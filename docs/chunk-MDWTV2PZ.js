import{$ as W,$a as ie,$b as ts,$c as BT,A as _z,Aa as kz,Ab as EA,Ac as uU,B as Za,Ba as lf,Bb as C0,Bc as dU,C as Wc,Ca as Mz,Cb as re,Cc as mU,D as ko,Da as $s,Db as q,Dc as pU,E as p0,Ea as ro,Eb as es,Ec as fU,F as vo,Fa as Mi,Fb as zz,Fc as hn,G as bo,Ga as cf,Gb as Uz,Gc as hU,H as C,Ha as _A,Hb as Gz,Hc as gU,I as hs,Ia as Rz,Ib as jz,Ic as fa,J as gs,Ja as uf,Jb as no,Jc as yU,K as ys,Ka as df,Kb as Hz,Kc as Fe,L as ep,La as Ri,Lb as qz,Lc as vU,M as Cg,Ma as rp,Mb as ac,Mc as Ce,N as li,Na as wg,Nb as T0,Nc as xr,O as Pz,Oa as Mo,Ob as Wz,Oc as bU,P as vs,Pa as nm,Pb as Xz,Pc as lc,Q as he,Qa as y0,Qb as Yz,Qc as xU,R as Ez,Ra as v0,Rb as Qz,Rc as ff,S as f0,Sa as Bx,Sb as Kz,Sc as SU,T as wA,Ta as b0,Tb as $z,Tc as P0,U as rm,Ua as x0,Ub as DT,Uc as hf,V as Lx,Va as ht,Vb as Zz,Vc as LT,W as TT,Wa as Ee,Wb as Jz,Wc as ha,X as Ai,Xa as Lz,Xb as Vx,Xc as Bi,Y as Iz,Ya as Bz,Yb as im,Yc as Oi,Z as bs,Za as Oz,Zb as eU,Zc as Fi,_ as y,_a as Fz,_b as Yo,_c as op,a as Sg,aa as Dt,ab as om,ac as Pr,ad as CU,b as or,ba as ne,bb as _g,bc as AT,bd as TU,c as Jd,ca as at,cb as PT,cc as np,cd as AA,d as nf,da as Tg,db as ld,dc as kT,dd as wU,e as vz,ea as ur,eb as xt,ec as tU,ed as Gx,f as ST,fa as af,fb as PA,fc as MT,fd as _U,g as bz,ga as xn,gb as Nz,gc as rU,gd as PU,h as Wo,ha as er,hb as Li,hc as nU,hd as Wr,i as fn,ia as tp,ib as Ge,ic as oU,id as EU,j as xz,ja as Dz,jb as mf,jc as iU,jd as g,k as CT,ka as wT,kb as Vz,kc as zx,kd as gf,l as em,la as K,lb as pa,lc as Ux,ld as xs,m as TA,ma as Xo,mb as S0,mc as IA,md as Ne,n as ce,na as _T,nb as Yc,nc as aU,nd as cn,o as of,oa as Az,ob as Ro,oc as DA,od as jx,p as Di,pa as Oe,pb as ET,pc as sU,pd as ue,q as Sz,qa as tr,qb as te,qc as ze,qd as z,r as m0,ra as we,rb as qe,rc as w0,rd as IU,s as ic,sa as $r,sb as pf,sc as lU,sd as cc,t as yo,ta as h0,tb as Ox,tc as sc,td as Js,u as Cz,ua as ki,ub as Qc,uc as Zs,ud as Pg,v as sd,va as ma,vb as cd,vc as _0,vd as yf,w as Jm,wa as sf,wb as Ja,wc as RT,wd as wl,x as tm,xa as g0,xb as IT,xc as rs,xd as Et,y as Tz,ya as Xc,yb as Fx,yc as Pe,z as wz,za as Tl,zb as Nx,zc as cU}from"./chunk-TI7GFU47.js";import{B as ad,C as d0,G as bT,I as gz,K as yz,R as xT,W as qc,a as w,b as U,c as fz,d as Hc,e as ua,f as Ot,g as N,m as ln,n as da,v as hz}from"./chunk-T4BLILQN.js";var fJ=Hc(en=>{"use strict";var hS=Symbol.for("react.element"),yPe=Symbol.for("react.portal"),vPe=Symbol.for("react.fragment"),bPe=Symbol.for("react.strict_mode"),xPe=Symbol.for("react.profiler"),SPe=Symbol.for("react.provider"),CPe=Symbol.for("react.context"),TPe=Symbol.for("react.forward_ref"),wPe=Symbol.for("react.suspense"),_Pe=Symbol.for("react.memo"),PPe=Symbol.for("react.lazy"),nJ=Symbol.iterator;function EPe(t){return t===null||typeof t!="object"?null:(t=nJ&&t[nJ]||t["@@iterator"],typeof t=="function"?t:null)}var aJ={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},sJ=Object.assign,lJ={};function Zv(t,e,r){this.props=t,this.context=e,this.refs=lJ,this.updater=r||aJ}Zv.prototype.isReactComponent={};Zv.prototype.setState=function(t,e){if(typeof t!="object"&&typeof t!="function"&&t!=null)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,t,e,"setState")};Zv.prototype.forceUpdate=function(t){this.updater.enqueueForceUpdate(this,t,"forceUpdate")};function cJ(){}cJ.prototype=Zv.prototype;function rB(t,e,r){this.props=t,this.context=e,this.refs=lJ,this.updater=r||aJ}var nB=rB.prototype=new cJ;nB.constructor=rB;sJ(nB,Zv.prototype);nB.isPureReactComponent=!0;var oJ=Array.isArray,uJ=Object.prototype.hasOwnProperty,oB={current:null},dJ={key:!0,ref:!0,__self:!0,__source:!0};function mJ(t,e,r){var n,o={},i=null,a=null;if(e!=null)for(n in e.ref!==void 0&&(a=e.ref),e.key!==void 0&&(i=""+e.key),e)uJ.call(e,n)&&!dJ.hasOwnProperty(n)&&(o[n]=e[n]);var s=arguments.length-2;if(s===1)o.children=r;else if(1<s){for(var l=Array(s),c=0;c<s;c++)l[c]=arguments[c+2];o.children=l}if(t&&t.defaultProps)for(n in s=t.defaultProps,s)o[n]===void 0&&(o[n]=s[n]);return{$$typeof:hS,type:t,key:i,ref:a,props:o,_owner:oB.current}}function IPe(t,e){return{$$typeof:hS,type:t.type,key:e,ref:t.ref,props:t.props,_owner:t._owner}}function iB(t){return typeof t=="object"&&t!==null&&t.$$typeof===hS}function DPe(t){var e={"=":"=0",":":"=2"};return"$"+t.replace(/[=:]/g,function(r){return e[r]})}var iJ=/\/+/g;function tB(t,e){return typeof t=="object"&&t!==null&&t.key!=null?DPe(""+t.key):e.toString(36)}function tP(t,e,r,n,o){var i=typeof t;(i==="undefined"||i==="boolean")&&(t=null);var a=!1;if(t===null)a=!0;else switch(i){case"string":case"number":a=!0;break;case"object":switch(t.$$typeof){case hS:case yPe:a=!0}}if(a)return a=t,o=o(a),t=n===""?"."+tB(a,0):n,oJ(o)?(r="",t!=null&&(r=t.replace(iJ,"$&/")+"/"),tP(o,e,r,"",function(c){return c})):o!=null&&(iB(o)&&(o=IPe(o,r+(!o.key||a&&a.key===o.key?"":(""+o.key).replace(iJ,"$&/")+"/")+t)),e.push(o)),1;if(a=0,n=n===""?".":n+":",oJ(t))for(var s=0;s<t.length;s++){i=t[s];var l=n+tB(i,s);a+=tP(i,e,r,l,o)}else if(l=EPe(t),typeof l=="function")for(t=l.call(t),s=0;!(i=t.next()).done;)i=i.value,l=n+tB(i,s++),a+=tP(i,e,r,l,o);else if(i==="object")throw e=String(t),Error("Objects are not valid as a React child (found: "+(e==="[object Object]"?"object with keys {"+Object.keys(t).join(", ")+"}":e)+"). If you meant to render a collection of children, use an array instead.");return a}function eP(t,e,r){if(t==null)return t;var n=[],o=0;return tP(t,n,"","",function(i){return e.call(r,i,o++)}),n}function APe(t){if(t._status===-1){var e=t._result;e=e(),e.then(function(r){(t._status===0||t._status===-1)&&(t._status=1,t._result=r)},function(r){(t._status===0||t._status===-1)&&(t._status=2,t._result=r)}),t._status===-1&&(t._status=0,t._result=e)}if(t._status===1)return t._result.default;throw t._result}var dl={current:null},rP={transition:null},kPe={ReactCurrentDispatcher:dl,ReactCurrentBatchConfig:rP,ReactCurrentOwner:oB};function pJ(){throw Error("act(...) is not supported in production builds of React.")}en.Children={map:eP,forEach:function(t,e,r){eP(t,function(){e.apply(this,arguments)},r)},count:function(t){var e=0;return eP(t,function(){e++}),e},toArray:function(t){return eP(t,function(e){return e})||[]},only:function(t){if(!iB(t))throw Error("React.Children.only expected to receive a single React element child.");return t}};en.Component=Zv;en.Fragment=vPe;en.Profiler=xPe;en.PureComponent=rB;en.StrictMode=bPe;en.Suspense=wPe;en.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=kPe;en.act=pJ;en.cloneElement=function(t,e,r){if(t==null)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+t+".");var n=sJ({},t.props),o=t.key,i=t.ref,a=t._owner;if(e!=null){if(e.ref!==void 0&&(i=e.ref,a=oB.current),e.key!==void 0&&(o=""+e.key),t.type&&t.type.defaultProps)var s=t.type.defaultProps;for(l in e)uJ.call(e,l)&&!dJ.hasOwnProperty(l)&&(n[l]=e[l]===void 0&&s!==void 0?s[l]:e[l])}var l=arguments.length-2;if(l===1)n.children=r;else if(1<l){s=Array(l);for(var c=0;c<l;c++)s[c]=arguments[c+2];n.children=s}return{$$typeof:hS,type:t.type,key:o,ref:i,props:n,_owner:a}};en.createContext=function(t){return t={$$typeof:CPe,_currentValue:t,_currentValue2:t,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null},t.Provider={$$typeof:SPe,_context:t},t.Consumer=t};en.createElement=mJ;en.createFactory=function(t){var e=mJ.bind(null,t);return e.type=t,e};en.createRef=function(){return{current:null}};en.forwardRef=function(t){return{$$typeof:TPe,render:t}};en.isValidElement=iB;en.lazy=function(t){return{$$typeof:PPe,_payload:{_status:-1,_result:t},_init:APe}};en.memo=function(t,e){return{$$typeof:_Pe,type:t,compare:e===void 0?null:e}};en.startTransition=function(t){var e=rP.transition;rP.transition={};try{t()}finally{rP.transition=e}};en.unstable_act=pJ;en.useCallback=function(t,e){return dl.current.useCallback(t,e)};en.useContext=function(t){return dl.current.useContext(t)};en.useDebugValue=function(){};en.useDeferredValue=function(t){return dl.current.useDeferredValue(t)};en.useEffect=function(t,e){return dl.current.useEffect(t,e)};en.useId=function(){return dl.current.useId()};en.useImperativeHandle=function(t,e,r){return dl.current.useImperativeHandle(t,e,r)};en.useInsertionEffect=function(t,e){return dl.current.useInsertionEffect(t,e)};en.useLayoutEffect=function(t,e){return dl.current.useLayoutEffect(t,e)};en.useMemo=function(t,e){return dl.current.useMemo(t,e)};en.useReducer=function(t,e,r){return dl.current.useReducer(t,e,r)};en.useRef=function(t){return dl.current.useRef(t)};en.useState=function(t){return dl.current.useState(t)};en.useSyncExternalStore=function(t,e,r){return dl.current.useSyncExternalStore(t,e,r)};en.useTransition=function(){return dl.current.useTransition()};en.version="18.3.1"});var Po=Hc((pFt,hJ)=>{"use strict";hJ.exports=fJ()});var yJ=Hc(nP=>{"use strict";var MPe=Po(),RPe=Symbol.for("react.element"),LPe=Symbol.for("react.fragment"),BPe=Object.prototype.hasOwnProperty,OPe=MPe.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,FPe={key:!0,ref:!0,__self:!0,__source:!0};function gJ(t,e,r){var n,o={},i=null,a=null;r!==void 0&&(i=""+r),e.key!==void 0&&(i=""+e.key),e.ref!==void 0&&(a=e.ref);for(n in e)BPe.call(e,n)&&!FPe.hasOwnProperty(n)&&(o[n]=e[n]);if(t&&t.defaultProps)for(n in e=t.defaultProps,e)o[n]===void 0&&(o[n]=e[n]);return{$$typeof:RPe,type:t,key:i,ref:a,props:o,_owner:OPe.current}}nP.Fragment=LPe;nP.jsx=gJ;nP.jsxs=gJ});var Or=Hc((hFt,vJ)=>{"use strict";vJ.exports=yJ()});var zne=Hc(po=>{"use strict";function TF(t,e){var r=t.length;t.push(e);e:for(;0<r;){var n=r-1>>>1,o=t[n];if(0<NE(o,e))t[n]=e,t[r]=o,r=n;else break e}}function Gd(t){return t.length===0?null:t[0]}function zE(t){if(t.length===0)return null;var e=t[0],r=t.pop();if(r!==e){t[0]=r;e:for(var n=0,o=t.length,i=o>>>1;n<i;){var a=2*(n+1)-1,s=t[a],l=a+1,c=t[l];if(0>NE(s,r))l<o&&0>NE(c,s)?(t[n]=c,t[l]=r,n=l):(t[n]=s,t[a]=r,n=a);else if(l<o&&0>NE(c,r))t[n]=c,t[l]=r,n=l;else break e}}return e}function NE(t,e){var r=t.sortIndex-e.sortIndex;return r!==0?r:t.id-e.id}typeof performance=="object"&&typeof performance.now=="function"?(kne=performance,po.unstable_now=function(){return kne.now()}):(xF=Date,Mne=xF.now(),po.unstable_now=function(){return xF.now()-Mne});var kne,xF,Mne,jm=[],jh=[],jMe=1,Xu=null,Vs=3,UE=!1,My=!1,rC=!1,Bne=typeof setTimeout=="function"?setTimeout:null,One=typeof clearTimeout=="function"?clearTimeout:null,Rne=typeof setImmediate<"u"?setImmediate:null;typeof navigator<"u"&&navigator.scheduling!==void 0&&navigator.scheduling.isInputPending!==void 0&&navigator.scheduling.isInputPending.bind(navigator.scheduling);function wF(t){for(var e=Gd(jh);e!==null;){if(e.callback===null)zE(jh);else if(e.startTime<=t)zE(jh),e.sortIndex=e.expirationTime,TF(jm,e);else break;e=Gd(jh)}}function _F(t){if(rC=!1,wF(t),!My)if(Gd(jm)!==null)My=!0,EF(PF);else{var e=Gd(jh);e!==null&&IF(_F,e.startTime-t)}}function PF(t,e){My=!1,rC&&(rC=!1,One(nC),nC=-1),UE=!0;var r=Vs;try{for(wF(e),Xu=Gd(jm);Xu!==null&&(!(Xu.expirationTime>e)||t&&!Vne());){var n=Xu.callback;if(typeof n=="function"){Xu.callback=null,Vs=Xu.priorityLevel;var o=n(Xu.expirationTime<=e);e=po.unstable_now(),typeof o=="function"?Xu.callback=o:Xu===Gd(jm)&&zE(jm),wF(e)}else zE(jm);Xu=Gd(jm)}if(Xu!==null)var i=!0;else{var a=Gd(jh);a!==null&&IF(_F,a.startTime-e),i=!1}return i}finally{Xu=null,Vs=r,UE=!1}}var GE=!1,VE=null,nC=-1,Fne=5,Nne=-1;function Vne(){return!(po.unstable_now()-Nne<Fne)}function SF(){if(VE!==null){var t=po.unstable_now();Nne=t;var e=!0;try{e=VE(!0,t)}finally{e?tC():(GE=!1,VE=null)}}else GE=!1}var tC;typeof Rne=="function"?tC=function(){Rne(SF)}:typeof MessageChannel<"u"?(CF=new MessageChannel,Lne=CF.port2,CF.port1.onmessage=SF,tC=function(){Lne.postMessage(null)}):tC=function(){Bne(SF,0)};var CF,Lne;function EF(t){VE=t,GE||(GE=!0,tC())}function IF(t,e){nC=Bne(function(){t(po.unstable_now())},e)}po.unstable_IdlePriority=5;po.unstable_ImmediatePriority=1;po.unstable_LowPriority=4;po.unstable_NormalPriority=3;po.unstable_Profiling=null;po.unstable_UserBlockingPriority=2;po.unstable_cancelCallback=function(t){t.callback=null};po.unstable_continueExecution=function(){My||UE||(My=!0,EF(PF))};po.unstable_forceFrameRate=function(t){0>t||125<t?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):Fne=0<t?Math.floor(1e3/t):5};po.unstable_getCurrentPriorityLevel=function(){return Vs};po.unstable_getFirstCallbackNode=function(){return Gd(jm)};po.unstable_next=function(t){switch(Vs){case 1:case 2:case 3:var e=3;break;default:e=Vs}var r=Vs;Vs=e;try{return t()}finally{Vs=r}};po.unstable_pauseExecution=function(){};po.unstable_requestPaint=function(){};po.unstable_runWithPriority=function(t,e){switch(t){case 1:case 2:case 3:case 4:case 5:break;default:t=3}var r=Vs;Vs=t;try{return e()}finally{Vs=r}};po.unstable_scheduleCallback=function(t,e,r){var n=po.unstable_now();switch(typeof r=="object"&&r!==null?(r=r.delay,r=typeof r=="number"&&0<r?n+r:n):r=n,t){case 1:var o=-1;break;case 2:o=250;break;case 5:o=1073741823;break;case 4:o=1e4;break;default:o=5e3}return o=r+o,t={id:jMe++,callback:e,priorityLevel:t,startTime:r,expirationTime:o,sortIndex:-1},r>n?(t.sortIndex=r,TF(jh,t),Gd(jm)===null&&t===Gd(jh)&&(rC?(One(nC),nC=-1):rC=!0,IF(_F,r-n))):(t.sortIndex=o,TF(jm,t),My||UE||(My=!0,EF(PF))),t};po.unstable_shouldYield=Vne;po.unstable_wrapCallback=function(t){var e=Vs;return function(){var r=Vs;Vs=e;try{return t.apply(this,arguments)}finally{Vs=r}}}});var Gne=Hc((LZt,Une)=>{"use strict";Une.exports=zne()});var Wae=Hc(Oc=>{"use strict";var HMe=Po(),Lc=Gne();function it(t){for(var e="https://reactjs.org/docs/error-decoder.html?invariant="+t,r=1;r<arguments.length;r++)e+="&args[]="+encodeURIComponent(arguments[r]);return"Minified React error #"+t+"; visit "+e+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var Qoe=new Set,_C={};function qy(t,e){mx(t,e),mx(t+"Capture",e)}function mx(t,e){for(_C[t]=e,t=0;t<e.length;t++)Qoe.add(e[t])}var Wp=!(typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"),$F=Object.prototype.hasOwnProperty,qMe=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,jne={},Hne={};function WMe(t){return $F.call(Hne,t)?!0:$F.call(jne,t)?!1:qMe.test(t)?Hne[t]=!0:(jne[t]=!0,!1)}function XMe(t,e,r,n){if(r!==null&&r.type===0)return!1;switch(typeof e){case"function":case"symbol":return!0;case"boolean":return n?!1:r!==null?!r.acceptsBooleans:(t=t.toLowerCase().slice(0,5),t!=="data-"&&t!=="aria-");default:return!1}}function YMe(t,e,r,n){if(e===null||typeof e>"u"||XMe(t,e,r,n))return!0;if(n)return!1;if(r!==null)switch(r.type){case 3:return!e;case 4:return e===!1;case 5:return isNaN(e);case 6:return isNaN(e)||1>e}return!1}function bl(t,e,r,n,o,i,a){this.acceptsBooleans=e===2||e===3||e===4,this.attributeName=n,this.attributeNamespace=o,this.mustUseProperty=r,this.propertyName=t,this.type=e,this.sanitizeURL=i,this.removeEmptyString=a}var ms={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(t){ms[t]=new bl(t,0,!1,t,null,!1,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(t){var e=t[0];ms[e]=new bl(e,1,!1,t[1],null,!1,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(t){ms[t]=new bl(t,2,!1,t.toLowerCase(),null,!1,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(t){ms[t]=new bl(t,2,!1,t,null,!1,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture disableRemotePlayback formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(t){ms[t]=new bl(t,3,!1,t.toLowerCase(),null,!1,!1)});["checked","multiple","muted","selected"].forEach(function(t){ms[t]=new bl(t,3,!0,t,null,!1,!1)});["capture","download"].forEach(function(t){ms[t]=new bl(t,4,!1,t,null,!1,!1)});["cols","rows","size","span"].forEach(function(t){ms[t]=new bl(t,6,!1,t,null,!1,!1)});["rowSpan","start"].forEach(function(t){ms[t]=new bl(t,5,!1,t.toLowerCase(),null,!1,!1)});var jN=/[\-:]([a-z])/g;function HN(t){return t[1].toUpperCase()}"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(t){var e=t.replace(jN,HN);ms[e]=new bl(e,1,!1,t,null,!1,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(t){var e=t.replace(jN,HN);ms[e]=new bl(e,1,!1,t,"http://www.w3.org/1999/xlink",!1,!1)});["xml:base","xml:lang","xml:space"].forEach(function(t){var e=t.replace(jN,HN);ms[e]=new bl(e,1,!1,t,"http://www.w3.org/XML/1998/namespace",!1,!1)});["tabIndex","crossOrigin"].forEach(function(t){ms[t]=new bl(t,1,!1,t.toLowerCase(),null,!1,!1)});ms.xlinkHref=new bl("xlinkHref",1,!1,"xlink:href","http://www.w3.org/1999/xlink",!0,!1);["src","href","action","formAction"].forEach(function(t){ms[t]=new bl(t,1,!1,t.toLowerCase(),null,!0,!0)});function qN(t,e,r,n){var o=ms.hasOwnProperty(e)?ms[e]:null;(o!==null?o.type!==0:n||!(2<e.length)||e[0]!=="o"&&e[0]!=="O"||e[1]!=="n"&&e[1]!=="N")&&(YMe(e,r,o,n)&&(r=null),n||o===null?WMe(e)&&(r===null?t.removeAttribute(e):t.setAttribute(e,""+r)):o.mustUseProperty?t[o.propertyName]=r===null?o.type===3?!1:"":r:(e=o.attributeName,n=o.attributeNamespace,r===null?t.removeAttribute(e):(o=o.type,r=o===3||o===4&&r===!0?"":""+r,n?t.setAttributeNS(n,e,r):t.setAttribute(e,r))))}var Kp=HMe.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,jE=Symbol.for("react.element"),Yb=Symbol.for("react.portal"),Qb=Symbol.for("react.fragment"),WN=Symbol.for("react.strict_mode"),ZF=Symbol.for("react.profiler"),Koe=Symbol.for("react.provider"),$oe=Symbol.for("react.context"),XN=Symbol.for("react.forward_ref"),JF=Symbol.for("react.suspense"),eN=Symbol.for("react.suspense_list"),YN=Symbol.for("react.memo"),qh=Symbol.for("react.lazy");Symbol.for("react.scope");Symbol.for("react.debug_trace_mode");var Zoe=Symbol.for("react.offscreen");Symbol.for("react.legacy_hidden");Symbol.for("react.cache");Symbol.for("react.tracing_marker");var qne=Symbol.iterator;function oC(t){return t===null||typeof t!="object"?null:(t=qne&&t[qne]||t["@@iterator"],typeof t=="function"?t:null)}var ai=Object.assign,DF;function mC(t){if(DF===void 0)try{throw Error()}catch(r){var e=r.stack.trim().match(/\n( *(at )?)/);DF=e&&e[1]||""}return`
`+DF+t}var AF=!1;function kF(t,e){if(!t||AF)return"";AF=!0;var r=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{if(e)if(e=function(){throw Error()},Object.defineProperty(e.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(e,[])}catch(c){var n=c}Reflect.construct(t,[],e)}else{try{e.call()}catch(c){n=c}t.call(e.prototype)}else{try{throw Error()}catch(c){n=c}t()}}catch(c){if(c&&n&&typeof c.stack=="string"){for(var o=c.stack.split(`
`),i=n.stack.split(`
`),a=o.length-1,s=i.length-1;1<=a&&0<=s&&o[a]!==i[s];)s--;for(;1<=a&&0<=s;a--,s--)if(o[a]!==i[s]){if(a!==1||s!==1)do if(a--,s--,0>s||o[a]!==i[s]){var l=`
`+o[a].replace(" at new "," at ");return t.displayName&&l.includes("<anonymous>")&&(l=l.replace("<anonymous>",t.displayName)),l}while(1<=a&&0<=s);break}}}finally{AF=!1,Error.prepareStackTrace=r}return(t=t?t.displayName||t.name:"")?mC(t):""}function QMe(t){switch(t.tag){case 5:return mC(t.type);case 16:return mC("Lazy");case 13:return mC("Suspense");case 19:return mC("SuspenseList");case 0:case 2:case 15:return t=kF(t.type,!1),t;case 11:return t=kF(t.type.render,!1),t;case 1:return t=kF(t.type,!0),t;default:return""}}function tN(t){if(t==null)return null;if(typeof t=="function")return t.displayName||t.name||null;if(typeof t=="string")return t;switch(t){case Qb:return"Fragment";case Yb:return"Portal";case ZF:return"Profiler";case WN:return"StrictMode";case JF:return"Suspense";case eN:return"SuspenseList"}if(typeof t=="object")switch(t.$$typeof){case $oe:return(t.displayName||"Context")+".Consumer";case Koe:return(t._context.displayName||"Context")+".Provider";case XN:var e=t.render;return t=t.displayName,t||(t=e.displayName||e.name||"",t=t!==""?"ForwardRef("+t+")":"ForwardRef"),t;case YN:return e=t.displayName||null,e!==null?e:tN(t.type)||"Memo";case qh:e=t._payload,t=t._init;try{return tN(t(e))}catch{}}return null}function KMe(t){var e=t.type;switch(t.tag){case 24:return"Cache";case 9:return(e.displayName||"Context")+".Consumer";case 10:return(e._context.displayName||"Context")+".Provider";case 18:return"DehydratedFragment";case 11:return t=e.render,t=t.displayName||t.name||"",e.displayName||(t!==""?"ForwardRef("+t+")":"ForwardRef");case 7:return"Fragment";case 5:return e;case 4:return"Portal";case 3:return"Root";case 6:return"Text";case 16:return tN(e);case 8:return e===WN?"StrictMode":"Mode";case 22:return"Offscreen";case 12:return"Profiler";case 21:return"Scope";case 13:return"Suspense";case 19:return"SuspenseList";case 25:return"TracingMarker";case 1:case 0:case 17:case 2:case 14:case 15:if(typeof e=="function")return e.displayName||e.name||null;if(typeof e=="string")return e}return null}function ig(t){switch(typeof t){case"boolean":case"number":case"string":case"undefined":return t;case"object":return t;default:return""}}function Joe(t){var e=t.type;return(t=t.nodeName)&&t.toLowerCase()==="input"&&(e==="checkbox"||e==="radio")}function $Me(t){var e=Joe(t)?"checked":"value",r=Object.getOwnPropertyDescriptor(t.constructor.prototype,e),n=""+t[e];if(!t.hasOwnProperty(e)&&typeof r<"u"&&typeof r.get=="function"&&typeof r.set=="function"){var o=r.get,i=r.set;return Object.defineProperty(t,e,{configurable:!0,get:function(){return o.call(this)},set:function(a){n=""+a,i.call(this,a)}}),Object.defineProperty(t,e,{enumerable:r.enumerable}),{getValue:function(){return n},setValue:function(a){n=""+a},stopTracking:function(){t._valueTracker=null,delete t[e]}}}}function HE(t){t._valueTracker||(t._valueTracker=$Me(t))}function eie(t){if(!t)return!1;var e=t._valueTracker;if(!e)return!0;var r=e.getValue(),n="";return t&&(n=Joe(t)?t.checked?"true":"false":t.value),t=n,t!==r?(e.setValue(t),!0):!1}function vI(t){if(t=t||(typeof document<"u"?document:void 0),typeof t>"u")return null;try{return t.activeElement||t.body}catch{return t.body}}function rN(t,e){var r=e.checked;return ai({},e,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:r??t._wrapperState.initialChecked})}function Wne(t,e){var r=e.defaultValue==null?"":e.defaultValue,n=e.checked!=null?e.checked:e.defaultChecked;r=ig(e.value!=null?e.value:r),t._wrapperState={initialChecked:n,initialValue:r,controlled:e.type==="checkbox"||e.type==="radio"?e.checked!=null:e.value!=null}}function tie(t,e){e=e.checked,e!=null&&qN(t,"checked",e,!1)}function nN(t,e){tie(t,e);var r=ig(e.value),n=e.type;if(r!=null)n==="number"?(r===0&&t.value===""||t.value!=r)&&(t.value=""+r):t.value!==""+r&&(t.value=""+r);else if(n==="submit"||n==="reset"){t.removeAttribute("value");return}e.hasOwnProperty("value")?oN(t,e.type,r):e.hasOwnProperty("defaultValue")&&oN(t,e.type,ig(e.defaultValue)),e.checked==null&&e.defaultChecked!=null&&(t.defaultChecked=!!e.defaultChecked)}function Xne(t,e,r){if(e.hasOwnProperty("value")||e.hasOwnProperty("defaultValue")){var n=e.type;if(!(n!=="submit"&&n!=="reset"||e.value!==void 0&&e.value!==null))return;e=""+t._wrapperState.initialValue,r||e===t.value||(t.value=e),t.defaultValue=e}r=t.name,r!==""&&(t.name=""),t.defaultChecked=!!t._wrapperState.initialChecked,r!==""&&(t.name=r)}function oN(t,e,r){(e!=="number"||vI(t.ownerDocument)!==t)&&(r==null?t.defaultValue=""+t._wrapperState.initialValue:t.defaultValue!==""+r&&(t.defaultValue=""+r))}var pC=Array.isArray;function ax(t,e,r,n){if(t=t.options,e){e={};for(var o=0;o<r.length;o++)e["$"+r[o]]=!0;for(r=0;r<t.length;r++)o=e.hasOwnProperty("$"+t[r].value),t[r].selected!==o&&(t[r].selected=o),o&&n&&(t[r].defaultSelected=!0)}else{for(r=""+ig(r),e=null,o=0;o<t.length;o++){if(t[o].value===r){t[o].selected=!0,n&&(t[o].defaultSelected=!0);return}e!==null||t[o].disabled||(e=t[o])}e!==null&&(e.selected=!0)}}function iN(t,e){if(e.dangerouslySetInnerHTML!=null)throw Error(it(91));return ai({},e,{value:void 0,defaultValue:void 0,children:""+t._wrapperState.initialValue})}function Yne(t,e){var r=e.value;if(r==null){if(r=e.children,e=e.defaultValue,r!=null){if(e!=null)throw Error(it(92));if(pC(r)){if(1<r.length)throw Error(it(93));r=r[0]}e=r}e==null&&(e=""),r=e}t._wrapperState={initialValue:ig(r)}}function rie(t,e){var r=ig(e.value),n=ig(e.defaultValue);r!=null&&(r=""+r,r!==t.value&&(t.value=r),e.defaultValue==null&&t.defaultValue!==r&&(t.defaultValue=r)),n!=null&&(t.defaultValue=""+n)}function Qne(t){var e=t.textContent;e===t._wrapperState.initialValue&&e!==""&&e!==null&&(t.value=e)}function nie(t){switch(t){case"svg":return"http://www.w3.org/2000/svg";case"math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function aN(t,e){return t==null||t==="http://www.w3.org/1999/xhtml"?nie(e):t==="http://www.w3.org/2000/svg"&&e==="foreignObject"?"http://www.w3.org/1999/xhtml":t}var qE,oie=function(t){return typeof MSApp<"u"&&MSApp.execUnsafeLocalFunction?function(e,r,n,o){MSApp.execUnsafeLocalFunction(function(){return t(e,r,n,o)})}:t}(function(t,e){if(t.namespaceURI!=="http://www.w3.org/2000/svg"||"innerHTML"in t)t.innerHTML=e;else{for(qE=qE||document.createElement("div"),qE.innerHTML="<svg>"+e.valueOf().toString()+"</svg>",e=qE.firstChild;t.firstChild;)t.removeChild(t.firstChild);for(;e.firstChild;)t.appendChild(e.firstChild)}});function PC(t,e){if(e){var r=t.firstChild;if(r&&r===t.lastChild&&r.nodeType===3){r.nodeValue=e;return}}t.textContent=e}var gC={animationIterationCount:!0,aspectRatio:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},ZMe=["Webkit","ms","Moz","O"];Object.keys(gC).forEach(function(t){ZMe.forEach(function(e){e=e+t.charAt(0).toUpperCase()+t.substring(1),gC[e]=gC[t]})});function iie(t,e,r){return e==null||typeof e=="boolean"||e===""?"":r||typeof e!="number"||e===0||gC.hasOwnProperty(t)&&gC[t]?(""+e).trim():e+"px"}function aie(t,e){t=t.style;for(var r in e)if(e.hasOwnProperty(r)){var n=r.indexOf("--")===0,o=iie(r,e[r],n);r==="float"&&(r="cssFloat"),n?t.setProperty(r,o):t[r]=o}}var JMe=ai({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0});function sN(t,e){if(e){if(JMe[t]&&(e.children!=null||e.dangerouslySetInnerHTML!=null))throw Error(it(137,t));if(e.dangerouslySetInnerHTML!=null){if(e.children!=null)throw Error(it(60));if(typeof e.dangerouslySetInnerHTML!="object"||!("__html"in e.dangerouslySetInnerHTML))throw Error(it(61))}if(e.style!=null&&typeof e.style!="object")throw Error(it(62))}}function lN(t,e){if(t.indexOf("-")===-1)return typeof e.is=="string";switch(t){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var cN=null;function QN(t){return t=t.target||t.srcElement||window,t.correspondingUseElement&&(t=t.correspondingUseElement),t.nodeType===3?t.parentNode:t}var uN=null,sx=null,lx=null;function Kne(t){if(t=HC(t)){if(typeof uN!="function")throw Error(it(280));var e=t.stateNode;e&&(e=WI(e),uN(t.stateNode,t.type,e))}}function sie(t){sx?lx?lx.push(t):lx=[t]:sx=t}function lie(){if(sx){var t=sx,e=lx;if(lx=sx=null,Kne(t),e)for(t=0;t<e.length;t++)Kne(e[t])}}function cie(t,e){return t(e)}function uie(){}var MF=!1;function die(t,e,r){if(MF)return t(e,r);MF=!0;try{return cie(t,e,r)}finally{MF=!1,(sx!==null||lx!==null)&&(uie(),lie())}}function EC(t,e){var r=t.stateNode;if(r===null)return null;var n=WI(r);if(n===null)return null;r=n[e];e:switch(e){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(n=!n.disabled)||(t=t.type,n=!(t==="button"||t==="input"||t==="select"||t==="textarea")),t=!n;break e;default:t=!1}if(t)return null;if(r&&typeof r!="function")throw Error(it(231,e,typeof r));return r}var dN=!1;if(Wp)try{Wb={},Object.defineProperty(Wb,"passive",{get:function(){dN=!0}}),window.addEventListener("test",Wb,Wb),window.removeEventListener("test",Wb,Wb)}catch{dN=!1}var Wb;function e3e(t,e,r,n,o,i,a,s,l){var c=Array.prototype.slice.call(arguments,3);try{e.apply(r,c)}catch(u){this.onError(u)}}var yC=!1,bI=null,xI=!1,mN=null,t3e={onError:function(t){yC=!0,bI=t}};function r3e(t,e,r,n,o,i,a,s,l){yC=!1,bI=null,e3e.apply(t3e,arguments)}function n3e(t,e,r,n,o,i,a,s,l){if(r3e.apply(this,arguments),yC){if(yC){var c=bI;yC=!1,bI=null}else throw Error(it(198));xI||(xI=!0,mN=c)}}function Wy(t){var e=t,r=t;if(t.alternate)for(;e.return;)e=e.return;else{t=e;do e=t,e.flags&4098&&(r=e.return),t=e.return;while(t)}return e.tag===3?r:null}function mie(t){if(t.tag===13){var e=t.memoizedState;if(e===null&&(t=t.alternate,t!==null&&(e=t.memoizedState)),e!==null)return e.dehydrated}return null}function $ne(t){if(Wy(t)!==t)throw Error(it(188))}function o3e(t){var e=t.alternate;if(!e){if(e=Wy(t),e===null)throw Error(it(188));return e!==t?null:t}for(var r=t,n=e;;){var o=r.return;if(o===null)break;var i=o.alternate;if(i===null){if(n=o.return,n!==null){r=n;continue}break}if(o.child===i.child){for(i=o.child;i;){if(i===r)return $ne(o),t;if(i===n)return $ne(o),e;i=i.sibling}throw Error(it(188))}if(r.return!==n.return)r=o,n=i;else{for(var a=!1,s=o.child;s;){if(s===r){a=!0,r=o,n=i;break}if(s===n){a=!0,n=o,r=i;break}s=s.sibling}if(!a){for(s=i.child;s;){if(s===r){a=!0,r=i,n=o;break}if(s===n){a=!0,n=i,r=o;break}s=s.sibling}if(!a)throw Error(it(189))}}if(r.alternate!==n)throw Error(it(190))}if(r.tag!==3)throw Error(it(188));return r.stateNode.current===r?t:e}function pie(t){return t=o3e(t),t!==null?fie(t):null}function fie(t){if(t.tag===5||t.tag===6)return t;for(t=t.child;t!==null;){var e=fie(t);if(e!==null)return e;t=t.sibling}return null}var hie=Lc.unstable_scheduleCallback,Zne=Lc.unstable_cancelCallback,i3e=Lc.unstable_shouldYield,a3e=Lc.unstable_requestPaint,_i=Lc.unstable_now,s3e=Lc.unstable_getCurrentPriorityLevel,KN=Lc.unstable_ImmediatePriority,gie=Lc.unstable_UserBlockingPriority,SI=Lc.unstable_NormalPriority,l3e=Lc.unstable_LowPriority,yie=Lc.unstable_IdlePriority,GI=null,Xm=null;function c3e(t){if(Xm&&typeof Xm.onCommitFiberRoot=="function")try{Xm.onCommitFiberRoot(GI,t,void 0,(t.current.flags&128)===128)}catch{}}var Xd=Math.clz32?Math.clz32:m3e,u3e=Math.log,d3e=Math.LN2;function m3e(t){return t>>>=0,t===0?32:31-(u3e(t)/d3e|0)|0}var WE=64,XE=4194304;function fC(t){switch(t&-t){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return t&4194240;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return t&130023424;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 1073741824;default:return t}}function CI(t,e){var r=t.pendingLanes;if(r===0)return 0;var n=0,o=t.suspendedLanes,i=t.pingedLanes,a=r&268435455;if(a!==0){var s=a&~o;s!==0?n=fC(s):(i&=a,i!==0&&(n=fC(i)))}else a=r&~o,a!==0?n=fC(a):i!==0&&(n=fC(i));if(n===0)return 0;if(e!==0&&e!==n&&!(e&o)&&(o=n&-n,i=e&-e,o>=i||o===16&&(i&4194240)!==0))return e;if(n&4&&(n|=r&16),e=t.entangledLanes,e!==0)for(t=t.entanglements,e&=n;0<e;)r=31-Xd(e),o=1<<r,n|=t[r],e&=~o;return n}function p3e(t,e){switch(t){case 1:case 2:case 4:return e+250;case 8:case 16:case 32:case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return e+5e3;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return-1;case 134217728:case 268435456:case 536870912:case 1073741824:return-1;default:return-1}}function f3e(t,e){for(var r=t.suspendedLanes,n=t.pingedLanes,o=t.expirationTimes,i=t.pendingLanes;0<i;){var a=31-Xd(i),s=1<<a,l=o[a];l===-1?(!(s&r)||s&n)&&(o[a]=p3e(s,e)):l<=e&&(t.expiredLanes|=s),i&=~s}}function pN(t){return t=t.pendingLanes&-1073741825,t!==0?t:t&1073741824?1073741824:0}function vie(){var t=WE;return WE<<=1,!(WE&4194240)&&(WE=64),t}function RF(t){for(var e=[],r=0;31>r;r++)e.push(t);return e}function GC(t,e,r){t.pendingLanes|=e,e!==536870912&&(t.suspendedLanes=0,t.pingedLanes=0),t=t.eventTimes,e=31-Xd(e),t[e]=r}function h3e(t,e){var r=t.pendingLanes&~e;t.pendingLanes=e,t.suspendedLanes=0,t.pingedLanes=0,t.expiredLanes&=e,t.mutableReadLanes&=e,t.entangledLanes&=e,e=t.entanglements;var n=t.eventTimes;for(t=t.expirationTimes;0<r;){var o=31-Xd(r),i=1<<o;e[o]=0,n[o]=-1,t[o]=-1,r&=~i}}function $N(t,e){var r=t.entangledLanes|=e;for(t=t.entanglements;r;){var n=31-Xd(r),o=1<<n;o&e|t[n]&e&&(t[n]|=e),r&=~o}}var Zn=0;function bie(t){return t&=-t,1<t?4<t?t&268435455?16:536870912:4:1}var xie,ZN,Sie,Cie,Tie,fN=!1,YE=[],$h=null,Zh=null,Jh=null,IC=new Map,DC=new Map,Xh=[],g3e="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset submit".split(" ");function Jne(t,e){switch(t){case"focusin":case"focusout":$h=null;break;case"dragenter":case"dragleave":Zh=null;break;case"mouseover":case"mouseout":Jh=null;break;case"pointerover":case"pointerout":IC.delete(e.pointerId);break;case"gotpointercapture":case"lostpointercapture":DC.delete(e.pointerId)}}function iC(t,e,r,n,o,i){return t===null||t.nativeEvent!==i?(t={blockedOn:e,domEventName:r,eventSystemFlags:n,nativeEvent:i,targetContainers:[o]},e!==null&&(e=HC(e),e!==null&&ZN(e)),t):(t.eventSystemFlags|=n,e=t.targetContainers,o!==null&&e.indexOf(o)===-1&&e.push(o),t)}function y3e(t,e,r,n,o){switch(e){case"focusin":return $h=iC($h,t,e,r,n,o),!0;case"dragenter":return Zh=iC(Zh,t,e,r,n,o),!0;case"mouseover":return Jh=iC(Jh,t,e,r,n,o),!0;case"pointerover":var i=o.pointerId;return IC.set(i,iC(IC.get(i)||null,t,e,r,n,o)),!0;case"gotpointercapture":return i=o.pointerId,DC.set(i,iC(DC.get(i)||null,t,e,r,n,o)),!0}return!1}function wie(t){var e=By(t.target);if(e!==null){var r=Wy(e);if(r!==null){if(e=r.tag,e===13){if(e=mie(r),e!==null){t.blockedOn=e,Tie(t.priority,function(){Sie(r)});return}}else if(e===3&&r.stateNode.current.memoizedState.isDehydrated){t.blockedOn=r.tag===3?r.stateNode.containerInfo:null;return}}}t.blockedOn=null}function lI(t){if(t.blockedOn!==null)return!1;for(var e=t.targetContainers;0<e.length;){var r=hN(t.domEventName,t.eventSystemFlags,e[0],t.nativeEvent);if(r===null){r=t.nativeEvent;var n=new r.constructor(r.type,r);cN=n,r.target.dispatchEvent(n),cN=null}else return e=HC(r),e!==null&&ZN(e),t.blockedOn=r,!1;e.shift()}return!0}function eoe(t,e,r){lI(t)&&r.delete(e)}function v3e(){fN=!1,$h!==null&&lI($h)&&($h=null),Zh!==null&&lI(Zh)&&(Zh=null),Jh!==null&&lI(Jh)&&(Jh=null),IC.forEach(eoe),DC.forEach(eoe)}function aC(t,e){t.blockedOn===e&&(t.blockedOn=null,fN||(fN=!0,Lc.unstable_scheduleCallback(Lc.unstable_NormalPriority,v3e)))}function AC(t){function e(o){return aC(o,t)}if(0<YE.length){aC(YE[0],t);for(var r=1;r<YE.length;r++){var n=YE[r];n.blockedOn===t&&(n.blockedOn=null)}}for($h!==null&&aC($h,t),Zh!==null&&aC(Zh,t),Jh!==null&&aC(Jh,t),IC.forEach(e),DC.forEach(e),r=0;r<Xh.length;r++)n=Xh[r],n.blockedOn===t&&(n.blockedOn=null);for(;0<Xh.length&&(r=Xh[0],r.blockedOn===null);)wie(r),r.blockedOn===null&&Xh.shift()}var cx=Kp.ReactCurrentBatchConfig,TI=!0;function b3e(t,e,r,n){var o=Zn,i=cx.transition;cx.transition=null;try{Zn=1,JN(t,e,r,n)}finally{Zn=o,cx.transition=i}}function x3e(t,e,r,n){var o=Zn,i=cx.transition;cx.transition=null;try{Zn=4,JN(t,e,r,n)}finally{Zn=o,cx.transition=i}}function JN(t,e,r,n){if(TI){var o=hN(t,e,r,n);if(o===null)zF(t,e,n,wI,r),Jne(t,n);else if(y3e(o,t,e,r,n))n.stopPropagation();else if(Jne(t,n),e&4&&-1<g3e.indexOf(t)){for(;o!==null;){var i=HC(o);if(i!==null&&xie(i),i=hN(t,e,r,n),i===null&&zF(t,e,n,wI,r),i===o)break;o=i}o!==null&&n.stopPropagation()}else zF(t,e,n,null,r)}}var wI=null;function hN(t,e,r,n){if(wI=null,t=QN(n),t=By(t),t!==null)if(e=Wy(t),e===null)t=null;else if(r=e.tag,r===13){if(t=mie(e),t!==null)return t;t=null}else if(r===3){if(e.stateNode.current.memoizedState.isDehydrated)return e.tag===3?e.stateNode.containerInfo:null;t=null}else e!==t&&(t=null);return wI=t,null}function _ie(t){switch(t){case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 1;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"toggle":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 4;case"message":switch(s3e()){case KN:return 1;case gie:return 4;case SI:case l3e:return 16;case yie:return 536870912;default:return 16}default:return 16}}var Qh=null,e4=null,cI=null;function Pie(){if(cI)return cI;var t,e=e4,r=e.length,n,o="value"in Qh?Qh.value:Qh.textContent,i=o.length;for(t=0;t<r&&e[t]===o[t];t++);var a=r-t;for(n=1;n<=a&&e[r-n]===o[i-n];n++);return cI=o.slice(t,1<n?1-n:void 0)}function uI(t){var e=t.keyCode;return"charCode"in t?(t=t.charCode,t===0&&e===13&&(t=13)):t=e,t===10&&(t=13),32<=t||t===13?t:0}function QE(){return!0}function toe(){return!1}function Bc(t){function e(r,n,o,i,a){this._reactName=r,this._targetInst=o,this.type=n,this.nativeEvent=i,this.target=a,this.currentTarget=null;for(var s in t)t.hasOwnProperty(s)&&(r=t[s],this[s]=r?r(i):i[s]);return this.isDefaultPrevented=(i.defaultPrevented!=null?i.defaultPrevented:i.returnValue===!1)?QE:toe,this.isPropagationStopped=toe,this}return ai(e.prototype,{preventDefault:function(){this.defaultPrevented=!0;var r=this.nativeEvent;r&&(r.preventDefault?r.preventDefault():typeof r.returnValue!="unknown"&&(r.returnValue=!1),this.isDefaultPrevented=QE)},stopPropagation:function(){var r=this.nativeEvent;r&&(r.stopPropagation?r.stopPropagation():typeof r.cancelBubble!="unknown"&&(r.cancelBubble=!0),this.isPropagationStopped=QE)},persist:function(){},isPersistent:QE}),e}var bx={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(t){return t.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},t4=Bc(bx),jC=ai({},bx,{view:0,detail:0}),S3e=Bc(jC),LF,BF,sC,jI=ai({},jC,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:r4,button:0,buttons:0,relatedTarget:function(t){return t.relatedTarget===void 0?t.fromElement===t.srcElement?t.toElement:t.fromElement:t.relatedTarget},movementX:function(t){return"movementX"in t?t.movementX:(t!==sC&&(sC&&t.type==="mousemove"?(LF=t.screenX-sC.screenX,BF=t.screenY-sC.screenY):BF=LF=0,sC=t),LF)},movementY:function(t){return"movementY"in t?t.movementY:BF}}),roe=Bc(jI),C3e=ai({},jI,{dataTransfer:0}),T3e=Bc(C3e),w3e=ai({},jC,{relatedTarget:0}),OF=Bc(w3e),_3e=ai({},bx,{animationName:0,elapsedTime:0,pseudoElement:0}),P3e=Bc(_3e),E3e=ai({},bx,{clipboardData:function(t){return"clipboardData"in t?t.clipboardData:window.clipboardData}}),I3e=Bc(E3e),D3e=ai({},bx,{data:0}),noe=Bc(D3e),A3e={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},k3e={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},M3e={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function R3e(t){var e=this.nativeEvent;return e.getModifierState?e.getModifierState(t):(t=M3e[t])?!!e[t]:!1}function r4(){return R3e}var L3e=ai({},jC,{key:function(t){if(t.key){var e=A3e[t.key]||t.key;if(e!=="Unidentified")return e}return t.type==="keypress"?(t=uI(t),t===13?"Enter":String.fromCharCode(t)):t.type==="keydown"||t.type==="keyup"?k3e[t.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:r4,charCode:function(t){return t.type==="keypress"?uI(t):0},keyCode:function(t){return t.type==="keydown"||t.type==="keyup"?t.keyCode:0},which:function(t){return t.type==="keypress"?uI(t):t.type==="keydown"||t.type==="keyup"?t.keyCode:0}}),B3e=Bc(L3e),O3e=ai({},jI,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0}),ooe=Bc(O3e),F3e=ai({},jC,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:r4}),N3e=Bc(F3e),V3e=ai({},bx,{propertyName:0,elapsedTime:0,pseudoElement:0}),z3e=Bc(V3e),U3e=ai({},jI,{deltaX:function(t){return"deltaX"in t?t.deltaX:"wheelDeltaX"in t?-t.wheelDeltaX:0},deltaY:function(t){return"deltaY"in t?t.deltaY:"wheelDeltaY"in t?-t.wheelDeltaY:"wheelDelta"in t?-t.wheelDelta:0},deltaZ:0,deltaMode:0}),G3e=Bc(U3e),j3e=[9,13,27,32],n4=Wp&&"CompositionEvent"in window,vC=null;Wp&&"documentMode"in document&&(vC=document.documentMode);var H3e=Wp&&"TextEvent"in window&&!vC,Eie=Wp&&(!n4||vC&&8<vC&&11>=vC),ioe=" ",aoe=!1;function Iie(t,e){switch(t){case"keyup":return j3e.indexOf(e.keyCode)!==-1;case"keydown":return e.keyCode!==229;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function Die(t){return t=t.detail,typeof t=="object"&&"data"in t?t.data:null}var Kb=!1;function q3e(t,e){switch(t){case"compositionend":return Die(e);case"keypress":return e.which!==32?null:(aoe=!0,ioe);case"textInput":return t=e.data,t===ioe&&aoe?null:t;default:return null}}function W3e(t,e){if(Kb)return t==="compositionend"||!n4&&Iie(t,e)?(t=Pie(),cI=e4=Qh=null,Kb=!1,t):null;switch(t){case"paste":return null;case"keypress":if(!(e.ctrlKey||e.altKey||e.metaKey)||e.ctrlKey&&e.altKey){if(e.char&&1<e.char.length)return e.char;if(e.which)return String.fromCharCode(e.which)}return null;case"compositionend":return Eie&&e.locale!=="ko"?null:e.data;default:return null}}var X3e={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function soe(t){var e=t&&t.nodeName&&t.nodeName.toLowerCase();return e==="input"?!!X3e[t.type]:e==="textarea"}function Aie(t,e,r,n){sie(n),e=_I(e,"onChange"),0<e.length&&(r=new t4("onChange","change",null,r,n),t.push({event:r,listeners:e}))}var bC=null,kC=null;function Y3e(t){Uie(t,0)}function HI(t){var e=Jb(t);if(eie(e))return t}function Q3e(t,e){if(t==="change")return e}var kie=!1;Wp&&(Wp?($E="oninput"in document,$E||(FF=document.createElement("div"),FF.setAttribute("oninput","return;"),$E=typeof FF.oninput=="function"),KE=$E):KE=!1,kie=KE&&(!document.documentMode||9<document.documentMode));var KE,$E,FF;function loe(){bC&&(bC.detachEvent("onpropertychange",Mie),kC=bC=null)}function Mie(t){if(t.propertyName==="value"&&HI(kC)){var e=[];Aie(e,kC,t,QN(t)),die(Y3e,e)}}function K3e(t,e,r){t==="focusin"?(loe(),bC=e,kC=r,bC.attachEvent("onpropertychange",Mie)):t==="focusout"&&loe()}function $3e(t){if(t==="selectionchange"||t==="keyup"||t==="keydown")return HI(kC)}function Z3e(t,e){if(t==="click")return HI(e)}function J3e(t,e){if(t==="input"||t==="change")return HI(e)}function eRe(t,e){return t===e&&(t!==0||1/t===1/e)||t!==t&&e!==e}var Qd=typeof Object.is=="function"?Object.is:eRe;function MC(t,e){if(Qd(t,e))return!0;if(typeof t!="object"||t===null||typeof e!="object"||e===null)return!1;var r=Object.keys(t),n=Object.keys(e);if(r.length!==n.length)return!1;for(n=0;n<r.length;n++){var o=r[n];if(!$F.call(e,o)||!Qd(t[o],e[o]))return!1}return!0}function coe(t){for(;t&&t.firstChild;)t=t.firstChild;return t}function uoe(t,e){var r=coe(t);t=0;for(var n;r;){if(r.nodeType===3){if(n=t+r.textContent.length,t<=e&&n>=e)return{node:r,offset:e-t};t=n}e:{for(;r;){if(r.nextSibling){r=r.nextSibling;break e}r=r.parentNode}r=void 0}r=coe(r)}}function Rie(t,e){return t&&e?t===e?!0:t&&t.nodeType===3?!1:e&&e.nodeType===3?Rie(t,e.parentNode):"contains"in t?t.contains(e):t.compareDocumentPosition?!!(t.compareDocumentPosition(e)&16):!1:!1}function Lie(){for(var t=window,e=vI();e instanceof t.HTMLIFrameElement;){try{var r=typeof e.contentWindow.location.href=="string"}catch{r=!1}if(r)t=e.contentWindow;else break;e=vI(t.document)}return e}function o4(t){var e=t&&t.nodeName&&t.nodeName.toLowerCase();return e&&(e==="input"&&(t.type==="text"||t.type==="search"||t.type==="tel"||t.type==="url"||t.type==="password")||e==="textarea"||t.contentEditable==="true")}function tRe(t){var e=Lie(),r=t.focusedElem,n=t.selectionRange;if(e!==r&&r&&r.ownerDocument&&Rie(r.ownerDocument.documentElement,r)){if(n!==null&&o4(r)){if(e=n.start,t=n.end,t===void 0&&(t=e),"selectionStart"in r)r.selectionStart=e,r.selectionEnd=Math.min(t,r.value.length);else if(t=(e=r.ownerDocument||document)&&e.defaultView||window,t.getSelection){t=t.getSelection();var o=r.textContent.length,i=Math.min(n.start,o);n=n.end===void 0?i:Math.min(n.end,o),!t.extend&&i>n&&(o=n,n=i,i=o),o=uoe(r,i);var a=uoe(r,n);o&&a&&(t.rangeCount!==1||t.anchorNode!==o.node||t.anchorOffset!==o.offset||t.focusNode!==a.node||t.focusOffset!==a.offset)&&(e=e.createRange(),e.setStart(o.node,o.offset),t.removeAllRanges(),i>n?(t.addRange(e),t.extend(a.node,a.offset)):(e.setEnd(a.node,a.offset),t.addRange(e)))}}for(e=[],t=r;t=t.parentNode;)t.nodeType===1&&e.push({element:t,left:t.scrollLeft,top:t.scrollTop});for(typeof r.focus=="function"&&r.focus(),r=0;r<e.length;r++)t=e[r],t.element.scrollLeft=t.left,t.element.scrollTop=t.top}}var rRe=Wp&&"documentMode"in document&&11>=document.documentMode,$b=null,gN=null,xC=null,yN=!1;function doe(t,e,r){var n=r.window===r?r.document:r.nodeType===9?r:r.ownerDocument;yN||$b==null||$b!==vI(n)||(n=$b,"selectionStart"in n&&o4(n)?n={start:n.selectionStart,end:n.selectionEnd}:(n=(n.ownerDocument&&n.ownerDocument.defaultView||window).getSelection(),n={anchorNode:n.anchorNode,anchorOffset:n.anchorOffset,focusNode:n.focusNode,focusOffset:n.focusOffset}),xC&&MC(xC,n)||(xC=n,n=_I(gN,"onSelect"),0<n.length&&(e=new t4("onSelect","select",null,e,r),t.push({event:e,listeners:n}),e.target=$b)))}function ZE(t,e){var r={};return r[t.toLowerCase()]=e.toLowerCase(),r["Webkit"+t]="webkit"+e,r["Moz"+t]="moz"+e,r}var Zb={animationend:ZE("Animation","AnimationEnd"),animationiteration:ZE("Animation","AnimationIteration"),animationstart:ZE("Animation","AnimationStart"),transitionend:ZE("Transition","TransitionEnd")},NF={},Bie={};Wp&&(Bie=document.createElement("div").style,"AnimationEvent"in window||(delete Zb.animationend.animation,delete Zb.animationiteration.animation,delete Zb.animationstart.animation),"TransitionEvent"in window||delete Zb.transitionend.transition);function qI(t){if(NF[t])return NF[t];if(!Zb[t])return t;var e=Zb[t],r;for(r in e)if(e.hasOwnProperty(r)&&r in Bie)return NF[t]=e[r];return t}var Oie=qI("animationend"),Fie=qI("animationiteration"),Nie=qI("animationstart"),Vie=qI("transitionend"),zie=new Map,moe="abort auxClick cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");function sg(t,e){zie.set(t,e),qy(e,[t])}for(JE=0;JE<moe.length;JE++)eI=moe[JE],poe=eI.toLowerCase(),foe=eI[0].toUpperCase()+eI.slice(1),sg(poe,"on"+foe);var eI,poe,foe,JE;sg(Oie,"onAnimationEnd");sg(Fie,"onAnimationIteration");sg(Nie,"onAnimationStart");sg("dblclick","onDoubleClick");sg("focusin","onFocus");sg("focusout","onBlur");sg(Vie,"onTransitionEnd");mx("onMouseEnter",["mouseout","mouseover"]);mx("onMouseLeave",["mouseout","mouseover"]);mx("onPointerEnter",["pointerout","pointerover"]);mx("onPointerLeave",["pointerout","pointerover"]);qy("onChange","change click focusin focusout input keydown keyup selectionchange".split(" "));qy("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" "));qy("onBeforeInput",["compositionend","keypress","textInput","paste"]);qy("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" "));qy("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" "));qy("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var hC="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),nRe=new Set("cancel close invalid load scroll toggle".split(" ").concat(hC));function hoe(t,e,r){var n=t.type||"unknown-event";t.currentTarget=r,n3e(n,e,void 0,t),t.currentTarget=null}function Uie(t,e){e=(e&4)!==0;for(var r=0;r<t.length;r++){var n=t[r],o=n.event;n=n.listeners;e:{var i=void 0;if(e)for(var a=n.length-1;0<=a;a--){var s=n[a],l=s.instance,c=s.currentTarget;if(s=s.listener,l!==i&&o.isPropagationStopped())break e;hoe(o,s,c),i=l}else for(a=0;a<n.length;a++){if(s=n[a],l=s.instance,c=s.currentTarget,s=s.listener,l!==i&&o.isPropagationStopped())break e;hoe(o,s,c),i=l}}}if(xI)throw t=mN,xI=!1,mN=null,t}function Eo(t,e){var r=e[CN];r===void 0&&(r=e[CN]=new Set);var n=t+"__bubble";r.has(n)||(Gie(e,t,2,!1),r.add(n))}function VF(t,e,r){var n=0;e&&(n|=4),Gie(r,t,n,e)}var tI="_reactListening"+Math.random().toString(36).slice(2);function RC(t){if(!t[tI]){t[tI]=!0,Qoe.forEach(function(r){r!=="selectionchange"&&(nRe.has(r)||VF(r,!1,t),VF(r,!0,t))});var e=t.nodeType===9?t:t.ownerDocument;e===null||e[tI]||(e[tI]=!0,VF("selectionchange",!1,e))}}function Gie(t,e,r,n){switch(_ie(e)){case 1:var o=b3e;break;case 4:o=x3e;break;default:o=JN}r=o.bind(null,e,r,t),o=void 0,!dN||e!=="touchstart"&&e!=="touchmove"&&e!=="wheel"||(o=!0),n?o!==void 0?t.addEventListener(e,r,{capture:!0,passive:o}):t.addEventListener(e,r,!0):o!==void 0?t.addEventListener(e,r,{passive:o}):t.addEventListener(e,r,!1)}function zF(t,e,r,n,o){var i=n;if(!(e&1)&&!(e&2)&&n!==null)e:for(;;){if(n===null)return;var a=n.tag;if(a===3||a===4){var s=n.stateNode.containerInfo;if(s===o||s.nodeType===8&&s.parentNode===o)break;if(a===4)for(a=n.return;a!==null;){var l=a.tag;if((l===3||l===4)&&(l=a.stateNode.containerInfo,l===o||l.nodeType===8&&l.parentNode===o))return;a=a.return}for(;s!==null;){if(a=By(s),a===null)return;if(l=a.tag,l===5||l===6){n=i=a;continue e}s=s.parentNode}}n=n.return}die(function(){var c=i,u=QN(r),d=[];e:{var m=zie.get(t);if(m!==void 0){var p=t4,h=t;switch(t){case"keypress":if(uI(r)===0)break e;case"keydown":case"keyup":p=B3e;break;case"focusin":h="focus",p=OF;break;case"focusout":h="blur",p=OF;break;case"beforeblur":case"afterblur":p=OF;break;case"click":if(r.button===2)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":p=roe;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":p=T3e;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":p=N3e;break;case Oie:case Fie:case Nie:p=P3e;break;case Vie:p=z3e;break;case"scroll":p=S3e;break;case"wheel":p=G3e;break;case"copy":case"cut":case"paste":p=I3e;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":p=ooe}var f=(e&4)!==0,b=!f&&t==="scroll",v=f?m!==null?m+"Capture":null:m;f=[];for(var x=c,S;x!==null;){S=x;var T=S.stateNode;if(S.tag===5&&T!==null&&(S=T,v!==null&&(T=EC(x,v),T!=null&&f.push(LC(x,T,S)))),b)break;x=x.return}0<f.length&&(m=new p(m,h,null,r,u),d.push({event:m,listeners:f}))}}if(!(e&7)){e:{if(m=t==="mouseover"||t==="pointerover",p=t==="mouseout"||t==="pointerout",m&&r!==cN&&(h=r.relatedTarget||r.fromElement)&&(By(h)||h[Xp]))break e;if((p||m)&&(m=u.window===u?u:(m=u.ownerDocument)?m.defaultView||m.parentWindow:window,p?(h=r.relatedTarget||r.toElement,p=c,h=h?By(h):null,h!==null&&(b=Wy(h),h!==b||h.tag!==5&&h.tag!==6)&&(h=null)):(p=null,h=c),p!==h)){if(f=roe,T="onMouseLeave",v="onMouseEnter",x="mouse",(t==="pointerout"||t==="pointerover")&&(f=ooe,T="onPointerLeave",v="onPointerEnter",x="pointer"),b=p==null?m:Jb(p),S=h==null?m:Jb(h),m=new f(T,x+"leave",p,r,u),m.target=b,m.relatedTarget=S,T=null,By(u)===c&&(f=new f(v,x+"enter",h,r,u),f.target=S,f.relatedTarget=b,T=f),b=T,p&&h)t:{for(f=p,v=h,x=0,S=f;S;S=Xb(S))x++;for(S=0,T=v;T;T=Xb(T))S++;for(;0<x-S;)f=Xb(f),x--;for(;0<S-x;)v=Xb(v),S--;for(;x--;){if(f===v||v!==null&&f===v.alternate)break t;f=Xb(f),v=Xb(v)}f=null}else f=null;p!==null&&goe(d,m,p,f,!1),h!==null&&b!==null&&goe(d,b,h,f,!0)}}e:{if(m=c?Jb(c):window,p=m.nodeName&&m.nodeName.toLowerCase(),p==="select"||p==="input"&&m.type==="file")var E=Q3e;else if(soe(m))if(kie)E=J3e;else{E=$3e;var _=K3e}else(p=m.nodeName)&&p.toLowerCase()==="input"&&(m.type==="checkbox"||m.type==="radio")&&(E=Z3e);if(E&&(E=E(t,c))){Aie(d,E,r,u);break e}_&&_(t,m,c),t==="focusout"&&(_=m._wrapperState)&&_.controlled&&m.type==="number"&&oN(m,"number",m.value)}switch(_=c?Jb(c):window,t){case"focusin":(soe(_)||_.contentEditable==="true")&&($b=_,gN=c,xC=null);break;case"focusout":xC=gN=$b=null;break;case"mousedown":yN=!0;break;case"contextmenu":case"mouseup":case"dragend":yN=!1,doe(d,r,u);break;case"selectionchange":if(rRe)break;case"keydown":case"keyup":doe(d,r,u)}var D;if(n4)e:{switch(t){case"compositionstart":var P="onCompositionStart";break e;case"compositionend":P="onCompositionEnd";break e;case"compositionupdate":P="onCompositionUpdate";break e}P=void 0}else Kb?Iie(t,r)&&(P="onCompositionEnd"):t==="keydown"&&r.keyCode===229&&(P="onCompositionStart");P&&(Eie&&r.locale!=="ko"&&(Kb||P!=="onCompositionStart"?P==="onCompositionEnd"&&Kb&&(D=Pie()):(Qh=u,e4="value"in Qh?Qh.value:Qh.textContent,Kb=!0)),_=_I(c,P),0<_.length&&(P=new noe(P,t,null,r,u),d.push({event:P,listeners:_}),D?P.data=D:(D=Die(r),D!==null&&(P.data=D)))),(D=H3e?q3e(t,r):W3e(t,r))&&(c=_I(c,"onBeforeInput"),0<c.length&&(u=new noe("onBeforeInput","beforeinput",null,r,u),d.push({event:u,listeners:c}),u.data=D))}Uie(d,e)})}function LC(t,e,r){return{instance:t,listener:e,currentTarget:r}}function _I(t,e){for(var r=e+"Capture",n=[];t!==null;){var o=t,i=o.stateNode;o.tag===5&&i!==null&&(o=i,i=EC(t,r),i!=null&&n.unshift(LC(t,i,o)),i=EC(t,e),i!=null&&n.push(LC(t,i,o))),t=t.return}return n}function Xb(t){if(t===null)return null;do t=t.return;while(t&&t.tag!==5);return t||null}function goe(t,e,r,n,o){for(var i=e._reactName,a=[];r!==null&&r!==n;){var s=r,l=s.alternate,c=s.stateNode;if(l!==null&&l===n)break;s.tag===5&&c!==null&&(s=c,o?(l=EC(r,i),l!=null&&a.unshift(LC(r,l,s))):o||(l=EC(r,i),l!=null&&a.push(LC(r,l,s)))),r=r.return}a.length!==0&&t.push({event:e,listeners:a})}var oRe=/\r\n?/g,iRe=/\u0000|\uFFFD/g;function yoe(t){return(typeof t=="string"?t:""+t).replace(oRe,`
`).replace(iRe,"")}function rI(t,e,r){if(e=yoe(e),yoe(t)!==e&&r)throw Error(it(425))}function PI(){}var vN=null,bN=null;function xN(t,e){return t==="textarea"||t==="noscript"||typeof e.children=="string"||typeof e.children=="number"||typeof e.dangerouslySetInnerHTML=="object"&&e.dangerouslySetInnerHTML!==null&&e.dangerouslySetInnerHTML.__html!=null}var SN=typeof setTimeout=="function"?setTimeout:void 0,aRe=typeof clearTimeout=="function"?clearTimeout:void 0,voe=typeof Promise=="function"?Promise:void 0,sRe=typeof queueMicrotask=="function"?queueMicrotask:typeof voe<"u"?function(t){return voe.resolve(null).then(t).catch(lRe)}:SN;function lRe(t){setTimeout(function(){throw t})}function UF(t,e){var r=e,n=0;do{var o=r.nextSibling;if(t.removeChild(r),o&&o.nodeType===8)if(r=o.data,r==="/$"){if(n===0){t.removeChild(o),AC(e);return}n--}else r!=="$"&&r!=="$?"&&r!=="$!"||n++;r=o}while(r);AC(e)}function eg(t){for(;t!=null;t=t.nextSibling){var e=t.nodeType;if(e===1||e===3)break;if(e===8){if(e=t.data,e==="$"||e==="$!"||e==="$?")break;if(e==="/$")return null}}return t}function boe(t){t=t.previousSibling;for(var e=0;t;){if(t.nodeType===8){var r=t.data;if(r==="$"||r==="$!"||r==="$?"){if(e===0)return t;e--}else r==="/$"&&e++}t=t.previousSibling}return null}var xx=Math.random().toString(36).slice(2),Wm="__reactFiber$"+xx,BC="__reactProps$"+xx,Xp="__reactContainer$"+xx,CN="__reactEvents$"+xx,cRe="__reactListeners$"+xx,uRe="__reactHandles$"+xx;function By(t){var e=t[Wm];if(e)return e;for(var r=t.parentNode;r;){if(e=r[Xp]||r[Wm]){if(r=e.alternate,e.child!==null||r!==null&&r.child!==null)for(t=boe(t);t!==null;){if(r=t[Wm])return r;t=boe(t)}return e}t=r,r=t.parentNode}return null}function HC(t){return t=t[Wm]||t[Xp],!t||t.tag!==5&&t.tag!==6&&t.tag!==13&&t.tag!==3?null:t}function Jb(t){if(t.tag===5||t.tag===6)return t.stateNode;throw Error(it(33))}function WI(t){return t[BC]||null}var TN=[],ex=-1;function lg(t){return{current:t}}function Io(t){0>ex||(t.current=TN[ex],TN[ex]=null,ex--)}function fo(t,e){ex++,TN[ex]=t.current,t.current=e}var ag={},js=lg(ag),Jl=lg(!1),zy=ag;function px(t,e){var r=t.type.contextTypes;if(!r)return ag;var n=t.stateNode;if(n&&n.__reactInternalMemoizedUnmaskedChildContext===e)return n.__reactInternalMemoizedMaskedChildContext;var o={},i;for(i in r)o[i]=e[i];return n&&(t=t.stateNode,t.__reactInternalMemoizedUnmaskedChildContext=e,t.__reactInternalMemoizedMaskedChildContext=o),o}function ec(t){return t=t.childContextTypes,t!=null}function EI(){Io(Jl),Io(js)}function xoe(t,e,r){if(js.current!==ag)throw Error(it(168));fo(js,e),fo(Jl,r)}function jie(t,e,r){var n=t.stateNode;if(e=e.childContextTypes,typeof n.getChildContext!="function")return r;n=n.getChildContext();for(var o in n)if(!(o in e))throw Error(it(108,KMe(t)||"Unknown",o));return ai({},r,n)}function II(t){return t=(t=t.stateNode)&&t.__reactInternalMemoizedMergedChildContext||ag,zy=js.current,fo(js,t),fo(Jl,Jl.current),!0}function Soe(t,e,r){var n=t.stateNode;if(!n)throw Error(it(169));r?(t=jie(t,e,zy),n.__reactInternalMemoizedMergedChildContext=t,Io(Jl),Io(js),fo(js,t)):Io(Jl),fo(Jl,r)}var Gp=null,XI=!1,GF=!1;function Hie(t){Gp===null?Gp=[t]:Gp.push(t)}function dRe(t){XI=!0,Hie(t)}function cg(){if(!GF&&Gp!==null){GF=!0;var t=0,e=Zn;try{var r=Gp;for(Zn=1;t<r.length;t++){var n=r[t];do n=n(!0);while(n!==null)}Gp=null,XI=!1}catch(o){throw Gp!==null&&(Gp=Gp.slice(t+1)),hie(KN,cg),o}finally{Zn=e,GF=!1}}return null}var tx=[],rx=0,DI=null,AI=0,Yu=[],Qu=0,Uy=null,jp=1,Hp="";function Ry(t,e){tx[rx++]=AI,tx[rx++]=DI,DI=t,AI=e}function qie(t,e,r){Yu[Qu++]=jp,Yu[Qu++]=Hp,Yu[Qu++]=Uy,Uy=t;var n=jp;t=Hp;var o=32-Xd(n)-1;n&=~(1<<o),r+=1;var i=32-Xd(e)+o;if(30<i){var a=o-o%5;i=(n&(1<<a)-1).toString(32),n>>=a,o-=a,jp=1<<32-Xd(e)+o|r<<o|n,Hp=i+t}else jp=1<<i|r<<o|n,Hp=t}function i4(t){t.return!==null&&(Ry(t,1),qie(t,1,0))}function a4(t){for(;t===DI;)DI=tx[--rx],tx[rx]=null,AI=tx[--rx],tx[rx]=null;for(;t===Uy;)Uy=Yu[--Qu],Yu[Qu]=null,Hp=Yu[--Qu],Yu[Qu]=null,jp=Yu[--Qu],Yu[Qu]=null}var Rc=null,Mc=null,qo=!1,Wd=null;function Wie(t,e){var r=Ku(5,null,null,0);r.elementType="DELETED",r.stateNode=e,r.return=t,e=t.deletions,e===null?(t.deletions=[r],t.flags|=16):e.push(r)}function Coe(t,e){switch(t.tag){case 5:var r=t.type;return e=e.nodeType!==1||r.toLowerCase()!==e.nodeName.toLowerCase()?null:e,e!==null?(t.stateNode=e,Rc=t,Mc=eg(e.firstChild),!0):!1;case 6:return e=t.pendingProps===""||e.nodeType!==3?null:e,e!==null?(t.stateNode=e,Rc=t,Mc=null,!0):!1;case 13:return e=e.nodeType!==8?null:e,e!==null?(r=Uy!==null?{id:jp,overflow:Hp}:null,t.memoizedState={dehydrated:e,treeContext:r,retryLane:1073741824},r=Ku(18,null,null,0),r.stateNode=e,r.return=t,t.child=r,Rc=t,Mc=null,!0):!1;default:return!1}}function wN(t){return(t.mode&1)!==0&&(t.flags&128)===0}function _N(t){if(qo){var e=Mc;if(e){var r=e;if(!Coe(t,e)){if(wN(t))throw Error(it(418));e=eg(r.nextSibling);var n=Rc;e&&Coe(t,e)?Wie(n,r):(t.flags=t.flags&-4097|2,qo=!1,Rc=t)}}else{if(wN(t))throw Error(it(418));t.flags=t.flags&-4097|2,qo=!1,Rc=t}}}function Toe(t){for(t=t.return;t!==null&&t.tag!==5&&t.tag!==3&&t.tag!==13;)t=t.return;Rc=t}function nI(t){if(t!==Rc)return!1;if(!qo)return Toe(t),qo=!0,!1;var e;if((e=t.tag!==3)&&!(e=t.tag!==5)&&(e=t.type,e=e!=="head"&&e!=="body"&&!xN(t.type,t.memoizedProps)),e&&(e=Mc)){if(wN(t))throw Xie(),Error(it(418));for(;e;)Wie(t,e),e=eg(e.nextSibling)}if(Toe(t),t.tag===13){if(t=t.memoizedState,t=t!==null?t.dehydrated:null,!t)throw Error(it(317));e:{for(t=t.nextSibling,e=0;t;){if(t.nodeType===8){var r=t.data;if(r==="/$"){if(e===0){Mc=eg(t.nextSibling);break e}e--}else r!=="$"&&r!=="$!"&&r!=="$?"||e++}t=t.nextSibling}Mc=null}}else Mc=Rc?eg(t.stateNode.nextSibling):null;return!0}function Xie(){for(var t=Mc;t;)t=eg(t.nextSibling)}function fx(){Mc=Rc=null,qo=!1}function s4(t){Wd===null?Wd=[t]:Wd.push(t)}var mRe=Kp.ReactCurrentBatchConfig;function lC(t,e,r){if(t=r.ref,t!==null&&typeof t!="function"&&typeof t!="object"){if(r._owner){if(r=r._owner,r){if(r.tag!==1)throw Error(it(309));var n=r.stateNode}if(!n)throw Error(it(147,t));var o=n,i=""+t;return e!==null&&e.ref!==null&&typeof e.ref=="function"&&e.ref._stringRef===i?e.ref:(e=function(a){var s=o.refs;a===null?delete s[i]:s[i]=a},e._stringRef=i,e)}if(typeof t!="string")throw Error(it(284));if(!r._owner)throw Error(it(290,t))}return t}function oI(t,e){throw t=Object.prototype.toString.call(e),Error(it(31,t==="[object Object]"?"object with keys {"+Object.keys(e).join(", ")+"}":t))}function woe(t){var e=t._init;return e(t._payload)}function Yie(t){function e(v,x){if(t){var S=v.deletions;S===null?(v.deletions=[x],v.flags|=16):S.push(x)}}function r(v,x){if(!t)return null;for(;x!==null;)e(v,x),x=x.sibling;return null}function n(v,x){for(v=new Map;x!==null;)x.key!==null?v.set(x.key,x):v.set(x.index,x),x=x.sibling;return v}function o(v,x){return v=og(v,x),v.index=0,v.sibling=null,v}function i(v,x,S){return v.index=S,t?(S=v.alternate,S!==null?(S=S.index,S<x?(v.flags|=2,x):S):(v.flags|=2,x)):(v.flags|=1048576,x)}function a(v){return t&&v.alternate===null&&(v.flags|=2),v}function s(v,x,S,T){return x===null||x.tag!==6?(x=QF(S,v.mode,T),x.return=v,x):(x=o(x,S),x.return=v,x)}function l(v,x,S,T){var E=S.type;return E===Qb?u(v,x,S.props.children,T,S.key):x!==null&&(x.elementType===E||typeof E=="object"&&E!==null&&E.$$typeof===qh&&woe(E)===x.type)?(T=o(x,S.props),T.ref=lC(v,x,S),T.return=v,T):(T=yI(S.type,S.key,S.props,null,v.mode,T),T.ref=lC(v,x,S),T.return=v,T)}function c(v,x,S,T){return x===null||x.tag!==4||x.stateNode.containerInfo!==S.containerInfo||x.stateNode.implementation!==S.implementation?(x=KF(S,v.mode,T),x.return=v,x):(x=o(x,S.children||[]),x.return=v,x)}function u(v,x,S,T,E){return x===null||x.tag!==7?(x=Vy(S,v.mode,T,E),x.return=v,x):(x=o(x,S),x.return=v,x)}function d(v,x,S){if(typeof x=="string"&&x!==""||typeof x=="number")return x=QF(""+x,v.mode,S),x.return=v,x;if(typeof x=="object"&&x!==null){switch(x.$$typeof){case jE:return S=yI(x.type,x.key,x.props,null,v.mode,S),S.ref=lC(v,null,x),S.return=v,S;case Yb:return x=KF(x,v.mode,S),x.return=v,x;case qh:var T=x._init;return d(v,T(x._payload),S)}if(pC(x)||oC(x))return x=Vy(x,v.mode,S,null),x.return=v,x;oI(v,x)}return null}function m(v,x,S,T){var E=x!==null?x.key:null;if(typeof S=="string"&&S!==""||typeof S=="number")return E!==null?null:s(v,x,""+S,T);if(typeof S=="object"&&S!==null){switch(S.$$typeof){case jE:return S.key===E?l(v,x,S,T):null;case Yb:return S.key===E?c(v,x,S,T):null;case qh:return E=S._init,m(v,x,E(S._payload),T)}if(pC(S)||oC(S))return E!==null?null:u(v,x,S,T,null);oI(v,S)}return null}function p(v,x,S,T,E){if(typeof T=="string"&&T!==""||typeof T=="number")return v=v.get(S)||null,s(x,v,""+T,E);if(typeof T=="object"&&T!==null){switch(T.$$typeof){case jE:return v=v.get(T.key===null?S:T.key)||null,l(x,v,T,E);case Yb:return v=v.get(T.key===null?S:T.key)||null,c(x,v,T,E);case qh:var _=T._init;return p(v,x,S,_(T._payload),E)}if(pC(T)||oC(T))return v=v.get(S)||null,u(x,v,T,E,null);oI(x,T)}return null}function h(v,x,S,T){for(var E=null,_=null,D=x,P=x=0,A=null;D!==null&&P<S.length;P++){D.index>P?(A=D,D=null):A=D.sibling;var I=m(v,D,S[P],T);if(I===null){D===null&&(D=A);break}t&&D&&I.alternate===null&&e(v,D),x=i(I,x,P),_===null?E=I:_.sibling=I,_=I,D=A}if(P===S.length)return r(v,D),qo&&Ry(v,P),E;if(D===null){for(;P<S.length;P++)D=d(v,S[P],T),D!==null&&(x=i(D,x,P),_===null?E=D:_.sibling=D,_=D);return qo&&Ry(v,P),E}for(D=n(v,D);P<S.length;P++)A=p(D,v,P,S[P],T),A!==null&&(t&&A.alternate!==null&&D.delete(A.key===null?P:A.key),x=i(A,x,P),_===null?E=A:_.sibling=A,_=A);return t&&D.forEach(function(k){return e(v,k)}),qo&&Ry(v,P),E}function f(v,x,S,T){var E=oC(S);if(typeof E!="function")throw Error(it(150));if(S=E.call(S),S==null)throw Error(it(151));for(var _=E=null,D=x,P=x=0,A=null,I=S.next();D!==null&&!I.done;P++,I=S.next()){D.index>P?(A=D,D=null):A=D.sibling;var k=m(v,D,I.value,T);if(k===null){D===null&&(D=A);break}t&&D&&k.alternate===null&&e(v,D),x=i(k,x,P),_===null?E=k:_.sibling=k,_=k,D=A}if(I.done)return r(v,D),qo&&Ry(v,P),E;if(D===null){for(;!I.done;P++,I=S.next())I=d(v,I.value,T),I!==null&&(x=i(I,x,P),_===null?E=I:_.sibling=I,_=I);return qo&&Ry(v,P),E}for(D=n(v,D);!I.done;P++,I=S.next())I=p(D,v,P,I.value,T),I!==null&&(t&&I.alternate!==null&&D.delete(I.key===null?P:I.key),x=i(I,x,P),_===null?E=I:_.sibling=I,_=I);return t&&D.forEach(function(M){return e(v,M)}),qo&&Ry(v,P),E}function b(v,x,S,T){if(typeof S=="object"&&S!==null&&S.type===Qb&&S.key===null&&(S=S.props.children),typeof S=="object"&&S!==null){switch(S.$$typeof){case jE:e:{for(var E=S.key,_=x;_!==null;){if(_.key===E){if(E=S.type,E===Qb){if(_.tag===7){r(v,_.sibling),x=o(_,S.props.children),x.return=v,v=x;break e}}else if(_.elementType===E||typeof E=="object"&&E!==null&&E.$$typeof===qh&&woe(E)===_.type){r(v,_.sibling),x=o(_,S.props),x.ref=lC(v,_,S),x.return=v,v=x;break e}r(v,_);break}else e(v,_);_=_.sibling}S.type===Qb?(x=Vy(S.props.children,v.mode,T,S.key),x.return=v,v=x):(T=yI(S.type,S.key,S.props,null,v.mode,T),T.ref=lC(v,x,S),T.return=v,v=T)}return a(v);case Yb:e:{for(_=S.key;x!==null;){if(x.key===_)if(x.tag===4&&x.stateNode.containerInfo===S.containerInfo&&x.stateNode.implementation===S.implementation){r(v,x.sibling),x=o(x,S.children||[]),x.return=v,v=x;break e}else{r(v,x);break}else e(v,x);x=x.sibling}x=KF(S,v.mode,T),x.return=v,v=x}return a(v);case qh:return _=S._init,b(v,x,_(S._payload),T)}if(pC(S))return h(v,x,S,T);if(oC(S))return f(v,x,S,T);oI(v,S)}return typeof S=="string"&&S!==""||typeof S=="number"?(S=""+S,x!==null&&x.tag===6?(r(v,x.sibling),x=o(x,S),x.return=v,v=x):(r(v,x),x=QF(S,v.mode,T),x.return=v,v=x),a(v)):r(v,x)}return b}var hx=Yie(!0),Qie=Yie(!1),kI=lg(null),MI=null,nx=null,l4=null;function c4(){l4=nx=MI=null}function u4(t){var e=kI.current;Io(kI),t._currentValue=e}function PN(t,e,r){for(;t!==null;){var n=t.alternate;if((t.childLanes&e)!==e?(t.childLanes|=e,n!==null&&(n.childLanes|=e)):n!==null&&(n.childLanes&e)!==e&&(n.childLanes|=e),t===r)break;t=t.return}}function ux(t,e){MI=t,l4=nx=null,t=t.dependencies,t!==null&&t.firstContext!==null&&(t.lanes&e&&(Zl=!0),t.firstContext=null)}function Zu(t){var e=t._currentValue;if(l4!==t)if(t={context:t,memoizedValue:e,next:null},nx===null){if(MI===null)throw Error(it(308));nx=t,MI.dependencies={lanes:0,firstContext:t}}else nx=nx.next=t;return e}var Oy=null;function d4(t){Oy===null?Oy=[t]:Oy.push(t)}function Kie(t,e,r,n){var o=e.interleaved;return o===null?(r.next=r,d4(e)):(r.next=o.next,o.next=r),e.interleaved=r,Yp(t,n)}function Yp(t,e){t.lanes|=e;var r=t.alternate;for(r!==null&&(r.lanes|=e),r=t,t=t.return;t!==null;)t.childLanes|=e,r=t.alternate,r!==null&&(r.childLanes|=e),r=t,t=t.return;return r.tag===3?r.stateNode:null}var Wh=!1;function m4(t){t.updateQueue={baseState:t.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,interleaved:null,lanes:0},effects:null}}function $ie(t,e){t=t.updateQueue,e.updateQueue===t&&(e.updateQueue={baseState:t.baseState,firstBaseUpdate:t.firstBaseUpdate,lastBaseUpdate:t.lastBaseUpdate,shared:t.shared,effects:t.effects})}function qp(t,e){return{eventTime:t,lane:e,tag:0,payload:null,callback:null,next:null}}function tg(t,e,r){var n=t.updateQueue;if(n===null)return null;if(n=n.shared,vn&2){var o=n.pending;return o===null?e.next=e:(e.next=o.next,o.next=e),n.pending=e,Yp(t,r)}return o=n.interleaved,o===null?(e.next=e,d4(n)):(e.next=o.next,o.next=e),n.interleaved=e,Yp(t,r)}function dI(t,e,r){if(e=e.updateQueue,e!==null&&(e=e.shared,(r&4194240)!==0)){var n=e.lanes;n&=t.pendingLanes,r|=n,e.lanes=r,$N(t,r)}}function _oe(t,e){var r=t.updateQueue,n=t.alternate;if(n!==null&&(n=n.updateQueue,r===n)){var o=null,i=null;if(r=r.firstBaseUpdate,r!==null){do{var a={eventTime:r.eventTime,lane:r.lane,tag:r.tag,payload:r.payload,callback:r.callback,next:null};i===null?o=i=a:i=i.next=a,r=r.next}while(r!==null);i===null?o=i=e:i=i.next=e}else o=i=e;r={baseState:n.baseState,firstBaseUpdate:o,lastBaseUpdate:i,shared:n.shared,effects:n.effects},t.updateQueue=r;return}t=r.lastBaseUpdate,t===null?r.firstBaseUpdate=e:t.next=e,r.lastBaseUpdate=e}function RI(t,e,r,n){var o=t.updateQueue;Wh=!1;var i=o.firstBaseUpdate,a=o.lastBaseUpdate,s=o.shared.pending;if(s!==null){o.shared.pending=null;var l=s,c=l.next;l.next=null,a===null?i=c:a.next=c,a=l;var u=t.alternate;u!==null&&(u=u.updateQueue,s=u.lastBaseUpdate,s!==a&&(s===null?u.firstBaseUpdate=c:s.next=c,u.lastBaseUpdate=l))}if(i!==null){var d=o.baseState;a=0,u=c=l=null,s=i;do{var m=s.lane,p=s.eventTime;if((n&m)===m){u!==null&&(u=u.next={eventTime:p,lane:0,tag:s.tag,payload:s.payload,callback:s.callback,next:null});e:{var h=t,f=s;switch(m=e,p=r,f.tag){case 1:if(h=f.payload,typeof h=="function"){d=h.call(p,d,m);break e}d=h;break e;case 3:h.flags=h.flags&-65537|128;case 0:if(h=f.payload,m=typeof h=="function"?h.call(p,d,m):h,m==null)break e;d=ai({},d,m);break e;case 2:Wh=!0}}s.callback!==null&&s.lane!==0&&(t.flags|=64,m=o.effects,m===null?o.effects=[s]:m.push(s))}else p={eventTime:p,lane:m,tag:s.tag,payload:s.payload,callback:s.callback,next:null},u===null?(c=u=p,l=d):u=u.next=p,a|=m;if(s=s.next,s===null){if(s=o.shared.pending,s===null)break;m=s,s=m.next,m.next=null,o.lastBaseUpdate=m,o.shared.pending=null}}while(!0);if(u===null&&(l=d),o.baseState=l,o.firstBaseUpdate=c,o.lastBaseUpdate=u,e=o.shared.interleaved,e!==null){o=e;do a|=o.lane,o=o.next;while(o!==e)}else i===null&&(o.shared.lanes=0);jy|=a,t.lanes=a,t.memoizedState=d}}function Poe(t,e,r){if(t=e.effects,e.effects=null,t!==null)for(e=0;e<t.length;e++){var n=t[e],o=n.callback;if(o!==null){if(n.callback=null,n=r,typeof o!="function")throw Error(it(191,o));o.call(n)}}}var qC={},Ym=lg(qC),OC=lg(qC),FC=lg(qC);function Fy(t){if(t===qC)throw Error(it(174));return t}function p4(t,e){switch(fo(FC,e),fo(OC,t),fo(Ym,qC),t=e.nodeType,t){case 9:case 11:e=(e=e.documentElement)?e.namespaceURI:aN(null,"");break;default:t=t===8?e.parentNode:e,e=t.namespaceURI||null,t=t.tagName,e=aN(e,t)}Io(Ym),fo(Ym,e)}function gx(){Io(Ym),Io(OC),Io(FC)}function Zie(t){Fy(FC.current);var e=Fy(Ym.current),r=aN(e,t.type);e!==r&&(fo(OC,t),fo(Ym,r))}function f4(t){OC.current===t&&(Io(Ym),Io(OC))}var oi=lg(0);function LI(t){for(var e=t;e!==null;){if(e.tag===13){var r=e.memoizedState;if(r!==null&&(r=r.dehydrated,r===null||r.data==="$?"||r.data==="$!"))return e}else if(e.tag===19&&e.memoizedProps.revealOrder!==void 0){if(e.flags&128)return e}else if(e.child!==null){e.child.return=e,e=e.child;continue}if(e===t)break;for(;e.sibling===null;){if(e.return===null||e.return===t)return null;e=e.return}e.sibling.return=e.return,e=e.sibling}return null}var jF=[];function h4(){for(var t=0;t<jF.length;t++)jF[t]._workInProgressVersionPrimary=null;jF.length=0}var mI=Kp.ReactCurrentDispatcher,HF=Kp.ReactCurrentBatchConfig,Gy=0,ii=null,ia=null,Ya=null,BI=!1,SC=!1,NC=0,pRe=0;function zs(){throw Error(it(321))}function g4(t,e){if(e===null)return!1;for(var r=0;r<e.length&&r<t.length;r++)if(!Qd(t[r],e[r]))return!1;return!0}function y4(t,e,r,n,o,i){if(Gy=i,ii=e,e.memoizedState=null,e.updateQueue=null,e.lanes=0,mI.current=t===null||t.memoizedState===null?yRe:vRe,t=r(n,o),SC){i=0;do{if(SC=!1,NC=0,25<=i)throw Error(it(301));i+=1,Ya=ia=null,e.updateQueue=null,mI.current=bRe,t=r(n,o)}while(SC)}if(mI.current=OI,e=ia!==null&&ia.next!==null,Gy=0,Ya=ia=ii=null,BI=!1,e)throw Error(it(300));return t}function v4(){var t=NC!==0;return NC=0,t}function qm(){var t={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return Ya===null?ii.memoizedState=Ya=t:Ya=Ya.next=t,Ya}function Ju(){if(ia===null){var t=ii.alternate;t=t!==null?t.memoizedState:null}else t=ia.next;var e=Ya===null?ii.memoizedState:Ya.next;if(e!==null)Ya=e,ia=t;else{if(t===null)throw Error(it(310));ia=t,t={memoizedState:ia.memoizedState,baseState:ia.baseState,baseQueue:ia.baseQueue,queue:ia.queue,next:null},Ya===null?ii.memoizedState=Ya=t:Ya=Ya.next=t}return Ya}function VC(t,e){return typeof e=="function"?e(t):e}function qF(t){var e=Ju(),r=e.queue;if(r===null)throw Error(it(311));r.lastRenderedReducer=t;var n=ia,o=n.baseQueue,i=r.pending;if(i!==null){if(o!==null){var a=o.next;o.next=i.next,i.next=a}n.baseQueue=o=i,r.pending=null}if(o!==null){i=o.next,n=n.baseState;var s=a=null,l=null,c=i;do{var u=c.lane;if((Gy&u)===u)l!==null&&(l=l.next={lane:0,action:c.action,hasEagerState:c.hasEagerState,eagerState:c.eagerState,next:null}),n=c.hasEagerState?c.eagerState:t(n,c.action);else{var d={lane:u,action:c.action,hasEagerState:c.hasEagerState,eagerState:c.eagerState,next:null};l===null?(s=l=d,a=n):l=l.next=d,ii.lanes|=u,jy|=u}c=c.next}while(c!==null&&c!==i);l===null?a=n:l.next=s,Qd(n,e.memoizedState)||(Zl=!0),e.memoizedState=n,e.baseState=a,e.baseQueue=l,r.lastRenderedState=n}if(t=r.interleaved,t!==null){o=t;do i=o.lane,ii.lanes|=i,jy|=i,o=o.next;while(o!==t)}else o===null&&(r.lanes=0);return[e.memoizedState,r.dispatch]}function WF(t){var e=Ju(),r=e.queue;if(r===null)throw Error(it(311));r.lastRenderedReducer=t;var n=r.dispatch,o=r.pending,i=e.memoizedState;if(o!==null){r.pending=null;var a=o=o.next;do i=t(i,a.action),a=a.next;while(a!==o);Qd(i,e.memoizedState)||(Zl=!0),e.memoizedState=i,e.baseQueue===null&&(e.baseState=i),r.lastRenderedState=i}return[i,n]}function Jie(){}function eae(t,e){var r=ii,n=Ju(),o=e(),i=!Qd(n.memoizedState,o);if(i&&(n.memoizedState=o,Zl=!0),n=n.queue,b4(nae.bind(null,r,n,t),[t]),n.getSnapshot!==e||i||Ya!==null&&Ya.memoizedState.tag&1){if(r.flags|=2048,zC(9,rae.bind(null,r,n,o,e),void 0,null),Qa===null)throw Error(it(349));Gy&30||tae(r,e,o)}return o}function tae(t,e,r){t.flags|=16384,t={getSnapshot:e,value:r},e=ii.updateQueue,e===null?(e={lastEffect:null,stores:null},ii.updateQueue=e,e.stores=[t]):(r=e.stores,r===null?e.stores=[t]:r.push(t))}function rae(t,e,r,n){e.value=r,e.getSnapshot=n,oae(e)&&iae(t)}function nae(t,e,r){return r(function(){oae(e)&&iae(t)})}function oae(t){var e=t.getSnapshot;t=t.value;try{var r=e();return!Qd(t,r)}catch{return!0}}function iae(t){var e=Yp(t,1);e!==null&&Yd(e,t,1,-1)}function Eoe(t){var e=qm();return typeof t=="function"&&(t=t()),e.memoizedState=e.baseState=t,t={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:VC,lastRenderedState:t},e.queue=t,t=t.dispatch=gRe.bind(null,ii,t),[e.memoizedState,t]}function zC(t,e,r,n){return t={tag:t,create:e,destroy:r,deps:n,next:null},e=ii.updateQueue,e===null?(e={lastEffect:null,stores:null},ii.updateQueue=e,e.lastEffect=t.next=t):(r=e.lastEffect,r===null?e.lastEffect=t.next=t:(n=r.next,r.next=t,t.next=n,e.lastEffect=t)),t}function aae(){return Ju().memoizedState}function pI(t,e,r,n){var o=qm();ii.flags|=t,o.memoizedState=zC(1|e,r,void 0,n===void 0?null:n)}function YI(t,e,r,n){var o=Ju();n=n===void 0?null:n;var i=void 0;if(ia!==null){var a=ia.memoizedState;if(i=a.destroy,n!==null&&g4(n,a.deps)){o.memoizedState=zC(e,r,i,n);return}}ii.flags|=t,o.memoizedState=zC(1|e,r,i,n)}function Ioe(t,e){return pI(8390656,8,t,e)}function b4(t,e){return YI(2048,8,t,e)}function sae(t,e){return YI(4,2,t,e)}function lae(t,e){return YI(4,4,t,e)}function cae(t,e){if(typeof e=="function")return t=t(),e(t),function(){e(null)};if(e!=null)return t=t(),e.current=t,function(){e.current=null}}function uae(t,e,r){return r=r!=null?r.concat([t]):null,YI(4,4,cae.bind(null,e,t),r)}function x4(){}function dae(t,e){var r=Ju();e=e===void 0?null:e;var n=r.memoizedState;return n!==null&&e!==null&&g4(e,n[1])?n[0]:(r.memoizedState=[t,e],t)}function mae(t,e){var r=Ju();e=e===void 0?null:e;var n=r.memoizedState;return n!==null&&e!==null&&g4(e,n[1])?n[0]:(t=t(),r.memoizedState=[t,e],t)}function pae(t,e,r){return Gy&21?(Qd(r,e)||(r=vie(),ii.lanes|=r,jy|=r,t.baseState=!0),e):(t.baseState&&(t.baseState=!1,Zl=!0),t.memoizedState=r)}function fRe(t,e){var r=Zn;Zn=r!==0&&4>r?r:4,t(!0);var n=HF.transition;HF.transition={};try{t(!1),e()}finally{Zn=r,HF.transition=n}}function fae(){return Ju().memoizedState}function hRe(t,e,r){var n=ng(t);if(r={lane:n,action:r,hasEagerState:!1,eagerState:null,next:null},hae(t))gae(e,r);else if(r=Kie(t,e,r,n),r!==null){var o=vl();Yd(r,t,n,o),yae(r,e,n)}}function gRe(t,e,r){var n=ng(t),o={lane:n,action:r,hasEagerState:!1,eagerState:null,next:null};if(hae(t))gae(e,o);else{var i=t.alternate;if(t.lanes===0&&(i===null||i.lanes===0)&&(i=e.lastRenderedReducer,i!==null))try{var a=e.lastRenderedState,s=i(a,r);if(o.hasEagerState=!0,o.eagerState=s,Qd(s,a)){var l=e.interleaved;l===null?(o.next=o,d4(e)):(o.next=l.next,l.next=o),e.interleaved=o;return}}catch{}finally{}r=Kie(t,e,o,n),r!==null&&(o=vl(),Yd(r,t,n,o),yae(r,e,n))}}function hae(t){var e=t.alternate;return t===ii||e!==null&&e===ii}function gae(t,e){SC=BI=!0;var r=t.pending;r===null?e.next=e:(e.next=r.next,r.next=e),t.pending=e}function yae(t,e,r){if(r&4194240){var n=e.lanes;n&=t.pendingLanes,r|=n,e.lanes=r,$N(t,r)}}var OI={readContext:Zu,useCallback:zs,useContext:zs,useEffect:zs,useImperativeHandle:zs,useInsertionEffect:zs,useLayoutEffect:zs,useMemo:zs,useReducer:zs,useRef:zs,useState:zs,useDebugValue:zs,useDeferredValue:zs,useTransition:zs,useMutableSource:zs,useSyncExternalStore:zs,useId:zs,unstable_isNewReconciler:!1},yRe={readContext:Zu,useCallback:function(t,e){return qm().memoizedState=[t,e===void 0?null:e],t},useContext:Zu,useEffect:Ioe,useImperativeHandle:function(t,e,r){return r=r!=null?r.concat([t]):null,pI(4194308,4,cae.bind(null,e,t),r)},useLayoutEffect:function(t,e){return pI(4194308,4,t,e)},useInsertionEffect:function(t,e){return pI(4,2,t,e)},useMemo:function(t,e){var r=qm();return e=e===void 0?null:e,t=t(),r.memoizedState=[t,e],t},useReducer:function(t,e,r){var n=qm();return e=r!==void 0?r(e):e,n.memoizedState=n.baseState=e,t={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:t,lastRenderedState:e},n.queue=t,t=t.dispatch=hRe.bind(null,ii,t),[n.memoizedState,t]},useRef:function(t){var e=qm();return t={current:t},e.memoizedState=t},useState:Eoe,useDebugValue:x4,useDeferredValue:function(t){return qm().memoizedState=t},useTransition:function(){var t=Eoe(!1),e=t[0];return t=fRe.bind(null,t[1]),qm().memoizedState=t,[e,t]},useMutableSource:function(){},useSyncExternalStore:function(t,e,r){var n=ii,o=qm();if(qo){if(r===void 0)throw Error(it(407));r=r()}else{if(r=e(),Qa===null)throw Error(it(349));Gy&30||tae(n,e,r)}o.memoizedState=r;var i={value:r,getSnapshot:e};return o.queue=i,Ioe(nae.bind(null,n,i,t),[t]),n.flags|=2048,zC(9,rae.bind(null,n,i,r,e),void 0,null),r},useId:function(){var t=qm(),e=Qa.identifierPrefix;if(qo){var r=Hp,n=jp;r=(n&~(1<<32-Xd(n)-1)).toString(32)+r,e=":"+e+"R"+r,r=NC++,0<r&&(e+="H"+r.toString(32)),e+=":"}else r=pRe++,e=":"+e+"r"+r.toString(32)+":";return t.memoizedState=e},unstable_isNewReconciler:!1},vRe={readContext:Zu,useCallback:dae,useContext:Zu,useEffect:b4,useImperativeHandle:uae,useInsertionEffect:sae,useLayoutEffect:lae,useMemo:mae,useReducer:qF,useRef:aae,useState:function(){return qF(VC)},useDebugValue:x4,useDeferredValue:function(t){var e=Ju();return pae(e,ia.memoizedState,t)},useTransition:function(){var t=qF(VC)[0],e=Ju().memoizedState;return[t,e]},useMutableSource:Jie,useSyncExternalStore:eae,useId:fae,unstable_isNewReconciler:!1},bRe={readContext:Zu,useCallback:dae,useContext:Zu,useEffect:b4,useImperativeHandle:uae,useInsertionEffect:sae,useLayoutEffect:lae,useMemo:mae,useReducer:WF,useRef:aae,useState:function(){return WF(VC)},useDebugValue:x4,useDeferredValue:function(t){var e=Ju();return ia===null?e.memoizedState=t:pae(e,ia.memoizedState,t)},useTransition:function(){var t=WF(VC)[0],e=Ju().memoizedState;return[t,e]},useMutableSource:Jie,useSyncExternalStore:eae,useId:fae,unstable_isNewReconciler:!1};function Hd(t,e){if(t&&t.defaultProps){e=ai({},e),t=t.defaultProps;for(var r in t)e[r]===void 0&&(e[r]=t[r]);return e}return e}function EN(t,e,r,n){e=t.memoizedState,r=r(n,e),r=r==null?e:ai({},e,r),t.memoizedState=r,t.lanes===0&&(t.updateQueue.baseState=r)}var QI={isMounted:function(t){return(t=t._reactInternals)?Wy(t)===t:!1},enqueueSetState:function(t,e,r){t=t._reactInternals;var n=vl(),o=ng(t),i=qp(n,o);i.payload=e,r!=null&&(i.callback=r),e=tg(t,i,o),e!==null&&(Yd(e,t,o,n),dI(e,t,o))},enqueueReplaceState:function(t,e,r){t=t._reactInternals;var n=vl(),o=ng(t),i=qp(n,o);i.tag=1,i.payload=e,r!=null&&(i.callback=r),e=tg(t,i,o),e!==null&&(Yd(e,t,o,n),dI(e,t,o))},enqueueForceUpdate:function(t,e){t=t._reactInternals;var r=vl(),n=ng(t),o=qp(r,n);o.tag=2,e!=null&&(o.callback=e),e=tg(t,o,n),e!==null&&(Yd(e,t,n,r),dI(e,t,n))}};function Doe(t,e,r,n,o,i,a){return t=t.stateNode,typeof t.shouldComponentUpdate=="function"?t.shouldComponentUpdate(n,i,a):e.prototype&&e.prototype.isPureReactComponent?!MC(r,n)||!MC(o,i):!0}function vae(t,e,r){var n=!1,o=ag,i=e.contextType;return typeof i=="object"&&i!==null?i=Zu(i):(o=ec(e)?zy:js.current,n=e.contextTypes,i=(n=n!=null)?px(t,o):ag),e=new e(r,i),t.memoizedState=e.state!==null&&e.state!==void 0?e.state:null,e.updater=QI,t.stateNode=e,e._reactInternals=t,n&&(t=t.stateNode,t.__reactInternalMemoizedUnmaskedChildContext=o,t.__reactInternalMemoizedMaskedChildContext=i),e}function Aoe(t,e,r,n){t=e.state,typeof e.componentWillReceiveProps=="function"&&e.componentWillReceiveProps(r,n),typeof e.UNSAFE_componentWillReceiveProps=="function"&&e.UNSAFE_componentWillReceiveProps(r,n),e.state!==t&&QI.enqueueReplaceState(e,e.state,null)}function IN(t,e,r,n){var o=t.stateNode;o.props=r,o.state=t.memoizedState,o.refs={},m4(t);var i=e.contextType;typeof i=="object"&&i!==null?o.context=Zu(i):(i=ec(e)?zy:js.current,o.context=px(t,i)),o.state=t.memoizedState,i=e.getDerivedStateFromProps,typeof i=="function"&&(EN(t,e,i,r),o.state=t.memoizedState),typeof e.getDerivedStateFromProps=="function"||typeof o.getSnapshotBeforeUpdate=="function"||typeof o.UNSAFE_componentWillMount!="function"&&typeof o.componentWillMount!="function"||(e=o.state,typeof o.componentWillMount=="function"&&o.componentWillMount(),typeof o.UNSAFE_componentWillMount=="function"&&o.UNSAFE_componentWillMount(),e!==o.state&&QI.enqueueReplaceState(o,o.state,null),RI(t,r,o,n),o.state=t.memoizedState),typeof o.componentDidMount=="function"&&(t.flags|=4194308)}function yx(t,e){try{var r="",n=e;do r+=QMe(n),n=n.return;while(n);var o=r}catch(i){o=`
Error generating stack: `+i.message+`
`+i.stack}return{value:t,source:e,stack:o,digest:null}}function XF(t,e,r){return{value:t,source:null,stack:r??null,digest:e??null}}function DN(t,e){try{console.error(e.value)}catch(r){setTimeout(function(){throw r})}}var xRe=typeof WeakMap=="function"?WeakMap:Map;function bae(t,e,r){r=qp(-1,r),r.tag=3,r.payload={element:null};var n=e.value;return r.callback=function(){NI||(NI=!0,VN=n),DN(t,e)},r}function xae(t,e,r){r=qp(-1,r),r.tag=3;var n=t.type.getDerivedStateFromError;if(typeof n=="function"){var o=e.value;r.payload=function(){return n(o)},r.callback=function(){DN(t,e)}}var i=t.stateNode;return i!==null&&typeof i.componentDidCatch=="function"&&(r.callback=function(){DN(t,e),typeof n!="function"&&(rg===null?rg=new Set([this]):rg.add(this));var a=e.stack;this.componentDidCatch(e.value,{componentStack:a!==null?a:""})}),r}function koe(t,e,r){var n=t.pingCache;if(n===null){n=t.pingCache=new xRe;var o=new Set;n.set(e,o)}else o=n.get(e),o===void 0&&(o=new Set,n.set(e,o));o.has(r)||(o.add(r),t=LRe.bind(null,t,e,r),e.then(t,t))}function Moe(t){do{var e;if((e=t.tag===13)&&(e=t.memoizedState,e=e!==null?e.dehydrated!==null:!0),e)return t;t=t.return}while(t!==null);return null}function Roe(t,e,r,n,o){return t.mode&1?(t.flags|=65536,t.lanes=o,t):(t===e?t.flags|=65536:(t.flags|=128,r.flags|=131072,r.flags&=-52805,r.tag===1&&(r.alternate===null?r.tag=17:(e=qp(-1,1),e.tag=2,tg(r,e,1))),r.lanes|=1),t)}var SRe=Kp.ReactCurrentOwner,Zl=!1;function yl(t,e,r,n){e.child=t===null?Qie(e,null,r,n):hx(e,t.child,r,n)}function Loe(t,e,r,n,o){r=r.render;var i=e.ref;return ux(e,o),n=y4(t,e,r,n,i,o),r=v4(),t!==null&&!Zl?(e.updateQueue=t.updateQueue,e.flags&=-2053,t.lanes&=~o,Qp(t,e,o)):(qo&&r&&i4(e),e.flags|=1,yl(t,e,n,o),e.child)}function Boe(t,e,r,n,o){if(t===null){var i=r.type;return typeof i=="function"&&!I4(i)&&i.defaultProps===void 0&&r.compare===null&&r.defaultProps===void 0?(e.tag=15,e.type=i,Sae(t,e,i,n,o)):(t=yI(r.type,null,n,e,e.mode,o),t.ref=e.ref,t.return=e,e.child=t)}if(i=t.child,!(t.lanes&o)){var a=i.memoizedProps;if(r=r.compare,r=r!==null?r:MC,r(a,n)&&t.ref===e.ref)return Qp(t,e,o)}return e.flags|=1,t=og(i,n),t.ref=e.ref,t.return=e,e.child=t}function Sae(t,e,r,n,o){if(t!==null){var i=t.memoizedProps;if(MC(i,n)&&t.ref===e.ref)if(Zl=!1,e.pendingProps=n=i,(t.lanes&o)!==0)t.flags&131072&&(Zl=!0);else return e.lanes=t.lanes,Qp(t,e,o)}return AN(t,e,r,n,o)}function Cae(t,e,r){var n=e.pendingProps,o=n.children,i=t!==null?t.memoizedState:null;if(n.mode==="hidden")if(!(e.mode&1))e.memoizedState={baseLanes:0,cachePool:null,transitions:null},fo(ix,kc),kc|=r;else{if(!(r&1073741824))return t=i!==null?i.baseLanes|r:r,e.lanes=e.childLanes=1073741824,e.memoizedState={baseLanes:t,cachePool:null,transitions:null},e.updateQueue=null,fo(ix,kc),kc|=t,null;e.memoizedState={baseLanes:0,cachePool:null,transitions:null},n=i!==null?i.baseLanes:r,fo(ix,kc),kc|=n}else i!==null?(n=i.baseLanes|r,e.memoizedState=null):n=r,fo(ix,kc),kc|=n;return yl(t,e,o,r),e.child}function Tae(t,e){var r=e.ref;(t===null&&r!==null||t!==null&&t.ref!==r)&&(e.flags|=512,e.flags|=2097152)}function AN(t,e,r,n,o){var i=ec(r)?zy:js.current;return i=px(e,i),ux(e,o),r=y4(t,e,r,n,i,o),n=v4(),t!==null&&!Zl?(e.updateQueue=t.updateQueue,e.flags&=-2053,t.lanes&=~o,Qp(t,e,o)):(qo&&n&&i4(e),e.flags|=1,yl(t,e,r,o),e.child)}function Ooe(t,e,r,n,o){if(ec(r)){var i=!0;II(e)}else i=!1;if(ux(e,o),e.stateNode===null)fI(t,e),vae(e,r,n),IN(e,r,n,o),n=!0;else if(t===null){var a=e.stateNode,s=e.memoizedProps;a.props=s;var l=a.context,c=r.contextType;typeof c=="object"&&c!==null?c=Zu(c):(c=ec(r)?zy:js.current,c=px(e,c));var u=r.getDerivedStateFromProps,d=typeof u=="function"||typeof a.getSnapshotBeforeUpdate=="function";d||typeof a.UNSAFE_componentWillReceiveProps!="function"&&typeof a.componentWillReceiveProps!="function"||(s!==n||l!==c)&&Aoe(e,a,n,c),Wh=!1;var m=e.memoizedState;a.state=m,RI(e,n,a,o),l=e.memoizedState,s!==n||m!==l||Jl.current||Wh?(typeof u=="function"&&(EN(e,r,u,n),l=e.memoizedState),(s=Wh||Doe(e,r,s,n,m,l,c))?(d||typeof a.UNSAFE_componentWillMount!="function"&&typeof a.componentWillMount!="function"||(typeof a.componentWillMount=="function"&&a.componentWillMount(),typeof a.UNSAFE_componentWillMount=="function"&&a.UNSAFE_componentWillMount()),typeof a.componentDidMount=="function"&&(e.flags|=4194308)):(typeof a.componentDidMount=="function"&&(e.flags|=4194308),e.memoizedProps=n,e.memoizedState=l),a.props=n,a.state=l,a.context=c,n=s):(typeof a.componentDidMount=="function"&&(e.flags|=4194308),n=!1)}else{a=e.stateNode,$ie(t,e),s=e.memoizedProps,c=e.type===e.elementType?s:Hd(e.type,s),a.props=c,d=e.pendingProps,m=a.context,l=r.contextType,typeof l=="object"&&l!==null?l=Zu(l):(l=ec(r)?zy:js.current,l=px(e,l));var p=r.getDerivedStateFromProps;(u=typeof p=="function"||typeof a.getSnapshotBeforeUpdate=="function")||typeof a.UNSAFE_componentWillReceiveProps!="function"&&typeof a.componentWillReceiveProps!="function"||(s!==d||m!==l)&&Aoe(e,a,n,l),Wh=!1,m=e.memoizedState,a.state=m,RI(e,n,a,o);var h=e.memoizedState;s!==d||m!==h||Jl.current||Wh?(typeof p=="function"&&(EN(e,r,p,n),h=e.memoizedState),(c=Wh||Doe(e,r,c,n,m,h,l)||!1)?(u||typeof a.UNSAFE_componentWillUpdate!="function"&&typeof a.componentWillUpdate!="function"||(typeof a.componentWillUpdate=="function"&&a.componentWillUpdate(n,h,l),typeof a.UNSAFE_componentWillUpdate=="function"&&a.UNSAFE_componentWillUpdate(n,h,l)),typeof a.componentDidUpdate=="function"&&(e.flags|=4),typeof a.getSnapshotBeforeUpdate=="function"&&(e.flags|=1024)):(typeof a.componentDidUpdate!="function"||s===t.memoizedProps&&m===t.memoizedState||(e.flags|=4),typeof a.getSnapshotBeforeUpdate!="function"||s===t.memoizedProps&&m===t.memoizedState||(e.flags|=1024),e.memoizedProps=n,e.memoizedState=h),a.props=n,a.state=h,a.context=l,n=c):(typeof a.componentDidUpdate!="function"||s===t.memoizedProps&&m===t.memoizedState||(e.flags|=4),typeof a.getSnapshotBeforeUpdate!="function"||s===t.memoizedProps&&m===t.memoizedState||(e.flags|=1024),n=!1)}return kN(t,e,r,n,i,o)}function kN(t,e,r,n,o,i){Tae(t,e);var a=(e.flags&128)!==0;if(!n&&!a)return o&&Soe(e,r,!1),Qp(t,e,i);n=e.stateNode,SRe.current=e;var s=a&&typeof r.getDerivedStateFromError!="function"?null:n.render();return e.flags|=1,t!==null&&a?(e.child=hx(e,t.child,null,i),e.child=hx(e,null,s,i)):yl(t,e,s,i),e.memoizedState=n.state,o&&Soe(e,r,!0),e.child}function wae(t){var e=t.stateNode;e.pendingContext?xoe(t,e.pendingContext,e.pendingContext!==e.context):e.context&&xoe(t,e.context,!1),p4(t,e.containerInfo)}function Foe(t,e,r,n,o){return fx(),s4(o),e.flags|=256,yl(t,e,r,n),e.child}var MN={dehydrated:null,treeContext:null,retryLane:0};function RN(t){return{baseLanes:t,cachePool:null,transitions:null}}function _ae(t,e,r){var n=e.pendingProps,o=oi.current,i=!1,a=(e.flags&128)!==0,s;if((s=a)||(s=t!==null&&t.memoizedState===null?!1:(o&2)!==0),s?(i=!0,e.flags&=-129):(t===null||t.memoizedState!==null)&&(o|=1),fo(oi,o&1),t===null)return _N(e),t=e.memoizedState,t!==null&&(t=t.dehydrated,t!==null)?(e.mode&1?t.data==="$!"?e.lanes=8:e.lanes=1073741824:e.lanes=1,null):(a=n.children,t=n.fallback,i?(n=e.mode,i=e.child,a={mode:"hidden",children:a},!(n&1)&&i!==null?(i.childLanes=0,i.pendingProps=a):i=ZI(a,n,0,null),t=Vy(t,n,r,null),i.return=e,t.return=e,i.sibling=t,e.child=i,e.child.memoizedState=RN(r),e.memoizedState=MN,t):S4(e,a));if(o=t.memoizedState,o!==null&&(s=o.dehydrated,s!==null))return CRe(t,e,a,n,s,o,r);if(i){i=n.fallback,a=e.mode,o=t.child,s=o.sibling;var l={mode:"hidden",children:n.children};return!(a&1)&&e.child!==o?(n=e.child,n.childLanes=0,n.pendingProps=l,e.deletions=null):(n=og(o,l),n.subtreeFlags=o.subtreeFlags&14680064),s!==null?i=og(s,i):(i=Vy(i,a,r,null),i.flags|=2),i.return=e,n.return=e,n.sibling=i,e.child=n,n=i,i=e.child,a=t.child.memoizedState,a=a===null?RN(r):{baseLanes:a.baseLanes|r,cachePool:null,transitions:a.transitions},i.memoizedState=a,i.childLanes=t.childLanes&~r,e.memoizedState=MN,n}return i=t.child,t=i.sibling,n=og(i,{mode:"visible",children:n.children}),!(e.mode&1)&&(n.lanes=r),n.return=e,n.sibling=null,t!==null&&(r=e.deletions,r===null?(e.deletions=[t],e.flags|=16):r.push(t)),e.child=n,e.memoizedState=null,n}function S4(t,e){return e=ZI({mode:"visible",children:e},t.mode,0,null),e.return=t,t.child=e}function iI(t,e,r,n){return n!==null&&s4(n),hx(e,t.child,null,r),t=S4(e,e.pendingProps.children),t.flags|=2,e.memoizedState=null,t}function CRe(t,e,r,n,o,i,a){if(r)return e.flags&256?(e.flags&=-257,n=XF(Error(it(422))),iI(t,e,a,n)):e.memoizedState!==null?(e.child=t.child,e.flags|=128,null):(i=n.fallback,o=e.mode,n=ZI({mode:"visible",children:n.children},o,0,null),i=Vy(i,o,a,null),i.flags|=2,n.return=e,i.return=e,n.sibling=i,e.child=n,e.mode&1&&hx(e,t.child,null,a),e.child.memoizedState=RN(a),e.memoizedState=MN,i);if(!(e.mode&1))return iI(t,e,a,null);if(o.data==="$!"){if(n=o.nextSibling&&o.nextSibling.dataset,n)var s=n.dgst;return n=s,i=Error(it(419)),n=XF(i,n,void 0),iI(t,e,a,n)}if(s=(a&t.childLanes)!==0,Zl||s){if(n=Qa,n!==null){switch(a&-a){case 4:o=2;break;case 16:o=8;break;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:o=32;break;case 536870912:o=268435456;break;default:o=0}o=o&(n.suspendedLanes|a)?0:o,o!==0&&o!==i.retryLane&&(i.retryLane=o,Yp(t,o),Yd(n,t,o,-1))}return E4(),n=XF(Error(it(421))),iI(t,e,a,n)}return o.data==="$?"?(e.flags|=128,e.child=t.child,e=BRe.bind(null,t),o._reactRetry=e,null):(t=i.treeContext,Mc=eg(o.nextSibling),Rc=e,qo=!0,Wd=null,t!==null&&(Yu[Qu++]=jp,Yu[Qu++]=Hp,Yu[Qu++]=Uy,jp=t.id,Hp=t.overflow,Uy=e),e=S4(e,n.children),e.flags|=4096,e)}function Noe(t,e,r){t.lanes|=e;var n=t.alternate;n!==null&&(n.lanes|=e),PN(t.return,e,r)}function YF(t,e,r,n,o){var i=t.memoizedState;i===null?t.memoizedState={isBackwards:e,rendering:null,renderingStartTime:0,last:n,tail:r,tailMode:o}:(i.isBackwards=e,i.rendering=null,i.renderingStartTime=0,i.last=n,i.tail=r,i.tailMode=o)}function Pae(t,e,r){var n=e.pendingProps,o=n.revealOrder,i=n.tail;if(yl(t,e,n.children,r),n=oi.current,n&2)n=n&1|2,e.flags|=128;else{if(t!==null&&t.flags&128)e:for(t=e.child;t!==null;){if(t.tag===13)t.memoizedState!==null&&Noe(t,r,e);else if(t.tag===19)Noe(t,r,e);else if(t.child!==null){t.child.return=t,t=t.child;continue}if(t===e)break e;for(;t.sibling===null;){if(t.return===null||t.return===e)break e;t=t.return}t.sibling.return=t.return,t=t.sibling}n&=1}if(fo(oi,n),!(e.mode&1))e.memoizedState=null;else switch(o){case"forwards":for(r=e.child,o=null;r!==null;)t=r.alternate,t!==null&&LI(t)===null&&(o=r),r=r.sibling;r=o,r===null?(o=e.child,e.child=null):(o=r.sibling,r.sibling=null),YF(e,!1,o,r,i);break;case"backwards":for(r=null,o=e.child,e.child=null;o!==null;){if(t=o.alternate,t!==null&&LI(t)===null){e.child=o;break}t=o.sibling,o.sibling=r,r=o,o=t}YF(e,!0,r,null,i);break;case"together":YF(e,!1,null,null,void 0);break;default:e.memoizedState=null}return e.child}function fI(t,e){!(e.mode&1)&&t!==null&&(t.alternate=null,e.alternate=null,e.flags|=2)}function Qp(t,e,r){if(t!==null&&(e.dependencies=t.dependencies),jy|=e.lanes,!(r&e.childLanes))return null;if(t!==null&&e.child!==t.child)throw Error(it(153));if(e.child!==null){for(t=e.child,r=og(t,t.pendingProps),e.child=r,r.return=e;t.sibling!==null;)t=t.sibling,r=r.sibling=og(t,t.pendingProps),r.return=e;r.sibling=null}return e.child}function TRe(t,e,r){switch(e.tag){case 3:wae(e),fx();break;case 5:Zie(e);break;case 1:ec(e.type)&&II(e);break;case 4:p4(e,e.stateNode.containerInfo);break;case 10:var n=e.type._context,o=e.memoizedProps.value;fo(kI,n._currentValue),n._currentValue=o;break;case 13:if(n=e.memoizedState,n!==null)return n.dehydrated!==null?(fo(oi,oi.current&1),e.flags|=128,null):r&e.child.childLanes?_ae(t,e,r):(fo(oi,oi.current&1),t=Qp(t,e,r),t!==null?t.sibling:null);fo(oi,oi.current&1);break;case 19:if(n=(r&e.childLanes)!==0,t.flags&128){if(n)return Pae(t,e,r);e.flags|=128}if(o=e.memoizedState,o!==null&&(o.rendering=null,o.tail=null,o.lastEffect=null),fo(oi,oi.current),n)break;return null;case 22:case 23:return e.lanes=0,Cae(t,e,r)}return Qp(t,e,r)}var Eae,LN,Iae,Dae;Eae=function(t,e){for(var r=e.child;r!==null;){if(r.tag===5||r.tag===6)t.appendChild(r.stateNode);else if(r.tag!==4&&r.child!==null){r.child.return=r,r=r.child;continue}if(r===e)break;for(;r.sibling===null;){if(r.return===null||r.return===e)return;r=r.return}r.sibling.return=r.return,r=r.sibling}};LN=function(){};Iae=function(t,e,r,n){var o=t.memoizedProps;if(o!==n){t=e.stateNode,Fy(Ym.current);var i=null;switch(r){case"input":o=rN(t,o),n=rN(t,n),i=[];break;case"select":o=ai({},o,{value:void 0}),n=ai({},n,{value:void 0}),i=[];break;case"textarea":o=iN(t,o),n=iN(t,n),i=[];break;default:typeof o.onClick!="function"&&typeof n.onClick=="function"&&(t.onclick=PI)}sN(r,n);var a;r=null;for(c in o)if(!n.hasOwnProperty(c)&&o.hasOwnProperty(c)&&o[c]!=null)if(c==="style"){var s=o[c];for(a in s)s.hasOwnProperty(a)&&(r||(r={}),r[a]="")}else c!=="dangerouslySetInnerHTML"&&c!=="children"&&c!=="suppressContentEditableWarning"&&c!=="suppressHydrationWarning"&&c!=="autoFocus"&&(_C.hasOwnProperty(c)?i||(i=[]):(i=i||[]).push(c,null));for(c in n){var l=n[c];if(s=o?.[c],n.hasOwnProperty(c)&&l!==s&&(l!=null||s!=null))if(c==="style")if(s){for(a in s)!s.hasOwnProperty(a)||l&&l.hasOwnProperty(a)||(r||(r={}),r[a]="");for(a in l)l.hasOwnProperty(a)&&s[a]!==l[a]&&(r||(r={}),r[a]=l[a])}else r||(i||(i=[]),i.push(c,r)),r=l;else c==="dangerouslySetInnerHTML"?(l=l?l.__html:void 0,s=s?s.__html:void 0,l!=null&&s!==l&&(i=i||[]).push(c,l)):c==="children"?typeof l!="string"&&typeof l!="number"||(i=i||[]).push(c,""+l):c!=="suppressContentEditableWarning"&&c!=="suppressHydrationWarning"&&(_C.hasOwnProperty(c)?(l!=null&&c==="onScroll"&&Eo("scroll",t),i||s===l||(i=[])):(i=i||[]).push(c,l))}r&&(i=i||[]).push("style",r);var c=i;(e.updateQueue=c)&&(e.flags|=4)}};Dae=function(t,e,r,n){r!==n&&(e.flags|=4)};function cC(t,e){if(!qo)switch(t.tailMode){case"hidden":e=t.tail;for(var r=null;e!==null;)e.alternate!==null&&(r=e),e=e.sibling;r===null?t.tail=null:r.sibling=null;break;case"collapsed":r=t.tail;for(var n=null;r!==null;)r.alternate!==null&&(n=r),r=r.sibling;n===null?e||t.tail===null?t.tail=null:t.tail.sibling=null:n.sibling=null}}function Us(t){var e=t.alternate!==null&&t.alternate.child===t.child,r=0,n=0;if(e)for(var o=t.child;o!==null;)r|=o.lanes|o.childLanes,n|=o.subtreeFlags&14680064,n|=o.flags&14680064,o.return=t,o=o.sibling;else for(o=t.child;o!==null;)r|=o.lanes|o.childLanes,n|=o.subtreeFlags,n|=o.flags,o.return=t,o=o.sibling;return t.subtreeFlags|=n,t.childLanes=r,e}function wRe(t,e,r){var n=e.pendingProps;switch(a4(e),e.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return Us(e),null;case 1:return ec(e.type)&&EI(),Us(e),null;case 3:return n=e.stateNode,gx(),Io(Jl),Io(js),h4(),n.pendingContext&&(n.context=n.pendingContext,n.pendingContext=null),(t===null||t.child===null)&&(nI(e)?e.flags|=4:t===null||t.memoizedState.isDehydrated&&!(e.flags&256)||(e.flags|=1024,Wd!==null&&(GN(Wd),Wd=null))),LN(t,e),Us(e),null;case 5:f4(e);var o=Fy(FC.current);if(r=e.type,t!==null&&e.stateNode!=null)Iae(t,e,r,n,o),t.ref!==e.ref&&(e.flags|=512,e.flags|=2097152);else{if(!n){if(e.stateNode===null)throw Error(it(166));return Us(e),null}if(t=Fy(Ym.current),nI(e)){n=e.stateNode,r=e.type;var i=e.memoizedProps;switch(n[Wm]=e,n[BC]=i,t=(e.mode&1)!==0,r){case"dialog":Eo("cancel",n),Eo("close",n);break;case"iframe":case"object":case"embed":Eo("load",n);break;case"video":case"audio":for(o=0;o<hC.length;o++)Eo(hC[o],n);break;case"source":Eo("error",n);break;case"img":case"image":case"link":Eo("error",n),Eo("load",n);break;case"details":Eo("toggle",n);break;case"input":Wne(n,i),Eo("invalid",n);break;case"select":n._wrapperState={wasMultiple:!!i.multiple},Eo("invalid",n);break;case"textarea":Yne(n,i),Eo("invalid",n)}sN(r,i),o=null;for(var a in i)if(i.hasOwnProperty(a)){var s=i[a];a==="children"?typeof s=="string"?n.textContent!==s&&(i.suppressHydrationWarning!==!0&&rI(n.textContent,s,t),o=["children",s]):typeof s=="number"&&n.textContent!==""+s&&(i.suppressHydrationWarning!==!0&&rI(n.textContent,s,t),o=["children",""+s]):_C.hasOwnProperty(a)&&s!=null&&a==="onScroll"&&Eo("scroll",n)}switch(r){case"input":HE(n),Xne(n,i,!0);break;case"textarea":HE(n),Qne(n);break;case"select":case"option":break;default:typeof i.onClick=="function"&&(n.onclick=PI)}n=o,e.updateQueue=n,n!==null&&(e.flags|=4)}else{a=o.nodeType===9?o:o.ownerDocument,t==="http://www.w3.org/1999/xhtml"&&(t=nie(r)),t==="http://www.w3.org/1999/xhtml"?r==="script"?(t=a.createElement("div"),t.innerHTML="<script><\/script>",t=t.removeChild(t.firstChild)):typeof n.is=="string"?t=a.createElement(r,{is:n.is}):(t=a.createElement(r),r==="select"&&(a=t,n.multiple?a.multiple=!0:n.size&&(a.size=n.size))):t=a.createElementNS(t,r),t[Wm]=e,t[BC]=n,Eae(t,e,!1,!1),e.stateNode=t;e:{switch(a=lN(r,n),r){case"dialog":Eo("cancel",t),Eo("close",t),o=n;break;case"iframe":case"object":case"embed":Eo("load",t),o=n;break;case"video":case"audio":for(o=0;o<hC.length;o++)Eo(hC[o],t);o=n;break;case"source":Eo("error",t),o=n;break;case"img":case"image":case"link":Eo("error",t),Eo("load",t),o=n;break;case"details":Eo("toggle",t),o=n;break;case"input":Wne(t,n),o=rN(t,n),Eo("invalid",t);break;case"option":o=n;break;case"select":t._wrapperState={wasMultiple:!!n.multiple},o=ai({},n,{value:void 0}),Eo("invalid",t);break;case"textarea":Yne(t,n),o=iN(t,n),Eo("invalid",t);break;default:o=n}sN(r,o),s=o;for(i in s)if(s.hasOwnProperty(i)){var l=s[i];i==="style"?aie(t,l):i==="dangerouslySetInnerHTML"?(l=l?l.__html:void 0,l!=null&&oie(t,l)):i==="children"?typeof l=="string"?(r!=="textarea"||l!=="")&&PC(t,l):typeof l=="number"&&PC(t,""+l):i!=="suppressContentEditableWarning"&&i!=="suppressHydrationWarning"&&i!=="autoFocus"&&(_C.hasOwnProperty(i)?l!=null&&i==="onScroll"&&Eo("scroll",t):l!=null&&qN(t,i,l,a))}switch(r){case"input":HE(t),Xne(t,n,!1);break;case"textarea":HE(t),Qne(t);break;case"option":n.value!=null&&t.setAttribute("value",""+ig(n.value));break;case"select":t.multiple=!!n.multiple,i=n.value,i!=null?ax(t,!!n.multiple,i,!1):n.defaultValue!=null&&ax(t,!!n.multiple,n.defaultValue,!0);break;default:typeof o.onClick=="function"&&(t.onclick=PI)}switch(r){case"button":case"input":case"select":case"textarea":n=!!n.autoFocus;break e;case"img":n=!0;break e;default:n=!1}}n&&(e.flags|=4)}e.ref!==null&&(e.flags|=512,e.flags|=2097152)}return Us(e),null;case 6:if(t&&e.stateNode!=null)Dae(t,e,t.memoizedProps,n);else{if(typeof n!="string"&&e.stateNode===null)throw Error(it(166));if(r=Fy(FC.current),Fy(Ym.current),nI(e)){if(n=e.stateNode,r=e.memoizedProps,n[Wm]=e,(i=n.nodeValue!==r)&&(t=Rc,t!==null))switch(t.tag){case 3:rI(n.nodeValue,r,(t.mode&1)!==0);break;case 5:t.memoizedProps.suppressHydrationWarning!==!0&&rI(n.nodeValue,r,(t.mode&1)!==0)}i&&(e.flags|=4)}else n=(r.nodeType===9?r:r.ownerDocument).createTextNode(n),n[Wm]=e,e.stateNode=n}return Us(e),null;case 13:if(Io(oi),n=e.memoizedState,t===null||t.memoizedState!==null&&t.memoizedState.dehydrated!==null){if(qo&&Mc!==null&&e.mode&1&&!(e.flags&128))Xie(),fx(),e.flags|=98560,i=!1;else if(i=nI(e),n!==null&&n.dehydrated!==null){if(t===null){if(!i)throw Error(it(318));if(i=e.memoizedState,i=i!==null?i.dehydrated:null,!i)throw Error(it(317));i[Wm]=e}else fx(),!(e.flags&128)&&(e.memoizedState=null),e.flags|=4;Us(e),i=!1}else Wd!==null&&(GN(Wd),Wd=null),i=!0;if(!i)return e.flags&65536?e:null}return e.flags&128?(e.lanes=r,e):(n=n!==null,n!==(t!==null&&t.memoizedState!==null)&&n&&(e.child.flags|=8192,e.mode&1&&(t===null||oi.current&1?aa===0&&(aa=3):E4())),e.updateQueue!==null&&(e.flags|=4),Us(e),null);case 4:return gx(),LN(t,e),t===null&&RC(e.stateNode.containerInfo),Us(e),null;case 10:return u4(e.type._context),Us(e),null;case 17:return ec(e.type)&&EI(),Us(e),null;case 19:if(Io(oi),i=e.memoizedState,i===null)return Us(e),null;if(n=(e.flags&128)!==0,a=i.rendering,a===null)if(n)cC(i,!1);else{if(aa!==0||t!==null&&t.flags&128)for(t=e.child;t!==null;){if(a=LI(t),a!==null){for(e.flags|=128,cC(i,!1),n=a.updateQueue,n!==null&&(e.updateQueue=n,e.flags|=4),e.subtreeFlags=0,n=r,r=e.child;r!==null;)i=r,t=n,i.flags&=14680066,a=i.alternate,a===null?(i.childLanes=0,i.lanes=t,i.child=null,i.subtreeFlags=0,i.memoizedProps=null,i.memoizedState=null,i.updateQueue=null,i.dependencies=null,i.stateNode=null):(i.childLanes=a.childLanes,i.lanes=a.lanes,i.child=a.child,i.subtreeFlags=0,i.deletions=null,i.memoizedProps=a.memoizedProps,i.memoizedState=a.memoizedState,i.updateQueue=a.updateQueue,i.type=a.type,t=a.dependencies,i.dependencies=t===null?null:{lanes:t.lanes,firstContext:t.firstContext}),r=r.sibling;return fo(oi,oi.current&1|2),e.child}t=t.sibling}i.tail!==null&&_i()>vx&&(e.flags|=128,n=!0,cC(i,!1),e.lanes=4194304)}else{if(!n)if(t=LI(a),t!==null){if(e.flags|=128,n=!0,r=t.updateQueue,r!==null&&(e.updateQueue=r,e.flags|=4),cC(i,!0),i.tail===null&&i.tailMode==="hidden"&&!a.alternate&&!qo)return Us(e),null}else 2*_i()-i.renderingStartTime>vx&&r!==1073741824&&(e.flags|=128,n=!0,cC(i,!1),e.lanes=4194304);i.isBackwards?(a.sibling=e.child,e.child=a):(r=i.last,r!==null?r.sibling=a:e.child=a,i.last=a)}return i.tail!==null?(e=i.tail,i.rendering=e,i.tail=e.sibling,i.renderingStartTime=_i(),e.sibling=null,r=oi.current,fo(oi,n?r&1|2:r&1),e):(Us(e),null);case 22:case 23:return P4(),n=e.memoizedState!==null,t!==null&&t.memoizedState!==null!==n&&(e.flags|=8192),n&&e.mode&1?kc&1073741824&&(Us(e),e.subtreeFlags&6&&(e.flags|=8192)):Us(e),null;case 24:return null;case 25:return null}throw Error(it(156,e.tag))}function _Re(t,e){switch(a4(e),e.tag){case 1:return ec(e.type)&&EI(),t=e.flags,t&65536?(e.flags=t&-65537|128,e):null;case 3:return gx(),Io(Jl),Io(js),h4(),t=e.flags,t&65536&&!(t&128)?(e.flags=t&-65537|128,e):null;case 5:return f4(e),null;case 13:if(Io(oi),t=e.memoizedState,t!==null&&t.dehydrated!==null){if(e.alternate===null)throw Error(it(340));fx()}return t=e.flags,t&65536?(e.flags=t&-65537|128,e):null;case 19:return Io(oi),null;case 4:return gx(),null;case 10:return u4(e.type._context),null;case 22:case 23:return P4(),null;case 24:return null;default:return null}}var aI=!1,Gs=!1,PRe=typeof WeakSet=="function"?WeakSet:Set,Rt=null;function ox(t,e){var r=t.ref;if(r!==null)if(typeof r=="function")try{r(null)}catch(n){hi(t,e,n)}else r.current=null}function BN(t,e,r){try{r()}catch(n){hi(t,e,n)}}var Voe=!1;function ERe(t,e){if(vN=TI,t=Lie(),o4(t)){if("selectionStart"in t)var r={start:t.selectionStart,end:t.selectionEnd};else e:{r=(r=t.ownerDocument)&&r.defaultView||window;var n=r.getSelection&&r.getSelection();if(n&&n.rangeCount!==0){r=n.anchorNode;var o=n.anchorOffset,i=n.focusNode;n=n.focusOffset;try{r.nodeType,i.nodeType}catch{r=null;break e}var a=0,s=-1,l=-1,c=0,u=0,d=t,m=null;t:for(;;){for(var p;d!==r||o!==0&&d.nodeType!==3||(s=a+o),d!==i||n!==0&&d.nodeType!==3||(l=a+n),d.nodeType===3&&(a+=d.nodeValue.length),(p=d.firstChild)!==null;)m=d,d=p;for(;;){if(d===t)break t;if(m===r&&++c===o&&(s=a),m===i&&++u===n&&(l=a),(p=d.nextSibling)!==null)break;d=m,m=d.parentNode}d=p}r=s===-1||l===-1?null:{start:s,end:l}}else r=null}r=r||{start:0,end:0}}else r=null;for(bN={focusedElem:t,selectionRange:r},TI=!1,Rt=e;Rt!==null;)if(e=Rt,t=e.child,(e.subtreeFlags&1028)!==0&&t!==null)t.return=e,Rt=t;else for(;Rt!==null;){e=Rt;try{var h=e.alternate;if(e.flags&1024)switch(e.tag){case 0:case 11:case 15:break;case 1:if(h!==null){var f=h.memoizedProps,b=h.memoizedState,v=e.stateNode,x=v.getSnapshotBeforeUpdate(e.elementType===e.type?f:Hd(e.type,f),b);v.__reactInternalSnapshotBeforeUpdate=x}break;case 3:var S=e.stateNode.containerInfo;S.nodeType===1?S.textContent="":S.nodeType===9&&S.documentElement&&S.removeChild(S.documentElement);break;case 5:case 6:case 4:case 17:break;default:throw Error(it(163))}}catch(T){hi(e,e.return,T)}if(t=e.sibling,t!==null){t.return=e.return,Rt=t;break}Rt=e.return}return h=Voe,Voe=!1,h}function CC(t,e,r){var n=e.updateQueue;if(n=n!==null?n.lastEffect:null,n!==null){var o=n=n.next;do{if((o.tag&t)===t){var i=o.destroy;o.destroy=void 0,i!==void 0&&BN(e,r,i)}o=o.next}while(o!==n)}}function KI(t,e){if(e=e.updateQueue,e=e!==null?e.lastEffect:null,e!==null){var r=e=e.next;do{if((r.tag&t)===t){var n=r.create;r.destroy=n()}r=r.next}while(r!==e)}}function ON(t){var e=t.ref;if(e!==null){var r=t.stateNode;switch(t.tag){case 5:t=r;break;default:t=r}typeof e=="function"?e(t):e.current=t}}function Aae(t){var e=t.alternate;e!==null&&(t.alternate=null,Aae(e)),t.child=null,t.deletions=null,t.sibling=null,t.tag===5&&(e=t.stateNode,e!==null&&(delete e[Wm],delete e[BC],delete e[CN],delete e[cRe],delete e[uRe])),t.stateNode=null,t.return=null,t.dependencies=null,t.memoizedProps=null,t.memoizedState=null,t.pendingProps=null,t.stateNode=null,t.updateQueue=null}function kae(t){return t.tag===5||t.tag===3||t.tag===4}function zoe(t){e:for(;;){for(;t.sibling===null;){if(t.return===null||kae(t.return))return null;t=t.return}for(t.sibling.return=t.return,t=t.sibling;t.tag!==5&&t.tag!==6&&t.tag!==18;){if(t.flags&2||t.child===null||t.tag===4)continue e;t.child.return=t,t=t.child}if(!(t.flags&2))return t.stateNode}}function FN(t,e,r){var n=t.tag;if(n===5||n===6)t=t.stateNode,e?r.nodeType===8?r.parentNode.insertBefore(t,e):r.insertBefore(t,e):(r.nodeType===8?(e=r.parentNode,e.insertBefore(t,r)):(e=r,e.appendChild(t)),r=r._reactRootContainer,r!=null||e.onclick!==null||(e.onclick=PI));else if(n!==4&&(t=t.child,t!==null))for(FN(t,e,r),t=t.sibling;t!==null;)FN(t,e,r),t=t.sibling}function NN(t,e,r){var n=t.tag;if(n===5||n===6)t=t.stateNode,e?r.insertBefore(t,e):r.appendChild(t);else if(n!==4&&(t=t.child,t!==null))for(NN(t,e,r),t=t.sibling;t!==null;)NN(t,e,r),t=t.sibling}var us=null,qd=!1;function Hh(t,e,r){for(r=r.child;r!==null;)Mae(t,e,r),r=r.sibling}function Mae(t,e,r){if(Xm&&typeof Xm.onCommitFiberUnmount=="function")try{Xm.onCommitFiberUnmount(GI,r)}catch{}switch(r.tag){case 5:Gs||ox(r,e);case 6:var n=us,o=qd;us=null,Hh(t,e,r),us=n,qd=o,us!==null&&(qd?(t=us,r=r.stateNode,t.nodeType===8?t.parentNode.removeChild(r):t.removeChild(r)):us.removeChild(r.stateNode));break;case 18:us!==null&&(qd?(t=us,r=r.stateNode,t.nodeType===8?UF(t.parentNode,r):t.nodeType===1&&UF(t,r),AC(t)):UF(us,r.stateNode));break;case 4:n=us,o=qd,us=r.stateNode.containerInfo,qd=!0,Hh(t,e,r),us=n,qd=o;break;case 0:case 11:case 14:case 15:if(!Gs&&(n=r.updateQueue,n!==null&&(n=n.lastEffect,n!==null))){o=n=n.next;do{var i=o,a=i.destroy;i=i.tag,a!==void 0&&(i&2||i&4)&&BN(r,e,a),o=o.next}while(o!==n)}Hh(t,e,r);break;case 1:if(!Gs&&(ox(r,e),n=r.stateNode,typeof n.componentWillUnmount=="function"))try{n.props=r.memoizedProps,n.state=r.memoizedState,n.componentWillUnmount()}catch(s){hi(r,e,s)}Hh(t,e,r);break;case 21:Hh(t,e,r);break;case 22:r.mode&1?(Gs=(n=Gs)||r.memoizedState!==null,Hh(t,e,r),Gs=n):Hh(t,e,r);break;default:Hh(t,e,r)}}function Uoe(t){var e=t.updateQueue;if(e!==null){t.updateQueue=null;var r=t.stateNode;r===null&&(r=t.stateNode=new PRe),e.forEach(function(n){var o=ORe.bind(null,t,n);r.has(n)||(r.add(n),n.then(o,o))})}}function jd(t,e){var r=e.deletions;if(r!==null)for(var n=0;n<r.length;n++){var o=r[n];try{var i=t,a=e,s=a;e:for(;s!==null;){switch(s.tag){case 5:us=s.stateNode,qd=!1;break e;case 3:us=s.stateNode.containerInfo,qd=!0;break e;case 4:us=s.stateNode.containerInfo,qd=!0;break e}s=s.return}if(us===null)throw Error(it(160));Mae(i,a,o),us=null,qd=!1;var l=o.alternate;l!==null&&(l.return=null),o.return=null}catch(c){hi(o,e,c)}}if(e.subtreeFlags&12854)for(e=e.child;e!==null;)Rae(e,t),e=e.sibling}function Rae(t,e){var r=t.alternate,n=t.flags;switch(t.tag){case 0:case 11:case 14:case 15:if(jd(e,t),Hm(t),n&4){try{CC(3,t,t.return),KI(3,t)}catch(f){hi(t,t.return,f)}try{CC(5,t,t.return)}catch(f){hi(t,t.return,f)}}break;case 1:jd(e,t),Hm(t),n&512&&r!==null&&ox(r,r.return);break;case 5:if(jd(e,t),Hm(t),n&512&&r!==null&&ox(r,r.return),t.flags&32){var o=t.stateNode;try{PC(o,"")}catch(f){hi(t,t.return,f)}}if(n&4&&(o=t.stateNode,o!=null)){var i=t.memoizedProps,a=r!==null?r.memoizedProps:i,s=t.type,l=t.updateQueue;if(t.updateQueue=null,l!==null)try{s==="input"&&i.type==="radio"&&i.name!=null&&tie(o,i),lN(s,a);var c=lN(s,i);for(a=0;a<l.length;a+=2){var u=l[a],d=l[a+1];u==="style"?aie(o,d):u==="dangerouslySetInnerHTML"?oie(o,d):u==="children"?PC(o,d):qN(o,u,d,c)}switch(s){case"input":nN(o,i);break;case"textarea":rie(o,i);break;case"select":var m=o._wrapperState.wasMultiple;o._wrapperState.wasMultiple=!!i.multiple;var p=i.value;p!=null?ax(o,!!i.multiple,p,!1):m!==!!i.multiple&&(i.defaultValue!=null?ax(o,!!i.multiple,i.defaultValue,!0):ax(o,!!i.multiple,i.multiple?[]:"",!1))}o[BC]=i}catch(f){hi(t,t.return,f)}}break;case 6:if(jd(e,t),Hm(t),n&4){if(t.stateNode===null)throw Error(it(162));o=t.stateNode,i=t.memoizedProps;try{o.nodeValue=i}catch(f){hi(t,t.return,f)}}break;case 3:if(jd(e,t),Hm(t),n&4&&r!==null&&r.memoizedState.isDehydrated)try{AC(e.containerInfo)}catch(f){hi(t,t.return,f)}break;case 4:jd(e,t),Hm(t);break;case 13:jd(e,t),Hm(t),o=t.child,o.flags&8192&&(i=o.memoizedState!==null,o.stateNode.isHidden=i,!i||o.alternate!==null&&o.alternate.memoizedState!==null||(w4=_i())),n&4&&Uoe(t);break;case 22:if(u=r!==null&&r.memoizedState!==null,t.mode&1?(Gs=(c=Gs)||u,jd(e,t),Gs=c):jd(e,t),Hm(t),n&8192){if(c=t.memoizedState!==null,(t.stateNode.isHidden=c)&&!u&&t.mode&1)for(Rt=t,u=t.child;u!==null;){for(d=Rt=u;Rt!==null;){switch(m=Rt,p=m.child,m.tag){case 0:case 11:case 14:case 15:CC(4,m,m.return);break;case 1:ox(m,m.return);var h=m.stateNode;if(typeof h.componentWillUnmount=="function"){n=m,r=m.return;try{e=n,h.props=e.memoizedProps,h.state=e.memoizedState,h.componentWillUnmount()}catch(f){hi(n,r,f)}}break;case 5:ox(m,m.return);break;case 22:if(m.memoizedState!==null){joe(d);continue}}p!==null?(p.return=m,Rt=p):joe(d)}u=u.sibling}e:for(u=null,d=t;;){if(d.tag===5){if(u===null){u=d;try{o=d.stateNode,c?(i=o.style,typeof i.setProperty=="function"?i.setProperty("display","none","important"):i.display="none"):(s=d.stateNode,l=d.memoizedProps.style,a=l!=null&&l.hasOwnProperty("display")?l.display:null,s.style.display=iie("display",a))}catch(f){hi(t,t.return,f)}}}else if(d.tag===6){if(u===null)try{d.stateNode.nodeValue=c?"":d.memoizedProps}catch(f){hi(t,t.return,f)}}else if((d.tag!==22&&d.tag!==23||d.memoizedState===null||d===t)&&d.child!==null){d.child.return=d,d=d.child;continue}if(d===t)break e;for(;d.sibling===null;){if(d.return===null||d.return===t)break e;u===d&&(u=null),d=d.return}u===d&&(u=null),d.sibling.return=d.return,d=d.sibling}}break;case 19:jd(e,t),Hm(t),n&4&&Uoe(t);break;case 21:break;default:jd(e,t),Hm(t)}}function Hm(t){var e=t.flags;if(e&2){try{e:{for(var r=t.return;r!==null;){if(kae(r)){var n=r;break e}r=r.return}throw Error(it(160))}switch(n.tag){case 5:var o=n.stateNode;n.flags&32&&(PC(o,""),n.flags&=-33);var i=zoe(t);NN(t,i,o);break;case 3:case 4:var a=n.stateNode.containerInfo,s=zoe(t);FN(t,s,a);break;default:throw Error(it(161))}}catch(l){hi(t,t.return,l)}t.flags&=-3}e&4096&&(t.flags&=-4097)}function IRe(t,e,r){Rt=t,Lae(t,e,r)}function Lae(t,e,r){for(var n=(t.mode&1)!==0;Rt!==null;){var o=Rt,i=o.child;if(o.tag===22&&n){var a=o.memoizedState!==null||aI;if(!a){var s=o.alternate,l=s!==null&&s.memoizedState!==null||Gs;s=aI;var c=Gs;if(aI=a,(Gs=l)&&!c)for(Rt=o;Rt!==null;)a=Rt,l=a.child,a.tag===22&&a.memoizedState!==null?Hoe(o):l!==null?(l.return=a,Rt=l):Hoe(o);for(;i!==null;)Rt=i,Lae(i,e,r),i=i.sibling;Rt=o,aI=s,Gs=c}Goe(t,e,r)}else o.subtreeFlags&8772&&i!==null?(i.return=o,Rt=i):Goe(t,e,r)}}function Goe(t){for(;Rt!==null;){var e=Rt;if(e.flags&8772){var r=e.alternate;try{if(e.flags&8772)switch(e.tag){case 0:case 11:case 15:Gs||KI(5,e);break;case 1:var n=e.stateNode;if(e.flags&4&&!Gs)if(r===null)n.componentDidMount();else{var o=e.elementType===e.type?r.memoizedProps:Hd(e.type,r.memoizedProps);n.componentDidUpdate(o,r.memoizedState,n.__reactInternalSnapshotBeforeUpdate)}var i=e.updateQueue;i!==null&&Poe(e,i,n);break;case 3:var a=e.updateQueue;if(a!==null){if(r=null,e.child!==null)switch(e.child.tag){case 5:r=e.child.stateNode;break;case 1:r=e.child.stateNode}Poe(e,a,r)}break;case 5:var s=e.stateNode;if(r===null&&e.flags&4){r=s;var l=e.memoizedProps;switch(e.type){case"button":case"input":case"select":case"textarea":l.autoFocus&&r.focus();break;case"img":l.src&&(r.src=l.src)}}break;case 6:break;case 4:break;case 12:break;case 13:if(e.memoizedState===null){var c=e.alternate;if(c!==null){var u=c.memoizedState;if(u!==null){var d=u.dehydrated;d!==null&&AC(d)}}}break;case 19:case 17:case 21:case 22:case 23:case 25:break;default:throw Error(it(163))}Gs||e.flags&512&&ON(e)}catch(m){hi(e,e.return,m)}}if(e===t){Rt=null;break}if(r=e.sibling,r!==null){r.return=e.return,Rt=r;break}Rt=e.return}}function joe(t){for(;Rt!==null;){var e=Rt;if(e===t){Rt=null;break}var r=e.sibling;if(r!==null){r.return=e.return,Rt=r;break}Rt=e.return}}function Hoe(t){for(;Rt!==null;){var e=Rt;try{switch(e.tag){case 0:case 11:case 15:var r=e.return;try{KI(4,e)}catch(l){hi(e,r,l)}break;case 1:var n=e.stateNode;if(typeof n.componentDidMount=="function"){var o=e.return;try{n.componentDidMount()}catch(l){hi(e,o,l)}}var i=e.return;try{ON(e)}catch(l){hi(e,i,l)}break;case 5:var a=e.return;try{ON(e)}catch(l){hi(e,a,l)}}}catch(l){hi(e,e.return,l)}if(e===t){Rt=null;break}var s=e.sibling;if(s!==null){s.return=e.return,Rt=s;break}Rt=e.return}}var DRe=Math.ceil,FI=Kp.ReactCurrentDispatcher,C4=Kp.ReactCurrentOwner,$u=Kp.ReactCurrentBatchConfig,vn=0,Qa=null,Zi=null,ds=0,kc=0,ix=lg(0),aa=0,UC=null,jy=0,$I=0,T4=0,TC=null,$l=null,w4=0,vx=1/0,Up=null,NI=!1,VN=null,rg=null,sI=!1,Kh=null,VI=0,wC=0,zN=null,hI=-1,gI=0;function vl(){return vn&6?_i():hI!==-1?hI:hI=_i()}function ng(t){return t.mode&1?vn&2&&ds!==0?ds&-ds:mRe.transition!==null?(gI===0&&(gI=vie()),gI):(t=Zn,t!==0||(t=window.event,t=t===void 0?16:_ie(t.type)),t):1}function Yd(t,e,r,n){if(50<wC)throw wC=0,zN=null,Error(it(185));GC(t,r,n),(!(vn&2)||t!==Qa)&&(t===Qa&&(!(vn&2)&&($I|=r),aa===4&&Yh(t,ds)),tc(t,n),r===1&&vn===0&&!(e.mode&1)&&(vx=_i()+500,XI&&cg()))}function tc(t,e){var r=t.callbackNode;f3e(t,e);var n=CI(t,t===Qa?ds:0);if(n===0)r!==null&&Zne(r),t.callbackNode=null,t.callbackPriority=0;else if(e=n&-n,t.callbackPriority!==e){if(r!=null&&Zne(r),e===1)t.tag===0?dRe(qoe.bind(null,t)):Hie(qoe.bind(null,t)),sRe(function(){!(vn&6)&&cg()}),r=null;else{switch(bie(n)){case 1:r=KN;break;case 4:r=gie;break;case 16:r=SI;break;case 536870912:r=yie;break;default:r=SI}r=Gae(r,Bae.bind(null,t))}t.callbackPriority=e,t.callbackNode=r}}function Bae(t,e){if(hI=-1,gI=0,vn&6)throw Error(it(327));var r=t.callbackNode;if(dx()&&t.callbackNode!==r)return null;var n=CI(t,t===Qa?ds:0);if(n===0)return null;if(n&30||n&t.expiredLanes||e)e=zI(t,n);else{e=n;var o=vn;vn|=2;var i=Fae();(Qa!==t||ds!==e)&&(Up=null,vx=_i()+500,Ny(t,e));do try{MRe();break}catch(s){Oae(t,s)}while(!0);c4(),FI.current=i,vn=o,Zi!==null?e=0:(Qa=null,ds=0,e=aa)}if(e!==0){if(e===2&&(o=pN(t),o!==0&&(n=o,e=UN(t,o))),e===1)throw r=UC,Ny(t,0),Yh(t,n),tc(t,_i()),r;if(e===6)Yh(t,n);else{if(o=t.current.alternate,!(n&30)&&!ARe(o)&&(e=zI(t,n),e===2&&(i=pN(t),i!==0&&(n=i,e=UN(t,i))),e===1))throw r=UC,Ny(t,0),Yh(t,n),tc(t,_i()),r;switch(t.finishedWork=o,t.finishedLanes=n,e){case 0:case 1:throw Error(it(345));case 2:Ly(t,$l,Up);break;case 3:if(Yh(t,n),(n&130023424)===n&&(e=w4+500-_i(),10<e)){if(CI(t,0)!==0)break;if(o=t.suspendedLanes,(o&n)!==n){vl(),t.pingedLanes|=t.suspendedLanes&o;break}t.timeoutHandle=SN(Ly.bind(null,t,$l,Up),e);break}Ly(t,$l,Up);break;case 4:if(Yh(t,n),(n&4194240)===n)break;for(e=t.eventTimes,o=-1;0<n;){var a=31-Xd(n);i=1<<a,a=e[a],a>o&&(o=a),n&=~i}if(n=o,n=_i()-n,n=(120>n?120:480>n?480:1080>n?1080:1920>n?1920:3e3>n?3e3:4320>n?4320:1960*DRe(n/1960))-n,10<n){t.timeoutHandle=SN(Ly.bind(null,t,$l,Up),n);break}Ly(t,$l,Up);break;case 5:Ly(t,$l,Up);break;default:throw Error(it(329))}}}return tc(t,_i()),t.callbackNode===r?Bae.bind(null,t):null}function UN(t,e){var r=TC;return t.current.memoizedState.isDehydrated&&(Ny(t,e).flags|=256),t=zI(t,e),t!==2&&(e=$l,$l=r,e!==null&&GN(e)),t}function GN(t){$l===null?$l=t:$l.push.apply($l,t)}function ARe(t){for(var e=t;;){if(e.flags&16384){var r=e.updateQueue;if(r!==null&&(r=r.stores,r!==null))for(var n=0;n<r.length;n++){var o=r[n],i=o.getSnapshot;o=o.value;try{if(!Qd(i(),o))return!1}catch{return!1}}}if(r=e.child,e.subtreeFlags&16384&&r!==null)r.return=e,e=r;else{if(e===t)break;for(;e.sibling===null;){if(e.return===null||e.return===t)return!0;e=e.return}e.sibling.return=e.return,e=e.sibling}}return!0}function Yh(t,e){for(e&=~T4,e&=~$I,t.suspendedLanes|=e,t.pingedLanes&=~e,t=t.expirationTimes;0<e;){var r=31-Xd(e),n=1<<r;t[r]=-1,e&=~n}}function qoe(t){if(vn&6)throw Error(it(327));dx();var e=CI(t,0);if(!(e&1))return tc(t,_i()),null;var r=zI(t,e);if(t.tag!==0&&r===2){var n=pN(t);n!==0&&(e=n,r=UN(t,n))}if(r===1)throw r=UC,Ny(t,0),Yh(t,e),tc(t,_i()),r;if(r===6)throw Error(it(345));return t.finishedWork=t.current.alternate,t.finishedLanes=e,Ly(t,$l,Up),tc(t,_i()),null}function _4(t,e){var r=vn;vn|=1;try{return t(e)}finally{vn=r,vn===0&&(vx=_i()+500,XI&&cg())}}function Hy(t){Kh!==null&&Kh.tag===0&&!(vn&6)&&dx();var e=vn;vn|=1;var r=$u.transition,n=Zn;try{if($u.transition=null,Zn=1,t)return t()}finally{Zn=n,$u.transition=r,vn=e,!(vn&6)&&cg()}}function P4(){kc=ix.current,Io(ix)}function Ny(t,e){t.finishedWork=null,t.finishedLanes=0;var r=t.timeoutHandle;if(r!==-1&&(t.timeoutHandle=-1,aRe(r)),Zi!==null)for(r=Zi.return;r!==null;){var n=r;switch(a4(n),n.tag){case 1:n=n.type.childContextTypes,n!=null&&EI();break;case 3:gx(),Io(Jl),Io(js),h4();break;case 5:f4(n);break;case 4:gx();break;case 13:Io(oi);break;case 19:Io(oi);break;case 10:u4(n.type._context);break;case 22:case 23:P4()}r=r.return}if(Qa=t,Zi=t=og(t.current,null),ds=kc=e,aa=0,UC=null,T4=$I=jy=0,$l=TC=null,Oy!==null){for(e=0;e<Oy.length;e++)if(r=Oy[e],n=r.interleaved,n!==null){r.interleaved=null;var o=n.next,i=r.pending;if(i!==null){var a=i.next;i.next=o,n.next=a}r.pending=n}Oy=null}return t}function Oae(t,e){do{var r=Zi;try{if(c4(),mI.current=OI,BI){for(var n=ii.memoizedState;n!==null;){var o=n.queue;o!==null&&(o.pending=null),n=n.next}BI=!1}if(Gy=0,Ya=ia=ii=null,SC=!1,NC=0,C4.current=null,r===null||r.return===null){aa=1,UC=e,Zi=null;break}e:{var i=t,a=r.return,s=r,l=e;if(e=ds,s.flags|=32768,l!==null&&typeof l=="object"&&typeof l.then=="function"){var c=l,u=s,d=u.tag;if(!(u.mode&1)&&(d===0||d===11||d===15)){var m=u.alternate;m?(u.updateQueue=m.updateQueue,u.memoizedState=m.memoizedState,u.lanes=m.lanes):(u.updateQueue=null,u.memoizedState=null)}var p=Moe(a);if(p!==null){p.flags&=-257,Roe(p,a,s,i,e),p.mode&1&&koe(i,c,e),e=p,l=c;var h=e.updateQueue;if(h===null){var f=new Set;f.add(l),e.updateQueue=f}else h.add(l);break e}else{if(!(e&1)){koe(i,c,e),E4();break e}l=Error(it(426))}}else if(qo&&s.mode&1){var b=Moe(a);if(b!==null){!(b.flags&65536)&&(b.flags|=256),Roe(b,a,s,i,e),s4(yx(l,s));break e}}i=l=yx(l,s),aa!==4&&(aa=2),TC===null?TC=[i]:TC.push(i),i=a;do{switch(i.tag){case 3:i.flags|=65536,e&=-e,i.lanes|=e;var v=bae(i,l,e);_oe(i,v);break e;case 1:s=l;var x=i.type,S=i.stateNode;if(!(i.flags&128)&&(typeof x.getDerivedStateFromError=="function"||S!==null&&typeof S.componentDidCatch=="function"&&(rg===null||!rg.has(S)))){i.flags|=65536,e&=-e,i.lanes|=e;var T=xae(i,s,e);_oe(i,T);break e}}i=i.return}while(i!==null)}Vae(r)}catch(E){e=E,Zi===r&&r!==null&&(Zi=r=r.return);continue}break}while(!0)}function Fae(){var t=FI.current;return FI.current=OI,t===null?OI:t}function E4(){(aa===0||aa===3||aa===2)&&(aa=4),Qa===null||!(jy&268435455)&&!($I&268435455)||Yh(Qa,ds)}function zI(t,e){var r=vn;vn|=2;var n=Fae();(Qa!==t||ds!==e)&&(Up=null,Ny(t,e));do try{kRe();break}catch(o){Oae(t,o)}while(!0);if(c4(),vn=r,FI.current=n,Zi!==null)throw Error(it(261));return Qa=null,ds=0,aa}function kRe(){for(;Zi!==null;)Nae(Zi)}function MRe(){for(;Zi!==null&&!i3e();)Nae(Zi)}function Nae(t){var e=Uae(t.alternate,t,kc);t.memoizedProps=t.pendingProps,e===null?Vae(t):Zi=e,C4.current=null}function Vae(t){var e=t;do{var r=e.alternate;if(t=e.return,e.flags&32768){if(r=_Re(r,e),r!==null){r.flags&=32767,Zi=r;return}if(t!==null)t.flags|=32768,t.subtreeFlags=0,t.deletions=null;else{aa=6,Zi=null;return}}else if(r=wRe(r,e,kc),r!==null){Zi=r;return}if(e=e.sibling,e!==null){Zi=e;return}Zi=e=t}while(e!==null);aa===0&&(aa=5)}function Ly(t,e,r){var n=Zn,o=$u.transition;try{$u.transition=null,Zn=1,RRe(t,e,r,n)}finally{$u.transition=o,Zn=n}return null}function RRe(t,e,r,n){do dx();while(Kh!==null);if(vn&6)throw Error(it(327));r=t.finishedWork;var o=t.finishedLanes;if(r===null)return null;if(t.finishedWork=null,t.finishedLanes=0,r===t.current)throw Error(it(177));t.callbackNode=null,t.callbackPriority=0;var i=r.lanes|r.childLanes;if(h3e(t,i),t===Qa&&(Zi=Qa=null,ds=0),!(r.subtreeFlags&2064)&&!(r.flags&2064)||sI||(sI=!0,Gae(SI,function(){return dx(),null})),i=(r.flags&15990)!==0,r.subtreeFlags&15990||i){i=$u.transition,$u.transition=null;var a=Zn;Zn=1;var s=vn;vn|=4,C4.current=null,ERe(t,r),Rae(r,t),tRe(bN),TI=!!vN,bN=vN=null,t.current=r,IRe(r,t,o),a3e(),vn=s,Zn=a,$u.transition=i}else t.current=r;if(sI&&(sI=!1,Kh=t,VI=o),i=t.pendingLanes,i===0&&(rg=null),c3e(r.stateNode,n),tc(t,_i()),e!==null)for(n=t.onRecoverableError,r=0;r<e.length;r++)o=e[r],n(o.value,{componentStack:o.stack,digest:o.digest});if(NI)throw NI=!1,t=VN,VN=null,t;return VI&1&&t.tag!==0&&dx(),i=t.pendingLanes,i&1?t===zN?wC++:(wC=0,zN=t):wC=0,cg(),null}function dx(){if(Kh!==null){var t=bie(VI),e=$u.transition,r=Zn;try{if($u.transition=null,Zn=16>t?16:t,Kh===null)var n=!1;else{if(t=Kh,Kh=null,VI=0,vn&6)throw Error(it(331));var o=vn;for(vn|=4,Rt=t.current;Rt!==null;){var i=Rt,a=i.child;if(Rt.flags&16){var s=i.deletions;if(s!==null){for(var l=0;l<s.length;l++){var c=s[l];for(Rt=c;Rt!==null;){var u=Rt;switch(u.tag){case 0:case 11:case 15:CC(8,u,i)}var d=u.child;if(d!==null)d.return=u,Rt=d;else for(;Rt!==null;){u=Rt;var m=u.sibling,p=u.return;if(Aae(u),u===c){Rt=null;break}if(m!==null){m.return=p,Rt=m;break}Rt=p}}}var h=i.alternate;if(h!==null){var f=h.child;if(f!==null){h.child=null;do{var b=f.sibling;f.sibling=null,f=b}while(f!==null)}}Rt=i}}if(i.subtreeFlags&2064&&a!==null)a.return=i,Rt=a;else e:for(;Rt!==null;){if(i=Rt,i.flags&2048)switch(i.tag){case 0:case 11:case 15:CC(9,i,i.return)}var v=i.sibling;if(v!==null){v.return=i.return,Rt=v;break e}Rt=i.return}}var x=t.current;for(Rt=x;Rt!==null;){a=Rt;var S=a.child;if(a.subtreeFlags&2064&&S!==null)S.return=a,Rt=S;else e:for(a=x;Rt!==null;){if(s=Rt,s.flags&2048)try{switch(s.tag){case 0:case 11:case 15:KI(9,s)}}catch(E){hi(s,s.return,E)}if(s===a){Rt=null;break e}var T=s.sibling;if(T!==null){T.return=s.return,Rt=T;break e}Rt=s.return}}if(vn=o,cg(),Xm&&typeof Xm.onPostCommitFiberRoot=="function")try{Xm.onPostCommitFiberRoot(GI,t)}catch{}n=!0}return n}finally{Zn=r,$u.transition=e}}return!1}function Woe(t,e,r){e=yx(r,e),e=bae(t,e,1),t=tg(t,e,1),e=vl(),t!==null&&(GC(t,1,e),tc(t,e))}function hi(t,e,r){if(t.tag===3)Woe(t,t,r);else for(;e!==null;){if(e.tag===3){Woe(e,t,r);break}else if(e.tag===1){var n=e.stateNode;if(typeof e.type.getDerivedStateFromError=="function"||typeof n.componentDidCatch=="function"&&(rg===null||!rg.has(n))){t=yx(r,t),t=xae(e,t,1),e=tg(e,t,1),t=vl(),e!==null&&(GC(e,1,t),tc(e,t));break}}e=e.return}}function LRe(t,e,r){var n=t.pingCache;n!==null&&n.delete(e),e=vl(),t.pingedLanes|=t.suspendedLanes&r,Qa===t&&(ds&r)===r&&(aa===4||aa===3&&(ds&130023424)===ds&&500>_i()-w4?Ny(t,0):T4|=r),tc(t,e)}function zae(t,e){e===0&&(t.mode&1?(e=XE,XE<<=1,!(XE&130023424)&&(XE=4194304)):e=1);var r=vl();t=Yp(t,e),t!==null&&(GC(t,e,r),tc(t,r))}function BRe(t){var e=t.memoizedState,r=0;e!==null&&(r=e.retryLane),zae(t,r)}function ORe(t,e){var r=0;switch(t.tag){case 13:var n=t.stateNode,o=t.memoizedState;o!==null&&(r=o.retryLane);break;case 19:n=t.stateNode;break;default:throw Error(it(314))}n!==null&&n.delete(e),zae(t,r)}var Uae;Uae=function(t,e,r){if(t!==null)if(t.memoizedProps!==e.pendingProps||Jl.current)Zl=!0;else{if(!(t.lanes&r)&&!(e.flags&128))return Zl=!1,TRe(t,e,r);Zl=!!(t.flags&131072)}else Zl=!1,qo&&e.flags&1048576&&qie(e,AI,e.index);switch(e.lanes=0,e.tag){case 2:var n=e.type;fI(t,e),t=e.pendingProps;var o=px(e,js.current);ux(e,r),o=y4(null,e,n,t,o,r);var i=v4();return e.flags|=1,typeof o=="object"&&o!==null&&typeof o.render=="function"&&o.$$typeof===void 0?(e.tag=1,e.memoizedState=null,e.updateQueue=null,ec(n)?(i=!0,II(e)):i=!1,e.memoizedState=o.state!==null&&o.state!==void 0?o.state:null,m4(e),o.updater=QI,e.stateNode=o,o._reactInternals=e,IN(e,n,t,r),e=kN(null,e,n,!0,i,r)):(e.tag=0,qo&&i&&i4(e),yl(null,e,o,r),e=e.child),e;case 16:n=e.elementType;e:{switch(fI(t,e),t=e.pendingProps,o=n._init,n=o(n._payload),e.type=n,o=e.tag=NRe(n),t=Hd(n,t),o){case 0:e=AN(null,e,n,t,r);break e;case 1:e=Ooe(null,e,n,t,r);break e;case 11:e=Loe(null,e,n,t,r);break e;case 14:e=Boe(null,e,n,Hd(n.type,t),r);break e}throw Error(it(306,n,""))}return e;case 0:return n=e.type,o=e.pendingProps,o=e.elementType===n?o:Hd(n,o),AN(t,e,n,o,r);case 1:return n=e.type,o=e.pendingProps,o=e.elementType===n?o:Hd(n,o),Ooe(t,e,n,o,r);case 3:e:{if(wae(e),t===null)throw Error(it(387));n=e.pendingProps,i=e.memoizedState,o=i.element,$ie(t,e),RI(e,n,null,r);var a=e.memoizedState;if(n=a.element,i.isDehydrated)if(i={element:n,isDehydrated:!1,cache:a.cache,pendingSuspenseBoundaries:a.pendingSuspenseBoundaries,transitions:a.transitions},e.updateQueue.baseState=i,e.memoizedState=i,e.flags&256){o=yx(Error(it(423)),e),e=Foe(t,e,n,r,o);break e}else if(n!==o){o=yx(Error(it(424)),e),e=Foe(t,e,n,r,o);break e}else for(Mc=eg(e.stateNode.containerInfo.firstChild),Rc=e,qo=!0,Wd=null,r=Qie(e,null,n,r),e.child=r;r;)r.flags=r.flags&-3|4096,r=r.sibling;else{if(fx(),n===o){e=Qp(t,e,r);break e}yl(t,e,n,r)}e=e.child}return e;case 5:return Zie(e),t===null&&_N(e),n=e.type,o=e.pendingProps,i=t!==null?t.memoizedProps:null,a=o.children,xN(n,o)?a=null:i!==null&&xN(n,i)&&(e.flags|=32),Tae(t,e),yl(t,e,a,r),e.child;case 6:return t===null&&_N(e),null;case 13:return _ae(t,e,r);case 4:return p4(e,e.stateNode.containerInfo),n=e.pendingProps,t===null?e.child=hx(e,null,n,r):yl(t,e,n,r),e.child;case 11:return n=e.type,o=e.pendingProps,o=e.elementType===n?o:Hd(n,o),Loe(t,e,n,o,r);case 7:return yl(t,e,e.pendingProps,r),e.child;case 8:return yl(t,e,e.pendingProps.children,r),e.child;case 12:return yl(t,e,e.pendingProps.children,r),e.child;case 10:e:{if(n=e.type._context,o=e.pendingProps,i=e.memoizedProps,a=o.value,fo(kI,n._currentValue),n._currentValue=a,i!==null)if(Qd(i.value,a)){if(i.children===o.children&&!Jl.current){e=Qp(t,e,r);break e}}else for(i=e.child,i!==null&&(i.return=e);i!==null;){var s=i.dependencies;if(s!==null){a=i.child;for(var l=s.firstContext;l!==null;){if(l.context===n){if(i.tag===1){l=qp(-1,r&-r),l.tag=2;var c=i.updateQueue;if(c!==null){c=c.shared;var u=c.pending;u===null?l.next=l:(l.next=u.next,u.next=l),c.pending=l}}i.lanes|=r,l=i.alternate,l!==null&&(l.lanes|=r),PN(i.return,r,e),s.lanes|=r;break}l=l.next}}else if(i.tag===10)a=i.type===e.type?null:i.child;else if(i.tag===18){if(a=i.return,a===null)throw Error(it(341));a.lanes|=r,s=a.alternate,s!==null&&(s.lanes|=r),PN(a,r,e),a=i.sibling}else a=i.child;if(a!==null)a.return=i;else for(a=i;a!==null;){if(a===e){a=null;break}if(i=a.sibling,i!==null){i.return=a.return,a=i;break}a=a.return}i=a}yl(t,e,o.children,r),e=e.child}return e;case 9:return o=e.type,n=e.pendingProps.children,ux(e,r),o=Zu(o),n=n(o),e.flags|=1,yl(t,e,n,r),e.child;case 14:return n=e.type,o=Hd(n,e.pendingProps),o=Hd(n.type,o),Boe(t,e,n,o,r);case 15:return Sae(t,e,e.type,e.pendingProps,r);case 17:return n=e.type,o=e.pendingProps,o=e.elementType===n?o:Hd(n,o),fI(t,e),e.tag=1,ec(n)?(t=!0,II(e)):t=!1,ux(e,r),vae(e,n,o),IN(e,n,o,r),kN(null,e,n,!0,t,r);case 19:return Pae(t,e,r);case 22:return Cae(t,e,r)}throw Error(it(156,e.tag))};function Gae(t,e){return hie(t,e)}function FRe(t,e,r,n){this.tag=t,this.key=r,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=e,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=n,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function Ku(t,e,r,n){return new FRe(t,e,r,n)}function I4(t){return t=t.prototype,!(!t||!t.isReactComponent)}function NRe(t){if(typeof t=="function")return I4(t)?1:0;if(t!=null){if(t=t.$$typeof,t===XN)return 11;if(t===YN)return 14}return 2}function og(t,e){var r=t.alternate;return r===null?(r=Ku(t.tag,e,t.key,t.mode),r.elementType=t.elementType,r.type=t.type,r.stateNode=t.stateNode,r.alternate=t,t.alternate=r):(r.pendingProps=e,r.type=t.type,r.flags=0,r.subtreeFlags=0,r.deletions=null),r.flags=t.flags&14680064,r.childLanes=t.childLanes,r.lanes=t.lanes,r.child=t.child,r.memoizedProps=t.memoizedProps,r.memoizedState=t.memoizedState,r.updateQueue=t.updateQueue,e=t.dependencies,r.dependencies=e===null?null:{lanes:e.lanes,firstContext:e.firstContext},r.sibling=t.sibling,r.index=t.index,r.ref=t.ref,r}function yI(t,e,r,n,o,i){var a=2;if(n=t,typeof t=="function")I4(t)&&(a=1);else if(typeof t=="string")a=5;else e:switch(t){case Qb:return Vy(r.children,o,i,e);case WN:a=8,o|=8;break;case ZF:return t=Ku(12,r,e,o|2),t.elementType=ZF,t.lanes=i,t;case JF:return t=Ku(13,r,e,o),t.elementType=JF,t.lanes=i,t;case eN:return t=Ku(19,r,e,o),t.elementType=eN,t.lanes=i,t;case Zoe:return ZI(r,o,i,e);default:if(typeof t=="object"&&t!==null)switch(t.$$typeof){case Koe:a=10;break e;case $oe:a=9;break e;case XN:a=11;break e;case YN:a=14;break e;case qh:a=16,n=null;break e}throw Error(it(130,t==null?t:typeof t,""))}return e=Ku(a,r,e,o),e.elementType=t,e.type=n,e.lanes=i,e}function Vy(t,e,r,n){return t=Ku(7,t,n,e),t.lanes=r,t}function ZI(t,e,r,n){return t=Ku(22,t,n,e),t.elementType=Zoe,t.lanes=r,t.stateNode={isHidden:!1},t}function QF(t,e,r){return t=Ku(6,t,null,e),t.lanes=r,t}function KF(t,e,r){return e=Ku(4,t.children!==null?t.children:[],t.key,e),e.lanes=r,e.stateNode={containerInfo:t.containerInfo,pendingChildren:null,implementation:t.implementation},e}function VRe(t,e,r,n,o){this.tag=e,this.containerInfo=t,this.finishedWork=this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.pendingContext=this.context=null,this.callbackPriority=0,this.eventTimes=RF(0),this.expirationTimes=RF(-1),this.entangledLanes=this.finishedLanes=this.mutableReadLanes=this.expiredLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=RF(0),this.identifierPrefix=n,this.onRecoverableError=o,this.mutableSourceEagerHydrationData=null}function D4(t,e,r,n,o,i,a,s,l){return t=new VRe(t,e,r,s,l),e===1?(e=1,i===!0&&(e|=8)):e=0,i=Ku(3,null,null,e),t.current=i,i.stateNode=t,i.memoizedState={element:n,isDehydrated:r,cache:null,transitions:null,pendingSuspenseBoundaries:null},m4(i),t}function zRe(t,e,r){var n=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null;return{$$typeof:Yb,key:n==null?null:""+n,children:t,containerInfo:e,implementation:r}}function jae(t){if(!t)return ag;t=t._reactInternals;e:{if(Wy(t)!==t||t.tag!==1)throw Error(it(170));var e=t;do{switch(e.tag){case 3:e=e.stateNode.context;break e;case 1:if(ec(e.type)){e=e.stateNode.__reactInternalMemoizedMergedChildContext;break e}}e=e.return}while(e!==null);throw Error(it(171))}if(t.tag===1){var r=t.type;if(ec(r))return jie(t,r,e)}return e}function Hae(t,e,r,n,o,i,a,s,l){return t=D4(r,n,!0,t,o,i,a,s,l),t.context=jae(null),r=t.current,n=vl(),o=ng(r),i=qp(n,o),i.callback=e??null,tg(r,i,o),t.current.lanes=o,GC(t,o,n),tc(t,n),t}function JI(t,e,r,n){var o=e.current,i=vl(),a=ng(o);return r=jae(r),e.context===null?e.context=r:e.pendingContext=r,e=qp(i,a),e.payload={element:t},n=n===void 0?null:n,n!==null&&(e.callback=n),t=tg(o,e,a),t!==null&&(Yd(t,o,a,i),dI(t,o,a)),a}function UI(t){if(t=t.current,!t.child)return null;switch(t.child.tag){case 5:return t.child.stateNode;default:return t.child.stateNode}}function Xoe(t,e){if(t=t.memoizedState,t!==null&&t.dehydrated!==null){var r=t.retryLane;t.retryLane=r!==0&&r<e?r:e}}function A4(t,e){Xoe(t,e),(t=t.alternate)&&Xoe(t,e)}function URe(){return null}var qae=typeof reportError=="function"?reportError:function(t){console.error(t)};function k4(t){this._internalRoot=t}eD.prototype.render=k4.prototype.render=function(t){var e=this._internalRoot;if(e===null)throw Error(it(409));JI(t,e,null,null)};eD.prototype.unmount=k4.prototype.unmount=function(){var t=this._internalRoot;if(t!==null){this._internalRoot=null;var e=t.containerInfo;Hy(function(){JI(null,t,null,null)}),e[Xp]=null}};function eD(t){this._internalRoot=t}eD.prototype.unstable_scheduleHydration=function(t){if(t){var e=Cie();t={blockedOn:null,target:t,priority:e};for(var r=0;r<Xh.length&&e!==0&&e<Xh[r].priority;r++);Xh.splice(r,0,t),r===0&&wie(t)}};function M4(t){return!(!t||t.nodeType!==1&&t.nodeType!==9&&t.nodeType!==11)}function tD(t){return!(!t||t.nodeType!==1&&t.nodeType!==9&&t.nodeType!==11&&(t.nodeType!==8||t.nodeValue!==" react-mount-point-unstable "))}function Yoe(){}function GRe(t,e,r,n,o){if(o){if(typeof n=="function"){var i=n;n=function(){var c=UI(a);i.call(c)}}var a=Hae(e,n,t,0,null,!1,!1,"",Yoe);return t._reactRootContainer=a,t[Xp]=a.current,RC(t.nodeType===8?t.parentNode:t),Hy(),a}for(;o=t.lastChild;)t.removeChild(o);if(typeof n=="function"){var s=n;n=function(){var c=UI(l);s.call(c)}}var l=D4(t,0,!1,null,null,!1,!1,"",Yoe);return t._reactRootContainer=l,t[Xp]=l.current,RC(t.nodeType===8?t.parentNode:t),Hy(function(){JI(e,l,r,n)}),l}function rD(t,e,r,n,o){var i=r._reactRootContainer;if(i){var a=i;if(typeof o=="function"){var s=o;o=function(){var l=UI(a);s.call(l)}}JI(e,a,t,o)}else a=GRe(r,e,t,o,n);return UI(a)}xie=function(t){switch(t.tag){case 3:var e=t.stateNode;if(e.current.memoizedState.isDehydrated){var r=fC(e.pendingLanes);r!==0&&($N(e,r|1),tc(e,_i()),!(vn&6)&&(vx=_i()+500,cg()))}break;case 13:Hy(function(){var n=Yp(t,1);if(n!==null){var o=vl();Yd(n,t,1,o)}}),A4(t,1)}};ZN=function(t){if(t.tag===13){var e=Yp(t,134217728);if(e!==null){var r=vl();Yd(e,t,134217728,r)}A4(t,134217728)}};Sie=function(t){if(t.tag===13){var e=ng(t),r=Yp(t,e);if(r!==null){var n=vl();Yd(r,t,e,n)}A4(t,e)}};Cie=function(){return Zn};Tie=function(t,e){var r=Zn;try{return Zn=t,e()}finally{Zn=r}};uN=function(t,e,r){switch(e){case"input":if(nN(t,r),e=r.name,r.type==="radio"&&e!=null){for(r=t;r.parentNode;)r=r.parentNode;for(r=r.querySelectorAll("input[name="+JSON.stringify(""+e)+'][type="radio"]'),e=0;e<r.length;e++){var n=r[e];if(n!==t&&n.form===t.form){var o=WI(n);if(!o)throw Error(it(90));eie(n),nN(n,o)}}}break;case"textarea":rie(t,r);break;case"select":e=r.value,e!=null&&ax(t,!!r.multiple,e,!1)}};cie=_4;uie=Hy;var jRe={usingClientEntryPoint:!1,Events:[HC,Jb,WI,sie,lie,_4]},uC={findFiberByHostInstance:By,bundleType:0,version:"18.3.1",rendererPackageName:"react-dom"},HRe={bundleType:uC.bundleType,version:uC.version,rendererPackageName:uC.rendererPackageName,rendererConfig:uC.rendererConfig,overrideHookState:null,overrideHookStateDeletePath:null,overrideHookStateRenamePath:null,overrideProps:null,overridePropsDeletePath:null,overridePropsRenamePath:null,setErrorHandler:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:Kp.ReactCurrentDispatcher,findHostInstanceByFiber:function(t){return t=pie(t),t===null?null:t.stateNode},findFiberByHostInstance:uC.findFiberByHostInstance||URe,findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null,reconcilerVersion:"18.3.1-next-f1338f8080-20240426"};if(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__<"u"&&(dC=__REACT_DEVTOOLS_GLOBAL_HOOK__,!dC.isDisabled&&dC.supportsFiber))try{GI=dC.inject(HRe),Xm=dC}catch{}var dC;Oc.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=jRe;Oc.createPortal=function(t,e){var r=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;if(!M4(e))throw Error(it(200));return zRe(t,e,null,r)};Oc.createRoot=function(t,e){if(!M4(t))throw Error(it(299));var r=!1,n="",o=qae;return e!=null&&(e.unstable_strictMode===!0&&(r=!0),e.identifierPrefix!==void 0&&(n=e.identifierPrefix),e.onRecoverableError!==void 0&&(o=e.onRecoverableError)),e=D4(t,1,!1,null,null,r,!1,n,o),t[Xp]=e.current,RC(t.nodeType===8?t.parentNode:t),new k4(e)};Oc.findDOMNode=function(t){if(t==null)return null;if(t.nodeType===1)return t;var e=t._reactInternals;if(e===void 0)throw typeof t.render=="function"?Error(it(188)):(t=Object.keys(t).join(","),Error(it(268,t)));return t=pie(e),t=t===null?null:t.stateNode,t};Oc.flushSync=function(t){return Hy(t)};Oc.hydrate=function(t,e,r){if(!tD(e))throw Error(it(200));return rD(null,t,e,!0,r)};Oc.hydrateRoot=function(t,e,r){if(!M4(t))throw Error(it(405));var n=r!=null&&r.hydratedSources||null,o=!1,i="",a=qae;if(r!=null&&(r.unstable_strictMode===!0&&(o=!0),r.identifierPrefix!==void 0&&(i=r.identifierPrefix),r.onRecoverableError!==void 0&&(a=r.onRecoverableError)),e=Hae(e,null,t,1,r??null,o,!1,i,a),t[Xp]=e.current,RC(t),n)for(t=0;t<n.length;t++)r=n[t],o=r._getVersion,o=o(r._source),e.mutableSourceEagerHydrationData==null?e.mutableSourceEagerHydrationData=[r,o]:e.mutableSourceEagerHydrationData.push(r,o);return new eD(e)};Oc.render=function(t,e,r){if(!tD(e))throw Error(it(200));return rD(null,t,e,!1,r)};Oc.unmountComponentAtNode=function(t){if(!tD(t))throw Error(it(40));return t._reactRootContainer?(Hy(function(){rD(null,null,t,!1,function(){t._reactRootContainer=null,t[Xp]=null})}),!0):!1};Oc.unstable_batchedUpdates=_4;Oc.unstable_renderSubtreeIntoContainer=function(t,e,r,n){if(!tD(r))throw Error(it(200));if(t==null||t._reactInternals===void 0)throw Error(it(38));return rD(t,e,r,!1,n)};Oc.version="18.3.1-next-f1338f8080-20240426"});var Qae=Hc((OZt,Yae)=>{"use strict";function Xae(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(Xae)}catch(t){console.error(t)}}Xae(),Yae.exports=Wae()});var $ae=Hc(R4=>{"use strict";var Kae=Qae();R4.createRoot=Kae.createRoot,R4.hydrateRoot=Kae.hydrateRoot;var FZt});var mse=Hc((jJt,dse)=>{"use strict";var sse=/\/\*[^*]*\*+([^/*][^*]*\*+)*\//g,rLe=/\n/g,nLe=/^\s*/,oLe=/^(\*?[-#/*\\\w]+(\[[0-9a-z_-]+\])?)\s*/,iLe=/^:\s*/,aLe=/^((?:'(?:\\'|.)*?'|"(?:\\"|.)*?"|\([^)]*?\)|[^};])+)/,sLe=/^[;\s]*/,lLe=/^\s+|\s+$/g,cLe=`
`,lse="/",cse="*",Qy="",uLe="comment",dLe="declaration";dse.exports=function(t,e){if(typeof t!="string")throw new TypeError("First argument must be a string");if(!t)return[];e=e||{};var r=1,n=1;function o(f){var b=f.match(rLe);b&&(r+=b.length);var v=f.lastIndexOf(cLe);n=~v?f.length-v:n+f.length}function i(){var f={line:r,column:n};return function(b){return b.position=new a(f),u(),b}}function a(f){this.start=f,this.end={line:r,column:n},this.source=e.source}a.prototype.content=t;var s=[];function l(f){var b=new Error(e.source+":"+r+":"+n+": "+f);if(b.reason=f,b.filename=e.source,b.line=r,b.column=n,b.source=t,e.silent)s.push(b);else throw b}function c(f){var b=f.exec(t);if(b){var v=b[0];return o(v),t=t.slice(v.length),b}}function u(){c(nLe)}function d(f){var b;for(f=f||[];b=m();)b!==!1&&f.push(b);return f}function m(){var f=i();if(!(lse!=t.charAt(0)||cse!=t.charAt(1))){for(var b=2;Qy!=t.charAt(b)&&(cse!=t.charAt(b)||lse!=t.charAt(b+1));)++b;if(b+=2,Qy===t.charAt(b-1))return l("End of comment missing");var v=t.slice(2,b-2);return n+=2,o(v),t=t.slice(b),n+=2,f({type:uLe,comment:v})}}function p(){var f=i(),b=c(oLe);if(b){if(m(),!c(iLe))return l("property missing ':'");var v=c(aLe),x=f({type:dLe,property:use(b[0].replace(sse,Qy)),value:v?use(v[0].replace(sse,Qy)):Qy});return c(sLe),x}}function h(){var f=[];d(f);for(var b;b=p();)b!==!1&&(f.push(b),d(f));return f}return u(),h()};function use(t){return t?t.replace(lLe,Qy):Qy}});var pse=Hc(YC=>{"use strict";var mLe=YC&&YC.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(YC,"__esModule",{value:!0});var pLe=mLe(mse());function fLe(t,e){var r=null;if(!t||typeof t!="string")return r;var n=(0,pLe.default)(t),o=typeof e=="function";return n.forEach(function(i){if(i.type==="declaration"){var a=i.property,s=i.value;o?e(a,s,i):s&&(r=r||{},r[a]=s)}}),r}YC.default=fLe});var Ole=Hc((Iir,Ble)=>{"use strict";var MD=Object.prototype.hasOwnProperty,Lle=Object.prototype.toString,Ile=Object.defineProperty,Dle=Object.getOwnPropertyDescriptor,Ale=function(e){return typeof Array.isArray=="function"?Array.isArray(e):Lle.call(e)==="[object Array]"},kle=function(e){if(!e||Lle.call(e)!=="[object Object]")return!1;var r=MD.call(e,"constructor"),n=e.constructor&&e.constructor.prototype&&MD.call(e.constructor.prototype,"isPrototypeOf");if(e.constructor&&!r&&!n)return!1;var o;for(o in e);return typeof o>"u"||MD.call(e,o)},Mle=function(e,r){Ile&&r.name==="__proto__"?Ile(e,r.name,{enumerable:!0,configurable:!0,value:r.newValue,writable:!0}):e[r.name]=r.newValue},Rle=function(e,r){if(r==="__proto__")if(MD.call(e,r)){if(Dle)return Dle(e,r).value}else return;return e[r]};Ble.exports=function t(){var e,r,n,o,i,a,s=arguments[0],l=1,c=arguments.length,u=!1;for(typeof s=="boolean"&&(u=s,s=arguments[1]||{},l=2),(s==null||typeof s!="object"&&typeof s!="function")&&(s={});l<c;++l)if(e=arguments[l],e!=null)for(r in e)n=Rle(s,r),o=Rle(e,r),s!==o&&(u&&o&&(kle(o)||(i=Ale(o)))?(i?(i=!1,a=n&&Ale(n)?n:[]):a=n&&kle(n)?n:{},Mle(s,{name:r,newValue:t(u,a,o)})):typeof o<"u"&&Mle(s,{name:r,newValue:o}));return s}});function Pce(t,e){for(let r=0,n=e*3;r<n;r+=3){let o=t[r],i=t[r+1],a=t[r+2],s=1/Math.sqrt(o*o+i*i+a*a);t[r]=o*s,t[r+1]=i*s,t[r+2]=a*s}return t}var _l=y();function $c(t,e,r,n){for(let o=0,i=n*3;o<i;o+=3)y.fromArray(_l,e,r+o),y.transformMat4(_l,_l,t),y.toArray(_l,e,r+o)}function MU(t,e,r,n){for(let o=0,i=n*3;o<i;o+=3)y.fromArray(_l,e,r+o),y.transformMat3(_l,_l,t),y.toArray(_l,e,r+o)}function RU(t,e){for(let r=0,n=t.length;r<n;r+=3)y.fromArray(_l,t,r),y.normalize(_l,_l),y.scale(_l,_l,e),y.toArray(_l,t,r)}var DU=y(),kA=y(),AU=y(),Kc=y(),kU=y();function OT(t,e,r,n,o){for(let i=0,a=o*3;i<a;i+=3){let s=e[i]*3,l=e[i+1]*3,c=e[i+2]*3;y.fromArray(DU,t,s),y.fromArray(kA,t,l),y.fromArray(AU,t,c),y.sub(Kc,AU,kA),y.sub(kU,DU,kA),y.cross(Kc,Kc,kU),r[s]+=Kc[0],r[s+1]+=Kc[1],r[s+2]+=Kc[2],r[l]+=Kc[0],r[l+1]+=Kc[1],r[l+2]+=Kc[2],r[c]+=Kc[0],r[c+1]+=Kc[1],r[c+2]+=Kc[2]}return Pce(r,n)}function Zc(t,e,r=1){let n=Mi(t),o=new Int32Array(n+2),i=new Int32Array(e),a=new Int32Array(e);for(let c=0,u=e*r;c<u;c+=r)++a[t[c]];let s=0;for(let c=0;c<e;c++)o[c]=s,s+=a[c];o[e]=s;let l=new Int32Array(s);for(let c=0,u=e*r;c<u;c+=r){let d=t[c],m=o[d]+i[d];l[m]=c,++i[d]}return{indices:l,offsets:o}}var MA=y.fromArray,FT=y.transformMat4Offset;function Ece(t,e){t=Math.max(t,2);let r=Math.sqrt(t),n=Math.ceil(r);n=n+(e-n%e)%e;let o=n>0?Math.ceil(t/n):0;return{width:n,height:o,length:n*o*e}}function Zr(t,e,r,n){let{length:o,width:i,height:a}=Ece(t,e);return n=n&&n.length>=o?n:new r(o),{array:n,width:i,height:a}}var Jc=y(),Ice=new Zs("14"),Dce=new Zs("98");function LU(t){return t>1e5?Ice:Dce}function Pl(t,e,r){let n=r*3,o=LU(e);o.reset();for(let a=0,s=e*3;a<s;a+=n)MA(Jc,t,a),o.includePosition(Jc);o.finishedIncludeStep();for(let a=0,s=e*3;a<s;a+=n)MA(Jc,t,a),o.radiusPosition(Jc);let i=o.getSphere();if(e<=14){let a=[];for(let s=0,l=e*3;s<l;s+=n)a.push(MA(y(),t,s));te.setExtrema(i,a)}return i}var RA=W();function Hn(t,e,r,n){if(r===1){W.fromArray(RA,e,n);let l=te.clone(t);return W.isIdentity(RA)?l:te.transform(l,l,RA)}let o=LU(r);o.reset();let{center:i,radius:a,extrema:s}=t;if(s&&r<=14){for(let l=0,c=r;l<c;++l)for(let u of s)FT(Jc,u,e,0,0,l*16+n),o.includePosition(Jc);o.finishedIncludeStep();for(let l=0,c=r;l<c;++l)for(let u of s)FT(Jc,u,e,0,0,l*16+n),o.radiusPosition(Jc)}else{for(let l=0,c=r;l<c;++l)FT(Jc,i,e,0,0,l*16+n),o.includePositionRadius(Jc,a);o.finishedIncludeStep();for(let l=0,c=r;l<c;++l)FT(Jc,i,e,0,0,l*16+n),o.radiusPositionRadius(Jc,a)}return o.getSphere()}var ns=new Uint8Array(772);ns[1]=1;ns[2]=1;ns[3]=1;ns[256]=1;ns[512]=1;ns[768]=1;ns[257]=2;ns[513]=2;ns[769]=2;ns[258]=2;ns[514]=2;ns[770]=2;ns[259]=2;ns[515]=2;ns[771]=2;function LA(t,e){if(e===0)return 0;let r=new Uint32Array(t.buffer,0,t.buffer.byteLength>>2),n=e-4>>2,o=4*n,i=0;if(n<0)for(let a=0;a<e;++a)i+=t[a]&&1;else{for(let a=0;a<n;++a){let s=r[a];i+=ns[s&65535]+ns[s>>16]}for(let a=o;a<e;++a)i+=t[a]&&1}return i/e}function jr(t,e,r){let n=Zr(Math.max(1,t),1,Uint8Array,r&&r.tMarker.ref.value.array),o=LA(n.array,t),i=o===0?0:-1;return r?(C.updateIfChanged(r.uMarker,0),C.update(r.tMarker,n),C.update(r.uMarkerTexDim,ne.create(n.width,n.height)),C.updateIfChanged(r.markerAverage,o),C.updateIfChanged(r.markerStatus,i),C.updateIfChanged(r.dMarkerType,e),r):{uMarker:C.create(0),tMarker:C.create(n),uMarkerTexDim:C.create(ne.create(n.width,n.height)),markerAverage:C.create(o),markerStatus:C.create(i),dMarkerType:C.create(e)}}var oNe={array:new Uint8Array(1),width:1,height:1};var Lo={kind:"null-location"};function NT(t,e,r){return{kind:"data-location",tag:t,data:e,element:r}}function jt(t,e,r,n,o=!1,i=()=>!1,a){if(t%r!==0)throw new Error("incompatible groupCount and stride");let s={location:Lo,location2:Lo,index:0,groupIndex:0,instanceIndex:0,isSecondary:!1},l=s.groupIndex<t,c=!1,u=0,d=0,m=!1,p=!!a;return{get hasNext(){return l},get isNextNewInstance(){return c},groupCount:t,instanceCount:e,count:t*e,stride:r,nonInstanceable:o,hasLocation2:p,move(){return l&&(s.groupIndex=u,s.instanceIndex=d,s.index=d*t+u,s.location=n(u,m?-1:d),p&&(s.location2=a(u,m?-1:d)),s.isSecondary=i(u,m?-1:d),u+=r,u===t?(++d,c=!0,d<e&&(u=0)):c=!1,l=u<t),s},reset(){s.location=Lo,s.location2=Lo,s.index=0,s.groupIndex=0,s.instanceIndex=0,s.isSecondary=!1,l=s.groupIndex<t,c=!1,u=0,d=0,m=!1},skipInstance(){l&&s.instanceIndex===d&&(++d,u=0,l=d<e)},voidInstances(){m=!0}}}function Ss(t,e){return{kind:"position-location",position:t?y.clone(t):y(),normal:e?y.clone(e):y()}}function BU(t){return!!t&&t.kind==="position-location"}var FU=bo();function Ace(t,e){switch(e){case t.FRAMEBUFFER_COMPLETE:return"complete";case t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:return"incomplete attachment";case t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:return"incomplete missing attachment";case t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:return"incomplete dimensions";case t.FRAMEBUFFER_UNSUPPORTED:return"unsupported"}if(ct(t))switch(e){case t.FRAMEBUFFER_INCOMPLETE_MULTISAMPLE:return"incomplete multisample";case t.RENDERBUFFER_SAMPLES:return"renderbuffer samples"}return"unknown error"}function Eg(t){let e=t.checkFramebufferStatus(t.FRAMEBUFFER);if(e!==t.FRAMEBUFFER_COMPLETE){let r=Ace(t,e);throw new Error(`Framebuffer status: ${r}`)}}function OU(t){let e=t.createFramebuffer();if(e===null)throw new Error("Could not create WebGL framebuffer");return e}function NU(t){let e=OU(t),r=!1;return{id:FU(),bind:()=>t.bindFramebuffer(t.FRAMEBUFFER,e),reset:()=>{e=OU(t)},destroy:()=>{r||(t.deleteFramebuffer(e),r=!0)}}}function VU(){return{id:FU(),bind:()=>{},reset:()=>{},destroy:()=>{}}}function BA(t){let e=zU(t);if(e===null)throw new Error('Could not find support for "instanced_arrays"');let r=GU(t);if(r===null)throw new Error('Could not find support for "element_index_uint"');let n=UU(t);if(n===null)throw new Error('Could not find support for "standard_derivatives"');let o=HU(t);ht&&o===null&&console.log('Could not find support for "texture_float"');let i=qU(t);ht&&i===null&&console.log('Could not find support for "texture_float_linear"');let a=WU(t);ht&&a===null&&console.log('Could not find support for "texture_half_float"');let s=XU(t);ht&&s===null&&console.log('Could not find support for "texture_half_float_linear"');let l=t5(t);ht&&l===null&&console.log('Could not find support for "depth_texture"');let c=YU(t);ht&&c===null&&console.log('Could not find support for "blend_minmax"');let u=jU(t);ht&&u===null&&console.log('Could not find support for "vertex_array_object"');let d=QU(t);ht&&d===null&&console.log('Could not find support for "frag_depth"');let m=KU(t);ht&&m===null&&console.log('Could not find support for "color_buffer_float"');let p=$U(t);ht&&p===null&&console.log('Could not find support for "color_buffer_half_float"');let h=ZU(t);ht&&h===null&&console.log('Could not find support for "draw_buffers"');let f=JU(t);ht&&f===null&&console.log('Could not find support for "draw_buffers_indexed"');let b=e5(t);ht&&b===null&&console.log('Could not find support for "shader_texture_lod"');let v=r5(t);ht&&v===null&&console.log('Could not find support for "sRGB"');let x=n5(t);ht&&x===null&&console.log('Could not find support for "disjoint_timer_query"');let S=o5(t);ht&&S===null&&console.log('Could not find support for "multi_draw"');let T=i5(t);ht&&T===null&&console.log('Could not find support for "draw_instanced_base_vertex_base_instance"');let E=a5(t);ht&&E===null&&console.log('Could not find support for "multi_draw_instanced_base_vertex_base_instance"');let _=s5(t);ht&&_===null&&console.log('Could not find support for "parallel_shader_compile"');let D=l5(t);ht&&D===null&&console.log('Could not find support for "fbo_render_mipmap"');let P=c5(t);ht&&P===null&&console.log('Could not find support for "provoking_vertex"');let A=u5(t);ht&&A===null&&console.log('Could not find support for "clip_cull_distance"');let I=d5(t);ht&&I===null&&console.log('Could not find support for "conservative_depth"');let k=m5(t);ht&&k===null&&console.log('Could not find support for "stencil_texturing"');let M=p5(t);ht&&M===null&&console.log('Could not find support for "clip_control"');let R=f5(t);return{instancedArrays:e,standardDerivatives:n,elementIndexUint:r,textureFloat:o,textureFloatLinear:i,textureHalfFloat:a,textureHalfFloatLinear:s,depthTexture:l,blendMinMax:c,vertexArrayObject:u,fragDepth:d,colorBufferFloat:m,colorBufferHalfFloat:p,drawBuffers:h,drawBuffersIndexed:f,shaderTextureLod:b,sRGB:v,disjointTimerQuery:x,multiDraw:S,drawInstancedBaseVertexBaseInstance:T,multiDrawInstancedBaseVertexBaseInstance:E,parallelShaderCompile:_,fboRenderMipmap:D,provokingVertex:P,clipCullDistance:A,conservativeDepth:I,stencilTexturing:k,clipControl:M,noNonInstancedActiveAttribs:R}}function h5(t,e){let r={},n=t.getParameter(t.FRONT_FACE),o=t.getParameter(t.CULL_FACE_MODE),i=t.getParameter(t.DEPTH_WRITEMASK),a=t.getParameter(t.DEPTH_CLEAR_VALUE),s=t.getParameter(t.DEPTH_FUNC),l=t.getParameter(t.COLOR_WRITEMASK),c=t.getParameter(t.COLOR_CLEAR_VALUE),u=t.getParameter(t.BLEND_SRC_RGB),d=t.getParameter(t.BLEND_DST_RGB),m=t.getParameter(t.BLEND_SRC_ALPHA),p=t.getParameter(t.BLEND_DST_ALPHA),h=t.getParameter(t.BLEND_COLOR),f=t.getParameter(t.BLEND_EQUATION_RGB),b=t.getParameter(t.BLEND_EQUATION_ALPHA),v=t.getParameter(t.STENCIL_FUNC),x=t.getParameter(t.STENCIL_VALUE_MASK),S=t.getParameter(t.STENCIL_REF),T=t.getParameter(t.STENCIL_BACK_FUNC),E=t.getParameter(t.STENCIL_BACK_VALUE_MASK),_=t.getParameter(t.STENCIL_BACK_REF),D=t.getParameter(t.STENCIL_WRITEMASK),P=t.getParameter(t.STENCIL_BACK_WRITEMASK),A=t.getParameter(t.STENCIL_FAIL),I=t.getParameter(t.STENCIL_PASS_DEPTH_PASS),k=t.getParameter(t.STENCIL_PASS_DEPTH_FAIL),M=t.getParameter(t.STENCIL_BACK_FAIL),R=t.getParameter(t.STENCIL_BACK_PASS_DEPTH_PASS),B=t.getParameter(t.STENCIL_BACK_PASS_DEPTH_FAIL),F=t.getParameter(t.MAX_VERTEX_ATTRIBS),G=[],V=t.getParameter(t.VIEWPORT),H=t.getParameter(t.SCISSOR_BOX),Q=e.clipControl?t.getParameter(e.clipControl.CLIP_ORIGIN):-1,L=e.clipControl?t.getParameter(e.clipControl.CLIP_DEPTH_MODE):-1,Y=()=>{for(let j=0;j<F;++j)G[j]=0};return Y(),{currentProgramId:-1,currentMaterialId:-1,currentRenderItemId:-1,enable:j=>{r[j]!==!0&&(t.enable(j),r[j]=!0)},disable:j=>{r[j]!==!1&&(t.disable(j),r[j]=!1)},frontFace:j=>{j!==n&&(t.frontFace(j),n=j)},cullFace:j=>{j!==o&&(t.cullFace(j),o=j)},depthMask:j=>{j!==i&&(t.depthMask(j),i=j)},clearDepth:j=>{j!==a&&(t.clearDepth(j),a=j)},depthFunc:j=>{j!==s&&(t.depthFunc(j),s=j)},colorMask:(j,O,J,$)=>{(j!==l[0]||O!==l[1]||J!==l[2]||$!==l[3])&&(t.colorMask(j,O,J,$),l[0]=j,l[1]=O,l[2]=J,l[3]=$)},clearColor:(j,O,J,$)=>{(j!==c[0]||O!==c[1]||J!==c[2]||$!==c[3])&&(t.clearColor(j,O,J,$),c[0]=j,c[1]=O,c[2]=J,c[3]=$)},blendFunc:(j,O)=>{(j!==u||O!==d||j!==m||O!==p)&&(t.blendFunc(j,O),u=j,d=O,m=j,p=O)},blendFuncSeparate:(j,O,J,$)=>{(j!==u||O!==d||J!==m||$!==p)&&(t.blendFuncSeparate(j,O,J,$),u=j,d=O,m=J,p=$)},blendEquation:j=>{(j!==f||j!==b)&&(t.blendEquation(j),f=j,b=j)},blendEquationSeparate:(j,O)=>{(j!==f||O!==b)&&(t.blendEquationSeparate(j,O),f=j,b=O)},blendColor:(j,O,J,$)=>{(j!==h[0]||O!==h[1]||J!==h[2]||$!==h[3])&&(t.blendColor(j,O,J,$),h[0]=j,h[1]=O,h[2]=J,h[3]=$)},stencilFunc:(j,O,J)=>{(j!==v||O!==S||J!==x||j!==T||O!==_||J!==E)&&(t.stencilFunc(j,O,J),v=j,S=O,x=J,T=j,_=O,E=J)},stencilFuncSeparate:(j,O,J,$)=>{j===t.FRONT?(O!==v||J!==S||$!==x)&&(t.stencilFuncSeparate(j,O,J,$),v=O,S=J,x=$):j===t.BACK?(O!==T||J!==_||$!==E)&&(t.stencilFuncSeparate(j,O,J,$),T=O,_=J,E=$):j===t.FRONT_AND_BACK&&(O!==v||J!==S||$!==x||O!==T||J!==_||$!==E)&&(t.stencilFuncSeparate(j,O,J,$),v=O,S=J,x=$,T=O,_=J,E=$)},stencilMask:j=>{(j!==D||j!==P)&&(t.stencilMask(j),D=j,P=j)},stencilMaskSeparate:(j,O)=>{j===t.FRONT?O!==D&&(t.stencilMaskSeparate(j,O),D=O):j===t.BACK?O!==P&&(t.stencilMaskSeparate(j,O),P=O):j===t.FRONT_AND_BACK&&(O!==D||O!==P)&&(t.stencilMaskSeparate(j,O),D=O,P=O)},stencilOp:(j,O,J)=>{(j!==A||O!==k||J!==I||j!==M||O!==B||J!==R)&&(t.stencilOp(j,O,J),A=j,k=O,I=J,M=j,B=O,R=J)},stencilOpSeparate:(j,O,J,$)=>{j===t.FRONT?(O!==A||J!==k||$!==I)&&(t.stencilOpSeparate(j,O,J,$),A=O,k=J,I=$):j===t.BACK?(O!==M||J!==B||$!==R)&&(t.stencilOpSeparate(j,O,J,$),M=O,B=J,R=$):j===t.FRONT_AND_BACK&&(O!==A||J!==k||$!==I||O!==M||J!==B||$!==R)&&(t.stencilOpSeparate(j,O,J,$),A=O,k=J,I=$,M=O,B=J,R=$)},enableVertexAttrib:j=>{t.enableVertexAttribArray(j),G[j]=1},clearVertexAttribsState:Y,disableUnusedVertexAttribs:()=>{for(let j=0;j<F;++j)G[j]===0&&t.disableVertexAttribArray(j)},viewport:(j,O,J,$)=>{(j!==V[0]||O!==V[1]||J!==V[2]||$!==V[3])&&(t.viewport(j,O,J,$),V[0]=j,V[1]=O,V[2]=J,V[3]=$)},scissor:(j,O,J,$)=>{(j!==H[0]||O!==H[1]||J!==H[2]||$!==H[3])&&(t.scissor(j,O,J,$),H[0]=j,H[1]=O,H[2]=J,H[3]=$)},clipControl:e.clipControl?(j,O)=>{(j!==Q||O!==L)&&(e.clipControl.clipControl(j,O),Q=j,L=O)}:void 0,reset:()=>{r={},n=t.getParameter(t.FRONT_FACE),o=t.getParameter(t.CULL_FACE_MODE),i=t.getParameter(t.DEPTH_WRITEMASK),a=t.getParameter(t.DEPTH_CLEAR_VALUE),s=t.getParameter(t.DEPTH_FUNC),l=t.getParameter(t.COLOR_WRITEMASK),c=t.getParameter(t.COLOR_CLEAR_VALUE),u=t.getParameter(t.BLEND_SRC_RGB),d=t.getParameter(t.BLEND_DST_RGB),m=t.getParameter(t.BLEND_SRC_ALPHA),p=t.getParameter(t.BLEND_DST_ALPHA),h=t.getParameter(t.BLEND_COLOR),f=t.getParameter(t.BLEND_EQUATION_RGB),b=t.getParameter(t.BLEND_EQUATION_ALPHA),v=t.getParameter(t.STENCIL_FUNC),x=t.getParameter(t.STENCIL_VALUE_MASK),S=t.getParameter(t.STENCIL_REF),T=t.getParameter(t.STENCIL_BACK_FUNC),E=t.getParameter(t.STENCIL_BACK_VALUE_MASK),_=t.getParameter(t.STENCIL_BACK_REF),D=t.getParameter(t.STENCIL_WRITEMASK),P=t.getParameter(t.STENCIL_BACK_WRITEMASK),A=t.getParameter(t.STENCIL_FAIL),I=t.getParameter(t.STENCIL_PASS_DEPTH_PASS),k=t.getParameter(t.STENCIL_PASS_DEPTH_FAIL),M=t.getParameter(t.STENCIL_BACK_FAIL),R=t.getParameter(t.STENCIL_BACK_PASS_DEPTH_PASS),B=t.getParameter(t.STENCIL_BACK_PASS_DEPTH_FAIL),F=t.getParameter(t.MAX_VERTEX_ATTRIBS),G.length=0;for(let j=0;j<F;++j)G[j]=0;V=t.getParameter(t.VIEWPORT),H=t.getParameter(t.SCISSOR_BOX),Q=e.clipControl?t.getParameter(e.clipControl.CLIP_ORIGIN):-1,L=e.clipControl?t.getParameter(e.clipControl.CLIP_DEPTH_MODE):-1}}}var ip;(function(t){function e(o,i,a){return{array:o,width:i,height:a}}t.create=e;function r(o){let{array:i,width:a,height:s}=o,l=i.length/(a*s),c=a*l;for(let u=0,d=s/2;u<d;++u)for(let m=0,p=c;m<p;++m){let h=u*c+m,f=(s-u-1)*c+m,b=i[h];i[h]=i[f],i[f]=b}return o}t.flipY=r;function n(o){let{array:i}=o,a=i instanceof Uint8Array?255:1;for(let s=0,l=i.length;s<l;s+=4){let c=i[s+3]/a;i[s]/=c,i[s+1]/=c,i[s+2]/=c}return o}t.divideByAlpha=n})(ip||(ip={}));var g5=`
float preFogAlpha = gl_FragColor.a;
if (uFog) {
    float viewZ = depthToViewZ(uIsOrtho, fragmentDepth, uNear, uFar);
    float fogFactor = smoothstep(uFogNear, uFogFar, abs(viewZ));
    float fogAlpha = (1.0 - fogFactor) * gl_FragColor.a;
    if (!uTransparentBackground) {
        if (gl_FragColor.a < 1.0) {
            // transparent objects are blended with background color
            gl_FragColor.a = fogAlpha;
        } else {
            // mix opaque objects with background color
            gl_FragColor.rgb = mix(gl_FragColor.rgb, uFogColor, fogFactor);
        }
    } else {
        #if defined(dRenderVariant_colorDpoit)
            if (gl_FragColor.a < 1.0) {
                // transparent objects are blended with background color
                gl_FragColor.a = fogAlpha;
            } else {
                // opaque objects need to be pre-multiplied alpha
                gl_FragColor.rgb *= fogAlpha;
                gl_FragColor.a = fogAlpha;
            }
        #else
            // pre-multiplied alpha expected for transparent background
            gl_FragColor.rgb *= fogAlpha;
            gl_FragColor.a = fogAlpha;
        #endif
    }
}
`;var y5=`
if (interior) {
    if (uInteriorColorFlag) {
        gl_FragColor.rgb = uInteriorColor;
    } else {
        gl_FragColor.rgb *= 1.0 - uInteriorDarkening;
    }

    #ifdef dTransparentBackfaces_opaque
        gl_FragColor.a = 1.0;
    #endif
}
`;var v5=`
#if defined(dIgnoreLight)
    #ifdef bumpEnabled
        if (uBumpFrequency > 0.0 && uBumpAmplitude > 0.0 && bumpiness > 0.0) {
            material.rgb += fbm(vModelPosition * uBumpFrequency) * uBumpAmplitude * bumpiness;
            material.rgb -= 0.5 * uBumpAmplitude * bumpiness;
        }
    #endif

    #if defined(dRenderVariant_color)
        material.rgb += material.rgb * emissive;
    #endif

    gl_FragColor = material;
#else
    #ifdef bumpEnabled
        if (uBumpFrequency > 0.0 && uBumpAmplitude > 0.0 && bumpiness > 0.0) {
            normal = perturbNormal(-vViewPosition, normal, fbm(vModelPosition * uBumpFrequency), (uBumpAmplitude * bumpiness) / uBumpFrequency);
        }
    #endif

    vec4 color = material;

    ReflectedLight reflectedLight = ReflectedLight(vec3(0.0), vec3(0.0), vec3(0.0), vec3(0.0));

    PhysicalMaterial physicalMaterial;
    physicalMaterial.diffuseColor = color.rgb * (1.0 - metalness);
    #ifdef enabledFragDepth
        physicalMaterial.roughness = min(max(roughness, 0.0525), 1.0);
    #else
        vec3 dxy = max(abs(dFdx(normal)), abs(dFdy(normal)));
        float geometryRoughness = max(max(dxy.x, dxy.y), dxy.z);
        physicalMaterial.roughness = min(max(roughness, 0.0525) + geometryRoughness, 1.0);
    #endif
    physicalMaterial.specularColor = mix(vec3(0.04), color.rgb, metalness);
    physicalMaterial.specularF90 = 1.0;

    GeometricContext geometry;
    geometry.position = -vViewPosition;
    geometry.normal = normal;
    geometry.viewDir = normalize(vViewPosition);

    IncidentLight directLight;
    #pragma unroll_loop_start
    for (int i = 0; i < dLightCount; ++i) {
        directLight.direction = uLightDirection[i];
        directLight.color = uLightColor[i] * PI; // * PI for punctual light
        RE_Direct_Physical(directLight, geometry, physicalMaterial, reflectedLight);
    }
    #pragma unroll_loop_end

    vec3 irradiance = uAmbientColor * PI; // * PI for punctual light
    RE_IndirectDiffuse_Physical(irradiance, geometry, physicalMaterial, reflectedLight);

    // indirect specular only metals
    vec3 radiance = uAmbientColor * metalness;
    vec3 iblIrradiance = uAmbientColor * metalness;
    vec3 clearcoatRadiance = vec3(0.0);
    RE_IndirectSpecular_Physical(radiance, iblIrradiance, clearcoatRadiance, geometry, physicalMaterial, reflectedLight);

    vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular;
    outgoingLight = clamp(outgoingLight, 0.01, 0.99); // prevents black artifacts on specular highlight with transparent background

    #if defined(dRenderVariant_color)
        outgoingLight += color.rgb * emissive;
    #endif

    gl_FragColor = vec4(outgoingLight, color.a);
#endif

#if defined(dXrayShaded_on)
    gl_FragColor.a *= 1.0 - pow(abs(dot(normal, vec3(0.0, 0.0, 1.0))), uXrayEdgeFalloff);
#elif defined(dXrayShaded_inverted)
    gl_FragColor.a *= pow(abs(dot(normal, vec3(0.0, 0.0, 1.0))), uXrayEdgeFalloff);
#endif

gl_FragColor.rgb *= uExposure;
`;var b5=`

#if defined(dColorMarker)
    if (marker > 0.0) {
        if ((uMarkerPriority == 1 && marker != 2.0) || (uMarkerPriority != 1 && marker == 1.0)) {
            gl_FragColor.rgb = mix(gl_FragColor.rgb, uHighlightColor, uHighlightStrength);
            gl_FragColor.a = max(gl_FragColor.a, uHighlightStrength * 0.002); // for direct-volume rendering
        } else {
            gl_FragColor.rgb = mix(gl_FragColor.rgb, uSelectColor, uSelectStrength);
            gl_FragColor.a = max(gl_FragColor.a, uSelectStrength * 0.002); // for direct-volume rendering
        }
    } else if (uMarkerAverage > 0.0) {
        gl_FragColor.rgb = mix(gl_FragColor.rgb, uDimColor, uDimStrength);
        gl_FragColor.a = max(gl_FragColor.a, uDimStrength * 0.002); // for direct-volume rendering
    }
#endif
`;var x5=`
#if dClipObjectCount != 0 && defined(dClipping)
    #if defined(dClippingType_instance)
        vClipping = readFromTexture(tClipping, aInstance, uClippingTexDim).a;
    #elif defined(dMarkerType_groupInstance)
        vClipping = readFromTexture(tClipping, aInstance * float(uGroupCount) + group, uClippingTexDim).a;
    #endif
#endif
`;var S5=`
#if defined(dRenderVariant_color)
    #if defined(dColorType_attribute)
        vColor.rgb = aColor;
    #elif defined(dColorType_instance)
        vColor.rgb = readFromTexture(tColor, aInstance, uColorTexDim).rgb;
    #elif defined(dColorType_group)
        #if defined(dDualColor)
            vec4 color2;
            if (aColorMode == 2.0) {
                vColor.rgb = readFromTexture(tColor, group, uColorTexDim).rgb;
            } else {
                vColor.rgb = readFromTexture(tColor, group * 2.0, uColorTexDim).rgb;
                color2.rgb = readFromTexture(tColor, group * 2.0 + 1.0, uColorTexDim).rgb;
            }
        #else
            vColor.rgb = readFromTexture(tColor, group, uColorTexDim).rgb;
        #endif
    #elif defined(dColorType_groupInstance)
        #if defined(dDualColor)
            vec4 color2;
            if (aColorMode == 2.0) {
                vColor.rgb = readFromTexture(tColor, aInstance * float(uGroupCount) + group, uColorTexDim).rgb;
            } else {
                vColor.rgb = readFromTexture(tColor, (aInstance * float(uGroupCount) + group) * 2.0, uColorTexDim).rgb;
                color2.rgb = readFromTexture(tColor, (aInstance * float(uGroupCount) + group) * 2.0 + 1.0, uColorTexDim).rgb;
            }
        #else
            vColor.rgb = readFromTexture(tColor, aInstance * float(uGroupCount) + group, uColorTexDim).rgb;
        #endif
    #elif defined(dColorType_vertex)
        vColor.rgb = readFromTexture(tColor, VertexID, uColorTexDim).rgb;
    #elif defined(dColorType_vertexInstance)
        vColor.rgb = readFromTexture(tColor, int(aInstance) * uVertexCount + VertexID, uColorTexDim).rgb;
    #elif defined(dColorType_volume)
        vec3 cgridPos = (uColorGridTransform.w * (position - uColorGridTransform.xyz)) / uColorGridDim;
        vColor.rgb = texture3dFrom2dLinear(tColorGrid, cgridPos, uColorGridDim, uColorTexDim).rgb;
    #elif defined(dColorType_volumeInstance)
        vec3 cgridPos = (uColorGridTransform.w * (vModelPosition - uColorGridTransform.xyz)) / uColorGridDim;
        vColor.rgb = texture3dFrom2dLinear(tColorGrid, cgridPos, uColorGridDim, uColorTexDim).rgb;
    #endif

    #ifdef dUsePalette
        vPaletteV = ((vColor.r * 256.0 * 256.0 * 255.0 + vColor.g * 256.0 * 255.0 + vColor.b * 255.0) - 1.0) / 16777215.0;
    #endif

    #ifdef dOverpaint
        #if defined(dOverpaintType_instance)
            vOverpaint = readFromTexture(tOverpaint, aInstance, uOverpaintTexDim);
        #elif defined(dOverpaintType_groupInstance)
            vOverpaint = readFromTexture(tOverpaint, aInstance * float(uGroupCount) + group, uOverpaintTexDim);
        #elif defined(dOverpaintType_vertexInstance)
            vOverpaint = readFromTexture(tOverpaint, int(aInstance) * uVertexCount + VertexID, uOverpaintTexDim);
        #elif defined(dOverpaintType_volumeInstance)
            vec3 ogridPos = (uOverpaintGridTransform.w * (vModelPosition - uOverpaintGridTransform.xyz)) / uOverpaintGridDim;
            vOverpaint = texture3dFrom2dLinear(tOverpaintGrid, ogridPos, uOverpaintGridDim, uOverpaintTexDim);
        #endif

        // pre-mix to avoid darkening due to empty overpaint
        #ifdef dColorType_uniform
            vOverpaint.rgb = mix(uColor.rgb, vOverpaint.rgb, vOverpaint.a);
        #else
            vOverpaint.rgb = mix(vColor.rgb, vOverpaint.rgb, vOverpaint.a);
        #endif
        vOverpaint *= uOverpaintStrength;
    #endif

    #ifdef dEmissive
        #if defined(dEmissiveType_instance)
            vEmissive = readFromTexture(tEmissive, aInstance, uEmissiveTexDim).a;
        #elif defined(dEmissiveType_groupInstance)
            vEmissive = readFromTexture(tEmissive, aInstance * float(uGroupCount) + group, uEmissiveTexDim).a;
        #elif defined(dEmissiveType_vertexInstance)
            vEmissive = readFromTexture(tEmissive, int(aInstance) * uVertexCount + VertexID, uEmissiveTexDim).a;
        #elif defined(dEmissiveType_volumeInstance)
            vec3 egridPos = (uEmissiveGridTransform.w * (vModelPosition - uEmissiveGridTransform.xyz)) / uEmissiveGridDim;
            vEmissive = texture3dFrom2dLinear(tEmissiveGrid, egridPos, uEmissiveGridDim, uEmissiveTexDim).a;
        #endif
        vEmissive *= uEmissiveStrength;
    #endif

    #ifdef dSubstance
        #if defined(dSubstanceType_instance)
            vSubstance = readFromTexture(tSubstance, aInstance, uSubstanceTexDim);
        #elif defined(dSubstanceType_groupInstance)
            vSubstance = readFromTexture(tSubstance, aInstance * float(uGroupCount) + group, uSubstanceTexDim);
        #elif defined(dSubstanceType_vertexInstance)
            vSubstance = readFromTexture(tSubstance, int(aInstance) * uVertexCount + VertexID, uSubstanceTexDim);
        #elif defined(dSubstanceType_volumeInstance)
            vec3 sgridPos = (uSubstanceGridTransform.w * (vModelPosition - uSubstanceGridTransform.xyz)) / uSubstanceGridDim;
            vSubstance = texture3dFrom2dLinear(tSubstanceGrid, sgridPos, uSubstanceGridDim, uSubstanceTexDim);
        #endif

        // pre-mix to avoid artifacts due to empty substance
        vSubstance.rgb = mix(vec3(uMetalness, uRoughness, uBumpiness), vSubstance.rgb, vSubstance.a);
        vSubstance *= uSubstanceStrength;
    #endif
#elif defined(dRenderVariant_emissive)
    #ifdef dEmissive
        #if defined(dEmissiveType_instance)
            vEmissive = readFromTexture(tEmissive, aInstance, uEmissiveTexDim).a;
        #elif defined(dEmissiveType_groupInstance)
            vEmissive = readFromTexture(tEmissive, aInstance * float(uGroupCount) + group, uEmissiveTexDim).a;
        #elif defined(dEmissiveType_vertexInstance)
            vEmissive = readFromTexture(tEmissive, int(aInstance) * uVertexCount + VertexID, uEmissiveTexDim).a;
        #elif defined(dEmissiveType_volumeInstance)
            vec3 egridPos = (uEmissiveGridTransform.w * (vModelPosition - uEmissiveGridTransform.xyz)) / uEmissiveGridDim;
            vEmissive = texture3dFrom2dLinear(tEmissiveGrid, egridPos, uEmissiveGridDim, uEmissiveTexDim).a;
        #endif
        vEmissive *= uEmissiveStrength;
    #endif
#elif defined(dRenderVariant_pick)
    #ifdef requiredDrawBuffers
        vObject = vec4(packIntToRGB(float(uObjectId)), 1.0);
        vInstance = vec4(packIntToRGB(aInstance), 1.0);
        vGroup = vec4(packIntToRGB(group), 1.0);
    #else
        if (uPickType == 1) {
            vColor = vec4(packIntToRGB(float(uObjectId)), 1.0);
        } else if (uPickType == 2) {
            vColor = vec4(packIntToRGB(aInstance), 1.0);
        } else {
            vColor = vec4(packIntToRGB(group), 1.0);
        }
    #endif
#endif

#ifdef dTransparency
    #if defined(dTransparencyType_instance)
        vTransparency = readFromTexture(tTransparency, aInstance, uTransparencyTexDim).a;
    #elif defined(dTransparencyType_groupInstance)
        vTransparency = readFromTexture(tTransparency, aInstance * float(uGroupCount) + group, uTransparencyTexDim).a;
    #elif defined(dTransparencyType_vertexInstance)
        vTransparency = readFromTexture(tTransparency, int(aInstance) * uVertexCount + VertexID, uTransparencyTexDim).a;
    #elif defined(dTransparencyType_volumeInstance)
        vec3 tgridPos = (uTransparencyGridTransform.w * (vModelPosition - uTransparencyGridTransform.xyz)) / uTransparencyGridDim;
        vTransparency = texture3dFrom2dLinear(tTransparencyGrid, tgridPos, uTransparencyGridDim, uTransparencyTexDim).a;
    #endif
    vTransparency *= uTransparencyStrength;
#endif
`;var C5=`
#ifdef dGeometryType_textureMesh
    float group = unpackRGBToInt(readFromTexture(tGroup, VertexID, uGeoTexDim).rgb);
#else
    float group = aGroup;
#endif
`;var T5=`
#if defined(dNeedsMarker)
    #if defined(dMarkerType_instance)
        vMarker = readFromTexture(tMarker, aInstance, uMarkerTexDim).a;
    #elif defined(dMarkerType_groupInstance)
        vMarker = readFromTexture(tMarker, aInstance * float(uGroupCount) + group, uMarkerTexDim).a;
    #endif
#endif
`;var w5=`
#if defined(dNeedsMarker)
    float marker = uMarker;
    if (uMarker == -1.0) {
        marker = floor(vMarker * 255.0 + 0.5); // rounding required to work on some cards on win
    }
#endif

#if defined(dRenderVariant_color)
    #if defined(dUsePalette)
        vec4 material = vec4(texture2D(tPalette, vec2(vPaletteV, 0.5)).rgb, uAlpha);
    #elif defined(dColorType_uniform)
        vec4 material = vec4(uColor, uAlpha);
    #elif defined(dColorType_varying)
        vec4 material = vec4(vColor.rgb, uAlpha);
    #endif

    // mix material with overpaint
    #if defined(dOverpaint)
        material.rgb = mix(material.rgb, vOverpaint.rgb, vOverpaint.a);
    #endif

    float emissive = uEmissive;
    #ifdef dEmissive
        emissive += vEmissive;
    #endif

    float metalness = uMetalness;
    float roughness = uRoughness;
    float bumpiness = uBumpiness;
    #ifdef dSubstance
        float sf = clamp(vSubstance.a, 0.0, 0.99); // clamp to avoid artifacts
        metalness = mix(metalness, vSubstance.r, sf);
        roughness = mix(roughness, vSubstance.g, sf);
        bumpiness = mix(bumpiness, vSubstance.b, sf);
    #endif
#elif defined(dRenderVariant_depth)
    if (fragmentDepth > getDepth(gl_FragCoord.xy / uDrawingBufferSize)) {
        discard;
    }

    #ifndef dXrayShaded
        #if defined(dTransparency)
            float dta = 1.0 - vTransparency;
            if (vTransparency < 0.2) dta = 1.0; // hard cutoff looks better

            if (uRenderMask == MaskTransparent && uAlpha * dta == 1.0) {
                discard;
            } else if (uRenderMask == MaskOpaque && uAlpha * dta < 1.0) {
                discard;
            }
        #else
            if (uRenderMask == MaskTransparent && uAlpha == 1.0) {
                discard;
            } else if (uRenderMask == MaskOpaque && uAlpha < 1.0) {
                discard;
            }
        #endif
    #else
        if (uRenderMask == MaskOpaque) {
            discard;
        }
    #endif

    vec4 material = packDepthToRGBA(fragmentDepth);
#elif defined(dRenderVariant_marking)
    vec4 material;
    if(uMarkingType == 1) {
        if (marker > 0.0)
            discard;
        #ifdef enabledFragDepth
            material = packDepthToRGBA(gl_FragDepthEXT);
        #else
            material = packDepthToRGBA(gl_FragCoord.z);
        #endif
    } else {
        if (marker == 0.0)
            discard;
        float depthTest = 1.0;
        if (uMarkingDepthTest) {
            depthTest = (fragmentDepth >= getDepthPacked(gl_FragCoord.xy / uDrawingBufferSize)) ? 1.0 : 0.0;
        }
        bool isHighlight = intMod(marker, 2.0) > 0.1;
        float viewZ = depthToViewZ(uIsOrtho, fragmentDepth, uNear, uFar);
        float fogFactor = smoothstep(uFogNear, uFogFar, abs(viewZ));
        if (fogFactor == 1.0)
            discard;
        material = vec4(0.0, depthTest, isHighlight ? 1.0 : 0.0, 1.0 - fogFactor);
    }
#elif defined(dRenderVariant_emissive)
    float emissive = uEmissive;
    #ifdef dEmissive
        emissive += vEmissive;
    #endif
    vec4 material = vec4(emissive);
#endif

// apply per-group transparency
#if defined(dTransparency) && (defined(dRenderVariant_pick) || defined(dRenderVariant_color) || defined(dRenderVariant_emissive))
    float ta = 1.0 - vTransparency;
    if (vTransparency < 0.09) ta = 1.0; // hard cutoff looks better

    #if defined(dRenderVariant_pick)
        if (ta * uAlpha < uPickingAlphaThreshold)
            discard; // ignore so the element below can be picked
    #elif defined(dRenderVariant_emissive)
        if (ta < 1.0)
            discard; // emissive not supported with transparency
    #elif defined(dRenderVariant_color)
        material.a *= ta;
    #endif
#endif
`;var _5=`
mat4 model = uModel * aTransform;
mat4 modelView = uView * model;
#ifdef dGeometryType_textureMesh
    vec3 position = readFromTexture(tPosition, VertexID, uGeoTexDim).xyz;
#else
    vec3 position = aPosition;
#endif
vec4 position4 = vec4(position, 1.0);
// for accessing tColorGrid in vert shader and for clipping in frag shader
vModelPosition = (model * position4).xyz;
vec4 mvPosition = modelView * position4;
vViewPosition = mvPosition.xyz;
gl_Position = uProjection * mvPosition;
`;var P5=`
#if defined(dSizeType_uniform)
    float size = uSize;
#elif defined(dSizeType_attribute)
    float size = aSize;
#elif defined(dSizeType_instance)
    float size = unpackRGBToInt(readFromTexture(tSize, aInstance, uSizeTexDim).rgb);
#elif defined(dSizeType_group)
    float size = unpackRGBToInt(readFromTexture(tSize, group, uSizeTexDim).rgb);
#elif defined(dSizeType_groupInstance)
    float size = unpackRGBToInt(readFromTexture(tSize, aInstance * float(uGroupCount) + group, uSizeTexDim).rgb);
#endif

#if defined(dSizeType_instance) || defined(dSizeType_group) || defined(dSizeType_groupInstance)
    size /= 100.0; // NOTE factor also set in TypeScript
#endif

size *= uSizeFactor;
`;var E5=`
float viewZ = depthToViewZ(uIsOrtho, fragmentDepth, uNear, uFar);
float fogFactor = smoothstep(uFogNear, uFogFar, abs(viewZ));
float alpha = (1.0 - fogFactor) * uAlpha;
// if not opaque enough ignore so the element below can be picked
if (uAlpha < uPickingAlphaThreshold || alpha < 0.1) {
    #ifdef dTransparentBackfaces_opaque
        if (!interior) discard;
    #else
        discard;
    #endif
}
`;var I5=`
#if defined(dRenderVariant_color)
    #if defined(dTransparentBackfaces_off)
        if (interior && material.a < 1.0) discard;
    #elif defined(dTransparentBackfaces_opaque)
        if (interior) material.a = 1.0;
    #endif

    #if !defined(dXrayShaded_on) && !defined(dXrayShaded_inverted)
        if ((uRenderMask == MaskOpaque && material.a < 1.0) ||
            (uRenderMask == MaskTransparent && material.a == 1.0)
        ) {
            discard;
        }
    #endif
#endif
`;var D5=`
#if defined(dClipVariant_instance) && dClipObjectCount != 0
    vec4 mCenter = uModel * aTransform * vec4(uInvariantBoundingSphere.xyz, 1.0);
    if (clipTest(vec4(mCenter.xyz, uInvariantBoundingSphere.w)))
        // move out of [ -w, +w ] to 'discard' in vert shader
        gl_Position.z = 2.0 * gl_Position.w;
#endif
`;var A5=`
#if defined(dClipVariant_pixel) && dClipObjectCount != 0
    if (clipTest(vec4(vModelPosition, 0.0)))
        discard;
#endif
`;var k5=`
uniform float uMetalness;
uniform float uRoughness;
uniform float uBumpiness;
#ifdef bumpEnabled
    uniform float uBumpFrequency;
    uniform float uBumpAmplitude;
#endif
uniform float uEmissive;

#if defined(dRenderVariant_color)
    #if defined(dColorType_uniform)
        uniform vec3 uColor;
    #elif defined(dColorType_varying)
        varying vec4 vColor;
    #endif

    #ifdef dUsePalette
        uniform sampler2D tPalette;
        varying float vPaletteV;
    #endif

    #ifdef dOverpaint
        varying vec4 vOverpaint;
    #endif

    #ifdef dEmissive
        varying float vEmissive;
    #endif

    #ifdef dSubstance
        varying vec4 vSubstance;
    #endif
#elif defined(dRenderVariant_emissive)
    #ifdef dEmissive
        varying float vEmissive;
    #endif
#elif defined(dRenderVariant_pick)
    #if __VERSION__ == 100 || !defined(dVaryingGroup)
        #ifdef requiredDrawBuffers
            varying vec4 vObject;
            varying vec4 vInstance;
            varying vec4 vGroup;
        #else
            varying vec4 vColor;
        #endif
    #else
        #ifdef requiredDrawBuffers
            flat in vec4 vObject;
            flat in vec4 vInstance;
            flat in vec4 vGroup;
        #else
            flat in vec4 vColor;
        #endif
    #endif
#endif

#ifdef dTransparency
    varying float vTransparency;
#endif
`;var M5=`
uniform float uMetalness;
uniform float uRoughness;
uniform float uBumpiness;

#if defined(dRenderVariant_color)
    #if defined(dColorType_uniform)
        uniform vec3 uColor;
    #elif defined(dColorType_attribute)
        varying vec4 vColor;
        attribute vec3 aColor;
    #elif defined(dColorType_texture)
        varying vec4 vColor;
        uniform vec2 uColorTexDim;
        uniform sampler2D tColor;
    #elif defined(dColorType_grid)
        varying vec4 vColor;
        uniform vec2 uColorTexDim;
        uniform vec3 uColorGridDim;
        uniform vec4 uColorGridTransform;
        uniform sampler2D tColorGrid;
    #elif defined(dColorType_direct)
        varying vec4 vColor;
    #endif

    #ifdef dUsePalette
        varying float vPaletteV;
    #endif

    #ifdef dOverpaint
        #if defined(dOverpaintType_instance) || defined(dOverpaintType_groupInstance) || defined(dOverpaintType_vertexInstance)
            varying vec4 vOverpaint;
            uniform vec2 uOverpaintTexDim;
            uniform sampler2D tOverpaint;
        #elif defined(dOverpaintType_volumeInstance)
            varying vec4 vOverpaint;
            uniform vec2 uOverpaintTexDim;
            uniform vec3 uOverpaintGridDim;
            uniform vec4 uOverpaintGridTransform;
            uniform sampler2D tOverpaintGrid;
        #endif
        uniform float uOverpaintStrength;
    #endif

    #ifdef dEmissive
        #if defined(dEmissiveType_instance) || defined(dEmissiveType_groupInstance) || defined(dEmissiveType_vertexInstance)
            varying float vEmissive;
            uniform vec2 uEmissiveTexDim;
            uniform sampler2D tEmissive;
        #elif defined(dEmissiveType_volumeInstance)
            varying float vEmissive;
            uniform vec2 uEmissiveTexDim;
            uniform vec3 uEmissiveGridDim;
            uniform vec4 uEmissiveGridTransform;
            uniform sampler2D tEmissiveGrid;
        #endif
        uniform float uEmissiveStrength;
    #endif

    #ifdef dSubstance
        #if defined(dSubstanceType_instance) || defined(dSubstanceType_groupInstance) || defined(dSubstanceType_vertexInstance)
            varying vec4 vSubstance;
            uniform vec2 uSubstanceTexDim;
            uniform sampler2D tSubstance;
        #elif defined(dSubstanceType_volumeInstance)
            varying vec4 vSubstance;
            uniform vec2 uSubstanceTexDim;
            uniform vec3 uSubstanceGridDim;
            uniform vec4 uSubstanceGridTransform;
            uniform sampler2D tSubstanceGrid;
        #endif
        uniform float uSubstanceStrength;
    #endif
#elif defined(dRenderVariant_emissive)
    #ifdef dEmissive
        #if defined(dEmissiveType_instance) || defined(dEmissiveType_groupInstance) || defined(dEmissiveType_vertexInstance)
            varying float vEmissive;
            uniform vec2 uEmissiveTexDim;
            uniform sampler2D tEmissive;
        #elif defined(dEmissiveType_volumeInstance)
            varying float vEmissive;
            uniform vec2 uEmissiveTexDim;
            uniform vec3 uEmissiveGridDim;
            uniform vec4 uEmissiveGridTransform;
            uniform sampler2D tEmissiveGrid;
        #endif
        uniform float uEmissiveStrength;
    #endif
#elif defined(dRenderVariant_pick)
    #if __VERSION__ == 100 || !defined(dVaryingGroup)
        #ifdef requiredDrawBuffers
            varying vec4 vObject;
            varying vec4 vInstance;
            varying vec4 vGroup;
        #else
            varying vec4 vColor;
        #endif
    #else
        #ifdef requiredDrawBuffers
            flat out vec4 vObject;
            flat out vec4 vInstance;
            flat out vec4 vGroup;
        #else
            flat out vec4 vColor;
        #endif
    #endif
#endif

#ifdef dTransparency
    #if defined(dTransparencyType_instance) || defined(dTransparencyType_groupInstance) || defined(dTransparencyType_vertexInstance)
        varying float vTransparency;
        uniform vec2 uTransparencyTexDim;
        uniform sampler2D tTransparency;
    #elif defined(dTransparencyType_volumeInstance)
        varying float vTransparency;
        uniform vec2 uTransparencyTexDim;
        uniform vec3 uTransparencyGridDim;
        uniform vec4 uTransparencyGridTransform;
        uniform sampler2D tTransparencyGrid;
    #endif
    uniform float uTransparencyStrength;
#endif
`;var R5=`
#if dClipObjectCount != 0
    vec3 quaternionTransform(const in vec4 q, const in vec3 v) {
        vec3 t = 2.0 * cross(q.xyz, v);
        return v + q.w * t + cross(q.xyz, t);
    }

    vec4 computePlane(const in vec3 normal, const in vec3 inPoint) {
        return vec4(normalize(normal), -dot(normal, inPoint));
    }

    float planeSD(const in vec4 plane, const in vec3 center) {
        return -dot(plane.xyz, center - plane.xyz * -plane.w);
    }

    float sphereSD(const in vec3 position, const in vec4 rotation, const in vec3 size, const in vec3 center) {
        return (
            length(quaternionTransform(vec4(-rotation.x, -rotation.y, -rotation.z, rotation.w), center - position) / size) - 1.0
        ) * min(min(size.x, size.y), size.z);
    }

    float cubeSD(const in vec3 position, const in vec4 rotation, const in vec3 size, const in vec3 center) {
        vec3 d = abs(quaternionTransform(vec4(-rotation.x, -rotation.y, -rotation.z, rotation.w), center - position)) - size;
        return min(max(d.x, max(d.y, d.z)), 0.0) + length(max(d, 0.0));
    }

    float cylinderSD(const in vec3 position, const in vec4 rotation, const in vec3 size, const in vec3 center) {
        vec3 t = quaternionTransform(vec4(-rotation.x, -rotation.y, -rotation.z, rotation.w), center - position);

        vec2 d = abs(vec2(length(t.xz), t.y)) - size.xy;
        return min(max(d.x, d.y), 0.0) + length(max(d, 0.0));
    }

    float infiniteConeSD(const in vec3 position, const in vec4 rotation, const in vec3 size, const in vec3 center) {
        vec3 t = quaternionTransform(vec4(-rotation.x, -rotation.y, -rotation.z, rotation.w), center - position);

        float q = length(t.xy);
        return dot(size.xy, vec2(q, t.z));
    }

    float getSignedDistance(const in vec3 center, const in int type, const in vec3 position, const in vec4 rotation, const in vec3 scale) {
        if (type == 1) {
            vec3 normal = quaternionTransform(rotation, vec3(0.0, 1.0, 0.0));
            vec4 plane = computePlane(normal, position);
            return planeSD(plane, center);
        } else if (type == 2) {
            return sphereSD(position, rotation, scale * 0.5, center);
        } else if (type == 3) {
            return cubeSD(position, rotation, scale * 0.5, center);
        } else if (type == 4) {
            return cylinderSD(position, rotation, scale * 0.5, center);
        } else if (type == 5) {
            return infiniteConeSD(position, rotation, scale * 0.5, center);
        } else {
            return 0.1;
        }
    }

    #if __VERSION__ == 100
        // 8-bit
        int bitwiseAnd(in int a, in int b) {
            int d = 128;
            int result = 0;
            for (int i = 0; i < 8; ++i) {
                if (d <= 0) break;
                if (a >= d && b >= d) result += d;
                if (a >= d) a -= d;
                if (b >= d) b -= d;
                d /= 2;
            }
            return result;
        }

        bool hasBit(const in int mask, const in int bit) {
            return bitwiseAnd(mask, bit) == 0;
        }
    #else
        bool hasBit(const in int mask, const in int bit) {
            return (mask & bit) == 0;
        }
    #endif

    bool clipTest(const in vec4 sphere) {
        // flag is a bit-flag for clip-objects to ignore (note, object ids start at 1 not 0)
        #if defined(dClipping)
            int flag = int(floor(vClipping * 255.0 + 0.5));
        #else
            int flag = 0;
        #endif

        #pragma unroll_loop_start
        for (int i = 0; i < dClipObjectCount; ++i) {
            if (flag == 0 || hasBit(flag, UNROLLED_LOOP_INDEX + 1)) {
                // TODO take sphere radius into account?
                bool test = getSignedDistance(sphere.xyz, uClipObjectType[i], uClipObjectPosition[i], uClipObjectRotation[i], uClipObjectScale[i]) <= 0.0;
                if ((!uClipObjectInvert[i] && test) || (uClipObjectInvert[i] && !test)) {
                    return true;
                }
            }
        }
        #pragma unroll_loop_end
        return false;
    }
#endif
`;var L5=`
uniform int uObjectId;
uniform int uInstanceCount;
uniform int uGroupCount;

uniform int uPickType;
uniform int uMarkingType;

uniform vec4 uCameraPlane;
uniform vec4 uLod;

#if dClipObjectCount != 0
    uniform int uClipObjectType[dClipObjectCount];
    uniform bool uClipObjectInvert[dClipObjectCount];
    uniform vec3 uClipObjectPosition[dClipObjectCount];
    uniform vec4 uClipObjectRotation[dClipObjectCount];
    uniform vec3 uClipObjectScale[dClipObjectCount];

    #if defined(dClipping)
        #if __VERSION__ == 100 || defined(dClippingType_instance) || !defined(dVaryingGroup)
            varying float vClipping;
        #else
            flat in float vClipping;
        #endif
    #endif
#endif

#if defined(dColorMarker)
    uniform vec3 uHighlightColor;
    uniform vec3 uSelectColor;
    uniform vec3 uDimColor;
    uniform float uHighlightStrength;
    uniform float uSelectStrength;
    uniform float uDimStrength;
    uniform int uMarkerPriority;
    uniform float uMarkerAverage;
#endif

#if defined(dNeedsMarker)
    uniform float uMarker;
    #if __VERSION__ == 100 || defined(dMarkerType_instance) || !defined(dVaryingGroup)
        varying float vMarker;
    #else
        flat in float vMarker;
    #endif
#endif

#if defined(dRenderVariant_colorDpoit)
    #define MAX_DPOIT_DEPTH 99999.0 // NOTE constant also set in TypeScript
    uniform sampler2D tDpoitDepth;
    uniform sampler2D tDpoitFrontColor;
#endif

varying vec3 vModelPosition;
varying vec3 vViewPosition;

uniform vec2 uViewOffset;

uniform float uNear;
uniform float uFar;
uniform float uIsOrtho;

uniform bool uFog;
uniform float uFogNear;
uniform float uFogFar;
uniform vec3 uFogColor;

uniform float uAlpha;
uniform float uPickingAlphaThreshold;
uniform bool uTransparentBackground;

uniform bool uDoubleSided;
uniform float uInteriorDarkening;
uniform bool uInteriorColorFlag;
uniform vec3 uInteriorColor;
bool interior;

uniform float uXrayEdgeFalloff;
uniform float uExposure;

uniform mat4 uProjection;

uniform int uRenderMask;
uniform bool uMarkingDepthTest;

uniform sampler2D tDepth;
uniform vec2 uDrawingBufferSize;

float getDepthPacked(const in vec2 coords) {
    return unpackRGBAToDepth(texture2D(tDepth, coords));
}

float getDepth(const in vec2 coords) {
    #ifdef depthTextureSupport
        return texture2D(tDepth, coords).r;
    #else
        return unpackRGBAToDepth(texture2D(tDepth, coords));
    #endif
}

float calcDepth(const in vec3 pos) {
    vec2 clipZW = pos.z * uProjection[2].zw + uProjection[3].zw;
    return 0.5 + 0.5 * clipZW.x / clipZW.y;
}

// "Bump Mapping Unparametrized Surfaces on the GPU" Morten S. Mikkelsen
// https://mmikk.github.io/papers3d/mm_sfgrad_bump.pdf
vec3 perturbNormal(in vec3 position, in vec3 normal, in float height, in float scale) {
    vec3 sigmaS = dFdx(position);
    vec3 sigmaT = dFdy(position);

    vec3 r1 = cross(sigmaT, normal);
    vec3 r2 = cross(normal, sigmaS);
    float det = dot(sigmaS, r1);
    if (det == 0.0) return normal;

    float bs = dFdx(height);
    float bt = dFdy(height);

    vec3 surfGrad = sign(det) * (bs * r1 + bt * r2);
    return normalize(abs(det) * normal - scale * surfGrad);
}

float hash(in float h) {
    return fract(sin(h) * 43758.5453123);
}

float noise(in vec3 x) {
    vec3 p = floor(x);
    vec3 f = fract(x);
    f = f * f * (3.0 - 2.0 * f);

    float n = p.x + p.y * 157.0 + 113.0 * p.z;
    return mix(
        mix(mix(hash(n + 0.0), hash(n + 1.0), f.x),
            mix(hash(n + 157.0), hash(n + 158.0), f.x), f.y),
        mix(mix(hash(n + 113.0), hash(n + 114.0), f.x),
            mix(hash(n + 270.0), hash(n + 271.0), f.x), f.y), f.z);
}

float fbm(in vec3 p) {
    float f = 0.0;
    f += 0.5 * noise(p);
    p *= 2.01;
    f += 0.25 * noise(p);
    p *= 2.02;
    f += 0.125 * noise(p);

    return f;
}
`;var B5=`
uniform mat4 uProjection, uModel, uView;
uniform vec3 uCameraPosition;
uniform vec4 uCameraPlane;

uniform int uObjectId;
uniform int uVertexCount;
uniform int uInstanceCount;
uniform int uGroupCount;
uniform vec4 uInvariantBoundingSphere;
uniform vec4 uLod;

uniform bool uDoubleSided;
uniform int uPickType;

#if dClipObjectCount != 0
    uniform int uClipObjectType[dClipObjectCount];
    uniform bool uClipObjectInvert[dClipObjectCount];
    uniform vec3 uClipObjectPosition[dClipObjectCount];
    uniform vec4 uClipObjectRotation[dClipObjectCount];
    uniform vec3 uClipObjectScale[dClipObjectCount];

    #if defined(dClipping)
        uniform vec2 uClippingTexDim;
        uniform sampler2D tClipping;
        #if __VERSION__ == 100 || defined(dClippingType_instance) || !defined(dVaryingGroup)
            varying float vClipping;
        #else
            flat out float vClipping;
        #endif
    #endif
#endif

#if defined(dNeedsMarker)
    uniform float uMarker;
    uniform vec2 uMarkerTexDim;
    uniform sampler2D tMarker;
    #if __VERSION__ == 100 || defined(dMarkerType_instance) || !defined(dVaryingGroup)
        varying float vMarker;
    #else
        flat out float vMarker;
    #endif
#endif

varying vec3 vModelPosition;
varying vec3 vViewPosition;

#if defined(noNonInstancedActiveAttribs)
    // int() is needed for some Safari versions
    // see https://bugs.webkit.org/show_bug.cgi?id=244152
    #define VertexID int(gl_VertexID)
#else
    attribute float aVertex;
    #define VertexID int(aVertex)
#endif

#if defined(enabledMultiDraw)
    #define DrawID gl_DrawID
#else
    #define DrawID uDrawId
#endif
`;var O5=`
// TODO find a better place for these convenience defines

#if defined(dRenderVariant_colorBlended) || defined(dRenderVariant_colorWboit) || defined(dRenderVariant_colorDpoit)
    #define dRenderVariant_color
#endif

#if defined(dColorType_instance) || defined(dColorType_group) || defined(dColorType_groupInstance) || defined(dColorType_vertex) || defined(dColorType_vertexInstance)
    #define dColorType_texture
#endif

#if defined(dColorType_volume) || defined(dColorType_volumeInstance)
    #define dColorType_grid
#endif

#if defined(dColorType_attribute) || defined(dColorType_texture) || defined(dColorType_grid)
    #define dColorType_varying
#endif

#if (defined(dRenderVariant_color) && defined(dColorMarker)) || defined(dRenderVariant_marking)
    #define dNeedsMarker
#endif

#if defined(dXrayShaded_on) || defined(dXrayShaded_inverted)
    #define dXrayShaded
#endif

#define MaskAll 0
#define MaskOpaque 1
#define MaskTransparent 2

//

#define PI 3.14159265
#define RECIPROCAL_PI 0.31830988618
#define EPSILON 1e-6

#define saturate(a) clamp(a, 0.0, 1.0)

#if __VERSION__ == 100
    #define round(x) floor((x) + 0.5)
#endif

float intDiv(const in float a, const in float b) { return float(int(a) / int(b)); }
vec2 ivec2Div(const in vec2 a, const in vec2 b) { return vec2(ivec2(a) / ivec2(b)); }
float intMod(const in float a, const in float b) { return a - b * float(int(a) / int(b)); }
int imod(const in int a, const in int b) { return a - b * (a / b); }

float pow2(const in float x) { return x * x; }

vec3 packIntToRGB(in float value) {
    value = clamp(round(value), 0.0, 16777216.0 - 1.0) + 1.0;
    vec3 c = vec3(0.0);
    c.b = mod(value, 256.0);
    value = floor(value / 256.0);
    c.g = mod(value, 256.0);
    value = floor(value / 256.0);
    c.r = mod(value, 256.0);
    return c / 255.0;
}
float unpackRGBToInt(const in vec3 rgb) {
    return (floor(rgb.r * 255.0 + 0.5) * 256.0 * 256.0 + floor(rgb.g * 255.0 + 0.5) * 256.0 + floor(rgb.b * 255.0 + 0.5)) - 1.0;
}

vec2 packUnitIntervalToRG(const in float v) {
    vec2 enc;
    enc.xy = vec2(fract(v * 256.0), v);
    enc.y -= enc.x * (1.0 / 256.0);
    enc.xy *=  256.0 / 255.0;

    return enc;
}

float unpackRGToUnitInterval(const in vec2 enc) {
    return dot(enc, vec2(255.0 / (256.0 * 256.0), 255.0 / 256.0));
}

vec3 screenSpaceToViewSpace(const in vec3 ssPos, const in mat4 invProjection) {
    vec4 p = vec4(ssPos * 2.0 - 1.0, 1.0);
    p = invProjection * p;
    return p.xyz / p.w;
}

const float PackUpscale = 256.0 / 255.0; // fraction -> 0..1 (including 1)
const float UnpackDownscale = 255.0 / 256.0; // 0..1 -> fraction (excluding 1)
const vec3 PackFactors = vec3(256.0 * 256.0 * 256.0, 256.0 * 256.0,  256.0);
const vec4 UnpackFactors = UnpackDownscale / vec4(PackFactors, 1.0);
const float ShiftRight8 = 1.0 / 256.0;

vec4 packDepthToRGBA(const in float v) {
    vec4 r = vec4(fract(v * PackFactors), v);
    r.yzw -= r.xyz * ShiftRight8; // tidy overflow
    return r * PackUpscale;
}
float unpackRGBAToDepth(const in vec4 v) {
    return dot(v, UnpackFactors);
}

vec4 sRGBToLinear(const in vec4 c) {
    return vec4(mix(pow(c.rgb * 0.9478672986 + vec3(0.0521327014), vec3(2.4)), c.rgb * 0.0773993808, vec3(lessThanEqual(c.rgb, vec3(0.04045)))), c.a);
}
vec4 linearTosRGB(const in vec4 c) {
    return vec4(mix(pow(c.rgb, vec3(0.41666)) * 1.055 - vec3(0.055), c.rgb * 12.92, vec3(lessThanEqual(c.rgb, vec3(0.0031308)))), c.a);
}

float linearizeDepth(const in float depth, const in float near, const in float far) {
    return (2.0 * near) / (far + near - depth * (far - near));
}

float perspectiveDepthToViewZ(const in float invClipZ, const in float near, const in float far) {
    return (near * far) / ((far - near) * invClipZ - far);
}

float orthographicDepthToViewZ(const in float linearClipZ, const in float near, const in float far) {
    return linearClipZ * (near - far) - near;
}

float depthToViewZ(const in float isOrtho, const in float linearClipZ, const in float near, const in float far) {
    return isOrtho == 1.0 ? orthographicDepthToViewZ(linearClipZ, near, far) : perspectiveDepthToViewZ(linearClipZ, near, far);
}

#if __VERSION__ == 100
    // transpose

    float transpose(const in float m) {
        return m;
    }

    mat2 transpose2(const in mat2 m) {
        return mat2(
            m[0][0], m[1][0],
            m[0][1], m[1][1]
        );
    }

    mat3 transpose3(const in mat3 m) {
        return mat3(
            m[0][0], m[1][0], m[2][0],
            m[0][1], m[1][1], m[2][1],
            m[0][2], m[1][2], m[2][2]
        );
    }

    mat4 transpose4(const in mat4 m) {
        return mat4(
            m[0][0], m[1][0], m[2][0], m[3][0],
            m[0][1], m[1][1], m[2][1], m[3][1],
            m[0][2], m[1][2], m[2][2], m[3][2],
            m[0][3], m[1][3], m[2][3], m[3][3]
        );
    }

    // inverse

    float inverse(const in float m) {
        return 1.0 / m;
    }

    mat2 inverse2(const in mat2 m) {
        return mat2(m[1][1],-m[0][1],
                -m[1][0], m[0][0]) / (m[0][0]*m[1][1] - m[0][1]*m[1][0]);
    }

    mat3 inverse3(const in mat3 m) {
        float a00 = m[0][0], a01 = m[0][1], a02 = m[0][2];
        float a10 = m[1][0], a11 = m[1][1], a12 = m[1][2];
        float a20 = m[2][0], a21 = m[2][1], a22 = m[2][2];

        float b01 = a22 * a11 - a12 * a21;
        float b11 = -a22 * a10 + a12 * a20;
        float b21 = a21 * a10 - a11 * a20;

        float det = a00 * b01 + a01 * b11 + a02 * b21;

        return mat3(b01, (-a22 * a01 + a02 * a21), (a12 * a01 - a02 * a11),
                    b11, (a22 * a00 - a02 * a20), (-a12 * a00 + a02 * a10),
                    b21, (-a21 * a00 + a01 * a20), (a11 * a00 - a01 * a10)) / det;
    }

    mat4 inverse4(const in mat4 m) {
        float
            a00 = m[0][0], a01 = m[0][1], a02 = m[0][2], a03 = m[0][3],
            a10 = m[1][0], a11 = m[1][1], a12 = m[1][2], a13 = m[1][3],
            a20 = m[2][0], a21 = m[2][1], a22 = m[2][2], a23 = m[2][3],
            a30 = m[3][0], a31 = m[3][1], a32 = m[3][2], a33 = m[3][3],

            b00 = a00 * a11 - a01 * a10,
            b01 = a00 * a12 - a02 * a10,
            b02 = a00 * a13 - a03 * a10,
            b03 = a01 * a12 - a02 * a11,
            b04 = a01 * a13 - a03 * a11,
            b05 = a02 * a13 - a03 * a12,
            b06 = a20 * a31 - a21 * a30,
            b07 = a20 * a32 - a22 * a30,
            b08 = a20 * a33 - a23 * a30,
            b09 = a21 * a32 - a22 * a31,
            b10 = a21 * a33 - a23 * a31,
            b11 = a22 * a33 - a23 * a32,

            det = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06;

        return mat4(
            a11 * b11 - a12 * b10 + a13 * b09,
            a02 * b10 - a01 * b11 - a03 * b09,
            a31 * b05 - a32 * b04 + a33 * b03,
            a22 * b04 - a21 * b05 - a23 * b03,
            a12 * b08 - a10 * b11 - a13 * b07,
            a00 * b11 - a02 * b08 + a03 * b07,
            a32 * b02 - a30 * b05 - a33 * b01,
            a20 * b05 - a22 * b02 + a23 * b01,
            a10 * b10 - a11 * b08 + a13 * b06,
            a01 * b08 - a00 * b10 - a03 * b06,
            a30 * b04 - a31 * b02 + a33 * b00,
            a21 * b02 - a20 * b04 - a23 * b00,
            a11 * b07 - a10 * b09 - a12 * b06,
            a00 * b09 - a01 * b07 + a02 * b06,
            a31 * b01 - a30 * b03 - a32 * b00,
            a20 * b03 - a21 * b01 + a22 * b00) / det;
    }

    #define isNaN(x) ((x) != (x))
    #define isInf(x) ((x) == (x) + 1.0)
#else
    #define transpose2(m) transpose(m)
    #define transpose3(m) transpose(m)
    #define transpose4(m) transpose(m)

    #define inverse2(m) inverse(m)
    #define inverse3(m) inverse(m)
    #define inverse4(m) inverse(m)

    #define isNaN isnan
    #define isInf isinf
#endif
`;var F5=`
if (uLod.w == 0.0 && (uLod.x != 0.0 || uLod.y != 0.0)) {
    float d = dot(uCameraPlane.xyz, vModelPosition) + uCameraPlane.w;
    float ta = min(
        smoothstep(uLod.x, uLod.x + uLod.z, d),
        1.0 - smoothstep(uLod.y - uLod.z, uLod.y, d)
    );

    #if defined(dRenderVariant_color)
        float at = 0.0;

        // shift by view-offset during multi-sample rendering to allow for blending
        vec2 coord = gl_FragCoord.xy + uViewOffset * 0.25;

        const mat4 thresholdMatrix = mat4(
            1.0 / 17.0,  9.0 / 17.0,  3.0 / 17.0, 11.0 / 17.0,
            13.0 / 17.0,  5.0 / 17.0, 15.0 / 17.0,  7.0 / 17.0,
            4.0 / 17.0, 12.0 / 17.0,  2.0 / 17.0, 10.0 / 17.0,
            16.0 / 17.0,  8.0 / 17.0, 14.0 / 17.0,  6.0 / 17.0
        );
        int ci = int(intMod(coord.x, 4.0));
        int ri = int(intMod(coord.y, 4.0));
        #if __VERSION__ == 100
            vec4 i = vec4(float(ci * 4 + ri));
            vec4 v = thresholdMatrix[0] * vec4(equal(i, vec4(0.0, 1.0, 2.0, 3.0))) +
                thresholdMatrix[1] * vec4(equal(i, vec4(4.0, 5.0, 6.0, 7.0))) +
                thresholdMatrix[2] * vec4(equal(i, vec4(8.0, 9.0, 10.0, 11.0))) +
                thresholdMatrix[3] * vec4(equal(i, vec4(12.0, 13.0, 14.0, 15.0)));
            at = v.x + v.y + v.z + v.w;
        #else
            at = thresholdMatrix[ci][ri];
        #endif

        if (ta < 0.99 && (ta < 0.01 || ta < at)) {
            discard;
        }
    #else
        if (ta < uPickingAlphaThreshold) {
            discard;
        }
    #endif
}
`;var N5=`
    // floatToRgba adapted from https://github.com/equinor/glsl-float-to-rgba
    // MIT License, Copyright (c) 2020 Equinor

    float shiftRight (float v, float amt) {
    v = floor(v) + 0.5;
    return floor(v / exp2(amt));
    }
    float shiftLeft (float v, float amt) {
        return floor(v * exp2(amt) + 0.5);
    }
    float maskLast (float v, float bits) {
        return mod(v, shiftLeft(1.0, bits));
    }
    float extractBits (float num, float from, float to) {
        from = floor(from + 0.5); to = floor(to + 0.5);
        return maskLast(shiftRight(num, from), to - from);
    }

    vec4 floatToRgba(float texelFloat, bool littleEndian) {
        if (texelFloat == 0.0) return vec4(0.0, 0.0, 0.0, 0.0);
        float sign = texelFloat > 0.0 ? 0.0 : 1.0;
        texelFloat = abs(texelFloat);
        float exponent = floor(log2(texelFloat));
        float biased_exponent = exponent + 127.0;
        float fraction = ((texelFloat / exp2(exponent)) - 1.0) * 8388608.0;
        float t = biased_exponent / 2.0;
        float last_bit_of_biased_exponent = fract(t) * 2.0;
        float remaining_bits_of_biased_exponent = floor(t);
        float byte4 = extractBits(fraction, 0.0, 8.0) / 255.0;
        float byte3 = extractBits(fraction, 8.0, 16.0) / 255.0;
        float byte2 = (last_bit_of_biased_exponent * 128.0 + extractBits(fraction, 16.0, 23.0)) / 255.0;
        float byte1 = (sign * 128.0 + remaining_bits_of_biased_exponent) / 255.0;
        return (
            littleEndian
                ? vec4(byte4, byte3, byte2, byte1)
                : vec4(byte1, byte2, byte3, byte4)
        );
    }
`;var V5=`
#if dLightCount != 0
    uniform vec3 uLightDirection[dLightCount];
    uniform vec3 uLightColor[dLightCount];
#endif
uniform vec3 uAmbientColor;

struct PhysicalMaterial {
    vec3 diffuseColor;
    float roughness;
    vec3 specularColor;
    float specularF90;
};

struct IncidentLight {
    vec3 color;
    vec3 direction;
};

struct ReflectedLight {
    vec3 directDiffuse;
    vec3 directSpecular;
    vec3 indirectDiffuse;
    vec3 indirectSpecular;
};

struct GeometricContext {
    vec3 position;
    vec3 normal;
    vec3 viewDir;
};

vec3 BRDF_Lambert(const in vec3 diffuseColor) {
    return RECIPROCAL_PI * diffuseColor;
}

vec3 F_Schlick(const in vec3 f0, const in float f90, const in float dotVH) {
    // Original approximation by Christophe Schlick '94
    // float fresnel = pow( 1.0 - dotVH, 5.0 );
    // Optimized variant (presented by Epic at SIGGRAPH '13)
    // https://cdn2.unrealengine.com/Resources/files/2013SiggraphPresentationsNotes-26915738.pdf
    float fresnel = exp2((-5.55473 * dotVH - 6.98316) * dotVH);
    return f0 * (1.0 - fresnel) + (f90 * fresnel);
}

// Moving Frostbite to Physically Based Rendering 3.0 - page 12, listing 2
// https://seblagarde.files.wordpress.com/2015/07/course_notes_moving_frostbite_to_pbr_v32.pdf
float V_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {
    float a2 = pow2(alpha);
    float gv = dotNL * sqrt(a2 + (1.0 - a2) * pow2(dotNV));
    float gl = dotNV * sqrt(a2 + (1.0 - a2) * pow2(dotNL));
    return 0.5 / max(gv + gl, EPSILON);
}

// Microfacet Models for Refraction through Rough Surfaces - equation (33)
// http://graphicrants.blogspot.com/2013/08/specular-brdf-reference.html
// alpha is "roughness squared" in Disney\u2019s reparameterization
float D_GGX(const in float alpha, const in float dotNH) {
    float a2 = pow2(alpha);
    float denom = pow2(dotNH) * (a2 - 1.0) + 1.0; // avoid alpha = 0 with dotNH = 1
    return RECIPROCAL_PI * a2 / pow2(denom);
}

// GGX Distribution, Schlick Fresnel, GGX_SmithCorrelated Visibility
vec3 BRDF_GGX(const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in vec3 f0, const in float f90, const in float roughness) {
    float alpha = pow2(roughness); // UE4's roughness
    vec3 halfDir = normalize( lightDir + viewDir);
    float dotNL = saturate(dot(normal, lightDir));
    float dotNV = saturate(dot(normal, viewDir));
    float dotNH = saturate(dot(normal, halfDir));
    float dotVH = saturate(dot(viewDir, halfDir));
    vec3 F = F_Schlick(f0, f90, dotVH);
    float V = V_GGX_SmithCorrelated(alpha, dotNL, dotNV);
    float D = D_GGX(alpha, dotNH);
    return F * (V * D);
}

// Analytical approximation of the DFG LUT, one half of the
// split-sum approximation used in indirect specular lighting.
// via 'environmentBRDF' from "Physically Based Shading on Mobile"
// https://www.unrealengine.com/blog/physically-based-shading-on-mobile
vec2 DFGApprox(const in vec3 normal, const in vec3 viewDir, const in float roughness) {
    float dotNV = saturate(dot(normal, viewDir));
    const vec4 c0 = vec4(-1, -0.0275, -0.572, 0.022);
    const vec4 c1 = vec4(1, 0.0425, 1.04, -0.04);
    vec4 r = roughness * c0 + c1;
    float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;
    vec2 fab = vec2(-1.04, 1.04) * a004 + r.zw;
    return fab;
}

// Fdez-Ag\xFCera's "Multiple-Scattering Microfacet Model for Real-Time Image Based Lighting"
// Approximates multiscattering in order to preserve energy.
// http://www.jcgt.org/published/0008/01/03/
void computeMultiscattering(const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter) {
    vec2 fab = DFGApprox(normal, viewDir, roughness);
    vec3 FssEss = specularColor * fab.x + specularF90 * fab.y;
    float Ess = fab.x + fab.y;
    float Ems = 1.0 - Ess;
    vec3 Favg = specularColor + (1.0 - specularColor) * 0.047619; // 1/21
    vec3 Fms = FssEss * Favg / (1.0 - Ems * Favg);
    singleScatter += FssEss;
    multiScatter += Fms * Ems;
}

void RE_Direct_Physical(const in IncidentLight directLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {
    float dotNL = saturate(dot(geometry.normal, directLight.direction));
    vec3 irradiance = dotNL * directLight.color;
    reflectedLight.directSpecular += irradiance * BRDF_GGX(directLight.direction, geometry.viewDir, geometry.normal, material.specularColor, material.specularF90, material.roughness);
    reflectedLight.directDiffuse += irradiance * BRDF_Lambert(material.diffuseColor);
}

void RE_IndirectDiffuse_Physical(const in vec3 irradiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {
    reflectedLight.indirectDiffuse += irradiance * BRDF_Lambert(material.diffuseColor);
}

void RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 irradiance, const in vec3 clearcoatRadiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {
    // Both indirect specular and indirect diffuse light accumulate here
    vec3 singleScattering = vec3(0.0);
    vec3 multiScattering = vec3(0.0);
    vec3 cosineWeightedIrradiance = irradiance * RECIPROCAL_PI;
    computeMultiscattering(geometry.normal, geometry.viewDir, material.specularColor, material.specularF90, material.roughness, singleScattering, multiScattering);
    vec3 diffuse = material.diffuseColor * (1.0 - ( singleScattering + multiScattering));
    reflectedLight.indirectSpecular += radiance * singleScattering;
    reflectedLight.indirectSpecular += multiScattering * cosineWeightedIrradiance;
    reflectedLight.indirectDiffuse += diffuse * cosineWeightedIrradiance;
}
`;var z5=`
float matrixScale(in mat4 m){
    vec4 r = m[0];
    return sqrt(r[0] * r[0] + r[1] * r[1] + r[2] * r[2]);
}
`;var U5=`
varying vec3 vNormal;
`;var G5=`
vec4 readFromTexture(const in sampler2D tex, const in float i, const in vec2 dim) {
    float x = intMod(i, dim.x);
    float y = floor(intDiv(i, dim.x));
    vec2 uv = (vec2(x, y) + 0.5) / dim;
    return texture2D(tex, uv);
}

vec4 readFromTexture(const in sampler2D tex, const in int i, const in vec2 dim) {
    int x = imod(i, int(dim.x));
    int y = i / int(dim.x);
    vec2 uv = (vec2(x, y) + 0.5) / dim;
    return texture2D(tex, uv);
}
`;var j5=`
    // rgbaToFloat adapted from https://github.com/ihmeuw/glsl-rgba-to-float
    // BSD 3-Clause License
    //
    // Copyright (c) 2019, Institute for Health Metrics and Evaluation All rights reserved.
    // Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:
    //  - Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.
    //  - Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.
    //  - Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.
    //
    // THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES,
    // INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
    // IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY,
    // OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA,
    // OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
    // OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
    // OF THE POSSIBILITY OF SUCH DAMAGE.

    ivec4 floatsToBytes(vec4 inputFloats, bool littleEndian) {
        ivec4 bytes = ivec4(inputFloats * 255.0);
        return (
            littleEndian
                ? bytes.abgr
                : bytes
        );
    }

    // Break the four bytes down into an array of 32 bits.
    void bytesToBits(const in ivec4 bytes, out bool bits[32]) {
        for (int channelIndex = 0; channelIndex < 4; ++channelIndex) {
            float acc = float(bytes[channelIndex]);
            for (int indexInByte = 7; indexInByte >= 0; --indexInByte) {
                float powerOfTwo = exp2(float(indexInByte));
                bool bit = acc >= powerOfTwo;
                bits[channelIndex * 8 + (7 - indexInByte)] = bit;
                acc = mod(acc, powerOfTwo);
            }
        }
    }

    // Compute the exponent of the 32-bit float.
    float getExponent(bool bits[32]) {
        const int startIndex = 1;
        const int bitStringLength = 8;
        const int endBeforeIndex = startIndex + bitStringLength;
        float acc = 0.0;
        int pow2 = bitStringLength - 1;
        for (int bitIndex = startIndex; bitIndex < endBeforeIndex; ++bitIndex) {
            acc += float(bits[bitIndex]) * exp2(float(pow2--));
        }
        return acc;
    }

    // Compute the mantissa of the 32-bit float.
    float getMantissa(bool bits[32], bool subnormal) {
        const int startIndex = 9;
        const int bitStringLength = 23;
        const int endBeforeIndex = startIndex + bitStringLength;
        // Leading/implicit/hidden bit convention:
        // If the number is not subnormal (with exponent 0), we add a leading 1 digit.
        float acc = float(!subnormal) * exp2(float(bitStringLength));
        int pow2 = bitStringLength - 1;
        for (int bitIndex = startIndex; bitIndex < endBeforeIndex; ++bitIndex) {
            acc += float(bits[bitIndex]) * exp2(float(pow2--));
        }
        return acc;
    }

    // Parse the float from its 32 bits.
    float bitsToFloat(bool bits[32]) {
        float signBit = float(bits[0]) * -2.0 + 1.0;
        float exponent = getExponent(bits);
        bool subnormal = abs(exponent - 0.0) < 0.01;
        float mantissa = getMantissa(bits, subnormal);
        float exponentBias = 127.0;
        return signBit * mantissa * exp2(exponent - exponentBias - 23.0);
    }

    float rgbaToFloat(vec4 texelRGBA, bool littleEndian) {
        ivec4 rgbaBytes = floatsToBytes(texelRGBA, littleEndian);
        bool bits[32];
        bytesToBits(rgbaBytes, bits);
        return bitsToFloat(bits);
    }
`;var H5=`
#if defined(dSizeType_uniform)
    uniform float uSize;
#elif defined(dSizeType_attribute)
    attribute float aSize;
#elif defined(dSizeType_instance) || defined(dSizeType_group) || defined(dSizeType_groupInstance)
    uniform vec2 uSizeTexDim;
    uniform sampler2D tSize;
#endif

uniform float uSizeFactor;
`;var q5=`
vec4 texture3dFrom1dTrilinear(const in sampler2D tex, const in vec3 pos, const in vec3 gridDim, const in vec2 texDim, const in float offset) {
    float gdYZ = gridDim.z * gridDim.y;
    float gdZ = gridDim.z;
    vec3 p0 = floor(pos * gridDim);
    vec3 p1 = ceil(pos * gridDim);
    vec3 pd = (pos * gridDim - p0) / (p1 - p0);
    vec4 s000 = readFromTexture(tex, offset + p0.z + p0.y * gdZ + p0.x * gdYZ, texDim);
    vec4 s100 = readFromTexture(tex, offset + p0.z + p0.y * gdZ + p1.x * gdYZ, texDim);
    vec4 s001 = readFromTexture(tex, offset + p1.z + p0.y * gdZ + p0.x * gdYZ, texDim);
    vec4 s101 = readFromTexture(tex, offset + p1.z + p0.y * gdZ + p1.x * gdYZ, texDim);
    vec4 s010 = readFromTexture(tex, offset + p0.z + p1.y * gdZ + p0.x * gdYZ, texDim);
    vec4 s110 = readFromTexture(tex, offset + p0.z + p1.y * gdZ + p1.x * gdYZ, texDim);
    vec4 s011 = readFromTexture(tex, offset + p1.z + p1.y * gdZ + p0.x * gdYZ, texDim);
    vec4 s111 = readFromTexture(tex, offset + p1.z + p1.y * gdZ + p1.x * gdYZ, texDim);
    vec4 s00 = mix(s000, s100, pd.x);
    vec4 s01 = mix(s001, s101, pd.x);
    vec4 s10 = mix(s010, s110, pd.x);
    vec4 s11 = mix(s011, s111, pd.x);
    vec4 s0 = mix(s00, s10, pd.y);
    vec4 s1 = mix(s01, s11, pd.y);
    return mix(s0, s1, pd.z);
}
`;var W5=`
vec4 texture3dFrom2dLinear(sampler2D tex, vec3 pos, vec3 gridDim, vec2 texDim) {
    float zSlice0 = floor(pos.z * gridDim.z);
    float column0 = intMod(zSlice0 * gridDim.x, texDim.x) / gridDim.x;
    float row0 = floor(intDiv(zSlice0 * gridDim.x, texDim.x));
    vec2 coord0 = (vec2(column0 * gridDim.x, row0 * gridDim.y) + (pos.xy * gridDim.xy)) / texDim;
    vec4 color0 = texture2D(tex, coord0);

    float zSlice1 = zSlice0 + 1.0;
    float column1 = intMod(zSlice1 * gridDim.x, texDim.x) / gridDim.x;
    float row1 = floor(intDiv(zSlice1 * gridDim.x, texDim.x));
    vec2 coord1 = (vec2(column1 * gridDim.x, row1 * gridDim.y) + (pos.xy * gridDim.xy)) / texDim;
    vec4 color1 = texture2D(tex, coord1);

    float delta0 = abs((pos.z * gridDim.z) - zSlice0);
    return mix(color0, color1, delta0);
}
`;var X5=`
vec4 texture3dFrom2dNearest(sampler2D tex, vec3 pos, vec3 gridDim, vec2 texDim) {
    float zSlice = floor(pos.z * gridDim.z + 0.5); // round to nearest z-slice
    float column = intMod(zSlice * gridDim.x, texDim.x) / gridDim.x;
    float row = floor(intDiv(zSlice * gridDim.x, texDim.x));
    vec2 coord = (vec2(column * gridDim.x, row * gridDim.y) + (pos.xy * gridDim.xy)) / texDim;
    return texture2D(tex, coord);
}
`;var Y5=`
#if defined(dRenderVariant_colorWboit)
    if (uRenderMask == MaskOpaque) {
        if (preFogAlpha < 1.0) {
            discard;
        }
    } else if (uRenderMask == MaskTransparent) {
        if (preFogAlpha != 1.0 && fragmentDepth < getDepth(gl_FragCoord.xy / uDrawingBufferSize)) {
            #ifdef dTransparentBackfaces_off
                if (interior) discard;
            #endif
            float alpha = gl_FragColor.a;
            float wboitWeight = alpha * clamp(pow(1.0 - fragmentDepth, 2.0), 0.01, 1.0);
            gl_FragColor = vec4(gl_FragColor.rgb * alpha * wboitWeight, alpha);
            // extra alpha is to handle pre-multiplied alpha
            #ifndef dGeometryType_directVolume
                gl_FragData[1] = vec4((uTransparentBackground ? alpha : 1.0) * alpha * wboitWeight);
            #else
                gl_FragData[1] = vec4(alpha * alpha * wboitWeight);
            #endif
        } else {
            discard;
        }
    }
#endif
`;var Q5=`
#if defined(dRenderVariant_colorDpoit)
    if (uRenderMask == MaskOpaque) {
        if (preFogAlpha < 1.0) {
            discard;
        }
    } else if (uRenderMask == MaskTransparent) {
        vec2 coords = gl_FragCoord.xy / uDrawingBufferSize;
        if (preFogAlpha != 1.0 && fragmentDepth < getDepth(coords)) {
            #ifdef dTransparentBackfaces_off
                if (interior) discard;
            #endif

            // adapted from https://github.com/tsherif/webgl2examples
            // The MIT License, Copyright 2017 Tarek Sherif, Shuai Shao

            vec2 lastDepth = texture2D(tDpoitDepth, coords).rg;
            vec4 lastFrontColor = texture2D(tDpoitFrontColor, coords);

            vec4 fragColor = gl_FragColor;

            // depth value always increases
            // so we can use MAX blend equation
            gl_FragData[2].rg = vec2(-MAX_DPOIT_DEPTH);

            // front color always increases
            // so we can use MAX blend equation
            gl_FragColor = lastFrontColor;

            // back color is separately blend afterwards each pass
            gl_FragData[1] = vec4(0.0);

            float nearestDepth = -lastDepth.x;
            float furthestDepth = lastDepth.y;
            float alphaMultiplier = 1.0 - lastFrontColor.a;

            if (fragmentDepth < nearestDepth || fragmentDepth > furthestDepth) {
                // Skip this depth since it's been peeled.
                return;
            }

            if (fragmentDepth > nearestDepth && fragmentDepth < furthestDepth) {
                // This needs to be peeled.
                // The ones remaining after MAX blended for
                // all need-to-peel will be peeled next pass.
                gl_FragData[2].rg = vec2(-fragmentDepth, fragmentDepth);
                return;
            }

            // write to back and front color buffer
            if (fragmentDepth == nearestDepth) {
                gl_FragColor.rgb += fragColor.rgb * fragColor.a * alphaMultiplier;
                gl_FragColor.a = 1.0 - alphaMultiplier * (1.0 - fragColor.a);
            } else {
                gl_FragData[1] += fragColor;
            }

        } else {
            discard;
        }
    }
#endif
`;var K5=`
precision highp float;
precision highp int;

#include common
#include read_from_texture
#include common_vert_params
#include color_vert_params
#include size_vert_params
#include common_clip

uniform float uPixelRatio;
uniform vec4 uViewport;

attribute vec3 aPosition;
attribute mat4 aTransform;
attribute float aInstance;
attribute float aGroup;

void main(){
    #include assign_group
    #include assign_color_varying
    #include assign_marker_varying
    #include assign_clipping_varying
    #include assign_position
    #include assign_size

    #ifdef dPointSizeAttenuation
        gl_PointSize = size * uPixelRatio * ((uViewport.w / 2.0) / -mvPosition.z) * 5.0;
    #else
        gl_PointSize = size * uPixelRatio;
    #endif
    gl_PointSize = max(1.0, gl_PointSize);

    gl_Position = uProjection * mvPosition;

    #include clip_instance
}
`;var $5=`
precision highp float;
precision highp int;

#include common
#include common_frag_params
#include color_frag_params
#include common_clip

const vec2 center = vec2(0.5);
const float radius = 0.5;

void main(){
    #include fade_lod
    #include clip_pixel

    float fragmentDepth = gl_FragCoord.z;
    #include assign_material_color

    #if defined(dPointStyle_circle)
        float dist = distance(gl_PointCoord, center);
        if (dist > radius) discard;
    #elif defined(dPointStyle_fuzzy)
        float dist = distance(gl_PointCoord, center);
        float fuzzyAlpha = 1.0 - smoothstep(0.0, radius, dist);
        if (fuzzyAlpha < 0.0001) discard;
    #endif

    #if defined(dPointStyle_fuzzy) && defined(dRenderVariant_color)
        material.a *= fuzzyAlpha;
    #endif

    #include check_transparency

    #if defined(dRenderVariant_pick)
        #include check_picking_alpha
        #ifdef requiredDrawBuffers
            gl_FragColor = vObject;
            gl_FragData[1] = vInstance;
            gl_FragData[2] = vGroup;
            gl_FragData[3] = packDepthToRGBA(fragmentDepth);
        #else
            gl_FragColor = vColor;
        #endif
    #elif defined(dRenderVariant_depth)
        gl_FragColor = material;
    #elif defined(dRenderVariant_marking)
        gl_FragColor = material;
    #elif defined(dRenderVariant_emissive)
        gl_FragColor = material;
    #elif defined(dRenderVariant_color)
        gl_FragColor = material;

        #include apply_marker_color
        #include apply_fog
        #include wboit_write
        #include dpoit_write
    #endif
}
`;var Z5=`
precision highp float;
precision highp int;

#include common
#include read_from_texture
#include common_vert_params
#include color_vert_params
#include size_vert_params
#include common_clip

uniform mat4 uModelView;
uniform mat4 uInvProjection;
uniform float uIsOrtho;

uniform vec2 uTexDim;
uniform sampler2D tPositionGroup;

attribute mat4 aTransform;
attribute float aInstance;

varying float vRadius;
varying vec3 vPoint;
varying vec3 vPointViewPosition;

#include matrix_scale

/**
 * Bounding rectangle of a clipped, perspective-projected 3D Sphere.
 * Michael Mara, Morgan McGuire. 2013
 *
 * Specialization by Arseny Kapoulkine, MIT License Copyright (c) 2018
 * https://github.com/zeux/niagara
 */
void sphereProjection(const in vec3 p, const in float r, const in vec2 mapping) {
    vec3 pr = p * r;
    float pzr2 = p.z * p.z - r * r;

    float vx = sqrt(p.x * p.x + pzr2);
    float minx = ((vx * p.x - pr.z) / (vx * p.z + pr.x)) * uProjection[0][0];
    float maxx = ((vx * p.x + pr.z) / (vx * p.z - pr.x)) * uProjection[0][0];

    float vy = sqrt(p.y * p.y + pzr2);
    float miny = ((vy * p.y - pr.z) / (vy * p.z + pr.y)) * uProjection[1][1];
    float maxy = ((vy * p.y + pr.z) / (vy * p.z - pr.y)) * uProjection[1][1];

    gl_Position.xy = vec2(maxx + minx, maxy + miny) * -0.5;
    gl_Position.xy -= mapping * vec2(maxx - minx, maxy - miny) * 0.5;
    gl_Position.xy *= gl_Position.w;
}

void main(void){
    vec2 mapping = vec2(1.0, 1.0); // vertices 2 and 5
    #if __VERSION__ == 100
        int m = imod(VertexID, 6);
    #else
        int m = VertexID % 6;
    #endif
    if (m == 0) {
        mapping = vec2(-1.0, 1.0);
    } else if (m == 1 || m == 3) {
        mapping = vec2(-1.0, -1.0);
    } else if (m == 4) {
        mapping = vec2(1.0, -1.0);
    }

    vec4 positionGroup = readFromTexture(tPositionGroup, VertexID / 6, uTexDim);
    vec3 position = positionGroup.rgb;
    float group = positionGroup.a;

    #include assign_color_varying
    #include assign_marker_varying
    #include assign_clipping_varying
    #include assign_size

    vRadius = size * matrixScale(uModelView);

    vec4 position4 = vec4(position, 1.0);
    vModelPosition = (uModel * aTransform * position4).xyz; // for clipping in frag shader

    float d;
    if (uLod.w != 0.0 && (uLod.x != 0.0 || uLod.y != 0.0)) {
        d = dot(uCameraPlane.xyz, vModelPosition) + uCameraPlane.w;
        float f = min(
            smoothstep(uLod.x, uLod.x + uLod.z, d),
            1.0 - smoothstep(uLod.y - uLod.z, uLod.y, d)
        ) * uLod.w;
        vRadius *= f;
    }

    vec4 mvPosition = uModelView * aTransform * position4;

    #ifdef dApproximate
        vec4 mvCorner = vec4(mvPosition.xyz, 1.0);
        mvCorner.xy += mapping * vRadius;
        gl_Position = uProjection * mvCorner;
    #else
        if (uIsOrtho == 1.0) {
            vec4 mvCorner = vec4(mvPosition.xyz, 1.0);
            mvCorner.xy += mapping * vRadius;
            gl_Position = uProjection * mvCorner;
        } else {
            gl_Position = uProjection * vec4(mvPosition.xyz, 1.0);
            sphereProjection(mvPosition.xyz, vRadius, mapping);
        }
    #endif

    vec4 vPoint4 = uInvProjection * gl_Position;
    vPoint = vPoint4.xyz / vPoint4.w;
    vPointViewPosition = -mvPosition.xyz / mvPosition.w;

    if (gl_Position.z < -gl_Position.w) {
        mvPosition.z -= 2.0 * vRadius; // avoid clipping
        gl_Position.z = (uProjection * vec4(mvPosition.xyz, 1.0)).z;
    }

    if (uLod.w != 0.0 && (uLod.x != 0.0 || uLod.y != 0.0)) {
        if (d < uLod.x || d > uLod.y) {
            // move out of [ -w, +w ] to 'discard' in vert shader
            gl_Position.z = 2.0 * gl_Position.w;
        }
    }

    #if defined(dClipPrimitive) && !defined(dClipVariant_instance) && dClipObjectCount != 0
        if (clipTest(vec4(vModelPosition.xyz, 0.0))) {
            // move out of [ -w, +w ] to 'discard' in vert shader
            gl_Position.z = 2.0 * gl_Position.w;
        }
    #else
        #include clip_instance
    #endif
}
`;var J5=`
precision highp float;
precision highp int;

#define bumpEnabled

#include common
#include common_frag_params
#include color_frag_params
#include light_frag_params
#include common_clip

uniform mat4 uInvView;
uniform float uAlphaThickness;

varying float vRadius;
varying vec3 vPoint;
varying vec3 vPointViewPosition;

#ifdef dSolidInterior
    const bool solidInterior = true;
#else
    const bool solidInterior = false;
#endif

bool SphereImpostor(out vec3 modelPos, out vec3 cameraPos, out vec3 cameraNormal, out bool interior, out float fragmentDepth){
    vec3 cameraSpherePos = -vPointViewPosition;

    vec3 rayOrigin = mix(vec3(0.0, 0.0, 0.0), vPoint, uIsOrtho);
    vec3 rayDirection = mix(normalize(vPoint), vec3(0.0, 0.0, 1.0), uIsOrtho);
    vec3 cameraSphereDir = mix(cameraSpherePos, rayOrigin - cameraSpherePos, uIsOrtho);

    float B = dot(rayDirection, cameraSphereDir);
    float det = B * B + vRadius * vRadius - dot(cameraSphereDir, cameraSphereDir);

    if (det < 0.0) return false;

    float sqrtDet = sqrt(det);
    float posT = mix(B + sqrtDet, B - sqrtDet, uIsOrtho);
    float negT = mix(B - sqrtDet, B + sqrtDet, uIsOrtho);

    cameraPos = rayDirection * negT + rayOrigin;
    modelPos = (uInvView * vec4(cameraPos, 1.0)).xyz;
    fragmentDepth = calcDepth(cameraPos);

    bool objectClipped = false;

    #if !defined(dClipPrimitive) && defined(dClipVariant_pixel) && dClipObjectCount != 0
        if (clipTest(vec4(modelPos, 0.0))) {
            objectClipped = true;
            fragmentDepth = -1.0;
        }
    #endif

    if (fragmentDepth > 0.0) {
        cameraNormal = normalize(cameraPos - cameraSpherePos);
        interior = false;
        return true;
    } else if (uDoubleSided || solidInterior) {
        cameraPos = rayDirection * posT + rayOrigin;
        modelPos = (uInvView * vec4(cameraPos, 1.0)).xyz;
        fragmentDepth = calcDepth(cameraPos);
        cameraNormal = -normalize(cameraPos - cameraSpherePos);
        interior = true;
        if (fragmentDepth > 0.0) {
            #ifdef dSolidInterior
                if (!objectClipped) {
                    fragmentDepth = 0.0 + (0.0000001 / vRadius);
                    cameraNormal = -mix(normalize(vPoint), vec3(0.0, 0.0, 1.0), uIsOrtho);
                }
            #endif
            return true;
        }
    }

    return false;
}

void main(void){
    vec3 cameraNormal;
    float fragmentDepth;

    #ifdef dApproximate
        vec3 pointDir = -vPointViewPosition - vPoint;
        if (dot(pointDir, pointDir) > vRadius * vRadius) discard;
        vec3 vViewPosition = -vPointViewPosition;
        fragmentDepth = gl_FragCoord.z;
        #if !defined(dIgnoreLight) || defined(dXrayShaded)
            pointDir.z -= cos(length(pointDir) / vRadius);
            cameraNormal = -normalize(pointDir / vRadius);
        #endif
        interior = false;
    #else
        vec3 modelPos;
        vec3 cameraPos;
        bool hit = SphereImpostor(modelPos, cameraPos, cameraNormal, interior, fragmentDepth);
        if (!hit) discard;

        if (fragmentDepth < 0.0) discard;
        if (fragmentDepth > 1.0) discard;

        gl_FragDepthEXT = fragmentDepth;

        vec3 vModelPosition = modelPos;
        vec3 vViewPosition = cameraPos;
    #endif

    #include fade_lod
    #if !defined(dClipPrimitive) && defined(dClipVariant_pixel) && dClipObjectCount != 0
        #include clip_pixel
    #endif
    #include assign_material_color

    #if defined(dRenderVariant_color)
        if (uRenderMask == MaskTransparent && uAlphaThickness > 0.0) {
            material.a *= min(1.0, vRadius / uAlphaThickness);
        }
    #endif

    #include check_transparency

    #if defined(dRenderVariant_pick)
        #include check_picking_alpha
        #ifdef requiredDrawBuffers
            gl_FragColor = vObject;
            gl_FragData[1] = vInstance;
            gl_FragData[2] = vGroup;
            gl_FragData[3] = packDepthToRGBA(fragmentDepth);
        #else
            gl_FragColor = vColor;
        #endif
    #elif defined(dRenderVariant_depth)
        gl_FragColor = material;
    #elif defined(dRenderVariant_marking)
        gl_FragColor = material;
    #elif defined(dRenderVariant_emissive)
        gl_FragColor = material;
    #elif defined(dRenderVariant_color)
        vec3 normal = -cameraNormal;
        #include apply_light_color

        #include apply_interior_color
        #include apply_marker_color
        #include apply_fog
        #include wboit_write
        #include dpoit_write
    #endif
}
`;var eG=`
precision highp float;
precision highp int;

#include common
#include read_from_texture
#include common_vert_params
#include color_vert_params
#include size_vert_params
#include common_clip

uniform mat4 uModelView;

attribute mat4 aTransform;
attribute float aInstance;
attribute float aGroup;

attribute vec3 aMapping;
attribute vec3 aStart;
attribute vec3 aEnd;
attribute float aScale;
attribute float aCap;
attribute float aColorMode;

varying mat4 vTransform;
varying vec3 vStart;
varying vec3 vEnd;
varying float vSize;
varying float vCap;

uniform float uIsOrtho;
uniform vec3 uCameraDir;

void main() {
    #include assign_group
    #include assign_color_varying
    #include assign_marker_varying
    #include assign_clipping_varying
    #include assign_size

    mat4 modelTransform = uModel * aTransform;

    vTransform = aTransform;
    vStart = (modelTransform * vec4(aStart, 1.0)).xyz;
    vEnd = (modelTransform * vec4(aEnd, 1.0)).xyz;
    vSize = size * aScale;
    vCap = aCap;

    vModelPosition = (vStart + vEnd) * 0.5;
    vec3 camDir = -mix(normalize(vModelPosition - uCameraPosition), uCameraDir, uIsOrtho);
    vec3 dir = vEnd - vStart;
    float f = aMapping.x > 0.0 ? 1.0 : 0.0;
    // ensure cylinder 'dir' is pointing towards the camera
    if(dot(camDir, dir) < 0.0) {
        dir = -dir;
        f = 1.0 - f;
    }

    vec3 left = cross(camDir, dir);
    vec3 up = cross(left, dir);
    left = vSize * normalize(left);
    up = vSize * normalize(up);

    // move vertex in object-space from center to corner
    vModelPosition += aMapping.x * dir + aMapping.y * left + aMapping.z * up;

    vec4 mvPosition = uView * vec4(vModelPosition, 1.0);
    vViewPosition = mvPosition.xyz;
    gl_Position = uProjection * mvPosition;

    if (gl_Position.z < -gl_Position.w) {
        mvPosition.z -= 2.0 * (length(vEnd - vStart) + vSize); // avoid clipping
        gl_Position.z = (uProjection * mvPosition).z;
    }

    #if defined(dDualColor) && defined(dRenderVariant_color) && (defined(dColorType_group) || defined(dColorType_groupInstance))
        // dual-color mixing
        // - for aColorMode between 0 and 1 use aColorMode to interpolate
        // - for aColorMode == 2 do nothing, i.e., use vColor
        // - for aColorMode == 3 use position on cylinder axis to interpolate
        if (aColorMode <= 1.0){
            vColor.rgb = mix(vColor.rgb, color2.rgb, aColorMode);
        } else if (aColorMode == 3.0) {
            vColor.rgb = mix(vColor.rgb, color2.rgb, mix(-0.25, 1.25, f / 1.5));
        }
    #endif

    #include clip_instance
}
`;var tG=`
precision highp float;
precision highp int;

#define bumpEnabled

uniform mat4 uView;

varying mat4 vTransform;
varying vec3 vStart;
varying vec3 vEnd;
varying float vSize;
varying float vCap;

uniform vec3 uCameraDir;
uniform vec3 uCameraPosition;
uniform mat4 uInvView;

#include common
#include common_frag_params
#include color_frag_params
#include light_frag_params
#include common_clip

#ifdef dSolidInterior
    const bool solidInterior = true;
#else
    const bool solidInterior = false;
#endif

// adapted from https://www.shadertoy.com/view/4lcSRn
// The MIT License, Copyright 2016 Inigo Quilez
bool CylinderImpostor(
    in vec3 rayOrigin, in vec3 rayDir,
    in vec3 start, in vec3 end, in float radius,
    out vec3 cameraNormal, out bool interior,
    out vec3 modelPosition, out vec3 viewPosition, out float fragmentDepth
){
    vec3 ba = end - start;
    vec3 oc = rayOrigin - start;

    float baba = dot(ba, ba);
    float bard = dot(ba, rayDir);
    float baoc = dot(ba, oc);

    float k2 = baba - bard * bard;
    float k1 = baba * dot(oc, rayDir) - baoc * bard;
    float k0 = baba * dot(oc, oc) - baoc * baoc - radius * radius * baba;

    float h = k1 * k1 - k2 * k0;
    if (h < 0.0) return false;

    bool topCap = (vCap > 0.9 && vCap < 1.1) || vCap >= 2.9;
    bool bottomCap = (vCap > 1.9 && vCap < 2.1) || vCap >= 2.9;

    #ifdef dSolidInterior
        bool topInterior = !topCap;
        bool bottomInterior = !bottomCap;
        topCap = true;
        bottomCap = true;
    #else
        bool topInterior = false;
        bool bottomInterior = false;
    #endif

    bool clipped = false;
    bool objectClipped = false;

    // body outside
    h = sqrt(h);
    float t = (-k1 - h) / k2;
    float y = baoc + t * bard;
    if (y > 0.0 && y < baba) {
        interior = false;
        cameraNormal = (oc + t * rayDir - ba * y / baba) / radius;
        modelPosition = rayOrigin + t * rayDir;
        viewPosition = (uView * vec4(modelPosition, 1.0)).xyz;
        fragmentDepth = calcDepth(viewPosition);
        #if defined(dClipVariant_pixel) && dClipObjectCount != 0
            if (clipTest(vec4(modelPosition, 0.0))) {
                objectClipped = true;
                fragmentDepth = -1.0;
                #ifdef dSolidInterior
                    topCap = !topInterior;
                    bottomCap = !bottomInterior;
                #endif
            }
        #endif
        if (fragmentDepth > 0.0) return true;
        clipped = true;
    }

    if (!clipped) {
        if (topCap && y < 0.0) {
            // top cap
            t = -baoc / bard;
            if (abs(k1 + k2 * t) < h) {
                interior = topInterior;
                cameraNormal = -ba / baba;
                modelPosition = rayOrigin + t * rayDir;
                viewPosition = (uView * vec4(modelPosition, 1.0)).xyz;
                fragmentDepth = calcDepth(viewPosition);
                #if defined(dClipVariant_pixel) && dClipObjectCount != 0
                    if (clipTest(vec4(modelPosition, 0.0))) {
                        objectClipped = true;
                        fragmentDepth = -1.0;
                        #ifdef dSolidInterior
                            topCap = !topInterior;
                            bottomCap = !bottomInterior;
                        #endif
                    }
                #endif
                if (fragmentDepth > 0.0) {
                    #ifdef dSolidInterior
                        if (interior) cameraNormal = -rayDir;
                    #endif
                    return true;
                }
            }
        } else if (bottomCap && y >= 0.0) {
            // bottom cap
            t = (baba - baoc) / bard;
            if (abs(k1 + k2 * t) < h) {
                interior = bottomInterior;
                cameraNormal = ba / baba;
                modelPosition = rayOrigin + t * rayDir;
                viewPosition = (uView * vec4(modelPosition, 1.0)).xyz;
                fragmentDepth = calcDepth(viewPosition);
                #if defined(dClipVariant_pixel) && dClipObjectCount != 0
                    if (clipTest(vec4(modelPosition, 0.0))) {
                        objectClipped = true;
                        fragmentDepth = -1.0;
                        #ifdef dSolidInterior
                            topCap = !topInterior;
                            bottomCap = !bottomInterior;
                        #endif
                    }
                #endif
                if (fragmentDepth > 0.0) {
                    #ifdef dSolidInterior
                        if (interior) cameraNormal = -rayDir;
                    #endif
                    return true;
                }
            }
        }
    }

    if (uDoubleSided || solidInterior) {
        // body inside
        h = -h;
        t = (-k1 - h) / k2;
        y = baoc + t * bard;
        if (y > 0.0 && y < baba) {
            interior = true;
            cameraNormal = -(oc + t * rayDir - ba * y / baba) / radius;
            modelPosition = rayOrigin + t * rayDir;
            viewPosition = (uView * vec4(modelPosition, 1.0)).xyz;
            fragmentDepth = calcDepth(viewPosition);
            if (fragmentDepth > 0.0) {
                #ifdef dSolidInterior
                    if (!objectClipped) {
                        fragmentDepth = 0.0 + (0.0000002 / vSize);
                        cameraNormal = -rayDir;
                    }
                #endif
                return true;
            }
        }

        if (topCap && y < 0.0) {
            // top cap
            t = -baoc / bard;
            if (abs(k1 + k2 * t) < -h) {
                interior = true;
                cameraNormal = ba / baba;
                modelPosition = rayOrigin + t * rayDir;
                viewPosition = (uView * vec4(modelPosition, 1.0)).xyz;
                fragmentDepth = calcDepth(viewPosition);
                if (fragmentDepth > 0.0) {
                    #ifdef dSolidInterior
                        if (!objectClipped) {
                            fragmentDepth = 0.0 + (0.0000002 / vSize);
                            cameraNormal = -rayDir;
                        }
                    #endif
                    return true;
                }
            }
        } else if (bottomCap && y >= 0.0) {
            // bottom cap
            t = (baba - baoc) / bard;
            if (abs(k1 + k2 * t) < -h) {
                interior = true;
                cameraNormal = -ba / baba;
                modelPosition = rayOrigin + t * rayDir;
                viewPosition = (uView * vec4(modelPosition, 1.0)).xyz;
                fragmentDepth = calcDepth(viewPosition);
                if (fragmentDepth > 0.0) {
                    #ifdef dSolidInterior
                        if (!objectClipped) {
                            fragmentDepth = 0.0 + (0.0000002 / vSize);
                            cameraNormal = -rayDir;
                        }
                    #endif
                    return true;
                }
            }
        }
    }

    return false;
}

void main() {
    vec3 rayOrigin = vModelPosition;
    vec3 rayDir = mix(normalize(vModelPosition - uCameraPosition), uCameraDir, uIsOrtho);

    vec3 cameraNormal;
    vec3 modelPosition;
    vec3 viewPosition;
    float fragmentDepth;
    bool hit = CylinderImpostor(rayOrigin, rayDir, vStart, vEnd, vSize, cameraNormal, interior, modelPosition, viewPosition, fragmentDepth);
    if (!hit) discard;

    if (fragmentDepth < 0.0) discard;
    if (fragmentDepth > 1.0) discard;

    gl_FragDepthEXT = fragmentDepth;

    vec3 vViewPosition = viewPosition;
    vec3 vModelPosition = modelPosition;

    #include fade_lod
    #include clip_pixel
    #include assign_material_color
    #include check_transparency

    #if defined(dRenderVariant_pick)
        #include check_picking_alpha
        #ifdef requiredDrawBuffers
            gl_FragColor = vObject;
            gl_FragData[1] = vInstance;
            gl_FragData[2] = vGroup;
            gl_FragData[3] = packDepthToRGBA(fragmentDepth);
        #else
            gl_FragColor = vColor;
        #endif
    #elif defined(dRenderVariant_depth)
        gl_FragColor = material;
    #elif defined(dRenderVariant_marking)
        gl_FragColor = material;
    #elif defined(dRenderVariant_emissive)
        gl_FragColor = material;
    #elif defined(dRenderVariant_color)
        mat3 normalMatrix = transpose3(inverse3(mat3(uView)));
        vec3 normal = normalize(normalMatrix * -normalize(cameraNormal));
        #include apply_light_color

        #include apply_interior_color
        #include apply_marker_color
        #include apply_fog
        #include wboit_write
        #include dpoit_write
    #endif
}
`;var rG=`
precision highp float;
precision highp int;

#include common
#include read_from_texture
#include common_vert_params
#include color_vert_params
#include size_vert_params
#include common_clip

uniform mat4 uModelView;

attribute vec3 aPosition;
attribute vec2 aMapping;
attribute float aDepth;
attribute vec2 aTexCoord;
attribute mat4 aTransform;
attribute float aInstance;
attribute float aGroup;

uniform float uOffsetX;
uniform float uOffsetY;
uniform float uOffsetZ;

uniform float uIsOrtho;
uniform float uPixelRatio;
uniform vec4 uViewport;

varying vec2 vTexCoord;

#include matrix_scale

void main(void){
    #include assign_group
    #include assign_color_varying
    #include assign_marker_varying
    #include assign_clipping_varying
    #include assign_size

    vTexCoord = aTexCoord;

    float scale = matrixScale(uModelView);

    float offsetX = uOffsetX * scale;
    float offsetY = uOffsetY * scale;
    float offsetZ = (uOffsetZ + aDepth * 0.95) * scale;

    vec4 position4 = vec4(aPosition, 1.0);
    vec4 mvPosition = uModelView * aTransform * position4;

    vModelPosition = (uModel * aTransform * position4).xyz; // for clipping in frag shader

    // TODO
    // #ifdef FIXED_SIZE
    //     if (ortho) {
    //         scale /= pixelRatio * ((uViewport.w / 2.0) / -uCameraPosition.z) * 0.1;
    //     } else {
    //         scale /= pixelRatio * ((uViewport.w / 2.0) / -mvPosition.z) * 0.1;
    //     }
    // #endif

    vec4 mvCorner = vec4(mvPosition.xyz, 1.0);

    if (vTexCoord.x == 10.0) { // indicates background plane
        // move a bit to the back, taking distance to camera into account to avoid z-fighting
        offsetZ -= 0.001 * distance(uCameraPosition, (uProjection * mvCorner).xyz);
    }

    mvCorner.xy += aMapping * size * scale;
    mvCorner.x += offsetX;
    mvCorner.y += offsetY;

    if (uIsOrtho == 1.0) {
        mvCorner.z += offsetZ;
    } else {
        mvCorner.xyz += normalize(-mvCorner.xyz) * offsetZ;
    }

    gl_Position = uProjection * mvCorner;

    vViewPosition = -mvCorner.xyz;

    #include clip_instance
}
`;var nG=`
precision highp float;
precision highp int;

#include common
#include common_frag_params
#include color_frag_params
#include common_clip

uniform sampler2D tFont;

uniform vec3 uBorderColor;
uniform float uBorderWidth;
uniform vec3 uBackgroundColor;
uniform float uBackgroundOpacity;

varying vec2 vTexCoord;

const float smoothness = 32.0;
const float gamma = 2.2;

void main2(){
    gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);
}

void main(){
    #include fade_lod
    #include clip_pixel

    float fragmentDepth = gl_FragCoord.z;
    #include assign_material_color

    if (vTexCoord.x > 1.0) {
        #if defined(dRenderVariant_color)
            material = vec4(uBackgroundColor, uBackgroundOpacity * material.a);
        #endif
    } else {
        // retrieve signed distance
        float sdf = texture2D(tFont, vTexCoord).a + uBorderWidth;

        // perform adaptive anti-aliasing of the edges
        float w = clamp(smoothness * (abs(dFdx(vTexCoord.x)) + abs(dFdy(vTexCoord.y))), 0.0, 0.5);
        float a = clamp(0.0, 1.0, smoothstep(0.5 - w, 0.5 + w, sdf));

        // gamma correction for linear attenuation
        a = pow(a, 1.0 / gamma);

        if (a < 0.5) discard;

        #if defined(dRenderVariant_color)
            // add border
            float t = 0.5 + uBorderWidth;
            if (uBorderWidth > 0.0 && sdf < t) {
                material.xyz = mix(uBorderColor, material.xyz, smoothstep(t - w, t, sdf));
            }
        #endif
    }

    #include check_transparency

    #if defined(dRenderVariant_pick)
        #include check_picking_alpha
        #ifdef requiredDrawBuffers
            gl_FragColor = vObject;
            gl_FragData[1] = vInstance;
            gl_FragData[2] = vGroup;
            gl_FragData[3] = packDepthToRGBA(fragmentDepth);
        #else
            gl_FragColor = vColor;
        #endif
    #elif defined(dRenderVariant_depth)
        gl_FragColor = material;
    #elif defined(dRenderVariant_marking)
        gl_FragColor = material;
    #elif defined(dRenderVariant_emissive)
        gl_FragColor = material;
    #elif defined(dRenderVariant_color)
        gl_FragColor = material;

        #include apply_marker_color
        #include apply_fog
        #include wboit_write
        #include dpoit_write
    #endif
}
`;var oG=`
precision highp float;
precision highp int;

#include common
#include read_from_texture
#include common_vert_params
#include color_vert_params
#include size_vert_params
#include common_clip

uniform float uPixelRatio;
uniform vec4 uViewport;

attribute mat4 aTransform;
attribute float aInstance;
attribute float aGroup;

attribute vec2 aMapping;
attribute vec3 aStart;
attribute vec3 aEnd;

void trimSegment(const in vec4 start, inout vec4 end) {
    // trim end segment so it terminates between the camera plane and the near plane
    // conservative estimate of the near plane
    float a = uProjection[2][2];  // 3rd entry in 3rd column
    float b = uProjection[3][2];  // 3rd entry in 4th column
    float nearEstimate = -0.5 * b / a;
    float alpha = (nearEstimate - start.z) / (end.z - start.z);
    end.xyz = mix(start.xyz, end.xyz, alpha);
}

void main(){
    float aspect = uViewport.z / uViewport.w;

    #include assign_group
    #include assign_color_varying
    #include assign_marker_varying
    #include assign_clipping_varying
    #include assign_size

    mat4 modelView = uView * uModel * aTransform;

    // camera space
    vec4 start = modelView * vec4(aStart, 1.0);
    vec4 end = modelView * vec4(aEnd, 1.0);

    // assign position
    vec4 position4 = vec4((aMapping.y < 0.5) ? aStart : aEnd, 1.0);
    vec4 mvPosition = modelView * position4;
    vViewPosition = mvPosition.xyz;

    vModelPosition = (uModel * aTransform * position4).xyz; // for clipping in frag shader

    // special case for perspective projection, and segments that terminate either in, or behind, the camera plane
    // clearly the gpu firmware has a way of addressing this issue when projecting into ndc space
    // but we need to perform ndc-space calculations in the shader, so we must address this issue directly
    // perhaps there is a more elegant solution -- WestLangley
    bool perspective = (uProjection[2][3] == -1.0); // 4th entry in the 3rd column
    if (perspective) {
        if (start.z < 0.0 && end.z >= 0.0) {
            trimSegment(start, end);
        } else if (end.z < 0.0 && start.z >= 0.0) {
            trimSegment(end, start);
        }
    }

    // clip space
    vec4 clipStart = uProjection * start;
    vec4 clipEnd = uProjection * end;

    // ndc space
    vec2 ndcStart = clipStart.xy / clipStart.w;
    vec2 ndcEnd = clipEnd.xy / clipEnd.w;

    // direction
    vec2 dir = ndcEnd - ndcStart;

    // account for clip-space aspect ratio
    dir.x *= aspect;
    dir = normalize(dir);

    // perpendicular to dir
    vec2 offset = vec2(dir.y, - dir.x);

    // undo aspect ratio adjustment
    dir.x /= aspect;
    offset.x /= aspect;

    // sign flip
    if (aMapping.x < 0.0) offset *= -1.0;

    // calculate linewidth
    float linewidth;
    #ifdef dLineSizeAttenuation
        linewidth = size * uPixelRatio * ((uViewport.w / 2.0) / -start.z) * 5.0;
    #else
        linewidth = size * uPixelRatio;
    #endif
    linewidth = max(1.0, linewidth);

    // adjust for linewidth
    offset *= linewidth;

    // adjust for clip-space to screen-space conversion
    offset /= uViewport.w;

    // select end
    vec4 clip = (aMapping.y < 0.5) ? clipStart : clipEnd;

    // back to clip space
    offset *= clip.w;
    clip.xy += offset;
    gl_Position = clip;

    #include clip_instance
}
`;var iG=`
precision highp float;
precision highp int;

#include common
#include common_frag_params
#include color_frag_params
#include common_clip

void main(){
    #include fade_lod
    #include clip_pixel

    float fragmentDepth = gl_FragCoord.z;
    #include assign_material_color
    #include check_transparency

    #if defined(dRenderVariant_pick)
        #include check_picking_alpha
        #ifdef requiredDrawBuffers
            gl_FragColor = vObject;
            gl_FragData[1] = vInstance;
            gl_FragData[2] = vGroup;
            gl_FragData[3] = packDepthToRGBA(fragmentDepth);
        #else
            gl_FragColor = vColor;
        #endif
    #elif defined(dRenderVariant_depth)
        gl_FragColor = material;
    #elif defined(dRenderVariant_marking)
        gl_FragColor = material;
    #elif defined(dRenderVariant_emissive)
        gl_FragColor = material;
    #elif defined(dRenderVariant_color)
        gl_FragColor = material;

        #include apply_marker_color
        #include apply_fog
        #include wboit_write
        #include dpoit_write
    #endif
}
`;var aG=`
precision highp float;
precision highp int;
precision highp sampler2D;

#include common
#include read_from_texture
#include common_vert_params
#include color_vert_params
#include common_clip
#include texture3d_from_2d_linear

#ifdef dGeometryType_textureMesh
    uniform vec2 uGeoTexDim;
    uniform sampler2D tPosition;
    uniform sampler2D tGroup;
    uniform sampler2D tNormal;
#else
    attribute vec3 aPosition;
    attribute float aGroup;
    attribute vec3 aNormal;
#endif
attribute mat4 aTransform;
attribute float aInstance;

varying vec3 vNormal;

void main(){
    #include assign_group
    #include assign_marker_varying
    #include assign_clipping_varying
    #include assign_position
    #include assign_color_varying
    #include clip_instance

    #ifdef dGeometryType_textureMesh
        vec3 normal = readFromTexture(tNormal, VertexID, uGeoTexDim).xyz;
    #else
        vec3 normal = aNormal;
    #endif
    mat3 normalMatrix = transpose3(inverse3(mat3(modelView)));
    vec3 transformedNormal = normalize(normalMatrix * normalize(normal));
    #if defined(dFlipSided)
        if (!uDoubleSided) { // TODO checking uDoubleSided should not be required, ASR
            transformedNormal = -transformedNormal;
        }
    #endif
    vNormal = transformedNormal;
}
`;var sG=`
precision highp float;
precision highp int;

#define bumpEnabled

#include common
#include common_frag_params
#include color_frag_params
#include light_frag_params
#include normal_frag_params
#include common_clip

void main() {
    #include fade_lod
    #include clip_pixel

    // Workaround for buggy gl_FrontFacing (e.g. on some integrated Intel GPUs)
    vec3 fdx = dFdx(vViewPosition);
    vec3 fdy = dFdy(vViewPosition);
    vec3 faceNormal = normalize(cross(fdx,fdy));
    bool frontFacing = dot(vNormal, faceNormal) > 0.0;

    #if defined(dFlipSided)
        interior = frontFacing;
    #else
        interior = !frontFacing;
    #endif

    float fragmentDepth = gl_FragCoord.z;
    #include assign_material_color
    #include check_transparency

    #if defined(dRenderVariant_pick)
        #include check_picking_alpha
        #ifdef requiredDrawBuffers
            gl_FragColor = vObject;
            gl_FragData[1] = vInstance;
            gl_FragData[2] = vGroup;
            gl_FragData[3] = packDepthToRGBA(fragmentDepth);
        #else
            gl_FragColor = vColor;
        #endif
    #elif defined(dRenderVariant_depth)
        gl_FragColor = material;
    #elif defined(dRenderVariant_marking)
        gl_FragColor = material;
    #elif defined(dRenderVariant_emissive)
        gl_FragColor = material;
    #elif defined(dRenderVariant_color)
        #if defined(dFlatShaded)
            vec3 normal = -faceNormal;
        #else
            vec3 normal = -normalize(vNormal);
            if (uDoubleSided) normal *= float(frontFacing) * 2.0 - 1.0;
        #endif
        #include apply_light_color

        #include apply_interior_color
        #include apply_marker_color
        #include apply_fog
        #include wboit_write
        #include dpoit_write
    #endif
}
`;var lG=`
precision highp float;

attribute vec3 aPosition;
attribute mat4 aTransform;
attribute float aInstance;

uniform mat4 uModelView;
uniform mat4 uProjection;
uniform vec4 uInvariantBoundingSphere;

varying vec3 vOrigPos;
varying float vInstance;
varying vec4 vBoundingSphere;
varying mat4 vTransform;

uniform vec3 uBboxSize;
uniform vec3 uBboxMin;
uniform vec3 uBboxMax;
uniform vec3 uGridDim;
uniform mat4 uTransform;

uniform mat4 uUnitToCartn;

void main() {
    vec4 unitCoord = vec4(aPosition + vec3(0.5), 1.0);
    vec4 mvPosition = uModelView * aTransform * uUnitToCartn * unitCoord;

    vOrigPos = (aTransform * uUnitToCartn * unitCoord).xyz;
    vInstance = aInstance;
    vBoundingSphere = vec4(
        (aTransform * vec4(uInvariantBoundingSphere.xyz, 1.0)).xyz,
        uInvariantBoundingSphere.w
    );
    vTransform = aTransform;

    gl_Position = uProjection * mvPosition;

    // move z position to near clip plane (but not too close to get precision issues)
    gl_Position.z = gl_Position.w - 0.01;
}
`;var cG=`
precision highp float;
precision highp int;

#include common
#include light_frag_params

#if dClipObjectCount != 0
    uniform int uClipObjectType[dClipObjectCount];
    uniform bool uClipObjectInvert[dClipObjectCount];
    uniform vec3 uClipObjectPosition[dClipObjectCount];
    uniform vec4 uClipObjectRotation[dClipObjectCount];
    uniform vec3 uClipObjectScale[dClipObjectCount];
#endif
#include common_clip

#include read_from_texture
#include texture3d_from_1d_trilinear
#include texture3d_from_2d_nearest
#include texture3d_from_2d_linear

uniform mat4 uProjection, uTransform, uModelView, uModel, uView;
uniform vec3 uCameraDir;

uniform sampler2D tDepth;
uniform vec2 uDrawingBufferSize;

varying vec3 vOrigPos;
varying float vInstance;
varying vec4 vBoundingSphere;
varying mat4 vTransform;

uniform mat4 uInvView;
uniform vec3 uGridDim;
uniform vec3 uBboxSize;
uniform sampler2D tTransferTex;
uniform float uTransferScale;
uniform float uStepScale;
uniform float uJumpLength;

uniform int uObjectId;
uniform int uVertexCount;
uniform int uInstanceCount;
uniform int uGroupCount;

#if defined(dColorMarker)
    uniform vec3 uHighlightColor;
    uniform vec3 uSelectColor;
    uniform vec3 uDimColor;
    uniform float uHighlightStrength;
    uniform float uSelectStrength;
    uniform float uDimStrength;
    uniform int uMarkerPriority;
    uniform float uMarkerAverage;

    uniform float uMarker;
    uniform vec2 uMarkerTexDim;
    uniform sampler2D tMarker;
#endif

uniform float uMetalness;
uniform float uRoughness;
uniform float uEmissive;

uniform bool uFog;
uniform float uFogNear;
uniform float uFogFar;
uniform vec3 uFogColor;

uniform float uAlpha;
uniform bool uTransparentBackground;
uniform float uXrayEdgeFalloff;
uniform float uExposure;

uniform int uRenderMask;

uniform float uNear;
uniform float uFar;
uniform float uIsOrtho;

uniform vec3 uCellDim;
uniform vec3 uCameraPosition;
uniform mat4 uCartnToUnit;

#if __VERSION__ != 100
    // for webgl1 this is given as a 'define'
    uniform int uMaxSteps;
#endif

#if defined(dGridTexType_2d)
    precision highp sampler2D;
    uniform sampler2D tGridTex;
    uniform vec3 uGridTexDim;
#elif defined(dGridTexType_3d)
    precision highp sampler3D;
    uniform sampler3D tGridTex;
#endif

#if defined(dColorType_uniform)
    uniform vec3 uColor;
#elif defined(dColorType_texture)
    uniform vec2 uColorTexDim;
    uniform sampler2D tColor;
#endif

#ifdef dOverpaint
    #if defined(dOverpaintType_groupInstance) || defined(dOverpaintType_vertexInstance)
        uniform vec2 uOverpaintTexDim;
        uniform sampler2D tOverpaint;
    #endif
#endif

#ifdef dUsePalette
    uniform sampler2D tPalette;
#endif

#if defined(dGridTexType_2d)
    vec4 textureVal(vec3 pos) {
        return texture3dFrom2dLinear(tGridTex, pos + (vec3(0.5, 0.5, 0.0) / uGridDim), uGridDim, uGridTexDim.xy);
    }
    vec4 textureGroup(vec3 pos) {
        return texture3dFrom2dNearest(tGridTex, pos + (vec3(0.5, 0.5, 0.0) / uGridDim), uGridDim, uGridTexDim.xy);
    }
#elif defined(dGridTexType_3d)
    vec4 textureVal(vec3 pos) {
        return texture(tGridTex, pos + (vec3(0.5) / uGridDim));
    }
    vec4 textureGroup(vec3 pos) {
        return texelFetch(tGridTex, ivec3(pos * uGridDim), 0);
    }
#endif

float calcDepth(const in vec3 pos) {
    vec2 clipZW = pos.z * uProjection[2].zw + uProjection[3].zw;
    return 0.5 + 0.5 * clipZW.x / clipZW.y;
}

float transferFunction(float value) {
    return texture2D(tTransferTex, vec2(value, 0.0)).a;
}

float getDepth(const in vec2 coords) {
    #ifdef depthTextureSupport
        return texture2D(tDepth, coords).r;
    #else
        return unpackRGBAToDepth(texture2D(tDepth, coords));
    #endif
}

const float gradOffset = 0.5;

vec3 v3m4(vec3 p, mat4 m) {
    return (m * vec4(p, 1.0)).xyz;
}

float preFogAlphaBlended = 0.0;

vec4 raymarch(vec3 startLoc, vec3 step, vec3 rayDir) {
    mat3 normalMatrix = transpose3(inverse3(mat3(uModelView * vTransform)));
    mat4 cartnToUnit = uCartnToUnit * inverse4(vTransform);
    #if defined(dClipVariant_pixel) && dClipObjectCount != 0
        mat4 modelTransform = uModel * vTransform * uTransform;
    #endif
    mat4 modelViewTransform = uModelView * vTransform * uTransform;

    vec3 scaleVol = vec3(1.0) / uGridDim;
    vec3 pos = startLoc;
    vec4 cell;
    float prevValue = -1.0;
    float value = 0.0;
    vec4 src = vec4(0.0);
    vec4 dst = vec4(0.0);
    float fragmentDepth;

    vec3 posMin = vec3(0.0);
    vec3 posMax = vec3(1.0) - vec3(1.0) / uGridDim;

    vec3 unitPos;

    vec3 nextPos;
    float nextValue;

    vec4 material;
    vec4 overpaint;
    float metalness = uMetalness;
    float roughness = uRoughness;
    float emissive = uEmissive;

    vec3 gradient = vec3(1.0);
    vec3 dx = vec3(gradOffset * scaleVol.x, 0.0, 0.0);
    vec3 dy = vec3(0.0, gradOffset * scaleVol.y, 0.0);
    vec3 dz = vec3(0.0, 0.0, gradOffset * scaleVol.z);

    float maxDist = min(vBoundingSphere.w * 2.0, uFar - uNear);
    float maxDistSq = maxDist * maxDist;

    for (int i = 0; i < uMaxSteps; ++i) {
        // break when beyond bounding-sphere or far-plane
        vec3 distVec = startLoc - pos;
        if (dot(distVec, distVec) > maxDistSq) break;

        unitPos = v3m4(pos, cartnToUnit);

        // continue when outside of grid
        if (unitPos.x > posMax.x || unitPos.y > posMax.y || unitPos.z > posMax.z ||
            unitPos.x < posMin.x || unitPos.y < posMin.y || unitPos.z < posMin.z
        ) {
            prevValue = value;
            pos += step;
            continue;
        }

        cell = textureVal(unitPos);
        value = cell.a; // current voxel value

        if (uJumpLength > 0.0 && value < 0.01) {
            nextPos = pos + rayDir * uJumpLength;
            nextValue = textureVal(v3m4(nextPos, cartnToUnit)).a;
            if (nextValue < 0.01) {
                prevValue = nextValue;
                pos = nextPos;
                continue;
            }
        }

        vec4 mvPosition = modelViewTransform * vec4(unitPos * uGridDim, 1.0);
        if (calcDepth(mvPosition.xyz) > getDepth(gl_FragCoord.xy / uDrawingBufferSize))
            break;

        #if defined(dClipVariant_pixel) && dClipObjectCount != 0
            vec3 vModelPosition = v3m4(unitPos * uGridDim, modelTransform);
            if (clipTest(vec4(vModelPosition, 0.0))) {
                prevValue = value;
                pos += step;
                continue;
            }
        #endif

        vec3 vViewPosition = mvPosition.xyz;
        material.a = transferFunction(value);

        #ifdef dPackedGroup
            float group = unpackRGBToInt(textureGroup(floor(unitPos * uGridDim + 0.5) / uGridDim).rgb);
        #else
            vec3 g = floor(unitPos * uGridDim + 0.5);
            // note that we swap x and z because the texture is flipped around y
            #if defined(dAxisOrder_012)
                float group = g.z + g.y * uGridDim.z + g.x * uGridDim.z * uGridDim.y; // 210
            #elif defined(dAxisOrder_021)
                float group = g.y + g.z * uGridDim.y + g.x * uGridDim.y * uGridDim.z; // 120
            #elif defined(dAxisOrder_102)
                float group = g.z + g.x * uGridDim.z + g.y * uGridDim.z * uGridDim.x; // 201
            #elif defined(dAxisOrder_120)
                float group = g.x + g.z * uGridDim.x + g.y * uGridDim.x * uGridDim.z; // 021
            #elif defined(dAxisOrder_201)
                float group = g.y + g.x * uGridDim.y + g.z * uGridDim.y * uGridDim.x; // 102
            #elif defined(dAxisOrder_210)
                float group = g.x + g.y * uGridDim.x + g.z * uGridDim.x * uGridDim.y; // 012
            #endif
        #endif

        #if defined(dColorType_direct) && defined(dUsePalette)
            material.rgb = texture2D(tPalette, vec2(value, 0.0)).rgb;
        #elif defined(dColorType_uniform)
            material.rgb = uColor;
        #elif defined(dColorType_instance)
            material.rgb = readFromTexture(tColor, vInstance, uColorTexDim).rgb;
        #elif defined(dColorType_group)
            material.rgb = readFromTexture(tColor, group, uColorTexDim).rgb;
        #elif defined(dColorType_groupInstance)
            material.rgb = readFromTexture(tColor, vInstance * float(uGroupCount) + group, uColorTexDim).rgb;
        #elif defined(dColorType_vertex)
            material.rgb = texture3dFrom1dTrilinear(tColor, unitPos, uGridDim, uColorTexDim, 0.0).rgb;
        #elif defined(dColorType_vertexInstance)
            material.rgb = texture3dFrom1dTrilinear(tColor, unitPos, uGridDim, uColorTexDim, vInstance * float(uVertexCount)).rgb;
        #endif

        #ifdef dOverpaint
            #if defined(dOverpaintType_groupInstance)
                overpaint = readFromTexture(tOverpaint, vInstance * float(uGroupCount) + group, uOverpaintTexDim);
            #elif defined(dOverpaintType_vertexInstance)
                overpaint = texture3dFrom1dTrilinear(tOverpaint, unitPos, uGridDim, uOverpaintTexDim, vInstance * float(uVertexCount));
            #endif

            material.rgb = mix(material.rgb, overpaint.rgb, overpaint.a);
        #endif

        #if defined(dIgnoreLight)
            gl_FragColor.rgb = material.rgb;
        #else
            if (material.a >= 0.01) {
                #ifdef dPackedGroup
                    // compute gradient by central differences
                    gradient.x = textureVal(unitPos - dx).a - textureVal(unitPos + dx).a;
                    gradient.y = textureVal(unitPos - dy).a - textureVal(unitPos + dy).a;
                    gradient.z = textureVal(unitPos - dz).a - textureVal(unitPos + dz).a;
                #else
                    gradient = cell.xyz * 2.0 - 1.0;
                #endif
                vec3 normal = -normalize(normalMatrix * normalize(gradient));
                #include apply_light_color
            } else {
                gl_FragColor.rgb = material.rgb;
            }
        #endif

        gl_FragColor.a = material.a * uAlpha * uTransferScale;

        #if defined(dColorMarker)
            float marker = uMarker;
            if (uMarker == -1.0) {
                marker = readFromTexture(tMarker, vInstance * float(uGroupCount) + group, uMarkerTexDim).a;
                marker = floor(marker * 255.0 + 0.5); // rounding required to work on some cards on win
            }
        #endif
        #include apply_marker_color

        preFogAlphaBlended = (1.0 - preFogAlphaBlended) * gl_FragColor.a + preFogAlphaBlended;
        fragmentDepth = calcDepth(mvPosition.xyz);
        #include apply_fog

        src = gl_FragColor;

        if (!uTransparentBackground) {
            // done in 'apply_fog' otherwise
            src.rgb *= src.a;
        }
        dst = (1.0 - dst.a) * src + dst; // standard blending

        // break if the color is opaque enough
        if (dst.a > 0.95)
            break;

        pos += step;
    }

    return dst;
}

// TODO: support float texture for higher precision values???
// TODO: support clipping exclusion texture support

void main() {
    #if defined(dRenderVariant_emissive)
        discard;
    #else
        if (gl_FrontFacing)
            discard;

        vec3 rayDir = mix(normalize(vOrigPos - uCameraPosition), uCameraDir, uIsOrtho);
        vec3 step = rayDir * uStepScale;

        float boundingSphereNear = distance(vBoundingSphere.xyz, uCameraPosition) - vBoundingSphere.w;
        float d = max(uNear, boundingSphereNear) - mix(0.0, distance(vOrigPos, uCameraPosition), uIsOrtho);
        vec3 start = mix(uCameraPosition, vOrigPos, uIsOrtho) + (d * rayDir);
        gl_FragColor = raymarch(start, step, rayDir);

        float fragmentDepth = calcDepth((uModelView * vec4(start, 1.0)).xyz);
        float preFogAlpha = clamp(preFogAlphaBlended, 0.0, 1.0);
        #include wboit_write
    #endif
}
`;var uG=`
precision highp float;
precision highp int;

#include common
#include common_vert_params

attribute vec3 aPosition;
attribute vec2 aUv;
attribute mat4 aTransform;
attribute float aInstance;

varying vec2 vUv;
varying float vInstance;

void main() {
    #include assign_position

    vUv = aUv;
    vInstance = aInstance;
}
`;var dG=`
precision highp float;
precision highp int;

#include common
#include read_from_texture
#include common_frag_params
#include common_clip

uniform vec2 uImageTexDim;
uniform sampler2D tImageTex;
uniform sampler2D tGroupTex;

uniform vec2 uMarkerTexDim;
uniform sampler2D tMarker;

varying vec2 vUv;
varying float vInstance;

#if defined(dInterpolation_catmulrom) || defined(dInterpolation_mitchell) || defined(dInterpolation_bspline)
    #define dInterpolation_cubic
#endif

#if defined(dInterpolation_cubic)
    #if defined(dInterpolation_catmulrom) || defined(dInterpolation_mitchell)
        #if defined(dInterpolation_catmulrom)
            const float B = 0.0;
            const float C = 0.5;
        #elif defined(dInterpolation_mitchell)
            const float B = 0.333;
            const float C = 0.333;
        #endif

        float cubicFilter(float x){
            float f = x;
            if (f < 0.0) {
                f = -f;
            }
            if (f < 1.0) {
                return ((12.0 - 9.0 * B - 6.0 * C) * (f * f * f) +
                    (-18.0 + 12.0 * B + 6.0 * C) * (f * f) +
                    (6.0 - 2.0 * B)) / 6.0;
            }else if (f >= 1.0 && f < 2.0){
                return ((-B - 6.0 * C) * ( f * f * f)
                    + (6.0 * B + 30.0 * C) * (f * f) +
                    (-(12.0 * B) - 48.0 * C) * f +
                    8.0 * B + 24.0 * C) / 6.0;
            }else{
                return 0.0;
            }
        }
    #elif defined(dInterpolation_bspline)
        float cubicFilter(float x) {
            float f = x;
            if (f < 0.0) {
                f = -f;
            }
            if (f >= 0.0 && f <= 1.0){
                return (2.0 / 3.0) + (0.5) * (f * f * f) - (f * f);
            } else if (f > 1.0 && f <= 2.0) {
                return 1.0 / 6.0 * pow((2.0 - f), 3.0);
            }
            return 1.0;
        }
    #endif

    vec4 biCubic(sampler2D tex, vec2 texCoord) {
        vec2 texelSize = 1.0 / uImageTexDim;
        texCoord -= texelSize / 2.0;
        vec4 nSum = vec4(0.0);
        float nDenom = 0.0;
        vec2 cell = fract(texCoord * uImageTexDim);
        for (float m = -1.0; m <= 2.0; ++m) {
            for (float n = -1.0; n <= 2.0; ++n) {
                vec4 vecData = texture2D(tex, texCoord + texelSize * vec2(m, n));
                float c = abs(cubicFilter(m - cell.x) * cubicFilter(-n + cell.y));
                nSum += vecData * c;
                nDenom += c;
            }
        }
        return nSum / nDenom;
    }
#endif

void main() {
    #include fade_lod
    #include clip_pixel

    #if defined(dInterpolation_cubic)
        vec4 imageData = biCubic(tImageTex, vUv);
    #else
        vec4 imageData = texture2D(tImageTex, vUv);
    #endif
    imageData.a = clamp(imageData.a, 0.0, 1.0);
    if (imageData.a > 0.9) imageData.a = 1.0;

    imageData.a *= uAlpha;
    if (imageData.a < 0.05)
        discard;

    float fragmentDepth = gl_FragCoord.z;

    if ((uRenderMask == MaskOpaque && imageData.a < 1.0) ||
        (uRenderMask == MaskTransparent && imageData.a == 1.0)
    ) {
        discard;
    }

    #if defined(dRenderVariant_pick)
        if (imageData.a < 0.3)
            discard;
        #ifdef requiredDrawBuffers
            gl_FragColor = vec4(packIntToRGB(float(uObjectId)), 1.0);
            gl_FragData[1] = vec4(packIntToRGB(vInstance), 1.0);
            gl_FragData[2] = vec4(texture2D(tGroupTex, vUv).rgb, 1.0);
            gl_FragData[3] = packDepthToRGBA(gl_FragCoord.z);
        #else
            gl_FragColor = vColor;
            if (uPickType == 1) {
                gl_FragColor = vec4(packIntToRGB(float(uObjectId)), 1.0);
            } else if (uPickType == 2) {
                gl_FragColor = vec4(packIntToRGB(vInstance), 1.0);
            } else {
                gl_FragColor = vec4(texture2D(tGroupTex, vUv).rgb, 1.0);
            }
        #endif
    #elif defined(dRenderVariant_depth)
        if (imageData.a < 0.05)
            discard;
        gl_FragColor = packDepthToRGBA(gl_FragCoord.z);
    #elif defined(dRenderVariant_marking)
        float marker = uMarker;
        if (uMarker == -1.0) {
            float group = unpackRGBToInt(texture2D(tGroupTex, vUv).rgb);
            marker = readFromTexture(tMarker, vInstance * float(uGroupCount) + group, uMarkerTexDim).a;
            marker = floor(marker * 255.0 + 0.5); // rounding required to work on some cards on win
        }
        if (uMarkingType == 1) {
            if (marker > 0.0 || imageData.a < 0.05)
                discard;
            gl_FragColor = packDepthToRGBA(gl_FragCoord.z);
        } else {
            if (marker == 0.0 || imageData.a < 0.05)
                discard;
            float depthTest = 1.0;
            if (uMarkingDepthTest) {
                depthTest = (fragmentDepth >= getDepthPacked(gl_FragCoord.xy / uDrawingBufferSize)) ? 1.0 : 0.0;
            }
            bool isHighlight = intMod(marker, 2.0) > 0.1;
            gl_FragColor = vec4(0.0, depthTest, isHighlight ? 1.0 : 0.0, 1.0);
        }
    #elif defined(dRenderVariant_emissive)
        gl_FragColor = vec4(0.0);
    #elif defined(dRenderVariant_color)
        gl_FragColor = imageData;

        float marker = uMarker;
        if (uMarker == -1.0) {
            float group = unpackRGBToInt(texture2D(tGroupTex, vUv).rgb);
            marker = readFromTexture(tMarker, vInstance * float(uGroupCount) + group, uMarkerTexDim).a;
            marker = floor(marker * 255.0 + 0.5); // rounding required to work on some cards on win
        }

        #include apply_marker_color
        #include apply_fog
        #include wboit_write
        #include dpoit_write
    #endif
}
`;var hG=bo(),kce={apply_fog:g5,apply_interior_color:y5,apply_light_color:v5,apply_marker_color:b5,assign_clipping_varying:x5,assign_color_varying:S5,assign_group:C5,assign_marker_varying:T5,assign_material_color:w5,assign_position:_5,assign_size:P5,check_picking_alpha:E5,check_transparency:I5,clip_instance:D5,clip_pixel:A5,color_frag_params:k5,color_vert_params:M5,common_clip:R5,common_frag_params:L5,common_vert_params:B5,common:O5,fade_lod:F5,float_to_rgba:N5,light_frag_params:V5,matrix_scale:z5,normal_frag_params:U5,read_from_texture:G5,rgba_to_float:j5,size_vert_params:H5,texture3d_from_1d_trilinear:q5,texture3d_from_2d_linear:W5,texture3d_from_2d_nearest:X5,wboit_write:Y5,dpoit_write:Q5},Mce=/^(?!\/\/)\s*#include\s+(\S+)/gm,Rce=/#pragma unroll_loop_start\s+for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<\s*(\d+)\s*;\s*\+\+i\s*\s*\)\s*{([\s\S]+?)}\s+#pragma unroll_loop_end/g,Lce=/[ \t]*\/\/.*\n/g,Bce=/[ \t]*\/\*[\s\S]*?\*\//g,Oce=/\n{2,}/g;function mG(t){return t.replace(Mce,(e,r)=>{let n=kce[r];if(!n)throw new Error(`empty chunk, '${r}'`);return n}).trim().replace(Lce,`
`).replace(Bce,`
`).replace(Oce,`
`)}function Fce(t){return t.replace(Rce,Nce)}function Nce(t,e,r,n){let o="";for(let i=parseInt(e);i<parseInt(r);++i)o+=n.replace(/\[\s*i\s*\]/g,`[${i}]`).replace(/UNROLLED_LOOP_INDEX/g,`${i}`);return o}function Vce(t,e){return e.dLightCount&&(t=t.replace(/dLightCount/g,`${e.dLightCount.ref.value}`)),e.dClipObjectCount&&(t=t.replace(/dClipObjectCount/g,`${e.dClipObjectCount.ref.value}`)),t}function pG(t,e){return Fce(Vce(t,e))}function Qt(t,e,r,n={},o={},i){return{id:hG(),name:t,vert:mG(e),frag:mG(r),extensions:n,outTypes:o,ignoreDefine:i}}function Hx(t,e,r){var n;if(e.startsWith("color")){if(t==="dLightCount")return!!(!((n=r.dIgnoreLight)===null||n===void 0)&&n.ref.value)}else{let o=["dColorType","dUsePalette","dLightCount","dXrayShaded","dOverpaintType","dOverpaint","dSubstanceType","dSubstance","dColorMarker"];return e!=="emissive"&&o.push("dEmissiveType","dEmissive"),o.includes(t)}return!1}function VT(t,e,r){return t==="dLightCount"?!0:Hx(t,e,r)}var gG=Qt("points",K5,$5,{drawBuffers:"optional"},{},VT),yG=Qt("spheres",Z5,J5,{fragDepth:"required",drawBuffers:"optional"},{},Hx),vG=Qt("cylinders",eG,tG,{fragDepth:"required",drawBuffers:"optional"},{},Hx),bG=Qt("text",rG,nG,{drawBuffers:"optional"},{},VT),xG=Qt("lines",oG,iG,{drawBuffers:"optional"},{},VT),zT=Qt("mesh",aG,sG,{drawBuffers:"optional"},{},Hx),SG=Qt("direct-volume",lG,cG,{fragDepth:"optional",drawBuffers:"optional"},{},Hx),CG=Qt("image",uG,dG,{drawBuffers:"optional"},{},VT);function fG(t,e){var r;if(t===void 0)return"";let n=((r=t.dRenderVariant)===null||r===void 0?void 0:r.ref.value)||"",o=[];for(let i in t){if(e?.(i,n,t))continue;let s=t[i].ref.value;s!==void 0&&(typeof s=="string"?o.push(`#define ${i}_${s}`):typeof s=="number"?o.push(`#define ${i} ${s}`):typeof s=="boolean"?s&&o.push(`#define ${i}`):ur(s))}return o.join(`
`)+`
`}function zce(t,e){let r=[];if(e.drawBuffers){if(t.drawBuffers)r.push("#define requiredDrawBuffers");else if(e.drawBuffers==="required")throw new Error("required 'GL_EXT_draw_buffers' extension not available")}if(e.multiDraw){if(t.multiDraw)r.push("#extension GL_ANGLE_multi_draw : require"),r.push("#define enabledMultiDraw");else if(e.multiDraw==="required")throw new Error("required 'GL_ANGLE_multi_draw' extension not available")}return r.join(`
`)+`
`}function Uce(t,e){let r=["#extension GL_OES_standard_derivatives : enable"];if(e.fragDepth){if(t.fragDepth)r.push("#extension GL_EXT_frag_depth : enable"),r.push("#define enabledFragDepth");else if(e.fragDepth==="required")throw new Error("required 'GL_EXT_frag_depth' extension not available")}if(e.drawBuffers){if(t.drawBuffers)r.push("#extension GL_EXT_draw_buffers : require"),r.push("#define requiredDrawBuffers"),r.push("#define gl_FragColor gl_FragData[0]");else if(e.drawBuffers==="required")throw new Error("required 'GL_EXT_draw_buffers' extension not available")}if(e.shaderTextureLod){if(t.shaderTextureLod)r.push("#extension GL_EXT_shader_texture_lod : enable"),r.push("#define enabledShaderTextureLod");else if(e.shaderTextureLod==="required")throw new Error("required 'GL_EXT_shader_texture_lod' extension not available")}return t.depthTexture&&r.push("#define depthTextureSupport"),r.join(`
`)+`
`}var Gce=`
#define attribute in
#define varying out
#define texture2D texture
`,jce=`
#define varying in
#define texture2D texture
#define textureCube texture
#define texture2DLodEXT textureLod
#define textureCubeLodEXT textureLod

#define gl_FragColor out_FragData0
#define gl_FragDepthEXT gl_FragDepth

#define depthTextureSupport
`;function Hce(t,e){let r=["#version 300 es"];if(e.drawBuffers&&t.drawBuffers&&r.push("#define requiredDrawBuffers"),e.multiDraw){if(t.multiDraw)r.push("#extension GL_ANGLE_multi_draw : require"),r.push("#define enabledMultiDraw");else if(e.multiDraw==="required")throw new Error("required 'GL_ANGLE_multi_draw' extension not available")}if(e.clipCullDistance){if(t.clipCullDistance)r.push("#extension GL_ANGLE_clip_cull_distance : enable"),r.push("#define enabledClipCullDistance");else if(e.clipCullDistance==="required")throw new Error("required 'GL_ANGLE_clip_cull_distance' extension not available")}if(e.conservativeDepth){if(t.conservativeDepth)r.push("#extension GL_EXT_conservative_depth : enable"),r.push("#define enabledConservativeDepth");else if(e.conservativeDepth==="required")throw new Error("required 'GL_EXT_conservative_depth' extension not available")}return t.noNonInstancedActiveAttribs&&r.push("#define noNonInstancedActiveAttribs"),r.push(Gce),r.join(`
`)+`
`}function qce(t,e,r,n){let o=["#version 300 es",`layout(location = 0) out highp ${n[0]||"vec4"} out_FragData0;`];if(r.fragDepth&&e.fragDepth&&o.push("#define enabledFragDepth"),r.drawBuffers&&e.drawBuffers){o.push("#define requiredDrawBuffers");let i=t.getParameter(t.MAX_DRAW_BUFFERS);for(let a=1,s=i;a<s;++a)o.push(`layout(location = ${a}) out highp ${n[a]||"vec4"} out_FragData${a};`)}return r.shaderTextureLod&&e.shaderTextureLod&&o.push("#define enabledShaderTextureLod"),o.push(jce),o.join(`
`)+`
`}function Wce(t){return t.replace(/gl_FragData\[([0-9]+)\]/g,"out_FragData$1")}function TG(t,e,r,n){let o=fG(r,n.ignoreDefine),i=fG(r,n.ignoreDefine),a=ct(t)?Hce(e,n.extensions):zce(e,n.extensions),s=ct(t)?qce(t,e,n.extensions,n.outTypes):Uce(e,n.extensions),l=ct(t)?Wce(n.frag):n.frag;return{id:hG(),name:n.name,vert:`${a}${o}${pG(n.vert,r)}`,frag:`${s}${i}${pG(l,r)}`,extensions:n.extensions,outTypes:n.outTypes}}function _G(t,e){switch(e){case"b":case"b[]":return t.BOOL;case"f":case"f[]":return t.FLOAT;case"i":case"i[]":return t.INT;case"v2":case"v2[]":return t.FLOAT_VEC2;case"v3":case"v3[]":return t.FLOAT_VEC3;case"v4":case"v4[]":return t.FLOAT_VEC4;case"iv2":case"iv2[]":return t.INT_VEC2;case"iv3":case"iv3[]":return t.INT_VEC3;case"iv4":case"iv4[]":return t.INT_VEC4;case"m3":case"m3[]":return t.FLOAT_MAT3;case"m4":case"m4[]":return t.FLOAT_MAT4;default:console.error(`unknown uniform kind '${e}'`)}}function PG(t){return t.endsWith("[]")}function Xce(t,e,r){t.uniform1f(e,r)}function Yce(t,e,r){t.uniform1fv(e,r)}function Qce(t,e,r){t.uniform1i(e,r)}function Kce(t,e,r){t.uniform1iv(e,r)}function $ce(t,e,r){t.uniform2fv(e,r)}function Zce(t,e,r){t.uniform3fv(e,r)}function Jce(t,e,r){t.uniform4fv(e,r)}function eue(t,e,r){t.uniform2iv(e,r)}function tue(t,e,r){t.uniform3iv(e,r)}function rue(t,e,r){t.uniform4iv(e,r)}function nue(t,e,r){t.uniformMatrix3fv(e,!1,r)}function oue(t,e,r){t.uniformMatrix4fv(e,!1,r)}function wG(t){switch(t){case"f":return Xce;case"f[]":return Yce;case"i":case"t":case"b":return Qce;case"i[]":case"t[]":case"b[]":return Kce;case"v2":case"v2[]":return $ce;case"v3":case"v3[]":return Zce;case"v4":case"v4[]":return Jce;case"iv2":case"iv2[]":return eue;case"iv3":case"iv3[]":return tue;case"iv4":case"iv4[]":return rue;case"m3":case"m3[]":return nue;case"m4":case"m4[]":return oue}}function EG(t){let e={};return Object.keys(t).forEach(r=>{let n=t[r];n.type==="uniform"?e[r]=wG(n.kind):n.type==="texture"&&(e[r]=wG("t"))}),e}function IG(t){let e={};return Object.keys(t).forEach(r=>{e[r]=C.create($s(t[r].ref.value))}),e}var iue=bo();function aue(t,e){switch(e){case"static":return t.STATIC_DRAW;case"dynamic":return t.DYNAMIC_DRAW;case"stream":return t.STREAM_DRAW}}function sue(t,e){if(e instanceof Uint8Array)return t.UNSIGNED_BYTE;if(e instanceof Int8Array)return t.BYTE;if(e instanceof Uint16Array)return t.UNSIGNED_SHORT;if(e instanceof Int16Array)return t.SHORT;if(e instanceof Uint32Array)return t.UNSIGNED_INT;if(e instanceof Int32Array)return t.INT;if(e instanceof Float32Array)return t.FLOAT;ur(e)}function lue(t,e){switch(e){case"attribute":return t.ARRAY_BUFFER;case"elements":return t.ELEMENT_ARRAY_BUFFER;case"uniform":if(ct(t))return t.UNIFORM_BUFFER;throw new Error("WebGL2 is required for uniform buffers")}}function UT(t){let e=t.createBuffer();if(e===null)throw new Error("Could not create WebGL buffer");return e}function DG(t,e,r,n){let o=UT(t),i=aue(t,r),a=lue(t,n),s=sue(t,e),l=e.BYTES_PER_ELEMENT,c=e.length;function u(m){t.bindBuffer(a,o),t.bufferData(a,m,i)}u(e);let d=!1;return{id:iue(),_usageHint:i,_bufferType:a,_dataType:s,_bpe:l,length:c,getBuffer:()=>o,updateData:u,updateSubData:(m,p,h)=>{t.bindBuffer(a,o),h-p===m.length?t.bufferSubData(a,0,m):t.bufferSubData(a,p*l,m.subarray(p,p+h))},reset:()=>{o=UT(t),u(e)},destroy:()=>{d||(t.deleteBuffer(o),d=!0)}}}function AG(t,e,r){switch(e){case"float32":switch(r){case 1:return t.FLOAT;case 2:return t.FLOAT_VEC2;case 3:return t.FLOAT_VEC3;case 4:return t.FLOAT_VEC4;case 16:return t.FLOAT_MAT4}default:ur(e)}}function kG(t,e,r,n,o,i,a="static"){let{instancedArrays:s}=r,l=DG(t,n,a,"attribute"),{_bufferType:c,_dataType:u,_bpe:d}=l;return U(w({},l),{divisor:i,bind:m=>{if(t.bindBuffer(c,l.getBuffer()),o===16)for(let p=0;p<4;++p)e.enableVertexAttrib(m+p),t.vertexAttribPointer(m+p,4,u,!1,4*4*d,p*4*d),s.vertexAttribDivisor(m+p,i);else e.enableVertexAttrib(m),t.vertexAttribPointer(m,o,u,!1,0,0),s.vertexAttribDivisor(m,i)},changeOffset:(m,p)=>{let h=p*d*o;if(t.bindBuffer(c,l.getBuffer()),o===16)for(let f=0;f<4;++f)t.vertexAttribPointer(m+f,4,u,!1,4*4*d,f*4*d+h);else t.vertexAttribPointer(m,o,u,!1,0,h)}})}function MG(t,e,r){let n=[];return Object.keys(e).forEach(o=>{let i=e[o];i.type==="attribute"&&(n[n.length]=[o,t.resources.attribute(r[o].ref.value,i.itemSize,i.divisor)])}),n}function RG(t,e,r="static"){let n=DG(t,e,r,"elements");return U(w({},n),{bind:()=>{t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,n.getBuffer())}})}var cue=bo();function uue(t,e,r){let n={};return Object.keys(r).forEach(o=>{let i=r[o];if(i.type==="attribute"){let a=t.getAttribLocation(e,o);n[o]=a}else if(i.type==="uniform"){let a=t.getUniformLocation(e,o);a===null&&PG(i.kind)&&(a=t.getUniformLocation(e,o+"[0]")),n[o]=a}else if(i.type==="texture"){let a=t.getUniformLocation(e,o);n[o]=a}}),n}function due(t,e,r){let n=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES);for(let o=0;o<n;++o){let i=t.getActiveAttrib(e,o);if(i){let{name:a,type:s}=i;if(a.startsWith("__activeAttribute")||a==="gl_InstanceID"||a==="gl_VertexID"||a==="gl_DrawID")continue;let l=r[a];if(l===void 0)throw new Error(`missing 'uniform' or 'texture' with name '${a}' in schema`);if(l.type!=="attribute")throw new Error(`'${a}' must be of type 'attribute' but is '${l.type}'`);let c=AG(t,l.kind,l.itemSize);if(c!==s)throw new Error(`unexpected attribute type '${c}' for ${a}, expected '${s}'`)}}}function mue(t,e,r){let n=t.getProgramParameter(e,t.ACTIVE_UNIFORMS);for(let o=0;o<n;++o){let i=t.getActiveUniform(e,o);if(i){let{name:a,type:s}=i;if(a.startsWith("__activeUniform")||a==="gl_InstanceID"||a==="gl_VertexID"||a==="gl_DrawID")continue;let l=a.replace(/[[0-9]+\]$/,""),c=r[l];if(c===void 0)throw new Error(`missing 'uniform' or 'texture' with name '${a}' in schema`);if(c.type==="uniform"){if(_G(t,c.kind)!==s)throw new Error(`unexpected uniform type for ${a}`)}else if(c.type==="texture"){if(c.kind==="image-float32"||c.kind==="image-uint8"){if(s!==t.SAMPLER_2D)throw new Error(`unexpected sampler type for '${a}'`)}else if(c.kind==="volume-float32"||c.kind==="volume-uint8")if(ct(t)){if(s!==t.SAMPLER_3D)throw new Error(`unexpected sampler type for '${a}'`)}else throw new Error("WebGL2 is required to use SAMPLER_3D")}else throw new Error(`'${a}' must be of type 'uniform' or 'texture' but is '${c.type}'`)}}}function pue(t,e){if(!t.getProgramParameter(e,t.LINK_STATUS))throw new Error(`Could not compile WebGL program. 

${t.getProgramInfoLog(e)}`)}function GT(t){let e=t.createProgram();if(e===null)throw new Error("Could not create WebGL program");return e}function LG(t,e,r,n,o){let{defineValues:i,shaderCode:a,schema:s}=o,l=GT(t),c=cue(),u=TG(t,r,i,a),d=n("vert",u.vert),m=n("frag",u.frag),p,h;function f(){d.attach(l),m.attach(l),t.linkProgram(l),ht&&pue(t,l),p=uue(t,l,s),h=EG(s),ht&&(due(t,l,s),mue(t,l,s))}f();let b=!1;return{id:c,use:()=>{e.currentProgramId=c,t.useProgram(l)},setUniforms:v=>{for(let x=0,S=v.length;x<S;++x){let[T,E]=v[x];if(E){let _=p[T];_!==null&&h[T](t,_,E.ref.value)}}},uniform:(v,x)=>{let S=p[v];S!==null&&h[v](t,S,x)},bindAttributes:v=>{e.clearVertexAttribsState();for(let x=0,S=v.length;x<S;++x){let[T,E]=v[x],_=p[T];_!==-1&&E.bind(_)}e.disableUnusedVertexAttribs()},offsetAttributes:(v,x)=>{for(let S=0,T=v.length;S<T;++S){let[E,_]=v[S],D=p[E];D!==-1&&_.changeOffset(D,x)}},bindTextures:(v,x)=>{for(let S=0,T=v.length;S<T;++S){let[E,_]=v[S],D=p[E];D!=null&&(_.bind(S+x),h[E](t,D,S+x))}},reset:()=>{l=GT(t),f()},destroy:()=>{b||(d.destroy(),m.destroy(),t.deleteProgram(l),b=!0)}}}var fue=bo();function hue(t){let e=t.split(`
`);for(let r=0;r<e.length;++r)e[r]=r+1+": "+e[r];return e.join(`
`)}function qx(t,e){let{type:r,source:n}=e,o=t.createShader(r==="vert"?t.VERTEX_SHADER:t.FRAGMENT_SHADER);if(o===null)throw new Error(`Error creating ${r} shader`);if(t.shaderSource(o,n),t.compileShader(o),ht&&t.getShaderParameter(o,t.COMPILE_STATUS)===!1)throw console.warn(`'${r}' shader info log '${t.getShaderInfoLog(o)}'
${hue(n)}`),new Error(`Error compiling ${r} shader`);return o}function BG(t,e){let r=qx(t,e);return{id:fue(),attach:n=>{t.attachShader(n,r)},reset:()=>{r=qx(t,e)},destroy:()=>{t.deleteShader(r)}}}function gue(t,e=0){return{value:t,usageCount:e}}function yue(t){return{free:()=>{t.usageCount-=1},value:t.value}}function OA(t,e,r){let n=new Map;return{get:o=>{let i=t(o),a=n.get(i);return a||(a=gue(e(o)),n.set(i,a)),a.usageCount+=1,yue(a)},clear:()=>{n.forEach((o,i)=>{o.usageCount<=0&&(o.usageCount<0&&console.warn("Reference usageCount below zero."),r(o.value),n.delete(i))})},get count(){return n.size},dispose:()=>{n.forEach(o=>r(o.value)),n.clear()}}}var vue=bo();function bue(t,e){switch(e){case"depth16":return t.DEPTH_COMPONENT16;case"stencil8":return t.STENCIL_INDEX8;case"rgba4":return t.RGBA4;case"depth-stencil":return t.DEPTH_STENCIL;case"depth24":if(ct(t))return t.DEPTH_COMPONENT24;throw new Error("WebGL2 needed for `depth24` renderbuffer format");case"depth32f":if(ct(t))return t.DEPTH_COMPONENT32F;throw new Error("WebGL2 needed for `depth32f` renderbuffer format");case"depth24-stencil8":if(ct(t))return t.DEPTH24_STENCIL8;throw new Error("WebGL2 needed for `depth24-stencil8` renderbuffer format");case"depth32f-stencil8":if(ct(t))return t.DEPTH32F_STENCIL8;throw new Error("WebGL2 needed for `depth32f-stencil8` renderbuffer format")}}function xue(t,e){switch(e){case"depth":return t.DEPTH_ATTACHMENT;case"stencil":return t.STENCIL_ATTACHMENT;case"depth-stencil":return t.DEPTH_STENCIL_ATTACHMENT;case"color0":return t.COLOR_ATTACHMENT0}}function OG(t){let e=t.createRenderbuffer();if(e===null)throw new Error("Could not create WebGL renderbuffer");return e}function FG(t,e,r,n,o){let i=OG(t),a=()=>t.bindRenderbuffer(t.RENDERBUFFER,i),s=bue(t,e),l=xue(t,r);function c(){a(),t.renderbufferStorage(t.RENDERBUFFER,s,n,o)}c();let u=!1;return{id:vue(),bind:a,attachFramebuffer:d=>{d.bind(),a(),t.framebufferRenderbuffer(t.FRAMEBUFFER,l,t.RENDERBUFFER,i),ht&&Eg(t)},detachFramebuffer:d=>{d.bind(),a(),t.framebufferRenderbuffer(t.FRAMEBUFFER,l,t.RENDERBUFFER,null),ht&&Eg(t)},setSize:(d,m)=>{n=d,o=m,c()},reset:()=>{i=OG(t),c()},destroy:()=>{u||(t.deleteRenderbuffer(i),u=!0)}}}var Sue=bo();function NG(t){let{vertexArrayObject:e}=t;if(!e)throw new Error("VertexArrayObject not supported");let r=e.createVertexArray();if(!r)throw new Error("Could not create WebGL vertex array");return r}function VG(t){let{vertexArrayObject:e}=t;if(e===null)throw new Error("VertexArrayObject not supported");return e}function zG(t,e,r,n,o){let i=Sue(),a=NG(e),s=VG(e);function l(){s.bindVertexArray(a),o&&o.bind(),r.bindAttributes(n),s.bindVertexArray(null)}l();let c=!1;return{id:i,bind:()=>{s.bindVertexArray(a)},update:l,reset:()=>{a=NG(e),s=VG(e),l()},destroy:()=>{c||(o&&(s.bindVertexArray(a),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null)),s.deleteVertexArray(a),c=!0)}}}function Cue(t){return typeof t=="boolean"?t?1:0:typeof t=="number"?t*1e4:wA(t)}function UG(t){return U(w({},t.value),{destroy:()=>{t.free()}})}function GG(t,e,r,n){let o={attribute:new Set,elements:new Set,framebuffer:new Set,program:new Set,renderbuffer:new Set,shader:new Set,texture:new Set,cubeTexture:new Set,vertexArray:new Set};function i(c,u){return o[c].add(u),r.resourceCounts[c]+=1,U(w({},u),{destroy:()=>{u.destroy(),o[c].delete(u),r.resourceCounts[c]-=1}})}let a=OA(c=>JSON.stringify(c),c=>i("shader",BG(t,c)),c=>{c.destroy()});function s(c,u){return UG(a.get({type:c,source:u}))}let l=OA(c=>{var u;let d=[c.shaderCode.id],m=((u=c.defineValues.dRenderVariant)===null||u===void 0?void 0:u.ref.value)||"";return Object.keys(c.defineValues).forEach(p=>{var h,f;!((f=(h=c.shaderCode).ignoreDefine)===null||f===void 0)&&f.call(h,p,m,c.defineValues)||d.push(wA(p),Cue(c.defineValues[p].ref.value))}),Ai(d).toString()},c=>i("program",LG(t,e,n,s,c)),c=>{c.destroy()});return{attribute:(c,u,d,m)=>i("attribute",kG(t,e,n,c,u,d,m)),elements:(c,u)=>i("elements",RG(t,c,u)),framebuffer:()=>i("framebuffer",NU(t)),program:(c,u,d)=>UG(l.get({defineValues:c,shaderCode:u,schema:d})),renderbuffer:(c,u,d,m)=>i("renderbuffer",FG(t,c,u,d,m)),shader:s,texture:(c,u,d,m)=>i("texture",jG(t,n,c,u,d,m)),cubeTexture:(c,u,d)=>i("cubeTexture",HG(t,c,u,d)),vertexArray:(c,u,d)=>i("vertexArray",zG(t,n,c,u,d)),getByteCounts:()=>{let c=0;o.texture.forEach(m=>{c+=m.getByteCount()}),o.cubeTexture.forEach(m=>{c+=m.getByteCount()});let u=0;o.attribute.forEach(m=>{u+=m.length*4});let d=0;return o.elements.forEach(m=>{d+=m.length*4}),{texture:c,attribute:u,elements:d}},reset:()=>{o.attribute.forEach(c=>c.reset()),o.elements.forEach(c=>c.reset()),o.framebuffer.forEach(c=>c.reset()),o.renderbuffer.forEach(c=>c.reset()),o.shader.forEach(c=>c.reset()),o.program.forEach(c=>c.reset()),o.vertexArray.forEach(c=>c.reset()),o.texture.forEach(c=>c.reset())},destroy:()=>{o.attribute.forEach(c=>c.destroy()),o.elements.forEach(c=>c.destroy()),o.framebuffer.forEach(c=>c.destroy()),o.renderbuffer.forEach(c=>c.destroy()),o.shader.forEach(c=>c.destroy()),o.program.forEach(c=>c.destroy()),o.vertexArray.forEach(c=>c.destroy()),o.texture.forEach(c=>c.destroy()),a.clear(),l.clear()}}}var qG=bo();function WG(t,e,r,n,o=!0,i="uint8",a="nearest",s="rgba"){if(s==="alpha"&&!ct(t))throw new Error("cannot render to alpha format in webgl1");let l=e.framebuffer(),c=i==="fp16"?e.texture("image-float16",s,"fp16",a):i==="float32"?e.texture("image-float32",s,"float",a):e.texture("image-uint8",s,"ubyte",a),u=o?ct(t)?e.renderbuffer("depth32f","depth",r,n):e.renderbuffer("depth16","depth",r,n):null;function d(){c.define(r,n),c.attachFramebuffer(l,"color0"),u&&u.attachFramebuffer(l)}d();let m=!1;return{id:qG(),texture:c,framebuffer:l,depthRenderbuffer:u,getWidth:()=>r,getHeight:()=>n,bind:()=>{l.bind()},setSize:(p,h)=>{r===p&&n===h||(r=p,n=h,c.define(r,n),u&&u.setSize(r,n))},reset:()=>{d()},destroy:()=>{m||(c.destroy(),l.destroy(),u&&u.destroy(),m=!0)}}}function XG(t){return{id:qG(),texture:un(t),framebuffer:VU(),depthRenderbuffer:null,getWidth:()=>0,getHeight:()=>0,bind:()=>{t.bindFramebuffer(t.FRAMEBUFFER,null)},setSize:()=>{},reset:()=>{},destroy:()=>{}}}function Tue(t,e,r){return t-=t/r,t+=e/r,t}var jT=class{add(e,r){let n=this.avgs.get(e)||r;return n=Tue(n,r,this.count),this.avgs.set(e,n),n}get(e){return this.avgs.get(e)}stats(){return Object.fromEntries(this.avgs.entries())}clear(){this.avgs.clear()}constructor(e){this.count=e,this.avgs=new Map}};function wue(t){t.calls.drawInstanced=0,t.calls.drawInstancedBase=0,t.calls.multiDrawInstancedBase=0,t.calls.counts=0,t.culled.lod=0,t.culled.frustum=0,t.culled.occlusion=0}function _ue(t){return t.disjointTimerQuery?t.disjointTimerQuery.createQuery():null}function YG(t,e,r,n){var o;let i=e.disjointTimerQuery,a=(o=n?.avgCount)!==null&&o!==void 0?o:30,s=new Map,l=new Map,c=[],u=new jT(a),d=new jT(a),m=[],p=null,h=!1,f=()=>{i&&(s.forEach((v,x)=>{i.deleteQuery(x)}),l.clear(),c.length=0,u.clear(),d.clear(),m=[],p=null,h=!1)},b=()=>{if(!i)return;let v=_ue(e);v&&(i.beginQuery(i.TIME_ELAPSED,v),l.forEach((x,S)=>{x.queries.push(v)}),s.set(v,{refCount:l.size}),p=v)};return{resolve:()=>{let v=[];if(!i||!m.length)return v;s.forEach((S,T)=>{if(S.timeElapsed!==void 0)return;let E=i.getQueryParameter(T,i.QUERY_RESULT_AVAILABLE),_=t.getParameter(i.GPU_DISJOINT);if(E&&!_){let D=i.getQueryParameter(T,i.QUERY_RESULT);S.timeElapsed=D}(E||_)&&i.deleteQuery(T)});let x=[];for(let S of m)if(S.queries.every(T=>{var E;return((E=s.get(T))===null||E===void 0?void 0:E.timeElapsed)!==void 0})){let T=0;for(let E of S.queries){let _=s.get(E);T+=_.timeElapsed,_.refCount-=1}if(S.timeElapsed=T,S.root){let E=[],_=(P,A)=>{for(let I of P){let k=I.timeElapsed,M=I.cpu.end-I.cpu.start,R={label:I.label,gpuElapsed:k,gpuAvg:u.add(I.label,k),cpuElapsed:M,cpuAvg:d.add(I.label,M),children:[],calls:I.calls};A.push(R),_(I.children,R.children)}};_(S.children,E);let D=S.cpu.end-S.cpu.start;v.push({label:S.label,gpuElapsed:T,gpuAvg:u.add(S.label,T),cpuElapsed:D,cpuAvg:d.add(S.label,D),children:E,calls:S.calls})}}else x.push(S);return m=x,s.forEach((S,T)=>{S.refCount===0&&s.delete(T)}),v},mark:(v,x=!1)=>{if(!i)return;if(l.has(v))throw new Error(`Timer mark for '${v}' already exists`);p!==null&&i.endQuery(i.TIME_ELAPSED);let S={label:v,queries:[],children:[],root:p===null,cpu:{start:ko(),end:-1},captureStats:x};if(l.set(v,S),c.length&&c[c.length-1].children.push(S),c.push(S),x){if(h)throw new Error("Already capturing stats");wue(r),h=!0}b()},markEnd:v=>{var x;if(!i)return;let S=l.get(v);if(!S)throw new Error(`Timer mark for '${v}' does not exist`);if(((x=c.pop())===null||x===void 0?void 0:x.label)!==v)throw new Error(`Timer mark for '${v}' has pending nested mark`);i.endQuery(i.TIME_ELAPSED),l.delete(v),S.cpu.end=ko(),S.captureStats&&(S.calls=w({},r.calls),h=!1),m.push(S),l.size>0?b():p=null},stats:()=>({gpu:u.stats(),cpu:d.stats()}),formatedStats:()=>{let v={},x=u.stats(),S=d.stats();for(let T of Object.keys(x)){let E=`${(x[T]/1e3/1e3).toFixed(2)}`,_=`${S[T].toFixed(2)}`;v[T]=`${E} ms | CPU: ${_} ms`}return v},clear:f,destroy:()=>{f()}}}function Pue(t){let e=`${(t.gpuElapsed/1e3/1e3).toFixed(2)}`,r=`${(t.gpuAvg/1e3/1e3).toFixed(2)}`,n=`${t.cpuElapsed.toFixed(2)}`,o=`${t.cpuAvg.toFixed(2)}`;return`${t.label} ${e} ms (avg. ${r} ms) | CPU: ${n} ms (avg. ${o} ms)`}function FA(t){t.map(e=>{let r=Pue(e);e.children.length||e.calls?(console.groupCollapsed(r),e.calls&&console.log(e.calls),FA(e.children),console.groupEnd()):console.log(r)})}function KG(t,e){function r(o){try{return t.getContext(o,e)}catch{return null}}let n=(e?.preferWebGl1?null:r("webgl2"))||r("webgl")||r("experimental-webgl");return ht&&console.log(`isWebgl2: ${ct(n)}`),n}function VA(t,e){switch(e){case t.NO_ERROR:return"no error";case t.INVALID_ENUM:return"invalid enum";case t.INVALID_VALUE:return"invalid value";case t.INVALID_OPERATION:return"invalid operation";case t.INVALID_FRAMEBUFFER_OPERATION:return"invalid framebuffer operation";case t.OUT_OF_MEMORY:return"out of memory";case t.CONTEXT_LOST_WEBGL:return"context lost"}return"unknown error"}function zA(t){let e=t.getError();if(e!==t.NO_ERROR)throw new Error(`WebGL error: '${VA(t,e)}'`)}function Eue(t){let e=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS);for(let o=0;o<e;++o)t.activeTexture(t.TEXTURE0+o),t.bindTexture(t.TEXTURE_2D,null),t.bindTexture(t.TEXTURE_CUBE_MAP,null),ct(t)&&(t.bindTexture(t.TEXTURE_2D_ARRAY,null),t.bindTexture(t.TEXTURE_3D,null));let r=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,r);let n=t.getParameter(t.MAX_VERTEX_ATTRIBS);for(let o=0;o<n;++o)t.vertexAttribPointer(o,1,t.FLOAT,!1,0,0);t.bindBuffer(t.ARRAY_BUFFER,null),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),t.bindRenderbuffer(t.RENDERBUFFER,null),HT(t)}function HT(t){t.bindFramebuffer(t.FRAMEBUFFER,null)}var $G=new Uint8Array(1*4);function ZG(t,e,r){t.getSyncParameter(e,t.SYNC_STATUS)===t.SIGNALED?(t.deleteSync(e),r()):b0.setImmediate(ZG,t,e,r)}function JG(t,e){let r=t.fenceSync(t.SYNC_GPU_COMMANDS_COMPLETE,0);r?b0.setImmediate(ZG,t,r,e):(console.warn("Could not create a WebGLSync object"),t.readPixels(0,0,1,1,t.RGBA,t.UNSIGNED_BYTE,$G),e())}var QG=!1;function Iue(t){return new Promise(e=>{ct(t)?JG(t,e):(QG||(console.info("Sync object not supported in WebGL"),QG=!0),ej(t),e())})}function ej(t){t.bindFramebuffer(t.FRAMEBUFFER,null),t.readPixels(0,0,1,1,t.RGBA,t.UNSIGNED_BYTE,$G)}function NA(t,e,r,n,o,i){if(ht&&Eg(t),i instanceof Uint8Array)t.readPixels(e,r,n,o,t.RGBA,t.UNSIGNED_BYTE,i);else if(i instanceof Float32Array)t.readPixels(e,r,n,o,t.RGBA,t.FLOAT,i);else if(i instanceof Int32Array&&ct(t))t.readPixels(e,r,n,o,t.RGBA_INTEGER,t.INT,i);else throw new Error("unsupported readPixels buffer type");ht&&zA(t)}function Due(t,e){let r=t.drawingBufferWidth,n=t.drawingBufferHeight,o=new Uint8Array(r*n*4);return HT(t),e.viewport(0,0,r,n),NA(t,0,0,r,n,o),ip.flipY(ip.create(o,r,n))}function Aue(){return{resourceCounts:{attribute:0,elements:0,framebuffer:0,program:0,renderbuffer:0,shader:0,texture:0,cubeTexture:0,vertexArray:0},drawCount:0,instanceCount:0,instancedDrawCount:0,calls:{drawInstanced:0,drawInstancedBase:0,multiDrawInstancedBase:0,counts:0},culled:{lod:0,frustum:0,occlusion:0}}}function tj(t,e={}){let r=BA(t),n=h5(t,r),o=Aue(),i=GG(t,n,o,r),a=YG(t,r,o),s={maxTextureSize:t.getParameter(t.MAX_TEXTURE_SIZE),max3dTextureSize:ct(t)?t.getParameter(t.MAX_3D_TEXTURE_SIZE):0,maxRenderbufferSize:t.getParameter(t.MAX_RENDERBUFFER_SIZE),maxDrawBuffers:r.drawBuffers?t.getParameter(r.drawBuffers.MAX_DRAW_BUFFERS):0,maxTextureImageUnits:t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS)};if(s.maxVertexTextureImageUnits<8)throw new Error('Need "MAX_VERTEX_TEXTURE_IMAGE_UNITS" >= 8');let l=r.provokingVertex;l?.provokingVertex(l.FIRST_VERTEX_CONVENTION);let c=!1,u=new da(0),d=e.pixelScale||1,m;if(ct(t)){let h=t.createBuffer(),f,b,v=!1,x=()=>{t.bindBuffer(t.PIXEL_PACK_BUFFER,h),t.getBufferSubData(t.PIXEL_PACK_BUFFER,0,f),t.bindBuffer(t.PIXEL_PACK_BUFFER,null),v=!1,b(),b=void 0,f=void 0};m=(S,T,E,_,D)=>new Promise((P,A)=>{if(v){A("Can not call multiple readPixelsAsync at the same time");return}v=!0,t.bindBuffer(t.PIXEL_PACK_BUFFER,h),t.bufferData(t.PIXEL_PACK_BUFFER,E*_*4,t.STREAM_READ),t.readPixels(S,T,E,_,t.RGBA,t.UNSIGNED_BYTE,0),t.bindBuffer(t.PIXEL_PACK_BUFFER,null),b=P,f=D,JG(t,x)})}else m=(h,f,b,v,x)=>N(this,null,function*(){NA(t,h,f,b,v,x)});let p=new Set;return{gl:t,isWebGL2:ct(t),get pixelRatio(){return(typeof window<"u"&&window.devicePixelRatio||1)*(d||1)},extensions:r,state:n,stats:o,resources:i,timer:a,get maxTextureSize(){return s.maxTextureSize},get max3dTextureSize(){return s.max3dTextureSize},get maxRenderbufferSize(){return s.maxRenderbufferSize},get maxDrawBuffers(){return s.maxDrawBuffers},get maxTextureImageUnits(){return s.maxTextureImageUnits},namedComputeRenderables:Object.create(null),namedFramebuffers:Object.create(null),namedTextures:Object.create(null),get isContextLost(){return c||t.isContextLost()},contextRestored:u,setContextLost:()=>{c=!0,a.clear()},handleContextRestored:h=>{Object.assign(r,BA(t)),n.reset(),n.currentMaterialId=-1,n.currentProgramId=-1,n.currentRenderItemId=-1,i.reset(),p.forEach(f=>f.reset()),h?.(),c=!1,u.next(ko())},setPixelScale:h=>{d=h},createRenderTarget:(h,f,b,v,x,S)=>{let T=WG(t,i,h,f,b,v,x,S);return p.add(T),U(w({},T),{destroy:()=>{T.destroy(),p.delete(T)}})},unbindFramebuffer:()=>HT(t),readPixels:(h,f,b,v,x)=>{NA(t,h,f,b,v,x)},readPixelsAsync:m,waitForGpuCommandsComplete:()=>Iue(t),waitForGpuCommandsCompleteSync:()=>ej(t),getDrawingBufferPixelData:()=>Due(t,n),clear:(h,f,b,v)=>{HT(t),n.enable(t.SCISSOR_TEST),n.depthMask(!0),n.colorMask(!0,!0,!0,!0),n.clearColor(h,f,b,v),n.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight),n.scissor(0,0,t.drawingBufferWidth,t.drawingBufferHeight),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)},destroy:h=>{var f,b;i.destroy(),Eue(t),h?.doNotForceWebGLContextLoss||((f=t.getExtension("WEBGL_lose_context"))===null||f===void 0||f.loseContext(),(b=t.getExtension("STACKGL_destroy_context"))===null||b===void 0||b.destroy())}}}function ct(t){return typeof WebGL2RenderingContext<"u"&&t instanceof WebGL2RenderingContext}function zU(t){if(ct(t))return{drawArraysInstanced:t.drawArraysInstanced.bind(t),drawElementsInstanced:t.drawElementsInstanced.bind(t),vertexAttribDivisor:t.vertexAttribDivisor.bind(t),VERTEX_ATTRIB_ARRAY_DIVISOR:t.VERTEX_ATTRIB_ARRAY_DIVISOR};{let e=t.getExtension("ANGLE_instanced_arrays");return e===null?null:{drawArraysInstanced:e.drawArraysInstancedANGLE.bind(e),drawElementsInstanced:e.drawElementsInstancedANGLE.bind(e),vertexAttribDivisor:e.vertexAttribDivisorANGLE.bind(e),VERTEX_ATTRIB_ARRAY_DIVISOR:e.VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE}}}function UU(t){if(ct(t))return{FRAGMENT_SHADER_DERIVATIVE_HINT:t.FRAGMENT_SHADER_DERIVATIVE_HINT};{let e=t.getExtension("OES_standard_derivatives");return e===null?null:{FRAGMENT_SHADER_DERIVATIVE_HINT:e.FRAGMENT_SHADER_DERIVATIVE_HINT_OES}}}function GU(t){return ct(t)?{}:t.getExtension("OES_element_index_uint")}function jU(t){if(ct(t))return{VERTEX_ARRAY_BINDING:t.VERTEX_ARRAY_BINDING,bindVertexArray:t.bindVertexArray.bind(t),createVertexArray:t.createVertexArray.bind(t),deleteVertexArray:t.deleteVertexArray.bind(t),isVertexArray:t.isVertexArray.bind(t)};{let e=t.getExtension("OES_vertex_array_object");return e===null?null:{VERTEX_ARRAY_BINDING:e.VERTEX_ARRAY_BINDING_OES,bindVertexArray:e.bindVertexArrayOES.bind(e),createVertexArray:e.createVertexArrayOES.bind(e),deleteVertexArray:e.deleteVertexArrayOES.bind(e),isVertexArray:e.isVertexArrayOES.bind(e)}}}function HU(t){return ct(t)?{}:t.getExtension("OES_texture_float")}function qU(t){return t.getExtension("OES_texture_float_linear")}function WU(t){if(ct(t))return{HALF_FLOAT:t.HALF_FLOAT};{let e=t.getExtension("OES_texture_half_float");return e===null?null:{HALF_FLOAT:e.HALF_FLOAT_OES}}}function XU(t){return t.getExtension("OES_texture_half_float_linear")}function YU(t){if(ct(t))return{MIN:t.MIN,MAX:t.MAX};{let e=t.getExtension("EXT_blend_minmax");return e===null?null:{MIN:e.MIN_EXT,MAX:e.MAX_EXT}}}function QU(t){return ct(t)?{}:t.getExtension("EXT_frag_depth")}function KU(t){if(ct(t))return t.getExtension("EXT_color_buffer_float")===null?null:(t.getExtension("EXT_float_blend"),{RGBA32F:t.RGBA32F});{let e=t.getExtension("WEBGL_color_buffer_float");return e===null?(t.getExtension("OES_texture_float"),rj(t,t.FLOAT)?{RGBA32F:34836}:null):(t.getExtension("EXT_float_blend"),{RGBA32F:e.RGBA32F_EXT})}}function $U(t){if(ct(t))return t.getExtension("EXT_color_buffer_half_float")===null?null:(t.getExtension("EXT_float_blend"),{RGBA16F:t.RGBA16F});{let e=t.getExtension("EXT_color_buffer_half_float");return e===null?(t.getExtension("OES_texture_half_float"),rj(t,36193)?{RGBA16F:34842}:null):(t.getExtension("EXT_float_blend"),{RGBA16F:e.RGBA16F_EXT})}}function ZU(t){if(ct(t))return{drawBuffers:t.drawBuffers.bind(t),COLOR_ATTACHMENT0:t.COLOR_ATTACHMENT0,COLOR_ATTACHMENT1:t.COLOR_ATTACHMENT1,COLOR_ATTACHMENT2:t.COLOR_ATTACHMENT2,COLOR_ATTACHMENT3:t.COLOR_ATTACHMENT3,COLOR_ATTACHMENT4:t.COLOR_ATTACHMENT4,COLOR_ATTACHMENT5:t.COLOR_ATTACHMENT5,COLOR_ATTACHMENT6:t.COLOR_ATTACHMENT6,COLOR_ATTACHMENT7:t.COLOR_ATTACHMENT7,DRAW_BUFFER0:t.DRAW_BUFFER0,DRAW_BUFFER1:t.DRAW_BUFFER1,DRAW_BUFFER2:t.DRAW_BUFFER2,DRAW_BUFFER3:t.DRAW_BUFFER3,DRAW_BUFFER4:t.DRAW_BUFFER4,DRAW_BUFFER5:t.DRAW_BUFFER5,DRAW_BUFFER6:t.DRAW_BUFFER6,DRAW_BUFFER7:t.DRAW_BUFFER7,MAX_COLOR_ATTACHMENTS:t.MAX_COLOR_ATTACHMENTS,MAX_DRAW_BUFFERS:t.MAX_DRAW_BUFFERS};{let e=t.getExtension("WEBGL_draw_buffers");return e===null?null:{drawBuffers:e.drawBuffersWEBGL.bind(e),COLOR_ATTACHMENT0:e.COLOR_ATTACHMENT0_WEBGL,COLOR_ATTACHMENT1:e.COLOR_ATTACHMENT1_WEBGL,COLOR_ATTACHMENT2:e.COLOR_ATTACHMENT2_WEBGL,COLOR_ATTACHMENT3:e.COLOR_ATTACHMENT3_WEBGL,COLOR_ATTACHMENT4:e.COLOR_ATTACHMENT4_WEBGL,COLOR_ATTACHMENT5:e.COLOR_ATTACHMENT5_WEBGL,COLOR_ATTACHMENT6:e.COLOR_ATTACHMENT6_WEBGL,COLOR_ATTACHMENT7:e.COLOR_ATTACHMENT7_WEBGL,DRAW_BUFFER0:e.DRAW_BUFFER0_WEBGL,DRAW_BUFFER1:e.DRAW_BUFFER1_WEBGL,DRAW_BUFFER2:e.DRAW_BUFFER2_WEBGL,DRAW_BUFFER3:e.DRAW_BUFFER3_WEBGL,DRAW_BUFFER4:e.DRAW_BUFFER4_WEBGL,DRAW_BUFFER5:e.DRAW_BUFFER5_WEBGL,DRAW_BUFFER6:e.DRAW_BUFFER6_WEBGL,DRAW_BUFFER7:e.DRAW_BUFFER7_WEBGL,MAX_COLOR_ATTACHMENTS:e.MAX_COLOR_ATTACHMENTS_WEBGL,MAX_DRAW_BUFFERS:e.MAX_DRAW_BUFFERS_WEBGL}}}function JU(t){let e=t.getExtension("OES_draw_buffers_indexed");return e===null?null:{enablei:e.enableiOES.bind(e),disablei:e.disableiOES.bind(e),blendEquationi:e.blendEquationiOES.bind(e),blendEquationSeparatei:e.blendEquationSeparateiOES.bind(e),blendFunci:e.blendFunciOES.bind(e),blendFuncSeparatei:e.blendFuncSeparateiOES.bind(e),colorMaski:e.colorMaskiOES.bind(e)}}function e5(t){return ct(t)?{}:t.getExtension("EXT_shader_texture_lod")}function t5(t){if(ct(t))return{UNSIGNED_INT_24_8:t.UNSIGNED_INT_24_8};{let e=t.getExtension("WEBGL_depth_texture");return e===null?null:{UNSIGNED_INT_24_8:e.UNSIGNED_INT_24_8_WEBGL}}}function r5(t){if(ct(t))return{FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING:t.FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING,SRGB8_ALPHA8:t.SRGB8_ALPHA8,SRGB8:t.SRGB8,SRGB:t.SRGB};{let e=t.getExtension("EXT_sRGB");return e===null?null:{FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING:e.FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING_EXT,SRGB8_ALPHA8:e.SRGB8_ALPHA8_EXT,SRGB8:e.SRGB_ALPHA_EXT,SRGB:e.SRGB_EXT}}}function n5(t){if(ct(t)){let e=t.getExtension("EXT_disjoint_timer_query_webgl2")||t.getExtension("EXT_disjoint_timer_query");return e===null?null:{QUERY_COUNTER_BITS:e.QUERY_COUNTER_BITS_EXT,CURRENT_QUERY:t.CURRENT_QUERY,QUERY_RESULT:t.QUERY_RESULT,QUERY_RESULT_AVAILABLE:t.QUERY_RESULT_AVAILABLE,TIME_ELAPSED:e.TIME_ELAPSED_EXT,TIMESTAMP:e.TIMESTAMP_EXT,GPU_DISJOINT:e.GPU_DISJOINT_EXT,createQuery:t.createQuery.bind(t),deleteQuery:t.deleteQuery.bind(t),isQuery:t.isQuery.bind(t),beginQuery:t.beginQuery.bind(t),endQuery:t.endQuery.bind(t),queryCounter:e.queryCounterEXT.bind(e),getQuery:t.getQuery.bind(t),getQueryParameter:t.getQueryParameter.bind(t)}}else{let e=t.getExtension("EXT_disjoint_timer_query");return e===null?null:{QUERY_COUNTER_BITS:e.QUERY_COUNTER_BITS_EXT,CURRENT_QUERY:e.CURRENT_QUERY_EXT,QUERY_RESULT:e.QUERY_RESULT_EXT,QUERY_RESULT_AVAILABLE:e.QUERY_RESULT_AVAILABLE_EXT,TIME_ELAPSED:e.TIME_ELAPSED_EXT,TIMESTAMP:e.TIMESTAMP_EXT,GPU_DISJOINT:e.GPU_DISJOINT_EXT,createQuery:e.createQueryEXT.bind(e),deleteQuery:e.deleteQueryEXT.bind(e),isQuery:e.isQueryEXT.bind(e),beginQuery:e.beginQueryEXT.bind(e),endQuery:e.endQueryEXT.bind(e),queryCounter:e.queryCounterEXT.bind(e),getQuery:e.getQueryEXT.bind(e),getQueryParameter:e.getQueryObjectEXT.bind(e)}}}function o5(t){let e=t.getExtension("WEBGL_multi_draw");return e?{multiDrawArrays:e.multiDrawArraysWEBGL.bind(e),multiDrawElements:e.multiDrawElementsWEBGL.bind(e),multiDrawArraysInstanced:e.multiDrawArraysInstancedWEBGL.bind(e),multiDrawElementsInstanced:e.multiDrawElementsInstancedWEBGL.bind(e)}:null}function i5(t){let e=t.getExtension("WEBGL_draw_instanced_base_vertex_base_instance");return e?{drawArraysInstancedBaseInstance:e.drawArraysInstancedBaseInstanceWEBGL.bind(e),drawElementsInstancedBaseVertexBaseInstance:e.drawElementsInstancedBaseVertexBaseInstanceWEBGL.bind(e)}:null}function a5(t){let e=t.getExtension("WEBGL_multi_draw_instanced_base_vertex_base_instance");return e?{multiDrawArraysInstancedBaseInstance:e.multiDrawArraysInstancedBaseInstanceWEBGL.bind(e),multiDrawElementsInstancedBaseVertexBaseInstance:e.multiDrawElementsInstancedBaseVertexBaseInstanceWEBGL.bind(e)}:null}function s5(t){let e=t.getExtension("KHR_parallel_shader_compile");return e===null?null:{COMPLETION_STATUS:e.COMPLETION_STATUS_KHR}}function l5(t){return ct(t)?{}:t.getExtension("OES_fbo_render_mipmap")}function c5(t){if(ct(t)){let e=t.getExtension("WEBGL_provoking_vertex");if(e)return{FIRST_VERTEX_CONVENTION:e.FIRST_VERTEX_CONVENTION_WEBGL,LAST_VERTEX_CONVENTION:e.LAST_VERTEX_CONVENTION_WEBGL,PROVOKING_VERTEX:e.PROVOKING_VERTEX_WEBGL,provokingVertex:e.provokingVertexWEBGL.bind(e)}}return null}function u5(t){if(ct(t)){let e=t.getExtension("WEBGL_clip_cull_distance");if(e)return{MAX_CLIP_DISTANCES:e.MAX_CLIP_DISTANCES_WEBGL,MAX_CULL_DISTANCES:e.MAX_CULL_DISTANCES_WEBGL,MAX_COMBINED_CLIP_AND_CULL_DISTANCES:e.MAX_COMBINED_CLIP_AND_CULL_DISTANCES_WEBGL,CLIP_DISTANCE0:e.CLIP_DISTANCE0_WEBGL,CLIP_DISTANCE1:e.CLIP_DISTANCE1_WEBGL,CLIP_DISTANCE2:e.CLIP_DISTANCE2_WEBGL,CLIP_DISTANCE3:e.CLIP_DISTANCE3_WEBGL,CLIP_DISTANCE4:e.CLIP_DISTANCE4_WEBGL,CLIP_DISTANCE5:e.CLIP_DISTANCE5_WEBGL,CLIP_DISTANCE6:e.CLIP_DISTANCE6_WEBGL,CLIP_DISTANCE7:e.CLIP_DISTANCE7_WEBGL}}return null}function d5(t){return ct(t)&&t.getExtension("EXT_conservative_depth")?{}:null}function m5(t){if(ct(t)){let e=t.getExtension("WEBGL_stencil_texturing");if(e)return{DEPTH_STENCIL_TEXTURE_MODE:e.DEPTH_STENCIL_TEXTURE_MODE_WEBGL,STENCIL_INDEX:e.STENCIL_INDEX_WEBGL}}return null}function p5(t){let e=t.getExtension("EXT_clip_control");return e?{LOWER_LEFT:e.LOWER_LEFT_EXT,UPPER_LEFT:e.UPPER_LEFT_EXT,NEGATIVE_ONE_TO_ONE:e.NEGATIVE_ONE_TO_ONE_EXT,ZERO_TO_ONE:e.ZERO_TO_ONE_EXT,CLIP_ORIGIN:e.CLIP_ORIGIN_EXT,CLIP_DEPTH_MODE:e.CLIP_DEPTH_MODE_EXT,clipControl:e.clipControlEXT.bind(e)}:null}function f5(t){if(!ct(t))return!1;if(typeof navigator<"u"){let e=window.navigator.userAgent.match(/Firefox\/([0-9]+)\./);return e?parseInt(e[1])>=85:!0}return!1}var kue=`
attribute vec4 aPosition;

void main() {
    gl_Position = aPosition;
}`,Mue=`
precision mediump float;
uniform vec4 uColor;
uniform sampler2D uTexture;

void main() {
    gl_FragColor = texture2D(uTexture, vec2(0.5, 0.5)) * uColor;
}`,Rue=new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]);function rj(t,e){let r=qx(t,{type:"vert",source:kue}),n=qx(t,{type:"frag",source:Mue});if(!r||!n)return!1;let o=GT(t);t.attachShader(o,r),t.attachShader(o,n),t.linkProgram(o),t.useProgram(o);let i=t.getAttribLocation(o,"aPosition"),a=t.getUniformLocation(o,"uColor");if(!a)return ht&&console.log("error getting 'uColor' uniform location"),!1;let s=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,s),t.bufferData(t.ARRAY_BUFFER,Rue,t.STATIC_DRAW),t.enableVertexAttribArray(i),t.vertexAttribPointer(i,2,t.FLOAT,!1,0,0);let l=t.createTexture(),c=new Uint8Array([255,255,255,255]);t.bindTexture(t.TEXTURE_2D,l),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,c);let u=t.createTexture();t.bindTexture(t.TEXTURE_2D,u),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,e,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);let d=t.createFramebuffer();if(t.bindFramebuffer(t.FRAMEBUFFER,d),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,u,0),t.checkFramebufferStatus(t.FRAMEBUFFER)!==t.FRAMEBUFFER_COMPLETE)return ht&&console.log(`error creating framebuffer for '${e}'`),!1;t.bindTexture(t.TEXTURE_2D,l),t.uniform4fv(a,[0,10,20,1]),t.drawArrays(t.TRIANGLES,0,6),t.bindTexture(t.TEXTURE_2D,u),t.bindFramebuffer(t.FRAMEBUFFER,null),t.clearColor(1,0,0,1),t.clear(t.COLOR_BUFFER_BIT),t.uniform4fv(a,[0,1/10,1/20,1]),t.drawArrays(t.TRIANGLES,0,6);let p=new Uint8Array(4);if(t.readPixels(0,0,1,1,t.RGBA,t.UNSIGNED_BYTE,p),p[0]!==0||p[1]<248||p[2]<248||p[3]<254)return ht&&console.log(`not able to actually render to '${e}' texture`),!1;if(e===t.FLOAT){t.bindFramebuffer(t.FRAMEBUFFER,d);let h=new Float32Array(4);t.readPixels(0,0,1,1,t.RGBA,t.FLOAT,h);let f=t.getError();if(f)return ht&&console.log(`error reading float pixels: '${VA(t,f)}'`),!1}return!0}var UA=bo();function Lue(t,e){switch(e){case"image-uint8":return t.TEXTURE_2D;case"image-float32":return t.TEXTURE_2D;case"image-float16":return t.TEXTURE_2D;case"image-depth":return t.TEXTURE_2D}if(ct(t))switch(e){case"image-int32":return t.TEXTURE_2D;case"volume-uint8":return t.TEXTURE_3D;case"volume-float32":return t.TEXTURE_3D;case"volume-float16":return t.TEXTURE_3D}throw new Error(`unknown texture kind '${e}'`)}function sj(t,e,r){switch(e){case"alpha":return ct(t)&&r==="float"?t.RED:ct(t)&&r==="int"?t.RED_INTEGER:t.ALPHA;case"rgb":return ct(t)&&r==="int"?t.RGB_INTEGER:t.RGB;case"rg":if(ct(t)&&r==="float")return t.RG;if(ct(t)&&r==="int")return t.RG_INTEGER;throw new Error('texture format "rg" requires webgl2 and type "float" or int"');case"rgba":return ct(t)&&r==="int"?t.RGBA_INTEGER:t.RGBA;case"depth":return t.DEPTH_COMPONENT}}function Bue(t,e,r){if(ct(t))switch(e){case"alpha":switch(r){case"ubyte":return t.ALPHA;case"float":return t.R32F;case"fp16":return t.R16F;case"int":return t.R32I}case"rg":switch(r){case"ubyte":return t.RG;case"float":return t.RG32F;case"fp16":return t.RG16F;case"int":return t.RG32I}case"rgb":switch(r){case"ubyte":return t.RGB;case"float":return t.RGB32F;case"fp16":return t.RGB16F;case"int":return t.RGB32I}case"rgba":switch(r){case"ubyte":return t.RGBA;case"float":return t.RGBA32F;case"fp16":return t.RGBA16F;case"int":return t.RGBA32I}case"depth":switch(r){case"ushort":return t.DEPTH_COMPONENT16;case"float":return t.DEPTH_COMPONENT32F}}return sj(t,e,r)}function lj(t,e,r,n,o){return Oue(t)*Fue(e)*r*n*(o||1)}function Oue(t){switch(t){case"alpha":return 1;case"rg":return 2;case"rgb":return 3;case"rgba":return 4;case"depth":return 4}}function Fue(t){switch(t){case"ubyte":return 1;case"ushort":return 2;case"float":return 4;case"fp16":return 2;case"int":return 4}}function Nue(t,e,r){switch(r){case"ubyte":return t.UNSIGNED_BYTE;case"ushort":return t.UNSIGNED_SHORT;case"float":return t.FLOAT;case"fp16":if(e.textureHalfFloat)return e.textureHalfFloat.HALF_FLOAT;throw new Error('extension "texture_half_float" unavailable');case"int":if(ct(t))return t.INT;throw new Error('texture type "int" requires webgl2')}}function nj(t,e){switch(e){case"nearest":return t.NEAREST;case"linear":return t.LINEAR}}function qT(t,e,r){switch(r){case"depth":return t.DEPTH_ATTACHMENT;case"stencil":return t.STENCIL_ATTACHMENT;case"color0":case 0:return t.COLOR_ATTACHMENT0}if(e.drawBuffers)switch(r){case"color1":case 1:return e.drawBuffers.COLOR_ATTACHMENT1;case"color2":case 2:return e.drawBuffers.COLOR_ATTACHMENT2;case"color3":case 3:return e.drawBuffers.COLOR_ATTACHMENT3;case"color4":case 4:return e.drawBuffers.COLOR_ATTACHMENT4;case"color5":case 5:return e.drawBuffers.COLOR_ATTACHMENT5;case"color6":case 6:return e.drawBuffers.COLOR_ATTACHMENT6;case"color7":case 7:return e.drawBuffers.COLOR_ATTACHMENT7}throw new Error("unknown texture attachment")}function oj(t){return typeof HTMLImageElement<"u"&&t instanceof HTMLImageElement}function Vue(t,e,r){return e===r.TEXTURE_2D}function ij(t,e,r){return e===r.TEXTURE_3D}function aj(t){let e=t.createTexture();if(e===null)throw new Error("Could not create WebGL texture");return e}function jG(t,e,r,n,o,i){let a=UA(),s=aj(t);if(r.endsWith("float32")&&o!=="float"||r.endsWith("float16")&&o!=="fp16"||r.endsWith("uint8")&&o!=="ubyte"||r.endsWith("int32")&&o!=="int"||r.endsWith("depth")&&o!=="ushort"&&o!=="float")throw new Error(`texture kind '${r}' and type '${o}' are incompatible`);if(!e.depthTexture&&n==="depth")throw new Error("extension 'WEBGL_depth_texture' needed for 'depth' texture format");let l=Lue(t,r),c=nj(t,i),u=sj(t,n,o),d=Bue(t,n,o),m=Nue(t,e,o);function p(){t.bindTexture(l,s),t.texParameteri(l,t.TEXTURE_MAG_FILTER,c),t.texParameteri(l,t.TEXTURE_MIN_FILTER,c),t.texParameteri(l,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(l,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.bindTexture(l,null)}p();let h=0,f=0,b=0,v,x=!1,S=!1;function T(P,A,I){if(P===0||A===0||ct(t)&&l===t.TEXTURE_3D&&I===0)throw new Error("empty textures are not allowed");if(!(h===P&&f===A&&b===(I||0)))if(h=P,f=A,b=I||0,t.bindTexture(l,s),l===t.TEXTURE_2D)t.texImage2D(l,0,d,h,f,0,u,m,null);else if(ct(t)&&l===t.TEXTURE_3D&&b!==void 0)t.texImage3D(l,0,d,h,f,b,0,u,m,null);else throw new Error("unknown texture target")}T(1,1,ct(t)&&l===t.TEXTURE_3D?1:0);function E(P,A=!1){if(P.width===0||P.height===0||!oj(P)&&ct(t)&&ij(P,l,t)&&P.depth===0)throw new Error("empty textures are not allowed");if(t.bindTexture(l,s),t.pixelStorei(t.UNPACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_COLORSPACE_CONVERSION_WEBGL,t.NONE),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),oj(P))h=P.width,f=P.height,t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.bindTexture(t.TEXTURE_2D,s),t.texImage2D(t.TEXTURE_2D,0,d,u,m,P);else if(Vue(P,l,t)){let I=P.filter?nj(t,P.filter):c;t.texParameteri(l,t.TEXTURE_MAG_FILTER,I),t.texParameteri(l,t.TEXTURE_MIN_FILTER,I),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!!P.flipY),A?t.texSubImage2D(l,0,0,0,P.width,P.height,u,m,P.array):(h=P.width,f=P.height,t.texImage2D(l,0,d,h,f,0,u,m,P.array))}else if(ct(t)&&ij(P,l,t))t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),A?t.texSubImage3D(l,0,0,0,0,P.width,P.height,P.depth,u,m,P.array):(h=P.width,f=P.height,b=P.depth,t.texImage3D(l,0,d,h,f,b,0,u,m,P.array));else throw new Error("unknown texture target");t.bindTexture(l,null),v=P}function _(){if(l!==t.TEXTURE_2D)throw new Error("mipmap only supported for 2d textures");if(ct(t)||nf(h)&&nf(f))t.bindTexture(l,s),t.texParameteri(l,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),t.generateMipmap(l),t.bindTexture(l,null),x=!0;else throw new Error("mipmap unsupported for non-power-of-two textures and webgl1")}function D(P,A,I){if(P.bind(),l===t.TEXTURE_2D)t.framebufferTexture2D(t.FRAMEBUFFER,qT(t,e,A),t.TEXTURE_2D,s,0);else if(ct(t)&&l===t.TEXTURE_3D){if(I===void 0)throw new Error("need `layer` to attach 3D texture");t.framebufferTextureLayer(t.FRAMEBUFFER,qT(t,e,A),s,0,I)}else throw new Error("unknown/unsupported texture target")}return{id:a,target:l,format:u,internalFormat:d,type:m,filter:c,getWidth:()=>h,getHeight:()=>f,getDepth:()=>b,getByteCount:()=>lj(n,o,h,f,b),define:T,load:E,mipmap:_,bind:P=>{t.activeTexture(t.TEXTURE0+P),t.bindTexture(l,s)},unbind:P=>{t.activeTexture(t.TEXTURE0+P),t.bindTexture(l,null)},attachFramebuffer:D,detachFramebuffer:(P,A)=>{if(P.bind(),l===t.TEXTURE_2D)t.framebufferTexture2D(t.FRAMEBUFFER,qT(t,e,A),t.TEXTURE_2D,null,0);else if(ct(t)&&l===t.TEXTURE_3D)t.framebufferTextureLayer(t.FRAMEBUFFER,qT(t,e,A),null,0,0);else throw new Error("unknown texture target")},reset:()=>{s=aj(t),p();let[P,A,I]=[h,f,b];h=0,f=0,b=0,T(P,A,I),v&&E(v),x&&_()},destroy:()=>{S||(t.deleteTexture(s),S=!0)}}}function GA(t,e,r){let{resources:n}=t,o=[];return Object.keys(e).forEach(i=>{let a=e[i];if(a.type==="texture"){let s=r[i];if(s)if(a.kind==="texture")o[o.length]=[i,s.ref.value];else{let l=n.texture(a.kind,a.format,a.dataType,a.filter);l.load(s.ref.value),o[o.length]=[i,l]}}}),o}function jA(t,e,r){let n=new Image;n.onload=function(){r.load(n),C.update(e,r)},n.src=t}function zue(t,e){switch(e){case"nx":return t.TEXTURE_CUBE_MAP_NEGATIVE_X;case"ny":return t.TEXTURE_CUBE_MAP_NEGATIVE_Y;case"nz":return t.TEXTURE_CUBE_MAP_NEGATIVE_Z;case"px":return t.TEXTURE_CUBE_MAP_POSITIVE_X;case"py":return t.TEXTURE_CUBE_MAP_POSITIVE_Y;case"pz":return t.TEXTURE_CUBE_MAP_POSITIVE_Z}}function HG(t,e,r,n){let o=t.TEXTURE_CUBE_MAP,i=t.LINEAR,a=t.RGBA,s=t.RGBA,l=t.UNSIGNED_BYTE,c=0,u=t.createTexture();t.bindTexture(o,u);let d=0;ro(e,(p,h)=>{if(!p)return;let f=0,b=zue(t,h),v=new Image;p instanceof File?v.src=URL.createObjectURL(p):af(p)?p.then(x=>{v.src=URL.createObjectURL(x)}):v.src=p,v.addEventListener("load",()=>{c===0&&(c=v.width),t.texImage2D(b,f,a,c,c,0,s,l,null),t.pixelStorei(t.UNPACK_ALIGNMENT,4),t.pixelStorei(t.UNPACK_COLORSPACE_CONVERSION_WEBGL,t.NONE),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.bindTexture(o,u),t.texImage2D(b,f,a,s,l,v),d+=1,d===6&&(m||(r?(t.texParameteri(o,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),t.generateMipmap(o)):t.texParameteri(o,t.TEXTURE_MIN_FILTER,i),t.texParameteri(o,t.TEXTURE_MAG_FILTER,i)),n?.(m))}),v.addEventListener("error",()=>{n?.(!0)})});let m=!1;return{id:UA(),target:o,format:s,internalFormat:a,type:l,filter:i,getWidth:()=>c,getHeight:()=>c,getDepth:()=>0,getByteCount:()=>lj("rgba","ubyte",c,c,0)*6*(r?2:1),define:()=>{},load:()=>{},mipmap:()=>{},bind:p=>{t.activeTexture(t.TEXTURE0+p),t.bindTexture(o,u)},unbind:p=>{t.activeTexture(t.TEXTURE0+p),t.bindTexture(o,null)},attachFramebuffer:()=>{},detachFramebuffer:()=>{},reset:()=>{},destroy:()=>{m||(t.deleteTexture(u),m=!0)}}}var cj=-1;function uj(t){return t.format===cj}function un(t){var e;let r=(e=t?.TEXTURE_2D)!==null&&e!==void 0?e:3553;return{id:UA(),target:r,format:cj,internalFormat:0,type:0,filter:0,getWidth:()=>0,getHeight:()=>0,getDepth:()=>0,getByteCount:()=>0,define:()=>{},load:()=>{},mipmap:()=>{},bind:n=>{t&&(t.activeTexture(t.TEXTURE0+n),t.bindTexture(r,null))},unbind:n=>{t&&(t.activeTexture(t.TEXTURE0+n),t.bindTexture(r,null))},attachFramebuffer:()=>{throw new Error("cannot attach null-texture to a framebuffer")},detachFramebuffer:()=>{throw new Error("cannot detach null-texture from a framebuffer")},reset:()=>{},destroy:()=>{}}}function uo(t,e,r,n){let o=Uue(t,e,r,n);return r.palette?(C.updateIfChanged(o.dUsePalette,!0),Gue(r.palette,o.tPalette)):C.updateIfChanged(o.dUsePalette,!1),o}function Uue(t,e,r,n){switch(r.granularity){case"uniform":return Hue(t,r.color,n);case"instance":return t.nonInstanceable?dj(t,r.color,n):que(t,r.color,n);case"group":return dj(t,r.color,n);case"groupInstance":return Wue(t,r.color,n);case"vertex":return Xue(e,r.color,n);case"vertexInstance":return Yue(e,r.color,n);case"volume":return mj(r.grid,"volume",n);case"volumeInstance":return mj(r.grid,"volumeInstance",n);case"direct":return Que(n)}}function Gue(t,e){let r=!0,n=e.ref.value;if(t.colors.length!==n.width||n.filter!==t.filter)r=!1;else{let a=n.array,s=0;for(let l of t.colors){let[c,u,d]=ce.toRgb(l);if(a[s++]!==c||a[s++]!==u||a[s++]!==d){r=!1;break}}}if(r)return;let o=new Uint8Array(t.colors.length*3),i=0;for(let a of t.colors){let[s,l,c]=ce.toRgb(a);o[i++]=s,o[i++]=l,o[i++]=c}C.update(e,{array:o,height:1,width:t.colors.length,filter:t.filter})}function jue(t,e){return e?(C.update(e.uColor,ce.toVec3Normalized(e.uColor.ref.value,t)),C.updateIfChanged(e.dColorType,"uniform"),e):{uColor:C.create(ce.toVec3Normalized(y(),t)),tColor:C.create({array:new Uint8Array(3),width:1,height:1}),tColorGrid:C.create(un()),tPalette:C.create({array:new Uint8Array(3),width:1,height:1}),uColorTexDim:C.create(ne.create(1,1)),uColorGridDim:C.create(y.create(1,1,1)),uColorGridTransform:C.create(at.create(0,0,0,1)),dColorType:C.create("uniform"),dUsePalette:C.create(!1)}}function Hue(t,e,r){return jue(e(Lo,!1),r)}function Wx(t,e,r){return r?(C.update(r.tColor,t),C.update(r.uColorTexDim,ne.create(t.width,t.height)),C.updateIfChanged(r.dColorType,e),r):{uColor:C.create(y()),tColor:C.create(t),tColorGrid:C.create(un()),tPalette:C.create({array:new Uint8Array(3),width:1,height:1}),uColorTexDim:C.create(ne.create(t.width,t.height)),uColorGridDim:C.create(y.create(1,1,1)),uColorGridTransform:C.create(at.create(0,0,0,1)),dColorType:C.create(e),dUsePalette:C.create(!1)}}function que(t,e,r){let{instanceCount:n}=t,o=Zr(Math.max(1,n),3,Uint8Array,r&&r.tColor.ref.value.array);for(t.reset();t.hasNext;){let{location:i,isSecondary:a,instanceIndex:s}=t.move();ce.toArray(e(i,a),o.array,s*3),t.skipInstance()}return Wx(o,"instance",r)}function dj(t,e,r){let{groupCount:n,hasLocation2:o}=t,i=Zr(Math.max(1,n*(o?2:1)),3,Uint8Array,r&&r.tColor.ref.value.array);t.reset();let a=o?6:3;for(;t.hasNext&&!t.isNextNewInstance;){let{location:s,location2:l,isSecondary:c,groupIndex:u}=t.move();ce.toArray(e(s,c),i.array,u*a),o&&ce.toArray(e(l,c),i.array,u*a+3)}return Wx(i,"group",r)}function Wue(t,e,r){let{groupCount:n,instanceCount:o,hasLocation2:i}=t,a=o*n*(i?2:1),s=Zr(Math.max(1,a),3,Uint8Array,r&&r.tColor.ref.value.array);t.reset();let l=i?6:3;for(;t.hasNext;){let{location:c,location2:u,isSecondary:d,index:m}=t.move();ce.toArray(e(c,d),s.array,m*l),i&&ce.toArray(e(u,d),s.array,m*l+3)}return Wx(s,"groupInstance",r)}function Xue(t,e,r){let{groupCount:n,stride:o}=t,i=Zr(Math.max(1,n),3,Uint8Array,r&&r.tColor.ref.value.array);for(t.reset(),t.voidInstances();t.hasNext&&!t.isNextNewInstance;){let{location:a,isSecondary:s,groupIndex:l}=t.move(),c=e(a,s);for(let u=0;u<o;++u)ce.toArray(c,i.array,(l+u)*3)}return Wx(i,"vertex",r)}function Yue(t,e,r){let{groupCount:n,instanceCount:o,stride:i}=t,a=o*n,s=Zr(Math.max(1,a),3,Uint8Array,r&&r.tColor.ref.value.array);for(t.reset();t.hasNext;){let{location:l,isSecondary:c,index:u}=t.move(),d=e(l,c);for(let m=0;m<i;++m)ce.toArray(d,s.array,(u+m)*3)}return Wx(s,"vertexInstance",r)}function mj(t,e,r){let{colors:n,dimension:o,transform:i}=t,a=n.getWidth(),s=n.getHeight();return r?(C.update(r.tColorGrid,n),C.update(r.uColorTexDim,ne.create(a,s)),C.update(r.uColorGridDim,y.clone(o)),C.update(r.uColorGridTransform,at.clone(i)),C.updateIfChanged(r.dColorType,e),r):{uColor:C.create(y()),tColor:C.create({array:new Uint8Array(3),width:1,height:1}),tColorGrid:C.create(n),tPalette:C.create({array:new Uint8Array(3),width:1,height:1}),uColorTexDim:C.create(ne.create(a,s)),uColorGridDim:C.create(y.clone(o)),uColorGridTransform:C.create(at.clone(i)),dColorType:C.create(e),dUsePalette:C.create(!1)}}function Que(t){return t?(C.updateIfChanged(t.dColorType,"direct"),t):{uColor:C.create(y()),tColor:C.create({array:new Uint8Array(3),width:1,height:1}),tColorGrid:C.create(un()),tPalette:C.create({array:new Uint8Array(3),width:1,height:1}),uColorTexDim:C.create(ne.create(1,1)),uColorGridDim:C.create(y.create(1,1,1)),uColorGridTransform:C.create(at.create(0,0,0,1)),dColorType:C.create("direct"),dUsePalette:C.create(!1)}}var HA=y.transformMat4Offset,Kue=y.fromArray,WT=qe.add;function pj(){return{cellSize:0,cellCount:0,cellOffsets:new Uint32Array,cellSpheres:new Float32Array,cellTransform:new Float32Array,cellInstance:new Float32Array,batchSize:0,batchCount:0,batchOffsets:new Uint32Array,batchSpheres:new Float32Array,batchCell:new Uint32Array}}function fj(t,e,r){let n=$ue(t,e),o=Zue(n,r),i=new Uint32Array(n.cellOffsets.length),a=new Float32Array(n.cellSpheres.length),s=new Float32Array(n.cellInstance.length),l=0;for(let u=0,d=o.batchCell.length;u<d;++u){let m=o.batchCell[u],p=n.cellOffsets[m],f=n.cellOffsets[m+1]-p;i[u+1]=i[u]+f;for(let b=0;b<4;++b)a[u*4+b]=n.cellSpheres[m*4+b];for(let b=0;b<f;++b){let v=p+b,x=n.cellInstance[v];for(let S=0;S<16;++S)n.cellTransform[l*16+S]=t.transform[x*16+S];s[l]=x,l+=1}}return{cellSize:n.cellSize,cellCount:n.cellCount,cellOffsets:i,cellSpheres:a,cellTransform:n.cellTransform,cellInstance:s,batchSize:o.batchSize,batchCount:o.batchCount,batchOffsets:o.batchOffsets,batchSpheres:o.batchSpheres,batchCell:Ri(o.batchCell)}}function $ue(t,e){let{instanceCount:r,instance:n,transform:o,invariantBoundingSphere:i}=t,a=new Float32Array(r),s=new Float32Array(r),l=new Float32Array(r),c=we.ofBounds(0,r),u=qe.setEmpty(qe()),{center:d,radius:m}=i,p=y.create(m,m,m),h=y();for(let R=0;R<r;++R)HA(h,d,o,0,0,R*16),a[R]=h[0],s[R]=h[1],l[R]=h[2],WT(u,h);qe.expand(u,u,p);let f={x:a,y:s,z:l,indices:c},b={box:u,sphere:te.fromBox3D(te(),u)},v=pf(f,b,y.create(e,e,e)),{array:x,offset:S,count:T}=v.buckets,E=S.length,_=new Uint32Array(E+1),D=new Float32Array(E*4),P=new Float32Array(r*16),A=new Float32Array(r),I=qe(),k=te(),M=0;for(let R=0;R<E;++R){let B=S[R],F=T[R];_[R]=B;let G=M;for(let V=B,H=B+F;V<H;++V){let Q=x[V];A[M]=n[Q];for(let L=0;L<16;++L)P[M*16+L]=o[Q*16+L];M+=1}if(F===1)HA(D,d,P,R*4,0,G*16),D[R*4+3]=m;else{qe.setEmpty(I);let V=G*16;for(let H=0;H<F;++H)HA(h,d,P,0,0,H*16+V),WT(I,h);qe.expand(I,I,p),te.fromBox3D(k,I),te.toArray(k,D,R*4)}}return _[E]=S[E-1]+T[E-1],{cellSize:e,cellCount:E,cellOffsets:_,cellSpheres:D,cellTransform:P,cellInstance:A}}function Zue(t,e){let{cellCount:r,cellSpheres:n}=t,o=new Float32Array(r),i=new Float32Array(r),a=new Float32Array(r),s=we.ofBounds(0,r),l=qe.setEmpty(qe()),c=y(),u=0;for(let A=0;A<r;++A){let I=A*4;Kue(c,n,I),o[A]=c[0],i[A]=c[1],a[A]=c[2],WT(l,c),u=Math.max(u,n[I+3])}let d=y.create(u,u,u);qe.expand(l,l,d);let m={x:o,y:i,z:a,indices:s},p={box:l,sphere:te.fromBox3D(te(),l)},h=pf(m,p,y.create(e,e,e)),{array:f,offset:b,count:v}=h.buckets,x=b.length,S=new Uint32Array(x+1),T=new Float32Array(x*4),E=new Uint32Array(r),_=qe(),D=te(),P=0;for(let A=0;A<x;++A){let I=b[A],k=v[A];S[A]=I;for(let M=I,R=I+k;M<R;++M)E[P]=f[M],P+=1;if(k===1){let M=f[I];T[A*4]=n[M*4],T[A*4+1]=n[M*4+1],T[A*4+2]=n[M*4+2],T[A*4+3]=n[M*4+3]}else{qe.setEmpty(_),u=0;for(let M=I,R=I+k;M<R;++M){let B=f[M];c[0]=n[B*4],c[1]=n[B*4+1],c[2]=n[B*4+2],WT(_,c),u=Math.max(u,n[B*4+3])}y.set(d,u,u,u),qe.expand(_,_,d),te.fromBox3D(D,_),te.toArray(D,T,A*4)}}return S[x]=b[x-1]+v[x-1],{batchSize:e,batchCount:x,batchOffsets:S,batchSpheres:T,batchCell:E}}var hj=Dt(),Jue=W();function ede(t,e){for(let r=0;r<e;r++)if(Dt.fromMat4(hj,W.fromArray(Jue,t,r*16)),Dt.determinant(hj)<0)return!0;return!1}function Xx(t,e,r,n,o,i){let a=ede(t,e);if(i){C.update(i.matrix,i.matrix.ref.value);let s=i.transform.ref.value.length>=e*16?i.transform.ref.value:new Float32Array(e*16);s.set(t),C.update(i.transform,s),C.updateIfChanged(i.uInstanceCount,e),C.updateIfChanged(i.instanceCount,e);let l=i.aTransform.ref.value.length>=e*16?i.aTransform.ref.value:new Float32Array(e*16);C.update(i.aTransform,l);let c=i.extraTransform.ref.value.length>=e*16?i.extraTransform.ref.value:new Float32Array(e*16);C.update(i.extraTransform,E0(c,e));let u=i.aInstance.ref.value.length>=e?i.aInstance.ref.value:new Float32Array(e);C.update(i.aInstance,Ri(u,e)),C.update(i.hasReflection,a)}else i={aTransform:C.create(new Float32Array(e*16)),matrix:C.create(W.identity()),transform:C.create(new Float32Array(t)),extraTransform:C.create(E0(new Float32Array(e*16),e)),uInstanceCount:C.create(e),instanceCount:C.create(e),aInstance:C.create(Ri(new Float32Array(e))),hasReflection:C.create(a),instanceGrid:C.create(pj())};return WA(i,r,n,o),i}var qA=new Float32Array(16);W.toArray(W.identity(),qA,0);function I0(t){return Xx(new Float32Array(qA),1,void 0,0,0,t)}function E0(t,e){for(let r=0;r<e;r++)t.set(qA,r*16);return t}function WA(t,e,r,n){let o=t.aTransform.ref.value,i=t.aInstance.ref.value,a=t.instanceCount.ref.value,s=t.matrix.ref.value,l=t.transform.ref.value,c=t.extraTransform.ref.value;for(let u=0;u<a;u++){let d=u*16;W.mulOffset(o,c,l,d,d,d),W.mulOffset(o,s,o,d,0,d),i[u]=u}if(e&&a>0){let u=fj({instanceCount:a,instance:i,transform:o,invariantBoundingSphere:e},r,n);C.update(t.instanceGrid,u),C.update(t.aInstance,u.cellInstance),C.update(t.aTransform,u.cellTransform)}else C.update(t.aInstance,i),C.update(t.aTransform,o)}var ut={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflower:6591981,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,laserlemon:16777044,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrod:16448210,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,maroon2:8323072,maroon3:11546720,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,purple2:8323199,purple3:10494192,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},$ze=function(){let t=new Map;return Object.keys(ut).forEach(e=>{t.set(ut[e],e)}),t}();var zt={Atom:"Atom Property",Chain:"Chain Property",Residue:"Residue Property",Symmetry:"Symmetry",Validation:"Validation",Misc:"Miscellaneous"};var gj=ce(13421772),tde="Gives everything the same, uniform color.",ap={value:g.Color(gj),saturation:g.Numeric(0,{min:-6,max:6,step:.1}),lightness:g.Numeric(0,{min:-6,max:6,step:.1})};function rde(t){return ap}function ud(t,e){let r=li(e.value,gj);return r=ce.saturate(r,e.saturation),r=ce.lighten(r,e.lightness),{factory:ud,granularity:"uniform",color:()=>r,props:e,description:tde,legend:vs([["uniform",r]])}}var yj={name:"uniform",label:"Uniform",category:zt.Misc,factory:ud,getParams:rde,defaultValues:g.getDefaultValues(ap),isApplicable:t=>!0};var nde="Gives everything the same, uniform size.",vj={value:g.Numeric(1,{min:0,max:20,step:.1})};function ode(t){return vj}function XT(t,e){let r=e.value;return{factory:XT,granularity:"uniform",size:()=>r,props:e,description:nde}}var bj={name:"uniform",label:"Uniform",category:"",factory:XT,getParams:ode,defaultValues:g.getDefaultValues(vj),isApplicable:t=>!0};function Qo(t){return w(w({},Qo.Zero),t)}(function(t){t.Zero={metalness:0,roughness:0,bumpiness:0};function e(o,i,a){return i[a]=o.metalness*255,i[a+1]=o.roughness*255,i[a+2]=o.bumpiness*255,i}t.toArray=e;function r({metalness:o,roughness:i,bumpiness:a}){return`M ${o.toFixed(2)} | R ${i.toFixed(2)} | B ${a.toFixed(2)}`}t.toString=r;function n(o){return g.Group({metalness:g.Numeric(0,{min:0,max:1,step:.01}),roughness:g.Numeric(1,{min:0,max:1,step:.01}),bumpiness:g.Numeric(0,{min:0,max:1,step:.01})},U(w({},o),{presets:[[{metalness:0,roughness:1,bumpiness:0},"Matte"],[{metalness:0,roughness:.2,bumpiness:0},"Plastic"],[{metalness:0,roughness:.6,bumpiness:0},"Glossy"],[{metalness:1,roughness:.6,bumpiness:0},"Metallic"]]}))}t.getParam=n})(Qo||(Qo={}));function dd(){}(function(t){t.Type={none:0,plane:1,sphere:2,cube:3,cylinder:4,infiniteCone:5},t.Params={variant:g.Select("pixel",g.arrayToOptions(["instance","pixel"])),objects:g.ObjectList({type:g.Select("plane",g.objectToOptions(t.Type,l=>ic(l))),invert:g.Boolean(!1),position:g.Vec3(y()),rotation:g.Group({axis:g.Vec3(y.create(1,0,0)),angle:g.Numeric(0,{min:-180,max:180,step:1},{description:"Angle in Degrees"})},{isExpanded:!0}),scale:g.Vec3(y.create(1,1,1))},l=>ic(l.type))};function e(l){return{count:0,type:new Array(l).fill(1),invert:new Array(l).fill(!1),position:new Array(l*3).fill(0),rotation:new Array(l*4).fill(0),scale:new Array(l*3).fill(1)}}let r=xn(),n=xn(),o=y(),i=y();function a(l,c){let u=l.objects.length,{type:d,invert:m,position:p,rotation:h,scale:f}=c?.objects||e(u);for(let b=0;b<u;++b){let v=l.objects[b];d[b]=t.Type[v.type],m[b]=v.invert,y.toArray(v.position,p,b*3),xn.toArray(xn.setAxisAngle(r,v.rotation.axis,or(v.rotation.angle)),h,b*4),y.toArray(v.scale,f,b*3)}return{variant:l.variant,objects:{count:u,type:d,invert:m,position:p,rotation:h,scale:f}}}t.getClip=a;function s(l,c){if(l.variant!==c.variant||l.objects.count!==c.objects.count)return!1;let u=l.objects,d=c.objects;for(let m=0,p=u.count;m<p;++m)if(u.invert[m]!==d.invert[m]||u.type[m]!==d.type[m]||(y.fromArray(o,u.position,m*3),y.fromArray(i,d.position,m*3),!y.equals(o,i))||(y.fromArray(o,u.scale,m*3),y.fromArray(i,d.scale,m*3),!y.equals(o,i))||(xn.fromArray(r,u.rotation,m*4),xn.fromArray(n,d.rotation,m*4),!xn.equals(r,n)))return!1;return!0}t.areEqual=s})(dd||(dd={}));var ide={custom:{},auto:{},highest:{},higher:{},high:{},medium:{},low:{},lower:{},lowest:{}},ade=Object.keys(ide),Qx=g.arrayToOptions(ade),YT={smoothColors:g.MappedStatic("auto",{auto:g.Group({}),on:g.Group({resolutionFactor:g.Numeric(2,{min:.5,max:6,step:.1}),sampleStride:g.Numeric(3,{min:1,max:12,step:1})}),off:g.Group({})})};function El(t){return!!t.smoothColors}function os(t,e,r){if((t.name==="on"||t.name==="auto"&&e)&&r&&r<3){let n=3;return t.name==="on"?(r*=t.params.resolutionFactor,n=t.params.sampleStride):(r*=2-CT(0,1.1,r),r=Math.max(.5,r),r>1.2&&(n=2)),{resolution:r,stride:n}}}var ge;(function(t){t.MaterialCategory={category:"Material"},t.ShadingCategory={category:"Shading"},t.CullingLodCategory={category:"Culling & LOD"},t.CustomQualityParamInfo={category:"Custom Quality",hideIf:a=>typeof a.quality<"u"&&a.quality!=="custom"},t.Params={alpha:g.Numeric(1,{min:0,max:1,step:.01},{label:"Opacity",isEssential:!0,description:"How opaque/transparent the representation is rendered."}),quality:g.Select("auto",Qx,{isEssential:!0,description:"Visual/rendering quality of the representation."}),material:Qo.getParam(),clip:g.Group(dd.Params),emissive:g.Numeric(0,{min:0,max:1,step:.01}),instanceGranularity:g.Boolean(!1,{description:"Use instance granularity for marker, transparency, clipping, overpaint, substance data to save memory."}),lod:g.Vec3(y(),void 0,U(w({},t.CullingLodCategory),{description:"Level of detail.",fieldLabels:{x:"Min Distance",y:"Max Distance",z:"Overlap (Shader)"}})),cellSize:g.Numeric(200,{min:0,max:5e3,step:100},U(w({},t.CullingLodCategory),{description:"Instance grid cell size."})),batchSize:g.Numeric(2e3,{min:0,max:5e4,step:500},U(w({},t.CullingLodCategory),{description:"Instance grid batch size."}))};function e(a=ut.grey,s=1,l){l||(l=I0());let c=jt(1,l.instanceCount.ref.value,1,()=>Lo,!1,()=>!1),u={color:ud({},{value:a,lightness:0,saturation:0}),size:XT({},{value:s})};return{transform:l,locationIterator:c,theme:u}}t.createSimple=e;function r(a,s){let l=dd.getClip(a.clip);return{alpha:C.create(a.alpha),uAlpha:C.create(a.alpha),uVertexCount:C.create(s.vertexCount),uGroupCount:C.create(s.groupCount),drawCount:C.create(s.drawCount),uMetalness:C.create(a.material.metalness),uRoughness:C.create(a.material.roughness),uBumpiness:C.create(a.material.bumpiness),uEmissive:C.create(a.emissive),dLightCount:C.create(1),dColorMarker:C.create(!0),dClipObjectCount:C.create(l.objects.count),dClipVariant:C.create(l.variant),uClipObjectType:C.create(l.objects.type),uClipObjectInvert:C.create(l.objects.invert),uClipObjectPosition:C.create(l.objects.position),uClipObjectRotation:C.create(l.objects.rotation),uClipObjectScale:C.create(l.objects.scale),instanceGranularity:C.create(a.instanceGranularity),uLod:C.create(at.create(a.lod[0],a.lod[1],a.lod[2],0))}}t.createValues=r;function n(a,s){C.updateIfChanged(a.alpha,s.alpha),C.updateIfChanged(a.uMetalness,s.material.metalness),C.updateIfChanged(a.uRoughness,s.material.roughness),C.updateIfChanged(a.uBumpiness,s.material.bumpiness),C.updateIfChanged(a.uEmissive,s.emissive);let l=dd.getClip(s.clip);C.updateIfChanged(a.dClipObjectCount,l.objects.count),C.updateIfChanged(a.dClipVariant,l.variant),C.update(a.uClipObjectType,l.objects.type),C.update(a.uClipObjectInvert,l.objects.invert),C.update(a.uClipObjectPosition,l.objects.position),C.update(a.uClipObjectRotation,l.objects.rotation),C.update(a.uClipObjectScale,l.objects.scale),C.updateIfChanged(a.instanceGranularity,s.instanceGranularity),C.update(a.uLod,at.set(a.uLod.ref.value,s.lod[0],s.lod[1],s.lod[2],0))}t.updateValues=n;function o(a={}){let s=a.alpha===void 0?!0:a.alpha===1;return{disposed:!1,visible:!0,alphaFactor:1,pickable:!0,colorOnly:!1,opaque:s,writeDepth:s}}t.createRenderableState=o;function i(a,s){a.opaque=s.alpha*a.alphaFactor>=1,a.writeDepth=a.opaque}t.updateRenderableState=i})(ge||(ge={}));function Sj(t,e,r,n){for(let o=e;o<r;++o)ce.toArray(n,t,o*4),t[o*4+3]=255;return!0}function XA(t,e,r){return t.fill(0,e*4,r*4),!0}function Cj(t,e,r){let n=Zr(Math.max(1,t),4,Uint8Array,r&&r.tOverpaint.ref.value.array);return r?(C.update(r.tOverpaint,n),C.update(r.uOverpaintTexDim,ne.create(n.width,n.height)),C.updateIfChanged(r.dOverpaint,t>0),C.updateIfChanged(r.dOverpaintType,e),r):{tOverpaint:C.create(n),uOverpaintTexDim:C.create(ne.create(n.width,n.height)),dOverpaint:C.create(t>0),tOverpaintGrid:C.create(un()),uOverpaintGridDim:C.create(y.create(1,1,1)),uOverpaintGridTransform:C.create(at.create(0,0,0,1)),dOverpaintType:C.create(e),uOverpaintStrength:C.create(1)}}var xj={array:new Uint8Array(4),width:1,height:1};function ga(t){return t?(C.update(t.tOverpaint,xj),C.update(t.uOverpaintTexDim,ne.create(1,1)),t):{tOverpaint:C.create(xj),uOverpaintTexDim:C.create(ne.create(1,1)),dOverpaint:C.create(!1),tOverpaintGrid:C.create(un()),uOverpaintGridDim:C.create(y.create(1,1,1)),uOverpaintGridTransform:C.create(at.create(0,0,0,1)),dOverpaintType:C.create("groupInstance"),uOverpaintStrength:C.create(1)}}function wj(t,e,r,n){for(let o=e;o<r;++o)t[o]=n*255;return!0}function YA(t,e){if(e===0||t.length<e)return 0;let r=0;for(let n=0;n<e;++n)r+=t[n];return r/(255*e)}function _j(t,e,r){t.fill(0,e,r)}function Pj(t,e,r){let n=Zr(Math.max(1,t),1,Uint8Array,r&&r.tTransparency.ref.value.array);return r?(C.update(r.tTransparency,n),C.update(r.uTransparencyTexDim,ne.create(n.width,n.height)),C.updateIfChanged(r.dTransparency,t>0),C.updateIfChanged(r.transparencyAverage,YA(n.array,t)),C.updateIfChanged(r.dTransparencyType,e),r):{tTransparency:C.create(n),uTransparencyTexDim:C.create(ne.create(n.width,n.height)),dTransparency:C.create(t>0),transparencyAverage:C.create(0),tTransparencyGrid:C.create(un()),uTransparencyGridDim:C.create(y.create(1,1,1)),uTransparencyGridTransform:C.create(at.create(0,0,0,1)),dTransparencyType:C.create(e),uTransparencyStrength:C.create(1)}}var Tj={array:new Uint8Array(1),width:1,height:1};function ya(t){return t?(C.update(t.tTransparency,Tj),C.update(t.uTransparencyTexDim,ne.create(1,1)),t):{tTransparency:C.create(Tj),uTransparencyTexDim:C.create(ne.create(1,1)),dTransparency:C.create(!1),transparencyAverage:C.create(0),tTransparencyGrid:C.create(un()),uTransparencyGridDim:C.create(y.create(1,1,1)),uTransparencyGridTransform:C.create(at.create(0,0,0,1)),dTransparencyType:C.create("groupInstance"),uTransparencyStrength:C.create(1)}}function Ij(t,e,r,n){return t.fill(n,e,r),!0}function Dj(t,e,r){t.fill(0,e,r)}function Aj(t,e,r){let n=Zr(Math.max(1,t),1,Uint8Array,r&&r.tClipping.ref.value.array);return r?(C.update(r.tClipping,n),C.update(r.uClippingTexDim,ne.create(n.width,n.height)),C.updateIfChanged(r.dClipping,t>0),C.updateIfChanged(r.dClippingType,e),r):{tClipping:C.create(n),uClippingTexDim:C.create(ne.create(n.width,n.height)),dClipping:C.create(t>0),dClippingType:C.create(e)}}var Ej={array:new Uint8Array(1),width:1,height:1};function va(t){return t?(C.update(t.tClipping,Ej),C.update(t.uClippingTexDim,ne.create(1,1)),C.updateIfChanged(t.dClipping,!1),t):{tClipping:C.create(Ej),uClippingTexDim:C.create(ne.create(1,1)),dClipping:C.create(!1),dClippingType:C.create("groupInstance")}}function Mj(t,e,r,n){for(let o=e;o<r;++o)Qo.toArray(n,t,o*4),t[o*4+3]=255;return!0}function QA(t,e,r){return t.fill(0,e*4,r*4),!0}function Rj(t,e,r){let n=Zr(Math.max(1,t),4,Uint8Array,r&&r.tSubstance.ref.value.array);return r?(C.update(r.tSubstance,n),C.update(r.uSubstanceTexDim,ne.create(n.width,n.height)),C.updateIfChanged(r.dSubstance,t>0),C.updateIfChanged(r.dSubstanceType,e),r):{tSubstance:C.create(n),uSubstanceTexDim:C.create(ne.create(n.width,n.height)),dSubstance:C.create(t>0),tSubstanceGrid:C.create(un()),uSubstanceGridDim:C.create(y.create(1,1,1)),uSubstanceGridTransform:C.create(at.create(0,0,0,1)),dSubstanceType:C.create(e),uSubstanceStrength:C.create(1)}}var kj={array:new Uint8Array(4),width:1,height:1};function ba(t){return t?(C.update(t.tSubstance,kj),C.update(t.uSubstanceTexDim,ne.create(1,1)),t):{tSubstance:C.create(kj),uSubstanceTexDim:C.create(ne.create(1,1)),dSubstance:C.create(!1),tSubstanceGrid:C.create(un()),uSubstanceGridDim:C.create(y.create(1,1,1)),uSubstanceGridTransform:C.create(at.create(0,0,0,1)),dSubstanceType:C.create("groupInstance"),uSubstanceStrength:C.create(1)}}function Bj(t,e,r,n){for(let o=e;o<r;++o)t[o]=n*255;return!0}function KA(t,e){if(e===0||t.length<e)return 0;let r=0;for(let n=0;n<e;++n)r+=t[n];return r/(255*e)}function Oj(t,e,r){t.fill(0,e,r)}function Fj(t,e,r){let n=Zr(Math.max(1,t),1,Uint8Array,r&&r.tEmissive.ref.value.array);return r?(C.update(r.tEmissive,n),C.update(r.uEmissiveTexDim,ne.create(n.width,n.height)),C.updateIfChanged(r.dEmissive,t>0),C.updateIfChanged(r.emissiveAverage,KA(n.array,t)),C.updateIfChanged(r.dEmissiveType,e),r):{tEmissive:C.create(n),uEmissiveTexDim:C.create(ne.create(n.width,n.height)),dEmissive:C.create(t>0),emissiveAverage:C.create(0),tEmissiveGrid:C.create(un()),uEmissiveGridDim:C.create(y.create(1,1,1)),uEmissiveGridTransform:C.create(at.create(0,0,0,1)),dEmissiveType:C.create(e),uEmissiveStrength:C.create(1)}}var Lj={array:new Uint8Array(1),width:1,height:1};function xa(t){return t?(C.update(t.tEmissive,Lj),C.update(t.uEmissiveTexDim,ne.create(1,1)),t):{tEmissive:C.create(Lj),uEmissiveTexDim:C.create(ne.create(1,1)),dEmissive:C.create(!1),emissiveAverage:C.create(0),tEmissiveGrid:C.create(un()),uEmissiveGridDim:C.create(y.create(1,1,1)),uEmissiveGridTransform:C.create(at.create(0,0,0,1)),dEmissiveType:C.create("groupInstance"),uEmissiveStrength:C.create(1)}}var Be;(function(t){function e(k,M,R,B,F,G,V){return V?i(k,M,R,B,F,G,V):o(k,M,R,B,F,G)}t.create=e;function r(k){let M=k?k.vertexBuffer.ref.value:new Float32Array(0),R=k?k.indexBuffer.ref.value:new Uint32Array(0),B=k?k.normalBuffer.ref.value:new Float32Array(0),F=k?k.groupBuffer.ref.value:new Float32Array(0);return e(M,R,B,F,0,0,k)}t.createEmpty=r;function n(k){return Ai([k.vertexCount,k.triangleCount,k.vertexBuffer.ref.version,k.indexBuffer.ref.version,k.normalBuffer.ref.version,k.groupBuffer.ref.version])}function o(k,M,R,B,F,G){let V=te(),H,Q=-1,L=-1,Y={kind:"mesh",vertexCount:F,triangleCount:G,vertexBuffer:C.create(k),indexBuffer:C.create(M),normalBuffer:C.create(R),groupBuffer:C.create(B),varyingGroup:C.create(!1),get boundingSphere(){let j=n(Y);if(j!==Q){let O=Pl(Y.vertexBuffer.ref.value,Y.vertexCount,1);te.copy(V,O),Q=j}return V},get groupMapping(){return Y.groupBuffer.ref.version!==L&&(H=Zc(Y.groupBuffer.ref.value,Y.vertexCount),L=Y.groupBuffer.ref.version),H},setBoundingSphere(j){te.copy(V,j),Q=n(Y)},meta:{}};return Y}function i(k,M,R,B,F,G,V){return V.vertexCount=F,V.triangleCount=G,C.update(V.vertexBuffer,k),C.update(V.indexBuffer,M),C.update(V.normalBuffer,R),C.update(V.groupBuffer,B),V}function a(k){let{vertexCount:M,triangleCount:R}=k,B=k.vertexBuffer.ref.value,F=k.indexBuffer.ref.value,G=k.normalBuffer.ref.value.length>=M*3?k.normalBuffer.ref.value:new Float32Array(M*3);G===k.normalBuffer.ref.value&&G.fill(0,0,M*3),OT(B,F,G,M,R),C.update(k.normalBuffer,G)}t.computeNormals=a;function s(k,M=3){let R=k.vertexBuffer.ref.value,B=new Map,F=(H,Q)=>`${H[0].toFixed(Q)}|${H[1].toFixed(Q)}|${H[2].toFixed(Q)}`,G=0,V=y();for(let H=0,Q=k.vertexCount;H<Q;++H){y.fromArray(V,R,H*3);let L=F(V,M),Y=B.get(L);Y!==void 0?(G+=1,B.set(L,Y+1)):B.set(L,1)}return G}t.checkForDuplicateVertices=s;let l=Dt();function c(k,M){let R=k.vertexBuffer.ref.value;if($c(M,R,0,k.vertexCount),!W.isTranslationAndUniformScaling(M)){let B=Dt.directionTransform(l,M);MU(B,k.normalBuffer.ref.value,0,k.vertexCount)}C.update(k.vertexBuffer,R)}t.transform=c;function u(k){let{originalData:M}="kind"in k?k.meta:k.meta.ref.value;return M}t.getOriginalData=u;function d(k,M=!0){let{indexBuffer:R,vertexBuffer:B,groupBuffer:F,normalBuffer:G,triangleCount:V,vertexCount:H}=k,Q=R.ref.value,L=B.ref.value,Y=F.ref.value,j=G.ref.value,O=he.create(Uint32Array,3,1024,V),J=he.create(Float32Array,3,1024,L);J.currentIndex=H*3,J.elementCount=H;let $=he.create(Float32Array,3,1024,j);$.currentIndex=H*3,$.elementCount=H;let ae=he.create(Float32Array,1,1024,Y);ae.currentIndex=H,ae.elementCount=H;let Z=y(),se=y(),Me=y(),be=y(),_e=y(),je=y();function gt(Ve){y.fromArray(Z,L,Ve*3),y.fromArray(be,j,Ve*3),he.add3(J,Z[0],Z[1],Z[2]),he.add3($,be[0],be[1],be[2])}function fr(Ve,It){y.fromArray(Z,L,Ve*3),y.fromArray(se,L,It*3),y.scale(Z,y.add(Z,Z,se),.5),y.fromArray(be,j,Ve*3),y.fromArray(_e,j,It*3),y.scale(be,y.add(be,be,_e),.5),he.add3(J,Z[0],Z[1],Z[2]),he.add3($,be[0],be[1],be[2])}function Nr(Ve,It,yt){y.fromArray(Z,L,Ve*3),y.fromArray(se,L,It*3),y.fromArray(Me,L,yt*3),y.scale(Z,y.add(Z,y.add(Z,Z,se),Me),1/3),y.fromArray(be,j,Ve*3),y.fromArray(_e,j,It*3),y.fromArray(je,j,yt*3),y.scale(be,y.add(be,y.add(be,be,_e),je),1/3),he.add3(J,Z[0],Z[1],Z[2]),he.add3($,be[0],be[1],be[2])}function Zt(Ve,It,yt,pe,Ae){++De,gt(Ve),fr(Ve,It),fr(Ve,yt),he.add3(O,oe,oe+1,oe+2);for(let $e=0;$e<3;++$e)he.add(ae,pe);oe+=3,De+=2,gt(It),gt(yt),fr(Ve,It),fr(Ve,yt),he.add3(O,oe,oe+1,oe+3),he.add3(O,oe,oe+3,oe+2);for(let $e=0;$e<4;++$e)he.add(ae,Ae);oe+=4}let oe=H,De=0;if(M)for(let Ve=0,It=V;Ve<It;++Ve){let yt=Q[Ve*3],pe=Q[Ve*3+1],Ae=Q[Ve*3+2],$e=Y[yt],ft=Y[pe],Pt=Y[Ae];if($e===ft&&$e===Pt)++De,he.add3(O,yt,pe,Ae);else if($e===ft)Zt(Ae,yt,pe,Pt,$e);else if($e===Pt)Zt(pe,Ae,yt,ft,Pt);else if(ft===Pt)Zt(yt,pe,Ae,$e,ft);else{De+=2,gt(yt),fr(yt,pe),fr(yt,Ae),Nr(yt,pe,Ae),he.add3(O,oe,oe+1,oe+3),he.add3(O,oe,oe+3,oe+2);for(let yr=0;yr<4;++yr)he.add(ae,$e);oe+=4,De+=2,gt(pe),fr(pe,Ae),fr(pe,yt),Nr(yt,pe,Ae),he.add3(O,oe,oe+1,oe+3),he.add3(O,oe,oe+3,oe+2);for(let yr=0;yr<4;++yr)he.add(ae,ft);oe+=4,De+=2,gt(Ae),fr(Ae,pe),fr(Ae,yt),Nr(yt,pe,Ae),he.add3(O,oe+3,oe+1,oe),he.add3(O,oe+2,oe+3,oe);for(let yr=0;yr<4;++yr)he.add(ae,Pt);oe+=4}}else for(let Ve=0,It=V;Ve<It;++Ve){let yt=Q[Ve*3],pe=Q[Ve*3+1],Ae=Q[Ve*3+2],$e=Y[yt],ft=Y[pe],Pt=Y[Ae];if($e!==ft||$e!==Pt){++De,gt(yt),gt(pe),gt(Ae),he.add3(O,oe,oe+1,oe+2);let yr=ft===Pt?ft:$e;for(let Ze=0;Ze<3;++Ze)he.add(ae,yr);oe+=3}else++De,he.add3(O,yt,pe,Ae)}let Le=he.compact(O),Qe=he.compact(J),Ue=he.compact($),Ke=he.compact(ae);return k.vertexCount=oe,k.triangleCount=De,C.update(B,Qe),C.update(F,Ke),C.update(R,Le),C.update(G,Ue),k.meta.originalData={indexBuffer:Q,vertexCount:H,triangleCount:V},k}t.uniformTriangleGroup=d;function m(k){let{vertexCount:M,triangleCount:R}=k,B=k.indexBuffer.ref.value,F=[];for(let G=0;G<M;++G)F[G]=[];for(let G=0;G<R;++G){let V=B[G*3],H=B[G*3+1],Q=B[G*3+2];Mo(F[V],H),Mo(F[V],Q),Mo(F[H],V),Mo(F[H],Q),Mo(F[Q],V),Mo(F[Q],H)}return F}function p(k){let{triangleCount:M}=k,R=k.indexBuffer.ref.value,B=new Map,F=(G,V)=>{let H=Lx(G,V),Q=B.get(H)||0;B.set(H,Q+1)};for(let G=0;G<M;++G){let V=R[G*3],H=R[G*3+1],Q=R[G*3+2];F(V,H),F(V,Q),F(H,Q)}return B}function h(k){let M=new Set,R=[0,0];return k.forEach((B,F)=>{B===1&&(TT(R,F),M.add(R[0]),M.add(R[1]))}),M}function f(k,M,R){let B=new Map,F=(G,V)=>{B.has(G)?Mo(B.get(G),V):B.set(G,[V])};return M.forEach(G=>{let V=k[G];for(let H of V)M.has(H)&&R.get(Lx(G,H))===1&&F(G,H)}),B}function b(k,M){let{indexBuffer:R,triangleCount:B}=k,F=R.ref.value,G=he.create(Uint32Array,3,1024,B),V=0;for(let Q=0;Q<B;++Q){let L=F[Q*3],Y=F[Q*3+1],j=F[Q*3+2];M[L].length===2||M[Y].length===2||M[j].length===2||(he.add3(G,L,Y,j),V+=1)}let H=he.compact(G);return k.triangleCount=V,C.update(R,H),k}function v(k,M,R,B){var F;let{vertexBuffer:G,indexBuffer:V,normalBuffer:H,triangleCount:Q}=k,L=G.ref.value,Y=V.ref.value,j=H.ref.value,O=he.create(Uint32Array,3,1024,Q),J=0;for(let Le=0;Le<Q;++Le)he.add3(O,Y[Le*3],Y[Le*3+1],Y[Le*3+2]),J+=1;let $=y(),ae=y(),Z=y(),se=y(),Me=y(),be=y(),_e=y(),je=y(),gt=y(),fr=y(),Nr=or(120),Zt=new Set,oe=Array.from(R.keys()).filter(Le=>R.get(Le).length<2).map(Le=>{let Qe=R.get(Le);return y.fromArray($,L,Le*3),y.fromArray(ae,L,Qe[0]*3),y.fromArray(Z,L,Qe[1]*3),y.sub(Me,ae,$),y.sub(be,Z,$),[Le,y.angle(Me,be)]});oe.sort(([,Le],[,Qe])=>Le-Qe);for(let[Le,Qe]of oe){if(Zt.has(Le)||Qe>Nr)continue;let Ue=R.get(Le);if(M[Ue[0]].includes(Ue[1])&&!(!((F=R.get(Ue[0]))===null||F===void 0)&&F.includes(Ue[1]))||(y.fromArray($,L,Le*3),y.fromArray(ae,L,Ue[0]*3),y.fromArray(Z,L,Ue[1]*3),y.sub(Me,ae,$),y.sub(be,Z,$),y.add(je,Me,be),y.squaredDistance($,ae)>=B))continue;let Ke=!1;for(let Ve of M[Le])if(!Ue.includes(Ve)&&(y.fromArray(se,L,Ve*3),y.sub(_e,se,$),y.dot(je,_e)<0)){Ke=!0;break}Ke&&(y.fromArray(gt,j,Le*3),y.triangleNormal(fr,$,ae,Z),y.dot(fr,gt)>0?he.add3(O,Le,Ue[0],Ue[1]):he.add3(O,Ue[1],Ue[0],Le),Zt.add(Le),Zt.add(Ue[0]),Zt.add(Ue[1]),J+=1)}let De=he.compact(O);return k.triangleCount=J,C.update(V,De),k}function x(k,M,R){let{iterations:B,lambda:F}=R,G=y(),V=y(),H=y(),Q=y(),L=-F,Y=new Float32Array(k.vertexBuffer.ref.value.length),j=O=>{let J=k.vertexBuffer.ref.value;Y.set(J),M.forEach((ae,Z)=>{if(ae.length!==2)return;y.fromArray(G,J,Z*3),y.fromArray(V,J,ae[0]*3),y.fromArray(H,J,ae[1]*3);let se=1/y.distance(G,V),Me=1/y.distance(G,H);y.scale(V,V,se),y.scale(H,H,Me),y.add(Q,V,H),y.scale(Q,Q,1/(se+Me)),y.sub(Q,Q,G),y.scale(Q,Q,O),y.add(Q,G,Q),y.toArray(Q,Y,Z*3)});let $=k.vertexBuffer.ref.value;C.update(k.vertexBuffer,Y),Y=$};for(let O=0;O<B;++O)j(F),j(L)}function S(k,M){b(k,m(k));for(let V=0;V<10;++V){let H=k.triangleCount,Q=p(k),L=m(k),Y=h(Q),j=f(L,Y,Q);if(v(k,L,j,M.maxNewEdgeLength*M.maxNewEdgeLength),k.triangleCount===H)break}let R=p(k),B=m(k),F=h(R),G=f(B,F,R);return x(k,G,{iterations:M.iterations,lambda:.5}),k}t.smoothEdges=S,t.Params=U(w({},ge.Params),{doubleSided:g.Boolean(!1,ge.CustomQualityParamInfo),flipSided:g.Boolean(!1,ge.ShadingCategory),flatShaded:g.Boolean(!1,ge.ShadingCategory),ignoreLight:g.Boolean(!1,ge.ShadingCategory),xrayShaded:g.Select(!1,[[!1,"Off"],[!0,"On"],["inverted","Inverted"]],ge.ShadingCategory),transparentBackfaces:g.Select("off",g.arrayToOptions(["off","on","opaque"]),ge.ShadingCategory),bumpFrequency:g.Numeric(0,{min:0,max:10,step:.1},ge.ShadingCategory),bumpAmplitude:g.Numeric(1,{min:0,max:5,step:.1},ge.ShadingCategory)}),t.Utils={Params:t.Params,createEmpty:r,createValues:E,createValuesSimple:_,updateValues:D,updateBoundingSphere:P,createRenderableState:A,updateRenderableState:I,createPositionIterator:T};function T(k,M){let R=k.vertexCount,B=M.instanceCount.ref.value,F=Ss(),G=F.position,V=F.normal,H=k.vertexBuffer.ref.value,Q=k.normalBuffer.ref.value,L=M.aTransform.ref.value;return jt(R,B,1,(j,O)=>(O<0?(y.fromArray(G,H,j*3),y.fromArray(V,Q,j*3)):(y.transformMat4Offset(G,H,L,0,j*3,O*16),y.transformDirectionOffset(V,Q,L,0,j*3,O*16)),F))}function E(k,M,R,B,F){let{instanceCount:G,groupCount:V}=R,H=T(k,M),Q=uo(R,H,B.color),L=F.instanceGranularity?jr(G,"instance"):jr(G*V,"groupInstance"),Y=ga(),j=ya(),O=xa(),J=ba(),$=va(),ae={drawCount:k.triangleCount*3,vertexCount:k.vertexCount,groupCount:V,instanceCount:G},Z=te.clone(k.boundingSphere),se=Hn(Z,M.aTransform.ref.value,G,0);return U(w(w(w(w(w(w(w(w(w({dGeometryType:C.create("mesh"),aPosition:k.vertexBuffer,aNormal:k.normalBuffer,aGroup:k.groupBuffer,elements:k.indexBuffer,dVaryingGroup:k.varyingGroup,boundingSphere:C.create(se),invariantBoundingSphere:C.create(Z),uInvariantBoundingSphere:C.create(at.ofSphere(Z))},Q),L),Y),j),O),J),$),M),ge.createValues(F,ae)),{uDoubleSided:C.create(F.doubleSided),dFlatShaded:C.create(F.flatShaded),dFlipSided:C.create(F.flipSided),dIgnoreLight:C.create(F.ignoreLight),dXrayShaded:C.create(F.xrayShaded==="inverted"?"inverted":F.xrayShaded===!0?"on":"off"),dTransparentBackfaces:C.create(F.transparentBackfaces),uBumpFrequency:C.create(F.bumpFrequency),uBumpAmplitude:C.create(F.bumpAmplitude),meta:C.create(k.meta)})}function _(k,M,R,B,F){let G=ge.createSimple(R,B,F),V=w(w({},g.getDefaultValues(t.Params)),M);return E(k,G.transform,G.locationIterator,G.theme,V)}function D(k,M){ge.updateValues(k,M),C.updateIfChanged(k.uDoubleSided,M.doubleSided),C.updateIfChanged(k.dFlatShaded,M.flatShaded),C.updateIfChanged(k.dFlipSided,M.flipSided),C.updateIfChanged(k.dIgnoreLight,M.ignoreLight),C.updateIfChanged(k.dXrayShaded,M.xrayShaded==="inverted"?"inverted":M.xrayShaded===!0?"on":"off"),C.updateIfChanged(k.dTransparentBackfaces,M.transparentBackfaces),C.updateIfChanged(k.uBumpFrequency,M.bumpFrequency),C.updateIfChanged(k.uBumpAmplitude,M.bumpAmplitude)}function P(k,M){let R=te.clone(M.boundingSphere),B=Hn(R,k.aTransform.ref.value,k.instanceCount.ref.value,0);te.equals(B,k.boundingSphere.ref.value)||C.update(k.boundingSphere,B),te.equals(R,k.invariantBoundingSphere.ref.value)||(C.update(k.invariantBoundingSphere,R),C.update(k.uInvariantBoundingSphere,at.fromSphere(k.uInvariantBoundingSphere.ref.value,R)))}function A(k){let M=ge.createRenderableState(k);return I(M,k),M}function I(k,M){ge.updateRenderableState(k,M),k.opaque=k.opaque&&!M.xrayShaded,k.writeDepth=k.opaque}})(Be||(Be={}));function vf(t,e,r){return t=Wo(Math.round(t),0,16777215)+1,e[r+2]=t%256,t=Math.floor(t/256),e[r+1]=t%256,t=Math.floor(t/256),e[r]=t%256,e}function Ig(t,e,r){return Math.floor(t)*256*256+Math.floor(e)*256+Math.floor(r)-1}var QT=255/256,$A=y.create(256*256*256,256*256,256),sde=at.create(QT/$A[0],QT/$A[1],QT/$A[2],QT/1),Nj=at();function Vj(t,e,r,n){return at.set(Nj,t/255,e/255,r/255,n/255),at.dot(Nj,sde)}function Sa(t,e,r){switch(eo.getGranularity(t,e.granularity)){case"uniform":return dde(t,e.size,r);case"group":return pde(t,e.size,r);case"groupInstance":return fde(t,e.size,r);case"instance":return mde(t,e.size,r)}}var KT=100;function bf(t){switch(t.dSizeType.ref.value){case"uniform":return t.uSize.ref.value;case"instance":case"group":case"groupInstance":let r=0,n=t.tSize.ref.value.array;for(let o=0,i=n.length;o<i;o+=3){let a=Ig(n[o],n[o+1],n[o+2]);r<a&&(r=a)}return r/KT}}var lde={array:new Uint8Array(3),width:1,height:1};function cde(){return{tSize:C.create(lde),uSizeTexDim:C.create(ne.create(1,1))}}function ude(t,e){return e?(C.update(e.uSize,t),C.updateIfChanged(e.dSizeType,"uniform"),e):U(w({uSize:C.create(t)},cde()),{dSizeType:C.create("uniform")})}function dde(t,e,r){return ude(e(Lo),r)}function ZA(t,e,r){return r?(C.update(r.tSize,t),C.update(r.uSizeTexDim,ne.create(t.width,t.height)),C.updateIfChanged(r.dSizeType,e),r):{uSize:C.create(0),tSize:C.create(t),uSizeTexDim:C.create(ne.create(t.width,t.height)),dSizeType:C.create(e)}}function mde(t,e,r){let{instanceCount:n}=t,o=Zr(Math.max(1,n),3,Uint8Array,r&&r.tSize.ref.value.array);for(t.reset();t.hasNext&&!t.isNextNewInstance;){let i=t.move();vf(e(i.location)*KT,o.array,i.instanceIndex*3),t.skipInstance()}return ZA(o,"instance",r)}function pde(t,e,r){let{groupCount:n}=t,o=Zr(Math.max(1,n),3,Uint8Array,r&&r.tSize.ref.value.array);for(t.reset();t.hasNext&&!t.isNextNewInstance;){let i=t.move();vf(e(i.location)*KT,o.array,i.groupIndex*3)}return ZA(o,"group",r)}function fde(t,e,r){let{groupCount:n,instanceCount:o}=t,i=o*n,a=Zr(Math.max(1,i),3,Uint8Array,r&&r.tSize.ref.value.array);for(t.reset();t.hasNext;){let s=t.move();vf(e(s.location)*KT,a.array,s.index*3)}return ZA(a,"groupInstance",r)}var Il;(function(t){function e(h,f,b,v){return v?i(h,f,b,v):o(h,f,b)}t.create=e;function r(h){let f=h?h.centerBuffer.ref.value:new Float32Array(0),b=h?h.groupBuffer.ref.value:new Float32Array(0);return e(f,b,0,h)}t.createEmpty=r;function n(h){return Ai([h.pointCount,h.centerBuffer.ref.version,h.groupBuffer.ref.version])}function o(h,f,b){let v=te(),x,S=-1,T=-1,E={kind:"points",pointCount:b,centerBuffer:C.create(h),groupBuffer:C.create(f),get boundingSphere(){let _=n(E);if(_!==S){let D=Pl(E.centerBuffer.ref.value,E.pointCount,1);te.copy(v,D),S=_}return v},get groupMapping(){return E.groupBuffer.ref.version!==T&&(x=Zc(E.groupBuffer.ref.value,E.pointCount),T=E.groupBuffer.ref.version),x},setBoundingSphere(_){te.copy(v,_),S=n(E)}};return E}function i(h,f,b,v){return v.pointCount=b,C.update(v.centerBuffer,h),C.update(v.groupBuffer,f),v}function a(h,f){let b=h.centerBuffer.ref.value;$c(f,b,0,h.pointCount),C.update(h.centerBuffer,b)}t.transform=a,t.StyleTypes={square:"Square",circle:"Circle",fuzzy:"Fuzzy"},t.StyleTypeNames=Object.keys(t.StyleTypes),t.Params=U(w({},ge.Params),{sizeFactor:g.Numeric(3,{min:0,max:10,step:.1}),pointSizeAttenuation:g.Boolean(!1),pointStyle:g.Select("square",g.objectToOptions(t.StyleTypes))}),t.Utils={Params:t.Params,createEmpty:r,createValues:l,createValuesSimple:c,updateValues:u,updateBoundingSphere:d,createRenderableState:m,updateRenderableState:p,createPositionIterator:s};function s(h,f){let b=h.pointCount,v=f.instanceCount.ref.value,x=Ss(),S=x.position,T=h.centerBuffer.ref.value,E=f.aTransform.ref.value;return jt(b,v,1,(D,P)=>(P<0?y.fromArray(S,T,D*3):y.transformMat4Offset(S,T,E,0,D*3,P*16),x))}function l(h,f,b,v,x){let{instanceCount:S,groupCount:T}=b,E=s(h,f),_=uo(b,E,v.color),D=Sa(b,v.size),P=x.instanceGranularity?jr(S,"instance"):jr(S*T,"groupInstance"),A=ga(),I=ya(),k=xa(),M=ba(),R=va(),B={drawCount:h.pointCount,vertexCount:h.pointCount,groupCount:T,instanceCount:S},F=te.clone(h.boundingSphere),G=Hn(F,f.aTransform.ref.value,S,0);return U(w(w(w(w(w(w(w(w(w(w({dGeometryType:C.create("points"),aPosition:h.centerBuffer,aGroup:h.groupBuffer,boundingSphere:C.create(G),invariantBoundingSphere:C.create(F),uInvariantBoundingSphere:C.create(at.ofSphere(F))},_),D),P),A),I),k),M),R),f),ge.createValues(x,B)),{uSizeFactor:C.create(x.sizeFactor),dPointSizeAttenuation:C.create(x.pointSizeAttenuation),dPointStyle:C.create(x.pointStyle)})}function c(h,f,b,v,x){let S=ge.createSimple(b,v,x),T=w(w({},g.getDefaultValues(t.Params)),f);return l(h,S.transform,S.locationIterator,S.theme,T)}function u(h,f){ge.updateValues(h,f),C.updateIfChanged(h.uSizeFactor,f.sizeFactor),C.updateIfChanged(h.dPointSizeAttenuation,f.pointSizeAttenuation),C.updateIfChanged(h.dPointStyle,f.pointStyle)}function d(h,f){let b=te.clone(f.boundingSphere),v=Hn(b,h.aTransform.ref.value,h.instanceCount.ref.value,0);te.equals(v,h.boundingSphere.ref.value)||C.update(h.boundingSphere,v),te.equals(b,h.invariantBoundingSphere.ref.value)||(C.update(h.invariantBoundingSphere,b),C.update(h.uInvariantBoundingSphere,at.fromSphere(h.uInvariantBoundingSphere.ref.value,b)))}function m(h){let f=ge.createRenderableState(h);return p(f,h),f}function p(h,f){ge.updateRenderableState(h,f),h.opaque=h.opaque&&f.pointStyle!=="fuzzy",h.writeDepth=h.opaque}})(Il||(Il={}));function JA(t,e,r,n,o,i,a){for(let s=0;s<e;s++){for(let l=0;l<r;l++)n[l]=t[l*e+s];zj(n,o,i,a,r);for(let l=0;l<r;l++)t[l*e+s]=o[l]}for(let s=0;s<r;s++){for(let l=0;l<e;l++)n[l]=t[s*e+l];zj(n,o,i,a,e);for(let l=0;l<e;l++)t[s*e+l]=Math.sqrt(o[l])}}function zj(t,e,r,n,o){r[0]=0,n[0]=Number.MIN_SAFE_INTEGER,n[1]=Number.MAX_SAFE_INTEGER;for(let i=1,a=0;i<o;i++){let s=(t[i]+i*i-(t[r[a]]+r[a]*r[a]))/(2*i-2*r[a]);for(;s<=n[a];)a--,s=(t[i]+i*i-(t[r[a]]+r[a]*r[a]))/(2*i-2*r[a]);a++,r[a]=i,n[a]=s,n[a+1]=Number.MAX_SAFE_INTEGER}for(let i=0,a=0;i<o;i++){for(;n[a+1]<i;)a++;e[i]=(i-r[a])*(i-r[a])+t[r[a]]}}var ek={};function Gj(t){let e=JSON.stringify(t);return ek[e]===void 0&&(ek[e]=new tk(t)),ek[e]}var rk={fontFamily:g.Select("sans-serif",[["sans-serif","Sans Serif"],["monospace","Monospace"],["serif","Serif"],["cursive","Cursive"]]),fontQuality:g.Select(3,[[0,"lower"],[1,"low"],[2,"medium"],[3,"high"],[4,"higher"]]),fontStyle:g.Select("normal",[["normal","Normal"],["italic","Italic"],["oblique","Oblique"]]),fontVariant:g.Select("normal",[["normal","Normal"],["small-caps","Small Caps"]]),fontWeight:g.Select("normal",[["normal","Normal"],["bold","Bold"]])},tk=class{constructor(e={}){this.mapped={},this.scratchW=0,this.scratchH=0,this.currentX=0,this.currentY=0,this.cutoff=.5;let r=w(w({},g.getDefaultValues(rk)),e);this.props=r;let n=32*(r.fontQuality+1);this.buffer=n/8,this.radius=n/3,this.lineHeight=Math.round(n+2*this.buffer+this.radius),this.maxWidth=Math.round(this.lineHeight*.75),this.texture=Zr(350*this.lineHeight*this.maxWidth,1,Uint8Array),this.scratchContext=gde(this.maxWidth,this.lineHeight,{willReadFrequently:!0}),this.scratchContext.font=`${r.fontStyle} ${r.fontVariant} ${r.fontWeight} ${n}px ${r.fontFamily}`,this.scratchContext.fillStyle="black",this.scratchContext.textBaseline="middle",this.scratchData=new Uint8Array(this.lineHeight*this.maxWidth),this.gridOuter=new Float64Array(this.lineHeight*this.maxWidth),this.gridInner=new Float64Array(this.lineHeight*this.maxWidth),this.f=new Float64Array(Math.max(this.lineHeight,this.maxWidth)),this.d=new Float64Array(Math.max(this.lineHeight,this.maxWidth)),this.z=new Float64Array(Math.max(this.lineHeight,this.maxWidth)+1),this.v=new Int16Array(Math.max(this.lineHeight,this.maxWidth)),this.middle=Math.ceil(this.lineHeight/2),this.placeholder=this.get("\uFFFD")}get(e){if(this.mapped[e]===void 0){this.draw(e);let{array:r,width:n,height:o}=this.texture,i=this.scratchData;if(this.currentX+this.scratchW>n&&(this.currentX=0,this.currentY+=this.scratchH),this.currentY+this.scratchH>o)return console.warn("canvas to small"),this.placeholder;this.mapped[e]={x:this.currentX,y:this.currentY,w:this.scratchW,h:this.scratchH,nw:this.scratchW/this.lineHeight,nh:this.scratchH/this.lineHeight};for(let a=0;a<this.scratchH;++a)for(let s=0;s<this.scratchW;++s)r[n*(this.currentY+a)+this.currentX+s]=i[a*this.scratchW+s];this.currentX+=this.scratchW}return this.mapped[e]}draw(e){let r=this.lineHeight,n=this.scratchContext,o=this.scratchData,i=n.measureText(e),a=Math.min(this.maxWidth,Math.ceil(i.width+2*this.buffer)),s=a*r;n.clearRect(0,0,a,r),n.fillText(e,this.buffer,this.middle);let l=n.getImageData(0,0,a,r);for(let c=0;c<s;c++){let u=l.data[c*4+3]/255;this.gridOuter[c]=u===1?0:u===0?Number.MAX_SAFE_INTEGER:Math.pow(Math.max(0,.5-u),2),this.gridInner[c]=u===1?Number.MAX_SAFE_INTEGER:u===0?0:Math.pow(Math.max(0,u-.5),2)}JA(this.gridOuter,a,r,this.f,this.d,this.v,this.z),JA(this.gridInner,a,r,this.f,this.d,this.v,this.z);for(let c=0;c<s;c++){let u=this.gridOuter[c]-this.gridInner[c];o[c]=Math.max(0,Math.min(255,Math.round(255-255*(u/this.radius+this.cutoff))))}this.scratchW=a,this.scratchH=r}},Uj;function hde(){if(!Uj)throw new Error("When running in Node.js and wanting to use Canvas API, call mol-util/data-source's setCanvasModule function first and pass imported `canvas` module to it.");return Uj}function gde(t,e,r){if(TU)return hde().createCanvas(t,e).getContext("2d",r);{let n=document.createElement("canvas");return n.width=t,n.height=e,n.getContext("2d",r)}}var Bo;(function(t){function e(p,h,f,b,v,x,S,T,E){return E?i(p,h,f,b,v,x,S,T,E):o(p,h,f,b,v,x,S,T)}t.create=e;function r(p){let h=p?p.fontTexture.ref.value:Zr(0,1,Uint8Array),f=p?p.centerBuffer.ref.value:new Float32Array(0),b=p?p.mappingBuffer.ref.value:new Float32Array(0),v=p?p.depthBuffer.ref.value:new Float32Array(0),x=p?p.indexBuffer.ref.value:new Uint32Array(0),S=p?p.groupBuffer.ref.value:new Float32Array(0),T=p?p.tcoordBuffer.ref.value:new Float32Array(0);return e(h,f,b,v,x,S,T,0,p)}t.createEmpty=r;function n(p){return Ai([p.charCount,p.fontTexture.ref.version,p.centerBuffer.ref.version,p.mappingBuffer.ref.version,p.depthBuffer.ref.version,p.indexBuffer.ref.version,p.groupBuffer.ref.version,p.tcoordBuffer.ref.version])}function o(p,h,f,b,v,x,S,T){let E=te(),_,D=-1,P=-1,A={kind:"text",charCount:T,fontTexture:C.create(p),centerBuffer:C.create(h),mappingBuffer:C.create(f),depthBuffer:C.create(b),indexBuffer:C.create(v),groupBuffer:C.create(x),tcoordBuffer:C.create(S),get boundingSphere(){let I=n(A);if(I!==D){let k=Pl(A.centerBuffer.ref.value,A.charCount*4,4);te.copy(E,k),D=I}return E},get groupMapping(){return A.groupBuffer.ref.version!==P&&(_=Zc(A.groupBuffer.ref.value,A.charCount,4),P=A.groupBuffer.ref.version),_},setBoundingSphere(I){te.copy(E,I),D=n(A)}};return A}function i(p,h,f,b,v,x,S,T,E){return E.charCount=T,C.update(E.fontTexture,p),C.update(E.centerBuffer,h),C.update(E.mappingBuffer,f),C.update(E.depthBuffer,b),C.update(E.indexBuffer,v),C.update(E.groupBuffer,x),C.update(E.tcoordBuffer,S),E}t.Params=U(w(w({},ge.Params),rk),{sizeFactor:g.Numeric(1,{min:0,max:10,step:.1}),borderWidth:g.Numeric(0,{min:0,max:.5,step:.01}),borderColor:g.Color(ut.grey),offsetX:g.Numeric(0,{min:0,max:10,step:.1}),offsetY:g.Numeric(0,{min:0,max:10,step:.1}),offsetZ:g.Numeric(0,{min:0,max:10,step:.1}),background:g.Boolean(!1),backgroundMargin:g.Numeric(.2,{min:0,max:1,step:.01}),backgroundColor:g.Color(ut.grey),backgroundOpacity:g.Numeric(1,{min:0,max:1,step:.01}),tether:g.Boolean(!1),tetherLength:g.Numeric(1,{min:0,max:5,step:.1}),tetherBaseWidth:g.Numeric(.3,{min:0,max:1,step:.01}),attachment:g.Select("middle-center",[["bottom-left","bottom-left"],["bottom-center","bottom-center"],["bottom-right","bottom-right"],["middle-left","middle-left"],["middle-center","middle-center"],["middle-right","middle-right"],["top-left","top-left"],["top-center","top-center"],["top-right","top-right"]])}),t.Utils={Params:t.Params,createEmpty:r,createValues:s,createValuesSimple:l,updateValues:c,updateBoundingSphere:u,createRenderableState:d,updateRenderableState:m,createPositionIterator:a};function a(p,h){let f=p.charCount*4,b=h.instanceCount.ref.value,v=Ss(),x=v.position,S=p.centerBuffer.ref.value,T=h.aTransform.ref.value;return jt(f,b,4,(_,D)=>(D<0?y.fromArray(x,S,_*3):y.transformMat4Offset(x,S,T,0,_*3,D*16),v))}function s(p,h,f,b,v){let{instanceCount:x,groupCount:S}=f,T=a(p,h),E=uo(f,T,b.color),_=Sa(f,b.size),D=v.instanceGranularity?jr(x,"instance"):jr(x*S,"groupInstance"),P=ga(),A=ya(),I=xa(),k=ba(),M=va(),R={drawCount:p.charCount*2*3,vertexCount:p.charCount*4,groupCount:S,instanceCount:x},B=jj(p.mappingBuffer.ref.value,p.depthBuffer.ref.value,p.charCount,bf(_)),F=te.expand(te(),p.boundingSphere,B),G=Hn(F,h.aTransform.ref.value,x,0);return U(w(U(w(w(w(w(w(w(w(w(w({dGeometryType:C.create("text"),aPosition:p.centerBuffer,aMapping:p.mappingBuffer,aDepth:p.depthBuffer,aGroup:p.groupBuffer,elements:p.indexBuffer,boundingSphere:C.create(G),invariantBoundingSphere:C.create(F),uInvariantBoundingSphere:C.create(at.ofSphere(F))},E),_),D),P),A),I),k),M),h),{aTexCoord:p.tcoordBuffer,tFont:p.fontTexture,padding:C.create(B)}),ge.createValues(v,R)),{uSizeFactor:C.create(v.sizeFactor),uBorderWidth:C.create(Wo(v.borderWidth,0,.5)),uBorderColor:C.create(ce.toArrayNormalized(v.borderColor,y.zero(),0)),uOffsetX:C.create(v.offsetX),uOffsetY:C.create(v.offsetY),uOffsetZ:C.create(v.offsetZ),uBackgroundColor:C.create(ce.toArrayNormalized(v.backgroundColor,y.zero(),0)),uBackgroundOpacity:C.create(v.backgroundOpacity)})}function l(p,h,f,b,v){let x=ge.createSimple(f,b,v),S=w(w({},g.getDefaultValues(t.Params)),h);return s(p,x.transform,x.locationIterator,x.theme,S)}function c(p,h){ge.updateValues(p,h),C.updateIfChanged(p.uSizeFactor,h.sizeFactor),C.updateIfChanged(p.uBorderWidth,h.borderWidth),ce.fromNormalizedArray(p.uBorderColor.ref.value,0)!==h.borderColor&&(ce.toArrayNormalized(h.borderColor,p.uBorderColor.ref.value,0),C.update(p.uBorderColor,p.uBorderColor.ref.value)),C.updateIfChanged(p.uOffsetX,h.offsetX),C.updateIfChanged(p.uOffsetY,h.offsetY),C.updateIfChanged(p.uOffsetZ,h.offsetZ),ce.fromNormalizedArray(p.uBackgroundColor.ref.value,0)!==h.backgroundColor&&(ce.toArrayNormalized(h.backgroundColor,p.uBackgroundColor.ref.value,0),C.update(p.uBackgroundColor,p.uBackgroundColor.ref.value)),C.updateIfChanged(p.uBackgroundOpacity,h.backgroundOpacity)}function u(p,h){let f=jj(p.aMapping.ref.value,p.aDepth.ref.value,h.charCount,bf(p)),b=te.expand(te(),h.boundingSphere,f),v=Hn(b,p.aTransform.ref.value,p.instanceCount.ref.value,0);te.equals(v,p.boundingSphere.ref.value)||C.update(p.boundingSphere,v),te.equals(b,p.invariantBoundingSphere.ref.value)||(C.update(p.invariantBoundingSphere,b),C.update(p.uInvariantBoundingSphere,at.fromSphere(p.uInvariantBoundingSphere.ref.value,b))),C.update(p.padding,f)}function d(p){let h=ge.createRenderableState(p);return m(h,p),h}function m(p,h){ge.updateRenderableState(p,h),p.pickable=!1,p.opaque=!1,p.writeDepth=!0}})(Bo||(Bo={}));function jj(t,e,r,n){let o=0,i=0;for(let a=0,s=r*4;a<s;++a){let l=2*a,c=Math.abs(t[l]);c>o&&(o=c);let u=Math.abs(t[l+1]);u>o&&(o=u);let d=Math.abs(e[a]);d>i&&(i=d)}return Math.max(i,n+n*o)}var el=y(),md=y(),Kx=y(),Hj=he.add,$T=he.add3,vi;(function(t){function e(r=2048,n=1024,o){let i=he.create(Float32Array,1,n,o?o.groupBuffer.ref.value:r),a=he.create(Float32Array,3,n,o?o.startBuffer.ref.value:r),s=he.create(Float32Array,3,n,o?o.endBuffer.ref.value:r),l=(d,m,p,h,f,b,v)=>{for(let x=0;x<4;++x)$T(a,d,m,p),$T(s,h,f,b),Hj(i,v)},c=(d,m,p)=>{for(let h=0;h<4;++h)$T(a,d[0],d[1],d[2]),$T(s,m[0],m[1],m[2]),Hj(i,p)},u=(d,m,p,h)=>{let f=y.distance(d,m),b=p%2!==0,v=Math.floor((p+1)/2),x=f/(p+.5);y.setMagnitude(Kx,y.sub(Kx,m,d),x),y.copy(el,d);for(let S=0;S<v;++S)y.add(el,el,Kx),b&&S===v-1?y.copy(md,m):y.add(md,el,Kx),l(el[0],el[1],el[2],md[0],md[1],md[2],h),y.add(el,el,Kx)};return{add:l,addVec:c,addFixedCountDashes:u,addFixedLengthDashes:(d,m,p,h)=>{let f=y.distance(d,m);u(d,m,f/p,h)},addCage:(d,m,p)=>{let{vertices:h,edges:f}=m;for(let b=0,v=f.length;b<v;b+=2)y.fromArray(el,h,f[b]*3),y.fromArray(md,h,f[b+1]*3),y.transformMat4(el,el,d),y.transformMat4(md,md,d),l(el[0],el[1],el[2],md[0],md[1],md[2],p)},getLines:()=>{let d=i.elementCount/4,m=he.compact(i,!0),p=he.compact(a,!0),h=he.compact(s,!0),f=o&&d<=o.lineCount?o.mappingBuffer.ref.value:new Float32Array(d*8),b=o&&d<=o.lineCount?o.indexBuffer.ref.value:new Uint32Array(d*6);return(!o||d>o.lineCount)&&yde(d,f,b),Sr.create(f,b,m,p,h,d,o)}}}t.create=e})(vi||(vi={}));function yde(t,e,r){for(let n=0;n<t;++n){let o=n*8;e[o]=-1,e[o+1]=-1,e[o+2]=1,e[o+3]=-1,e[o+4]=-1,e[o+5]=1,e[o+6]=1,e[o+7]=1}for(let n=0;n<t;++n){let o=n*4,i=n*6;r[i]=o,r[i+1]=o+1,r[i+2]=o+2,r[i+3]=o+1,r[i+4]=o+3,r[i+5]=o+2}}var Sr;(function(t){function e(p,h,f,b,v,x,S){return S?a(p,h,f,b,v,x,S):i(p,h,f,b,v,x)}t.create=e;function r(p){let h=p?p.mappingBuffer.ref.value:new Float32Array(0),f=p?p.indexBuffer.ref.value:new Uint32Array(0),b=p?p.groupBuffer.ref.value:new Float32Array(0),v=p?p.startBuffer.ref.value:new Float32Array(0),x=p?p.endBuffer.ref.value:new Float32Array(0);return e(h,f,b,v,x,0,p)}t.createEmpty=r;function n(p,h){let f=p.vertexBuffer.ref.value,b=p.indexBuffer.ref.value,v=p.groupBuffer.ref.value,x=vi.create(p.triangleCount*3,p.triangleCount/10,h);for(let S=0,T=p.triangleCount*3;S<T;S+=3){let E=b[S],_=b[S+1],D=b[S+2],P=f[E*3],A=f[E*3+1],I=f[E*3+2],k=f[_*3],M=f[_*3+1],R=f[_*3+2],B=f[D*3],F=f[D*3+1],G=f[D*3+2];x.add(P,A,I,k,M,R,v[E]),x.add(P,A,I,B,F,G,v[E]),x.add(k,M,R,B,F,G,v[_])}return x.getLines()}t.fromMesh=n;function o(p){return Ai([p.lineCount,p.mappingBuffer.ref.version,p.indexBuffer.ref.version,p.groupBuffer.ref.version,p.startBuffer.ref.version,p.endBuffer.ref.version])}function i(p,h,f,b,v,x){let S=te(),T,E=-1,_=-1,D={kind:"lines",lineCount:x,mappingBuffer:C.create(p),indexBuffer:C.create(h),groupBuffer:C.create(f),startBuffer:C.create(b),endBuffer:C.create(v),get boundingSphere(){let P=o(D);if(P!==E){let A=Pl(D.startBuffer.ref.value,D.lineCount*4,4),I=Pl(D.endBuffer.ref.value,D.lineCount*4,4);te.expandBySphere(S,A,I),E=P}return S},get groupMapping(){return D.groupBuffer.ref.version!==_&&(T=Zc(D.groupBuffer.ref.value,D.lineCount,4),_=D.groupBuffer.ref.version),T},setBoundingSphere(P){te.copy(S,P),E=o(D)}};return D}function a(p,h,f,b,v,x,S){return x>S.lineCount&&(C.update(S.mappingBuffer,p),C.update(S.indexBuffer,h)),S.lineCount=x,C.update(S.groupBuffer,f),C.update(S.startBuffer,b),C.update(S.endBuffer,v),S}function s(p,h){let f=p.startBuffer.ref.value;$c(h,f,0,p.lineCount*4),C.update(p.startBuffer,f);let b=p.endBuffer.ref.value;$c(h,b,0,p.lineCount*4),C.update(p.endBuffer,b)}t.transform=s,t.Params=U(w({},ge.Params),{sizeFactor:g.Numeric(2,{min:0,max:10,step:.1}),lineSizeAttenuation:g.Boolean(!1)}),t.Utils={Params:t.Params,createEmpty:r,createValues:c,createValuesSimple:u,updateValues:d,updateBoundingSphere:m,createRenderableState:ge.createRenderableState,updateRenderableState:ge.updateRenderableState,createPositionIterator:l};function l(p,h){let f=p.lineCount*4,b=h.instanceCount.ref.value,v=Ss(),x=v.position,S=p.startBuffer.ref.value,T=p.endBuffer.ref.value,E=h.aTransform.ref.value;return jt(f,b,2,(D,P)=>{let A=D%4===0?S:T;return P<0?y.fromArray(x,A,D*3):y.transformMat4Offset(x,A,E,0,D*3,P*16),v})}function c(p,h,f,b,v){let{instanceCount:x,groupCount:S}=f,T=l(p,h),E=uo(f,T,b.color),_=Sa(f,b.size),D=v.instanceGranularity?jr(x,"instance"):jr(x*S,"groupInstance"),P=ga(),A=ya(),I=xa(),k=ba(),M=va(),R={drawCount:p.lineCount*2*3,vertexCount:p.lineCount*4,groupCount:S,instanceCount:x},B=te.clone(p.boundingSphere),F=Hn(B,h.aTransform.ref.value,x,0);return U(w(w(w(w(w(w(w(w(w(w({dGeometryType:C.create("lines"),aMapping:p.mappingBuffer,aGroup:p.groupBuffer,aStart:p.startBuffer,aEnd:p.endBuffer,elements:p.indexBuffer,boundingSphere:C.create(F),invariantBoundingSphere:C.create(B),uInvariantBoundingSphere:C.create(at.ofSphere(B))},E),_),D),P),A),I),k),M),h),ge.createValues(v,R)),{uSizeFactor:C.create(v.sizeFactor),dLineSizeAttenuation:C.create(v.lineSizeAttenuation),uDoubleSided:C.create(!0),dFlipSided:C.create(!1)})}function u(p,h,f,b,v){let x=ge.createSimple(f,b,v),S=w(w({},g.getDefaultValues(t.Params)),h);return c(p,x.transform,x.locationIterator,x.theme,S)}function d(p,h){ge.updateValues(p,h),C.updateIfChanged(p.uSizeFactor,h.sizeFactor),C.updateIfChanged(p.dLineSizeAttenuation,h.lineSizeAttenuation)}function m(p,h){let f=te.clone(h.boundingSphere),b=Hn(f,p.aTransform.ref.value,p.instanceCount.ref.value,0);te.equals(b,p.boundingSphere.ref.value)||C.update(p.boundingSphere,b),te.equals(f,p.invariantBoundingSphere.ref.value)||(C.update(p.invariantBoundingSphere,f),C.update(p.uInvariantBoundingSphere,at.fromSphere(p.uInvariantBoundingSphere.ref.value,f)))}})(Sr||(Sr={}));var qj=y(),Wj=y(),Xj=y();function Dg(t,e){let r=e.length,n=pd(r/3);for(let o=0;o<r;o+=3)y.fromArray(qj,t,e[o]*3),y.fromArray(Wj,t,e[o+1]*3),y.fromArray(Xj,t,e[o+2]*3),n.add(qj,Wj,Xj);return n.getPrimitive()}var ZT=y();function pd(t,e){e===void 0&&(e=t*3);let r=new Float32Array(e*3),n=new Float32Array(e*3),o=new Uint32Array(t*3),i=0,a=0;return{add:(s,l,c)=>{y.toArray(s,r,i),y.toArray(l,r,i+3),y.toArray(c,r,i+6),y.triangleNormal(ZT,s,l,c);for(let u=0;u<3;++u)y.toArray(ZT,n,i+3*u),o[a+u]=i/3+u;i+=9,a+=3},addQuad:(s,l,c,u)=>{y.toArray(s,r,i),y.toArray(l,r,i+3),y.toArray(c,r,i+6),y.toArray(u,r,i+9),y.triangleNormal(ZT,s,l,c);for(let m=0;m<4;++m)y.toArray(ZT,n,i+3*m);let d=i/3;o[a]=d,o[a+1]=d+1,o[a+2]=d+2,o[a+3]=d+2,o[a+4]=d+3,o[a+5]=d,i+=12,a+=6},getPrimitive:()=>({vertices:r,normals:n,indices:o})}}var D0=y(),vde=Dt();function A0(t,e){let{vertices:r,normals:n}=t,o=Dt.directionTransform(vde,e);for(let i=0,a=r.length;i<a;i+=3)y.transformMat4(D0,y.fromArray(D0,r,i),e),y.toArray(D0,r,i),y.transformMat3(D0,y.fromArray(D0,n,i),o),y.toArray(D0,n,i);return t}function tl(t,e,r=-1){let n=new Float32Array(t*3),o=r===-1?t<=4?Math.sqrt(2)/2:.6:r,i=e?1:0;for(let a=0,s=t;a<s;++a){let l=(a*2+i)/t*Math.PI;n[a*3]=Math.cos(l)*o,n[a*3+1]=Math.sin(l)*o,n[a*3+2]=0}return n}function am(t,e){return{vertices:t,edges:e}}function ok(t){return{vertices:new Float32Array(t.vertices),edges:new Uint32Array(t.edges)}}var nk=y.zero();function ik(t,e){let{vertices:r}=t;for(let n=0,o=r.length;n<o;n+=3)y.transformMat4(nk,y.fromArray(nk,r,n),e),y.toArray(nk,r,n);return t}var sp=y(),lp=y(),cp=y(),k0=y(),Oo=tl(4,!0);function Yj(t){let n=pd(12,t?36:24);for(let o=0;o<4;++o){let i=(o+1)%4;y.set(sp,Oo[o*3],Oo[o*3+1],-.5),y.set(lp,Oo[i*3],Oo[i*3+1],-.5),y.set(cp,Oo[i*3],Oo[i*3+1],.5),y.set(k0,Oo[o*3],Oo[o*3+1],.5),t?n.add(sp,lp,cp):n.addQuad(sp,lp,cp,k0)}return y.set(sp,Oo[0],Oo[1],-.5),y.set(lp,Oo[3],Oo[4],-.5),y.set(cp,Oo[6],Oo[7],-.5),y.set(k0,Oo[9],Oo[10],-.5),t?n.add(cp,lp,sp):n.addQuad(k0,cp,lp,sp),y.set(sp,Oo[0],Oo[1],.5),y.set(lp,Oo[3],Oo[4],.5),y.set(cp,Oo[6],Oo[7],.5),y.set(k0,Oo[9],Oo[10],.5),t?n.add(sp,lp,cp):n.addQuad(sp,lp,cp,k0),n.getPrimitive()}var ak;function M0(){return ak||(ak=Yj(!1)),ak}var sk;function Qj(){return sk||(sk=Yj(!0)),sk}var lk;function JT(){return lk||(lk=am([.5,.5,-.5,-.5,.5,-.5,-.5,-.5,-.5,.5,-.5,-.5,.5,.5,.5,-.5,.5,.5,-.5,-.5,.5,.5,-.5,.5],[0,4,1,5,2,6,3,7,0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4])),lk}function ck(t){return t.map(e=>({x:e[0],alpha:e[1]}))}function uk(t,e){let r=[{x:0,alpha:0},{x:0,alpha:0},...t,{x:1,alpha:0},{x:1,alpha:0}],n=256,o=e?e.ref.value.array:new Uint8Array(n),i=0,a,s,l,c,u,d,m=t.length+1;for(let h=0;h<m;++h){a=r[h+1].x,s=r[h+2].x,l=r[h].alpha,c=r[h+1].alpha,u=r[h+2].alpha,d=r[h+3].alpha;let f=Math.round((s-a)*n);for(let b=0;b<f;++b){let v=b/f;o[i]=Math.max(0,xz(l,c,u,d,v,.5)*255),++i}}let p={array:o,width:256,height:1};return e?(C.update(e,p),e):C.create(p)}function $j(t,e,r){if(r)return Kj(t,e,r.min,r.max);{let[n,o]=_A(t);return Kj(t,e,n,o)}}function Kj(t,e,r,n){let o=(n-r)/e;o===0&&(o=1);let i=new Int32Array(e);for(let a=0,s=t.length;a<s;a++){let l=Math.floor((t[a]-r)/o);l>=e?l=e-1:l<0&&(l=0),i[l]++}return{min:r,max:n,binWidth:o,counts:i}}var Sn;(function(t){t.One={transform:{kind:"matrix",matrix:W.identity()},cells:er.create(er.Space([1,1,1],[0,1,2]),er.Data1([0])),stats:{min:0,max:0,mean:0,sigma:0}};let e=W.zero(),r=W.zero();function n(l){if(l.transform.kind==="matrix")return W.copy(W(),l.transform.matrix);if(l.transform.kind==="spacegroup"){let{cells:{space:c}}=l,u=W.fromScaling(e,y.div(y.zero(),qe.size(y.zero(),l.transform.fractionalBox),y.ofArray(c.dimensions))),d=W.fromTranslation(r,l.transform.fractionalBox.min);return W.mul3(W.zero(),l.transform.cell.fromFractional,d,u)}return W.identity()}t.getGridToCartesianTransform=n;function o(l,c){return l===c}t.areEquivalent=o;function i(l){return l.cells.data.length===0}t.isEmpty=i;function a(l,c){c||(c=te());let u=l.cells.space.dimensions,d=t.getGridToCartesianTransform(l);return te.fromDimensionsAndTransform(c,u,d)}t.getBoundingSphere=a;function s(l,c){let u=l._historams;return u||(u=l._historams={}),u[c]||(u[c]=$j(l.cells.data,c,{min:l.stats.min,max:l.stats.max})),u[c]}t.getHistogram=s})(Sn||(Sn={}));function Zj(t,e){return ie.create("Create Volume",()=>N(this,null,function*(){let{header:r,values:n}=t,o=er.Space(r.dim,[0,1,2],Float64Array),i;if(r.dataSetIds.length===0)i=n;else{let[c,u,d]=r.dim,m=(e?.dataIndex||0)+1,p=0,h=0;i=new Float64Array(c*u*d);for(let f=0;f<c;f++)for(let b=0;b<u;b++)for(let v=0;v<d;v++)i[p++]=n[h],h+=m}let a=er.create(o,er.Data1(i)),s=W.fromTranslation(W(),r.origin),l=W.fromBasis(W(),r.basisX,r.basisY,r.basisZ);return W.mul(s,s,l),{label:e?.label,entryId:e?.entryId,grid:{transform:{kind:"matrix",matrix:s},cells:a,stats:{min:cf(i),max:Mi(i),mean:uf(i),sigma:df(i)}},sourceData:$x.create(t),customProperties:new Tl,_propertyData:Object.create(null)}}))}var $x;(function(t){function e(n){return n?.kind==="cube"}t.is=e;function r(n){return{kind:"cube",name:n.name,data:n}}t.create=r})($x||($x={}));function e2(t,e){return ie.create("Create Volume",r=>N(this,null,function*(){let{volume_data_3d_info:n,volume_data_3d:o}=t,i=pa.create(n.spacegroup_number.value(0),y.ofArray(n.spacegroup_cell_size.value(0)),y.scale(y.zero(),y.ofArray(n.spacegroup_cell_angles.value(0)),Math.PI/180)),a=n.axis_order.value(0),s=er.convertToCanonicalAxisIndicesFastToSlow(a),l=s(n.sample_count.value(0)),c=er.Space(l,er.invertAxisOrder(a),Float32Array),u=er.create(c,er.Data1(o.values.toArray({array:Float32Array}))),d=y.ofArray(s(n.origin.value(0))),m=y.ofArray(s(n.dimensions.value(0)));return{label:e?.label,entryId:e?.entryId,grid:{transform:{kind:"spacegroup",cell:i,fractionalBox:qe.create(d,y.add(y.zero(),d,m))},cells:u,stats:{min:n.min_sampled.value(0),max:n.max_sampled.value(0),mean:n.mean_sampled.value(0),sigma:n.sigma_sampled.value(0)}},sourceData:Zx.create(t),customProperties:new Tl,_propertyData:Object.create(null)}}))}var Zx;(function(t){function e(n){return n?.kind==="dscif"}t.is=e;function r(n){return{kind:"dscif",name:n._name,data:n}}t.create=r})(Zx||(Zx={}));var xe;(function(t){function e(v){var x,S,T,E;return((E=(T=(S=(x=v?.grid)===null||x===void 0?void 0:x.cells)===null||S===void 0?void 0:S.space)===null||T===void 0?void 0:T.dimensions)===null||E===void 0?void 0:E.length)&&v?.sourceData&&v?.customProperties&&v?._propertyData}t.is=e;let r;(function(v){function x(I,k,M){return bs(D(I,M).absoluteValue,D(k,M).absoluteValue,M.sigma/100)}v.areSame=x;function S(I){return{kind:"absolute",absoluteValue:I}}v.absolute=S;function T(I){return{kind:"relative",relativeValue:I}}v.relative=T;function E(I,k){return k*I.sigma+I.mean}v.calcAbsolute=E;function _(I,k){return I.sigma===0?0:(k-I.mean)/I.sigma}v.calcRelative=_;function D(I,k){return I.kind==="absolute"?I:{kind:"absolute",absoluteValue:v.calcAbsolute(k,I.relativeValue)}}v.toAbsolute=D;function P(I,k){return I.kind==="relative"?I:{kind:"relative",relativeValue:v.calcRelative(k,I.absoluteValue)}}v.toRelative=P;function A(I){return I.kind==="relative"?`${I.relativeValue.toFixed(2)} \u03C3`:`${I.absoluteValue.toPrecision(4)}`}v.toString=A})(r=t.IsoValue||(t.IsoValue={}));function n(v,x,S){if(S==="relative")return r.relative(x);let T=r.absolute(x);if(Zx.is(v.sourceData)){let E={min:v.sourceData.data.volume_data_3d_info.min_source.value(0),max:v.sourceData.data.volume_data_3d_info.max_source.value(0),mean:v.sourceData.data.volume_data_3d_info.mean_source.value(0),sigma:v.sourceData.data.volume_data_3d_info.sigma_source.value(0)};return t.IsoValue.toRelative(T,E)}return T}t.adjustedIsoValue=n;let o={min:-1,max:1,mean:0,sigma:.1};function i(v,x){let S=x||o,{min:T,max:E,mean:_,sigma:D}=S,P=(T-_)/D,A=(E-_)/D,I=v;return v.kind==="absolute"?v.absoluteValue<T?I=t.IsoValue.absolute(T):v.absoluteValue>E&&(I=t.IsoValue.absolute(E)):v.relativeValue<P?I=t.IsoValue.relative(P):v.relativeValue>A&&(I=t.IsoValue.relative(A)),g.Conditioned(I,{absolute:g.Converted(k=>t.IsoValue.toAbsolute(k,Sn.One.stats).absoluteValue,k=>t.IsoValue.absolute(k),g.Numeric(_,{min:T,max:E,step:Ux(D/100,2)},{immediateUpdate:!0})),relative:g.Converted(k=>t.IsoValue.toRelative(k,Sn.One.stats).relativeValue,k=>t.IsoValue.relative(k),g.Numeric(Math.min(1,A),{min:P,max:A,step:Ux(Math.round((E-T)/D)/100,2)},{immediateUpdate:!0}))},k=>k.kind==="absolute"?"absolute":"relative",(k,M)=>M==="absolute"?t.IsoValue.toAbsolute(k,S):t.IsoValue.toRelative(k,S),{isEssential:!0})}t.createIsoValueParam=i,t.IsoValueParam=i(t.IsoValue.relative(2)),t.One={label:"",grid:Sn.One,sourceData:{kind:"",name:"",data:{}},customProperties:new Tl,_propertyData:Object.create(null)};function a(v,x){return Sn.areEquivalent(v.grid,x.grid)}t.areEquivalent=a;function s(v){return Sn.isEmpty(v.grid)}t.isEmpty=s;function l(v){return $x.is(v.sourceData)?v.sourceData.data.header.orbitals:!1}t.isOrbitals=l;function c(v){return{kind:"volume-loci",volume:v}}t.Loci=c;function u(v){return!!v&&v.kind==="volume-loci"}t.isLoci=u;function d(v,x){return v.volume===x.volume}t.areLociEqual=d;function m(v){return Sn.isEmpty(v.volume.grid)}t.isLociEmpty=m;function p(v,x){return Sn.getBoundingSphere(v.grid,x)}t.getBoundingSphere=p;let h;(function(v){function x(P,A){return{kind:"isosurface-loci",volume:P,isoValue:A}}v.Loci=x;function S(P){return!!P&&P.kind==="isosurface-loci"}v.isLoci=S;function T(P,A){return P.volume===A.volume&&t.IsoValue.areSame(P.isoValue,A.isoValue,P.volume.grid.stats)}v.areLociEqual=T;function E(P){return P.volume.grid.cells.data.length===0}v.isLociEmpty=E;let _=qe();function D(P,A,I){let k=t.IsoValue.toAbsolute(A,P.grid.stats).absoluteValue,M=k<0,R=[0,0,0],B=P.grid.cells.space.getCoords,F=P.grid.cells.data,[G,V,H]=P.grid.cells.space.dimensions,Q=G-1,L=V-1,Y=H-1,j=0,O=0,J=0;for(let ae=0,Z=F.length;ae<Z;++ae)(M&&F[ae]<=k||!M&&F[ae]>=k)&&(B(ae,R),R[0]<Q&&(Q=R[0]),R[1]<L&&(L=R[1]),R[2]<Y&&(Y=R[2]),R[0]>j&&(j=R[0]),R[1]>O&&(O=R[1]),R[2]>J&&(J=R[2]));y.set(_.min,Q-1,L-1,Y-1),y.set(_.max,j+1,O+1,J+1);let $=Sn.getGridToCartesianTransform(P.grid);return qe.transform(_,_,$),te.fromBox3D(I||te(),_)}v.getBoundingSphere=D})(h=t.Isosurface||(t.Isosurface={}));let f;(function(v){function x(A,I){return{kind:"cell-loci",volume:A,indices:I}}v.Loci=x;function S(A){return!!A&&A.kind==="cell-loci"}v.isLoci=S;function T(A,I){return A.volume===I.volume&&we.areEqual(A.indices,I.indices)}v.areLociEqual=T;function E(A){return we.size(A.indices)===0}v.isLociEmpty=E;let _=new Zs("98"),D=y();function P(A,I,k){_.reset();let M=Sn.getGridToCartesianTransform(A.grid),{getCoords:R}=A.grid.cells.space;for(let F=0,G=we.size(I);F<G;F++){let V=we.getAt(I,F);R(V,D),y.transformMat4(D,D,M),_.includePosition(D)}_.finishedIncludeStep();for(let F=0,G=we.size(I);F<G;F++){let V=we.getAt(I,F);R(V,D),y.transformMat4(D,D,M),_.radiusPosition(D)}let B=_.getSphere(k);return te.expand(B,B,W.getMaxScaleOnAxis(M)*10)}v.getBoundingSphere=P})(f=t.Cell||(t.Cell={}));let b;(function(v){function x(I,k){return{kind:"segment-loci",volume:I,segments:tr.ofUnsortedArray(k)}}v.Loci=x;function S(I){return!!I&&I.kind==="segment-loci"}v.isLoci=S;function T(I,k){return I.volume===k.volume&&tr.areEqual(I.segments,k.segments)}v.areLociEqual=T;function E(I){return I.volume.grid.cells.data.length===0||I.segments.length===0}v.isLociEmpty=E;let _=qe();function D(I,k,M){let R=t.Segmentation.get(I);if(R){qe.setEmpty(_);for(let F=0,G=k.length;F<G;++F){let V=R.bounds[k[F]];qe.add(_,V.min),qe.add(_,V.max)}let B=Sn.getGridToCartesianTransform(I.grid);return qe.transform(_,_,B),te.fromBox3D(M||te(),_)}else return t.getBoundingSphere(I,M)}v.getBoundingSphere=D;function P(I,k){return{kind:"segment-location",volume:I,segment:k}}v.Location=P;function A(I){return!!I&&I.kind==="segment-location"}v.isLocation=A})(b=t.Segment||(t.Segment={})),t.PickingGranularity={set(v,x){v._propertyData.__picking_granularity__=x},get(v){var x;return(x=v._propertyData.__picking_granularity__)!==null&&x!==void 0?x:"voxel"}},t.Segmentation={set(v,x){v._propertyData.__segmentation__=x},get(v){return v._propertyData.__segmentation__}}})(xe||(xe={}));var dk=M0(),ta;(function(t){function e(b,v,x,S,T,E,_,D,P,A){return A?o(b,v,x,S,T,E,_,D,P,A):n(b,v,x,S,T,E,_,D,P)}t.create=e;function r(b){return Ai([b.bboxSize.ref.version,b.gridDimension.ref.version,b.gridTexture.ref.version,b.transform.ref.version,b.gridStats.ref.version])}function n(b,v,x,S,T,E,_,D,P){let A=te(),I=-1,k=E.getWidth(),M=E.getHeight(),R=E.getDepth(),B={kind:"direct-volume",gridDimension:C.create(v),gridTexture:C.create(E),gridTextureDim:C.create(y.create(k,M,R)),gridStats:C.create(at.create(_.min,_.max,_.mean,_.sigma)),bboxMin:C.create(b.min),bboxMax:C.create(b.max),bboxSize:C.create(y.sub(y(),b.max,b.min)),transform:C.create(x),cellDim:C.create(T),unitToCartn:C.create(S),cartnToUnit:C.create(W.invert(W(),S)),get boundingSphere(){let F=r(B);if(F!==I){let G=bde(B.gridDimension.ref.value,B.transform.ref.value);te.copy(A,G),I=F}return A},packedGroup:C.create(D),axisOrder:C.create(P),setBoundingSphere(F){te.copy(A,F),I=r(B)}};return B}function o(b,v,x,S,T,E,_,D,P,A){let I=E.getWidth(),k=E.getHeight(),M=E.getDepth();return C.update(A.gridDimension,v),C.update(A.gridTexture,E),C.update(A.gridTextureDim,y.set(A.gridTextureDim.ref.value,I,k,M)),C.update(A.gridStats,at.set(A.gridStats.ref.value,_.min,_.max,_.mean,_.sigma)),C.update(A.bboxMin,b.min),C.update(A.bboxMax,b.max),C.update(A.bboxSize,y.sub(A.bboxSize.ref.value,b.max,b.min)),C.update(A.transform,x),C.update(A.cellDim,T),C.update(A.unitToCartn,S),C.update(A.cartnToUnit,W.invert(W(),S)),C.updateIfChanged(A.packedGroup,D),C.updateIfChanged(A.axisOrder,y.fromArray(A.axisOrder.ref.value,P,0)),A}function i(b){let v=qe(),x=y(),S=W.identity(),T=W.identity(),E=y(),_=un(),D=Sn.One.stats,P=!1,A=y.create(0,1,2);return e(v,x,S,T,E,_,D,P,A,b)}t.createEmpty=i,t.Params=U(w({},ge.Params),{ignoreLight:g.Boolean(!1,ge.ShadingCategory),xrayShaded:g.Select(!1,[[!1,"Off"],[!0,"On"],["inverted","Inverted"]],ge.ShadingCategory),controlPoints:g.LineGraph([ne.create(.19,0),ne.create(.2,.05),ne.create(.25,.05),ne.create(.26,0),ne.create(.79,0),ne.create(.8,.05),ne.create(.85,.05),ne.create(.86,0)],{isEssential:!0}),stepsPerCell:g.Numeric(3,{min:1,max:10,step:1}),jumpLength:g.Numeric(0,{min:0,max:20,step:.1})}),t.Utils={Params:t.Params,createEmpty:i,createValues:u,createValuesSimple:d,updateValues:m,updateBoundingSphere:p,createRenderableState:h,updateRenderableState:f,createPositionIterator:a};function a(b,v){let x=b.transform.ref.value,[S,T,E]=b.gridDimension.ref.value,_=S*T*E,D=v.instanceCount.ref.value,P=Ss(),A=P.position,I=v.aTransform.ref.value;return jt(_,D,1,(M,R)=>{let B=Math.floor(M/E);return A[0]=Math.floor(B/T),A[1]=B%T,A[2]=M%E,y.transformMat4(A,A,x),R>=0&&y.transformMat4Offset(A,A,I,0,0,R*16),P})}function s(b,v){return Math.ceil(y.magnitude(b)*v)}function l(b,v){return Math.min(...b)*(1/v)}function c(b){return 1/b}function u(b,v,x,S,T){let{gridTexture:E,gridTextureDim:_,gridStats:D}=b,{bboxSize:P,bboxMin:A,bboxMax:I,gridDimension:k,transform:M}=b,{instanceCount:R,groupCount:B}=x,F=t.Utils.createPositionIterator(b,v),G=uo(x,F,S.color),V=T.instanceGranularity?jr(R,"instance"):jr(R*B,"groupInstance"),H=ga(),Q=ya(),L=xa(),Y=ba(),j=va(),[O,J,$]=k.ref.value,ae={drawCount:dk.indices.length,vertexCount:O*J*$,groupCount:B,instanceCount:R},Z=te.clone(b.boundingSphere),se=Hn(Z,v.aTransform.ref.value,R,0),Me=ck(T.controlPoints),be=uk(Me);return U(w(w(w(w(w(w(w(w(w({dGeometryType:C.create("directVolume")},G),V),H),Q),L),Y),j),v),ge.createValues(T,ae)),{aPosition:C.create(dk.vertices),elements:C.create(dk.indices),boundingSphere:C.create(se),invariantBoundingSphere:C.create(Z),uInvariantBoundingSphere:C.create(at.ofSphere(Z)),uBboxMin:A,uBboxMax:I,uBboxSize:P,uMaxSteps:C.create(s(k.ref.value,T.stepsPerCell)),uStepScale:C.create(l(b.cellDim.ref.value,T.stepsPerCell)),uJumpLength:C.create(T.jumpLength),uTransform:M,uGridDim:k,tTransferTex:be,uTransferScale:C.create(c(T.stepsPerCell)),dGridTexType:C.create(E.ref.value.getDepth()>0?"3d":"2d"),uGridTexDim:_,tGridTex:E,uGridStats:D,uCellDim:b.cellDim,uCartnToUnit:b.cartnToUnit,uUnitToCartn:b.unitToCartn,dPackedGroup:b.packedGroup,dAxisOrder:C.create(b.axisOrder.ref.value.join("")),dIgnoreLight:C.create(T.ignoreLight),dXrayShaded:C.create(T.xrayShaded==="inverted"?"inverted":T.xrayShaded===!0?"on":"off")})}function d(b,v,x,S,T){let E=ge.createSimple(x,S,T),_=w(w({},g.getDefaultValues(t.Params)),v);return u(b,E.transform,E.locationIterator,E.theme,_)}function m(b,v){ge.updateValues(b,v),C.updateIfChanged(b.dIgnoreLight,v.ignoreLight),C.updateIfChanged(b.dXrayShaded,v.xrayShaded==="inverted"?"inverted":v.xrayShaded===!0?"on":"off");let x=ck(v.controlPoints);uk(x,b.tTransferTex),C.updateIfChanged(b.uMaxSteps,s(b.uGridDim.ref.value,v.stepsPerCell)),C.updateIfChanged(b.uStepScale,l(b.uCellDim.ref.value,v.stepsPerCell)),C.updateIfChanged(b.uTransferScale,c(v.stepsPerCell)),C.updateIfChanged(b.uJumpLength,v.jumpLength)}function p(b,v){let x=te.clone(v.boundingSphere),S=Hn(x,b.aTransform.ref.value,b.instanceCount.ref.value,0);te.equals(S,b.boundingSphere.ref.value)||C.update(b.boundingSphere,S),te.equals(x,b.invariantBoundingSphere.ref.value)||(C.update(b.invariantBoundingSphere,x),C.update(b.uInvariantBoundingSphere,at.fromSphere(b.uInvariantBoundingSphere.ref.value,x)))}function h(b){let v=ge.createRenderableState(b);return v.opaque=!1,v.writeDepth=!1,v}function f(b,v){ge.updateRenderableState(b,v),b.opaque=!1,b.writeDepth=!1}})(ta||(ta={}));function bde(t,e){return te.fromDimensionsAndTransform(te(),t,e)}var Ni;(function(t){function e(S,T,E,_){return _?i(S,T,E,_):o(S,T,E)}t.create=e;function r(S){let T=S?S.centerBuffer.ref.value:new Float32Array(0),E=S?S.groupBuffer.ref.value:new Float32Array(0);return e(T,E,0,S)}t.createEmpty=r;function n(S){return Ai([S.sphereCount,S.centerBuffer.ref.version,S.groupBuffer.ref.version])}function o(S,T,E){let _=te(),D,P=-1,A=-1,I=C.create(Zr(1,4,Float32Array)),k=C.create(ne.create(0,0)),M=C.create([]),R=C.create(0),B={kind:"spheres",sphereCount:E,centerBuffer:C.create(S),groupBuffer:C.create(T),get boundingSphere(){let F=n(B);if(F!==P){let G=Pl(B.centerBuffer.ref.value,B.sphereCount,1);te.copy(_,G),P=F}return _},get groupMapping(){return B.groupBuffer.ref.version!==A&&(D=Zc(B.groupBuffer.ref.value,B.sphereCount),A=B.groupBuffer.ref.version),D},setBoundingSphere(F){te.copy(_,F),P=n(B)},shaderData:{positionGroup:I,texDim:k,lodLevels:M,sizeFactor:R,update(F){var G,V;let H=(G=F?.lodLevels)!==null&&G!==void 0?G:c(M.ref.value),Q=(V=F?.sizeFactor)!==null&&V!==void 0?V:R.ref.value,L=d(H,Q),Y=Zr(B.sphereCount,4,Float32Array,I.ref.value.array),j=a(Y,B.centerBuffer.ref.value,B.groupBuffer.ref.value,B.sphereCount,L),O=j?l(H,Q,j,B.sphereCount):[];C.update(I,Y),C.update(k,ne.set(k.ref.value,Y.width,Y.height)),C.update(M,O),C.update(R,Q)}}};return B.shaderData.update(),B}function i(S,T,E,_){return _.sphereCount=E,C.update(_.centerBuffer,S),C.update(_.groupBuffer,T),_.shaderData.update(),_}function a(S,T,E,_,D){let{array:P}=S;if(D.length===0){for(let k=0;k<_;++k)P[k*4+0]=T[k*3+0],P[k*4+1]=T[k*3+1],P[k*4+2]=T[k*3+2],P[k*4+3]=E[k];return}let A=[0],I=0;for(let k=0,M=D.length;k<M;++k){let R=D[k];for(let B=0;B<_;++B){let F=!1;for(let G=0;G<k;++G)if(B%D[G]===0){F=!0;break}!F&&B%R===0&&(P[I*4+0]=T[B*3+0],P[I*4+1]=T[B*3+1],P[I*4+2]=T[B*3+2],P[I*4+3]=E[B],I+=1)}A.push(I*6)}return A}function s(S,T){if(S.length!==T.length)return!1;for(let E=0,_=S.length;E<_;++E)if(S[E].maxDistance!==T[E].maxDistance||S[E].minDistance!==T[E].minDistance||S[E].overlap!==T[E].overlap||S[E].stride!==T[E].stride||S[E].scaleBias!==T[E].scaleBias)return!1;return!0}function l(S,T,E,_){return S.map((D,P)=>{let A=u(D,T);return[D.minDistance,D.maxDistance,D.overlap,E[E.length-1-P],Math.pow(Math.min(_,A),1/D.scaleBias),D.stride,D.scaleBias]})}function c(S){return S.map(T=>({minDistance:T[0],maxDistance:T[1],overlap:T[2],stride:T[5],scaleBias:T[6]}))}function u(S,T){return Math.max(1,Math.round(S.stride/Math.pow(T,S.scaleBias)))}function d(S,T){return S.map(E=>u(E,T)).reverse()}t.Params=U(w({},ge.Params),{sizeFactor:g.Numeric(1,{min:0,max:10,step:.1}),doubleSided:g.Boolean(!1,ge.CustomQualityParamInfo),ignoreLight:g.Boolean(!1,ge.ShadingCategory),xrayShaded:g.Select(!1,[[!1,"Off"],[!0,"On"],["inverted","Inverted"]],ge.ShadingCategory),transparentBackfaces:g.Select("off",g.arrayToOptions(["off","on","opaque"]),ge.ShadingCategory),solidInterior:g.Boolean(!0,ge.ShadingCategory),clipPrimitive:g.Boolean(!1,U(w({},ge.ShadingCategory),{description:"Clip whole sphere instead of cutting it."})),approximate:g.Boolean(!1,U(w({},ge.ShadingCategory),{description:"Faster rendering, but has artifacts."})),alphaThickness:g.Numeric(0,{min:0,max:20,step:1},U(w({},ge.ShadingCategory),{description:"If not zero, adjusts alpha for radius."})),bumpFrequency:g.Numeric(0,{min:0,max:10,step:.1},ge.ShadingCategory),bumpAmplitude:g.Numeric(1,{min:0,max:5,step:.1},ge.ShadingCategory),lodLevels:g.ObjectList({minDistance:g.Numeric(0),maxDistance:g.Numeric(0),overlap:g.Numeric(0),stride:g.Numeric(0),scaleBias:g.Numeric(3,{min:.1,max:10,step:.1})},S=>`${S.stride}`,U(w({},ge.CullingLodCategory),{defaultValue:[]}))}),t.Utils={Params:t.Params,createEmpty:r,createValues:p,createValuesSimple:h,updateValues:f,updateBoundingSphere:b,createRenderableState:v,updateRenderableState:x,createPositionIterator:m};function m(S,T){let E=S.sphereCount,_=T.instanceCount.ref.value,D=Ss(),P=D.position,A=S.centerBuffer.ref.value,I=T.aTransform.ref.value;return jt(E,_,1,(M,R)=>(R<0?y.fromArray(P,A,M*3):y.transformMat4Offset(P,A,I,0,M*3,R*16),D))}function p(S,T,E,_,D){let{instanceCount:P,groupCount:A}=E,I=m(S,T),k=uo(E,I,_.color),M=Sa(E,_.size),R=D.instanceGranularity?jr(P,"instance"):jr(P*A,"groupInstance"),B=ga(),F=ya(),G=xa(),V=ba(),H=va(),Q={drawCount:S.sphereCount*2*3,vertexCount:S.sphereCount*6,groupCount:A,instanceCount:P},L=S.boundingSphere.radius?bf(M)*D.sizeFactor:0,Y=te.expand(te(),S.boundingSphere,L),j=Hn(Y,T.aTransform.ref.value,P,0);return S.shaderData.update({lodLevels:D.lodLevels,sizeFactor:D.sizeFactor}),U(w(U(w(w(w(w(w(w(w(w(w({dGeometryType:C.create("spheres"),uTexDim:S.shaderData.texDim,tPositionGroup:S.shaderData.positionGroup,boundingSphere:C.create(j),invariantBoundingSphere:C.create(Y),uInvariantBoundingSphere:C.create(at.ofSphere(Y))},k),M),R),B),F),G),V),H),T),{padding:C.create(L)}),ge.createValues(D,Q)),{uSizeFactor:S.shaderData.sizeFactor,uDoubleSided:C.create(D.doubleSided),dIgnoreLight:C.create(D.ignoreLight),dXrayShaded:C.create(D.xrayShaded==="inverted"?"inverted":D.xrayShaded===!0?"on":"off"),dTransparentBackfaces:C.create(D.transparentBackfaces),dSolidInterior:C.create(D.solidInterior),dClipPrimitive:C.create(D.clipPrimitive),dApproximate:C.create(D.approximate),uAlphaThickness:C.create(D.alphaThickness),uBumpFrequency:C.create(D.bumpFrequency),uBumpAmplitude:C.create(D.bumpAmplitude),lodLevels:S.shaderData.lodLevels,centerBuffer:S.centerBuffer,groupBuffer:S.groupBuffer})}function h(S,T,E,_,D){let P=ge.createSimple(E,_,D),A=w(w({},g.getDefaultValues(t.Params)),T);return p(S,P.transform,P.locationIterator,P.theme,A)}function f(S,T){ge.updateValues(S,T),C.updateIfChanged(S.uSizeFactor,T.sizeFactor),C.updateIfChanged(S.uDoubleSided,T.doubleSided),C.updateIfChanged(S.dIgnoreLight,T.ignoreLight),C.updateIfChanged(S.dXrayShaded,T.xrayShaded==="inverted"?"inverted":T.xrayShaded===!0?"on":"off"),C.updateIfChanged(S.dTransparentBackfaces,T.transparentBackfaces),C.updateIfChanged(S.dSolidInterior,T.solidInterior),C.updateIfChanged(S.dClipPrimitive,T.clipPrimitive),C.updateIfChanged(S.dApproximate,T.approximate),C.updateIfChanged(S.uAlphaThickness,T.alphaThickness),C.updateIfChanged(S.uBumpFrequency,T.bumpFrequency),C.updateIfChanged(S.uBumpAmplitude,T.bumpAmplitude);let E=c(S.lodLevels.ref.value);if(!s(T.lodLevels,E)){let _=S.uVertexCount.ref.value/6,D=d(T.lodLevels,T.sizeFactor),P=a(S.tPositionGroup.ref.value,S.centerBuffer.ref.value,S.groupBuffer.ref.value,_,D),A=P?l(T.lodLevels,T.sizeFactor,P,_):[];C.update(S.tPositionGroup,S.tPositionGroup.ref.value),C.update(S.lodLevels,A)}}function b(S,T){let E=T.boundingSphere.radius?bf(S)*S.uSizeFactor.ref.value:0,_=te.expand(te(),T.boundingSphere,E),D=Hn(_,S.aTransform.ref.value,S.instanceCount.ref.value,0);te.equals(D,S.boundingSphere.ref.value)||C.update(S.boundingSphere,D),te.equals(_,S.invariantBoundingSphere.ref.value)||(C.update(S.invariantBoundingSphere,_),C.update(S.uInvariantBoundingSphere,at.fromSphere(S.uInvariantBoundingSphere.ref.value,_))),C.update(S.padding,E)}function v(S){let T=ge.createRenderableState(S);return x(T,S),T}function x(S,T){ge.updateRenderableState(S,T),S.opaque=S.opaque&&!T.xrayShaded,S.writeDepth=S.opaque}})(Ni||(Ni={}));var Ko;(function(t){class e{constructor(){this.index=0,this.textures=[]}get(){return this.textures[this.index]}set(p,h,f){this.textures[this.index]=Object.assign(this.textures[this.index]||{},{vertex:p,group:h,normal:f}),this.index=(this.index+1)%2}destroy(){for(let p of this.textures)p.vertex.destroy(),p.group.destroy(),p.normal.destroy()}}t.DoubleBuffer=e;function r(m,p,h,f,b,v,x){let S=h.getWidth(),T=h.getHeight();return x?(x.vertexCount=m,x.groupCount=p,C.update(x.geoTextureDim,ne.set(x.geoTextureDim.ref.value,S,T)),C.update(x.vertexTexture,h),C.update(x.groupTexture,f),C.update(x.normalTexture,b),x.doubleBuffer.set(h,f,b),te.copy(x.boundingSphere,v),x):{kind:"texture-mesh",vertexCount:m,groupCount:p,geoTextureDim:C.create(ne.create(S,T)),vertexTexture:C.create(h),groupTexture:C.create(f),normalTexture:C.create(b),varyingGroup:C.create(!1),doubleBuffer:new e,boundingSphere:te.clone(v),meta:{}}}t.create=r;function n(m){let p=m?m.vertexTexture.ref.value:un(),h=m?m.groupTexture.ref.value:un(),f=m?m.normalTexture.ref.value:un(),b=m?m.boundingSphere:te();return r(0,0,p,h,f,b,m)}t.createEmpty=n,t.Params=U(w({},ge.Params),{doubleSided:g.Boolean(!1,ge.CustomQualityParamInfo),flipSided:g.Boolean(!1,ge.ShadingCategory),flatShaded:g.Boolean(!1,ge.ShadingCategory),ignoreLight:g.Boolean(!1,ge.ShadingCategory),xrayShaded:g.Select(!1,[[!1,"Off"],[!0,"On"],["inverted","Inverted"]],ge.ShadingCategory),transparentBackfaces:g.Select("off",g.arrayToOptions(["off","on","opaque"]),ge.ShadingCategory),bumpFrequency:g.Numeric(0,{min:0,max:10,step:.1},ge.ShadingCategory),bumpAmplitude:g.Numeric(1,{min:0,max:5,step:.1},ge.ShadingCategory)}),t.Utils={Params:t.Params,createEmpty:n,createValues:a,createValuesSimple:s,updateValues:l,updateBoundingSphere:c,createRenderableState:u,updateRenderableState:d,createPositionIterator:i};let o="texture-mesh";function i(m,p){let h=m.meta.webgl;if(!h)return jt(1,1,1,()=>Lo);h.namedFramebuffers[o]||(h.namedFramebuffers[o]=h.resources.framebuffer());let f=h.namedFramebuffers[o],[b,v]=m.geoTextureDim.ref.value,x=new Float32Array(b*v*4);f.bind(),m.vertexTexture.ref.value.attachFramebuffer(f,0),h.readPixels(0,0,b,v,x);let S=new Float32Array(b*v*4);f.bind(),m.normalTexture.ref.value.attachFramebuffer(f,0),h.readPixels(0,0,b,v,S);let T=m.vertexCount,E=p.instanceCount.ref.value,_=Ss(),D=_.position,P=_.normal,A=p.aTransform.ref.value;return jt(T,E,1,(k,M)=>(M<0?(y.fromArray(D,x,k*4),y.fromArray(P,S,k*4)):(y.transformMat4Offset(D,x,A,0,k*4,M*16),y.transformDirectionOffset(P,S,A,0,k*4,M*16)),_))}function a(m,p,h,f,b){let{instanceCount:v,groupCount:x}=h,S=t.Utils.createPositionIterator(m,p),T=uo(h,S,f.color),E=b.instanceGranularity?jr(v,"instance"):jr(v*x,"groupInstance"),_=ga(),D=ya(),P=xa(),A=ba(),I=va(),k={drawCount:m.vertexCount,vertexCount:m.vertexCount,groupCount:x,instanceCount:v},M=te.clone(m.boundingSphere),R=Hn(M,p.aTransform.ref.value,v,0);return U(w(w(w(w(w(w(w(w(w({dGeometryType:C.create("textureMesh"),uGeoTexDim:m.geoTextureDim,tPosition:m.vertexTexture,tGroup:m.groupTexture,tNormal:m.normalTexture,dVaryingGroup:m.varyingGroup,boundingSphere:C.create(R),invariantBoundingSphere:C.create(M),uInvariantBoundingSphere:C.create(at.ofSphere(M))},T),E),_),D),P),A),I),p),ge.createValues(b,k)),{uDoubleSided:C.create(b.doubleSided),dFlatShaded:C.create(b.flatShaded),dFlipSided:C.create(b.flipSided),dIgnoreLight:C.create(b.ignoreLight),dXrayShaded:C.create(b.xrayShaded==="inverted"?"inverted":b.xrayShaded===!0?"on":"off"),dTransparentBackfaces:C.create(b.transparentBackfaces),uBumpFrequency:C.create(b.bumpFrequency),uBumpAmplitude:C.create(b.bumpAmplitude),meta:C.create(m.meta)})}function s(m,p,h,f,b){let v=ge.createSimple(h,f,b),x=w(w({},g.getDefaultValues(t.Params)),p);return a(m,v.transform,v.locationIterator,v.theme,x)}function l(m,p){ge.updateValues(m,p),C.updateIfChanged(m.uDoubleSided,p.doubleSided),C.updateIfChanged(m.dFlatShaded,p.flatShaded),C.updateIfChanged(m.dFlipSided,p.flipSided),C.updateIfChanged(m.dIgnoreLight,p.ignoreLight),C.updateIfChanged(m.dXrayShaded,p.xrayShaded==="inverted"?"inverted":p.xrayShaded===!0?"on":"off"),C.updateIfChanged(m.dTransparentBackfaces,p.transparentBackfaces),C.updateIfChanged(m.uBumpFrequency,p.bumpFrequency),C.updateIfChanged(m.uBumpAmplitude,p.bumpAmplitude)}function c(m,p){let h=te.clone(p.boundingSphere),f=Hn(h,m.aTransform.ref.value,m.instanceCount.ref.value,0);te.equals(f,m.boundingSphere.ref.value)||C.update(m.boundingSphere,f),te.equals(h,m.invariantBoundingSphere.ref.value)||(C.update(m.invariantBoundingSphere,h),C.update(m.uInvariantBoundingSphere,at.fromSphere(m.uInvariantBoundingSphere.ref.value,h)))}function u(m){let p=ge.createRenderableState(m);return d(p,m),p}function d(m,p){ge.updateRenderableState(m,p),m.opaque=m.opaque&&!p.xrayShaded,m.writeDepth=m.opaque}})(Ko||(Ko={}));function Jj(t,e){let r={},n={},o={},i={},a={},s={},l={};return Object.keys(t).forEach(c=>{let u=t[c];u.type==="attribute"&&(r[c]=e[c]),u.type==="define"&&(n[c]=e[c]),u.type==="texture"&&e[c]!==void 0&&(u.variant==="material"?i[c]=e[c]:o[c]=e[c]),u.type==="uniform"&&e[c]!==void 0&&(u.variant==="material"?s[c]=e[c]:u.variant==="buffered"?l[c]=e[c]:a[c]=e[c])}),{attributeValues:r,defineValues:n,textureValues:o,materialTextureValues:i,uniformValues:a,materialUniformValues:s,bufferedUniformValues:l}}function eH(t){let e={};return Object.keys(t).forEach(r=>{e[r]=t[r].ref.version}),e}function hr(t,e,r){return{type:"attribute",kind:t,itemSize:e,divisor:r}}function ee(t,e){return{type:"uniform",kind:t,variant:e}}function We(t,e,r,n,o){return{type:"texture",kind:t,format:e,dataType:r,filter:n,variant:o}}function eu(t){return{type:"elements",kind:t}}function Ye(t,e){return{type:"define",kind:t,options:e}}function Mr(t){return{type:"value",kind:t}}var Ca={uDrawId:ee("i"),uModel:ee("m4"),uView:ee("m4"),uInvView:ee("m4"),uModelView:ee("m4"),uInvModelView:ee("m4"),uProjection:ee("m4"),uInvProjection:ee("m4"),uModelViewProjection:ee("m4"),uInvModelViewProjection:ee("m4"),uIsOrtho:ee("f"),uPixelRatio:ee("f"),uViewport:ee("v4"),uViewOffset:ee("v2"),uDrawingBufferSize:ee("v2"),uCameraPosition:ee("v3"),uCameraDir:ee("v3"),uCameraPlane:ee("v4"),uNear:ee("f"),uFar:ee("f"),uFog:ee("b"),uFogNear:ee("f"),uFogFar:ee("f"),uFogColor:ee("v3"),uTransparentBackground:ee("b"),uLightDirection:ee("v3[]"),uLightColor:ee("v3[]"),uAmbientColor:ee("v3"),uPickingAlphaThreshold:ee("f"),uInteriorDarkening:ee("f"),uInteriorColorFlag:ee("b"),uInteriorColor:ee("v3"),uHighlightColor:ee("v3"),uSelectColor:ee("v3"),uDimColor:ee("v3"),uHighlightStrength:ee("f"),uSelectStrength:ee("f"),uDimStrength:ee("f"),uMarkerPriority:ee("i"),uMarkerAverage:ee("f"),uXrayEdgeFalloff:ee("f"),uExposure:ee("f"),uRenderMask:ee("i"),uMarkingDepthTest:ee("b"),uMarkingType:ee("i"),uPickType:ee("i")},Ta={tDepth:We("texture","depth","ushort","nearest"),tDpoitDepth:We("texture","rg","float","nearest"),tDpoitFrontColor:We("texture","rgba","float","nearest"),tDpoitBackColor:We("texture","rgba","float","nearest")},wa={uObjectId:ee("i")},xde={uColor:ee("v3","material"),uColorTexDim:ee("v2"),uColorGridDim:ee("v3"),uColorGridTransform:ee("v4"),tColor:We("image-uint8","rgb","ubyte","nearest"),tPalette:We("image-uint8","rgb","ubyte","nearest"),tColorGrid:We("texture","rgb","ubyte","linear"),dColorType:Ye("string",["uniform","attribute","instance","group","groupInstance","vertex","vertexInstance","volume","volumeInstance","direct"]),dUsePalette:Ye("boolean")},sm={uSize:ee("f","material"),uSizeTexDim:ee("v2"),tSize:We("image-uint8","rgb","ubyte","nearest"),dSizeType:Ye("string",["uniform","attribute","instance","group","groupInstance"]),uSizeFactor:ee("f","material")},Sde={uMarker:ee("f"),uMarkerTexDim:ee("v2"),tMarker:We("image-uint8","alpha","ubyte","nearest"),markerAverage:Mr("number"),markerStatus:Mr("number"),dMarkerType:Ye("string",["instance","groupInstance"])},Cde={uOverpaintTexDim:ee("v2"),tOverpaint:We("image-uint8","rgba","ubyte","nearest"),dOverpaint:Ye("boolean"),uOverpaintGridDim:ee("v3"),uOverpaintGridTransform:ee("v4"),tOverpaintGrid:We("texture","rgba","ubyte","linear"),dOverpaintType:Ye("string",["instance","groupInstance","volumeInstance"]),uOverpaintStrength:ee("f","material")},Tde={uTransparencyTexDim:ee("v2"),tTransparency:We("image-uint8","alpha","ubyte","nearest"),dTransparency:Ye("boolean"),transparencyAverage:Mr("number"),uTransparencyGridDim:ee("v3"),uTransparencyGridTransform:ee("v4"),tTransparencyGrid:We("texture","alpha","ubyte","linear"),dTransparencyType:Ye("string",["instance","groupInstance","volumeInstance"]),uTransparencyStrength:ee("f","material")},wde={uEmissiveTexDim:ee("v2"),tEmissive:We("image-uint8","alpha","ubyte","nearest"),dEmissive:Ye("boolean"),emissiveAverage:Mr("number"),uEmissiveGridDim:ee("v3"),uEmissiveGridTransform:ee("v4"),tEmissiveGrid:We("texture","alpha","ubyte","linear"),dEmissiveType:Ye("string",["instance","groupInstance","volumeInstance"]),uEmissiveStrength:ee("f","material")},_de={uSubstanceTexDim:ee("v2"),tSubstance:We("image-uint8","rgba","ubyte","nearest"),dSubstance:Ye("boolean"),uSubstanceGridDim:ee("v3"),uSubstanceGridTransform:ee("v4"),tSubstanceGrid:We("texture","rgba","ubyte","linear"),dSubstanceType:Ye("string",["instance","groupInstance","volumeInstance"]),uSubstanceStrength:ee("f","material")},Pde={uClippingTexDim:ee("v2"),tClipping:We("image-uint8","alpha","ubyte","nearest"),dClipping:Ye("boolean"),dClippingType:Ye("string",["instance","groupInstance"])},_a=U(w(w(w(w(w(w(w({dGeometryType:Ye("string",["cylinders","directVolume","image","lines","mesh","points","spheres","text","textureMesh"])},xde),Sde),Cde),Tde),wde),_de),Pde),{dLightCount:Ye("number"),dColorMarker:Ye("boolean"),dClipObjectCount:Ye("number"),dClipVariant:Ye("string",["instance","pixel"]),uClipObjectType:ee("i[]","material"),uClipObjectInvert:ee("b[]","material"),uClipObjectPosition:ee("v3[]","material"),uClipObjectRotation:ee("v4[]","material"),uClipObjectScale:ee("v3[]","material"),aInstance:hr("float32",1,1),aTransform:hr("float32",16,1),uAlpha:ee("f","material"),uMetalness:ee("f","material"),uRoughness:ee("f","material"),uBumpiness:ee("f","material"),uEmissive:ee("f","material"),uVertexCount:ee("i"),uInstanceCount:ee("i"),uGroupCount:ee("i"),uInvariantBoundingSphere:ee("v4"),uLod:ee("v4"),drawCount:Mr("number"),instanceCount:Mr("number"),alpha:Mr("number"),matrix:Mr("m4"),transform:Mr("float32"),extraTransform:Mr("float32"),hasReflection:Mr("boolean"),instanceGranularity:Mr("boolean"),boundingSphere:Mr("sphere"),invariantBoundingSphere:Mr("sphere"),instanceGrid:Mr("instanceGrid")});var tH=`
precision highp float;
precision highp sampler2D;

uniform sampler2D tColor;
uniform vec2 uTexSize;

void main() {
    vec2 coords = gl_FragCoord.xy / uTexSize;
    gl_FragColor = texture2D(tColor, coords);
}
`;var zr=`
precision highp float;

attribute vec2 aPosition;
uniform vec2 uQuadScale;

void main(void) {
    vec2 position = aPosition * uQuadScale - vec2(1.0, 1.0) + uQuadScale;
    gl_Position = vec4(position, 0.0, 1.0);
}
`;var Ede=bo();function Ide(t,e){let{gl:r}=t;switch(e){case"points":return r.POINTS;case"lines":return r.LINES;case"line-strip":return r.LINE_STRIP;case"line-loop":return r.LINE_LOOP;case"triangles":return r.TRIANGLES;case"triangle-strip":return r.TRIANGLE_STRIP;case"triangle-fan":return r.TRIANGLE_FAN}}var Dde={color:"",pick:"",depth:"",marking:"",emissive:""},Ade=Object.keys(Dde),kde={compute:""},Mde=Object.keys(kde);function mk(t,e,r,n,o){return r=U(w({},r),{dRenderVariant:C.create(e)}),o.dRenderVariant===void 0&&Object.defineProperty(o,"dRenderVariant",{value:Ye("string")}),t.resources.program(r,n,o)}function Rde(){return{attributes:!1,defines:!1,elements:!1,textures:!1}}function Lde(t){t.attributes=!1,t.defines=!1,t.elements=!1,t.textures=!1}function pk(t,e){if(t==="color")switch(e){case"blended":return"colorBlended";case"wboit":return"colorWboit";case"dpoit":return"colorDpoit"}return t}function Pa(t,e,r,n,o,i,a){return rH(t,e,r,n,o,i,Ade,a)}function dr(t,e,r,n,o,i=-1){return rH(t,e,r,n,o,i,Mde,void 0)}function rH(t,e,r,n,o,i,a,s){let l=Ede(),{stats:c,state:u,resources:d}=t,{instancedArrays:m,vertexArrayObject:p,multiDrawInstancedBaseVertexBaseInstance:h,drawInstancedBaseVertexBaseInstance:f}=t.extensions;if(o.uVertexCount&&!t.extensions.noNonInstancedActiveAttribs){let Z=o.uVertexCount.ref.value;o.aVertex=C.create(Ri(new Float32Array(Z))),n.aVertex=hr("float32",1,0)}let{attributeValues:b,defineValues:v,textureValues:x,materialTextureValues:S,uniformValues:T,materialUniformValues:E,bufferedUniformValues:_}=Jj(n,o),D=Object.entries(T),P=Object.entries(E),A=Object.entries(_),I=Object.entries(IG(_)),k=Object.entries(v),M=eH(o),R=Ide(t,e),B={};for(let Z of a)B[Z]=mk(t,pk(Z,s),v,r,n);let F=GA(t,n,x),G=GA(t,n,S),V=MG(t,n,b),H=[];for(let Z=0,se=V.length;Z<se;++Z){let Me=V[Z];Me[1].divisor===1&&H.push(Me)}let Q,L=o.elements;L&&L.ref.value&&(Q=d.elements(L.ref.value));let Y={};for(let Z of a)Y[Z]=p?d.vertexArray(B[Z],V,Q):null;let j=o.drawCount.ref.value,O=o.instanceCount.ref.value;c.drawCount+=j,c.instanceCount+=O,c.instancedDrawCount+=O*j;let J=Rde(),$=!1,ae=-1;return{id:l,materialId:i,getProgram:Z=>B[Z],setTransparency:Z=>{if(Z!==s){s=Z;for(let se of a)B[se].destroy(),B[se]=mk(t,pk(se,s),v,r,n)}},render:(Z,se,Me)=>{if(j===0||O===0)return;let be=B[Z];if(be.id===ae&&u.currentRenderItemId===l)be.setUniforms(D),be.bindTextures(F,se);else{let _e=Y[Z];(be.id!==u.currentProgramId||be.id!==ae||i===-1||i!==u.currentMaterialId)&&(be.id!==u.currentProgramId&&be.use(),be.setUniforms(P),be.bindTextures(G,se+F.length),u.currentMaterialId=i,ae=be.id),be.setUniforms(D),be.setUniforms(I),be.bindTextures(F,se),_e?(_e.bind(),Q&&Q.bind()):(Q&&Q.bind(),be.bindAttributes(V)),u.currentRenderItemId=l}if(ht)try{Eg(t.gl)}catch(_e){throw new Error(`Framebuffer error rendering item id ${l}: '${_e}'`)}if(Me){for(let _e of Me)if(_e.count!==0){if(be.setUniforms(_e.uniforms),h)Q?h.multiDrawElementsInstancedBaseVertexBaseInstance(R,_e.counts,0,Q._dataType,_e.offsets,0,_e.instanceCounts,0,_e.baseVertices,0,_e.baseInstances,0,_e.count):h.multiDrawArraysInstancedBaseInstance(R,_e.firsts,0,_e.counts,0,_e.instanceCounts,0,_e.baseInstances,0,_e.count);else if(f)if(Q)for(let je=0;je<_e.count;++je)_e.counts[je]>0&&(be.uniform("uDrawId",je),f.drawElementsInstancedBaseVertexBaseInstance(R,_e.counts[je],Q._dataType,_e.offsets[je],_e.instanceCounts[je],_e.baseVertices[je],_e.baseInstances[je]));else for(let je=0;je<_e.count;++je)_e.counts[je]>0&&(be.uniform("uDrawId",je),f.drawArraysInstancedBaseInstance(R,_e.firsts[je],_e.counts[je],_e.instanceCounts[je],_e.baseInstances[je]));else if(Q)for(let je=0;je<_e.count;++je)_e.counts[je]>0&&(be.uniform("uDrawId",je),be.offsetAttributes(H,_e.baseInstances[je]),m.drawElementsInstanced(R,_e.counts[je],Q._dataType,_e.offsets[je],_e.instanceCounts[je]));else for(let je=0;je<_e.count;++je)_e.counts[je]>0&&(be.uniform("uDrawId",je),be.offsetAttributes(H,_e.baseInstances[je]),m.drawArraysInstanced(R,0,_e.counts[je],_e.instanceCounts[je]));if(Ee){h?c.calls.multiDrawInstancedBase+=1:f?c.calls.drawInstancedBase+=_e.count:c.calls.drawInstanced+=_e.count;for(let je=0;je<_e.count;++je)c.calls.counts+=_e.instanceCounts[je]}}}else Q?m.drawElementsInstanced(R,j,Q._dataType,0,O):m.drawArraysInstanced(R,0,j,O),Ee&&(c.calls.drawInstanced+=1,c.calls.counts+=O);if(ht)try{zA(t.gl)}catch(_e){throw new Error(`Draw error rendering item id ${l}: '${_e}'`)}},update:()=>{if(Lde(J),o.aVertex){let Z=o.uVertexCount.ref.value;o.aVertex.ref.value.length<Z&&C.update(o.aVertex,Ri(new Float32Array(Z)))}for(let Z=0,se=k.length;Z<se;++Z){let[Me,be]=k[Z];be.ref.version!==M[Me]&&(J.defines=!0,M[Me]=be.ref.version)}if(J.defines)for(let Z of a)B[Z].destroy(),B[Z]=mk(t,pk(Z,s),v,r,n);o.drawCount.ref.version!==M.drawCount&&(c.drawCount+=o.drawCount.ref.value-j,c.instancedDrawCount+=O*o.drawCount.ref.value-O*j,j=o.drawCount.ref.value,M.drawCount=o.drawCount.ref.version),o.instanceCount.ref.version!==M.instanceCount&&(c.instanceCount+=o.instanceCount.ref.value-O,c.instancedDrawCount+=o.instanceCount.ref.value*j-O*j,O=o.instanceCount.ref.value,M.instanceCount=o.instanceCount.ref.version);for(let Z=0,se=V.length;Z<se;++Z){let[Me,be]=V[Z],_e=b[Me];if(_e.ref.version!==M[Me]){if(be.length>=_e.ref.value.length)be.updateSubData(_e.ref.value,0,be.length);else{be.destroy();let{itemSize:je,divisor:gt}=n[Me];V[Z][1]=d.attribute(_e.ref.value,je,gt),J.attributes=!0}M[Me]=_e.ref.version}}if(Q&&o.elements.ref.version!==M.elements&&(Q.length>=o.elements.ref.value.length?Q.updateSubData(o.elements.ref.value,0,Q.length):(Q.destroy(),Q=d.elements(o.elements.ref.value),J.elements=!0),M.elements=o.elements.ref.version),J.attributes||J.defines||J.elements)for(let Z of a){let se=Y[Z];se&&se.destroy(),Y[Z]=p?d.vertexArray(B[Z],V,Q):null}for(let Z=0,se=F.length;Z<se;++Z){let[Me,be]=F[Z],_e=x[Me];_e.ref.version!==M[Me]&&(n[Me].kind!=="texture"?(be.load(_e.ref.value),J.textures=!0):F[Z][1]=_e.ref.value,M[Me]=_e.ref.version)}for(let Z=0,se=G.length;Z<se;++Z){let[Me,be]=G[Z],_e=S[Me];_e.ref.version!==M[Me]&&(n[Me].kind!=="texture"?(be.load(_e.ref.value),J.textures=!0):G[Z][1]=_e.ref.value,M[Me]=_e.ref.version)}for(let Z=0,se=A.length;Z<se;++Z){let[Me,be]=A[Z];be.ref.version!==M[Me]&&(C.update(I[Z][1],$s(be.ref.value)),M[Me]=be.ref.version)}},destroy:()=>{if(!$){for(let Z of a){B[Z].destroy();let se=Y[Z];se&&se.destroy()}F.forEach(([Z,se])=>{n[Z].kind!=="texture"&&se.destroy()}),G.forEach(([Z,se])=>{n[Z].kind!=="texture"&&se.destroy()}),V.forEach(([Z,se])=>se.destroy()),Q&&Q.destroy(),c.drawCount-=j,c.instanceCount-=O,c.instancedDrawCount-=O*j,$=!0}}}}function qn(){return qn.create(y.create(1,0,0),0)}(function(t){function e(f,b){return{normal:f,constant:b}}t.create=e;function r(f,b){return y.copy(f.normal,b.normal),f.constant=b.constant,f}t.copy=r;function n(f){return r(t(),f)}t.clone=n;function o(f,b){let v=1/y.magnitude(b.normal);return y.scale(f.normal,b.normal,v),f.constant=b.constant*v,f}t.normalize=o;function i(f,b){return y.negate(f.normal,b.normal),f.constant=-b.constant,f}t.negate=i;function a(f,b,v){return y.toArray(f.normal,b,v),b[v+3]=f.constant,b}t.toArray=a;function s(f,b,v){return y.fromArray(f.normal,b,v),f.constant=b[v+3],f}t.fromArray=s;function l(f,b,v){return y.copy(f.normal,b),f.constant=-y.dot(f.normal,v),f}t.fromNormalAndCoplanarPoint=l;function c(f,b,v,x){let S=y.triangleNormal(y(),b,v,x);return l(f,S,b),f}t.fromCoplanarPoints=c;let u=y();function d(f,b,v,x,S){y.set(u,b,v,x);let T=1/y.magnitude(u);return y.scale(f.normal,u,T),f.constant=S*T,f}t.setUnnormalized=d;function m(f,b){return y.dot(f.normal,b)+f.constant}t.distanceToPoint=m;function p(f,b){return m(f,b.center)-b.radius}t.distanceToSpher3D=p;function h(f,b,v){return y.scaleAndAdd(f,f,b.normal,-m(b,v))}t.projectPoint=h})(qn||(qn={}));function up(){return up.create(qn(),qn(),qn(),qn(),qn(),qn())}(function(t){function e(c,u,d,m,p,h){return[c,u,d,m,p,h]}t.create=e;function r(c,u){for(let d=0;d<6;++d)qn.copy(c[d],u[d]);return c}t.copy=r;function n(c){return r(t(),c)}t.clone=n;function o(c,u){let d=u[0],m=u[1],p=u[2],h=u[3],f=u[4],b=u[5],v=u[6],x=u[7],S=u[8],T=u[9],E=u[10],_=u[11],D=u[12],P=u[13],A=u[14],I=u[15];return qn.setUnnormalized(c[0],h-d,x-f,_-S,I-D),qn.setUnnormalized(c[1],h+d,x+f,_+S,I+D),qn.setUnnormalized(c[2],h+m,x+b,_+T,I+P),qn.setUnnormalized(c[3],h-m,x-b,_-T,I-P),qn.setUnnormalized(c[4],h-p,x-v,_-E,I-A),qn.setUnnormalized(c[5],h+p,x+v,_+E,I+A),c}t.fromProjectionMatrix=o;function i(c,u){let d=u.center,m=-u.radius;for(let p=0;p<6;++p)if(qn.distanceToPoint(c[p],d)<m)return!1;return!0}t.intersectsSphere3D=i;let a=y();function s(c,u){for(let d=0;d<6;++d){let m=c[d];if(a[0]=m.normal[0]>0?u.max[0]:u.min[0],a[1]=m.normal[1]>0?u.max[1]:u.min[1],a[2]=m.normal[2]>0?u.max[2]:u.min[2],qn.distanceToPoint(m,a)<0)return!1}return!0}t.intersectsBox3D=s;function l(c,u){for(let d=0;d<6;++d)if(qn.distanceToPoint(c[d],u)<0)return!1;return!0}t.containsPoint=l})(up||(up={}));var t2=qn.distanceToPoint,r2=up.intersectsSphere3D,n2=te.fromArray,nH=bo();function fk(t,e){return e&&e.instanceCounts.length>=t?e:{firsts:new Int32Array(t),counts:new Int32Array(t),offsets:new Int32Array(t),instanceCounts:new Int32Array(t),baseVertices:new Int32Array(t),baseInstances:new Uint32Array(t),count:0,uniforms:[]}}function Ea(t,e,r){let n=nH(),o=fk(0),i=[],a=!1,s=-1,l=te(),c=()=>{var u;let d=(u=e.lodLevels)===null||u===void 0?void 0:u.ref.value;if(d&&d.length>0){let{cellCount:m}=e.instanceGrid.ref.value;i.length=d.length;for(let p=0,h=d.length;p<h;++p)i[p]=fk(m,i[p]),i[p].count=0;if(e.lodLevels.ref.version!==s){for(let p=0,h=d.length;p<h;++p)i[p].uniforms.length!==1&&(i[p].uniforms.length=1,i[p].uniforms[0]=["uLod",C.create(at())]),C.update(i[p].uniforms[0][1],at.set(i[p].uniforms[0][1].ref.value,d[p][0],d[p][1],d[p][2],d[p][4]));s=e.lodLevels.ref.version}}};return c(),{id:n,materialId:t.materialId,values:e,state:r,cull:(u,d,m,p)=>{var h,f;if(a=!1,e.drawCount.ref.value===0||e.instanceCount.ref.value===0||e.instanceGrid.ref.value.cellSize<=1)return;let{cellOffsets:b,cellSpheres:v,cellCount:x,batchOffsets:S,batchSpheres:T,batchCount:E,batchCell:_,batchSize:D}=e.instanceGrid.ref.value,[P,A]=e.uLod.ref.value,I=P!==0||A!==0,k=2*D,M=(h=e.lodLevels)===null||h===void 0?void 0:h.ref.value;if(M&&M.length>0){if(((f=e.lodLevels)===null||f===void 0?void 0:f.ref.version)!==s)c();else for(let R=0,B=M.length;R<B;++R)i[R].count=0;for(let R=0;R<E;++R){let B=S[R],F=S[R+1];if(F-B===0)continue;n2(l,T,R*4);let V=t2(u,l.center);if(I&&(V+l.radius<P||V-l.radius>A)){Ee&&(p.culled.lod+=b[_[F-1]+1]-b[_[B]]);continue}if(!r2(d,l)){Ee&&(p.culled.frustum+=b[_[F-1]+1]-b[_[B]]);continue}if(m!==null&&m(l)){Ee&&(p.culled.occlusion+=b[_[F-1]+1]-b[_[B]]);continue}for(let H=B;H<F;++H){let Q=_[H],L=b[Q],j=b[Q+1]-L;if(j===0)continue;n2(l,v,Q*4);let O=t2(u,l.center);if(I&&(O+l.radius<P||O-l.radius>A)){Ee&&(p.culled.lod+=j);continue}if(!r2(d,l)){Ee&&(p.culled.frustum+=j);continue}if(m!==null&&O-l.radius<k&&m(l)){Ee&&(p.culled.occlusion+=j);continue}for(let J=0,$=M.length;J<$;++J){if(O+l.radius<M[J][0]||O-l.radius>M[J][1])continue;let ae=i[J],Z=ae.count;Z>0&&ae.baseInstances[Z-1]+ae.instanceCounts[Z-1]===L&&ae.counts[Z-1]===M[J][3]?ae.instanceCounts[Z-1]+=j:(ae.counts[Z]=M[J][3],ae.instanceCounts[Z]=j,ae.baseInstances[Z]=L,ae.count+=1)}}}}else{o=fk(x,o);let{baseInstances:R,instanceCounts:B,counts:F}=o,G=0;for(let V=0;V<E;++V){let H=S[V],Q=S[V+1];if(Q-H!==0){if(n2(l,T,V*4),I){let Y=t2(u,l.center);if(Y+l.radius<P||Y-l.radius>A){Ee&&(p.culled.lod+=b[_[Q-1]+1]-b[_[H]]);continue}}if(!r2(d,l)){Ee&&(p.culled.frustum+=b[_[Q-1]+1]-b[_[H]]);continue}if(m!==null&&m(l)){Ee&&(p.culled.occlusion+=b[_[Q-1]+1]-b[_[H]]);continue}for(let Y=H;Y<Q;++Y){let j=_[Y],O=b[j],$=b[j+1]-O;if($===0)continue;n2(l,v,j*4);let ae=t2(u,l.center);if(I&&(ae+l.radius<P||ae-l.radius>A)){Ee&&(p.culled.lod+=$);continue}if(!r2(d,l)){Ee&&(p.culled.frustum+=$);continue}if(m!==null&&ae-l.radius<k&&m(l)){Ee&&(p.culled.occlusion+=$);continue}G>0&&R[G-1]+B[G-1]===O?B[G-1]+=$:(F[G]=e.drawCount.ref.value,B[G]=$,R[G]=O,G+=1)}}}o.count=G,i.length=1,i[0]=o,i[0].uniforms.length=0}a=!0},uncull:()=>{a=!1},render:(u,d)=>{e.uAlpha&&e.alpha&&C.updateIfChanged(e.uAlpha,Wo(e.alpha.ref.value*r.alphaFactor,0,1)),t.render(u,d,a?i:void 0)},getProgram:u=>t.getProgram(u),setTransparency:u=>t.setTransparency(u),update:()=>{t.update(),c()},dispose:()=>t.destroy()}}function mr(t,e){return{id:nH(),values:e,render:()=>t.render("compute",0),update:()=>t.update(),dispose:()=>t.destroy()}}var Jx=new Float32Array([1,1,-1,1,-1,-1,-1,-1,1,-1,1,1]),Er={drawCount:Mr("number"),instanceCount:Mr("number"),aPosition:hr("float32",2,0),uQuadScale:ee("v2")},Ir={drawCount:C.create(6),instanceCount:C.create(1),aPosition:C.create(Jx),uQuadScale:C.create(ne.create(1,1))},Bde=U(w({},Er),{tColor:We("texture","rgba","ubyte","nearest"),uTexSize:ee("v2")}),Ode=Qt("copy",zr,tH);function dp(t,e){let r=U(w({},Ir),{tColor:C.create(e),uTexSize:C.create(ne.create(e.getWidth(),e.getHeight()))}),n=w({},Bde),o=dr(t,"triangles",Ode,n,r);return mr(o,r)}var oH=new Uint32Array([0,1,2,1,3,2]),Fde=new Float32Array([0,1,0,0,1,1,1,0]),iH={nearest:"Nearest",catmulrom:"Catmulrom (Cubic)",mitchell:"Mitchell (Cubic)",bspline:"B-Spline (Cubic)"},aH=Object.keys(iH);var fd;(function(t){function e(m,p,h,f){return f?o(m,p,h,f):n(m,p,h)}t.create=e;function r(m){return Ai([m.cornerBuffer.ref.version])}function n(m,p,h){let f=te(),b=-1,v=m.width,x=m.height,S={kind:"image",imageTexture:C.create(m),imageTextureDim:C.create(ne.create(v,x)),cornerBuffer:C.create(p),groupTexture:C.create(h),get boundingSphere(){let T=r(S);if(T!==b){let E=Nde(S.cornerBuffer.ref.value);te.copy(f,E),b=T}return f}};return S}function o(m,p,h,f){let b=m.width,v=m.height;return C.update(f.imageTexture,m),C.update(f.imageTextureDim,ne.set(f.imageTextureDim.ref.value,b,v)),C.update(f.cornerBuffer,p),C.update(f.groupTexture,h),f}function i(m){let p=Zr(0,4,Uint8Array),h=m?m.cornerBuffer.ref.value:new Float32Array(8*3),f=Zr(0,4,Uint8Array);return e(p,h,f,m)}t.createEmpty=i,t.Params=U(w({},ge.Params),{interpolation:g.Select("bspline",g.objectToOptions(iH))}),t.Utils={Params:t.Params,createEmpty:i,createValues:a,createValuesSimple:s,updateValues:l,updateBoundingSphere:c,createRenderableState:u,updateRenderableState:d,createPositionIterator:()=>jt(1,1,1,()=>Lo)};function a(m,p,h,f,b){let{instanceCount:v,groupCount:x}=h,S=t.Utils.createPositionIterator(m,p),T=uo(h,S,f.color),E=b.instanceGranularity?jr(v,"instance"):jr(v*x,"groupInstance"),_=ga(),D=ya(),P=xa(),A=ba(),I=va(),k={drawCount:oH.length,vertexCount:Jx.length/3,groupCount:x,instanceCount:v},M=te.clone(m.boundingSphere),R=Hn(M,p.aTransform.ref.value,v,0);return U(w(w(w(w(w(w(w(w(w({dGeometryType:C.create("image")},T),E),_),D),P),A),I),p),ge.createValues(b,k)),{aPosition:m.cornerBuffer,aUv:C.create(Fde),elements:C.create(oH),aGroup:C.create(Ri(new Float32Array(4))),boundingSphere:C.create(R),invariantBoundingSphere:C.create(M),uInvariantBoundingSphere:C.create(at.ofSphere(M)),dInterpolation:C.create(b.interpolation),uImageTexDim:m.imageTextureDim,tImageTex:m.imageTexture,tGroupTex:m.groupTexture})}function s(m,p,h,f,b){let v=ge.createSimple(h,f,b),x=w(w({},g.getDefaultValues(t.Params)),p);return a(m,v.transform,v.locationIterator,v.theme,x)}function l(m,p){ge.updateValues(m,p),C.updateIfChanged(m.dInterpolation,p.interpolation)}function c(m,p){let h=te.clone(p.boundingSphere),f=Hn(h,m.aTransform.ref.value,m.instanceCount.ref.value,0);te.equals(f,m.boundingSphere.ref.value)||C.update(m.boundingSphere,f),te.equals(h,m.invariantBoundingSphere.ref.value)||(C.update(m.invariantBoundingSphere,h),C.update(m.uInvariantBoundingSphere,at.fromSphere(m.uInvariantBoundingSphere.ref.value,h)))}function u(m){let p=ge.createRenderableState(m);return p.opaque=!1,p}function d(m,p){ge.updateRenderableState(m,p),m.opaque=!1}})(fd||(fd={}));function Nde(t){let e=y(),r=[];for(let i=0,a=t.length;i<a;i+=3){let s=y.fromArray(y(),t,i);r.push(s),y.add(e,e,s)}y.scale(e,e,1/(t.length/3));let n=0;for(let i of r){let a=y.distance(e,i);a>n&&(n=a)}let o=te.create(e,n);return te.setExtrema(o,r),o}var xo;(function(t){function e(h,f,b,v,x,S,T,E,_,D){return D?i(h,f,b,v,x,S,T,E,_,D):o(h,f,b,v,x,S,T,E,_)}t.create=e;function r(h){let f=h?h.mappingBuffer.ref.value:new Float32Array(0),b=h?h.indexBuffer.ref.value:new Uint32Array(0),v=h?h.groupBuffer.ref.value:new Float32Array(0),x=h?h.startBuffer.ref.value:new Float32Array(0),S=h?h.endBuffer.ref.value:new Float32Array(0),T=h?h.scaleBuffer.ref.value:new Float32Array(0),E=h?h.capBuffer.ref.value:new Float32Array(0),_=h?h.colorModeBuffer.ref.value:new Float32Array(0);return e(f,b,v,x,S,T,E,_,0,h)}t.createEmpty=r;function n(h){return Ai([h.cylinderCount,h.mappingBuffer.ref.version,h.indexBuffer.ref.version,h.groupBuffer.ref.version,h.startBuffer.ref.version,h.endBuffer.ref.version,h.scaleBuffer.ref.version,h.capBuffer.ref.version,h.colorModeBuffer.ref.version])}function o(h,f,b,v,x,S,T,E,_){let D=te(),P,A=-1,I=-1,k={kind:"cylinders",cylinderCount:_,mappingBuffer:C.create(h),indexBuffer:C.create(f),groupBuffer:C.create(b),startBuffer:C.create(v),endBuffer:C.create(x),scaleBuffer:C.create(S),capBuffer:C.create(T),colorModeBuffer:C.create(E),get boundingSphere(){let M=n(k);if(M!==A){let R=Pl(k.startBuffer.ref.value,k.cylinderCount*6,6),B=Pl(k.endBuffer.ref.value,k.cylinderCount*6,6);te.expandBySphere(D,R,B),A=M}return D},get groupMapping(){return k.groupBuffer.ref.version!==I&&(P=Zc(k.groupBuffer.ref.value,k.cylinderCount,6),I=k.groupBuffer.ref.version),P},setBoundingSphere(M){te.copy(D,M),A=n(k)}};return k}function i(h,f,b,v,x,S,T,E,_,D){return _>D.cylinderCount&&(C.update(D.mappingBuffer,h),C.update(D.indexBuffer,f)),D.cylinderCount=_,C.update(D.groupBuffer,b),C.update(D.startBuffer,v),C.update(D.endBuffer,x),C.update(D.scaleBuffer,S),C.update(D.capBuffer,T),C.update(D.colorModeBuffer,E),D}function a(h,f){let b=h.startBuffer.ref.value;$c(f,b,0,h.cylinderCount*6),C.update(h.startBuffer,b);let v=h.endBuffer.ref.value;$c(f,v,0,h.cylinderCount*6),C.update(h.endBuffer,v)}t.transform=a,t.Params=U(w({},ge.Params),{sizeFactor:g.Numeric(1,{min:0,max:10,step:.1}),sizeAspectRatio:g.Numeric(1,{min:0,max:3,step:.01}),doubleSided:g.Boolean(!1,ge.CustomQualityParamInfo),ignoreLight:g.Boolean(!1,ge.ShadingCategory),xrayShaded:g.Select(!1,[[!1,"Off"],[!0,"On"],["inverted","Inverted"]],ge.ShadingCategory),transparentBackfaces:g.Select("off",g.arrayToOptions(["off","on","opaque"]),ge.ShadingCategory),solidInterior:g.Boolean(!0,ge.ShadingCategory),bumpFrequency:g.Numeric(0,{min:0,max:10,step:.1},ge.ShadingCategory),bumpAmplitude:g.Numeric(1,{min:0,max:5,step:.1},ge.ShadingCategory),colorMode:g.Select("default",g.arrayToOptions(["default","interpolate"]),ge.ShadingCategory)}),t.Utils={Params:t.Params,createEmpty:r,createValues:l,createValuesSimple:c,updateValues:u,updateBoundingSphere:d,createRenderableState:m,updateRenderableState:p,createPositionIterator:s};function s(h,f){let b=h.cylinderCount*6,v=f.instanceCount.ref.value,x=Ss(),S=x.position,T=h.startBuffer.ref.value,E=h.endBuffer.ref.value,_=f.aTransform.ref.value;return jt(b,v,2,(P,A)=>{let I=P%6===0?T:E;return A<0?y.fromArray(S,I,P*3):y.transformMat4Offset(S,I,_,0,P*3,A*16),x})}function l(h,f,b,v,x){let{instanceCount:S,groupCount:T}=b,E=s(h,f),_=uo(b,E,v.color),D=Sa(b,v.size),P=x.instanceGranularity?jr(S,"instance"):jr(S*T,"groupInstance"),A=ga(),I=ya(),k=xa(),M=ba(),R=va(),B={drawCount:h.cylinderCount*4*3,vertexCount:h.cylinderCount*6,groupCount:T,instanceCount:S},F=bf(D)*x.sizeFactor,G=te.clone(h.boundingSphere),V=Hn(G,f.aTransform.ref.value,S,0);return U(w(U(w(w(w(w(w(w(w(w(w({dGeometryType:C.create("cylinders"),aMapping:h.mappingBuffer,aGroup:h.groupBuffer,aStart:h.startBuffer,aEnd:h.endBuffer,aScale:h.scaleBuffer,aCap:h.capBuffer,aColorMode:h.colorModeBuffer,elements:h.indexBuffer,boundingSphere:C.create(V),invariantBoundingSphere:C.create(G),uInvariantBoundingSphere:C.create(at.ofSphere(G))},_),D),P),A),I),k),M),R),f),{padding:C.create(F)}),ge.createValues(x,B)),{uSizeFactor:C.create(x.sizeFactor*x.sizeAspectRatio),uDoubleSided:C.create(x.doubleSided),dIgnoreLight:C.create(x.ignoreLight),dXrayShaded:C.create(x.xrayShaded==="inverted"?"inverted":x.xrayShaded===!0?"on":"off"),dTransparentBackfaces:C.create(x.transparentBackfaces),dSolidInterior:C.create(x.solidInterior),uBumpFrequency:C.create(x.bumpFrequency),uBumpAmplitude:C.create(x.bumpAmplitude),dDualColor:C.create(x.colorMode==="interpolate")})}function c(h,f,b,v,x){let S=ge.createSimple(b,v,x),T=w(w({},g.getDefaultValues(t.Params)),f);return l(h,S.transform,S.locationIterator,S.theme,T)}function u(h,f){ge.updateValues(h,f),C.updateIfChanged(h.uSizeFactor,f.sizeFactor*f.sizeAspectRatio),C.updateIfChanged(h.uDoubleSided,f.doubleSided),C.updateIfChanged(h.dIgnoreLight,f.ignoreLight),C.updateIfChanged(h.dXrayShaded,f.xrayShaded==="inverted"?"inverted":f.xrayShaded===!0?"on":"off"),C.updateIfChanged(h.dTransparentBackfaces,f.transparentBackfaces),C.updateIfChanged(h.dSolidInterior,f.solidInterior),C.updateIfChanged(h.uBumpFrequency,f.bumpFrequency),C.updateIfChanged(h.uBumpAmplitude,f.bumpAmplitude),C.updateIfChanged(h.dDualColor,f.colorMode==="interpolate")}function d(h,f){let b=te.clone(f.boundingSphere),v=Hn(b,h.aTransform.ref.value,h.instanceCount.ref.value,0);te.equals(v,h.boundingSphere.ref.value)||C.update(h.boundingSphere,v),te.equals(b,h.invariantBoundingSphere.ref.value)||(C.update(h.invariantBoundingSphere,b),C.update(h.uInvariantBoundingSphere,at.fromSphere(h.uInvariantBoundingSphere.ref.value,b)))}function m(h){let f=ge.createRenderableState(h);return p(f,h),f}function p(h,f){ge.updateRenderableState(h,f),h.opaque=h.opaque&&!f.xrayShaded,h.writeDepth=h.opaque}})(xo||(xo={}));var eo;(function(t){function e(a){switch(a.kind){case"mesh":return a.triangleCount*3;case"points":return a.pointCount;case"spheres":return a.sphereCount*2*3;case"cylinders":return a.cylinderCount*4*3;case"text":return a.charCount*2*3;case"lines":return a.lineCount*2*3;case"direct-volume":return 12*3;case"image":return 2*3;case"texture-mesh":return a.vertexCount}}t.getDrawCount=e;function r(a){switch(a.kind){case"mesh":return a.vertexCount;case"points":return a.pointCount;case"spheres":return a.sphereCount*6;case"cylinders":return a.cylinderCount*6;case"text":return a.charCount*4;case"lines":return a.lineCount*4;case"direct-volume":let[s,l,c]=a.gridDimension.ref.value;return s*l*c;case"image":return 4;case"texture-mesh":return a.vertexCount}}t.getVertexCount=r;function n(a){switch(a.kind){case"mesh":case"points":case"spheres":case"cylinders":case"text":case"lines":return e(a)===0?0:Mi(a.groupBuffer.ref.value)+1;case"direct-volume":return 1;case"image":return Mi(a.groupTexture.ref.value.array)+1;case"texture-mesh":return a.groupCount}}t.getGroupCount=n;function o(a){switch(a.kind){case"mesh":return Be.Utils;case"points":return Il.Utils;case"spheres":return Ni.Utils;case"cylinders":return xo.Utils;case"text":return Bo.Utils;case"lines":return Sr.Utils;case"direct-volume":return ta.Utils;case"image":return fd.Utils;case"texture-mesh":return Ko.Utils}}t.getUtils=o;function i(a,s){return s==="instance"&&a.nonInstanceable?"group":s}t.getGranularity=i})(eo||(eo={}));var Vde=1,zde="Assigns sizes as defined by the shape object.",sH={};function Ude(t){return sH}function o2(t,e){return{factory:o2,granularity:"groupInstance",size:r=>bi.isLocation(r)?r.shape.getSize(r.group,r.instance):Vde,props:e,description:zde}}var lH={name:"shape-group",label:"Shape Group",category:"",factory:o2,getParams:Ude,defaultValues:g.getDefaultValues(sH),isApplicable:t=>!!t.shape};var Gde=ce(13421772),jde="Assigns colors as defined by the shape object.",cH={};function Hde(t){return cH}function i2(t,e){return{factory:i2,granularity:"groupInstance",color:r=>bi.isLocation(r)?r.shape.getColor(r.group,r.instance):Gde,props:e,description:jde}}var uH={name:"shape-group",label:"Shape Group",category:zt.Misc,factory:i2,getParams:Hde,defaultValues:g.getDefaultValues(cH),isApplicable:t=>!!t.shape};var qde=U(w({},_a),{aPosition:hr("float32",3,0),elements:eu("uint32"),uBboxMin:ee("v3"),uBboxMax:ee("v3"),uBboxSize:ee("v3"),uMaxSteps:ee("i"),uStepScale:ee("f"),uJumpLength:ee("f"),uTransform:ee("m4"),uGridDim:ee("v3"),tTransferTex:We("image-uint8","alpha","ubyte","linear"),uTransferScale:ee("f","material"),dGridTexType:Ye("string",["2d","3d"]),uGridTexDim:ee("v3"),tGridTex:We("texture","rgba","ubyte","linear"),uGridStats:ee("v4"),uCellDim:ee("v3"),uCartnToUnit:ee("m4"),uUnitToCartn:ee("m4"),dPackedGroup:Ye("boolean"),dAxisOrder:Ye("string",["012","021","102","120","201","210"]),dIgnoreLight:Ye("boolean"),dXrayShaded:Ye("string",["off","on","inverted"])});function dH(t,e,r,n,o,i){let a=w(w(w(w({},Ca),Ta),wa),qde);t.isWebGL2||(a.uMaxSteps=Ye("number"));let s={uObjectId:C.create(e)},c=Pa(t,"triangles",SG,a,w(w({},r),s),o,i);return Ea(c,r,n)}var Wde=U(w({},_a),{aGroup:hr("float32",1,0),aPosition:hr("float32",3,0),aNormal:hr("float32",3,0),elements:eu("uint32"),dVaryingGroup:Ye("boolean"),dFlatShaded:Ye("boolean"),uDoubleSided:ee("b","material"),dFlipSided:Ye("boolean"),dIgnoreLight:Ye("boolean"),dXrayShaded:Ye("string",["off","on","inverted"]),dTransparentBackfaces:Ye("string",["off","on","opaque"]),uBumpFrequency:ee("f","material"),uBumpAmplitude:ee("f","material"),meta:Mr("unknown")});function mH(t,e,r,n,o,i){let a=w(w(w(w({},Ca),Ta),wa),Wde),s={uObjectId:C.create(e)},c=Pa(t,"triangles",zT,a,w(w({},r),s),o,i);return Ea(c,r,n)}var Xde=U(w(w({},_a),sm),{aGroup:hr("float32",1,0),aPosition:hr("float32",3,0),dPointSizeAttenuation:Ye("boolean"),dPointStyle:Ye("string",["square","circle","fuzzy"])});function pH(t,e,r,n,o,i){let a=w(w(w(w({},Ca),Ta),wa),Xde),s={uObjectId:C.create(e)},c=Pa(t,"points",gG,a,w(w({},r),s),o,i);return Ea(c,r,n)}var Yde=U(w(w({},_a),sm),{aGroup:hr("float32",1,0),aMapping:hr("float32",2,0),aStart:hr("float32",3,0),aEnd:hr("float32",3,0),elements:eu("uint32"),dLineSizeAttenuation:Ye("boolean"),uDoubleSided:ee("b","material"),dFlipSided:Ye("boolean")});function fH(t,e,r,n,o,i){let a=w(w(w(w({},Ca),Ta),wa),Yde),s={uObjectId:C.create(e)},c=Pa(t,"triangles",xG,a,w(w({},r),s),o,i);return Ea(c,r,n)}var Qde=U(w(w({},_a),sm),{uTexDim:ee("v2"),tPositionGroup:We("image-float32","rgba","float","nearest"),padding:Mr("number"),uDoubleSided:ee("b","material"),dIgnoreLight:Ye("boolean"),dXrayShaded:Ye("string",["off","on","inverted"]),dTransparentBackfaces:Ye("string",["off","on","opaque"]),dSolidInterior:Ye("boolean"),dClipPrimitive:Ye("boolean"),dApproximate:Ye("boolean"),uAlphaThickness:ee("f"),uBumpFrequency:ee("f","material"),uBumpAmplitude:ee("f","material"),lodLevels:Mr("unknown"),centerBuffer:Mr("float32"),groupBuffer:Mr("float32")});function hH(t,e,r,n,o,i){let a=w(w(w(w({},Ca),Ta),wa),Qde),s={uObjectId:C.create(e)},c=Pa(t,"triangles",yG,a,w(w({},r),s),o,i);return Ea(c,r,n)}var Kde=U(w(w({},_a),sm),{aGroup:hr("float32",1,0),aPosition:hr("float32",3,0),aMapping:hr("float32",2,0),aDepth:hr("float32",1,0),elements:eu("uint32"),aTexCoord:hr("float32",2,0),tFont:We("image-uint8","alpha","ubyte","linear"),padding:Mr("number"),uBorderWidth:ee("f","material"),uBorderColor:ee("v3","material"),uOffsetX:ee("f","material"),uOffsetY:ee("f","material"),uOffsetZ:ee("f","material"),uBackgroundColor:ee("v3","material"),uBackgroundOpacity:ee("f","material")});function gH(t,e,r,n,o,i){let a=w(w(w(w({},Ca),Ta),wa),Kde),s={uObjectId:C.create(e)},c=Pa(t,"triangles",bG,a,w(w({},r),s),o,i);return Ea(c,r,n)}var $de=U(w({},_a),{uGeoTexDim:ee("v2","buffered"),tPosition:We("texture","rgb","float","nearest"),tGroup:We("texture","alpha","float","nearest"),tNormal:We("texture","rgb","float","nearest"),dVaryingGroup:Ye("boolean"),dFlatShaded:Ye("boolean"),uDoubleSided:ee("b","material"),dFlipSided:Ye("boolean"),dIgnoreLight:Ye("boolean"),dXrayShaded:Ye("string",["off","on","inverted"]),dTransparentBackfaces:Ye("string",["off","on","opaque"]),uBumpFrequency:ee("f","material"),uBumpAmplitude:ee("f","material"),meta:Mr("unknown")});function yH(t,e,r,n,o,i){let a=w(w(w(w({},Ca),Ta),wa),$de),s={uObjectId:C.create(e)},c=Pa(t,"triangles",zT,a,w(w({},r),s),o,i);return Ea(c,r,n)}var Zde=U(w({},_a),{aGroup:hr("float32",1,0),aPosition:hr("float32",3,0),aUv:hr("float32",2,0),elements:eu("uint32"),uImageTexDim:ee("v2"),tImageTex:We("image-uint8","rgba","ubyte","nearest"),tGroupTex:We("image-uint8","rgba","ubyte","nearest"),dInterpolation:Ye("string",aH)});function vH(t,e,r,n,o,i){let a=w(w(w(w({},Ca),Ta),wa),Zde),s={uObjectId:C.create(e)},c=Pa(t,"triangles",CG,a,w(w({},r),s),o,i);return Ea(c,r,n)}var Jde=U(w(w({},_a),sm),{aGroup:hr("float32",1,0),aStart:hr("float32",3,0),aEnd:hr("float32",3,0),aMapping:hr("float32",3,0),aScale:hr("float32",1,0),aCap:hr("float32",1,0),aColorMode:hr("float32",1,0),elements:eu("uint32"),padding:Mr("number"),uDoubleSided:ee("b","material"),dIgnoreLight:Ye("boolean"),dXrayShaded:Ye("string",["off","on","inverted"]),dTransparentBackfaces:Ye("string",["off","on","opaque"]),dSolidInterior:Ye("boolean"),uBumpFrequency:ee("f","material"),uBumpAmplitude:ee("f","material"),dDualColor:Ye("boolean")});function bH(t,e,r,n,o,i){let a=w(w(w(w({},Ca),Ta),wa),Jde),s={uObjectId:C.create(e)},c=Pa(t,"triangles",vG,a,w(w({},r),s),o,i);return Ea(c,r,n)}var eme=bo(0,2147483647),rl=bo(0,2147483647);function tu(t,e,r,n){return{id:eme(),type:t,values:e,state:r,materialId:n}}function xH(t,e,r){switch(e.type){case"mesh":return mH(t,e.id,e.values,e.state,e.materialId,r);case"points":return pH(t,e.id,e.values,e.state,e.materialId,r);case"spheres":return hH(t,e.id,e.values,e.state,e.materialId,r);case"cylinders":return bH(t,e.id,e.values,e.state,e.materialId,r);case"text":return gH(t,e.id,e.values,e.state,e.materialId,r);case"lines":return fH(t,e.id,e.values,e.state,e.materialId,r);case"direct-volume":return dH(t,e.id,e.values,e.state,e.materialId,r);case"image":return vH(t,e.id,e.values,e.state,e.materialId,r);case"texture-mesh":return yH(t,e.id,e.values,e.state,e.materialId,r)}throw new Error("unsupported type")}var Yt;(function(t){function e(u,d,m,p,h,f,b){return{id:vo.create22(),name:u,sourceData:d,geometry:m,transforms:b||[W.identity()],get groupCount(){return eo.getGroupCount(m)},getColor:p,getSize:h,getLabel:f}}t.create=e;function r(u){return{color:i2({shape:u},{}),size:o2({shape:u},{})}}t.getTheme=r;function n(u){let d=u.transforms.length,m=bi.Location(u),p=(h,f)=>(m.group=h,m.instance=f,m);return jt(u.groupCount,d,1,p)}t.groupIterator=n;function o(u,d,m,p,h){let f=h&&h.aTransform.ref.value.length>=u.length*16?h.aTransform.ref.value:new Float32Array(u.length*16);for(let b=0,v=u.length;b<v;++b)W.toArray(u[b],f,b*16);return Xx(f,u.length,d,m,p,h)}t.createTransform=o;function i(u,d){let m=r(u),p=eo.getUtils(u.geometry),h=rl(),f=n(u),b=o(u.transforms,u.geometry.boundingSphere,d.cellSize,d.batchSize),v=p.createValues(u.geometry,b,f,m,d),x=p.createRenderableState(d);return tu(u.geometry.kind,v,x,h)}t.createRenderObject=i;function a(u){return{kind:"shape-loci",shape:u}}t.Loci=a;function s(u){return!!u&&u.kind==="shape-loci"}t.isLoci=s;function l(u,d){return u.shape===d.shape}t.areLociEqual=l;function c(u){return u.shape.groupCount===0}t.isLociEmpty=c})(Yt||(Yt={}));var bi;(function(t){function e(p,h=0,f=0){return{kind:"group-location",shape:p,group:h,instance:f}}t.Location=e;function r(p){return!!p&&p.kind==="group-location"}t.isLocation=r;function n(p,h){return{kind:"group-loci",shape:p,groups:h}}t.Loci=n;function o(p){return!!p&&p.kind==="group-loci"}t.isLoci=o;function i(p,h){if(p.shape!==h.shape||p.groups.length!==h.groups.length)return!1;for(let f=0,b=p.groups.length;f<b;++f){let{ids:v,instance:x}=p.groups[f],{ids:S,instance:T}=h.groups[f];if(x!==T||!we.areEqual(v,S))return!1}return!0}t.areLociEqual=i;function a(p){return s(p)===0}t.isLociEmpty=a;function s(p){let h=0;for(let f of p.groups)h+=we.size(f.ids);return h}t.size=s;let l=new np,c=y.zero();function u(p,h,f,b){let{indices:v,offsets:x}=h;for(let{ids:S,instance:T}of p)we.forEach(S,E=>{for(let _=x[E],D=x[E+1];_<D;++_)y.fromArray(c,f,v[_]*3),y.transformMat4(c,c,b[T]),l.includeStep(c)})}function d(p,h,f,b){let{indices:v,offsets:x}=h;for(let{ids:S,instance:T}of p)we.forEach(S,E=>{for(let _=x[E],D=x[E+1];_<D;++_)y.fromArray(c,f,v[_]*3),y.transformMat4(c,c,b[T]),l.radiusStep(c)})}function m(p,h){h||(h=te()),l.reset();let f=0,{geometry:b,transforms:v}=p.shape;if(b.kind==="mesh"||b.kind==="points"){let x=b.kind==="mesh"?b.vertexBuffer.ref.value:b.centerBuffer.ref.value;u(p.groups,b.groupMapping,x,v),l.finishedIncludeStep(),d(p.groups,b.groupMapping,x,v)}else if(b.kind==="lines"){let x=b.startBuffer.ref.value,S=b.endBuffer.ref.value;u(p.groups,b.groupMapping,x,v),u(p.groups,b.groupMapping,S,v),l.finishedIncludeStep(),d(p.groups,b.groupMapping,x,v),d(p.groups,b.groupMapping,S,v)}else if(b.kind==="spheres"||b.kind==="text"){let x=b.centerBuffer.ref.value;u(p.groups,b.groupMapping,x,v),l.finishedIncludeStep(),d(p.groups,b.groupMapping,x,v);for(let{ids:S,instance:T}of p.groups)we.forEach(S,E=>{let _=p.shape.getSize(E,T);f<_&&(f=_)})}else return te.copy(h,b.boundingSphere);return y.copy(h.center,l.center),h.radius=Math.sqrt(l.radiusSq),te.expand(h,h,f),h}t.getBoundingSphere=m})(bi||(bi={}));var xf={kind:"every-loci"};function So(t){return!!t&&t.kind==="every-loci"}var St={kind:"empty-loci"};function Wn(t){return!!t&&t.kind==="empty-loci"}function Ag(t){return!!t&&t.kind==="data-loci"}function tme(t,e){if(!ep(t.data,e.data)||t.tag!==e.tag||t.elements.length!==e.elements.length)return!1;for(let r=0,n=t.elements.length;r<n;++r)if(!ep(t.elements[r],e.elements[r]))return!1;return!0}function rme(t){return t.elements.length===0}function Sf(t,e,r,n,o){return{kind:"data-loci",tag:t,data:e,elements:r,getBoundingSphere:n,getLabel:o}}var st;(function(t){let e=new Zs("98");function r(f){let b=f.loci.map(v=>s(v)).filter(v=>!!v);e.reset();for(let v of b)e.includePositionRadius(v.center,v.radius);e.finishedIncludeStep();for(let v of b)e.radiusPositionRadius(v.center,v.radius);return e.getSphere()}t.getBundleBoundingSphere=r;function n(f,b){return So(f)&&So(b)||Wn(f)&&Wn(b)?!0:Ag(f)&&Ag(b)?tme(f,b):ue.isLoci(f)&&ue.isLoci(b)?ue.areLociEqual(f,b):z.Loci.is(f)&&z.Loci.is(b)?z.Loci.areEqual(f,b):ze.isLoci(f)&&ze.isLoci(b)?ze.areLociEqual(f,b):Yt.isLoci(f)&&Yt.isLoci(b)?Yt.areLociEqual(f,b):bi.isLoci(f)&&bi.isLoci(b)?bi.areLociEqual(f,b):xe.isLoci(f)&&xe.isLoci(b)?xe.areLociEqual(f,b):xe.Isosurface.isLoci(f)&&xe.Isosurface.isLoci(b)?xe.Isosurface.areLociEqual(f,b):xe.Cell.isLoci(f)&&xe.Cell.isLoci(b)?xe.Cell.areLociEqual(f,b):xe.Segment.isLoci(f)&&xe.Segment.isLoci(b)?xe.Segment.areLociEqual(f,b):!1}t.areEqual=n;function o(f){return!!f&&f.kind==="every-loci"}t.isEvery=o;function i(f){return So(f)?!1:Wn(f)?!0:Ag(f)?rme(f):ue.isLoci(f)?ue.isLociEmpty(f):z.Loci.is(f)?z.Loci.isEmpty(f):ze.isLoci(f)?ze.isLociEmpty(f):Yt.isLoci(f)?Yt.isLociEmpty(f):bi.isLoci(f)?bi.isLociEmpty(f):xe.isLoci(f)?xe.isLociEmpty(f):xe.Isosurface.isLoci(f)?xe.Isosurface.isLociEmpty(f):xe.Cell.isLoci(f)?xe.Cell.isLociEmpty(f):xe.Segment.isLoci(f)?xe.Segment.isLociEmpty(f):!1}t.isEmpty=i;function a(f,b){return b instanceof ue&&(z.Loci.is(f)?f=z.Loci.remap(f,b):ue.isLoci(f)?f=ue.remapLoci(f,b):ze.isLoci(f)&&(f=ze.remapLoci(f,b))),f}t.remap=a;function s(f,b){var v;if(!(f.kind==="every-loci"||f.kind==="empty-loci")){if(b||(b=te()),f.kind==="structure-loci")return te.copy(b,f.structure.boundary.sphere);if(f.kind==="element-loci")return te.copy(b,z.Loci.getBoundary(f).sphere);if(f.kind==="bond-loci")return ze.getBoundingSphere(f,b);if(f.kind==="shape-loci")return te.copy(b,f.shape.geometry.boundingSphere);if(f.kind==="group-loci")return bi.getBoundingSphere(f,b);if(f.kind==="data-loci")return(v=f.getBoundingSphere)===null||v===void 0?void 0:v.call(f,b);if(f.kind==="volume-loci")return xe.getBoundingSphere(f.volume,b);if(f.kind==="isosurface-loci")return xe.Isosurface.getBoundingSphere(f.volume,f.isoValue,b);if(f.kind==="cell-loci")return xe.Cell.getBoundingSphere(f.volume,f.indices,b);if(f.kind==="segment-loci")return xe.Segment.getBoundingSphere(f.volume,f.segments,b)}}t.getBoundingSphere=s;let l=te.zero();function c(f,b){let v=s(f,l);return v?y.copy(b||y(),v.center):void 0}t.getCenter=c;function u(f){if(!(f.kind==="every-loci"||f.kind==="empty-loci")){if(f.kind==="structure-loci")return z.Loci.getPrincipalAxes(ue.toStructureElementLoci(f.structure));if(f.kind==="element-loci")return z.Loci.getPrincipalAxes(f);if(f.kind==="bond-loci")return;if(f.kind==="shape-loci")return;if(f.kind==="group-loci")return;if(f.kind==="data-loci")return;if(f.kind==="volume-loci")return;if(f.kind==="isosurface-loci")return;if(f.kind==="cell-loci")return;if(f.kind==="segment-loci")return}}t.getPrincipalAxes=u;let d={element:f=>f,residue:f=>z.Loci.is(f)?z.Loci.extendToWholeResidues(f,!0):f,chain:f=>z.Loci.is(f)?z.Loci.extendToWholeChains(f):f,entity:f=>z.Loci.is(f)?z.Loci.extendToWholeEntities(f):f,model:f=>z.Loci.is(f)?z.Loci.extendToWholeModels(f):f,operator:f=>z.Loci.is(f)?z.Loci.extendToWholeOperators(f):f,structure:f=>z.Loci.is(f)?ue.toStructureElementLoci(f.structure):bi.isLoci(f)?Yt.Loci(f.shape):xe.Cell.isLoci(f)?xe.Loci(f.volume):f,elementInstances:f=>z.Loci.is(f)?z.Loci.extendToAllInstances(f):f,residueInstances:f=>z.Loci.is(f)?z.Loci.extendToAllInstances(z.Loci.extendToWholeResidues(f,!0)):f,chainInstances:f=>z.Loci.is(f)?z.Loci.extendToAllInstances(z.Loci.extendToWholeChains(f)):f};t.GranularityOptions=g.objectToOptions(d,f=>{switch(f){case"element":return"Atom/Coarse Element";case"elementInstances":return["Atom/Coarse Element Instances","With Symmetry"];case"structure":return"Structure/Shape";default:return f.indexOf("Instances")?[ic(f),"With Symmetry"]:ic(f)}});function m(f){return f.replace("Instances","")}t.simpleGranularity=m;function p(f,b){return d[b](f)}t.applyGranularity=p;function h(f,b,v=!1){return(b!=="element"||v)&&ze.isLoci(f)&&(f=ze.toStructureElementLoci(f)),ue.isLoci(f)&&(f=ue.toStructureElementLoci(f.structure)),z.Loci.is(f)&&(f=z.Loci.remap(f,f.structure.root)),b&&(f=p(f,b)),f}t.normalize=h})(st||(st={}));function SH(t){return Object.keys(t).filter(e=>!isNaN(e)).map(e=>+e).sort((e,r)=>e-r).map(e=>t[e])}function a2(t,e,r){return t&&t[e]!==void 0?t[e]:r}function Ie(t,...e){return{kind:"alias",aliases:e,symbol:t}}function s2(t,e,...r){return t.info.namespace="molscript-macro",t.id=`molscript-macro.${t.info.name}`,{kind:"macro",symbol:t,translate:e,aliases:[t.info.name,...r]}}function nme(t){return t.kind==="alias"||t.kind==="macro"}var ome=[["Core symbols",Ie(re.core.type.bool,"bool"),Ie(re.core.type.num,"num"),Ie(re.core.type.str,"str"),Ie(re.core.type.regex,"regex"),Ie(re.core.type.list,"list"),Ie(re.core.type.set,"set"),Ie(re.core.type.compositeKey,"composite-key"),Ie(re.core.logic.not,"not"),Ie(re.core.logic.and,"and"),Ie(re.core.logic.or,"or"),Ie(re.core.ctrl.if,"if"),Ie(re.core.ctrl.fn,"fn"),Ie(re.core.ctrl.eval,"eval"),Ie(re.core.math.add,"add","+"),Ie(re.core.math.sub,"sub","-"),Ie(re.core.math.mult,"mult","*"),Ie(re.core.math.div,"div","/"),Ie(re.core.math.pow,"pow","**"),Ie(re.core.math.mod,"mod"),Ie(re.core.math.min,"min"),Ie(re.core.math.max,"max"),Ie(re.core.math.cantorPairing,"cantor-pairing"),Ie(re.core.math.sortedCantorPairing,"sorted-cantor-pairing"),Ie(re.core.math.invertCantorPairing,"invert-cantor-pairing"),Ie(re.core.math.floor,"floor"),Ie(re.core.math.ceil,"ceil"),Ie(re.core.math.roundInt,"round"),Ie(re.core.math.trunc,"trunc"),Ie(re.core.math.abs,"abs"),Ie(re.core.math.sign,"sign"),Ie(re.core.math.sqrt,"sqrt"),Ie(re.core.math.cbrt,"cbrt"),Ie(re.core.math.sin,"sin"),Ie(re.core.math.cos,"cos"),Ie(re.core.math.tan,"tan"),Ie(re.core.math.asin,"asin"),Ie(re.core.math.acos,"acos"),Ie(re.core.math.atan,"atan"),Ie(re.core.math.sinh,"sinh"),Ie(re.core.math.cosh,"cosh"),Ie(re.core.math.tanh,"tanh"),Ie(re.core.math.exp,"exp"),Ie(re.core.math.log,"log"),Ie(re.core.math.log10,"log10"),Ie(re.core.math.atan2,"atan2"),Ie(re.core.rel.eq,"eq","="),Ie(re.core.rel.neq,"neq","!="),Ie(re.core.rel.lt,"lt","<"),Ie(re.core.rel.lte,"lte","<="),Ie(re.core.rel.gr,"gr",">"),Ie(re.core.rel.gre,"gre",">="),Ie(re.core.rel.inRange,"in-range"),Ie(re.core.str.concat,"concat"),Ie(re.core.str.match,"regex.match"),Ie(re.core.list.getAt,"list.get"),Ie(re.core.set.has,"set.has"),Ie(re.core.set.isSubset,"set.subset")],["Structure",["Types",Ie(re.structureQuery.type.entityType,"ent-type"),Ie(re.structureQuery.type.authResidueId,"auth-resid"),Ie(re.structureQuery.type.labelResidueId,"label-resid"),Ie(re.structureQuery.type.ringFingerprint,"ringfp"),Ie(re.structureQuery.type.bondFlags,"bond-flags")],["Slots",Ie(re.structureQuery.slot.elementSetReduce,"atom.set.reduce.value")],["Generators",Ie(re.structureQuery.generator.atomGroups,"sel.atom.atom-groups"),Ie(re.structureQuery.generator.queryInSelection,"sel.atom.query-in-selection"),Ie(re.structureQuery.generator.rings,"sel.atom.rings"),Ie(re.structureQuery.generator.empty,"sel.atom.empty"),Ie(re.structureQuery.generator.all,"sel.atom.all"),Ie(re.structureQuery.generator.bondedAtomicPairs,"sel.atom.bonded-pairs"),s2(Nx("sel.atom.atoms",Fx.Dictionary({0:IT(cd.Bool,{isOptional:!0,defaultValue:!0,description:"Test applied to each atom."})}),C0.ElementSelection,"A selection of singleton atom sets."),t=>q.struct.generator.atomGroups({"atom-test":a2(t,0,!0)})),s2(Nx("sel.atom.res",Fx.Dictionary({0:IT(cd.Bool,{isOptional:!0,defaultValue:!0,description:"Test applied to the 1st atom of each residue."})}),C0.ElementSelection,"A selection of atom sets grouped by residue."),t=>q.struct.generator.atomGroups({"residue-test":a2(t,0,!0),"group-by":q.ammp("residueKey")})),s2(Nx("sel.atom.chains",Fx.Dictionary({0:IT(cd.Bool,{isOptional:!0,defaultValue:!0,description:"Test applied to the 1st atom of each chain."})}),C0.ElementSelection,"A selection of atom sets grouped by chain."),t=>q.struct.generator.atomGroups({"chain-test":a2(t,0,!0),"group-by":q.ammp("chainKey")}))],["Modifiers",Ie(re.structureQuery.modifier.queryEach,"sel.atom.query-each"),Ie(re.structureQuery.modifier.intersectBy,"sel.atom.intersect-by"),Ie(re.structureQuery.modifier.exceptBy,"sel.atom.except-by"),Ie(re.structureQuery.modifier.unionBy,"sel.atom.union-by"),Ie(re.structureQuery.modifier.union,"sel.atom.union"),Ie(re.structureQuery.modifier.cluster,"sel.atom.cluster"),Ie(re.structureQuery.modifier.includeSurroundings,"sel.atom.include-surroundings"),Ie(re.structureQuery.modifier.surroundingLigands,"sel.atom.surrounding-ligands"),Ie(re.structureQuery.modifier.includeConnected,"sel.atom.include-connected"),Ie(re.structureQuery.modifier.expandProperty,"sel.atom.expand-property")],["Filters",Ie(re.structureQuery.filter.pick,"sel.atom.pick"),Ie(re.structureQuery.filter.first,"sel.atom.first"),Ie(re.structureQuery.filter.withSameAtomProperties,"sel.atom.with-same-atom-properties"),Ie(re.structureQuery.filter.intersectedBy,"sel.atom.intersected-by"),Ie(re.structureQuery.filter.within,"sel.atom.within"),Ie(re.structureQuery.filter.isConnectedTo,"sel.atom.is-connected-to")],["Combinators",Ie(re.structureQuery.combinator.intersect,"sel.atom.intersect"),Ie(re.structureQuery.combinator.merge,"sel.atom.merge"),Ie(re.structureQuery.combinator.distanceCluster,"sel.atom.dist-cluster")],["Atom Set Properties",Ie(re.structureQuery.atomSet.atomCount,"atom.set.atom-count"),Ie(re.structureQuery.atomSet.countQuery,"atom.set.count-query"),Ie(re.structureQuery.atomSet.reduce,"atom.set.reduce"),Ie(re.structureQuery.atomSet.propertySet,"atom.set.property")],["Atom Properties",Ie(re.structureQuery.atomProperty.core.elementSymbol,"atom.el"),Ie(re.structureQuery.atomProperty.core.vdw,"atom.vdw"),Ie(re.structureQuery.atomProperty.core.mass,"atom.mass"),Ie(re.structureQuery.atomProperty.core.atomicNumber,"atom.atomic-number"),Ie(re.structureQuery.atomProperty.core.x,"atom.x"),Ie(re.structureQuery.atomProperty.core.y,"atom.y"),Ie(re.structureQuery.atomProperty.core.z,"atom.z"),Ie(re.structureQuery.atomProperty.core.sourceIndex,"atom.src-index"),Ie(re.structureQuery.atomProperty.core.operatorName,"atom.op-name"),Ie(re.structureQuery.atomProperty.core.operatorKey,"atom.op-key"),Ie(re.structureQuery.atomProperty.core.modelIndex,"atom.model-index"),Ie(re.structureQuery.atomProperty.core.modelLabel,"atom.model-label"),Ie(re.structureQuery.atomProperty.core.atomKey,"atom.key"),Ie(re.structureQuery.atomProperty.core.bondCount,"atom.bond-count"),Ie(re.structureQuery.atomProperty.topology.connectedComponentKey,"atom.key.molecule"),Ie(re.structureQuery.atomProperty.macromolecular.authResidueId,"atom.auth-resid"),Ie(re.structureQuery.atomProperty.macromolecular.labelResidueId,"atom.label-resid"),Ie(re.structureQuery.atomProperty.macromolecular.residueKey,"atom.key.res"),Ie(re.structureQuery.atomProperty.macromolecular.chainKey,"atom.key.chain"),Ie(re.structureQuery.atomProperty.macromolecular.entityKey,"atom.key.entity"),Ie(re.structureQuery.atomProperty.macromolecular.isHet,"atom.is-het"),Ie(re.structureQuery.atomProperty.macromolecular.id,"atom.id"),Ie(re.structureQuery.atomProperty.macromolecular.label_atom_id,"atom.label_atom_id"),Ie(re.structureQuery.atomProperty.macromolecular.label_alt_id,"atom.label_alt_id","atom.altloc"),Ie(re.structureQuery.atomProperty.macromolecular.label_comp_id,"atom.label_comp_id"),Ie(re.structureQuery.atomProperty.macromolecular.label_asym_id,"atom.label_asym_id"),Ie(re.structureQuery.atomProperty.macromolecular.label_entity_id,"atom.label_entity_id"),Ie(re.structureQuery.atomProperty.macromolecular.label_seq_id,"atom.label_seq_id"),Ie(re.structureQuery.atomProperty.macromolecular.auth_atom_id,"atom.auth_atom_id","atom.name"),Ie(re.structureQuery.atomProperty.macromolecular.auth_comp_id,"atom.auth_comp_id","atom.resname"),Ie(re.structureQuery.atomProperty.macromolecular.auth_asym_id,"atom.auth_asym_id","atom.chain"),Ie(re.structureQuery.atomProperty.macromolecular.auth_seq_id,"atom.auth_seq_id","atom.resno"),Ie(re.structureQuery.atomProperty.macromolecular.pdbx_PDB_ins_code,"atom.pdbx_PDB_ins_code","atom.inscode"),Ie(re.structureQuery.atomProperty.macromolecular.pdbx_formal_charge,"atom.pdbx_formal_charge"),Ie(re.structureQuery.atomProperty.macromolecular.occupancy,"atom.occupancy"),Ie(re.structureQuery.atomProperty.macromolecular.B_iso_or_equiv,"atom.B_iso_or_equiv","atom.bfactor"),Ie(re.structureQuery.atomProperty.macromolecular.entityType,"atom.entity-type"),Ie(re.structureQuery.atomProperty.macromolecular.entitySubtype,"atom.entity-subtype"),Ie(re.structureQuery.atomProperty.macromolecular.entityPrdId,"atom.entity-prd-id"),Ie(re.structureQuery.atomProperty.macromolecular.entityDescription,"atom.entity-description"),Ie(re.structureQuery.atomProperty.macromolecular.objectPrimitive,"atom.object-primitive"),Ie(re.structureQuery.atomProperty.macromolecular.chemCompType,"atom.chem-comp-type"),Ie(re.structureQuery.atomProperty.macromolecular.secondaryStructureKey,"atom.key.sec-struct"),Ie(re.structureQuery.atomProperty.macromolecular.isModified,"atom.is-modified"),Ie(re.structureQuery.atomProperty.macromolecular.modifiedParentName,"atom.modified-parent")],["Bond Properties",Ie(re.structureQuery.bondProperty.order,"bond.order"),Ie(re.structureQuery.bondProperty.length,"bond.length"),Ie(re.structureQuery.bondProperty.key,"bond.key"),Ie(re.structureQuery.bondProperty.atomA,"bond.atom-a"),Ie(re.structureQuery.bondProperty.atomB,"bond.atom-b"),s2(Nx("bond.is",Fx.List(C0.BondFlag),cd.Bool,`Test if the current bond has at least one (or all if partial = false) of the specified flags: ${cd.oneOfValues(C0.BondFlag).join(", ")}`),t=>q.core.flags.hasAny([q.struct.bondProperty.flags(),q.struct.type.bondFlags(SH(t))]))]]],CH=[];function TH(t){for(let e of t)nme(e)?CH.push(e):e instanceof Array&&TH(e)}TH(ome);var l2=function(){let t=[],e=Object.create(null),r=Qc.create(),n=Qc.create();for(let o of CH){for(let a of o.aliases){if(t.push([a,o]),e[a])throw new Error(`Alias '${a}' already in use.`);e[a]=o}let i=o.symbol.args;if(i.kind!=="dictionary"){i.type.kind==="oneof"&&cd.oneOfValues(i.type).forEach(a=>Qc.add(n,a,a));continue}for(let a of Object.keys(i.map)){isNaN(a)&&Qc.add(r,a,a);let s=i.map[a];s.type.kind==="oneof"&&cd.oneOfValues(s.type).forEach(l=>Qc.add(n,l,l))}}return{symbolList:t,symbolMap:e,namedArgs:r.array,constants:n.array}}();var Hqe=l2.constants,qqe=l2.namedArgs,R0=l2.symbolMap,Wqe=l2.symbolList;function e1(t){if(Ja.isLiteral(t))return t;if(Ja.isSymbol(t)){if(!R0[t.name])return t;let a=R0[t.name];if(a.kind==="alias")return Ja.Symbol(R0[t.name].symbol.id);throw a.translate([])}let e=Ja.isSymbol(t.head)&&!!R0[t.head.name]&&R0[t.head.name].kind==="macro",r=e?t.head:e1(t.head),n=r!==t.head;if(!t.args)return e?e1(t.head):n?Ja.Apply(r):t;let o=!1,i;if(Ja.isArgumentsArray(t.args)){i=[];for(let a=0,s=t.args.length;a<s;a++){let l=t.args[a],c=e1(l);l!==c&&(o=!0),i[i.length]=c}if(o||(i=t.args),!e&&!n&&!o)return t}else{i={};for(let a of Object.keys(t.args)){let s=t.args[a],l=e1(s);s!==l&&(o=!0),i[a]=l}if(!e&&!n&&!o)return t;o||(i=t.args)}if(e){let a=R0[t.head.name];return a.kind!=="macro"?Ja.Apply(r,i):a.translate(i)}return Ja.Apply(r,i)}function wH(t){return e1(t)}var fe=class t{constructor(e){this._=e}parse(e){let r=this.skip(t.eof)._(e,0);return r.status?{success:!0,value:r.value}:{success:!1,index:_H(e,r.furthest),expected:r.expected}}tryParse(e){let r=this.parse(e);if(r.success)return r.value;{let n=sme(e,r);throw new Error(n)}}or(e){return t.alt(this,e)}trim(e){return this.wrap(e,e)}wrap(e,r){return hk(1,typeof e=="string"?t.string(e):e,this,typeof r=="string"?t.string(r):r)}thru(e){return e(this)}then(e){return hk(1,this,e)}many(){return new t((e,r)=>{let n=[],o;for(;;)if(o=ru(this._(e,r),o),o.status){if(r===o.index)throw new Error("infinite loop detected in .many() parser --- calling .many() on a parser which can accept zero characters is usually the cause");r=o.index,n.push(o.value)}else return ru(Cs(r,n),o)})}times(e,r){let n=typeof r>"u"?e:r;return new t((o,i)=>{let a=[],s,l,c;for(c=0;c<e;c++)if(s=this._(o,i),l=ru(s,l),s.status)i=s.index,a.push(s.value);else return l;for(;c<n&&(s=this._(o,i),l=ru(s,l),s.status);c+=1)i=s.index,a.push(s.value);return ru(Cs(i,a),l)})}result(e){return this.map(()=>e)}atMost(e){return this.times(0,e)}atLeast(e){return t.seq(this.times(e),this.many()).map(r=>[...r[0],...r[1]])}map(e){return new t((r,n)=>{let o=this._(r,n);return o.status?ru(Cs(o.index,e(o.value)),o):o})}skip(e){return hk(0,this,e)}mark(){return t.seq(t.index,this,t.index).map(e=>({start:e[0],value:e[1],end:e[2]}))}node(e){return t.seq(t.index,this,t.index).map(r=>({name:e,start:r[0],value:r[1],end:r[2]}))}sepBy(e){return t.sepBy(this,e)}sepBy1(e){return t.sepBy1(this,e)}lookahead(e){return this.skip(t.lookahead(e))}notFollowedBy(e){return this.skip(t.notFollowedBy(e))}desc(e){return new t((r,n)=>{let o=this._(r,n);return o.status||(o.expected=[e]),o})}fallback(e){return this.or(t.succeed(e))}ap(e){return t.seq(e,this).map(([r,n])=>r(n))}chain(e){return new t((r,n)=>{let o=this._(r,n);if(!o.status)return o;let i=e(o.value);return ru(i._(r,o.index),o)})}};(function(t){function e(P,A,I){let k=[].slice.call(arguments);if(k.length===0)throw new Error("seqMap needs at least one argument");let M=k.pop();return ume(M),n.apply(null,k).map(function(R){return M.apply(null,R)})}t.seqMap=e;function r(P){let A={};for(let I of Object.keys(P))(function(k){A[k]=T(()=>P[k](A))})(I);return A}t.createLanguage=r;function n(...P){let A=P.length;return new t((I,k)=>{let M,R=new Array(A),B=k;for(let F=0;F<A;F++){if(M=ru(P[F]._(I,B),M),!M.status)return M;R[F]=M.value,B=M.index}return ru(Cs(B,R),M)})}t.seq=n;function o(...P){return P.length===0?m("zero alternates"):new t((I,k)=>{let M;for(let R=0;R<P.length;R++)if(M=ru(P[R]._(I,k),M),M.status)return M;return M})}t.alt=o;function i(P,A){return a(P,A).or(d([]))}t.sepBy=i;function a(P,A){let I=A.then(P).many();return n(P,I).map(k=>[k[0],...k[1]])}t.sepBy1=a;function s(P){let A=`'${P}'`;if(P.length===1){let I=P.charCodeAt(0);return new t((k,M)=>k.charCodeAt(M)===I?Cs(M+1,P):mp(M,A))}return new t((I,k)=>{let M=k+P.length;return I.slice(k,M)===P?Cs(M,P):mp(k,A)})}t.string=s;function l(P){let A=""+P;return A.slice(A.lastIndexOf("/")+1)}function c(P){return RegExp("^(?:"+P.source+")",l(P))}function u(P,A=0){let I=c(P),k=""+P;return new t((M,R)=>{let B=I.exec(M.slice(R));if(B){if(0<=A&&A<=B.length){let G=B[0],V=B[A];return Cs(R+G.length,V)}let F=`invalid match group (0 to ${B.length}) in ${k}`;return mp(R,F)}return mp(R,k)})}t.regexp=u;function d(P){return new t((A,I)=>Cs(I,P))}t.succeed=d;function m(P){return new t((A,I)=>mp(I,P))}t.fail=m;function p(P){if(cme(P))return new t((A,I)=>{let k=P._(A,I);return k.status&&(k.index=I,k.value=null),k});if(typeof P=="string")return p(s(P));if(P instanceof RegExp)return p(u(P));throw new Error("not a string, regexp, or parser: "+P)}t.lookahead=p;function h(P){return new t((A,I)=>{let k=P._(A,I);return k.status?mp(I,'not "'+A.slice(I,k.index)+'"'):Cs(I,null)})}t.notFollowedBy=h;function f(P){return new t((A,I)=>{let k=A.charAt(I);return I<A.length&&P(k)?Cs(I+1,k):mp(I,"a character "+P)})}t.test=f;function b(P){return f(A=>P.indexOf(A)>=0)}t.oneOf=b;function v(P){return f(A=>P.indexOf(A)<0)}t.noneOf=v;function x(P,A){return f(I=>P<=I&&I<=A).desc(P+"-"+A)}t.range=x;function S(P){return new t((A,I)=>{let k=I;for(;k<A.length&&P(A.charAt(k));)k++;return Cs(k,A.slice(I,k))})}t.takeWhile=S;function T(P){let A=new t((I,k)=>{let M=P()._;return A._=M,M(I,k)});return A}t.lazy=T;function E(){return m("empty")}t.empty=E,t.index=new t(function(P,A){return Cs(A,_H(P,A))}),t.anyChar=new t((P,A)=>A>=P.length?mp(A,"any character"):Cs(A+1,P.charAt(A))),t.all=new t(function(P,A){return Cs(P.length,P.slice(A))}),t.eof=new t(function(P,A){return A<P.length?mp(A,"EOF"):Cs(A,null)}),t.digit=u(/[0-9]/).desc("a digit"),t.digits=u(/[0-9]*/).desc("optional digits"),t.letter=u(/[a-z]/i).desc("a letter"),t.letters=u(/[a-z]*/i).desc("optional letters"),t.optWhitespace=u(/\s*/).desc("optional whitespace"),t.whitespace=u(/\s+/).desc("whitespace"),t.cr=s("\r"),t.lf=s(`
`),t.crlf=s(`\r
`),t.newline=o(t.crlf,t.lf,t.cr).desc("newline"),t.end=o(t.newline,t.eof);function _(P){return d(P)}t.of=_;function D(P){return u(P)}t.regex=D})(fe||(fe={}));function hk(t,...e){let r=e.length;return new fe((n,o)=>{let i,a,s=o;for(let l=0;l<r;l++){if(i=ru(e[l]._(n,s),i),!i.status)return i;t===l&&(a=i.value),s=i.index}return ru(Cs(s,a),i)})}function Cs(t,e){return{status:!0,index:t,value:e}}function mp(t,e){return{status:!1,furthest:t,expected:[e]}}function ru(t,e){if(!e||t.status||e.status||t.furthest>e.furthest)return t;let r=t.furthest===e.furthest?lme(t.expected,e.expected):e.expected;return{status:t.status,furthest:e.furthest,expected:r}}function _H(t,e){let r=t.slice(0,e).split(`
`),n=r.length,o=r[r.length-1].length+1;return{offset:e,line:n,column:o}}function ime(t){return t.length===1?t[0]:"one of "+t.join(", ")}function ame(t,e){let r=e.index,n=r.offset;if(n===t.length)return", got the end of the input";let o=n>0?"'...":"'",i=t.length-n>12?"...'":"'";return` at line ${r.line} column ${r.column}, got ${o}${t.slice(n,n+12)}${i}`}function sme(t,e){return`expected ${ime(e.expected)}${ame(t,e)}`}function lme(t,e){let r=t.length,n=e.length;if(r===0)return e;if(n===0)return t;let o=new Set,i=[];for(let a=0;a<r;a++)o.has(t[a])||(i[i.length]=t[a],o.add(t[a]));for(let a=0;a<n;a++)o.has(e[a])||(i[i.length]=e[a],o.add(e[a]));return i.sort(),i}function cme(t){return t instanceof fe}function ume(t){if(typeof t!="function")throw new Error("not a function: "+t)}function PH(t){return gk.parse(t)}var gk;(function(t){let e;(function(T){function E(A){return{kind:"string",value:A}}T.str=E;function _(A){return{kind:"symbol",value:A}}T.symb=_;function D(A,I){return{kind:"list",bracket:A,nodes:I}}T.list=D;function P(A){return{kind:"comment",value:A}}T.comment=P})(e||(e={}));let r=fe.regexp(/[\n\r\s]*/),n=fe.lazy(()=>fe.alt(o,d,i,a).trim(r)),o=fe.takeWhile(T=>T!=="`").trim("`").map(e.str),i=fe.regexp(/[^()\[\]{};`,\n\r\s]+/).map(e.symb),a=fe.regexp(/\s*;+([^\n\r]*)\n/,1).map(e.comment),s=n.many(),l=s.wrap("(",")").map(T=>e.list("(",T)),c=s.wrap("[","]").map(T=>e.list("[",T)),u=s.wrap("{","}").map(T=>e.list("{",T)),d=fe.alt(l,c,u),m=n.many();function p(T){return m.tryParse(T)}function h(T){switch(T.kind){case"string":return T.value;case"symbol":{let E=T.value;if(E.length>1)switch(E.charAt(0)){case".":return q.atomName(E.substr(1));case"_":return q.struct.type.elementSymbol([E.substr(1)])}return E==="true"?!0:E==="false"?!1:x(E)?+E:Ja.Symbol(E)}case"list":switch(T.bracket){case"[":return q.core.type.list(v(T.nodes).map(h));case"{":return q.core.type.set(v(T.nodes).map(h));case"(":{if(T.nodes[0].kind==="comment")throw new Error("Invalid expression");let E=h(T.nodes[0]);return Ja.Apply(E,f(T.nodes))}default:ur(T.bracket)}default:ur(T)}}function f(T){if(T.length<=1)return;if(!b(T)){let P=[];for(let A=1,I=T.length;A<I;A++){let k=T[A];k.kind!=="comment"&&(P[P.length]=h(k))}return P}let E={},_=!0,D=0;for(let P=1,A=T.length;P<A;P++){let I=T[P];if(I.kind!=="comment")if(I.kind==="symbol"&&I.value.length>1&&I.value.charAt(0)===":"){let k=I.value.substr(1);for(++P;P<A&&T[P].kind==="comment";)P++;if(P>=A)throw new Error(`There must be a value foolowed a named arg ':${k}'.`);if(T[P].kind==="comment")throw new Error("Invalid expression");E[k]=h(T[P]),isNaN(+k)&&(_=!1)}else E[D++]=h(I)}if(_){let P=Object.keys(E).map(I=>+I).sort((I,k)=>I-k),A=!0;for(let I=0,k=P.length;I<k;I++)if(P[I]!==I){A=!1;break}if(A){let I=[];for(let k=0,M=P.length;k<M;k++)I[k]=E[k];return I}}return E}function b(T){for(let E=1,_=T.length;E<_;E++){let D=T[E];if(D.kind==="symbol"&&D.value.length>1&&D.value.charAt(0)===":")return!0}return!1}function v(T){let E=!1;for(let _=0,D=T.length;_<D;_++)if(T[_].kind==="comment"){E=!0;break}return E?T.filter(_=>_.kind!=="comment"):T}function x(T){return/-?(0|[1-9][0-9]*)([.][0-9]+)?([eE][+-]?[0-9]+)?/.test(T)&&!isNaN(+T)}function S(T){let E=p(T),_=[];for(let D of E)D.kind!=="comment"&&(_[_.length]=h(D));return _}t.parse=S})(gk||(gk={}));var Cn=q;function ra(t,e,r){let n=fe.lazy(()=>fe.seq(t,n).map(o=>r(...o)).or(e));return n}function t1(t,e,r){return fe.seqMap(e,t.many(),(n,o)=>o.reduce((i,a)=>r(a,i),n))}function Vi(t,e,r){return fe.seqMap(e,fe.seq(t,e).many(),(n,o)=>o.reduce((i,a)=>{let[s,l]=a;return r(s,i,l)},n))}function Cf(t,e){return t.reduce((n,o)=>{let i=o.isUnsupported?pp(`operator '${o.name}' not supported`):o.map;return o.type(o.rule,n,i)},e)}function nu(t,e=0){return fe.optWhitespace.then(fe.regexp(t,e).skip(fe.optWhitespace))}function nl(t,e=0){return fe.regexp(t,e).skip(fe.optWhitespace)}function r1(t,e=0){return fe.optWhitespace.then(fe.regexp(t,e))}function c2(t,e){let r=e?`${t}|${Jm(e)}`:t,n=RegExp(`(${r})\\s+([-+]?[0-9]*\\.?[0-9]+)\\s+OF`,"i");return nu(n,2).map(parseFloat)}function pp(t){return function(){throw new Error(t)}}function n1(t){return t.length===1?t[0]:t.length>1?Cn.core.logic.and(t):void 0}function IH(t){return t.length===1?t[0]:t.length>1?Cn.core.logic.or(t):void 0}function yk(t,e){if(e&&e.op!==void 0&&e.val!==void 0){let r=[t,e.val];switch(e.op){case"=":return Cn.core.rel.eq(r);case"!=":return Cn.core.rel.neq(r);case">":return Cn.core.rel.gr(r);case"<":return Cn.core.rel.lt(r);case">=":return Cn.core.rel.gre(r);case"<=":return Cn.core.rel.lte(r);default:throw new Error(`operator '${e.op}' not supported`)}}else return e&&e.flags!==void 0?Cn.core.flags.hasAny([t,e.flags]):e&&e.min!==void 0&&e.max!==void 0?Cn.core.rel.inRange([t,e.min,e.max]):Array.isArray(e)?e.length>1?Cn.core.set.has([Cn.core.type.set(e),t]):Cn.core.rel.eq([t,e[0]]):Cn.core.rel.eq([t,e])}function Ia(t){return Cn.struct.generator.queryInSelection({0:t,query:Cn.struct.generator.all(),"in-complement":!0})}function Dl(t,e){return t.length<e.length?1:-1}function vk(t,e){let r=(e?[t].concat(e):[t]).sort(Dl).map(Jm).join("|");return RegExp(`${r}`,"i")}function DH(t){let e={};return Object.keys(t).sort(Dl).forEach(r=>{let n=t[r],o=pp(`property '${r}' not supported`),i=fe.regexp(n.regex).map(a=>(n.isUnsupported&&o(),yk(n.property,n.map(a))));n.isNumeric||(e[r]=i)}),e}function u2(t){let e=[];return Object.keys(t).sort(Dl).forEach(r=>{let n=t[r],o=pp(`property '${r}' not supported`),i=fe.regexp(n.regex).map(l=>(n.isUnsupported&&o(),yk(n.property,n.map(l)))),a=fe.regexp(vk(r,n.abbr)).trim(fe.optWhitespace),s=l=>Cn.struct.generator.atomGroups({[n.level]:l});n.isNumeric?e.push(a.then(fe.seq(fe.regexp(/>=|<=|=|!=|>|</).trim(fe.optWhitespace),fe.regexp(n.regex).map(n.map))).map(l=>(n.isUnsupported&&o(),yk(n.property,{op:l[0],val:l[1]}))).map(s)):e.push(a.then(i).map(s))}),e}function L0(t){let e=[];return Object.keys(t).sort(Dl).forEach(r=>{let n=t[r],o=n.map?n.map:pp(`keyword '${r}' not supported`),i=fe.regexp(vk(r,n.abbr)).map(o);e.push(i)}),e}function AH(t,e){let r=[],n=fe.regexp(/\(\s*/),o=fe.regexp(/\s*\)/);return Object.keys(t).sort(Dl).forEach(i=>{let a=t[i],s=a.map?a.map:pp(`function '${i}' not supported`),l=fe.regexp(new RegExp(i,"i")).skip(n).then(e).skip(o).map(s);r.push(l)}),r}function o1(t,e){let r=[];return Object.keys(t).sort(Dl).forEach(n=>{let o=t[n],i=pp(`property '${n}' not supported`),a=fe.regexp(vk(n,o.abbr)).lookahead(e).map(()=>(o.isUnsupported&&i(),o.property));r.push(a)}),r}function B0(t,e,r,n){let o=[];for(let i in t)o.push(i),t[i].abbr&&o.push(...t[i].abbr);for(let i in e)o.push(i),e[i].abbr&&o.push(...e[i].abbr);return r.forEach(i=>{o.push(i.name),i.abbr&&o.push(...i.abbr)}),o}function uc(t){return Cn.core.type.set(t.map(Cn.atomName))}function dc(t){return Cn.struct.generator.queryInSelection({0:t,query:Cn.struct.generator.all()})}function Mg(t,e,r){switch(t.head.name){case"structure-query.atom-property.macromolecular.label_atom_id":return Cn.atomName(e);case"structure-query.atom-property.core.element-symbol":return Cn.es(e);case"structure-query.atom-property.macromolecular.secondary-structure-flags":return r&&(e=[r[e.toUpperCase()]||"none"]),Cn.struct.type.secondaryStructureFlags([e]);default:return e}}var EH="structure-query.atom-property.macromolecular.",dme=["entityKey","label_entity_id","entityType"],mme=["chainKey","label_asym_id","label_entity_id","auth_asym_id","entityType"],pme=["residueKey","label_comp_id","label_seq_id","auth_comp_id","auth_seq_id","pdbx_formal_charge","secondaryStructureKey","secondaryStructureFlags","isModified","modifiedParentName"];function kH(t){if(t.head.name.startsWith(EH)){let e=t.head.name.substr(EH.length);if(dme.includes(e))return"entity-test";if(mme.includes(e))return"chain-test";if(pme.includes(e))return"residue-test"}return"atom-test"}var fme=["structure-query.atom-property.macromolecular.secondary-structure-flags"];function MH(t,e){if(fme.includes(t.head.name)){let r=e[0].head,n=[];return e.forEach(o=>n.push(...o.args[0])),Cn.core.flags.hasAny([t,{head:r,args:n}])}else{if(e.length===1)return Cn.core.rel.eq([t,e[0]]);if(e.length>1)return Cn.core.set.has([Cn.core.type.set(e),t])}}function Cr(t){return Cn.struct.generator.atomGroups({"residue-test":Cn.core.set.has([Cn.core.type.set(t),Cn.ammp("label_comp_id")])})}var $o=q,ou=/[-+]?[0-9]*\.?[0-9]+/,i1=/[0-9]+/;function At(t){return t}var hme={none:"none",turn:"turn",sheet:"beta",helix:"helix",dna:"dna",rna:"rna",carbohydrate:"carbohydrate",helix310:"3-10",helixalpha:"alpha",helixpi:"pi",0:"none",1:"turn",2:"beta",3:"helix",4:"dna",5:"rna",6:"carbohydrate",7:"3-10",8:"alpha",9:"pi"};function bk(t){if(t.head){if(t.head.name&&t.head.name==="core.type.regex"&&(t=t.args[0].replace(/^\^|\$$/g,"")),t=hme[t.toString().toLowerCase()]||"none",["dna","rna","carbohydrate"].indexOf(t)!==-1)throw new Error("values 'dna', 'rna', 'carbohydrate' not yet supported for 'structure' property");return $o.struct.type.secondaryStructureFlags([t])}}var xk={adpmax:{"@desc":"the maximum anisotropic displacement parameter for the selected atom","@examples":[""],isUnsupported:!0,regex:ou,map:t=>parseFloat(t),level:"atom-test"},adpmin:{"@desc":"the minimum anisotropic displacement parameter for the selected atom","@examples":[""],isUnsupported:!0,regex:ou,map:t=>parseFloat(t),level:"atom-test"},altloc:{"@desc":"PDB alternate location identifier","@examples":["altloc = A"],regex:/[a-zA-Z0-9]/,map:At,level:"atom-test",property:$o.ammp("label_alt_id")},altname:{"@desc":"an alternative name given to atoms by some file readers (for example, P2N)","@examples":[""],isUnsupported:!0,regex:/[a-zA-Z0-9]/,map:At,level:"atom-test"},atomID:{"@desc":"special atom IDs for PDB atoms assigned by Jmol","@examples":[""],isUnsupported:!0,regex:i1,map:t=>parseInt(t),level:"atom-test"},atomIndex:{"@desc":"atom 0-based index; a unique number for each atom regardless of the number of models loaded","@examples":[""],isUnsupported:!0,regex:i1,map:t=>parseInt(t),level:"atom-test"},atomName:{"@desc":"atom name","@examples":["atomName = CA"],regex:/[a-zA-Z0-9]+/,map:t=>$o.atomName(t),level:"atom-test",property:$o.ammp("label_atom_id")},atomno:{"@desc":'sequential number; you can use "@" instead of "atomno=" -- for example, select @33 or Var x = @33 or @35',"@examples":[""],isUnsupported:!0,regex:i1,map:t=>parseInt(t),level:"atom-test"},atomType:{"@desc":"atom type (mol2, AMBER files) or atom name (other file types)","@examples":["atomType = OH"],regex:/[a-zA-Z0-9]+/,map:t=>$o.atomName(t),level:"atom-test",property:$o.ammp("label_atom_id")},atomX:{"@desc":"Cartesian X coordinate (or just X)","@examples":["x = 4.2"],abbr:["X"],isNumeric:!0,regex:ou,map:t=>parseFloat(t),level:"atom-test",property:$o.acp("x")},atomY:{"@desc":"Cartesian Y coordinate (or just Y)","@examples":["y < 42"],abbr:["Y"],isNumeric:!0,regex:ou,map:t=>parseFloat(t),level:"atom-test",property:$o.acp("y")},atomZ:{"@desc":"Cartesian Z coordinate (or just Z)","@examples":["Z > 10"],abbr:["Z"],isNumeric:!0,regex:ou,map:t=>parseFloat(t),level:"atom-test",property:$o.acp("z")},bondcount:{"@desc":"covalent bond count","@examples":["bondcount = 0"],isNumeric:!0,regex:i1,map:t=>parseInt(t),level:"atom-test",property:$o.acp("bondCount")},bondingRadius:{"@desc":"radius used for auto bonding; synonymous with ionic and ionicRadius","@examples":[""],abbr:["ionic","ionicRadius"],isUnsupported:!0,regex:ou,map:t=>parseFloat(t),level:"atom-test"},cell:{"@desc":'crystallographic unit cell, expressed either in lattice integer notation (111-999) or as a coordinate in ijk space, where {1 1 1} is the same as 555. ANDing two cells, for example select cell=555 and cell=556, selects the atoms on the common face. (Note: in the specifc case of CELL, only "=" is allowed as a comparator.)',"@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},configuration:{"@desc":'Only in the context {configuration=n}, this option selects the set of atoms with either no ALTLOC specified or those atoms having this index into the array of altlocs within its model. So, for example, if the model has altloc "A" and "B", select configuration=1 is equivalent to select altloc="" or altloc="A", and print {configuration=2} is equivalent to print {altloc="" or altloc="B"}. Configuration 0 is "all atoms in a model having configurations", and an invalid configuration number gives no atoms. (Note: in the specifc case of CONFIGURATION, only "=" is allowed as a comparator.)',"@examples":[""],isUnsupported:!0,regex:i1,map:t=>parseInt(t),level:"atom-test"},chain:{"@desc":'protein chain. For newer CIF files allowing multicharacter chain specifications, use quotations marks: select chain="AA". For these multicharacter desigations, case is not checked unless the CIF file has lower-case chain designations.',"@examples":["chain = A",'chain = "AA"'],regex:/[a-zA-Z0-9]+/,map:At,level:"chain-test",property:$o.ammp("auth_asym_id")},chainNo:{"@desc":'chain number; sequentially counted from 1 for each model; chainNo == 0 means"no chain" or PDB chain identifier indicated as a blank (Jmol 14.0).',"@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},color:{"@desc":"the atom color","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},covalentRadius:{"@desc":"covalent bonding radius, synonymous with covalent. Not used by Jmol, but could be used, for example, in {*}.spacefill={*}.covalentRadius.all.","@examples":[""],abbr:["covalent"],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},cs:{"@desc":"chemical shift calculated using computational results that include magnetic shielding tensors.","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},element:{"@desc":'element symbol. The value of this parameter depends upon the context. Used with select structure=x, x can be either the quoted element symbol, "H", "He", "Li", etc. or atomic number. In all other contexts, the value is the element symbol. When the atom is a specific isotope, the string will contain the isotope number -- "13C", for example.',"@examples":["element=Fe"],regex:/[a-zA-Z]+/,map:t=>$o.es(t),level:"atom-test",property:$o.acp("elementSymbol")},elemno:{"@desc":"atomic element number","@examples":["elemno=8"],regex:/[0-9\s{}-]+/,map:t=>parseInt(t),level:"atom-test",property:$o.acp("atomicNumber")},eta:{"@desc":`Based on Carlos M. Duarte, Leven M. Wadley, and Anna Marie Pyle, RNA structure comparison, motif search and discovery using a reduced representation of RNA conformational space, Nucleic Acids Research, 2003, Vol. 31, No. 16 4755-4761. The parameter eta is the C4'[i-1]-P[i]-C4'[i]-P[i+1] dihedral angle; theta is the P[i]-C4'[i]-P[i+1]-C4'[i+1] dihedral angle. Both are measured on a 0-360 degree scale because they are commonly near 180 degrees. Using the commands plot PROPERTIES eta theta resno; select visible;wireframe only one can create these authors' "RNA worm" graph.`,"@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},theta:{"@desc":`Based on Carlos M. Duarte, Leven M. Wadley, and Anna Marie Pyle, RNA structure comparison, motif search and discovery using a reduced representation of RNA conformational space, Nucleic Acids Research, 2003, Vol. 31, No. 16 4755-4761. The parameter eta is the C4'[i-1]-P[i]-C4'[i]-P[i+1] dihedral angle; theta is the P[i]-C4'[i]-P[i+1]-C4'[i+1] dihedral angle. Both are measured on a 0-360 degree scale because they are commonly near 180 degrees. Using the commands plot PROPERTIES eta theta resno; select visible;wireframe only one can create these authors' "RNA worm" graph.`,"@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},file:{"@desc":"file number containing this atom","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},formalCharge:{"@desc":"formal charge","@examples":["formalCharge=1"],regex:ou,map:t=>parseFloat(t),level:"atom-test",property:$o.ammp("pdbx_formal_charge")},format:{"@desc":"format (label) of the atom.","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},fXyz:{"@desc":"fractional XYZ coordinates","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},fX:{"@desc":"fractional X coordinate","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},fY:{"@desc":"fractional Y coordinate","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},fZ:{"@desc":"fractional Z coordinate","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},fuxyz:{"@desc":"fractional XYZ coordinates in the unitcell coordinate system","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},fux:{"@desc":"fractional X coordinate in the unitcell coordinate system","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},fuy:{"@desc":"fractional Y coordinate in the unitcell coordinate system","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},fuz:{"@desc":"fractional Z coordinate in the unit cell coordinate system","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},group:{"@desc":"3-letter residue code","@examples":["group = ALA"],regex:/[a-zA-Z0-9]{1,3}/,map:At,level:"residue-test",property:$o.ammp("label_comp_id")},group1:{"@desc":"single-letter residue code (amino acids only)","@examples":["group1 = G"],regex:/[a-zA-Z]/,map:At,level:"residue-test",property:$o.ammp("label_comp_id")},groupID:{"@desc":"group ID number: A unique ID for each amino acid or nucleic acid residue in a PDB file. 0  noGroup 1-5  ALA, ARG, ASN, ASP, CYS 6-10  GLN, GLU, GLY, HIS, ILE 11-15  LEU, LYS, MET, PHE, PRO 16-20  SER, THR, TRP, TYR, VAL 21-23  ASX, GLX, UNK 24-29  A, +A, G, +G, I, +I 30-35  C, +C, T, +T, U, +U Additional unique numbers are assigned arbitrarily by Jmol and cannot be used reproducibly.","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},groupindex:{"@desc":"overall group index","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},hydrophobicity:{"@desc":"Aminoacid residue scale of hydrophobicity based on Rose, G. D., Geselowitz, A. R., Lesser, G. J., Lee, R. H., and Zehfus, M. H. (1985). Hydrophobicity of amino acid residues in globular proteins, Science, 229(4716):834-838.","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},identify:{"@desc":"for a PDB/mmCIF file, a label such as [ILE]7^1:A.CD1%A/3 #47, which includes the group ([ILE]), residue number with optional insertion code (7^1), chain (:A), atom name (CD1), alternate location if present (%A), PDB model number (/3, for NMR models when one file is loaded; /file.model such as /2.3 if more than one file is loaded), and atom number (#47). For non-PDB data, the information is shorter -- for example, H15/2.1 #6, indicating atom name (H15), full file.model number (/2.1), and atom number (#6). If only a single model is loaded, %[identify] does not include the model number.","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},insertion:{"@desc":"protein residue insertion code","@examples":["insertion=A"],regex:/[a-zA-Z0-9]/,map:At,level:"atom-test",property:$o.ammp("pdbx_PDB_ins_code")},label:{"@desc":"current atom label (same as format)","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},mass:{"@desc":"atomic mass -- especially useful with appended .max or .sum","@examples":["mass > 13"],regex:ou,map:t=>parseFloat(t),level:"atom-test",property:$o.acp("mass")},model:{"@desc":"model number","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},modelindex:{"@desc":"a unique number for each model, starting with 0 and spanning all models in all files","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},modO:{"@desc":"currently calculated occupancy from modulation (0 to 100; NaN if atom has no occupancy modulation)","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},modXYZ:{"@desc":"currently calculated displacement modulation (for incommensurately modulated structures). Also modX, modY, modZ for individual components. For atoms without modultion, {xx}.modXYZ is -1 and {xx}.modX is NaN, and in a label %[modXYZ] and %[modX] are blank.","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},molecule:{"@desc":"molecule number","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},monomer:{"@desc":"monomer number (group number) in a polymer (usually a chain), starting with 1, or 0 if not part of a biopolymer -- that is, not a connected carbohydrate, amino acid, or nucleic acid (Jmol 14.3.15)","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},ms:{"@desc":"magnetic shielding calculated from file-loaded tensors.","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},occupancy:{"@desc":'CIF file site occupancy. In SELECT command comparisons ("select occupancy < 90"), an integer n implies measurement on a 0-100 scale; also, in the context %[occupancy] or %q for a label, the reported number is a percentage. In all other cases, such as when %Q is used in a label or when a decimal number is used in a comparison, the scale is 0.0 - 1.0.',"@examples":["occupancy < 1"],regex:ou,map:t=>parseFloat(t),level:"atom-test",property:$o.ammp("occupancy")},partialCharge:{"@desc":"partial charge","@examples":[""],isUnsupported:!0,regex:ou,map:t=>parseFloat(t),level:"atom-test"},phi:{"@desc":"protein group PHI angle for atom's residue","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},polymer:{"@desc":"sequential polymer number in a model, starting with 1.","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},polymerLength:{"@desc":"polymer length","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},property_xx:{"@desc":"a property created using the DATA command","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},psi:{"@desc":"protein group PSI angle for the atom's residue","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},radius:{"@desc":'currently displayed radius -- In SELECT command comparisons ("select radius=n"), integer n implies Rasmol units 1/250 Angstroms; in all other cases or when a decimal number is used, the units are Angstroms.',"@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},resno:{"@desc":"PDB residue number, not including insertion code (see also seqcode, below)","@examples":["resno = 100"],regex:/-?[0-9]+/,map:t=>parseInt(t),level:"residue-test",property:$o.ammp("auth_seq_id")},selected:{"@desc":"1.0 if atom is selected; 0.0 if not","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},sequence:{"@desc":'PDB one-character sequence code, as a string of characters, with "?" indicated where single-character codes are not available',"@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},seqcode:{"@desc":'PDB residue number, including insertion code (for example, 234^2; "seqcode" option added in Jmol 14.3.16)',"@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},seqid:{"@desc":"(mmCIF only) the value from _atom_site.label_seq_id; a pointer to _entity_poly_seq.num in the ENTITY_POLY_SEQ category specifying the sequence of monomers in a polymer. Allowance is made for the possibility of microheterogeneity in a sample by allowing a given sequence number to be correlated with more than one monomer id. (Jmol 14.2.3)","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},shape:{"@desc":'hybridization geometry such as "tetrahedral"',"@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},site:{"@desc":"crystallographic site number","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},spacefill:{"@desc":"currently displayed radius","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},straightness:{"@desc":'quaternion-derived straightness (second derivative of the quaternion describing the orientation of the residue. This quantity will have different values depending upon the setting of quaternionFrame as "A" (alpha-carbon/phosphorus atom only), "C" (alpha-carbon/pyrimidine or purine base based), "P" (carbonyl-carbon peptide plane/phosphorus tetrahedron based), or "N" (amide-nitrogen based). The default is alpha-carbon based, which corresponds closely to the following combination of Ramachandran angles involving three consecutive residues i-1, i, and i+1: -psii-1 - phii + psii + phii+1.',"@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},strucno:{"@desc":"a unique number for each helix, sheet, or turn in a model, starting with 1.","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},structure:{"@desc":'The value of this parameter depends upon the context. Used with select structure=x, x can be either the quoted keyword "none", "turn", "sheet", "helix", "dna", "rna", or "carbohydrate" or a respective number 0-6. In the context {*}.structure, the return value is a number; in the context label %[structure], the return is one of the six keywords.',"@examples":['structure="helix"',"structure=3"],regex:/none|turn|sheet|helix|dna|rna|carbohydrate|[0-6]/i,map:At,level:"residue-test",property:"structure"},substructure:{"@desc":'like structure, the value of this parameter depends upon the context. Used with select substructure=x, x can be either the quoted keyword "none", "turn", "sheet", "helix", "dna", "rna", "carbohydrate", "helix310", "helixalpha", or "helixpi", or the respective number 0-9. In the context {*}.substructure, the return value is a number; in the context label %[substructure], the return is one of the nine keywords.',"@examples":['substructure = "alphahelix"',"substructure =9"],regex:/none|turn|sheet|helix|dna|rna|carbohydrate|helix310|helixalpha|helixpi|[0-9]/i,map:At,level:"residue-test",property:"structure"},surfacedistance:{"@desc":"A value related to the distance of an atom to a nominal molecular surface. 0 indicates at the surface. Positive numbers are minimum distances in Angstroms from the given atom to the surface.","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},symop:{"@desc":'the first symmetry operation code that generated this atom by Jmol; an integer starting with 1. See also symmetry, below. This operator is only present if the file contains space group information and the file was loaded using the {i, j, k} option so as to generate symmetry-based atoms. To select only the original atoms prior to application of symmetry, you can either use "SYMOP=n", where n is the symmetry operator corresponding to "x,y,z", or you can specify instead simply "NOT symmetry" the way you might specify "NOT hydrogen". Note that atoms in special positions will have multiple operator matches. These atoms can be selected using the keyword SPECIALPOSITION. The special form select SYMOP=nijk selects a specific translation of atoms from the given crystallographic symmetry operation. Comparators <, <=, >, >=, and != can be used and only apply to the ijk part of the designation. The ijk are relative, not absolute. Thus, symop=2555 selects for atoms that have been transformed by symop=2 but not subjected to any further translation. select symop=1555 is identical to select not symmetry. All other ijk are relative to these selections for 555. If the model was loaded using load "filename.cif" {444 666 1}, where the 1 indicates that all symmetry-generated atoms are to be packed within cell 555 and then translated to fill the other 26 specified cells, then select symop=3555 is nearly the same as select symop=3 and cell=555. (The difference being that cell=555 selects for all atoms that are on any edge of the cell, while symop=3555 does not.) However, the situation is different if instead the model was loaded using load "filename.cif" {444 666 0}, where the 0 indicates that symmetry-generated atoms are to be placed exactly where their symmetry operator would put them (x,-y,z being different then from x, 1-y, z). In that case, select symop=3555 is for all atoms that have been generated using symmetry operation 3 but have not had any additional translations applied to the x,y,z expression found in the CIF file. If, for example, symmetry operation 3 is -x,-y,-z, then load "filename.cif" {444 666 0} will place an atom originally at {1/2, 1/2, 1/2} at positions {-1/2, -1/2, -1/2} (symop=3555) and {-3/2, -3/2, -3/2} (symop=3444) and 24 other sites.',"@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},symmetry:{"@desc":'as "symmetry" or in a label as lower-case "o" gives list of crystallographic symmetry operators generating this atom with lattice designations,such as 3555; upper-case "%O" in a label gives a list without the lattice designations. See also symop, above.',"@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},temperature:{"@desc":"yes  yes  temperature factor (B-factor)","@examples":["temperature >= 20"],regex:ou,map:t=>parseFloat(t),level:"atom-test",property:$o.ammp("B_iso_or_equiv")},unitXyz:{"@desc":"unit cell XYZ coordinates","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},uX:{"@desc":"unit cell X coordinate normalized to [0,1)","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},uY:{"@desc":"unit cell Y coordinate normalized to [0,1)","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},uZ:{"@desc":"unit cell Z coordinate normalized to [0,1)","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},valence:{"@desc":"the valence of an atom (sum of bonds, where double bond counts as 2 and triple bond counts as 3","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},vanderwaals:{"@desc":"van der Waals radius","@examples":["vanderwaals >2"],regex:ou,map:t=>parseFloat(t),level:"atom-test",property:$o.acp("vdw")},vectorScale:{"@desc":"vibration vector scale","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},volume:{"@desc":"approximate van der Waals volume for this atom. Note, {*}.volume gives an average; use {*}.volume.sum to get total volume.","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},vXyz:{"@desc":"vibration vector, or individual components as %vx %vy %vz. For atoms without vibration vectors, {xx}.vXyz is -1; in a label, %[vxyz] is blank.","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},vX:{"@desc":"vibration vector X coordinate; for atoms without vibration vector, {xx}.vX is NaN (same for vY and vZ)","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},vY:{"@desc":"vibration vector Y coordinate","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},vZ:{"@desc":"vibration vector Z coordinate","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"},xyz:{"@desc":"Cartesian XYZ coordinates; select xyz > 1.0 selects atoms more than one Angstrom from the origin.","@examples":[""],isUnsupported:!0,regex:/[0-9\s{}-]+/,map:At,level:"atom-test"}};var RH=q,Sk=[{"@desc":"Selects atoms that are not included in s1.","@examples":["not ARG"],name:"not",type:ra,rule:fe.alt(fe.regex(/NOT/i).skip(fe.whitespace),fe.string("!").skip(fe.optWhitespace)),map:(t,e)=>Ia(e)},{"@desc":"Selects atoms included in both s1 and s2.","@examples":["ASP and .CA"],name:"and",type:Vi,rule:nu(/AND|&/i),map:(t,e,r)=>RH.struct.modifier.intersectBy({0:e,by:r})},{"@desc":"Selects atoms included in either s1 or s2.","@examples":["ASP or GLU"],name:"or",type:Vi,rule:nu(/OR|\||,/i),map:(t,e,r)=>RH.struct.combinator.merge([e,r])}];var le=q,to={acidic:["ASP","GLU"],aliphatic:["ALA","GLY","ILE","LEU","VAL"],amino:["ALA","ARG","ASN","ASP","CYS","GLN","GLU","GLY","HIS","ILE","LEU","LYS","MET","PHE","PRO","SER","THR","TRP","TYR","VAL","ASX","GLX","UNK"],aromatic:["HIS","PHE","TRP","TYR"],basic:["ARG","HIS","LYS"],buried:["ALA","CYS","ILE","LEU","MET","PHE","TRP","VAL"],cg:["CYT","C","GUA","G"],cyclic:["HIS","PHE","PRO","TRP","TYR"],hydrophobic:["ALA","GLY","ILE","LEU","MET","PHE","PRO","TRP","TYR","VAL"],large:["ARG","GLU","GLN","HIS","ILE","LEU","LYS","MET","PHE","TRP","TYR"],medium:["ASN","ASP","CYS","PRO","THR","VAL"],small:["ALA","GLY","SER"],nucleic:["G","C","A","T","U","I","DG","DC","DA","DT","DU","DI","+G","+C","+A","+T","+U","+I"]},LH={nucleic:["P","O3'","O5'","C5'","C4'","C3'","OP1","OP2","O3*","O5*","C5*","C4*","C3*","C2'","C1'","O4'","O2'"],protein:["C","N","CA"]};function a1(){return le.struct.combinator.merge([le.struct.generator.atomGroups({"residue-test":le.core.set.has([le.set(...to.nucleic),le.ammp("label_comp_id")])}),le.struct.filter.pick({0:le.struct.generator.atomGroups({"group-by":le.ammp("residueKey")}),test:le.core.logic.and([le.core.rel.eq([le.struct.atomSet.atomCount(),1]),le.core.rel.eq([le.ammp("label_atom_id"),le.atomName("P")])])}),le.struct.filter.pick({0:le.struct.generator.atomGroups({"group-by":le.ammp("residueKey")}),test:le.core.logic.or([le.core.set.isSubset([uc(["C1'","C2'","O3'","C3'","C4'","C5'","O5'"]),le.ammpSet("label_atom_id")]),le.core.set.isSubset([uc(["C1*","C2*","O3*","C3*","C4*","C5*","O5*"]),le.ammpSet("label_atom_id")])])})])}function gme(){return le.struct.generator.atomGroups({"residue-test":le.core.set.has([le.set(...to.amino),le.ammp("label_comp_id")])})}function yme(){return le.struct.combinator.merge([le.struct.modifier.intersectBy({0:le.struct.generator.atomGroups({"residue-test":le.core.set.has([le.core.type.set(to.amino),le.ammp("label_comp_id")])}),by:le.struct.generator.atomGroups({"atom-test":le.core.set.has([le.core.type.set(LH.protein),le.ammp("label_atom_id")])})}),le.struct.modifier.intersectBy({0:le.struct.generator.atomGroups({"residue-test":le.core.set.has([le.core.type.set(to.nucleic),le.ammp("label_comp_id")])}),by:le.struct.generator.atomGroups({"atom-test":le.core.set.has([le.core.type.set(LH.nucleic),le.ammp("label_atom_id")])})})])}var Ck={all:{"@desc":"all atoms; same as *",abbr:["*"],map:()=>le.struct.generator.all()},bonded:{"@desc":"covalently bonded",map:()=>le.struct.generator.atomGroups({"atom-test":le.core.rel.gr([le.struct.atomProperty.core.bondCount({flags:le.struct.type.bondFlags(["covalent","metallic","sulfide"])}),0])})},clickable:{"@desc":"actually visible -- having some visible aspect such as wireframe, spacefill, or a label showing, or the alpha-carbon or phosphorus atom in a biomolecule that is rendered with only cartoon, rocket, or other biomolecule-specific shape."},connected:{"@desc":"bonded in any way, including hydrogen bonds",map:()=>le.struct.generator.atomGroups({"atom-test":le.core.rel.gr([le.struct.atomProperty.core.bondCount({flags:le.struct.type.bondFlags()}),0])})},displayed:{"@desc":"displayed using the display or hide command; not necessarily visible"},hidden:{"@desc":"hidden using the display or hide command"},none:{"@desc":"no atoms",map:()=>le.struct.generator.empty()},selected:{"@desc":"atoms that have been selected; defaults to all when a file is first loaded"},thisModel:{"@desc":'atoms in the current frame set, as defined by frame, model, or animation commands. If more than one model is in this set, "thisModel" refers to all of them, regardless of atom displayed/hidden status.'},visible:{"@desc":"visible in any way, including PDB residue atoms for which a cartoon or other such rendering makes their group visible, even if they themselves are not visible."},subset:{"@desc":"the currently defined subset. Note that if a subset is currently defined, then select/display all is the same as select/display subset, restrict none is the same as restrict not subset. In addition, select not subset selects nothing."},specialPosition:{"@desc":"atoms in crystal structures that are at special positions - that is, for which there is more than one operator that leads to them."},unitcell:{"@desc":"atoms within the current unitcell, which may be offset. This includes atoms on the faces and at the vertices of the unitcell."},polyhedra:{"@desc":"all central atoms for which polyhedra have been created. See also polyhera(n), below. (Jmol 14.4)"},nonmetal:{"@desc":"_H,_He,_B,_C,_N,_O,_F,_Ne,_Si,_P,_S,_Cl,_Ar,_As,_Se,_Br,_Kr,_Te,_I,_Xe,_At,_Rn",map:()=>le.struct.generator.atomGroups({"atom-test":le.core.set.has([le.set(...["H","He","B","C","N","O","F","Ne","Si","P","S","Cl","Ar","As","Se","Br","Kr","Te","I","Xe","At","Rn"].map(le.es)),le.acp("elementSymbol")])})},metal:{"@desc":"!nonmetal",map:()=>le.struct.generator.atomGroups({"atom-test":le.core.logic.not([le.core.set.has([le.set(...["H","He","B","C","N","O","F","Ne","Si","P","S","Cl","Ar","As","Se","Br","Kr","Te","I","Xe","At","Rn"].map(le.es)),le.acp("elementSymbol")])])})},alkaliMetal:{"@desc":"_Li,_Na,_K,_Rb,_Cs,_Fr",map:()=>le.struct.generator.atomGroups({"atom-test":le.core.set.has([le.set(...["Li","Na","K","Rb","Cs","Fr"].map(le.es)),le.acp("elementSymbol")])})},alkalineEarth:{"@desc":"_Be,_Mg,_Ca,_Sr,_Ba,_Ra",map:()=>le.struct.generator.atomGroups({"atom-test":le.core.set.has([le.set(...["Be","Mg","Ca","Sr","Ba","Ra"].map(le.es)),le.acp("elementSymbol")])})},nobleGas:{"@desc":"_He,_Ne,_Ar,_Kr,_Xe,_Rn",map:()=>le.struct.generator.atomGroups({"atom-test":le.core.set.has([le.set(...["He","Ne","Ar","Kr","Xe","Rn"].map(le.es)),le.acp("elementSymbol")])})},metalloid:{"@desc":"_B,_Si,_Ge,_As,_Sb,_Te",map:()=>le.struct.generator.atomGroups({"atom-test":le.core.set.has([le.set(...["B","Si","Ge","As","Sb","Te"].map(le.es)),le.acp("elementSymbol")])})},transitionMetal:{"@desc":"(includes La and Ac) elemno>=21 and elemno<=30, elemno=57, elemno=89, elemno>=39 and elemno<=48, elemno>=72 and elemno<=80, elemno>=104 and elemno<=112",map:()=>le.struct.generator.atomGroups({"atom-test":le.core.logic.or([le.core.rel.inRange([le.acp("atomicNumber"),21,30]),le.core.rel.inRange([le.acp("atomicNumber"),39,48]),le.core.rel.inRange([le.acp("atomicNumber"),72,80]),le.core.rel.inRange([le.acp("atomicNumber"),104,112]),le.core.set.has([le.set(57,89),le.acp("atomicNumber")])])})},lanthanide:{"@desc":"(does not include La) elemno>57 and elemno<=71",map:()=>le.struct.generator.atomGroups({"atom-test":le.core.rel.inRange([le.acp("atomicNumber"),57,71])})},actinide:{"@desc":"(does not include Ac) elemno>89 and elemno<=103",map:()=>le.struct.generator.atomGroups({"atom-test":le.core.rel.inRange([le.acp("atomicNumber"),89,103])})},isaromatic:{"@desc":"atoms connected with the AROMATIC, AROMATICSINGLE, or AROMATICDOUBLE bond types",map:()=>le.struct.generator.atomGroups({"atom-test":le.core.rel.gr([le.struct.atomProperty.core.bondCount({flags:le.struct.type.bondFlags(["aromatic"])}),0])})},carbohydrate:{"@desc":""},ions:{"@desc":'(specifically the PDB designations "PO4" and "SO4")'},ligand:{"@desc":'(originally "hetero and not solvent"; changed to "!(protein,nucleic,water,UREA)" for Jmol 12.2)'},nucleic:{"@desc":`any group that (a) has one of the following group names: G, C, A, T, U, I, DG, DC, DA, DT, DU, DI, +G, +C, +A, +T, +U, +I; or (b) can be identified as a group that is only one atom, with name "P"; or (c) has all of the following atoms (prime, ', can replace * here): C1*, C2*, C3*, O3*, C4*, C5*, and O5*.`,map:()=>a1()},purine:{"@desc":"any nucleic group that (a) has one of the following group names: A, G, I, DA, DG, DI, +A, +G, or +I; or (b) also has atoms N7, C8, and N9.",map:()=>le.struct.modifier.intersectBy({0:a1(),by:le.struct.combinator.merge([le.struct.generator.atomGroups({"residue-test":le.core.set.has([le.set("A","G","I","DA","DG","DI","+A","+G","+I"),le.ammp("label_comp_id")])}),le.struct.filter.pick({0:le.struct.generator.atomGroups({"group-by":le.ammp("residueKey")}),test:le.core.set.isSubset([uc(["N7","C8","N9"]),le.ammpSet("label_atom_id")])})])})},pyrimidine:{"@desc":"any nucleic group that (a) has one of the following group names: C, T, U, DC, DT, DU, +C, +T, +U; or (b) also has atom O2.",map:()=>le.struct.modifier.intersectBy({0:a1(),by:le.struct.combinator.merge([le.struct.generator.atomGroups({"residue-test":le.core.set.has([le.set("C","T","U","DC","DT","DU","+C","+T","+U"),le.ammp("label_comp_id")])}),le.struct.filter.pick({0:le.struct.generator.atomGroups({"group-by":le.ammp("residueKey")}),test:le.core.logic.or([le.core.set.has([le.ammpSet("label_atom_id"),le.atomName("O2*")]),le.core.set.has([le.ammpSet("label_atom_id"),le.atomName("O2'")])])})])})},dna:{"@desc":"any nucleic group that (a) has one of the following group names: DG, DC, DA, DT, DU, DI, T, +G, +C, +A, +T; or (b) has neither atom O2* or O2'.",map:()=>le.struct.modifier.intersectBy({0:a1(),by:le.struct.combinator.merge([le.struct.generator.atomGroups({"residue-test":le.core.set.has([le.set("DG","DC","DA","DT","DU","DI","T","+G","+C","+A","+T"),le.ammp("label_comp_id")])}),le.struct.filter.pick({0:le.struct.generator.atomGroups({"group-by":le.ammp("residueKey")}),test:le.core.logic.not([le.core.logic.or([le.core.set.has([le.ammpSet("label_atom_id"),le.atomName("O2*")]),le.core.set.has([le.ammpSet("label_atom_id"),le.atomName("O2'")])])])})])})},rna:{"@desc":"any nucleic group that (a) has one of the following group names: G, C, A, U, I, +U, +I; or (b) has atom O2* or O2'.",map:()=>le.struct.modifier.intersectBy({0:a1(),by:le.struct.combinator.merge([le.struct.generator.atomGroups({"residue-test":le.core.set.has([le.set("G","C","A","U","I","+U","+I"),le.ammp("label_comp_id")])}),le.struct.filter.pick({0:le.struct.generator.atomGroups({"group-by":le.ammp("residueKey")}),test:le.core.logic.or([le.core.set.has([le.ammpSet("label_atom_id"),le.atomName("O2*")]),le.core.set.has([le.ammpSet("label_atom_id"),le.atomName("O2'")])])})])})},protein:{"@desc":'defined as a group that (a) has one of the following group names: ALA, ARG, ASN, ASP, CYS, GLN, GLU, GLY, HIS, ILE, LEU, LYS, MET, PHE, PRO, SER, THR, TRP, TYR, VAL, ASX, GLX, or UNK; or (b) contains PDB atom designations [C, O, CA, and N] bonded correctly; or (c) does not contain "O" but contains [C, CA, and N] bonded correctly; or (d) has only one atom, which has name CA and does not have the group name CA (indicating a calcium atom).',map:()=>gme()},acidic:{"@desc":"ASP GLU",map:()=>Cr(to.acidic)},acyclic:{"@desc":"amino and not cyclic",map:()=>le.struct.modifier.intersectBy({0:Cr(to.amino),by:Ia(Cr(to.cyclic))})},aliphatic:{"@desc":"ALA GLY ILE LEU VAL",map:()=>Cr(to.aliphatic)},amino:{"@desc":"all twenty standard amino acids, plus ASX, GLX, UNK",map:()=>Cr(to.amino)},aromatic:{"@desc":'HIS PHE TRP TYR (see also "isaromatic" for aromatic bonds)',map:()=>Cr(to.aromatic)},basic:{"@desc":"ARG HIS LYS",map:()=>Cr(to.basic)},buried:{"@desc":"ALA CYS ILE LEU MET PHE TRP VAL",map:()=>Cr(to.buried)},charged:{"@desc":"same as acidic or basic -- ASP GLU, ARG HIS LYS",map:()=>Cr(to.acidic.concat(to.basic))},cyclic:{"@desc":"HIS PHE PRO TRP TYR",map:()=>Cr(to.cyclic)},helix:{"@desc":"secondary structure-related.",map:()=>le.struct.generator.atomGroups({"residue-test":le.core.flags.hasAny([le.struct.type.secondaryStructureFlags(["helix"]),le.ammp("secondaryStructureFlags")])})},helixalpha:{"@desc":"secondary structure-related.",map:()=>le.struct.generator.atomGroups({"residue-test":le.core.flags.hasAny([le.struct.type.secondaryStructureFlags(["alpha"]),le.ammp("secondaryStructureFlags")])})},helix310:{"@desc":"secondary structure-related.",map:()=>le.struct.generator.atomGroups({"residue-test":le.core.flags.hasAny([le.struct.type.secondaryStructureFlags(["3-10"]),le.ammp("secondaryStructureFlags")])})},helixpi:{"@desc":"secondary structure-related.",map:()=>le.struct.generator.atomGroups({"residue-test":le.core.flags.hasAny([le.struct.type.secondaryStructureFlags(["pi"]),le.ammp("secondaryStructureFlags")])})},hetero:{"@desc":"PDB atoms designated as HETATM",map:()=>le.struct.generator.atomGroups({"atom-test":le.ammp("isHet")})},hydrophobic:{"@desc":"ALA GLY ILE LEU MET PHE PRO TRP TYR VAL",map:()=>Cr(to.hydrophobic)},large:{"@desc":"ARG GLU GLN HIS ILE LEU LYS MET PHE TRP TYR",map:()=>Cr(to.large)},medium:{"@desc":"ASN ASP CYS PRO THR VAL",map:()=>Cr(to.medium)},negative:{"@desc":"same as acidic -- ASP GLU",map:()=>Cr(to.acidic)},neutral:{"@desc":"amino and not (acidic or basic)",map:()=>le.struct.modifier.intersectBy({0:Cr(to.amino),by:Ia(Cr(to.acidic.concat(to.basic)))})},polar:{"@desc":"amino and not hydrophobic",map:()=>le.struct.modifier.intersectBy({0:Cr(to.amino),by:Ia(Cr(to.hydrophobic))})},positive:{"@desc":"same as basic -- ARG HIS LYS",map:()=>Cr(to.basic)},sheet:{"@desc":"secondary structure-related",map:()=>le.struct.generator.atomGroups({"residue-test":le.core.flags.hasAny([le.struct.type.secondaryStructureFlags(["sheet"]),le.ammp("secondaryStructureFlags")])})},small:{"@desc":"ALA GLY SER",map:()=>Cr(to.small)},surface:{"@desc":"amino and not buried",map:()=>le.struct.modifier.intersectBy({0:Cr(to.amino),by:Ia(Cr(to.buried))})},turn:{"@desc":"secondary structure-related",map:()=>le.struct.generator.atomGroups({"residue-test":le.core.flags.hasAny([le.struct.type.secondaryStructureFlags(["turn"]),le.ammp("secondaryStructureFlags")])})},alpha:{"@desc":"(*.CA)",map:()=>le.struct.generator.atomGroups({"atom-test":le.core.rel.eq([le.atomName("CA"),le.ammp("label_atom_id")])})},base:{"@desc":"(nucleic bases)"},backbone:{"@desc":"(*.C, *.CA, *.N, and all nucleic other than the bases themselves)",abbr:["mainchain"],map:()=>yme()},sidechain:{"@desc":"((protein or nucleic) and not backbone)"},spine:{"@desc":"(*.CA, *.N, *.C for proteins; *.P, *.O3', *.O5', *.C3', *.C4', *.C5 for nucleic acids)"},leadatom:{"@desc":"(*.CA, *.P, and terminal *.O5')"},solvent:{"@desc":'PDB "HOH", water, also the connected set of H-O-H in any model'}};var ir=q,vme=[{"@desc":"value comparisons","@examples":[],name:"=",abbr:["=="],type:Vi,rule:fe.regexp(/\s*(LIKE|>=|<=|=|!=|>|<)\s*/i,1),map:(t,e,r)=>{let n;if(e==="structure"?n=ir.core.flags.hasAny([ir.ammp("secondaryStructureFlags"),bk(r)]):r==="structure"?n=ir.core.flags.hasAny([ir.ammp("secondaryStructureFlags"),bk(e)]):e.head!==void 0?e.head.name==="core.type.regex"&&(n=ir.core.str.match([e,ir.core.type.str([r])])):r.head!==void 0?r.head.name==="core.type.regex"&&(n=ir.core.str.match([r,ir.core.type.str([e])])):t.toUpperCase()==="LIKE"&&(e.head?n=ir.core.str.match([ir.core.type.regex([`^${r}$`,"i"]),ir.core.type.str([e])]):n=ir.core.str.match([ir.core.type.regex([`^${e}$`,"i"]),ir.core.type.str([r])])),!n)switch(e.head&&(r=Mg(e,r)),r.head&&(e=Mg(r,e)),t){case"=":n=ir.core.rel.eq([e,r]);break;case"!=":n=ir.core.rel.neq([e,r]);break;case">":n=ir.core.rel.gr([e,r]);break;case"<":n=ir.core.rel.lt([e,r]);break;case">=":n=ir.core.rel.gre([e,r]);break;case"<=":n=ir.core.rel.lte([e,r]);break;default:throw new Error(`value operator '${t}' not supported`)}return ir.struct.generator.atomGroups({"atom-test":n})}}];function bme(t){let[e,r,n,o,i,a,s]=t[1],l={};i&&(l["chain-test"]=ir.core.rel.eq([ir.ammp("auth_asym_id"),i]));let c=[];e&&c.push(ir.core.rel.eq([ir.ammp("label_comp_id"),e])),r&&c.push(ir.core.logic.and([ir.core.rel.gre([ir.ammp("auth_seq_id"),r[0]]),ir.core.rel.lte([ir.ammp("auth_seq_id"),r[1]])])),n&&c.push(ir.core.rel.eq([ir.ammp("auth_seq_id"),n])),o&&c.push(ir.core.rel.eq([ir.ammp("pdbx_PDB_ins_code"),o])),c.length&&(l["residue-test"]=n1(c));let u=[];return a&&u.push(ir.core.rel.eq([ir.ammp("auth_atom_id"),a])),s&&u.push(ir.core.rel.eq([ir.ammp("label_alt_id"),s])),u.length&&(l["atom-test"]=n1(u)),ir.struct.generator.atomGroups(l)}var xme=fe.createLanguage({Integer:()=>fe.regexp(/-?[0-9]+/).map(Number).desc("integer"),Parens:function(t){return fe.alt(t.Parens,t.Operator,t.Expression).wrap(fe.regexp(/\(\s*/),fe.regexp(/\s*\)/))},Expression:function(t){return fe.alt(t.Keywords,t.AtomExpression.map(bme),t.Within.map(e=>ir.struct.modifier.includeSurroundings({0:e[1],radius:e[0]})),t.ValueQuery,t.Element.map(e=>ir.struct.generator.atomGroups({"atom-test":ir.core.rel.eq([ir.acp("elementSymbol"),ir.struct.type.elementSymbol(e)])})),t.Resname.map(e=>ir.struct.generator.atomGroups({"residue-test":ir.core.rel.eq([ir.ammp("label_comp_id"),e])})))},Operator:function(t){return Cf(Sk,fe.alt(t.Parens,t.Expression))},AtomExpression:function(t){return fe.seq(fe.lookahead(t.AtomPrefix),fe.seq(t.BracketedResname.or(fe.of(null)),t.ResnoRange.or(fe.of(null)),t.Resno.or(fe.of(null)),t.Inscode.or(fe.of(null)),t.Chainname.or(fe.of(null)),t.Atomname.or(fe.of(null)),t.Altloc.or(fe.of(null)),t.Model.or(fe.of(null)))).desc("expression")},AtomPrefix:()=>fe.regexp(/[\[0-9:^%/.-]/).desc("atom-prefix"),Chainname:()=>fe.regexp(/:([A-Za-z]{1,3})/,1).desc("chainname"),Model:()=>fe.regexp(/\/([0-9]+)/,1).map(Number).desc("model"),Element:()=>fe.regexp(/_([A-Za-z]{1,3})/,1).desc("element"),Atomname:()=>fe.regexp(/\.([a-zA-Z0-9]{1,4})/,1).map(ir.atomName).desc("atomname"),Resname:()=>fe.regexp(/[a-zA-Z0-9]{1,4}/).desc("resname"),Resno:t=>t.Integer.desc("resno"),Altloc:()=>fe.regexp(/%([a-zA-Z0-9])/,1).desc("altloc"),Inscode:()=>fe.regexp(/\^([a-zA-Z0-9])/,1).desc("inscode"),BracketedResname:()=>fe.regexp(/\[([a-zA-Z0-9]{1,4})\]/,1).desc("bracketed-resname"),ResnoRange:t=>fe.seq(t.Integer.skip(fe.seq(fe.optWhitespace,fe.string("-"),fe.optWhitespace)),t.Integer).desc("resno-range"),Within:t=>fe.regexp(/within/i).skip(fe.regexp(/\s*\(\s*/)).then(fe.seq(t.Integer.skip(fe.regexp(/\s*,\s*/)),t.Query)).skip(fe.regexp(/\)/)),Keywords:()=>fe.alt(...L0(Ck)).desc("keyword"),Query:function(t){return fe.alt(t.Operator,t.Parens,t.Expression).trim(fe.optWhitespace)},Number:function(){return fe.regexp(/-?(0|[1-9][0-9]*)([.][0-9]+)?([eE][+-]?[0-9]+)?/).map(Number).desc("number")},String:function(){let t=B0(xk,Ck,Sk).sort(Dl).map(Jm).join("|");return fe.alt(fe.regexp(new RegExp(`(?!(${t}))[A-Z0-9_]+`,"i")),fe.regexp(/'((?:[^"\\]|\\.)*)'/,1),fe.regexp(/"((?:[^"\\]|\\.)*)"/,1).map(e=>ir.core.type.regex([`^${e}$`,"i"]))).desc("string")},Value:function(t){return fe.alt(t.Number,t.String)},ValueParens:function(t){return fe.alt(t.ValueParens,t.ValueOperator,t.ValueExpressions).wrap(fe.string("("),fe.string(")"))},ValuePropertyNames:function(){return fe.alt(...o1(xk,/LIKE|>=|<=|=|!=|>|<|\)|\s/i))},ValueOperator:function(t){return Cf(vme,fe.alt(t.ValueParens,t.ValueExpressions))},ValueExpressions:function(t){return fe.alt(t.Value,t.ValuePropertyNames)},ValueQuery:function(t){return fe.alt(t.ValueOperator.map(e=>{if(e.head){if(e.head.name.startsWith("structure-query.generator"))return e}else if(typeof e=="string"&&e.length<=4)return ir.struct.generator.atomGroups({"residue-test":ir.core.rel.eq([ir.ammp("label_comp_id"),e])});throw new Error(`values must be part of an comparison, value '${e}'`)}))}}),BH=t=>xme.Query.tryParse(t);var Da=q,d2=/[-+]?[0-9]*\.?[0-9]+/;function Sme(t){return t.split("+").map(Da.atomName)}function O0(t){return t.split("+").map(e=>e.replace(/^["']|["']$/g,""))}function Tk(t){if(t.includes("-")&&t.includes("+")){let e=t.split("+").map(n=>n.replace(/^["']|["']$/g,"")),r=[];return e.forEach(n=>{if(n.includes("-")&&!n.startsWith("-")){let[o,i]=n.split("-").map(a=>parseInt(a));for(let a=o;a<=i;a++)r.push(a)}else if(n.includes("-")&&n.startsWith("-")&&n.match(/[0-9]+-[-0-9]+/)){let o=-parseInt(n.split("-")[1]),i;n.includes("--")?i=-parseInt(n.split("-")[3]):i=parseInt(n.split("-")[2]);for(let a=o;a<=i;a++)r.push(a)}else n.includes("-")&&n.startsWith("-")&&n.match(/[0-9]+-[-0-9]+/),r.push(parseInt(n))}),r}else if(t.includes("-")&&!t.includes("+")){let e=[];if(t.startsWith("-"))if(t.startsWith("-")&&t.match(/[0-9]+-[-0-9]+/)){let r=-parseInt(t.split("-")[1]),n;t.includes("--")?n=-parseInt(t.split("-")[3]):n=parseInt(t.split("-")[2]);for(let o=r;o<=n;o++)e.push(o)}else t.startsWith("-")&&t.match(/[0-9]+-[-0-9]+/),e.push(parseInt(t));else{let[r,n]=t.split("-").map(o=>parseInt(o));for(let o=r;o<=n;o++)e.push(o)}return e}else return!t.includes("-")&&t.includes("+")?O0(t).map(e=>parseInt(e)):[parseInt(t)]}function Cme(t){return t.split("+").map(Da.struct.type.elementSymbol)}var Tme={H:"helix",S:"beta",L:"none"};function wme(t){return{flags:Da.struct.type.secondaryStructureFlags(t.toUpperCase().split("+").map(e=>Tme[e]||"none"))}}var s1={symbol:{"@desc":"chemical-symbol-list: list of 1- or 2-letter chemical symbols from the periodic table","@examples":["symbol O+N"],abbr:["e."],regex:/[a-zA-Z'"+]+/,map:Cme,level:"atom-test",property:Da.acp("elementSymbol")},name:{"@desc":"atom-name-list: list of up to 4-letter codes for atoms in proteins or nucleic acids","@examples":["name CA+CB+CG+CD"],abbr:["n."],regex:/[a-zA-Z0-9'"+]+/,map:Sme,level:"atom-test",property:Da.ammp("label_atom_id")},resn:{"@desc":"residue-name-list: list of 3-letter codes for amino acids or list of up to 2-letter codes for nucleic acids","@examples":["resn ASP+GLU+ASN+GLN","resn A+G"],abbr:["resname","r."],regex:/[a-zA-Z0-9'"+]+/,map:O0,level:"residue-test",property:Da.ammp("label_comp_id")},resi:{"@desc":"residue-identifier-list list of up to 4-digit residue numbers or residue-identifier-range","@examples":["resi 1+10+100+1000","resi 1-10"],abbr:["resident","residue","resid","i."],regex:/[0-9+-]+/,map:Tk,level:"residue-test",property:Da.ammp("auth_seq_id")},alt:{"@desc":"alternate-conformation-identifier-list list of single letters","@examples":["alt A+B",'alt ""','alt ""+A'],abbr:[],regex:/[a-zA-Z0-9'"+]+/,map:O0,level:"atom-test",property:Da.ammp("label_alt_id")},chain:{"@desc":"chain-identifier-list list of single letters or sometimes numbers","@examples":["chain A"],abbr:["c."],regex:/[a-zA-Z0-9'"+]+/,map:O0,level:"chain-test",property:Da.ammp("auth_asym_id")},segi:{"@desc":"segment-identifier-list list of up to 4 letter identifiers","@examples":["segi lig"],abbr:["segid","s."],regex:/[a-zA-Z0-9'"+]+/,map:O0,level:"chain-test",property:Da.ammp("label_asym_id")},flag:{"@desc":"flag-number a single integer from 0 to 31","@examples":["flag 0"],isUnsupported:!0,abbr:["f."],regex:/[0-9]+/,map:t=>parseInt(t),level:"atom-test"},numeric_type:{"@desc":"type-number a single integer","@examples":["nt. 5"],isUnsupported:!0,abbr:["nt."],regex:/[0-9]+/,map:t=>parseInt(t),level:"atom-test"},text_type:{"@desc":"type-string a list of up to 4 letter codes","@examples":["text_type HA+HC"],isUnsupported:!0,abbr:["tt."],regex:/[a-zA-Z0-9'"+]+/,map:O0,level:"atom-test"},id:{"@desc":"external-index-number a single integer","@examples":["id 23"],regex:/[0-9+-]+/,map:Tk,level:"atom-test",property:Da.ammp("id")},index:{"@desc":"internal-index-number a single integer","@examples":["index 11"],regex:/[0-9+-]+/,map:Tk,level:"atom-test",property:Da.ammp("id")},ss:{"@desc":"secondary-structure-type list of single letters. Helical regions should be assigned H and sheet regions S. Loop regions can either be assigned L or be blank.","@examples":["ss H+S+L",'ss S+""'],abbr:[],regex:/[a-zA-Z'"+]+/,map:wme,level:"residue-test",property:Da.ammp("secondaryStructureFlags")},b:{"@desc":"comparison-operator b-factor-value a real number","@examples":["b > 10"],isNumeric:!0,abbr:[],regex:d2,map:t=>parseFloat(t),level:"atom-test",property:Da.ammp("B_iso_or_equiv")},q:{"@desc":"comparison-operator occupancy-value a real number","@examples":["q <0.50"],isNumeric:!0,abbr:[],regex:d2,map:t=>parseFloat(t),level:"atom-test",property:Da.ammp("occupancy")},formal_charge:{"@desc":"comparison-operator formal charge-value an integer","@examples":["fc. = -1"],isNumeric:!0,abbr:["fc."],regex:d2,map:t=>parseFloat(t),level:"atom-test",property:Da.ammp("pdbx_formal_charge")},partial_charge:{"@desc":"comparison-operator partial charge-value a real number","@examples":["pc. > 1"],isUnsupported:!0,isNumeric:!0,abbr:["pc."],regex:d2,map:t=>parseFloat(t),level:"atom-test"},elem:{"@desc":'str  atomic element symbol string ("X" if undefined)',"@examples":["elem N"],regex:/[a-zA-Z0-9]{1,3}/,map:t=>Da.es(t),level:"atom-test",property:Da.acp("elementSymbol")}};var Kt=q,wk=[{"@desc":"Selects atoms that are not included in s1.","@examples":["NOT resn ALA","not (resi 42 or chain A)","!resi 42 or chain A"],name:"not",type:ra,rule:fe.alt(fe.regexp(/NOT/i).skip(fe.whitespace),fe.string("!").skip(fe.optWhitespace)),map:(t,e)=>Ia(e)},{"@desc":"Selects atoms included in both s1 and s2.","@examples":["chain A AND name CA"],name:"and",type:Vi,rule:nu(/AND|&/i),map:(t,e,r)=>Kt.struct.modifier.intersectBy({0:e,by:r})},{"@desc":"Selects atoms included in either s1 or s2.","@examples":["chain A OR chain B"],name:"or",type:Vi,rule:nu(/OR|\|/i),map:(t,e,r)=>Kt.struct.combinator.merge([e,r])},{"@desc":"Selects atoms in s1 whose identifiers name, resi, resn, chain and segi all match atoms in s2.","@examples":["chain A IN chain B"],name:"in",type:Vi,rule:nu(/IN/i),map:(t,e,r)=>Kt.struct.filter.withSameAtomProperties({0:e,source:r,property:Kt.core.type.compositeKey([Kt.ammp("label_atom_id"),Kt.ammp("label_seq_id"),Kt.ammp("label_comp_id"),Kt.ammp("auth_asym_id"),Kt.ammp("label_asym_id")])})},{"@desc":"Selects atoms in s1 whose identifiers name and resi match atoms in s2.","@examples":["chain A LIKE chain B"],name:"like",type:Vi,rule:nu(/LIKE|l\./i),map:(t,e,r)=>Kt.struct.filter.withSameAtomProperties({0:e,source:r,property:Kt.core.type.compositeKey([Kt.ammp("label_atom_id"),Kt.ammp("label_seq_id")])})},{"@desc":"Selects all atoms whose van der Waals radii are separated from the van der Waals radii of s1 by a minimum of X Angstroms.","@examples":["solvent GAP 2"],name:"gap",type:t1,rule:r1(/GAP\s+([-+]?[0-9]*\.?[0-9]+)/i,1).map(t=>parseFloat(t)),map:(t,e)=>Kt.struct.filter.within({0:Kt.struct.generator.all(),target:e,"atom-radius":Kt.acp("vdw"),"max-radius":t,invert:!0})},{"@desc":"Selects atoms with centers within X Angstroms of the center of any atom in s1.","@examples":["resname LIG AROUND 1"],name:"around",abbr:["a."],type:t1,rule:r1(/(AROUND|a\.)\s+([-+]?[0-9]*\.?[0-9]+)/i,2).map(t=>parseFloat(t)),map:(t,e)=>Kt.struct.modifier.exceptBy({0:Kt.struct.filter.within({0:Kt.struct.generator.all(),target:e,"max-radius":t}),by:e})},{"@desc":"Expands s1 by all atoms within X Angstroms of the center of any atom in s1.","@examples":["chain A EXPAND 3"],name:"expand",abbr:["x."],type:t1,rule:r1(/(EXPAND|x\.)\s+([-+]?[0-9]*\.?[0-9]+)/i,2).map(t=>parseFloat(t)),map:(t,e)=>Kt.struct.modifier.includeSurroundings({0:e,radius:t})},{"@desc":"Selects atoms in s1 that are within X Angstroms of any atom in s2.","@examples":["chain A WITHIN 3 OF chain B"],name:"within",abbr:["w."],type:Vi,rule:c2("WITHIN","w."),map:(t,e,r)=>Kt.struct.filter.within({0:e,target:r,"max-radius":t})},{"@desc":"Same as within, but excludes s2 from the selection (and thus is identical to s1 and s2 around X).","@examples":["chain A NEAR_TO 3 OF chain B"],name:"near_to",abbr:["nto."],type:Vi,rule:c2("NEAR_TO","nto."),map:(t,e,r)=>Kt.struct.modifier.exceptBy({0:Kt.struct.filter.within({0:e,target:r,"max-radius":t}),by:r})},{"@desc":"Selects atoms in s1 that are at least X Anstroms away from s2.","@examples":["solvent BEYOND 2 OF chain A"],name:"beyond",abbr:["be."],type:Vi,rule:c2("BEYOND","be."),map:(t,e,r)=>Kt.struct.modifier.exceptBy({0:Kt.struct.filter.within({0:e,target:r,"max-radius":t,invert:!0}),by:r})},{"@desc":"Expands selection to complete residues.","@examples":["BYRESIDUE name N"],name:"byresidue",abbr:["byresi","byres","br."],type:ra,rule:nl(/BYRESIDUE|byresi|byres|br\./i),map:(t,e)=>dc(Kt.struct.modifier.expandProperty({0:Kt.struct.modifier.union({0:e}),property:Kt.ammp("residueKey")}))},{"@desc":"Completely selects all alpha carbons in all residues covered by a selection.","@examples":["BYCALPHA chain A"],name:"bycalpha",abbr:["bca."],type:ra,rule:nl(/BYCALPHA|bca\./i),map:(t,e)=>Kt.struct.generator.queryInSelection({0:Kt.struct.modifier.expandProperty({0:Kt.struct.modifier.union({0:e}),property:Kt.ammp("residueKey")}),query:Kt.struct.generator.atomGroups({"atom-test":Kt.core.rel.eq([Kt.atomName("CA"),Kt.ammp("label_atom_id")])})})},{"@desc":"Expands selection to complete molecules.","@examples":["BYMOLECULE resi 20-30"],name:"bymolecule",isUnsupported:!0,abbr:["bymol","bm."],type:ra,rule:nl(/BYMOLECULE|bymol|bm\./i),map:(t,e)=>dc(Kt.struct.modifier.expandProperty({0:Kt.struct.modifier.union({0:e}),property:Kt.atp("connectedComponentKey")}))},{"@desc":"Expands selection to complete fragments.","@examples":["BYFRAGMENT resi 10"],name:"byfragment",abbr:["byfrag","bf."],isUnsupported:!0,type:ra,rule:nl(/BYFRAGMENT|byfrag|bf\./i),map:(t,e)=>[t,e]},{"@desc":"Expands selection to complete segments.","@examples":["BYSEGMENT resn CYS"],name:"bysegment",abbr:["bysegi","byseg","bs."],type:ra,rule:nl(/BYSEGMENT|bysegi|byseg|bs\./i),map:(t,e)=>dc(Kt.struct.modifier.expandProperty({0:Kt.struct.modifier.union({0:e}),property:Kt.ammp("chainKey")}))},{"@desc":"Expands selection to complete objects.","@examples":["BYOBJECT chain A"],name:"byobject",abbr:["byobj","bo."],isUnsupported:!0,type:ra,rule:nl(/BYOBJECT|byobj|bo\./i),map:(t,e)=>[t,e]},{"@desc":"Expands selection to unit cell.","@examples":["BYCELL chain A"],name:"bycell",isUnsupported:!0,type:ra,rule:nl(/BYCELL/i),map:(t,e)=>[t,e]},{"@desc":"All rings of size \u2264 7 which have at least one atom in s1.","@examples":["BYRING resn HEM"],name:"byring",type:ra,rule:nl(/BYRING/i),map:(t,e)=>dc(Kt.struct.modifier.intersectBy({0:Kt.struct.filter.pick({0:Kt.struct.generator.rings(),test:Kt.core.logic.and([Kt.core.rel.lte([Kt.struct.atomSet.atomCount(),7]),Kt.core.rel.gr([Kt.struct.atomSet.countQuery([e]),1])])}),by:e}))},{"@desc":"Selects atoms directly bonded to s1, excludes s1.","@examples":["NEIGHBOR resn CYS"],name:"neighbor",type:ra,abbr:["nbr."],rule:nl(/NEIGHBOR|nbr\./i),map:(t,e)=>Kt.struct.modifier.exceptBy({0:dc(Kt.struct.modifier.includeConnected({0:Kt.struct.modifier.union({0:e}),"bond-test":!0})),by:e})},{"@desc":"Selects atoms directly bonded to s1, may include s1.","@examples":["BOUND_TO name CA"],name:"bound_to",abbr:["bto."],type:ra,rule:nl(/BOUND_TO|bto\./i),map:(t,e)=>dc(Kt.struct.modifier.includeConnected({0:Kt.struct.modifier.union({0:e})}))},{"@desc":"Extends s1 by X bonds connected to atoms in s1.","@examples":["resname LIG EXTEND 3"],name:"extend",abbr:["xt."],type:t1,rule:r1(/(EXTEND|xt\.)\s+([0-9]+)/i,2).map(t=>parseInt(t)),map:(t,e)=>dc(Kt.struct.modifier.includeConnected({0:Kt.struct.modifier.union({0:e}),"bond-test":!0,"layer-count":t}))}];var et=q,Ts={nucleic:["A","C","T","G","U","DA","DC","DT","DG","DU"],protein:["ALA","ARG","ASN","ASP","CYS","CYX","GLN","GLU","GLY","HIS","HID","HIE","HIP","ILE","LEU","LYS","MET","MSE","PHE","PRO","SER","THR","TRP","TYR","VAL"],solvent:["HOH","WAT","H20","TIP","SOL"]},OH={nucleic:["P","O3'","O5'","C5'","C4'","C3'","OP1","OP2","O3*","O5*","C5*","C4*","C3*","C2'","C1'","O4'","O2'"],protein:["C","N","CA","O"]};function FH(){return et.struct.combinator.merge([et.struct.modifier.intersectBy({0:et.struct.generator.atomGroups({"residue-test":et.core.set.has([et.core.type.set(Ts.protein),et.ammp("label_comp_id")])}),by:et.struct.generator.atomGroups({"atom-test":et.core.set.has([et.core.type.set(OH.protein),et.ammp("label_atom_id")])})}),et.struct.modifier.intersectBy({0:et.struct.generator.atomGroups({"residue-test":et.core.set.has([et.core.type.set(Ts.nucleic),et.ammp("label_comp_id")])}),by:et.struct.generator.atomGroups({"atom-test":et.core.set.has([et.core.type.set(OH.nucleic),et.ammp("label_atom_id")])})})])}var _k={all:{"@desc":"All atoms currently loaded into PyMOL",abbr:["*"],map:()=>et.struct.generator.all()},none:{"@desc":"No atoms (empty selection)",map:()=>et.struct.generator.empty()},hydrogens:{"@desc":"All hydrogen atoms currently loaded into PyMOL",abbr:["hydro","h."],map:()=>et.struct.generator.atomGroups({"atom-test":et.core.rel.eq([et.acp("elementSymbol"),et.es("H")])})},hetatm:{"@desc":"All atoms loaded from Protein Data Bank HETATM records",abbr:["het"],map:()=>et.struct.generator.atomGroups({"atom-test":et.core.rel.eq([et.ammp("isHet"),!0])})},visible:{"@desc":"All atoms in enabled objects with at least one visible representation",abbr:["v."]},polymer:{"@desc":"All atoms on the polymer (not het). Finds atoms with residue identifiers matching a known polymer, such a peptide and DNA.",abbr:["pol."],map:()=>et.struct.generator.atomGroups({"residue-test":et.core.set.has([et.core.type.set(Ts.nucleic.concat(Ts.protein)),et.ammp("label_comp_id")])})},sidechain:{"@desc":"Polymer non-backbone atoms (new in PyMOL 1.6.1)",abbr:["sc."],map:()=>et.struct.modifier.exceptBy({0:et.struct.generator.atomGroups({"residue-test":et.core.set.has([et.core.type.set(Ts.nucleic.concat(Ts.protein)),et.ammp("label_comp_id")])}),by:FH()})},present:{"@desc":"All atoms with defined coordinates in the current state (used in creating movies)",abbr:["pr."]},center:{"@desc":"Pseudo-atom at the center of the scene"},origin:{"@desc":"Pseudo-atom at the origin of rotation"},enabled:{"@desc":"All enabled objects or selections from the object list."},masked:{"@desc":"All masked atoms.",abbr:["msk."]},protected:{"@desc":"All protected atoms.",abbr:["pr."]},bonded:{"@desc":"All bonded atoms",map:()=>et.struct.generator.atomGroups({"atom-test":et.core.rel.gr([et.struct.atomProperty.core.bondCount({flags:et.struct.type.bondFlags(["covalent","metallic","sulfide"])}),0])})},donors:{"@desc":"All hydrogen bond donor atoms.",abbr:["don."]},acceptors:{"@desc":"All hydrogen bond acceptor atoms.",abbr:["acc."]},fixed:{"@desc":"All fixed atoms.",abbr:["fxd."]},restrained:{"@desc":"All restrained atoms.",abbr:["rst."]},organic:{"@desc":"All atoms in non-polymer organic compounds (e.g. ligands, buffers). Finds carbon-containing molecules that do not match known polymers.",abbr:["org."],map:()=>dc(et.struct.modifier.expandProperty({0:et.struct.modifier.union([et.struct.generator.queryInSelection({0:et.struct.generator.atomGroups({"residue-test":et.core.logic.not([et.core.set.has([et.core.type.set(Ts.nucleic.concat(Ts.protein)),et.ammp("label_comp_id")])])}),query:et.struct.generator.atomGroups({"atom-test":et.core.rel.eq([et.es("C"),et.acp("elementSymbol")])})})]),property:et.ammp("residueKey")}))},inorganic:{"@desc":"All non-polymer inorganic atoms/ions. Finds atoms in molecules that do not contain carbon and do not match any known solvent residues.",abbr:["ino."],map:()=>dc(et.struct.modifier.expandProperty({0:et.struct.modifier.union([et.struct.filter.pick({0:et.struct.generator.atomGroups({"residue-test":et.core.logic.not([et.core.set.has([et.core.type.set(Ts.nucleic.concat(Ts.protein).concat(Ts.solvent)),et.ammp("label_comp_id")])]),"group-by":et.ammp("residueKey")}),test:et.core.logic.not([et.core.set.has([et.struct.atomSet.propertySet([et.acp("elementSymbol")]),et.es("C")])])})]),property:et.ammp("residueKey")}))},solvent:{"@desc":"All water molecules. The hardcoded solvent residue identifiers are currently: HOH, WAT, H20, TIP, SOL.",abbr:["sol."],map:()=>et.struct.generator.atomGroups({"residue-test":et.core.set.has([et.core.type.set(Ts.solvent),et.ammp("label_comp_id")])})},guide:{"@desc":"All protein CA and nucleic acid C4*/C4",map:()=>et.struct.combinator.merge([et.struct.generator.atomGroups({"atom-test":et.core.rel.eq([et.atomName("CA"),et.ammp("label_atom_id")]),"residue-test":et.core.set.has([et.core.type.set(Ts.protein),et.ammp("label_comp_id")])}),et.struct.generator.atomGroups({"atom-test":et.core.set.has([uc(["C4*","C4'"]),et.ammp("label_atom_id")]),"residue-test":et.core.set.has([et.core.type.set(Ts.nucleic),et.ammp("label_comp_id")])})])},metals:{"@desc":"All metal atoms (new in PyMOL 1.6.1)"},backbone:{"@desc":"Polymer backbone atoms (new in PyMOL 1.6.1)",abbr:["bb."],map:()=>FH()},"polymer.protein":{"@desc":"Protein (New in PyMOL 2.1)",abbr:["polymer.protein"],map:()=>et.struct.generator.atomGroups({"residue-test":et.core.set.has([et.core.type.set(Ts.protein),et.ammp("label_comp_id")])})},"polymer.nucleic":{"@desc":"Nucleic Acid (New in PyMOL 2.1)",abbr:["polymer.nucleic"],map:()=>et.struct.generator.atomGroups({"residue-test":et.core.set.has([et.core.type.set(Ts.nucleic),et.ammp("label_comp_id")])})}};var _me=q,Zo=DH(s1),ci=fe.string("/");function Xn(t){return t.or(fe.of(null))}function Pme(t){let e={},r={};for(let n in t){let o=s1[n];if(!o)throw new Error(`property '${n}' not supported, value '${t[n]}'`);t[n]!==null&&(r[o.level]||(r[o.level]=[]),r[o.level].push(t[n]))}for(let n in r)e[n]=n1(r[n]);return _me.struct.generator.atomGroups(e)}var Eme=fe.createLanguage({Parens:function(t){return fe.alt(t.Parens,t.Operator,t.Expression).wrap(fe.string("("),fe.string(")"))},Expression:function(t){return fe.alt(t.Keywords,t.AtomSelectionMacro.map(Pme),t.NamedAtomProperties,t.Pepseq,t.Rep,t.Object)},AtomSelectionMacro:function(t){return fe.alt(ci.then(fe.alt(fe.seq(Xn(t.ObjectProperty).skip(ci),Xn(Zo.segi).skip(ci),Xn(Zo.chain).skip(ci),Xn(Zo.resi).skip(ci),Xn(Zo.name)).map(e=>({object:e[0],segi:e[1],chain:e[2],resi:e[3],name:e[4]})),fe.seq(Xn(t.ObjectProperty).skip(ci),Xn(Zo.segi).skip(ci),Xn(Zo.chain).skip(ci),Xn(Zo.resi)).map(e=>({object:e[0],segi:e[1],chain:e[2],resi:e[3]})),fe.seq(Xn(t.ObjectProperty).skip(ci),Xn(Zo.segi).skip(ci),Xn(Zo.chain)).map(e=>({object:e[0],segi:e[1],chain:e[2]})),fe.seq(Xn(t.ObjectProperty).skip(ci),Xn(Zo.segi)).map(e=>({object:e[0],segi:e[1]})),fe.seq(Xn(t.ObjectProperty)).map(e=>({object:e[0]})))),fe.alt(fe.seq(Xn(t.ObjectProperty).skip(ci),Xn(Zo.segi).skip(ci),Xn(Zo.chain).skip(ci),Xn(Zo.resi).skip(ci),Xn(Zo.name)).map(e=>({object:e[0],segi:e[1],chain:e[2],resi:e[3],name:e[4]})),fe.seq(Xn(Zo.segi).skip(ci),Xn(Zo.chain).skip(ci),Xn(Zo.resi).skip(ci),Xn(Zo.name)).map(e=>({segi:e[0],chain:e[1],resi:e[2],name:e[3]})),fe.seq(Xn(Zo.chain).skip(ci),Xn(Zo.resi).skip(ci),Xn(Zo.name)).map(e=>({chain:e[0],resi:e[1],name:e[2]})),fe.seq(Xn(Zo.resi).skip(ci),Xn(Zo.name)).map(e=>({resi:e[0],name:e[1]}))))},NamedAtomProperties:function(){return fe.alt(...u2(s1))},Keywords:()=>fe.alt(...L0(_k)),ObjectProperty:()=>{let t=B0(s1,_k,wk).sort(Dl).map(Jm).join("|");return fe.regexp(new RegExp(`(?!(${t}))[A-Z0-9_]+`,"i"))},Object:t=>t.ObjectProperty.notFollowedBy(ci).map(e=>{throw new Error(`property 'object' not supported, value '${e}'`)}),Pepseq:()=>fe.regexp(/(PEPSEQ|ps\.)\s+([a-z]+)/i,2).map(pp("operator 'pepseq' not supported")),Rep:()=>fe.regexp(/REP\s+(lines|spheres|mesh|ribbon|cartoon|sticks|dots|surface|labels|extent|nonbonded|nb_spheres|slice|extent|slice|dashes|angles|dihedrals|cgo|cell|callback|everything)/i,1).map(pp("operator 'rep' not supported")),Operator:function(t){return Cf(wk,fe.alt(t.Parens,t.Expression,t.Operator))},Query:function(t){return fe.alt(t.Operator,t.Parens,t.Expression).trim(fe.optWhitespace)}}),NH=t=>Eme.Query.tryParse(t);var Fo=q,Al=/[-+]?[0-9]*\.?[0-9]+/,m2=/[+]?[0-9]+/,l1=/[-+]?[0-9]+/;function Rg(t){return t}var Pk={T:"turn",E:"sheet",B:"strand",H:"alpha",G:"3-10",I:"pi",C:"none"};function p2(t){return Fo.struct.type.secondaryStructureFlags([Pk[t.toUpperCase()]||"none"])}var hp={name:{"@desc":"str    atom name","@examples":["name CA"],regex:/[a-zA-Z0-9]+/,map:Fo.atomName,level:"atom-test",property:Fo.ammp("label_atom_id")},type:{"@desc":"str    atom type","@examples":["type C3"],isUnsupported:!0,regex:/[a-zA-Z0-9]+/,map:Rg,level:"atom-test"},index:{"@desc":"num    the atom number, starting at 0","@examples":["index 10"],isNumeric:!0,regex:m2,map:t=>parseInt(t)-1,level:"atom-test",property:Fo.ammp("id")},serial:{"@desc":"num    the atom number, starting at 1","@examples":["serial 11"],isNumeric:!0,regex:m2,map:t=>parseInt(t),level:"atom-test",property:Fo.ammp("id")},atomicnumber:{"@desc":"num    atomic number (0 if undefined)","@examples":["atomicnumber 13"],isNumeric:!0,regex:m2,map:t=>parseInt(t),level:"atom-test",property:Fo.acp("atomicNumber")},element:{"@desc":'str  atomic element symbol string ("X" if undefined)',"@examples":["element N"],regex:/[a-zA-Z0-9]{1,3}/,map:t=>Fo.es(t),level:"atom-test",property:Fo.acp("elementSymbol")},altloc:{"@desc":"str  alternate location/conformation identifier","@examples":["altloc C"],regex:/[a-zA-Z0-9]+/,map:Rg,level:"atom-test",property:Fo.ammp("label_alt_id")},chain:{"@desc":"str  the one-character chain identifier","@examples":["chain A"],regex:/[a-zA-Z0-9]+/,map:Rg,level:"residue-test",property:Fo.ammp("auth_asym_id")},residue:{"@desc":"num  a set of connected atoms with the same residue number","@examples":["residue < 11","residue 11"],isNumeric:!0,regex:l1,map:t=>parseInt(t),level:"residue-test",property:Fo.ammp("auth_seq_id")},fragment:{"@desc":"num  a set of connected residues","@examples":["fragment 42"],isUnsupported:!0,isNumeric:!0,regex:l1,map:t=>parseInt(t),level:"residue-test"},pfrag:{"@desc":"num  a set of connected protein residues","@examples":["pfrag 42"],isUnsupported:!0,isNumeric:!0,regex:l1,map:t=>parseInt(t),level:"residue-test"},nfrag:{"@desc":"num  a set of connected nucleic residues","@examples":["nfrag 42"],isUnsupported:!0,isNumeric:!0,regex:l1,map:t=>parseInt(t),level:"residue-test"},sequence:{"@desc":"str  a sequence given by one letter names","@examples":["sequence PGATTACA"],isUnsupported:!0,regex:/[a-zA-Z0-9]+/,map:Rg,level:"residue-test"},numbonds:{"@desc":"num  number of bonds","@examples":["numbonds = 2","numbonds >= 3"],isNumeric:!0,regex:m2,map:t=>parseInt(t),level:"atom-test",property:Fo.acp("bondCount")},resname:{"@desc":"str  residue name","@examples":["resname ALA"],regex:/[a-zA-Z0-9]+/,map:Rg,level:"residue-test",property:Fo.ammp("auth_comp_id")},resid:{"@desc":"num  residue id","@examples":["resid 42"],isNumeric:!0,regex:l1,map:t=>parseInt(t),level:"residue-test",property:Fo.ammp("auth_seq_id")},segname:{"@desc":"str  segment name","@examples":["segname B"],regex:/[a-zA-Z0-9]+/,map:Rg,level:"residue-test",property:Fo.ammp("label_asym_id")},x:{"@desc":"float  x coordinate","@examples":["x 42"],isNumeric:!0,regex:Al,map:t=>parseFloat(t),level:"atom-test",property:Fo.acp("x")},y:{"@desc":"float  y coordinate","@examples":["y > 1.7"],isNumeric:!0,regex:Al,map:t=>parseFloat(t),level:"atom-test",property:Fo.acp("y")},z:{"@desc":"float  z coordinate","@examples":["z < 11","z > -21"],isNumeric:!0,regex:Al,map:t=>parseFloat(t),level:"atom-test",property:Fo.acp("z")},radius:{"@desc":"float  atomic radius","@examples":["radius > 1.3"],isNumeric:!0,regex:Al,map:t=>parseFloat(t),level:"atom-test",property:Fo.acp("vdw")},mass:{"@desc":"float  atomic mass","@examples":["mass > 2"],isNumeric:!0,regex:Al,map:t=>parseFloat(t),level:"atom-test",property:Fo.acp("mass")},charge:{"@desc":"float  atomic charge","@examples":["charge > 0","charge 1"],isNumeric:!0,regex:Al,map:t=>parseFloat(t),level:"atom-test",property:Fo.ammp("pdbx_formal_charge")},beta:{"@desc":"float  temperature factor","@examples":["beta < 20","beta > 35"],isNumeric:!0,regex:Al,map:t=>parseFloat(t),level:"atom-test",property:Fo.ammp("B_iso_or_equiv")},occupancy:{"@desc":"float  occupancy","@examples":["occupancy 1","occupancy < 1"],isNumeric:!0,regex:Al,map:t=>parseFloat(t),level:"atom-test",property:Fo.ammp("occupancy")},user:{"@desc":"float  time-varying user-specified value","@examples":["user < 0.1"],isUnsupported:!0,isNumeric:!0,regex:Al,map:t=>parseFloat(t),level:"atom-test"},rasmol:{"@desc":"str  translates Rasmol selection string to VMD","@examples":["rasmol 'all'"],isUnsupported:!0,regex:/[^']*/,map:Rg,level:"atom-test"},structure:{"@desc":"str  single letter name for the secondary structure","@examples":["structure H","structure H E"],regex:/T|E|B|H|G|I|C/i,map:p2,level:"atom-test",property:Fo.ammp("secondaryStructureFlags")},phi:{"@desc":"float  phi backbone conformational angles","@examples":["phi < 160"],isUnsupported:!0,isNumeric:!0,regex:Al,map:t=>parseFloat(t),level:"residue-test"},psi:{"@desc":"float  psi backbone conformational angles","@examples":["psi < 160"],isUnsupported:!0,isNumeric:!0,regex:Al,map:t=>parseFloat(t),level:"residue-test"},ufx:{"@desc":"num  force to apply in the x coordinate","@examples":["ufx 1"],isUnsupported:!0,isNumeric:!0,regex:Al,map:t=>parseInt(t),level:"atom-test"},ufy:{"@desc":"num  force to apply in the y coordinate","@examples":["ufy 1"],isUnsupported:!0,isNumeric:!0,regex:Al,map:t=>parseInt(t),level:"atom-test"},ufz:{"@desc":"num  force to apply in the z coordinate","@examples":["ufz 1"],isUnsupported:!0,isNumeric:!0,regex:Al,map:t=>parseInt(t),level:"atom-test"}};var Lg=q,Ime=Object.keys(hp).sort(Dl).filter(t=>!hp[t].isUnsupported).join("|"),Ek=[{"@desc":"Selects atoms that are not included in s1.","@examples":["not protein"],name:"not",type:ra,rule:fe.regexp(/NOT/i).skip(fe.whitespace),map:(t,e)=>Ia(e)},{"@desc":"Selects atoms within a specified distance of a selection","@examples":["within 5 of name FE"],name:"within",type:ra,rule:nl(/WITHIN\s+([-+]?[0-9]*\.?[0-9]+)\s+OF/i,1).map(t=>parseFloat(t)),map:(t,e)=>Lg.struct.modifier.includeSurroundings({0:e,radius:t})},{"@desc":"Exclusive within, equivalent to (within 3 of X) and not X","@examples":["exwithin 10 of resname HEM"],name:"exwithin",type:ra,rule:nl(/EXWITHIN\s+([-+]?[0-9]*\.?[0-9]+)\s+OF/i,1).map(t=>parseFloat(t)),map:(t,e)=>Lg.struct.modifier.exceptBy({0:Lg.struct.modifier.includeSurroundings({0:e,radius:t}),by:e})},{"@desc":"Selects atoms which have the same keyword as the atoms in a given selection","@examples":["same resid as name FE"],name:"same",type:ra,rule:nl(new RegExp(`SAME\\s+(${Ime})\\s+AS`,"i"),1).map(t=>hp[t].property),map:(t,e)=>Lg.struct.filter.withSameAtomProperties({0:Lg.struct.generator.all(),source:e,property:t})},{"@desc":"Selects atoms included in both s1 and s2.","@examples":["backbone and protein"],name:"and",type:Vi,rule:fe.alt(nu(/AND/i),fe.whitespace),map:(t,e,r)=>Lg.struct.modifier.intersectBy({0:e,by:r})},{"@desc":"Selects atoms included in either s1 or s2.","@examples":["water or protein"],name:"or",type:Vi,rule:nu(/OR/i),map:(t,e,r)=>Lg.struct.combinator.merge([e,r])}];var sr=q;function gp(){return sr.struct.filter.pick({0:sr.struct.generator.atomGroups({"group-by":sr.ammp("residueKey")}),test:sr.core.set.isSubset([uc(["C","N","CA","O"]),sr.ammpSet("label_atom_id")])})}function Ik(){return sr.struct.filter.pick({0:sr.struct.generator.atomGroups({"group-by":sr.ammp("residueKey")}),test:sr.core.logic.and([sr.core.set.isSubset([uc(["P"]),sr.ammpSet("label_atom_id")]),sr.core.logic.or([sr.core.set.isSubset([uc(["O3'","C3'","C4'","C5'","O5'"]),sr.ammpSet("label_atom_id")]),sr.core.set.isSubset([uc(["O3*","C3*","C4*","C5*","O5*"]),sr.ammpSet("label_atom_id")])])])})}function VH(){return sr.struct.combinator.merge([sr.struct.generator.queryInSelection({0:gp(),query:sr.struct.generator.atomGroups({"atom-test":sr.core.set.has([uc(zH.protein),sr.ammp("label_atom_id")])})}),sr.struct.generator.queryInSelection({0:Ik(),query:sr.struct.generator.atomGroups({"atom-test":sr.core.set.has([uc(zH.nucleic),sr.ammp("label_atom_id")])})})])}function lm(t){return sr.struct.generator.atomGroups({"residue-test":sr.core.flags.hasAll([sr.ammp("secondaryStructureFlags"),sr.struct.type.secondaryStructureFlags(t)])})}var zH={nucleic:["P","O3'","O5'","C5'","C4'","C3'","OP1","OP2","O3*","O5*","C5*","C4*","C3*"],protein:["C","N","CA","O"]},ui={acidic:["ASP","GLU"],aliphatic:["ALA","GLY","ILE","LEU","VAL"],aromatic:["HIS","PHE","TRP","TYR"],at:["ADA","A","THY","T"],basic:["ARG","HIS","LYS"],buried:["ALA","LEU","VAL","ILE","PHE","CYS","MET","TRP"],cg:["CYT","C","GUA","G"],cyclic:["HIS","PHE","PRO","TRP","TYR"],hydrophobic:["ALA","LEU","VAL","ILE","PRO","PHE","MET","TRP"],medium:["VAL","THR","ASP","ASN","PRO","CYS","ASX","PCA","HYP"],neutral:["VAL","PHE","GLN","TYR","HIS","CYS","MET","TRP","ASX","GLX","PCA","HYP"],purine:["ADE","A","GUA","G"],pyrimidine:["CYT","C","THY","T","URI","U"],small:["ALA","GLY","SER"],water:["H2O","HH0","OHH","HOH","OH2","SOL","WAT","TIP","TIP2","TIP3","TIP4"]},Dk={all:{"@desc":"everything",map:()=>sr.struct.generator.all()},none:{"@desc":"nothing",map:()=>sr.struct.generator.empty()},protein:{"@desc":"a residue with atoms named C, N, CA, and O",map:()=>gp()},nucleic:{"@desc":"a residue with atoms named P, O1P, O2P and either O3', C3', C4', C5', O5' or O3*, C3*, C4*, C5*, O5*. This definition assumes that the base is phosphorylated, an assumption which will be corrected in the future.",map:()=>Ik()},backbone:{"@desc":"the C, N, CA, and O atoms of a protein and the equivalent atoms in a nucleic acid.",map:()=>VH()},sidechain:{"@desc":"non-backbone atoms and bonds",map:()=>Ia(VH())},water:{"@desc":"all atoms with the resname H2O, HH0, OHH, HOH, OH2, SOL, WAT, TIP, TIP2, TIP3 or TIP4",abbr:["waters"],map:()=>Cr(ui.water)},at:{"@desc":"residues named ADA A THY T",map:()=>Cr(ui.at)},acidic:{"@desc":"residues named ASP GLU",map:()=>Cr(ui.acidic)},acyclic:{"@desc":'"protein and not cyclic"',map:()=>sr.struct.modifier.intersectBy({0:gp(),by:Ia(Cr(ui.cyclic))})},aliphatic:{"@desc":"residues named ALA GLY ILE LEU VAL",map:()=>Cr(ui.aliphatic)},alpha:{"@desc":"atom's residue is an alpha helix",map:()=>lm(["alpha"])},amino:{"@desc":"a residue with atoms named C, N, CA, and O",map:()=>gp()},aromatic:{"@desc":"residues named HIS PHE TRP TYR",map:()=>Cr(ui.aromatic)},basic:{"@desc":"residues named ARG HIS LYS",map:()=>Cr(ui.basic)},bonded:{"@desc":"atoms for which numbonds > 0",map:()=>dc(sr.struct.filter.pick({0:sr.struct.modifier.includeConnected({0:sr.struct.generator.all(),"bond-test":sr.core.flags.hasAny([sr.struct.bondProperty.flags(),sr.struct.type.bondFlags(["covalent","metallic","sulfide"])])}),test:sr.core.rel.gr([sr.struct.atomSet.atomCount(),1])}))},buried:{"@desc":"residues named ALA LEU VAL ILE PHE CYS MET TRP",map:()=>Cr(ui.buried)},cg:{"@desc":"residues named CYT C GUA G",map:()=>Cr(ui.cg)},charged:{"@desc":'"basic or acidic"',map:()=>Cr(ui.basic.concat(ui.acidic))},cyclic:{"@desc":"residues named HIS PHE PRO TRP TYR",map:()=>Cr(ui.cyclic)},hetero:{"@desc":'"not (protein or nucleic)"',map:()=>Ia(sr.struct.combinator.merge([gp(),Ik()]))},hydrogen:{"@desc":'name "[0-9]?H.*"',map:()=>sr.struct.generator.atomGroups({"atom-test":sr.core.str.match([sr.core.type.regex(["^[0-9]?[H].*$","i"]),sr.core.type.str([sr.ammp("label_atom_id")])])})},large:{"@desc":'"protein and not (small or medium)"',map:()=>sr.struct.modifier.intersectBy({0:gp(),by:Ia(Cr(ui.small.concat(ui.medium)))})},medium:{"@desc":"residues named VAL THR ASP ASN PRO CYS ASX PCA HYP",map:()=>Cr(ui.medium)},neutral:{"@desc":"residues named VAL PHE GLN TYR HIS CYS MET TRP ASX GLX PCA HYP",map:()=>Cr(ui.neutral)},hydrophobic:{"@desc":"hydrophobic resname ALA LEU VAL ILE PRO PHE MET TRP",map:()=>Cr(ui.hydrophobic)},polar:{"@desc":'"protein and not hydrophobic"',map:()=>sr.struct.modifier.intersectBy({0:gp(),by:Ia(Cr(ui.hydrophobic))})},purine:{"@desc":"residues named ADE A GUA G",map:()=>Cr(ui.purine)},pyrimidine:{"@desc":"residues named CYT C THY T URI U",map:()=>Cr(ui.pyrimidine)},small:{"@desc":"residues named ALA GLY SER",map:()=>Cr(ui.small)},surface:{"@desc":'"protein and not buried"',map:()=>sr.struct.modifier.intersectBy({0:gp(),by:Ia(Cr(ui.buried))})},alpha_helix:{"@desc":"atom's residue is in an alpha helix",map:()=>lm(["alpha"])},pi_helix:{"@desc":"atom's residue is in a pi helix",map:()=>lm(["pi"])},helix_3_10:{"@desc":"atom's residue is in a 3-10 helix",map:()=>lm(["3-10"])},helix:{"@desc":"atom's residue is in an alpha or pi or 3-10 helix",map:()=>lm(["helix"])},extended_beta:{"@desc":"atom's residue is a beta sheet",map:()=>lm(["sheet"])},bridge_beta:{"@desc":"atom's residue is a beta sheet",map:()=>lm(["strand"])},sheet:{"@desc":"atom's residue is a beta sheet",map:()=>lm(["beta"])},turn:{"@desc":"atom's residue is in a turn conformation",map:()=>lm(["turn"])},coil:{"@desc":"atom's residue is in a coil conformation",map:()=>sr.struct.modifier.intersectBy({0:gp(),by:lm(["none"])})}};var is=q,UH={sqr:{"@desc":"square of x","@examples":["sqr(2)"],map:t=>is.core.math.pow([t,2])},sqrt:{"@desc":"square root of x","@examples":["sqrt(2)"],map:t=>is.core.math.sqrt([t])},abs:{"@desc":"absolute value of x","@examples":["abs(2)"],map:t=>is.core.math.abs([t])},floor:{"@desc":"largest integer not greater than x","@examples":["floor(2)"],map:t=>is.core.math.floor([t])},ceil:{"@desc":"smallest integer not less than x","@examples":["ceil(2)"],map:t=>is.core.math.ceil([t])},sin:{"@desc":"sine of x","@examples":["sin(2)"],map:t=>is.core.math.sin([t])},cos:{"@desc":"cosine of x","@examples":["cos(2)"],map:t=>is.core.math.cos([t])},tan:{"@desc":"tangent of x","@examples":["tan(2)"],map:t=>is.core.math.tan([t])},atan:{"@desc":"arctangent of x","@examples":["atan(2)"],map:t=>is.core.math.atan([t])},asin:{"@desc":"arcsin of x","@examples":["asin(2)"],map:t=>is.core.math.asin([t])},acos:{"@desc":"arccos of x","@examples":["acos(2)"],map:t=>is.core.math.acos([t])},sinh:{"@desc":"hyperbolic sine of x","@examples":["sinh(2)"],map:t=>is.core.math.sinh([t])},cosh:{"@desc":"hyperbolic cosine of x","@examples":["cosh(2)"],map:t=>is.core.math.cosh([t])},tanh:{"@desc":"hyperbolic tangent of x","@examples":["tanh(2)"],map:t=>is.core.math.tanh([t])},exp:{"@desc":"e to the power x","@examples":["exp(2)"],map:t=>is.core.math.exp([t])},log:{"@desc":"natural log of x","@examples":["log(2)"],map:t=>is.core.math.log([t])},log10:{"@desc":"log base 10 of x","@examples":["log10(2)"],map:t=>is.core.math.log10([t])}};var oo=q,Dme=[{"@desc":"multiplication, division","@examples":[],name:"mul-div",type:Vi,rule:fe.regexp(/\s*(\*|\/)\s*/,1),map:(t,e,r)=>{switch(t){case"*":return oo.core.math.mult([e,r]);case"/":return oo.core.math.div([e,r]);default:throw new Error(`value operator '${t}' not supported`)}}},{"@desc":"addition, substraction","@examples":[],name:"add-sub",type:Vi,rule:fe.regexp(/\s*(-|\+)\s*/,1),map:(t,e,r)=>{switch(t){case"-":return oo.core.math.sub([e,r]);case"+":return oo.core.math.add([e,r]);default:throw new Error(`value operator '${t}' not supported`)}}},{"@desc":"value comparisons","@examples":[],name:"comparison",type:Vi,rule:fe.alt(fe.regexp(/\s*(=~|==|>=|<=|=|!=|>|<)\s*/,1),fe.whitespace.result("=")),map:(t,e,r)=>{let n;if(e.head!==void 0?(e.head.name==="structure-query.atom-property.macromolecular.secondary-structure-flags"&&(n=oo.core.flags.hasAny([e,p2(r)])),e.head.name==="core.type.regex"&&(n=oo.core.str.match([e,oo.core.type.str([r])]))):r.head!==void 0?(r.head.name==="structure-query.atom-property.macromolecular.secondary-structure-flags"&&(n=oo.core.flags.hasAny([r,p2(e)])),r.head.name==="core.type.regex"&&(n=oo.core.str.match([r,oo.core.type.str([e])]))):t==="=~"&&(e.head?n=oo.core.str.match([oo.core.type.regex([`^${r}$`,"i"]),oo.core.type.str([e])]):n=oo.core.str.match([oo.core.type.regex([`^${e}$`,"i"]),oo.core.type.str([r])])),!n)switch(e.head&&(r=Mg(e,r)),r.head&&(e=Mg(r,e)),t){case"=":case"==":n=oo.core.rel.eq([e,r]);break;case"!=":n=oo.core.rel.neq([e,r]);break;case">":n=oo.core.rel.gr([e,r]);break;case"<":n=oo.core.rel.lt([e,r]);break;case">=":n=oo.core.rel.gre([e,r]);break;case"<=":n=oo.core.rel.lte([e,r]);break;default:throw new Error(`value operator '${t}' not supported`)}return oo.struct.generator.atomGroups({"atom-test":n})}}],Ame=fe.createLanguage({Parens:function(t){return fe.alt(t.Parens,t.Operator,t.Expression).wrap(fe.string("("),fe.string(")"))},Expression:function(t){return fe.alt(t.RangeListProperty,t.ValueQuery,t.Keywords)},NamedAtomProperties:function(){return fe.alt(...u2(hp))},Keywords:()=>fe.alt(...L0(Dk)),ValueRange:function(t){return fe.seq(t.Value.skip(fe.regexp(/\s+TO\s+/i)),t.Value).map(e=>({range:e}))},RangeListProperty:function(t){return fe.seq(fe.alt(...o1(hp,/\s/)).skip(fe.whitespace),fe.alt(t.ValueRange,t.Value).sepBy1(fe.whitespace)).map(e=>{let[r,n]=e,o=[],i=[];n.forEach(c=>{c.range?i.push(oo.core.rel.inRange([r,c.range[0],c.range[1]])):o.push(Mg(r,c,Pk))});let a=IH(i),s=MH(r,o),l;return a&&s?l=oo.core.logic.or([a,s]):l=a||s,oo.struct.generator.atomGroups({[kH(r)]:l})})},Operator:function(t){return Cf(Ek,fe.alt(t.Parens,t.Expression,t.ValueQuery))},Query:function(t){return fe.alt(t.Operator,t.Parens,t.Expression).trim(fe.optWhitespace)},Number:function(){return fe.regexp(/-?(0|[1-9][0-9]*)([.][0-9]+)?([eE][+-]?[0-9]+)?/).map(Number).desc("number")},String:function(){let t=B0(hp,Dk,Ek).sort(Dl).map(Jm).join("|");return fe.alt(fe.regexp(new RegExp(`(?!(${t}))[A-Z0-9_]+`,"i")),fe.regexp(/'((?:[^"\\]|\\.)*)'/,1),fe.regexp(/"((?:[^"\\]|\\.)*)"/,1).map(e=>oo.core.type.regex([`^${e}$`,"i"]))).desc("string")},Value:function(t){return fe.alt(t.Number,t.String)},ValueParens:function(t){return fe.alt(t.ValueParens,t.ValueOperator,t.ValueExpressions).wrap(fe.string("("),fe.string(")"))},ValuePropertyNames:function(){return fe.alt(...o1(hp,/=~|==|>=|<=|=|!=|>|<|\)|\s|\+|-|\*|\//i))},ValueOperator:function(t){return Cf(Dme,fe.alt(t.ValueParens,t.ValueExpressions))},ValueExpressions:function(t){return fe.alt(t.ValueFunctions,t.Value,t.ValuePropertyNames)},ValueFunctions:function(t){return fe.alt(...AH(UH,t.ValueOperator))},ValueQuery:function(t){return fe.alt(t.ValueOperator.map(e=>{if(!e.head.name||!e.head.name.startsWith("structure-query.generator"))throw new Error(`values must be part of an comparison, value '${e}'`);return e}))}}),GH=t=>Ame.Query.tryParse(t);var jH={pymol:NH,vmd:GH,jmol:BH};var kme=jH;function HH(t,e){try{return kme[t](e)}catch(r){throw console.error(r.message),r}}var Ak=class{constructor(){this.map=new Map}removeSymbol(e){this.map.delete(e.symbol.id)}addSymbol(e){this.map.has(e.symbol.id)&&console.warn(`Symbol '${e.symbol.id}' already added. Call removeSymbol/removeCustomProps re-adding the symbol.`),this.map.set(e.symbol.id,e)}addCustomProp(e){if(e.symbols)for(let r of Object.keys(e.symbols))this.addSymbol(e.symbols[r])}removeCustomProp(e){if(e.symbols)for(let r of Object.keys(e.symbols))this.removeSymbol(e.symbols[r])}getRuntime(e){return this.map.get(e)}},N0=new Ak,kk=class{constructor(e){this.table=e,this.constQueryContext=new fa(ue.Empty)}},qH;(function(t){function e(n){return{kind:"const",value:n}}t.Const=e;function r(n){return{kind:"dynamic",runtime:n}}t.Dynamic=r})(qH||(qH={}));var Bg;(function(t){function e(n){return{isConst:!0,fn:function(i){return n}}}t.Const=e;function r(n){return{isConst:!1,fn:n}}t.Dynamic=r})(Bg||(Bg={}));var F0;(function(t){function e(r,n,o,i){if(typeof r.length=="number")for(let a=0,s=r.length;a<s;a++)o(r[a](n),a,i);else{let a=0;for(let s of Object.keys(r))o(r[s](n),a++,i)}return i}t.forEachEval=e})(F0||(F0={}));var Tf;(function(t){function e(n,o){return new f2(n,o,!0)}t.Const=e;function r(n,o){return new f2(n,o,!1)}t.Dynamic=r})(Tf||(Tf={}));var f2=class{compile(e,r){let n,o=!1;if(!r)n=void 0,o=!0;else if(Ja.isArgumentsArray(r)){n=[],o=!0;for(let i of r){let a=Mk(e,i);o=o&&a.isConst,n.push(a.fn)}}else{n=Object.create(null),o=!0;for(let i of Object.keys(r)){let a=Mk(e,r[i]);o=o&&a.isConst,n[i]=a.fn}}return this.isConst?this.isConst&&o?Bg.Const(this.fn(e.constQueryContext,n)):Bg.Dynamic(WH(this.fn,n)):Bg.Dynamic(WH(this.fn,n))}constructor(e,r,n){this.symbol=e,this.fn=r,this.isConst=n}};function WH(t,e){return function(n){return t(n,e)}}function Mk(t,e){if(Ja.isLiteral(e))return Bg.Const(e);if(Ja.isSymbol(e)){let n=t.table.getRuntime(e.name);return n?n.compile(t):Bg.Const(e.name)}if(!Ja.isSymbol(e.head))throw new Error("Can only apply symbols.");let r=t.table.getRuntime(e.head.name);if(!r)throw new Error(`Symbol '${e.head.name}' is not implemented.`);return r.compile(t,e.args)}function hd(t){let e=new kk(N0);return Mk(e,t).fn}var Nt=Tf.Const,bt=Tf.Dynamic,Mme=[Nt(re.core.type.bool,function(e,r){return!!r[0](e)}),Nt(re.core.type.num,function(e,r){return+r[0](e)}),Nt(re.core.type.str,function(e,r){return""+r[0](e)}),Nt(re.core.type.list,function(e,r){return F0.forEachEval(r,e,(n,o,i)=>i[o]=n,[])}),Nt(re.core.type.set,function(e,r){return F0.forEachEval(r,e,function(o,i,a){return a.add(o)},new Set)}),Nt(re.core.type.regex,function(e,r){return new RegExp(r[0](e),r[1]&&r[1](e)||"")}),Nt(re.core.type.bitflags,function(e,r){return+r[0](e)}),Nt(re.core.type.compositeKey,function(e,r){return F0.forEachEval(r,e,(n,o,i)=>i[o]=""+n,[]).join("-")}),Nt(re.core.logic.not,(t,e)=>!e[0](t)),Nt(re.core.logic.and,(t,e)=>{if(typeof e.length=="number"){for(let r=0,n=e.length;r<n;r++)if(!e[r](t))return!1}else for(let r of Object.keys(e))if(!e[r](t))return!1;return!0}),Nt(re.core.logic.or,(t,e)=>{if(typeof e.length=="number"){for(let r=0,n=e.length;r<n;r++)if(e[r](t))return!0}else for(let r of Object.keys(e))if(e[r](t))return!0;return!1}),Nt(re.core.rel.eq,(t,e)=>e[0](t)===e[1](t)),Nt(re.core.rel.neq,(t,e)=>e[0](t)!==e[1](t)),Nt(re.core.rel.lt,(t,e)=>e[0](t)<e[1](t)),Nt(re.core.rel.lte,(t,e)=>e[0](t)<=e[1](t)),Nt(re.core.rel.gr,(t,e)=>e[0](t)>e[1](t)),Nt(re.core.rel.gre,(t,e)=>e[0](t)>=e[1](t)),Nt(re.core.rel.inRange,(t,e)=>{let r=e[0](t);return r>=e[1](t)&&r<=e[2](t)}),Nt(re.core.math.add,(t,e)=>{let r=0;if(typeof e.length=="number")for(let n=0,o=e.length;n<o;n++)r+=e[n](t);else for(let n of Object.keys(e))r+=e[n](t);return r}),Nt(re.core.math.sub,(t,e)=>{let r=0;if(typeof e.length=="number"){if(e.length===1)return-e[0](t);r=e[0](t)||0;for(let n=1,o=e.length;n<o;n++)r-=e[n](t)}else{let n=Object.keys(e);if(n.length===1)return-e[n[0]](t);r=e[n[0]](t)||0;for(let o=1,i=n.length;o<i;o++)r-=e[n[o]](t)}return r}),Nt(re.core.math.mult,(t,e)=>{let r=1;if(typeof e.length=="number")for(let n=0,o=e.length;n<o;n++)r*=e[n](t);else for(let n of Object.keys(e))r*=e[n](t);return r}),Nt(re.core.math.div,(t,e)=>e[0](t)/e[1](t)),Nt(re.core.math.pow,(t,e)=>Math.pow(e[0](t),e[1](t))),Nt(re.core.math.mod,(t,e)=>e[0](t)%e[1](t)),Nt(re.core.math.min,(t,e)=>{let r=Number.POSITIVE_INFINITY;if(typeof e.length=="number")for(let n=0,o=e.length;n<o;n++)r=Math.min(e[n](t),r);else for(let n of Object.keys(e))r=Math.min(e[n](t),r);return r}),Nt(re.core.math.max,(t,e)=>{let r=Number.NEGATIVE_INFINITY;if(typeof e.length=="number")for(let n=0,o=e.length;n<o;n++)r=Math.max(e[n](t),r);else for(let n of Object.keys(e))r=Math.max(e[n](t),r);return r}),Nt(re.core.math.cantorPairing,(t,e)=>rm(e[0](t),e[1](t))),Nt(re.core.math.sortedCantorPairing,(t,e)=>Lx(e[0](t),e[1](t))),Nt(re.core.math.invertCantorPairing,(t,e)=>TT([0,0],e[0](t))),Nt(re.core.math.floor,(t,e)=>Math.floor(e[0](t))),Nt(re.core.math.ceil,(t,e)=>Math.ceil(e[0](t))),Nt(re.core.math.roundInt,(t,e)=>Math.round(e[0](t))),Nt(re.core.math.trunc,(t,e)=>Math.trunc(e[0](t))),Nt(re.core.math.abs,(t,e)=>Math.abs(e[0](t))),Nt(re.core.math.sign,(t,e)=>Math.sign(e[0](t))),Nt(re.core.math.sqrt,(t,e)=>Math.sqrt(e[0](t))),Nt(re.core.math.cbrt,(t,e)=>Math.cbrt(e[0](t))),Nt(re.core.math.sin,(t,e)=>Math.sin(e[0](t))),Nt(re.core.math.cos,(t,e)=>Math.cos(e[0](t))),Nt(re.core.math.tan,(t,e)=>Math.tan(e[0](t))),Nt(re.core.math.asin,(t,e)=>Math.asin(e[0](t))),Nt(re.core.math.acos,(t,e)=>Math.acos(e[0](t))),Nt(re.core.math.atan,(t,e)=>Math.atan(e[0](t))),Nt(re.core.math.sinh,(t,e)=>Math.sinh(e[0](t))),Nt(re.core.math.cosh,(t,e)=>Math.cosh(e[0](t))),Nt(re.core.math.tanh,(t,e)=>Math.tanh(e[0](t))),Nt(re.core.math.exp,(t,e)=>Math.exp(e[0](t))),Nt(re.core.math.log,(t,e)=>Math.log(e[0](t))),Nt(re.core.math.log10,(t,e)=>Math.log10(e[0](t))),Nt(re.core.math.atan2,(t,e)=>Math.atan2(e[0](t),e[1](t))),Nt(re.core.str.match,(t,e)=>e[0](t).test(e[1](t))),Nt(re.core.str.concat,(t,e)=>{let r=[];if(typeof e.length=="number")for(let n=0,o=e.length;n<o;n++)r.push(e[n](t).toString());else for(let n of Object.keys(e))r.push(e[n](t).toString());return r.join("")}),Nt(re.core.list.getAt,(t,e)=>e[0](t)[e[1](t)]),Nt(re.core.list.equal,(t,e)=>v0(e[0](t),e[1](t))),Nt(re.core.set.has,function(e,r){return r[0](e).has(r[1](e))}),Nt(re.core.set.isSubset,function(e,r){return no.isSuperset(r[1](e),r[0](e))}),Nt(re.core.flags.hasAny,(t,e)=>{let r=e[1](t),n=e[0](t);return r?(n&r)!==0:!!n}),Nt(re.core.flags.hasAll,(t,e)=>{let r=e[1](t),n=e[0](t);return r?(n&r)===r:!n}),Nt(re.structureQuery.type.elementSymbol,(t,e)=>Hz(e[0](t))),Nt(re.structureQuery.type.atomName,(t,e)=>Sz(e[0](t))),Nt(re.structureQuery.type.bondFlags,(t,e)=>{let r=0;if(typeof e.length=="number")for(let n=0,o=e.length;n<o;n++)r=XH(r,e[n](t));else for(let n of Object.keys(e))r=XH(r,e[n](t));return r}),Nt(re.structureQuery.type.ringFingerprint,(t,e)=>lU.elementFingerprint(Rme(t,e))),Nt(re.structureQuery.type.secondaryStructureFlags,(t,e)=>{let r=0;if(typeof e.length=="number")for(let n=0,o=e.length;n<o;n++)r=YH(r,e[n](t));else for(let n of Object.keys(e))r=YH(r,e[n](t));return r}),bt(re.structureQuery.filter.pick,(t,e)=>cn.filters.pick(e[0],e.test)(t)),bt(re.structureQuery.filter.first,(t,e)=>cn.filters.first(e[0])(t)),bt(re.structureQuery.filter.withSameAtomProperties,(t,e)=>cn.filters.withSameAtomProperties(e[0],e.source,e.property)(t)),bt(re.structureQuery.filter.intersectedBy,(t,e)=>cn.filters.areIntersectedBy(e[0],e.by)(t)),bt(re.structureQuery.filter.within,(t,e)=>{var r,n,o;return cn.filters.within({query:e[0],target:e.target,minRadius:(r=e["min-radius"])===null||r===void 0?void 0:r.call(e,t),maxRadius:(n=e["max-radius"])===null||n===void 0?void 0:n.call(e,t),elementRadius:e["atom-radius"],invert:(o=e.invert)===null||o===void 0?void 0:o.call(e,t)})(t)}),bt(re.structureQuery.filter.isConnectedTo,(t,e)=>{var r,n;return cn.filters.isConnectedTo({query:e[0],target:e.target,disjunct:(r=e.disjunct)===null||r===void 0?void 0:r.call(e,t),invert:(n=e.invert)===null||n===void 0?void 0:n.call(e,t),bondTest:e["bond-test"]})(t)}),bt(re.structureQuery.generator.atomGroups,function(e,r){return cn.generators.atoms({entityTest:r["entity-test"],chainTest:r["chain-test"],residueTest:r["residue-test"],atomTest:r["atom-test"],groupBy:r["group-by"]})(e)}),bt(re.structureQuery.generator.all,function(e){return cn.generators.all(e)}),bt(re.structureQuery.generator.empty,function(e){return cn.generators.none(e)}),bt(re.structureQuery.generator.bondedAtomicPairs,function(e,r){return cn.generators.bondedAtomicPairs(r&&r[0])(e)}),bt(re.structureQuery.generator.rings,function(e,r){var n,o;return cn.generators.rings((n=r?.fingerprint)===null||n===void 0?void 0:n.call(r,e),(o=r?.["only-aromatic"])===null||o===void 0?void 0:o.call(r,e))(e)}),bt(re.structureQuery.generator.queryInSelection,function(e,r){var n;return cn.generators.querySelection(r[0],r.query,(n=r["in-complement"])===null||n===void 0?void 0:n.call(r,e))(e)}),bt(re.structureQuery.modifier.includeSurroundings,function(e,r){return cn.modifiers.includeSurroundings(r[0],{radius:r.radius(e),wholeResidues:!!(r["as-whole-residues"]&&r["as-whole-residues"](e)),elementRadius:r["atom-radius"]})(e)}),bt(re.structureQuery.modifier.surroundingLigands,function(e,r){return cn.modifiers.surroundingLigands({query:r[0],radius:r.radius(e),includeWater:!!(r["include-water"]&&r["include-water"](e))})(e)}),bt(re.structureQuery.modifier.wholeResidues,function(e,r){return cn.modifiers.wholeResidues(r[0])(e)}),bt(re.structureQuery.modifier.union,function(e,r){return cn.modifiers.union(r[0])(e)}),bt(re.structureQuery.modifier.expandProperty,function(e,r){return cn.modifiers.expandProperty(r[0],r.property)(e)}),bt(re.structureQuery.modifier.exceptBy,function(e,r){return cn.modifiers.exceptBy(r[0],r.by)(e)}),bt(re.structureQuery.modifier.includeConnected,function(e,r){var n,o;return cn.modifiers.includeConnected({query:r[0],bondTest:r["bond-test"],wholeResidues:!!(r["as-whole-residues"]&&r["as-whole-residues"](e)),layerCount:r["layer-count"]&&r["layer-count"](e)||1,fixedPoint:(o=(n=r["fixed-point"])===null||n===void 0?void 0:n.call(r,e))!==null&&o!==void 0?o:!1})(e)}),bt(re.structureQuery.modifier.intersectBy,function(e,r){return cn.modifiers.intersectBy(r[0],r.by)(e)}),bt(re.structureQuery.combinator.merge,(t,e)=>cn.combinators.merge(e)(t)),bt(re.structureQuery.atomProperty.core.elementSymbol,gn(Ne.atom.type_symbol)),bt(re.structureQuery.atomProperty.core.vdw,(t,e)=>ff(Ne.atom.type_symbol(e&&e[0]&&e[0](t)||t.element))),bt(re.structureQuery.atomProperty.core.mass,(t,e)=>SU(Ne.atom.type_symbol(e&&e[0]&&e[0](t)||t.element))),bt(re.structureQuery.atomProperty.core.atomicNumber,(t,e)=>P0(Ne.atom.type_symbol(e&&e[0]&&e[0](t)||t.element))),bt(re.structureQuery.atomProperty.core.x,gn(Ne.atom.x)),bt(re.structureQuery.atomProperty.core.y,gn(Ne.atom.y)),bt(re.structureQuery.atomProperty.core.z,gn(Ne.atom.z)),bt(re.structureQuery.atomProperty.core.sourceIndex,gn(Ne.atom.sourceIndex)),bt(re.structureQuery.atomProperty.core.operatorName,gn(Ne.unit.operator_name)),bt(re.structureQuery.atomProperty.core.operatorKey,gn(Ne.unit.operator_key)),bt(re.structureQuery.atomProperty.core.modelIndex,gn(Ne.unit.model_index)),bt(re.structureQuery.atomProperty.core.modelLabel,gn(Ne.unit.model_label)),bt(re.structureQuery.atomProperty.core.atomKey,(t,e)=>{let r=e&&e[0]&&e[0](t)||t.element;return rm(r.unit.id,r.element)}),bt(re.structureQuery.atomProperty.macromolecular.residueKey,(t,e)=>z.residueIndex(e&&e[0]&&e[0](t)||t.element)),bt(re.structureQuery.atomProperty.macromolecular.chainKey,(t,e)=>z.chainIndex(e&&e[0]&&e[0](t)||t.element)),bt(re.structureQuery.atomProperty.macromolecular.entityKey,(t,e)=>z.entityIndex(e&&e[0]&&e[0](t)||t.element)),bt(re.structureQuery.atomProperty.macromolecular.id,gn(Ne.atom.id)),bt(re.structureQuery.atomProperty.macromolecular.isHet,(t,e)=>Ne.residue.group_PDB(e&&e[0]&&e[0](t)||t.element)!=="ATOM"),bt(re.structureQuery.atomProperty.macromolecular.label_atom_id,gn(Ne.atom.label_atom_id)),bt(re.structureQuery.atomProperty.macromolecular.label_alt_id,gn(Ne.atom.label_alt_id)),bt(re.structureQuery.atomProperty.macromolecular.label_comp_id,gn(Ne.atom.label_comp_id)),bt(re.structureQuery.atomProperty.macromolecular.label_seq_id,gn(Ne.residue.label_seq_id)),bt(re.structureQuery.atomProperty.macromolecular.label_asym_id,gn(Ne.chain.label_asym_id)),bt(re.structureQuery.atomProperty.macromolecular.label_entity_id,gn(Ne.entity.id)),bt(re.structureQuery.atomProperty.macromolecular.auth_atom_id,gn(Ne.atom.auth_atom_id)),bt(re.structureQuery.atomProperty.macromolecular.auth_comp_id,gn(Ne.atom.auth_comp_id)),bt(re.structureQuery.atomProperty.macromolecular.auth_seq_id,gn(Ne.residue.auth_seq_id)),bt(re.structureQuery.atomProperty.macromolecular.auth_asym_id,gn(Ne.chain.auth_asym_id)),bt(re.structureQuery.atomProperty.macromolecular.pdbx_PDB_ins_code,gn(Ne.residue.pdbx_PDB_ins_code)),bt(re.structureQuery.atomProperty.macromolecular.pdbx_formal_charge,gn(Ne.atom.pdbx_formal_charge)),bt(re.structureQuery.atomProperty.macromolecular.occupancy,gn(Ne.atom.occupancy)),bt(re.structureQuery.atomProperty.macromolecular.B_iso_or_equiv,gn(Ne.atom.B_iso_or_equiv)),bt(re.structureQuery.atomProperty.macromolecular.entityType,gn(Ne.entity.type)),bt(re.structureQuery.atomProperty.macromolecular.entitySubtype,gn(Ne.entity.subtype)),bt(re.structureQuery.atomProperty.macromolecular.entityPrdId,gn(Ne.entity.prd_id)),bt(re.structureQuery.atomProperty.macromolecular.entityDescription,gn(Ne.entity.pdbx_description)),bt(re.structureQuery.atomProperty.macromolecular.objectPrimitive,gn(Ne.unit.object_primitive)),bt(re.structureQuery.atomProperty.macromolecular.isNonStandard,gn(Ne.residue.isNonStandard)),bt(re.structureQuery.atomProperty.macromolecular.secondaryStructureKey,gn(Ne.residue.secondary_structure_key)),bt(re.structureQuery.atomProperty.macromolecular.secondaryStructureFlags,gn(Ne.residue.secondary_structure_type)),bt(re.structureQuery.atomProperty.macromolecular.chemCompType,gn(Ne.residue.chem_comp_type)),bt(re.structureQuery.atomSet.atomCount,function(e,r){return cn.atomset.atomCount(e)}),bt(re.structureQuery.atomSet.countQuery,function(e,r){return cn.atomset.countQuery(r[0])(e)}),bt(re.structureQuery.atomSet.propertySet,function(e,r){return cn.atomset.propertySet(r[0])(e)}),bt(re.structureQuery.bondProperty.order,(t,e)=>t.atomicBond.order),bt(re.structureQuery.bondProperty.flags,(t,e)=>t.atomicBond.type),bt(re.structureQuery.bondProperty.key,(t,e)=>t.atomicBond.key),bt(re.structureQuery.bondProperty.atomA,(t,e)=>t.atomicBond.a),bt(re.structureQuery.bondProperty.atomB,(t,e)=>t.atomicBond.b),bt(re.structureQuery.bondProperty.length,(t,e)=>t.atomicBond.length),bt(re.internal.generator.bundleElement,function(e,r){return hU(r.groupedUnits(e),r.ranges(e),r.set(e))}),bt(re.internal.generator.bundle,function(e,r){return gU(r.elements(e))(e)}),bt(re.internal.generator.current,function(e,r){return e.tryGetCurrentSelection()})];function gn(t){return(e,r)=>t(r&&r[0]&&r[0](e)||e.element)}function XH(t,e){return t|(Pr.isName(e)?Pr.fromName(e):0)}function YH(t,e){switch(e.toLowerCase()){case"helix":return t|2;case"alpha":return t|2|4096;case"pi":return t|2|32768;case"310":return t|2|2048;case"beta":return t|4;case"strand":return t|4|4194304;case"sheet":return t|4|8388608;case"turn":return t|16;case"bend":return t|8;case"coil":return t|536870912;default:return t}}function Rme(t,e){let r=[];if(!e)return r;if(typeof e.length=="number")for(let n=0,o=e.length;n<o;n++)r.push(e[n](t));else{let n=Object.keys(e);for(let o=1,i=n.length;o<i;o++)r.push(e[n[o]](t))}return r}(function(){for(let t of Mme)N0.addSymbol(t)})();function Jr(t,e){return{expression:t,language:e}}(function(t){t.Info={"mol-script":"Mol-Script",pymol:"PyMOL",vmd:"VMD",jmol:"Jmol"};function e(s){return!!s&&typeof s.expression=="string"&&!!s.language}t.is=e;function r(s,l){return s.language===l.language&&s.expression===l.expression}t.areEqual=r;function n(s){switch(s.language){case"mol-script":let l=PH(s.expression);if(l.length===0)throw new Error("No query");return wH(l[0]);case"pymol":case"jmol":case"vmd":return HH(s.language,s.expression);default:ur(s.language)}}t.toExpression=n;function o(s){let l=n(s);return hd(l)}t.toQuery=o;function i(s,l){let u=o(s)(new fa(l));return hn.toLociWithSourceUnits(u)}t.toLoci=i;function a(s,l,c){let u=typeof s=="function"?s(q):s;return hd(u)(new fa(l,c))}t.getStructureSelection=a})(Jr||(Jr={}));function io(t,e){return{kind:t,layers:e}}(function(t){t.Empty={kind:"empty-loci",layers:[]};function e(c,u){if(c.layers.length===0&&u.layers.length===0)return!0;if(c.layers.length!==u.layers.length)return!1;for(let d=0,m=c.layers.length;d<m;++d)if(c.layers[d].clear!==u.layers[d].clear||c.layers[d].color!==u.layers[d].color||!st.areEqual(c.layers[d].loci,u.layers[d].loci))return!1;return!0}t.areEqual=e;function r(c){return c.layers.length===0}t.isEmpty=r;function n(c,u){if(c.kind==="element-loci"){let d=[];for(let m of c.layers){let{loci:p,color:h,clear:f}=m;p=z.Loci.remap(p,u),z.Loci.isEmpty(p)||d.push({loci:p,color:h,clear:f})}return{kind:"element-loci",layers:d}}else return c}t.remap=n;function o(c){if(r(c))return c;if(c.kind==="element-loci"){let{structure:u}=c.layers[0].loci,d=new Map,m=z.Loci.none(u);for(let h=0,f=c.layers.length;h<f;++h){let{loci:b,color:v,clear:x}=c.layers[f-h-1];if(b=z.Loci.subtract(b,m),m=z.Loci.union(b,m),!z.Loci.isEmpty(b)){let S=x?-1:v;d.has(S)&&(b=z.Loci.union(b,d.get(S))),d.set(S,b)}}let p=[];return d.forEach((h,f)=>{let b=f===-1,v=b?ce(0):f;p.push({loci:h,color:v,clear:b})}),{kind:"element-loci",layers:p}}else return c}t.merge=o;function i(c,u){if(r(c))return c;if(c.kind==="element-loci"){let{structure:d}=c.layers[0].loci,m=[];for(let p of c.layers){let{loci:h,color:f,clear:b}=p,v=z.Loci.remap(h,u);h=z.Loci.remap(v,d),z.Loci.isEmpty(h)||m.push({loci:h,color:f,clear:b})}return{kind:"element-loci",layers:m}}else return c}t.filter=i;function a(c,u){let d=[];for(let m=0,p=c.length;m<p;++m){let{script:h,color:f,clear:b}=c[m],v=Jr.toLoci(h,u);z.Loci.isEmpty(v)||d.push({loci:v,color:f,clear:b})}return{kind:"element-loci",layers:d}}t.ofScript=a;function s(c,u){let d=[];for(let m=0,p=c.length;m<p;++m){let{bundle:h,color:f,clear:b}=c[m],v=z.Bundle.toLoci(h,u.root);d.push({loci:v,color:f,clear:b})}return{kind:"element-loci",layers:d}}t.ofBundle=s;function l(c){let u=[];for(let d=0,m=c.layers.length;d<m;++d){let{loci:p,color:h,clear:f}=c.layers[d],b=z.Bundle.fromLoci(p);u.push({bundle:b,color:h,clear:f})}return{kind:"element-loci",layers:u}}t.toBundle=l})(io||(io={}));var Rr;(function(t){function e(){return o=>r(o)}t.factory=e;function r(o){var i;return i=class{static is(s){return!!s&&o===s.type}constructor(s,l){this.data=s,this.id=vo.create22(),this.type=o,this.label=l&&l.label||o.name,this.description=l&&l.description}},i.type=o,i}t.create=r;function n(o,i){if(!o.tags)return!1;for(let a of o.tags)if(a===i)return!0;return!1}t.hasTag=n,t.Null={id:vo.create22(),type:{name:"Null",typeClass:"Null"},data:void 0,label:"Null"}})(Rr||(Rr={}));var V0;(function(t){function e(n){let o=n;return!!o&&!!o.transform&&!!o.parent&&!!o.status}t.is=e;function r(n,o){let i=typeof o=="string"?o:t.is(o)?o.transform.ref:o.ref;return n.cells.get(i)}t.resolve=r})(V0||(V0={}));var z0=class{get cell(){var e;return(e=this.state)===null||e===void 0?void 0:e.cells.get(this.ref)}get obj(){var e,r;return(r=(e=this.state)===null||e===void 0?void 0:e.cells.get(this.ref))===null||r===void 0?void 0:r.obj}get data(){var e;return(e=this.obj)===null||e===void 0?void 0:e.data}update(e,r){if(!this.state)throw new Error("To use update() from StateObjectSelector, 'state' must be defined.");return r||(r=this.state.build()),(r||this.state.build()).to(this).update(e),r}checkValid(){if(!this.state)throw new Error("Unassigned State.");let e=this.cell;if(!e)throw new Error("Not created at all. Did you await/then the corresponding state update?");if(e.status==="ok")return!0;throw e.status==="error"?new Error(e.errorText):e.obj===Rr.Null?new Error("The object is Null."):new Error("Unresolved. Did you await/then the corresponding state update?")}get isOk(){let e=this.cell;return e&&e.status==="ok"&&e.obj!==Rr.Null}constructor(e,r){this.ref=e,this.state=r}},Fn;(function(t){function e(o){var i;if(o)return typeof o=="string"?o:V0.is(o)?o.transform.ref:(i=o.cell)===null||i===void 0?void 0:i.transform.ref}t.resolveRef=e;function r(o,i){if(i)return V0.is(i)?i:typeof i=="string"?o.cells.get(i):i.cell}t.resolve=r;function n(o,i){let a=r(o,i);if(!(!a||!a.obj||a.status!=="ok"))return a}t.resolveAndCheck=n})(Fn||(Fn={}));var b1="delete",Co=5,iu=1<<Co,ol=iu-1,on={};function Vk(){return{value:!1}}function au(t){t&&(t.value=!0)}function Yk(){}function U0(t){return t.size===void 0&&(t.size=t.__iterate(x6)),t.size}function Pf(t,e){if(typeof e!="number"){var r=e>>>0;if(""+r!==e||r===4294967295)return NaN;e=r}return e<0?U0(t)+e:e}function x6(){return!0}function C2(t,e,r){return(t===0&&!C6(t)||r!==void 0&&t<=-r)&&(e===void 0||r!==void 0&&e>=r)}function x1(t,e){return S6(t,e,0)}function T2(t,e){return S6(t,e,e)}function S6(t,e,r){return t===void 0?r:C6(t)?e===1/0?e:Math.max(0,e+t)|0:e===void 0||e===t?t:Math.min(e,t)|0}function C6(t){return t<0||t===0&&1/t===-1/0}var T6="@@__IMMUTABLE_ITERABLE__@@";function Ml(t){return!!(t&&t[T6])}var w6="@@__IMMUTABLE_KEYED__@@";function No(t){return!!(t&&t[w6])}var _6="@@__IMMUTABLE_INDEXED__@@";function kl(t){return!!(t&&t[_6])}function w2(t){return No(t)||kl(t)}var xi=function(e){return Ml(e)?e:hc(e)},lu=function(t){function e(r){return No(r)?r:If(r)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e}(xi),Ng=function(t){function e(r){return kl(r)?r:bd(r)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e}(xi),Y0=function(t){function e(r){return Ml(r)&&!w2(r)?r:Z0(r)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e}(xi);xi.Keyed=lu;xi.Indexed=Ng;xi.Set=Y0;var P6="@@__IMMUTABLE_SEQ__@@";function Qk(t){return!!(t&&t[P6])}var E6="@@__IMMUTABLE_RECORD__@@";function Q0(t){return!!(t&&t[E6])}function um(t){return Ml(t)||Q0(t)}var K0="@@__IMMUTABLE_ORDERED__@@";function yd(t){return!!(t&&t[K0])}var S1=0,vd=1,su=2,zk=typeof Symbol=="function"&&Symbol.iterator,I6="@@iterator",_2=zk||I6,In=function(e){this.next=e};In.prototype.toString=function(){return"[Iterator]"};In.KEYS=S1;In.VALUES=vd;In.ENTRIES=su;In.prototype.inspect=In.prototype.toSource=function(){return this.toString()};In.prototype[_2]=function(){return this};function Vo(t,e,r,n){var o=t===0?e:t===1?r:[e,r];return n?n.value=o:n={value:o,done:!1},n}function Rl(){return{value:void 0,done:!0}}function D6(t){return Array.isArray(t)?!0:!!P2(t)}function QH(t){return t&&typeof t.next=="function"}function Uk(t){var e=P2(t);return e&&e.call(t)}function P2(t){var e=t&&(zk&&t[zk]||t[I6]);if(typeof e=="function")return e}function Lme(t){var e=P2(t);return e&&e===t.entries}function Bme(t){var e=P2(t);return e&&e===t.keys}var $0=Object.prototype.hasOwnProperty;function A6(t){return Array.isArray(t)||typeof t=="string"?!0:t&&typeof t=="object"&&Number.isInteger(t.length)&&t.length>=0&&(t.length===0?Object.keys(t).length===1:t.hasOwnProperty(t.length-1))}var hc=function(t){function e(r){return r==null?$k():um(r)?r.toSeq():Fme(r)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.toSeq=function(){return this},e.prototype.toString=function(){return this.__toString("Seq {","}")},e.prototype.cacheResult=function(){return!this._cache&&this.__iterateUncached&&(this._cache=this.entrySeq().toArray(),this.size=this._cache.length),this},e.prototype.__iterate=function(n,o){var i=this._cache;if(i){for(var a=i.length,s=0;s!==a;){var l=i[o?a-++s:s++];if(n(l[1],l[0],this)===!1)break}return s}return this.__iterateUncached(n,o)},e.prototype.__iterator=function(n,o){var i=this._cache;if(i){var a=i.length,s=0;return new In(function(){if(s===a)return Rl();var l=i[o?a-++s:s++];return Vo(n,l[0],l[1])})}return this.__iteratorUncached(n,o)},e}(xi),If=function(t){function e(r){return r==null?$k().toKeyedSeq():Ml(r)?No(r)?r.toSeq():r.fromEntrySeq():Q0(r)?r.toSeq():Zk(r)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.toKeyedSeq=function(){return this},e}(hc),bd=function(t){function e(r){return r==null?$k():Ml(r)?No(r)?r.entrySeq():r.toIndexedSeq():Q0(r)?r.toSeq().entrySeq():k6(r)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.of=function(){return e(arguments)},e.prototype.toIndexedSeq=function(){return this},e.prototype.toString=function(){return this.__toString("Seq [","]")},e}(hc),Z0=function(t){function e(r){return(Ml(r)&&!w2(r)?r:bd(r)).toSetSeq()}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.of=function(){return e(arguments)},e.prototype.toSetSeq=function(){return this},e}(hc);hc.isSeq=Qk;hc.Keyed=If;hc.Set=Z0;hc.Indexed=bd;hc.prototype[P6]=!0;var Fg=function(t){function e(r){this._array=r,this.size=r.length}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.get=function(n,o){return this.has(n)?this._array[Pf(this,n)]:o},e.prototype.__iterate=function(n,o){for(var i=this._array,a=i.length,s=0;s!==a;){var l=o?a-++s:s++;if(n(i[l],l,this)===!1)break}return s},e.prototype.__iterator=function(n,o){var i=this._array,a=i.length,s=0;return new In(function(){if(s===a)return Rl();var l=o?a-++s:s++;return Vo(n,l,i[l])})},e}(bd),Kk=function(t){function e(r){var n=Object.keys(r).concat(Object.getOwnPropertySymbols?Object.getOwnPropertySymbols(r):[]);this._object=r,this._keys=n,this.size=n.length}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.get=function(n,o){return o!==void 0&&!this.has(n)?o:this._object[n]},e.prototype.has=function(n){return $0.call(this._object,n)},e.prototype.__iterate=function(n,o){for(var i=this._object,a=this._keys,s=a.length,l=0;l!==s;){var c=a[o?s-++l:l++];if(n(i[c],c,this)===!1)break}return l},e.prototype.__iterator=function(n,o){var i=this._object,a=this._keys,s=a.length,l=0;return new In(function(){if(l===s)return Rl();var c=a[o?s-++l:l++];return Vo(n,c,i[c])})},e}(If);Kk.prototype[K0]=!0;var Ome=function(t){function e(r){this._collection=r,this.size=r.length||r.size}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.__iterateUncached=function(n,o){if(o)return this.cacheResult().__iterate(n,o);var i=this._collection,a=Uk(i),s=0;if(QH(a))for(var l;!(l=a.next()).done&&n(l.value,s++,this)!==!1;);return s},e.prototype.__iteratorUncached=function(n,o){if(o)return this.cacheResult().__iterator(n,o);var i=this._collection,a=Uk(i);if(!QH(a))return new In(Rl);var s=0;return new In(function(){var l=a.next();return l.done?l:Vo(n,s++,l.value)})},e}(bd),KH;function $k(){return KH||(KH=new Fg([]))}function Zk(t){var e=Jk(t);if(e)return e.fromEntrySeq();if(typeof t=="object")return new Kk(t);throw new TypeError("Expected Array or collection object of [k, v] entries, or keyed object: "+t)}function k6(t){var e=Jk(t);if(e)return e;throw new TypeError("Expected Array or collection object of values: "+t)}function Fme(t){var e=Jk(t);if(e)return Lme(t)?e.fromEntrySeq():Bme(t)?e.toSetSeq():e;if(typeof t=="object")return new Kk(t);throw new TypeError("Expected Array or collection object of values, or keyed object: "+t)}function Jk(t){return A6(t)?new Fg(t):D6(t)?new Ome(t):void 0}var M6="@@__IMMUTABLE_MAP__@@";function eM(t){return!!(t&&t[M6])}function R6(t){return eM(t)&&yd(t)}function $H(t){return!!(t&&typeof t.equals=="function"&&typeof t.hashCode=="function")}function fc(t,e){if(t===e||t!==t&&e!==e)return!0;if(!t||!e)return!1;if(typeof t.valueOf=="function"&&typeof e.valueOf=="function"){if(t=t.valueOf(),e=e.valueOf(),t===e||t!==t&&e!==e)return!0;if(!t||!e)return!1}return!!($H(t)&&$H(e)&&t.equals(e))}var c1=typeof Math.imul=="function"&&Math.imul(4294967295,2)===-2?Math.imul:function(e,r){e|=0,r|=0;var n=e&65535,o=r&65535;return n*o+((e>>>16)*o+n*(r>>>16)<<16>>>0)|0};function E2(t){return t>>>1&1073741824|t&3221225471}var Nme=Object.prototype.valueOf;function mc(t){if(t==null)return ZH(t);if(typeof t.hashCode=="function")return E2(t.hashCode(t));var e=Hme(t);if(e==null)return ZH(e);switch(typeof e){case"boolean":return e?1108378657:1108378656;case"number":return Vme(e);case"string":return e.length>qme?zme(e):Gk(e);case"object":case"function":return Gme(e);case"symbol":return Ume(e);default:if(typeof e.toString=="function")return Gk(e.toString());throw new Error("Value type "+typeof e+" cannot be hashed.")}}function ZH(t){return t===null?1108378658:1108378659}function Vme(t){if(t!==t||t===1/0)return 0;var e=t|0;for(e!==t&&(e^=t*4294967295);t>4294967295;)t/=4294967295,e^=t;return E2(e)}function zme(t){var e=Bk[t];return e===void 0&&(e=Gk(t),Lk===Wme&&(Lk=0,Bk={}),Lk++,Bk[t]=e),e}function Gk(t){for(var e=0,r=0;r<t.length;r++)e=31*e+t.charCodeAt(r)|0;return E2(e)}function Ume(t){var e=t6[t];return e!==void 0||(e=L6(),t6[t]=e),e}function Gme(t){var e;if(jk&&(e=Hk.get(t),e!==void 0)||(e=t[Og],e!==void 0)||!e6&&(e=t.propertyIsEnumerable&&t.propertyIsEnumerable[Og],e!==void 0||(e=jme(t),e!==void 0)))return e;if(e=L6(),jk)Hk.set(t,e);else{if(JH!==void 0&&JH(t)===!1)throw new Error("Non-extensible objects are not allowed as keys.");if(e6)Object.defineProperty(t,Og,{enumerable:!1,configurable:!1,writable:!1,value:e});else if(t.propertyIsEnumerable!==void 0&&t.propertyIsEnumerable===t.constructor.prototype.propertyIsEnumerable)t.propertyIsEnumerable=function(){return this.constructor.prototype.propertyIsEnumerable.apply(this,arguments)},t.propertyIsEnumerable[Og]=e;else if(t.nodeType!==void 0)t[Og]=e;else throw new Error("Unable to set a non-enumerable property on object.")}return e}var JH=Object.isExtensible,e6=function(){try{return Object.defineProperty({},"@",{}),!0}catch{return!1}}();function jme(t){if(t&&t.nodeType>0)switch(t.nodeType){case 1:return t.uniqueID;case 9:return t.documentElement&&t.documentElement.uniqueID}}function Hme(t){return t.valueOf!==Nme&&typeof t.valueOf=="function"?t.valueOf(t):t}function L6(){var t=++Rk;return Rk&1073741824&&(Rk=0),t}var jk=typeof WeakMap=="function",Hk;jk&&(Hk=new WeakMap);var t6=Object.create(null),Rk=0,Og="__immutablehash__";typeof Symbol=="function"&&(Og=Symbol(Og));var qme=16,Wme=255,Lk=0,Bk={},I2=function(t){function e(r,n){this._iter=r,this._useKeys=n,this.size=r.size}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.get=function(n,o){return this._iter.get(n,o)},e.prototype.has=function(n){return this._iter.has(n)},e.prototype.valueSeq=function(){return this._iter.valueSeq()},e.prototype.reverse=function(){var n=this,o=tM(this,!0);return this._useKeys||(o.valueSeq=function(){return n._iter.toSeq().reverse()}),o},e.prototype.map=function(n,o){var i=this,a=V6(this,n,o);return this._useKeys||(a.valueSeq=function(){return i._iter.toSeq().map(n,o)}),a},e.prototype.__iterate=function(n,o){var i=this;return this._iter.__iterate(function(a,s){return n(a,s,i)},o)},e.prototype.__iterator=function(n,o){return this._iter.__iterator(n,o)},e}(If);I2.prototype[K0]=!0;var B6=function(t){function e(r){this._iter=r,this.size=r.size}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.includes=function(n){return this._iter.includes(n)},e.prototype.__iterate=function(n,o){var i=this,a=0;return o&&U0(this),this._iter.__iterate(function(s){return n(s,o?i.size-++a:a++,i)},o)},e.prototype.__iterator=function(n,o){var i=this,a=this._iter.__iterator(vd,o),s=0;return o&&U0(this),new In(function(){var l=a.next();return l.done?l:Vo(n,o?i.size-++s:s++,l.value,l)})},e}(bd),O6=function(t){function e(r){this._iter=r,this.size=r.size}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.has=function(n){return this._iter.includes(n)},e.prototype.__iterate=function(n,o){var i=this;return this._iter.__iterate(function(a){return n(a,a,i)},o)},e.prototype.__iterator=function(n,o){var i=this._iter.__iterator(vd,o);return new In(function(){var a=i.next();return a.done?a:Vo(n,a.value,a.value,a)})},e}(Z0),F6=function(t){function e(r){this._iter=r,this.size=r.size}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.entrySeq=function(){return this._iter.toSeq()},e.prototype.__iterate=function(n,o){var i=this;return this._iter.__iterate(function(a){if(a){n6(a);var s=Ml(a);return n(s?a.get(1):a[1],s?a.get(0):a[0],i)}},o)},e.prototype.__iterator=function(n,o){var i=this._iter.__iterator(vd,o);return new In(function(){for(;;){var a=i.next();if(a.done)return a;var s=a.value;if(s){n6(s);var l=Ml(s);return Vo(n,l?s.get(0):s[0],l?s.get(1):s[1],a)}}})},e}(If);B6.prototype.cacheResult=I2.prototype.cacheResult=O6.prototype.cacheResult=F6.prototype.cacheResult=oM;function N6(t){var e=dm(t);return e._iter=t,e.size=t.size,e.flip=function(){return t},e.reverse=function(){var r=t.reverse.apply(this);return r.flip=function(){return t.reverse()},r},e.has=function(r){return t.includes(r)},e.includes=function(r){return t.has(r)},e.cacheResult=oM,e.__iterateUncached=function(r,n){var o=this;return t.__iterate(function(i,a){return r(a,i,o)!==!1},n)},e.__iteratorUncached=function(r,n){if(r===su){var o=t.__iterator(r,n);return new In(function(){var i=o.next();if(!i.done){var a=i.value[0];i.value[0]=i.value[1],i.value[1]=a}return i})}return t.__iterator(r===vd?S1:vd,n)},e}function V6(t,e,r){var n=dm(t);return n.size=t.size,n.has=function(o){return t.has(o)},n.get=function(o,i){var a=t.get(o,on);return a===on?i:e.call(r,a,o,t)},n.__iterateUncached=function(o,i){var a=this;return t.__iterate(function(s,l,c){return o(e.call(r,s,l,c),l,a)!==!1},i)},n.__iteratorUncached=function(o,i){var a=t.__iterator(su,i);return new In(function(){var s=a.next();if(s.done)return s;var l=s.value,c=l[0];return Vo(o,c,e.call(r,l[1],c,t),s)})},n}function tM(t,e){var r=this,n=dm(t);return n._iter=t,n.size=t.size,n.reverse=function(){return t},t.flip&&(n.flip=function(){var o=N6(t);return o.reverse=function(){return t.flip()},o}),n.get=function(o,i){return t.get(e?o:-1-o,i)},n.has=function(o){return t.has(e?o:-1-o)},n.includes=function(o){return t.includes(o)},n.cacheResult=oM,n.__iterate=function(o,i){var a=this,s=0;return i&&U0(t),t.__iterate(function(l,c){return o(l,e?c:i?a.size-++s:s++,a)},!i)},n.__iterator=function(o,i){var a=0;i&&U0(t);var s=t.__iterator(su,!i);return new In(function(){var l=s.next();if(l.done)return l;var c=l.value;return Vo(o,e?c[0]:i?r.size-++a:a++,c[1],l)})},n}function z6(t,e,r,n){var o=dm(t);return n&&(o.has=function(i){var a=t.get(i,on);return a!==on&&!!e.call(r,a,i,t)},o.get=function(i,a){var s=t.get(i,on);return s!==on&&e.call(r,s,i,t)?s:a}),o.__iterateUncached=function(i,a){var s=this,l=0;return t.__iterate(function(c,u,d){if(e.call(r,c,u,d))return l++,i(c,n?u:l-1,s)},a),l},o.__iteratorUncached=function(i,a){var s=t.__iterator(su,a),l=0;return new In(function(){for(;;){var c=s.next();if(c.done)return c;var u=c.value,d=u[0],m=u[1];if(e.call(r,m,d,t))return Vo(i,n?d:l++,m,c)}})},o}function Xme(t,e,r){var n=yc().asMutable();return t.__iterate(function(o,i){n.update(e.call(r,o,i,t),0,function(a){return a+1})}),n.asImmutable()}function Yme(t,e,r){var n=No(t),o=(yd(t)?Ui():yc()).asMutable();t.__iterate(function(a,s){o.update(e.call(r,a,s,t),function(l){return l=l||[],l.push(n?[s,a]:a),l})});var i=nM(t);return o.map(function(a){return ao(t,i(a))}).asImmutable()}function Qme(t,e,r){var n=No(t),o=[[],[]];t.__iterate(function(a,s){o[e.call(r,a,s,t)?1:0].push(n?[s,a]:a)});var i=nM(t);return o.map(function(a){return ao(t,i(a))})}function rM(t,e,r,n){var o=t.size;if(C2(e,r,o))return t;var i=x1(e,o),a=T2(r,o);if(i!==i||a!==a)return rM(t.toSeq().cacheResult(),e,r,n);var s=a-i,l;s===s&&(l=s<0?0:s);var c=dm(t);return c.size=l===0?l:t.size&&l||void 0,!n&&Qk(t)&&l>=0&&(c.get=function(u,d){return u=Pf(this,u),u>=0&&u<l?t.get(u+i,d):d}),c.__iterateUncached=function(u,d){var m=this;if(l===0)return 0;if(d)return this.cacheResult().__iterate(u,d);var p=0,h=!0,f=0;return t.__iterate(function(b,v){if(!(h&&(h=p++<i)))return f++,u(b,n?v:f-1,m)!==!1&&f!==l}),f},c.__iteratorUncached=function(u,d){if(l!==0&&d)return this.cacheResult().__iterator(u,d);if(l===0)return new In(Rl);var m=t.__iterator(u,d),p=0,h=0;return new In(function(){for(;p++<i;)m.next();if(++h>l)return Rl();var f=m.next();return n||u===vd||f.done?f:u===S1?Vo(u,h-1,void 0,f):Vo(u,h-1,f.value[1],f)})},c}function Kme(t,e,r){var n=dm(t);return n.__iterateUncached=function(o,i){var a=this;if(i)return this.cacheResult().__iterate(o,i);var s=0;return t.__iterate(function(l,c,u){return e.call(r,l,c,u)&&++s&&o(l,c,a)}),s},n.__iteratorUncached=function(o,i){var a=this;if(i)return this.cacheResult().__iterator(o,i);var s=t.__iterator(su,i),l=!0;return new In(function(){if(!l)return Rl();var c=s.next();if(c.done)return c;var u=c.value,d=u[0],m=u[1];return e.call(r,m,d,a)?o===su?c:Vo(o,d,m,c):(l=!1,Rl())})},n}function U6(t,e,r,n){var o=dm(t);return o.__iterateUncached=function(i,a){var s=this;if(a)return this.cacheResult().__iterate(i,a);var l=!0,c=0;return t.__iterate(function(u,d,m){if(!(l&&(l=e.call(r,u,d,m))))return c++,i(u,n?d:c-1,s)}),c},o.__iteratorUncached=function(i,a){var s=this;if(a)return this.cacheResult().__iterator(i,a);var l=t.__iterator(su,a),c=!0,u=0;return new In(function(){var d,m,p;do{if(d=l.next(),d.done)return n||i===vd?d:i===S1?Vo(i,u++,void 0,d):Vo(i,u++,d.value[1],d);var h=d.value;m=h[0],p=h[1],c&&(c=e.call(r,p,m,s))}while(c);return i===su?d:Vo(i,m,p,d)})},o}function $me(t,e){var r=No(t),n=[t].concat(e).map(function(a){return Ml(a)?r&&(a=lu(a)):a=r?Zk(a):k6(Array.isArray(a)?a:[a]),a}).filter(function(a){return a.size!==0});if(n.length===0)return t;if(n.length===1){var o=n[0];if(o===t||r&&No(o)||kl(t)&&kl(o))return o}var i=new Fg(n);return r?i=i.toKeyedSeq():kl(t)||(i=i.toSetSeq()),i=i.flatten(!0),i.size=n.reduce(function(a,s){if(a!==void 0){var l=s.size;if(l!==void 0)return a+l}},0),i}function G6(t,e,r){var n=dm(t);return n.__iterateUncached=function(o,i){if(i)return this.cacheResult().__iterate(o,i);var a=0,s=!1;function l(c,u){c.__iterate(function(d,m){return(!e||u<e)&&Ml(d)?l(d,u+1):(a++,o(d,r?m:a-1,n)===!1&&(s=!0)),!s},i)}return l(t,0),a},n.__iteratorUncached=function(o,i){if(i)return this.cacheResult().__iterator(o,i);var a=t.__iterator(o,i),s=[],l=0;return new In(function(){for(;a;){var c=a.next();if(c.done!==!1){a=s.pop();continue}var u=c.value;if(o===su&&(u=u[1]),(!e||s.length<e)&&Ml(u))s.push(a),a=u.__iterator(o,i);else return r?c:Vo(o,l++,u,c)}return Rl()})},n}function Zme(t,e,r){var n=nM(t);return t.toSeq().map(function(o,i){return n(e.call(r,o,i,t))}).flatten(!0)}function Jme(t,e){var r=dm(t);return r.size=t.size&&t.size*2-1,r.__iterateUncached=function(n,o){var i=this,a=0;return t.__iterate(function(s){return(!a||n(e,a++,i)!==!1)&&n(s,a++,i)!==!1},o),a},r.__iteratorUncached=function(n,o){var i=t.__iterator(vd,o),a=0,s;return new In(function(){return(!s||a%2)&&(s=i.next(),s.done)?s:a%2?Vo(n,a++,e):Vo(n,a++,s.value,s)})},r}function G0(t,e,r){e||(e=j6);var n=No(t),o=0,i=t.toSeq().map(function(a,s){return[s,a,o++,r?r(a,s,t):a]}).valueSeq().toArray();return i.sort(function(a,s){return e(a[3],s[3])||a[2]-s[2]}).forEach(n?function(a,s){i[s].length=2}:function(a,s){i[s]=a[1]}),n?If(i):kl(t)?bd(i):Z0(i)}function h2(t,e,r){if(e||(e=j6),r){var n=t.toSeq().map(function(o,i){return[o,r(o,i,t)]}).reduce(function(o,i){return r6(e,o[1],i[1])?i:o});return n&&n[0]}return t.reduce(function(o,i){return r6(e,o,i)?i:o})}function r6(t,e,r){var n=t(r,e);return n===0&&r!==e&&(r==null||r!==r)||n>0}function g2(t,e,r,n){var o=dm(t),i=new Fg(r).map(function(a){return a.size});return o.size=n?i.max():i.min(),o.__iterate=function(a,s){for(var l=this.__iterator(vd,s),c,u=0;!(c=l.next()).done&&a(c.value,u++,this)!==!1;);return u},o.__iteratorUncached=function(a,s){var l=r.map(function(d){return d=xi(d),Uk(s?d.reverse():d)}),c=0,u=!1;return new In(function(){var d;return u||(d=l.map(function(m){return m.next()}),u=n?d.every(function(m){return m.done}):d.some(function(m){return m.done})),u?Rl():Vo(a,c++,e.apply(null,d.map(function(m){return m.value})))})},o}function ao(t,e){return t===e?t:Qk(t)?e:t.constructor(e)}function n6(t){if(t!==Object(t))throw new TypeError("Expected [K, V] tuple: "+t)}function nM(t){return No(t)?lu:kl(t)?Ng:Y0}function dm(t){return Object.create((No(t)?If:kl(t)?bd:Z0).prototype)}function oM(){return this._iter.cacheResult?(this._iter.cacheResult(),this.size=this._iter.size,this):hc.prototype.cacheResult.call(this)}function j6(t,e){return t===void 0&&e===void 0?0:t===void 0?1:e===void 0?-1:t>e?1:t<e?-1:0}function cm(t,e){e=e||0;for(var r=Math.max(0,t.length-e),n=new Array(r),o=0;o<r;o++)n[o]=t[o+e];return n}function iM(t,e){if(!t)throw new Error(e)}function pc(t){iM(t!==1/0,"Cannot perform this action with an infinite size.")}function H6(t){if(A6(t)&&typeof t!="string")return t;if(yd(t))return t.toArray();throw new TypeError("Invalid keyPath: expected Ordered Collection or Array: "+t)}var epe=Object.prototype.toString;function tpe(t){if(!t||typeof t!="object"||epe.call(t)!=="[object Object]")return!1;var e=Object.getPrototypeOf(t);if(e===null)return!0;for(var r=e,n=Object.getPrototypeOf(e);n!==null;)r=n,n=Object.getPrototypeOf(r);return r===e}function Ef(t){return typeof t=="object"&&(um(t)||Array.isArray(t)||tpe(t))}function f1(t){try{return typeof t=="string"?JSON.stringify(t):String(t)}catch{return JSON.stringify(t)}}function rpe(t,e){return um(t)?t.has(e):Ef(t)&&$0.call(t,e)}function q6(t,e,r){return um(t)?t.get(e,r):rpe(t,e)?typeof t.get=="function"?t.get(e):t[e]:r}function x2(t){if(Array.isArray(t))return cm(t);var e={};for(var r in t)$0.call(t,r)&&(e[r]=t[r]);return e}function npe(t,e){if(!Ef(t))throw new TypeError("Cannot update non-data-structure value: "+t);if(um(t)){if(!t.remove)throw new TypeError("Cannot update immutable value without .remove() method: "+t);return t.remove(e)}if(!$0.call(t,e))return t;var r=x2(t);return Array.isArray(r)?r.splice(e,1):delete r[e],r}function ope(t,e,r){if(!Ef(t))throw new TypeError("Cannot update non-data-structure value: "+t);if(um(t)){if(!t.set)throw new TypeError("Cannot update immutable value without .set() method: "+t);return t.set(e,r)}if($0.call(t,e)&&r===t[e])return t;var n=x2(t);return n[e]=r,n}function J0(t,e,r,n){n||(n=r,r=void 0);var o=W6(um(t),t,H6(e),0,r,n);return o===on?r:o}function W6(t,e,r,n,o,i){var a=e===on;if(n===r.length){var s=a?o:e,l=i(s);return l===s?e:l}if(!a&&!Ef(e))throw new TypeError("Cannot update within non-data-structure value in path ["+r.slice(0,n).map(f1)+"]: "+e);var c=r[n],u=a?on:q6(e,c,on),d=W6(u===on?t:um(u),u,r,n+1,o,i);return d===u?e:d===on?npe(e,c):ope(a?t?gd():{}:e,c,d)}function ipe(t,e,r){return J0(t,e,on,function(){return r})}function aM(t,e){return ipe(this,t,e)}function ape(t,e){return J0(t,e,function(){return on})}function sM(t){return ape(this,t)}function X6(t,e,r,n){return J0(t,[e],r,n)}function lM(t,e,r){return arguments.length===1?t(this):X6(this,t,e,r)}function cM(t,e,r){return J0(this,t,e,r)}function Y6(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];return K6(this,t)}function Q6(t){for(var e=[],r=arguments.length-1;r-- >0;)e[r]=arguments[r+1];if(typeof t!="function")throw new TypeError("Invalid merger function: "+t);return K6(this,e,t)}function K6(t,e,r){for(var n=[],o=0;o<e.length;o++){var i=lu(e[o]);i.size!==0&&n.push(i)}return n.length===0?t:t.toSeq().size===0&&!t.__ownerID&&n.length===1?t.constructor(n[0]):t.withMutations(function(a){for(var s=r?function(c,u){X6(a,u,on,function(d){return d===on?c:r(d,c,u)})}:function(c,u){a.set(u,c)},l=0;l<n.length;l++)n[l].forEach(s)})}function uM(t,e,r){return dM(t,e,spe(r))}function dM(t,e,r){if(!Ef(t))throw new TypeError("Cannot merge into non-data-structure value: "+t);if(um(t))return typeof r=="function"&&t.mergeWith?t.mergeWith.apply(t,[r].concat(e)):t.merge?t.merge.apply(t,e):t.concat.apply(t,e);for(var n=Array.isArray(t),o=t,i=n?Ng:lu,a=n?function(l){o===t&&(o=x2(o)),o.push(l)}:function(l,c){var u=$0.call(o,c),d=u&&r?r(o[c],l,c):l;(!u||d!==o[c])&&(o===t&&(o=x2(o)),o[c]=d)},s=0;s<e.length;s++)i(e[s]).forEach(a);return o}function spe(t){function e(r,n,o){return Ef(r)&&Ef(n)&&lpe(r,n)?dM(r,[n],e):t?t(r,n,o):n}return e}function lpe(t,e){var r=hc(t),n=hc(e);return kl(r)===kl(n)&&No(r)===No(n)}function $6(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];return uM(this,t)}function Z6(t){for(var e=[],r=arguments.length-1;r-- >0;)e[r]=arguments[r+1];return uM(this,e,t)}function mM(t){for(var e=[],r=arguments.length-1;r-- >0;)e[r]=arguments[r+1];return J0(this,t,gd(),function(n){return dM(n,e)})}function pM(t){for(var e=[],r=arguments.length-1;r-- >0;)e[r]=arguments[r+1];return J0(this,t,gd(),function(n){return uM(n,e)})}function C1(t){var e=this.asMutable();return t(e),e.wasAltered()?e.__ensureOwner(this.__ownerID):this}function T1(){return this.__ownerID?this:this.__ensureOwner(new Yk)}function w1(){return this.__ensureOwner()}function fM(){return this.__altered}var yc=function(t){function e(r){return r==null?gd():eM(r)&&!yd(r)?r:gd().withMutations(function(n){var o=t(r);pc(o.size),o.forEach(function(i,a){return n.set(a,i)})})}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.of=function(){for(var n=[],o=arguments.length;o--;)n[o]=arguments[o];return gd().withMutations(function(i){for(var a=0;a<n.length;a+=2){if(a+1>=n.length)throw new Error("Missing value for key: "+n[a]);i.set(n[a],n[a+1])}})},e.prototype.toString=function(){return this.__toString("Map {","}")},e.prototype.get=function(n,o){return this._root?this._root.get(0,void 0,n,o):o},e.prototype.set=function(n,o){return a6(this,n,o)},e.prototype.remove=function(n){return a6(this,n,on)},e.prototype.deleteAll=function(n){var o=xi(n);return o.size===0?this:this.withMutations(function(i){o.forEach(function(a){return i.remove(a)})})},e.prototype.clear=function(){return this.size===0?this:this.__ownerID?(this.size=0,this._root=null,this.__hash=void 0,this.__altered=!0,this):gd()},e.prototype.sort=function(n){return Ui(G0(this,n))},e.prototype.sortBy=function(n,o){return Ui(G0(this,o,n))},e.prototype.map=function(n,o){var i=this;return this.withMutations(function(a){a.forEach(function(s,l){a.set(l,n.call(o,s,l,i))})})},e.prototype.__iterator=function(n,o){return new cpe(this,n,o)},e.prototype.__iterate=function(n,o){var i=this,a=0;return this._root&&this._root.iterate(function(s){return a++,n(s[1],s[0],i)},o),a},e.prototype.__ensureOwner=function(n){return n===this.__ownerID?this:n?hM(this.size,this._root,n,this.__hash):this.size===0?gd():(this.__ownerID=n,this.__altered=!1,this)},e}(lu);yc.isMap=eM;var To=yc.prototype;To[M6]=!0;To[b1]=To.remove;To.removeAll=To.deleteAll;To.setIn=aM;To.removeIn=To.deleteIn=sM;To.update=lM;To.updateIn=cM;To.merge=To.concat=Y6;To.mergeWith=Q6;To.mergeDeep=$6;To.mergeDeepWith=Z6;To.mergeIn=mM;To.mergeDeepIn=pM;To.withMutations=C1;To.wasAltered=fM;To.asImmutable=w1;To["@@transducer/init"]=To.asMutable=T1;To["@@transducer/step"]=function(t,e){return t.set(e[0],e[1])};To["@@transducer/result"]=function(t){return t.asImmutable()};var h1=function(e,r){this.ownerID=e,this.entries=r};h1.prototype.get=function(e,r,n,o){for(var i=this.entries,a=0,s=i.length;a<s;a++)if(fc(n,i[a][0]))return i[a][1];return o};h1.prototype.update=function(e,r,n,o,i,a,s){for(var l=i===on,c=this.entries,u=0,d=c.length;u<d&&!fc(o,c[u][0]);u++);var m=u<d;if(m?c[u][1]===i:l)return this;if(au(s),(l||!m)&&au(a),!(l&&c.length===1)){if(!m&&!l&&c.length>=hpe)return upe(e,c,o,i);var p=e&&e===this.ownerID,h=p?c:cm(c);return m?l?u===d-1?h.pop():h[u]=h.pop():h[u]=[o,i]:h.push([o,i]),p?(this.entries=h,this):new h1(e,h)}};var j0=function(e,r,n){this.ownerID=e,this.bitmap=r,this.nodes=n};j0.prototype.get=function(e,r,n,o){r===void 0&&(r=mc(n));var i=1<<((e===0?r:r>>>e)&ol),a=this.bitmap;return a&i?this.nodes[J6(a&i-1)].get(e+Co,r,n,o):o};j0.prototype.update=function(e,r,n,o,i,a,s){n===void 0&&(n=mc(o));var l=(r===0?n:n>>>r)&ol,c=1<<l,u=this.bitmap,d=(u&c)!==0;if(!d&&i===on)return this;var m=J6(u&c-1),p=this.nodes,h=d?p[m]:void 0,f=gM(h,e,r+Co,n,o,i,a,s);if(f===h)return this;if(!d&&f&&p.length>=gpe)return mpe(e,p,u,l,f);if(d&&!f&&p.length===2&&s6(p[m^1]))return p[m^1];if(d&&f&&p.length===1&&s6(f))return f;var b=e&&e===this.ownerID,v=d?f?u:u^c:u|c,x=d?f?e8(p,m,f,b):fpe(p,m,b):ppe(p,m,f,b);return b?(this.bitmap=v,this.nodes=x,this):new j0(e,v,x)};var g1=function(e,r,n){this.ownerID=e,this.count=r,this.nodes=n};g1.prototype.get=function(e,r,n,o){r===void 0&&(r=mc(n));var i=(e===0?r:r>>>e)&ol,a=this.nodes[i];return a?a.get(e+Co,r,n,o):o};g1.prototype.update=function(e,r,n,o,i,a,s){n===void 0&&(n=mc(o));var l=(r===0?n:n>>>r)&ol,c=i===on,u=this.nodes,d=u[l];if(c&&!d)return this;var m=gM(d,e,r+Co,n,o,i,a,s);if(m===d)return this;var p=this.count;if(!d)p++;else if(!m&&(p--,p<ype))return dpe(e,u,p,l);var h=e&&e===this.ownerID,f=e8(u,l,m,h);return h?(this.count=p,this.nodes=f,this):new g1(e,p,f)};var H0=function(e,r,n){this.ownerID=e,this.keyHash=r,this.entries=n};H0.prototype.get=function(e,r,n,o){for(var i=this.entries,a=0,s=i.length;a<s;a++)if(fc(n,i[a][0]))return i[a][1];return o};H0.prototype.update=function(e,r,n,o,i,a,s){n===void 0&&(n=mc(o));var l=i===on;if(n!==this.keyHash)return l?this:(au(s),au(a),yM(this,e,r,n,[o,i]));for(var c=this.entries,u=0,d=c.length;u<d&&!fc(o,c[u][0]);u++);var m=u<d;if(m?c[u][1]===i:l)return this;if(au(s),(l||!m)&&au(a),l&&d===2)return new yp(e,this.keyHash,c[u^1]);var p=e&&e===this.ownerID,h=p?c:cm(c);return m?l?u===d-1?h.pop():h[u]=h.pop():h[u]=[o,i]:h.push([o,i]),p?(this.entries=h,this):new H0(e,this.keyHash,h)};var yp=function(e,r,n){this.ownerID=e,this.keyHash=r,this.entry=n};yp.prototype.get=function(e,r,n,o){return fc(n,this.entry[0])?this.entry[1]:o};yp.prototype.update=function(e,r,n,o,i,a,s){var l=i===on,c=fc(o,this.entry[0]);if(c?i===this.entry[1]:l)return this;if(au(s),l){au(a);return}return c?e&&e===this.ownerID?(this.entry[1]=i,this):new yp(e,this.keyHash,[o,i]):(au(a),yM(this,e,r,mc(o),[o,i]))};h1.prototype.iterate=H0.prototype.iterate=function(t,e){for(var r=this.entries,n=0,o=r.length-1;n<=o;n++)if(t(r[e?o-n:n])===!1)return!1};j0.prototype.iterate=g1.prototype.iterate=function(t,e){for(var r=this.nodes,n=0,o=r.length-1;n<=o;n++){var i=r[e?o-n:n];if(i&&i.iterate(t,e)===!1)return!1}};yp.prototype.iterate=function(t,e){return t(this.entry)};var cpe=function(t){function e(r,n,o){this._type=n,this._reverse=o,this._stack=r._root&&o6(r._root)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.next=function(){for(var n=this._type,o=this._stack;o;){var i=o.node,a=o.index++,s=void 0;if(i.entry){if(a===0)return Ok(n,i.entry)}else if(i.entries){if(s=i.entries.length-1,a<=s)return Ok(n,i.entries[this._reverse?s-a:a])}else if(s=i.nodes.length-1,a<=s){var l=i.nodes[this._reverse?s-a:a];if(l){if(l.entry)return Ok(n,l.entry);o=this._stack=o6(l,o)}continue}o=this._stack=this._stack.__prev}return Rl()},e}(In);function Ok(t,e){return Vo(t,e[0],e[1])}function o6(t,e){return{node:t,index:0,__prev:e}}function hM(t,e,r,n){var o=Object.create(To);return o.size=t,o._root=e,o.__ownerID=r,o.__hash=n,o.__altered=!1,o}var i6;function gd(){return i6||(i6=hM(0))}function a6(t,e,r){var n,o;if(t._root){var i=Vk(),a=Vk();if(n=gM(t._root,t.__ownerID,0,void 0,e,r,i,a),!a.value)return t;o=t.size+(i.value?r===on?-1:1:0)}else{if(r===on)return t;o=1,n=new h1(t.__ownerID,[[e,r]])}return t.__ownerID?(t.size=o,t._root=n,t.__hash=void 0,t.__altered=!0,t):n?hM(o,n):gd()}function gM(t,e,r,n,o,i,a,s){return t?t.update(e,r,n,o,i,a,s):i===on?t:(au(s),au(a),new yp(e,n,[o,i]))}function s6(t){return t.constructor===yp||t.constructor===H0}function yM(t,e,r,n,o){if(t.keyHash===n)return new H0(e,n,[t.entry,o]);var i=(r===0?t.keyHash:t.keyHash>>>r)&ol,a=(r===0?n:n>>>r)&ol,s,l=i===a?[yM(t,e,r+Co,n,o)]:(s=new yp(e,n,o),i<a?[t,s]:[s,t]);return new j0(e,1<<i|1<<a,l)}function upe(t,e,r,n){t||(t=new Yk);for(var o=new yp(t,mc(r),[r,n]),i=0;i<e.length;i++){var a=e[i];o=o.update(t,0,void 0,a[0],a[1])}return o}function dpe(t,e,r,n){for(var o=0,i=0,a=new Array(r),s=0,l=1,c=e.length;s<c;s++,l<<=1){var u=e[s];u!==void 0&&s!==n&&(o|=l,a[i++]=u)}return new j0(t,o,a)}function mpe(t,e,r,n,o){for(var i=0,a=new Array(iu),s=0;r!==0;s++,r>>>=1)a[s]=r&1?e[i++]:void 0;return a[n]=o,new g1(t,i+1,a)}function J6(t){return t-=t>>1&1431655765,t=(t&858993459)+(t>>2&858993459),t=t+(t>>4)&252645135,t+=t>>8,t+=t>>16,t&127}function e8(t,e,r,n){var o=n?t:cm(t);return o[e]=r,o}function ppe(t,e,r,n){var o=t.length+1;if(n&&e+1===o)return t[e]=r,t;for(var i=new Array(o),a=0,s=0;s<o;s++)s===e?(i[s]=r,a=-1):i[s]=t[s+a];return i}function fpe(t,e,r){var n=t.length-1;if(r&&e===n)return t.pop(),t;for(var o=new Array(n),i=0,a=0;a<n;a++)a===e&&(i=1),o[a]=t[a+i];return o}var hpe=iu/4,gpe=iu/2,ype=iu/4,t8="@@__IMMUTABLE_LIST__@@";function r8(t){return!!(t&&t[t8])}var mm=function(t){function e(r){var n=b2();if(r==null)return n;if(r8(r))return r;var o=t(r),i=o.size;return i===0?n:(pc(i),i>0&&i<iu?y1(0,i,Co,null,new _f(o.toArray())):n.withMutations(function(a){a.setSize(i),o.forEach(function(s,l){return a.set(l,s)})}))}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.of=function(){return this(arguments)},e.prototype.toString=function(){return this.__toString("List [","]")},e.prototype.get=function(n,o){if(n=Pf(this,n),n>=0&&n<this.size){n+=this._origin;var i=n8(this,n);return i&&i.array[n&ol]}return o},e.prototype.set=function(n,o){return vpe(this,n,o)},e.prototype.remove=function(n){return this.has(n)?n===0?this.shift():n===this.size-1?this.pop():this.splice(n,1):this},e.prototype.insert=function(n,o){return this.splice(n,0,o)},e.prototype.clear=function(){return this.size===0?this:this.__ownerID?(this.size=this._origin=this._capacity=0,this._level=Co,this._root=this._tail=this.__hash=void 0,this.__altered=!0,this):b2()},e.prototype.push=function(){var n=arguments,o=this.size;return this.withMutations(function(i){wf(i,0,o+n.length);for(var a=0;a<n.length;a++)i.set(o+a,n[a])})},e.prototype.pop=function(){return wf(this,0,-1)},e.prototype.unshift=function(){var n=arguments;return this.withMutations(function(o){wf(o,-n.length);for(var i=0;i<n.length;i++)o.set(i,n[i])})},e.prototype.shift=function(){return wf(this,1)},e.prototype.concat=function(){for(var n=arguments,o=[],i=0;i<arguments.length;i++){var a=n[i],s=t(typeof a!="string"&&D6(a)?a:[a]);s.size!==0&&o.push(s)}return o.length===0?this:this.size===0&&!this.__ownerID&&o.length===1?this.constructor(o[0]):this.withMutations(function(l){o.forEach(function(c){return c.forEach(function(u){return l.push(u)})})})},e.prototype.setSize=function(n){return wf(this,0,n)},e.prototype.map=function(n,o){var i=this;return this.withMutations(function(a){for(var s=0;s<i.size;s++)a.set(s,n.call(o,a.get(s),s,i))})},e.prototype.slice=function(n,o){var i=this.size;return C2(n,o,i)?this:wf(this,x1(n,i),T2(o,i))},e.prototype.__iterator=function(n,o){var i=o?this.size:0,a=l6(this,o);return new In(function(){var s=a();return s===p1?Rl():Vo(n,o?--i:i++,s)})},e.prototype.__iterate=function(n,o){for(var i=o?this.size:0,a=l6(this,o),s;(s=a())!==p1&&n(s,o?--i:i++,this)!==!1;);return i},e.prototype.__ensureOwner=function(n){return n===this.__ownerID?this:n?y1(this._origin,this._capacity,this._level,this._root,this._tail,n,this.__hash):this.size===0?b2():(this.__ownerID=n,this.__altered=!1,this)},e}(Ng);mm.isList=r8;var zi=mm.prototype;zi[t8]=!0;zi[b1]=zi.remove;zi.merge=zi.concat;zi.setIn=aM;zi.deleteIn=zi.removeIn=sM;zi.update=lM;zi.updateIn=cM;zi.mergeIn=mM;zi.mergeDeepIn=pM;zi.withMutations=C1;zi.wasAltered=fM;zi.asImmutable=w1;zi["@@transducer/init"]=zi.asMutable=T1;zi["@@transducer/step"]=function(t,e){return t.push(e)};zi["@@transducer/result"]=function(t){return t.asImmutable()};var _f=function(e,r){this.array=e,this.ownerID=r};_f.prototype.removeBefore=function(e,r,n){if(n===r?1<<r:this.array.length===0)return this;var o=n>>>r&ol;if(o>=this.array.length)return new _f([],e);var i=o===0,a;if(r>0){var s=this.array[o];if(a=s&&s.removeBefore(e,r-Co,n),a===s&&i)return this}if(i&&!a)return this;var l=q0(this,e);if(!i)for(var c=0;c<o;c++)l.array[c]=void 0;return a&&(l.array[o]=a),l};_f.prototype.removeAfter=function(e,r,n){if(n===(r?1<<r:0)||this.array.length===0)return this;var o=n-1>>>r&ol;if(o>=this.array.length)return this;var i;if(r>0){var a=this.array[o];if(i=a&&a.removeAfter(e,r-Co,n),i===a&&o===this.array.length-1)return this}var s=q0(this,e);return s.array.splice(o+1),i&&(s.array[o]=i),s};var p1={};function l6(t,e){var r=t._origin,n=t._capacity,o=v1(n),i=t._tail;return a(t._root,t._level,0);function a(c,u,d){return u===0?s(c,d):l(c,u,d)}function s(c,u){var d=u===o?i&&i.array:c&&c.array,m=u>r?0:r-u,p=n-u;return p>iu&&(p=iu),function(){if(m===p)return p1;var h=e?--p:m++;return d&&d[h]}}function l(c,u,d){var m,p=c&&c.array,h=d>r?0:r-d>>u,f=(n-d>>u)+1;return f>iu&&(f=iu),function(){for(;;){if(m){var b=m();if(b!==p1)return b;m=null}if(h===f)return p1;var v=e?--f:h++;m=a(p&&p[v],u-Co,d+(v<<u))}}}}function y1(t,e,r,n,o,i,a){var s=Object.create(zi);return s.size=e-t,s._origin=t,s._capacity=e,s._level=r,s._root=n,s._tail=o,s.__ownerID=i,s.__hash=a,s.__altered=!1,s}var c6;function b2(){return c6||(c6=y1(0,0,Co))}function vpe(t,e,r){if(e=Pf(t,e),e!==e)return t;if(e>=t.size||e<0)return t.withMutations(function(a){e<0?wf(a,e).set(0,r):wf(a,0,e+1).set(e,r)});e+=t._origin;var n=t._tail,o=t._root,i=Vk();return e>=v1(t._capacity)?n=qk(n,t.__ownerID,0,e,r,i):o=qk(o,t.__ownerID,t._level,e,r,i),i.value?t.__ownerID?(t._root=o,t._tail=n,t.__hash=void 0,t.__altered=!0,t):y1(t._origin,t._capacity,t._level,o,n):t}function qk(t,e,r,n,o,i){var a=n>>>r&ol,s=t&&a<t.array.length;if(!s&&o===void 0)return t;var l;if(r>0){var c=t&&t.array[a],u=qk(c,e,r-Co,n,o,i);return u===c?t:(l=q0(t,e),l.array[a]=u,l)}return s&&t.array[a]===o?t:(i&&au(i),l=q0(t,e),o===void 0&&a===l.array.length-1?l.array.pop():l.array[a]=o,l)}function q0(t,e){return e&&t&&e===t.ownerID?t:new _f(t?t.array.slice():[],e)}function n8(t,e){if(e>=v1(t._capacity))return t._tail;if(e<1<<t._level+Co){for(var r=t._root,n=t._level;r&&n>0;)r=r.array[e>>>n&ol],n-=Co;return r}}function wf(t,e,r){e!==void 0&&(e|=0),r!==void 0&&(r|=0);var n=t.__ownerID||new Yk,o=t._origin,i=t._capacity,a=o+e,s=r===void 0?i:r<0?i+r:o+r;if(a===o&&s===i)return t;if(a>=s)return t.clear();for(var l=t._level,c=t._root,u=0;a+u<0;)c=new _f(c&&c.array.length?[void 0,c]:[],n),l+=Co,u+=1<<l;u&&(a+=u,o+=u,s+=u,i+=u);for(var d=v1(i),m=v1(s);m>=1<<l+Co;)c=new _f(c&&c.array.length?[c]:[],n),l+=Co;var p=t._tail,h=m<d?n8(t,s-1):m>d?new _f([],n):p;if(p&&m>d&&a<i&&p.array.length){c=q0(c,n);for(var f=c,b=l;b>Co;b-=Co){var v=d>>>b&ol;f=f.array[v]=q0(f.array[v],n)}f.array[d>>>Co&ol]=p}if(s<i&&(h=h&&h.removeAfter(n,0,s)),a>=m)a-=m,s-=m,l=Co,c=null,h=h&&h.removeBefore(n,0,a);else if(a>o||m<d){for(u=0;c;){var x=a>>>l&ol;if(x!==m>>>l&ol)break;x&&(u+=(1<<l)*x),l-=Co,c=c.array[x]}c&&a>o&&(c=c.removeBefore(n,l,a-u)),c&&m<d&&(c=c.removeAfter(n,l,m-u)),u&&(a-=u,s-=u)}return t.__ownerID?(t.size=s-a,t._origin=a,t._capacity=s,t._level=l,t._root=c,t._tail=h,t.__hash=void 0,t.__altered=!0,t):y1(a,s,l,c,h)}function v1(t){return t<iu?0:t-1>>>Co<<Co}var Ui=function(t){function e(r){return r==null?u1():R6(r)?r:u1().withMutations(function(n){var o=lu(r);pc(o.size),o.forEach(function(i,a){return n.set(a,i)})})}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.of=function(){return this(arguments)},e.prototype.toString=function(){return this.__toString("OrderedMap {","}")},e.prototype.get=function(n,o){var i=this._map.get(n);return i!==void 0?this._list.get(i)[1]:o},e.prototype.clear=function(){return this.size===0?this:this.__ownerID?(this.size=0,this._map.clear(),this._list.clear(),this.__altered=!0,this):u1()},e.prototype.set=function(n,o){return d6(this,n,o)},e.prototype.remove=function(n){return d6(this,n,on)},e.prototype.__iterate=function(n,o){var i=this;return this._list.__iterate(function(a){return a&&n(a[1],a[0],i)},o)},e.prototype.__iterator=function(n,o){return this._list.fromEntrySeq().__iterator(n,o)},e.prototype.__ensureOwner=function(n){if(n===this.__ownerID)return this;var o=this._map.__ensureOwner(n),i=this._list.__ensureOwner(n);return n?vM(o,i,n,this.__hash):this.size===0?u1():(this.__ownerID=n,this.__altered=!1,this._map=o,this._list=i,this)},e}(yc);Ui.isOrderedMap=R6;Ui.prototype[K0]=!0;Ui.prototype[b1]=Ui.prototype.remove;function vM(t,e,r,n){var o=Object.create(Ui.prototype);return o.size=t?t.size:0,o._map=t,o._list=e,o.__ownerID=r,o.__hash=n,o.__altered=!1,o}var u6;function u1(){return u6||(u6=vM(gd(),b2()))}function d6(t,e,r){var n=t._map,o=t._list,i=n.get(e),a=i!==void 0,s,l;if(r===on){if(!a)return t;o.size>=iu&&o.size>=n.size*2?(l=o.filter(function(c,u){return c!==void 0&&i!==u}),s=l.toKeyedSeq().map(function(c){return c[0]}).flip().toMap(),t.__ownerID&&(s.__ownerID=l.__ownerID=t.__ownerID)):(s=n.remove(e),l=i===o.size-1?o.pop():o.set(i,void 0))}else if(a){if(r===o.get(i)[1])return t;s=n,l=o.set(i,[e,r])}else s=n.set(e,o.size),l=o.set(o.size,[e,r]);return t.__ownerID?(t.size=s.size,t._map=s,t._list=l,t.__hash=void 0,t.__altered=!0,t):vM(s,l)}var o8="@@__IMMUTABLE_STACK__@@";function Wk(t){return!!(t&&t[o8])}var bM=function(t){function e(r){return r==null?y2():Wk(r)?r:y2().pushAll(r)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.of=function(){return this(arguments)},e.prototype.toString=function(){return this.__toString("Stack [","]")},e.prototype.get=function(n,o){var i=this._head;for(n=Pf(this,n);i&&n--;)i=i.next;return i?i.value:o},e.prototype.peek=function(){return this._head&&this._head.value},e.prototype.push=function(){var n=arguments;if(arguments.length===0)return this;for(var o=this.size+arguments.length,i=this._head,a=arguments.length-1;a>=0;a--)i={value:n[a],next:i};return this.__ownerID?(this.size=o,this._head=i,this.__hash=void 0,this.__altered=!0,this):d1(o,i)},e.prototype.pushAll=function(n){if(n=t(n),n.size===0)return this;if(this.size===0&&Wk(n))return n;pc(n.size);var o=this.size,i=this._head;return n.__iterate(function(a){o++,i={value:a,next:i}},!0),this.__ownerID?(this.size=o,this._head=i,this.__hash=void 0,this.__altered=!0,this):d1(o,i)},e.prototype.pop=function(){return this.slice(1)},e.prototype.clear=function(){return this.size===0?this:this.__ownerID?(this.size=0,this._head=void 0,this.__hash=void 0,this.__altered=!0,this):y2()},e.prototype.slice=function(n,o){if(C2(n,o,this.size))return this;var i=x1(n,this.size),a=T2(o,this.size);if(a!==this.size)return t.prototype.slice.call(this,n,o);for(var s=this.size-i,l=this._head;i--;)l=l.next;return this.__ownerID?(this.size=s,this._head=l,this.__hash=void 0,this.__altered=!0,this):d1(s,l)},e.prototype.__ensureOwner=function(n){return n===this.__ownerID?this:n?d1(this.size,this._head,n,this.__hash):this.size===0?y2():(this.__ownerID=n,this.__altered=!1,this)},e.prototype.__iterate=function(n,o){var i=this;if(o)return new Fg(this.toArray()).__iterate(function(l,c){return n(l,c,i)},o);for(var a=0,s=this._head;s&&n(s.value,a++,this)!==!1;)s=s.next;return a},e.prototype.__iterator=function(n,o){if(o)return new Fg(this.toArray()).__iterator(n,o);var i=0,a=this._head;return new In(function(){if(a){var s=a.value;return a=a.next,Vo(n,i++,s)}return Rl()})},e}(Ng);bM.isStack=Wk;var il=bM.prototype;il[o8]=!0;il.shift=il.pop;il.unshift=il.push;il.unshiftAll=il.pushAll;il.withMutations=C1;il.wasAltered=fM;il.asImmutable=w1;il["@@transducer/init"]=il.asMutable=T1;il["@@transducer/step"]=function(t,e){return t.unshift(e)};il["@@transducer/result"]=function(t){return t.asImmutable()};function d1(t,e,r,n){var o=Object.create(il);return o.size=t,o._head=e,o.__ownerID=r,o.__hash=n,o.__altered=!1,o}var m6;function y2(){return m6||(m6=d1(0))}var i8="@@__IMMUTABLE_SET__@@";function xM(t){return!!(t&&t[i8])}function a8(t){return xM(t)&&yd(t)}function s8(t,e){if(t===e)return!0;if(!Ml(e)||t.size!==void 0&&e.size!==void 0&&t.size!==e.size||t.__hash!==void 0&&e.__hash!==void 0&&t.__hash!==e.__hash||No(t)!==No(e)||kl(t)!==kl(e)||yd(t)!==yd(e))return!1;if(t.size===0&&e.size===0)return!0;var r=!w2(t);if(yd(t)){var n=t.entries();return e.every(function(l,c){var u=n.next().value;return u&&fc(u[1],l)&&(r||fc(u[0],c))})&&n.next().done}var o=!1;if(t.size===void 0)if(e.size===void 0)typeof t.cacheResult=="function"&&t.cacheResult();else{o=!0;var i=t;t=e,e=i}var a=!0,s=e.__iterate(function(l,c){if(r?!t.has(l):o?!fc(l,t.get(c,on)):!fc(t.get(c,on),l))return a=!1,!1});return a&&t.size===s}function Vg(t,e){var r=function(n){t.prototype[n]=e[n]};return Object.keys(e).forEach(r),Object.getOwnPropertySymbols&&Object.getOwnPropertySymbols(e).forEach(r),t}function S2(t){if(!t||typeof t!="object")return t;if(!Ml(t)){if(!Ef(t))return t;t=hc(t)}if(No(t)){var e={};return t.__iterate(function(n,o){e[o]=S2(n)}),e}var r=[];return t.__iterate(function(n){r.push(S2(n))}),r}var D2=function(t){function e(r){return r==null?m1():xM(r)&&!yd(r)?r:m1().withMutations(function(n){var o=t(r);pc(o.size),o.forEach(function(i){return n.add(i)})})}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.of=function(){return this(arguments)},e.fromKeys=function(n){return this(lu(n).keySeq())},e.intersect=function(n){return n=xi(n).toArray(),n.length?as.intersect.apply(e(n.pop()),n):m1()},e.union=function(n){return n=xi(n).toArray(),n.length?as.union.apply(e(n.pop()),n):m1()},e.prototype.toString=function(){return this.__toString("Set {","}")},e.prototype.has=function(n){return this._map.has(n)},e.prototype.add=function(n){return v2(this,this._map.set(n,n))},e.prototype.remove=function(n){return v2(this,this._map.remove(n))},e.prototype.clear=function(){return v2(this,this._map.clear())},e.prototype.map=function(n,o){var i=this,a=!1,s=v2(this,this._map.mapEntries(function(l){var c=l[1],u=n.call(o,c,c,i);return u!==c&&(a=!0),[u,u]},o));return a?s:this},e.prototype.union=function(){for(var n=[],o=arguments.length;o--;)n[o]=arguments[o];return n=n.filter(function(i){return i.size!==0}),n.length===0?this:this.size===0&&!this.__ownerID&&n.length===1?this.constructor(n[0]):this.withMutations(function(i){for(var a=0;a<n.length;a++)typeof n[a]=="string"?i.add(n[a]):t(n[a]).forEach(function(s){return i.add(s)})})},e.prototype.intersect=function(){for(var n=[],o=arguments.length;o--;)n[o]=arguments[o];if(n.length===0)return this;n=n.map(function(a){return t(a)});var i=[];return this.forEach(function(a){n.every(function(s){return s.includes(a)})||i.push(a)}),this.withMutations(function(a){i.forEach(function(s){a.remove(s)})})},e.prototype.subtract=function(){for(var n=[],o=arguments.length;o--;)n[o]=arguments[o];if(n.length===0)return this;n=n.map(function(a){return t(a)});var i=[];return this.forEach(function(a){n.some(function(s){return s.includes(a)})&&i.push(a)}),this.withMutations(function(a){i.forEach(function(s){a.remove(s)})})},e.prototype.sort=function(n){return gc(G0(this,n))},e.prototype.sortBy=function(n,o){return gc(G0(this,o,n))},e.prototype.wasAltered=function(){return this._map.wasAltered()},e.prototype.__iterate=function(n,o){var i=this;return this._map.__iterate(function(a){return n(a,a,i)},o)},e.prototype.__iterator=function(n,o){return this._map.__iterator(n,o)},e.prototype.__ensureOwner=function(n){if(n===this.__ownerID)return this;var o=this._map.__ensureOwner(n);return n?this.__make(o,n):this.size===0?this.__empty():(this.__ownerID=n,this._map=o,this)},e}(Y0);D2.isSet=xM;var as=D2.prototype;as[i8]=!0;as[b1]=as.remove;as.merge=as.concat=as.union;as.withMutations=C1;as.asImmutable=w1;as["@@transducer/init"]=as.asMutable=T1;as["@@transducer/step"]=function(t,e){return t.add(e)};as["@@transducer/result"]=function(t){return t.asImmutable()};as.__empty=m1;as.__make=l8;function v2(t,e){return t.__ownerID?(t.size=e.size,t._map=e,t):e===t._map?t:e.size===0?t.__empty():t.__make(e)}function l8(t,e){var r=Object.create(as);return r.size=t?t.size:0,r._map=t,r.__ownerID=e,r}var p6;function m1(){return p6||(p6=l8(gd()))}var bpe=function(t){function e(r,n,o){if(!(this instanceof e))return new e(r,n,o);if(iM(o!==0,"Cannot step a Range by 0"),r=r||0,n===void 0&&(n=1/0),o=o===void 0?1:Math.abs(o),n<r&&(o=-o),this._start=r,this._end=n,this._step=o,this.size=Math.max(0,Math.ceil((n-r)/o-1)+1),this.size===0){if(Fk)return Fk;Fk=this}}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.toString=function(){return this.size===0?"Range []":"Range [ "+this._start+"..."+this._end+(this._step!==1?" by "+this._step:"")+" ]"},e.prototype.get=function(n,o){return this.has(n)?this._start+Pf(this,n)*this._step:o},e.prototype.includes=function(n){var o=(n-this._start)/this._step;return o>=0&&o<this.size&&o===Math.floor(o)},e.prototype.slice=function(n,o){return C2(n,o,this.size)?this:(n=x1(n,this.size),o=T2(o,this.size),o<=n?new e(0,0):new e(this.get(n,this._end),this.get(o,this._end),this._step))},e.prototype.indexOf=function(n){var o=n-this._start;if(o%this._step===0){var i=o/this._step;if(i>=0&&i<this.size)return i}return-1},e.prototype.lastIndexOf=function(n){return this.indexOf(n)},e.prototype.__iterate=function(n,o){for(var i=this.size,a=this._step,s=o?this._start+(i-1)*a:this._start,l=0;l!==i&&n(s,o?i-++l:l++,this)!==!1;)s+=o?-a:a;return l},e.prototype.__iterator=function(n,o){var i=this.size,a=this._step,s=o?this._start+(i-1)*a:this._start,l=0;return new In(function(){if(l===i)return Rl();var c=s;return s+=o?-a:a,Vo(n,o?i-++l:l++,c)})},e.prototype.equals=function(n){return n instanceof e?this._start===n._start&&this._end===n._end&&this._step===n._step:s8(this,n)},e}(bd),Fk;function c8(t,e,r){for(var n=H6(e),o=0;o!==n.length;)if(t=q6(t,n[o++],on),t===on)return r;return t}function u8(t,e){return c8(this,t,e)}function xpe(t,e){return c8(t,e,on)!==on}function Spe(t){return xpe(this,t)}function d8(){pc(this.size);var t={};return this.__iterate(function(e,r){t[r]=e}),t}xi.isIterable=Ml;xi.isKeyed=No;xi.isIndexed=kl;xi.isAssociative=w2;xi.isOrdered=yd;xi.Iterator=In;Vg(xi,{toArray:function(){pc(this.size);var e=new Array(this.size||0),r=No(this),n=0;return this.__iterate(function(o,i){e[n++]=r?[i,o]:o}),e},toIndexedSeq:function(){return new B6(this)},toJS:function(){return S2(this)},toKeyedSeq:function(){return new I2(this,!0)},toMap:function(){return yc(this.toKeyedSeq())},toObject:d8,toOrderedMap:function(){return Ui(this.toKeyedSeq())},toOrderedSet:function(){return gc(No(this)?this.valueSeq():this)},toSet:function(){return D2(No(this)?this.valueSeq():this)},toSetSeq:function(){return new O6(this)},toSeq:function(){return kl(this)?this.toIndexedSeq():No(this)?this.toKeyedSeq():this.toSetSeq()},toStack:function(){return bM(No(this)?this.valueSeq():this)},toList:function(){return mm(No(this)?this.valueSeq():this)},toString:function(){return"[Collection]"},__toString:function(e,r){return this.size===0?e+r:e+" "+this.toSeq().map(this.__toStringMapper).join(", ")+" "+r},concat:function(){for(var e=[],r=arguments.length;r--;)e[r]=arguments[r];return ao(this,$me(this,e))},includes:function(e){return this.some(function(r){return fc(r,e)})},entries:function(){return this.__iterator(su)},every:function(e,r){pc(this.size);var n=!0;return this.__iterate(function(o,i,a){if(!e.call(r,o,i,a))return n=!1,!1}),n},filter:function(e,r){return ao(this,z6(this,e,r,!0))},partition:function(e,r){return Qme(this,e,r)},find:function(e,r,n){var o=this.findEntry(e,r);return o?o[1]:n},forEach:function(e,r){return pc(this.size),this.__iterate(r?e.bind(r):e)},join:function(e){pc(this.size),e=e!==void 0?""+e:",";var r="",n=!0;return this.__iterate(function(o){n?n=!1:r+=e,r+=o!=null?o.toString():""}),r},keys:function(){return this.__iterator(S1)},map:function(e,r){return ao(this,V6(this,e,r))},reduce:function(e,r,n){return f6(this,e,r,n,arguments.length<2,!1)},reduceRight:function(e,r,n){return f6(this,e,r,n,arguments.length<2,!0)},reverse:function(){return ao(this,tM(this,!0))},slice:function(e,r){return ao(this,rM(this,e,r,!0))},some:function(e,r){pc(this.size);var n=!1;return this.__iterate(function(o,i,a){if(e.call(r,o,i,a))return n=!0,!1}),n},sort:function(e){return ao(this,G0(this,e))},values:function(){return this.__iterator(vd)},butLast:function(){return this.slice(0,-1)},isEmpty:function(){return this.size!==void 0?this.size===0:!this.some(function(){return!0})},count:function(e,r){return U0(e?this.toSeq().filter(e,r):this)},countBy:function(e,r){return Xme(this,e,r)},equals:function(e){return s8(this,e)},entrySeq:function(){var e=this;if(e._cache)return new Fg(e._cache);var r=e.toSeq().map(Tpe).toIndexedSeq();return r.fromEntrySeq=function(){return e.toSeq()},r},filterNot:function(e,r){return this.filter(Nk(e),r)},findEntry:function(e,r,n){var o=n;return this.__iterate(function(i,a,s){if(e.call(r,i,a,s))return o=[a,i],!1}),o},findKey:function(e,r){var n=this.findEntry(e,r);return n&&n[0]},findLast:function(e,r,n){return this.toKeyedSeq().reverse().find(e,r,n)},findLastEntry:function(e,r,n){return this.toKeyedSeq().reverse().findEntry(e,r,n)},findLastKey:function(e,r){return this.toKeyedSeq().reverse().findKey(e,r)},first:function(e){return this.find(x6,null,e)},flatMap:function(e,r){return ao(this,Zme(this,e,r))},flatten:function(e){return ao(this,G6(this,e,!0))},fromEntrySeq:function(){return new F6(this)},get:function(e,r){return this.find(function(n,o){return fc(o,e)},void 0,r)},getIn:u8,groupBy:function(e,r){return Yme(this,e,r)},has:function(e){return this.get(e,on)!==on},hasIn:Spe,isSubset:function(e){return e=typeof e.includes=="function"?e:xi(e),this.every(function(r){return e.includes(r)})},isSuperset:function(e){return e=typeof e.isSubset=="function"?e:xi(e),e.isSubset(this)},keyOf:function(e){return this.findKey(function(r){return fc(r,e)})},keySeq:function(){return this.toSeq().map(Cpe).toIndexedSeq()},last:function(e){return this.toSeq().reverse().first(e)},lastKeyOf:function(e){return this.toKeyedSeq().reverse().keyOf(e)},max:function(e){return h2(this,e)},maxBy:function(e,r){return h2(this,r,e)},min:function(e){return h2(this,e?h6(e):y6)},minBy:function(e,r){return h2(this,r?h6(r):y6,e)},rest:function(){return this.slice(1)},skip:function(e){return e===0?this:this.slice(Math.max(0,e))},skipLast:function(e){return e===0?this:this.slice(0,-Math.max(0,e))},skipWhile:function(e,r){return ao(this,U6(this,e,r,!0))},skipUntil:function(e,r){return this.skipWhile(Nk(e),r)},sortBy:function(e,r){return ao(this,G0(this,r,e))},take:function(e){return this.slice(0,Math.max(0,e))},takeLast:function(e){return this.slice(-Math.max(0,e))},takeWhile:function(e,r){return ao(this,Kme(this,e,r))},takeUntil:function(e,r){return this.takeWhile(Nk(e),r)},update:function(e){return e(this)},valueSeq:function(){return this.toIndexedSeq()},hashCode:function(){return this.__hash||(this.__hash=wpe(this))}});var ws=xi.prototype;ws[T6]=!0;ws[_2]=ws.values;ws.toJSON=ws.toArray;ws.__toStringMapper=f1;ws.inspect=ws.toSource=function(){return this.toString()};ws.chain=ws.flatMap;ws.contains=ws.includes;Vg(lu,{flip:function(){return ao(this,N6(this))},mapEntries:function(e,r){var n=this,o=0;return ao(this,this.toSeq().map(function(i,a){return e.call(r,[a,i],o++,n)}).fromEntrySeq())},mapKeys:function(e,r){var n=this;return ao(this,this.toSeq().flip().map(function(o,i){return e.call(r,o,i,n)}).flip())}});var _1=lu.prototype;_1[w6]=!0;_1[_2]=ws.entries;_1.toJSON=d8;_1.__toStringMapper=function(t,e){return f1(e)+": "+f1(t)};Vg(Ng,{toKeyedSeq:function(){return new I2(this,!1)},filter:function(e,r){return ao(this,z6(this,e,r,!1))},findIndex:function(e,r){var n=this.findEntry(e,r);return n?n[0]:-1},indexOf:function(e){var r=this.keyOf(e);return r===void 0?-1:r},lastIndexOf:function(e){var r=this.lastKeyOf(e);return r===void 0?-1:r},reverse:function(){return ao(this,tM(this,!1))},slice:function(e,r){return ao(this,rM(this,e,r,!1))},splice:function(e,r){var n=arguments.length;if(r=Math.max(r||0,0),n===0||n===2&&!r)return this;e=x1(e,e<0?this.count():this.size);var o=this.slice(0,e);return ao(this,n===1?o:o.concat(cm(arguments,2),this.slice(e+r)))},findLastIndex:function(e,r){var n=this.findLastEntry(e,r);return n?n[0]:-1},first:function(e){return this.get(0,e)},flatten:function(e){return ao(this,G6(this,e,!1))},get:function(e,r){return e=Pf(this,e),e<0||this.size===1/0||this.size!==void 0&&e>this.size?r:this.find(function(n,o){return o===e},void 0,r)},has:function(e){return e=Pf(this,e),e>=0&&(this.size!==void 0?this.size===1/0||e<this.size:this.indexOf(e)!==-1)},interpose:function(e){return ao(this,Jme(this,e))},interleave:function(){var e=[this].concat(cm(arguments)),r=g2(this.toSeq(),bd.of,e),n=r.flatten(!0);return r.size&&(n.size=r.size*e.length),ao(this,n)},keySeq:function(){return bpe(0,this.size)},last:function(e){return this.get(-1,e)},skipWhile:function(e,r){return ao(this,U6(this,e,r,!1))},zip:function(){var e=[this].concat(cm(arguments));return ao(this,g2(this,g6,e))},zipAll:function(){var e=[this].concat(cm(arguments));return ao(this,g2(this,g6,e,!0))},zipWith:function(e){var r=cm(arguments);return r[0]=this,ao(this,g2(this,e,r))}});var ev=Ng.prototype;ev[_6]=!0;ev[K0]=!0;Vg(Y0,{get:function(e,r){return this.has(e)?e:r},includes:function(e){return this.has(e)},keySeq:function(){return this.valueSeq()}});var W0=Y0.prototype;W0.has=ws.includes;W0.contains=W0.includes;W0.keys=W0.values;Vg(If,_1);Vg(bd,ev);Vg(Z0,W0);function f6(t,e,r,n,o,i){return pc(t.size),t.__iterate(function(a,s,l){o?(o=!1,r=a):r=e.call(n,r,a,s,l)},i),r}function Cpe(t,e){return e}function Tpe(t,e){return[e,t]}function Nk(t){return function(){return!t.apply(this,arguments)}}function h6(t){return function(){return-t.apply(this,arguments)}}function g6(){return cm(arguments)}function y6(t,e){return t<e?1:t>e?-1:0}function wpe(t){if(t.size===1/0)return 0;var e=yd(t),r=No(t),n=e?1:0,o=t.__iterate(r?e?function(i,a){n=31*n+v6(mc(i),mc(a))|0}:function(i,a){n=n+v6(mc(i),mc(a))|0}:e?function(i){n=31*n+mc(i)|0}:function(i){n=n+mc(i)|0});return _pe(o,n)}function _pe(t,e){return e=c1(e,3432918353),e=c1(e<<15|e>>>-15,461845907),e=c1(e<<13|e>>>-13,5),e=(e+3864292196|0)^t,e=c1(e^e>>>16,2246822507),e=c1(e^e>>>13,3266489909),e=E2(e^e>>>16),e}function v6(t,e){return t^e+2654435769+(t<<6)+(t>>2)|0}var gc=function(t){function e(r){return r==null?Xk():a8(r)?r:Xk().withMutations(function(n){var o=Y0(r);pc(o.size),o.forEach(function(i){return n.add(i)})})}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.of=function(){return this(arguments)},e.fromKeys=function(n){return this(lu(n).keySeq())},e.prototype.toString=function(){return this.__toString("OrderedSet {","}")},e}(D2);gc.isOrderedSet=a8;var zg=gc.prototype;zg[K0]=!0;zg.zip=ev.zip;zg.zipWith=ev.zipWith;zg.zipAll=ev.zipAll;zg.__empty=Xk;zg.__make=m8;function m8(t,e){var r=Object.create(zg);return r.size=t?t.size:0,r._map=t,r.__ownerID=e,r}var b6;function Xk(){return b6||(b6=m8(u1()))}function Ppe(t){if(Q0(t))throw new Error("Can not call `Record` with an immutable Record as default values. Use a plain javascript object instead.");if(um(t))throw new Error("Can not call `Record` with an immutable Collection as default values. Use a plain javascript object instead.");if(t===null||typeof t!="object")throw new Error("Can not call `Record` with a non-object as default values. Use a plain javascript object instead.")}var Aa=function(e,r){var n;Ppe(e);var o=function(s){var l=this;if(s instanceof o)return s;if(!(this instanceof o))return new o(s);if(!n){n=!0;var c=Object.keys(e),u=i._indices={};i._name=r,i._keys=c,i._defaultValues=e;for(var d=0;d<c.length;d++){var m=c[d];u[m]=d,i[m]?typeof console=="object"&&console.warn&&console.warn("Cannot define "+CM(this)+' with property "'+m+'" since that property name is part of the Record API.'):Epe(i,m)}}return this.__ownerID=void 0,this._values=mm().withMutations(function(p){p.setSize(l._keys.length),lu(s).forEach(function(h,f){p.set(l._indices[f],h===l._defaultValues[f]?void 0:h)})}),this},i=o.prototype=Object.create(mo);return i.constructor=o,r&&(o.displayName=r),o};Aa.prototype.toString=function(){for(var e=CM(this)+" { ",r=this._keys,n,o=0,i=r.length;o!==i;o++)n=r[o],e+=(o?", ":"")+n+": "+f1(this.get(n));return e+" }"};Aa.prototype.equals=function(e){return this===e||Q0(e)&&X0(this).equals(X0(e))};Aa.prototype.hashCode=function(){return X0(this).hashCode()};Aa.prototype.has=function(e){return this._indices.hasOwnProperty(e)};Aa.prototype.get=function(e,r){if(!this.has(e))return r;var n=this._indices[e],o=this._values.get(n);return o===void 0?this._defaultValues[e]:o};Aa.prototype.set=function(e,r){if(this.has(e)){var n=this._values.set(this._indices[e],r===this._defaultValues[e]?void 0:r);if(n!==this._values&&!this.__ownerID)return SM(this,n)}return this};Aa.prototype.remove=function(e){return this.set(e)};Aa.prototype.clear=function(){var e=this._values.clear().setSize(this._keys.length);return this.__ownerID?this:SM(this,e)};Aa.prototype.wasAltered=function(){return this._values.wasAltered()};Aa.prototype.toSeq=function(){return X0(this)};Aa.prototype.toJS=function(){return S2(this)};Aa.prototype.entries=function(){return this.__iterator(su)};Aa.prototype.__iterator=function(e,r){return X0(this).__iterator(e,r)};Aa.prototype.__iterate=function(e,r){return X0(this).__iterate(e,r)};Aa.prototype.__ensureOwner=function(e){if(e===this.__ownerID)return this;var r=this._values.__ensureOwner(e);return e?SM(this,r,e):(this.__ownerID=e,this._values=r,this)};Aa.isRecord=Q0;Aa.getDescriptiveName=CM;var mo=Aa.prototype;mo[E6]=!0;mo[b1]=mo.remove;mo.deleteIn=mo.removeIn=sM;mo.getIn=u8;mo.hasIn=ws.hasIn;mo.merge=Y6;mo.mergeWith=Q6;mo.mergeIn=mM;mo.mergeDeep=$6;mo.mergeDeepWith=Z6;mo.mergeDeepIn=pM;mo.setIn=aM;mo.update=lM;mo.updateIn=cM;mo.withMutations=C1;mo.asMutable=T1;mo.asImmutable=w1;mo[_2]=mo.entries;mo.toJSON=mo.toObject=ws.toObject;mo.inspect=mo.toSource=function(){return this.toString()};function SM(t,e,r){var n=Object.create(Object.getPrototypeOf(t));return n._values=e,n.__ownerID=r,n}function CM(t){return t.constructor.displayName||t.constructor.name||"Record"}function X0(t){return Zk(t._keys.map(function(e){return[e,t.get(e)]}))}function Epe(t,e){try{Object.defineProperty(t,e,{get:function(){return this.get(e)},set:function(r){iM(this.__ownerID,"Cannot set on an immutable record."),this.set(e,r)}})}catch{}}var Gi;(function(t){function e(o){let i={create(a){return{action:i,params:a}},id:vo.create22(),definition:o,createDefaultParams(a,s){return o.params?g.getDefaultValues(o.params(a,s)):{}}};return i}t.create=e;function r(o){let i=o.definition;return e({from:i.from,display:i.display,params:i.params,isApplicable:o.definition.isApplicable?(a,s,l)=>o.definition.isApplicable(a,l):void 0,run({cell:a,state:s,params:l}){let c=s.build().to(a.transform.ref).apply(o,l);return s.updateTree(c)}})}t.fromTransformer=r;let n;(function(o){function i(a){return s=>e(w({from:a.from instanceof Array?a.from:a.from?[a.from]:[],display:typeof a.display=="string"?{name:a.display}:a.display?a.display:{name:"Unnamed State Action"},params:typeof a.params=="object"?()=>a.params:a.params?a.params:void 0,isApplicable:a.isApplicable},typeof s=="function"?{run:s}:s))}o.build=a=>i(a)})(n=t.Builder||(t.Builder={})),t.build=n.build})(Gi||(Gi={}));var Se;(function(t){function e(f,b,v){return f.definition.params?f.definition.params(b,v):{}}t.getParamDefinition=e;function r(f){return!!f&&typeof f.toAction=="function"&&typeof f.apply=="function"}t.is=r;let n;(function(f){f[f.Unchanged=0]="Unchanged",f[f.Updated=1]="Updated",f[f.Recreate=2]="Recreate",f[f.Null=3]="Null"})(n=t.UpdateResult||(t.UpdateResult={}));let o=new Map,i=new Map;function a(f){for(let b of f.definition.from)i.has(b.type)?i.get(b.type).push(f):i.set(b.type,[f])}function s(){return Array.from(o.values())}t.getAll=s;function l(f){let b=o.get(f);if(!b)throw new Error(`A transformer with signature '${f}' is not registered.`);return b}t.get=l;function c(f){return i.get(f)||[]}t.fromType=c;function u(f,b){let{name:v}=b,x=`${f}.${v}`;if(o.has(x))throw new Error(`A transform with id '${v}' is already registered. Please pick a unique identifier for your transforms and/or register them only once. This is to ensure that transforms can be serialized and replayed.`);let S={apply(T,E,_){return kt.create(T,S,E,_)},toAction(){return Gi.fromTransformer(S)},namespace:f,id:x,definition:b,createDefaultParams(T,E){return b.params?g.getDefaultValues(b.params(T,E)):{}}};return o.set(x,S),a(S),S}t.create=u;function d(f){return b=>u(f,b)}t.factory=d;function m(f){return p.build(f)}t.builderFactory=m;let p;(function(f){function b(x,S){return T=>u(x,w({name:S.name,from:S.from instanceof Array?S.from:[S.from],to:S.to instanceof Array?S.to:[S.to],display:typeof S.display=="string"?{name:S.display}:S.display?S.display:{name:m0(S.name.replace(/[-]/g," "))},params:typeof S.params=="object"?()=>S.params:S.params?S.params:void 0,isDecorator:S.isDecorator},T))}function v(x){return S=>b(x,S)}f.build=v})(p=t.Builder||(t.Builder={}));function h(f){return p.build(f)}t.build=h,t.ROOT=u("build-in",{name:"root",from:[],to:[],display:{name:"Root",description:"For internal use."},apply(){throw new Error("should never be applied")},update(){return n.Unchanged}})})(Se||(Se={}));var kt;(function(t){t.RootRef="-=root=-";function e(b,v){return!!b.isHidden!=!!v.isHidden||!!b.isCollapsed!=!!v.isCollapsed||!!b.isGhost!=!!v.isGhost||!!b.isLocked!=!!v.isLocked}t.areStatesEqual=e;function r(b,v){return v?typeof v.isCollapsed<"u"&&b.isCollapsed!==v.isCollapsed||typeof v.isHidden<"u"&&b.isHidden!==v.isHidden||typeof v.isGhost<"u"&&b.isGhost!==v.isGhost||typeof v.isLocked<"u"&&b.isLocked!==v.isLocked:!1}t.isStateChange=r;function n(b,v){if(!v)return!1;let x=!1;for(let S of Object.keys(v)){let T=v[S],E=b[S];!!T!=!!E&&(x=!0,b[S]=T)}return x}t.assignState=n;function o(b,v){if(!v)return!1;let x=!1;for(let S of Object.keys(v)){let T=v[S],E=b[S];!!T!=!!E&&(x=!0,T!==void 0?b[S]=T:delete b[S])}for(let S of Object.keys(b)){let T=v[S],E=b[S];!!T!=!!E&&(x=!0,T!==void 0?b[S]=T:delete b[S])}return x}t.syncState=o;function i(b,v,x,S){let T=S&&S.ref?S.ref:vo.create22(),E;return S&&S.tags&&(E=typeof S.tags=="string"?[S.tags]:S.tags,E.length===0?E=void 0:E.sort()),{parent:b,transformer:v,state:S?.state||{},tags:E,ref:T,dependsOn:S&&S.dependsOn,params:x,version:vo.create22()}}t.create=i;function a(b,v){return U(w({},b),{params:v,version:vo.create22()})}t.withParams=a;function s(b,v){return v?U(w({},b),{state:w(w({},b.state),v)}):b}t.withState=s;function l(b,v){let x;return v&&(x=typeof v=="string"?[v]:v,x.length===0?x=void 0:x.sort()),U(w({},b),{tags:x,version:vo.create22()})}t.withTags=l;function c(b,v){return U(w({},b),{parent:v,version:vo.create22()})}t.withParent=c;function u(b){return i(t.RootRef,Se.ROOT,{},{ref:t.RootRef,state:b})}t.createRoot=u;function d(b,v){return b.tags?b.tags.indexOf(v)>=0:!1}t.hasTag=d;function m(b,v){if(!b.tags)return typeof v!="string"&&v.length===0;if(typeof v=="string")return d(b,v);for(let x of v)if(b.tags.indexOf(x)<0)return!1;return!0}t.hasTags=m;function p(b){return b}function h(b){let v=b.transformer.definition.customSerialization?b.transformer.definition.customSerialization.toJSON:p,x;for(let S of Object.keys(b.state))b.state[S]&&(x||(x={}),x[S]=!0);return{parent:b.parent,transformer:b.transformer.id,params:b.params?v(b.params):void 0,state:x,tags:b.tags,ref:b.ref,dependsOn:b.dependsOn,version:b.version}}t.toJSON=h;function f(b){let v=Se.get(b.transformer),x=v.definition.customSerialization?v.definition.customSerialization.fromJSON:p;return{parent:b.parent,transformer:v,params:b.params?x(b.params):void 0,state:b.state||{},tags:b.tags,ref:b.ref,dependsOn:b.dependsOn,version:b.version}}t.fromJSON=f})(kt||(kt={}));var P1=class{get childMutations(){return this._childMutations?this._childMutations:(this._childMutations=new Map,this._childMutations)}get dependencyMutations(){return this._dependencyMutations?this._dependencyMutations:(this._dependencyMutations=new Map,this._dependencyMutations)}changeNodes(){this.changedNodes||(this.changedNodes=!0,this.transforms=this.transforms.asMutable())}changeChildren(){this.changedChildren||(this.changedChildren=!0,this.children=this.children.asMutable())}changeDependencies(){this.changedDependencies||(this.changedDependencies=!0,this.dependencies=this.dependencies.asMutable())}get root(){return this.transforms.get(kt.RootRef)}asTransient(){return this.asImmutable().asTransient()}addChild(e,r){if(this.changeChildren(),this.childMutations.has(e))this.childMutations.get(e).add(r);else{let n=this.children.get(e).asMutable();n.add(r),this.children.set(e,n),this.childMutations.set(e,n)}}removeChild(e,r){if(this.changeChildren(),this.childMutations.has(e))this.childMutations.get(e).remove(r);else{let n=this.children.get(e).asMutable();n.remove(r),this.children.set(e,n),this.childMutations.set(e,n)}}clearRoot(){let e=kt.RootRef;if(this.children.get(e).size===0)return;this.changeChildren();let r=gc();this.children.set(e,r),this.childMutations.set(e,r)}mutateDependency(e,r,n){let o=this.dependencyMutations.get(e);if(!o){let i=this.dependencies.get(e);if(!i&&n==="remove")return;this.changeDependencies(),o=i?i.asMutable():gc().asMutable(),this.dependencyMutations.set(e,o),this.dependencies.set(e,o)}n==="add"?o.add(r):o.remove(r)}changeParent(e,r){A2(this.transforms,e);let n=this.transforms.get(e);this.removeChild(n.parent,e),this.addChild(r,e),this.changeNodes(),this.transforms.set(e,kt.withParent(n,r))}add(e){let r=e.ref;this.transforms.has(e.ref)&&this.transforms.get(e.ref).parent!==e.parent&&Ape(e.ref);let n=this.children.get(e.parent);if(n||kpe(e.parent),n.has(e.ref)||this.addChild(e.parent,e.ref),this.children.has(e.ref)||(this.changedChildren||(this.changedChildren=!0,this.children=this.children.asMutable()),this.children.set(e.ref,gc())),this.changeNodes(),this.transforms.set(r,e),e.dependsOn)for(let o of e.dependsOn)this.mutateDependency(o,r,"add");return this}setParams(e,r){A2(this.transforms,e);let n=this.transforms.get(e);return lf(n.params,r)?!1:(this.changedNodes||(this.changedNodes=!0,this.transforms=this.transforms.asMutable()),this.transforms.set(n.ref,kt.withParams(n,r)),!0)}setTags(e,r){A2(this.transforms,e);let n=this.transforms.get(e),o=kt.withParams(n,r);return v0(n.tags,o.tags)?!1:(this.changedNodes||(this.changedNodes=!0,this.transforms=this.transforms.asMutable()),this.transforms.set(n.ref,o),!0)}assignState(e,r){A2(this.transforms,e);let n=this.transforms.get(e);if(this._stateUpdates&&this._stateUpdates.has(e))return kt.assignState(n.state,r),n;{this._stateUpdates||(this._stateUpdates=new Set),this._stateUpdates.add(n.ref),this.changeNodes();let o=kt.withState(n,r);return this.transforms.set(e,o),o}}remove(e){let r=this.transforms.get(e);if(!r)return[];let n=Nn.subtreePostOrder(this,r);if(e===kt.RootRef){if(n.pop(),n.length===0)return n;this.clearRoot()}else{if(n.length===0)return n;this.removeChild(r.parent,r.ref)}this.changeNodes(),this.changeChildren();for(let i of n)this.transforms.delete(i.ref),this.children.delete(i.ref),this._childMutations&&this._childMutations.delete(i.ref);let o=[];for(let i of n){if(i.dependsOn)for(let a of i.dependsOn)this.transforms.has(a)&&this.mutateDependency(a,i.ref,"remove");if(this.dependencies.has(i.ref)){let a=this.dependencies.get(i.ref).toArray();this.changeDependencies(),this.dependencies.delete(i.ref),this._dependencyMutations&&this._dependencyMutations.delete(i.ref);for(let s of a)if(this.transforms.has(s))for(let l of this.remove(s))o[o.length]=l}}for(let i of o)n[n.length]=i;return n}asImmutable(){return!this.changedNodes&&!this.changedChildren&&!this._childMutations?this.tree:(this._childMutations&&this._childMutations.forEach(Ipe,this.children),this._dependencyMutations&&this._dependencyMutations.forEach(Dpe,this.dependencies),Nn.create(this.changedNodes?this.transforms.asImmutable():this.transforms,this.changedChildren?this.children.asImmutable():this.children,this.changedDependencies?this.dependencies.asImmutable():this.dependencies))}constructor(e){this.tree=e,this.transforms=this.tree.transforms,this.children=this.tree.children,this.dependencies=this.tree.dependencies,this.changedNodes=!1,this.changedChildren=!1,this.changedDependencies=!1,this._childMutations=void 0,this._dependencyMutations=void 0,this._stateUpdates=void 0}};function Ipe(t,e){this.set(e,t.asImmutable())}function Dpe(t,e){t.size===0?this.delete(e):this.set(e,t.asImmutable())}function Ape(t){throw new Error(`Transform '${t}' is already present in the tree.`)}function kpe(t){throw new Error(`Parent '${t}' must be present in the tree.`)}function A2(t,e){if(!t.has(e))throw new Error(`Node '${e}' is not present in the tree.`)}var Nn;(function(t){class e{get root(){return this.transforms.get(kt.RootRef)}asTransient(){return new P1(this)}constructor(T,E,_){this.transforms=T,this.children=E,this.dependencies=_}}function r(S){let T=S||kt.createRoot();return n(yc([[T.ref,T]]),yc([[T.ref,gc()]]),yc())}t.createEmpty=r;function n(S,T,E){return new e(S,T,E)}t.create=n;function o(S){i(this,this.tree.transforms.get(S))}function i(S,T){let E=S.tree.children.get(T.ref);E&&E.size&&E.forEach(o,S),S.f(T,S.tree,S.state)}function a(S,T,E,_){let D={tree:S,state:E,f:_};return i(D,T),D.state}t.doPostOrder=a;function s(S){l(this,this.tree.transforms.get(S))}function l(S,T){let E=S.f(T,S.tree,S.state);if(typeof E=="boolean"&&!E)return;let _=S.tree.children.get(T.ref);_&&_.size&&_.forEach(s,S)}function c(S,T,E,_){let D={tree:S,state:E,f:_};return l(D,T),D.state}t.doPreOrder=c;function u(S,T,E){E.push(S)}function d(S,T){return a(S,T,[],u)}t.subtreePostOrder=d;function m(S,T,E){E.push(kt.toJSON(S))}function p(S){let T=[];return c(S,S.root,T,m),{transforms:T}}t.toJSON=p;function h(S){let T=yc().asMutable(),E=yc().asMutable(),_=yc().asMutable();for(let P of S.transforms){let A=kt.fromJSON(P);T.set(A.ref,A),E.has(A.ref)||E.set(A.ref,gc().asMutable()),A.ref!==A.parent&&E.get(A.parent).add(A.ref)}let D=new Set;for(let P of S.transforms){let A=P.ref;if(E.set(A,E.get(A).asImmutable()),!!P.dependsOn)for(let I of P.dependsOn)D.add(I),_.has(I)?_.get(I).add(A):_.set(I,gc([A]).asMutable())}return D.forEach(P=>{_.set(P,_.get(P).asImmutable())}),n(T.asImmutable(),E.asImmutable(),_.asImmutable())}t.fromJSON=h;function f(S){console.log({tr:S.transforms.keySeq().toArray(),tr1:S.transforms.valueSeq().toArray().map(T=>T.ref),ch:S.children.keySeq().toArray()})}t.dump=f;function b(S,T,E){if(T===E)return!0;let D=S.children.get(T).values();for(;;){let P=D.next();if(P.done)return!1;if(b(S,P.value,E))return!0}}function v(S,T,E){return!S.transforms.has(T)||!S.transforms.has(E)?!1:b(S,T,E)}t.subtreeHasRef=v;function x(S,T){let E=S.children.get(T);if(E.size!==1)return T;let _=S.transforms.get(E.first());return _.transformer.definition.isDecorator?x(S,_.ref):T}t.getDecoratorRoot=x})(Nn||(Nn={}));var lt;(function(t){function e($,ae){return r($)(ae)}t.select=e;function r($){let ae=$||c.root,Z;return o(ae)?Z=ae.compile():n(ae)?Z=c.byValue(ae).compile():i(ae)?Z=ae:Z=c.byRef(ae).compile(),Z}t.compile=r;function n($){return $.transform!==void 0&&$.status!==void 0}function o($){return $.compile!==void 0}function i($){return typeof $=="function"}let a={select($){return e(this,$||this.state)}};function s($,ae){a[$]=function(...Z){return ae.call(void 0,this,...Z)}}function l($){return Object.create(a,{compile:{writable:!1,configurable:!1,value:$}})}let c;(function($){$.root=l(()=>Zt=>[Zt.cells.get(Zt.tree.root.ref)]);function ae(...Zt){return l(()=>oe=>{let De=[];for(let Le of Zt){let Qe=oe.cells.get(Le);Qe&&De.push(Qe)}return De})}$.byRef=ae;function Z(...Zt){return l(()=>oe=>Zt)}$.byValue=Z;function se(Zt,oe=kt.RootRef){return l(()=>De=>{let Le={roots:[],cells:De.cells,type:Zt.type};return Nn.doPreOrder(De.tree,De.tree.transforms.get(oe),Le,je),Le.roots})}$.rootsOfType=se;function Me(Zt,oe=kt.RootRef){return l(()=>De=>{let Le={ret:[],cells:De.cells,type:Zt.type};return Nn.doPreOrder(De.tree,De.tree.transforms.get(oe),Le,gt),Le.ret})}$.ofType=Me;function be(Zt,oe=kt.RootRef){return l(()=>De=>{let Le={ret:[],cells:De.cells,t:Zt};return Nn.doPreOrder(De.tree,De.tree.transforms.get(oe),Le,fr),Le.ret})}$.ofTransformer=be;function _e(Zt,oe=kt.RootRef){return l(()=>De=>{let Le={ret:[],cells:De.cells,t:Zt};return Nn.doPreOrder(De.tree,De.tree.transforms.get(oe),Le,Nr),Le.ret})}$.ofTransformerWithError=_e;function je(Zt,oe,De){let Le=De.cells.get(Zt.ref);return Le&&Le.obj&&Le.obj.type===De.type?(De.roots.push(Le),!1):!0}function gt(Zt,oe,De){let Le=De.cells.get(Zt.ref);return Le&&Le.obj&&Le.obj.type===De.type&&De.ret.push(Le),!0}function fr(Zt,oe,De){let Le=De.cells.get(Zt.ref);return Le&&Le.obj&&Le.transform.transformer===De.t&&De.ret.push(Le),!0}function Nr(Zt,oe,De){let Le=De.cells.get(Zt.ref);return Le&&Le.status==="error"&&Le.transform.transformer===De.t&&De.ret.push(Le),!0}})(c=t.Generators||(t.Generators={})),s("flatMap",u);function u($,ae){let Z=r($);return l(()=>se=>{let Me=[];for(let be of Z(se))for(let _e of ae(be,se))Me.push(_e);return Me})}t.flatMap=u,s("mapObject",d);function d($,ae){let Z=r($);return l(()=>se=>{let Me=[];for(let be of Z(se)){let _e=ae(be,se);_e&&Me.push(_e)}return Me})}t.mapObject=d,s("unique",m);function m($){let ae=r($);return l(()=>Z=>{let se=new Set,Me=[];for(let be of ae(Z))be&&(se.has(be.transform.ref)||(se.add(be.transform.ref),Me.push(be)));return Me})}t.unique=m,s("first",p);function p($){let ae=r($);return l(()=>Z=>{let se=ae(Z);return se.length?[se[0]]:[]})}t.first=p,s("filter",h);function h($,ae){return u($,Z=>ae(Z)?[Z]:[])}t.filter=h,s("withStatus",f);function f($,ae){return h($,Z=>Z.status===ae)}t.withStatus=f,s("withTag",b);function b($,ae){return h($,Z=>!!Z.transform.tags&&Z.transform.tags.indexOf(ae)>=0)}t.withTag=b,s("subtree",v);function v($){return u($,(ae,Z)=>{let se=[];return Nn.doPreOrder(Z.tree,Z.tree.transforms.get(ae.transform.ref),se,(Me,be,_e)=>{_e.push(Me.ref)}),se.map(Me=>Z.cells.get(Me))})}t.subtree=v,s("children",x);function x($){return u($,(ae,Z)=>{let se=[];return Z.tree.children.get(ae.transform.ref).forEach(Me=>se.push(Z.cells.get(Me))),se})}t.children=x,s("ofType",S);function S($,ae){return h($,Z=>Z.obj?Z.obj.type===ae.type:!1)}t.ofType=S,s("ancestor",T);function T($,ae){return m(d($,(Z,se)=>M(se.tree,se.cells,Z.transform.ref,ae)))}t.ancestor=T,s("ancestorOfType",E);function E($,ae){return m(d($,(Z,se)=>F(se.tree,se.cells,Z.transform.ref,ae)))}t.ancestorOfType=E,s("ancestorWithTransformer",_);function _($,ae){return m(d($,(Z,se)=>B(se.tree,se.cells,Z.transform.ref,ae)))}t.ancestorWithTransformer=_,s("withTransformer",D);function D($,ae){return h($,Z=>Z.transform.transformer===ae)}t.withTransformer=D,s("root",P);function P($,ae){return m(d($,(Z,se)=>R(se.tree,se.cells,Z.transform.ref,ae)))}t.root=P,s("rootOfType",A);function A($,ae){return m(d($,(Z,se)=>G(se.tree,se.cells,Z.transform.ref,ae)))}t.rootOfType=A,s("parent",I);function I($){return m(d($,(ae,Z)=>Z.cells.get(Z.tree.transforms.get(ae.transform.ref).parent)))}t.parent=I;function k($,ae,Z,se,Me){let be=$.transforms.get(Z),_e;for(;;){be=$.transforms.get(be.parent);let je=ae.get(be.ref);if(je.obj&&se(je)&&(_e=je,Me)||be.ref===kt.RootRef)return _e}}function M($,ae,Z,se){return k($,ae,Z,se,!0)}t.findAncestor=M;function R($,ae,Z,se){return k($,ae,Z,se,!1)}t.findRoot=R;function B($,ae,Z,se){return M($,ae,Z,Array.isArray(se)?Me=>se.indexOf(Me.transform.transformer)>=0:Me=>Me.transform.transformer===se)}t.findAncestorWithTransformer=B;function F($,ae,Z,se){return M($,ae,Z,V(se))}t.findAncestorOfType=F;function G($,ae,Z,se){return R($,ae,Z,V(se))}t.findRootOfType=G;function V($){return Array.isArray($)?ae=>{for(let Z of $)if(Z.type===ae.obj.type)return!0}:ae=>ae.obj.type===$.type}function H($,ae,Z){return Nn.doPreOrder($,$.transforms.get(ae),{refs:{},tags:Z},Q).refs}t.findUniqueTagsInSubtree=H;function Q($,ae,Z){if($.tags){for(let se of $.tags)if(Z.tags.has(se)){Z.refs[se]=$.ref;break}}return!0}function L($,ae,Z){return Nn.doPreOrder($,$.transforms.get(ae),{ref:void 0,tag:Z},Y).ref}t.findTagInSubtree=L;function Y($,ae,Z){return $.tags&&$.tags.indexOf(Z.tag)>=0?(Z.ref=$.ref,!1):!0}function j($,ae,Z){return Nn.doPreOrder($,$.transforms.get(ae),{refs:[],tags:Z},O).refs}t.findWithAllTags=j;function O($,ae,Z){if($.tags){let se=Z.tags.size,Me=0;for(let be of $.tags)if(Z.tags.has(be)&&(Me++,Me===se)){Z.refs.push($);break}}else Z.tags.size===0&&Z.refs.push($)}function J($,ae,Z){if($.transforms.get(ae).transformer===Z)return $.cells.get(ae);let Me=$.tree.children.get(ae);if(Me.size!==1)return;let be=Me.first();if($.transforms.get(be).transformer.definition.isDecorator)return J($,be,Z)}t.tryFindDecorator=J})(lt||(lt={}));var _s;(function(t){function e(){let r=new TM,n=()=>r.create();return n.dispose=()=>r.dispose(),n.behavior=o=>r.behavior(o),n}t.create=e})(_s||(_s={}));var TM=class{constructor(){this._eventList=[],this._disposed=!1}create(){let e=new ln;return this._eventList.push(e),e}behavior(e){let r=new da(e);return this._eventList.push(r),r}dispose(){if(!this._disposed){for(let e of this._eventList)e.complete();this._disposed=!0}}};var v8=Symbol.for("immer-nothing"),p8=Symbol.for("immer-draftable"),vc=Symbol.for("immer-state");function xd(t,...e){throw new Error(`[Immer] minified error nr: ${t}. Full error at: https://bit.ly/3cXEKWf`)}var tv=Object.getPrototypeOf;function rv(t){return!!t&&!!t[vc]}function Gg(t){return t?b8(t)||Array.isArray(t)||!!t[p8]||!!t.constructor?.[p8]||B2(t)||O2(t):!1}var Mpe=Object.prototype.constructor.toString();function b8(t){if(!t||typeof t!="object")return!1;let e=tv(t);if(e===null)return!0;let r=Object.hasOwnProperty.call(e,"constructor")&&e.constructor;return r===Object?!0:typeof r=="function"&&Function.toString.call(r)===Mpe}function k2(t,e){L2(t)===0?Reflect.ownKeys(t).forEach(r=>{e(r,t[r],t)}):t.forEach((r,n)=>e(n,r,t))}function L2(t){let e=t[vc];return e?e.type_:Array.isArray(t)?1:B2(t)?2:O2(t)?3:0}function PM(t,e){return L2(t)===2?t.has(e):Object.prototype.hasOwnProperty.call(t,e)}function x8(t,e,r){let n=L2(t);n===2?t.set(e,r):n===3?t.add(r):t[e]=r}function Rpe(t,e){return t===e?t!==0||1/t===1/e:t!==t&&e!==e}function B2(t){return t instanceof Map}function O2(t){return t instanceof Set}function Ug(t){return t.copy_||t.base_}function EM(t,e){if(B2(t))return new Map(t);if(O2(t))return new Set(t);if(Array.isArray(t))return Array.prototype.slice.call(t);let r=b8(t);if(e===!0||e==="class_only"&&!r){let n=Object.getOwnPropertyDescriptors(t);delete n[vc];let o=Reflect.ownKeys(n);for(let i=0;i<o.length;i++){let a=o[i],s=n[a];s.writable===!1&&(s.writable=!0,s.configurable=!0),(s.get||s.set)&&(n[a]={configurable:!0,writable:!0,enumerable:s.enumerable,value:t[a]})}return Object.create(tv(t),n)}else{let n=tv(t);if(n!==null&&r)return w({},t);let o=Object.create(n);return Object.assign(o,t)}}function MM(t,e=!1){return F2(t)||rv(t)||!Gg(t)||(L2(t)>1&&(t.set=t.add=t.clear=t.delete=Lpe),Object.freeze(t),e&&Object.entries(t).forEach(([r,n])=>MM(n,!0))),t}function Lpe(){xd(2)}function F2(t){return Object.isFrozen(t)}var Bpe={};function jg(t){let e=Bpe[t];return e||xd(0,t),e}var E1;function S8(){return E1}function Ope(t,e){return{drafts_:[],parent_:t,immer_:e,canAutoFreeze_:!0,unfinalizedDrafts_:0}}function f8(t,e){e&&(jg("Patches"),t.patches_=[],t.inversePatches_=[],t.patchListener_=e)}function IM(t){DM(t),t.drafts_.forEach(Fpe),t.drafts_=null}function DM(t){t===E1&&(E1=t.parent_)}function h8(t){return E1=Ope(E1,t)}function Fpe(t){let e=t[vc];e.type_===0||e.type_===1?e.revoke_():e.revoked_=!0}function g8(t,e){e.unfinalizedDrafts_=e.drafts_.length;let r=e.drafts_[0];return t!==void 0&&t!==r?(r[vc].modified_&&(IM(e),xd(4)),Gg(t)&&(t=M2(e,t),e.parent_||R2(e,t)),e.patches_&&jg("Patches").generateReplacementPatches_(r[vc].base_,t,e.patches_,e.inversePatches_)):t=M2(e,r,[]),IM(e),e.patches_&&e.patchListener_(e.patches_,e.inversePatches_),t!==v8?t:void 0}function M2(t,e,r){if(F2(e))return e;let n=e[vc];if(!n)return k2(e,(o,i)=>y8(t,n,e,o,i,r)),e;if(n.scope_!==t)return e;if(!n.modified_)return R2(t,n.base_,!0),n.base_;if(!n.finalized_){n.finalized_=!0,n.scope_.unfinalizedDrafts_--;let o=n.copy_,i=o,a=!1;n.type_===3&&(i=new Set(o),o.clear(),a=!0),k2(i,(s,l)=>y8(t,n,o,s,l,r,a)),R2(t,o,!1),r&&t.patches_&&jg("Patches").generatePatches_(n,r,t.patches_,t.inversePatches_)}return n.copy_}function y8(t,e,r,n,o,i,a){if(rv(o)){let s=i&&e&&e.type_!==3&&!PM(e.assigned_,n)?i.concat(n):void 0,l=M2(t,o,s);if(x8(r,n,l),rv(l))t.canAutoFreeze_=!1;else return}else a&&r.add(o);if(Gg(o)&&!F2(o)){if(!t.immer_.autoFreeze_&&t.unfinalizedDrafts_<1)return;M2(t,o),(!e||!e.scope_.parent_)&&typeof n!="symbol"&&Object.prototype.propertyIsEnumerable.call(r,n)&&R2(t,o)}}function R2(t,e,r=!1){!t.parent_&&t.immer_.autoFreeze_&&t.canAutoFreeze_&&MM(e,r)}function Npe(t,e){let r=Array.isArray(t),n={type_:r?1:0,scope_:e?e.scope_:S8(),modified_:!1,finalized_:!1,assigned_:{},parent_:e,base_:t,draft_:null,copy_:null,revoke_:null,isManual_:!1},o=n,i=RM;r&&(o=[n],i=I1);let{revoke:a,proxy:s}=Proxy.revocable(o,i);return n.draft_=s,n.revoke_=a,s}var RM={get(t,e){if(e===vc)return t;let r=Ug(t);if(!PM(r,e))return Vpe(t,r,e);let n=r[e];return t.finalized_||!Gg(n)?n:n===wM(t.base_,e)?(_M(t),t.copy_[e]=kM(n,t)):n},has(t,e){return e in Ug(t)},ownKeys(t){return Reflect.ownKeys(Ug(t))},set(t,e,r){let n=C8(Ug(t),e);if(n?.set)return n.set.call(t.draft_,r),!0;if(!t.modified_){let o=wM(Ug(t),e),i=o?.[vc];if(i&&i.base_===r)return t.copy_[e]=r,t.assigned_[e]=!1,!0;if(Rpe(r,o)&&(r!==void 0||PM(t.base_,e)))return!0;_M(t),AM(t)}return t.copy_[e]===r&&(r!==void 0||e in t.copy_)||Number.isNaN(r)&&Number.isNaN(t.copy_[e])||(t.copy_[e]=r,t.assigned_[e]=!0),!0},deleteProperty(t,e){return wM(t.base_,e)!==void 0||e in t.base_?(t.assigned_[e]=!1,_M(t),AM(t)):delete t.assigned_[e],t.copy_&&delete t.copy_[e],!0},getOwnPropertyDescriptor(t,e){let r=Ug(t),n=Reflect.getOwnPropertyDescriptor(r,e);return n&&{writable:!0,configurable:t.type_!==1||e!=="length",enumerable:n.enumerable,value:r[e]}},defineProperty(){xd(11)},getPrototypeOf(t){return tv(t.base_)},setPrototypeOf(){xd(12)}},I1={};k2(RM,(t,e)=>{I1[t]=function(){return arguments[0]=arguments[0][0],e.apply(this,arguments)}});I1.deleteProperty=function(t,e){return I1.set.call(this,t,e,void 0)};I1.set=function(t,e,r){return RM.set.call(this,t[0],e,r,t[0])};function wM(t,e){let r=t[vc];return(r?Ug(r):t)[e]}function Vpe(t,e,r){let n=C8(e,r);return n?"value"in n?n.value:n.get?.call(t.draft_):void 0}function C8(t,e){if(!(e in t))return;let r=tv(t);for(;r;){let n=Object.getOwnPropertyDescriptor(r,e);if(n)return n;r=tv(r)}}function AM(t){t.modified_||(t.modified_=!0,t.parent_&&AM(t.parent_))}function _M(t){t.copy_||(t.copy_=EM(t.base_,t.scope_.immer_.useStrictShallowCopy_))}var zpe=class{constructor(t){this.autoFreeze_=!0,this.useStrictShallowCopy_=!1,this.produce=(e,r,n)=>{if(typeof e=="function"&&typeof r!="function"){let i=r;r=e;let a=this;return function(l=i,...c){return a.produce(l,u=>r.call(this,u,...c))}}typeof r!="function"&&xd(6),n!==void 0&&typeof n!="function"&&xd(7);let o;if(Gg(e)){let i=h8(this),a=kM(e,void 0),s=!0;try{o=r(a),s=!1}finally{s?IM(i):DM(i)}return f8(i,n),g8(o,i)}else if(!e||typeof e!="object"){if(o=r(e),o===void 0&&(o=e),o===v8&&(o=void 0),this.autoFreeze_&&MM(o,!0),n){let i=[],a=[];jg("Patches").generateReplacementPatches_(e,o,i,a),n(i,a)}return o}else xd(1,e)},this.produceWithPatches=(e,r)=>{if(typeof e=="function")return(a,...s)=>this.produceWithPatches(a,l=>e(l,...s));let n,o;return[this.produce(e,r,(a,s)=>{n=a,o=s}),n,o]},typeof t?.autoFreeze=="boolean"&&this.setAutoFreeze(t.autoFreeze),typeof t?.useStrictShallowCopy=="boolean"&&this.setUseStrictShallowCopy(t.useStrictShallowCopy)}createDraft(t){Gg(t)||xd(8),rv(t)&&(t=Upe(t));let e=h8(this),r=kM(t,void 0);return r[vc].isManual_=!0,DM(e),r}finishDraft(t,e){let r=t&&t[vc];(!r||!r.isManual_)&&xd(9);let{scope_:n}=r;return f8(n,e),g8(void 0,n)}setAutoFreeze(t){this.autoFreeze_=t}setUseStrictShallowCopy(t){this.useStrictShallowCopy_=t}applyPatches(t,e){let r;for(r=e.length-1;r>=0;r--){let o=e[r];if(o.path.length===0&&o.op==="replace"){t=o.value;break}}r>-1&&(e=e.slice(r+1));let n=jg("Patches").applyPatches_;return rv(t)?n(t,e):this.produce(t,o=>n(o,e))}};function kM(t,e){let r=B2(t)?jg("MapSet").proxyMap_(t,e):O2(t)?jg("MapSet").proxySet_(t,e):Npe(t,e);return(e?e.scope_:S8()).drafts_.push(r),r}function Upe(t){return rv(t)||xd(10,t),T8(t)}function T8(t){if(!Gg(t)||F2(t))return t;let e=t[vc],r;if(e){if(!e.modified_)return e.base_;e.finalized_=!0,r=EM(t,e.scope_.immer_.useStrictShallowCopy_)}else r=EM(t,!0);return k2(r,(n,o)=>{x8(r,n,T8(o))}),e&&(e.finalized_=!1),r}var bc=new zpe,ss=bc.produce,rXe=bc.produceWithPatches.bind(bc),w8=bc.setAutoFreeze.bind(bc),nXe=bc.setUseStrictShallowCopy.bind(bc),oXe=bc.applyPatches.bind(bc),iXe=bc.createDraft.bind(bc),aXe=bc.finishDraft.bind(bc);var Df;(function(t){function e(a){if(!a.state||a.state.tree===a.editInfo.sourceTree)return a.tree.asImmutable();let s=a.state.tree.asTransient();for(let l of a.actions)switch(l.kind){case"add":s.add(l.transform);break;case"update":s.setParams(l.ref,l.params);break;case"delete":s.remove(l.ref);break;case"insert":{let c=s.children.get(l.ref).toArray();s.add(l.transform);for(let u of c)s.changeParent(u,l.transform.ref);break}}return a.editInfo.sourceTree=a.tree,s.asImmutable()}function r(a){return!!a&&typeof a.getTree=="function"}t.is=r;function n(a){return!!a&&typeof a.getTree=="function"&&typeof a.ref=="string"}t.isTo=n;class o{get editInfo(){return this.state.editInfo}get currentTree(){return this.state.tree}to(s){let l=typeof s=="string"?s:V0.is(s)?s.transform.ref:s.ref;return new i(this.state,l,this)}toRoot(){return new i(this.state,this.state.tree.root.ref,this)}delete(s){let l=Fn.resolveRef(s);return!l||!this.state.tree.transforms.has(l)?this:(this.editInfo.count++,this.state.tree.remove(l),this.state.actions.push({kind:"delete",ref:l}),this)}getTree(){return e(this.state)}commit(s){if(!this.state.state)throw new Error("Cannot commit template tree");return this.state.state.runTask(this.state.state.updateTree(this,s))}constructor(s,l){this.state={state:l,tree:s.asTransient(),actions:[],editInfo:{applied:!1,sourceTree:s,count:0,lastUpdate:void 0}}}}t.Root=o;class i{get editInfo(){return this.state.editInfo}get selector(){return new z0(this.ref,this.state.state)}getApplyRoot(){return Nn.getDecoratorRoot(this.state.tree,this.ref)}apply(s,l,c){if(s.definition.isDecorator)return this.insert(s,l,c);let u=this.getApplyRoot(),d=s.apply(u,l,c);return this.state.tree.add(d),this.editInfo.count++,this.editInfo.lastUpdate=d.ref,this.state.actions.push({kind:"add",transform:d}),new i(this.state,d.ref,this.root)}applyOrUpdate(s,l,c,u){if(this.state.tree.transforms.has(s)){let d=this.to(s);return c&&d.update(c),d}else return this.apply(l,c,U(w({},u),{ref:s}))}applyOrUpdateTagged(s,l,c,u){if(l.definition.isDecorator)throw new Error("Can't use applyOrUpdateTagged on decorator transformers.");let d=this.getApplyRoot(),m=this.state.tree.children.get(d).values();for(;;){let h=m.next();if(h.done)break;let f=this.state.tree.transforms.get(h.value);if(f&&kt.hasTags(f,s)){let b=this.to(h.value);return b.updateTagged(c,_8(f.tags,s,u&&u.tags)),b}}let p=l.apply(d,c,U(w({},u),{tags:_8(s,u&&u.tags)}));return this.state.tree.add(p),this.editInfo.count++,this.editInfo.lastUpdate=p.ref,this.state.actions.push({kind:"add",transform:p}),new i(this.state,p.ref,this.root)}group(s,l,c){return this.apply(s,l,c)}insert(s,l,c){let u=this.state.tree.children.get(this.ref).toArray(),d=s.apply(this.ref,l,c);this.state.tree.add(d);for(let m of u)this.state.tree.changeParent(m,d.ref);return this.editInfo.count++,this.editInfo.lastUpdate=d.ref,this.state.actions.push({kind:"insert",ref:this.ref,transform:d}),new i(this.state,d.ref,this.root)}updateTagged(s,l){(this.state.tree.setParams(this.ref,s)||this.state.tree.setTags(this.ref,l))&&(this.editInfo.count++,this.editInfo.lastUpdate=this.ref,this.state.actions.push({kind:"update",ref:this.ref,params:s}))}update(s,l){let c;if(l){let u=this.state.tree.transforms.get(this.ref);c=ss(u.params,l)}else c=typeof s=="function"?ss(this.state.tree.transforms.get(this.ref).params,s):s;return this.state.tree.setParams(this.ref,c)&&(this.editInfo.count++,this.editInfo.lastUpdate=this.ref,this.state.actions.push({kind:"update",ref:this.ref,params:c})),this.root}to(s){return this.root.to(s)}toRoot(){return this.root.toRoot()}delete(s){return this.root.delete(s)}getTree(){return e(this.state)}commit(s){if(!this.state.state)throw new Error("Cannot commit template tree");return this.state.state.runTask(this.state.state.updateTree(this,s))}constructor(s,l,c){if(this.state=s,this.root=c,this.ref=l,!this.state.tree.transforms.has(l))throw new Error(`Could not find node '${l}'.`)}}t.To=i})(Df||(Df={}));function _8(...t){let e,r=[];for(let n of t)if(n)if(e||(e=new Set),typeof n=="string"){if(e.has(n))continue;e.add(n),r.push(n)}else for(let o of n)e.has(o)||(e.add(o),r.push(o));return r}var N2=class{constructor(){this.ev=_s.create(),this.actions=new Map,this.fromTypeIndex=new Map,this.events={added:this.ev(),removed:this.ev()}}add(e){let r=Se.is(e)?e.toAction():e;if(this.actions.has(r.id))return this;this.actions.set(r.id,r);for(let n of r.definition.from)this.fromTypeIndex.has(n.type)?this.fromTypeIndex.get(n.type).push(r):this.fromTypeIndex.set(n.type,[r]);return this.events.added.next(void 0),this}remove(e){let r=Se.is(e)?e.toAction().id:vo.is(e)?e:e.id,n=this.actions.get(r);if(!n)return this;this.actions.delete(r);for(let o of n.definition.from){let i=this.fromTypeIndex.get(o.type);i&&(nm(i,n),i.length===0&&this.fromTypeIndex.delete(o.type))}return this.events.removed.next(void 0),this}fromCell(e,r){let n=e.obj;if(!n)return[];let o=this.fromTypeIndex.get(n.type);if(!o)return[];let i=!1;for(let s of o)if(s.definition.isApplicable){i=!0;break}if(!i)return o;let a=[];for(let s of o)s.definition.isApplicable?s.definition.isApplicable(n,e.transform,r)&&a.push(s):a.push(s);return a}dispose(){this.ev.dispose()}};var cu;(function(t){function e(i){return{type:"message",timestamp:new Date,message:i}}t.message=e;function r(i){return{type:"error",timestamp:new Date,message:i}}t.error=r;function n(i){return{type:"warning",timestamp:new Date,message:i}}t.warning=n;function o(i){return{type:"info",timestamp:new Date,message:i}}t.info=o})(cu||(cu={}));var Af;(function(t){class e{get current(){return this._current}set current(i){this._current=i}getAncestorOfType(i){if(!this._current)return;let a=this._current;for(;;){if(a=this.cells.get(a.transform.parent),!a.obj)return;if(a.obj.type===i.type)return a.obj;if(a.transform.ref===kt.RootRef)return}}getRootOfType(i){if(!this._current)return;let a=this._current,s;for(;;){if(!a.obj)return;if(a.obj.type===i.type&&(s=a),a.transform.ref===kt.RootRef)return s?s.obj:void 0;a=this.cells.get(a.transform.parent)}}constructor(i){this.cells=i,this._current=void 0}}t.Impl=e;function r(o,i){let a=o.cells,s=a.get(i),l=[s];for(;s?.transform.transformer.definition.isDecorator;)s=a.get(s.transform.parent),l.push(s);return l}t.getDecoratorChain=r;function n(o,i,a){let s,l=o.cells.get(a);if(l)for(;;){if(!l.obj)return;if(l.obj.type===i.type&&(s=l),l.transform.ref===kt.RootRef)return s?s.obj:void 0;l=o.cells.get(l.transform.parent)}}t.getRootOfType=n})(Af||(Af={}));var V2=class{constructor(){this.queue=[],this.signal=new ln}get length(){return this.queue.length}enqueue(e){return this.queue.push(e),this.queue.length===1?!0:this.waitFor(e)}handled(e){rp(this.queue,e),this.queue.length>0&&this.signal.next({v:this.queue[0],stillPresent:!0})}remove(e){let r=rp(this.queue,e);return r&&this.signal.next({v:e,stillPresent:!1}),r}waitFor(e){return new Promise(r=>{let n=this.signal.subscribe(({v:o,stillPresent:i})=>{o===e&&(n.unsubscribe(),r(i))})})}};var Ll=class{get tree(){return this._tree}get transforms(){return this._tree.transforms}get current(){return this.behaviors.currentObject.value.ref}get root(){return this.cells.get(this._tree.root.ref)}build(){return new Df.Root(this.tree,this)}addHistory(e,r){this.historyCapacity!==0&&(this.history.unshift([e,r||"Update"]),this.history.length>this.historyCapacity&&this.history.pop(),this.events.historyUpdated.next({state:this}))}clearHistory(){this.history.length!==0&&(this.history=[],this.events.historyUpdated.next({state:this}))}get latestUndoLabel(){return this.history.length>0?this.history[0][1]:void 0}get canUndo(){return this.history.length>0}undo(){return ie.create("Undo",e=>N(this,null,function*(){let r=this.history.shift();if(r){this.events.historyUpdated.next({state:this}),this.undoingHistory=!0;try{yield this.updateTree(r[0],{canUndo:!1}).runInContext(e)}finally{this.undoingHistory=!1}}}))}getSnapshot(){return{tree:Nn.toJSON(this._tree)}}setSnapshot(e){let r=Nn.fromJSON(e.tree);return this.updateTree(r)}setCurrent(e){this.behaviors.currentObject.next({state:this,ref:e})}updateCellState(e,r){let n=this.cells.get(e);if(!n)return;let o=typeof r=="function"?r(n.state):r;kt.assignState(n.state,o)&&(n.transform=this._tree.assignState(n.transform.ref,o),this.events.cell.stateUpdated.next({state:this,ref:e,cell:n}))}dispose(){this.ev.dispose(),this.actions.dispose()}select(e){return lt.select(e,this)}selectQ(e){return typeof e=="string"?lt.select(e,this):lt.select(e(lt.Generators),this)}applyAction(e,r,n=kt.RootRef){return ie.create("Apply Action",o=>{let i=this.cells.get(n);if(!i)throw new Error(`'${n}' does not exist.`);if(i.status!=="ok")throw new Error(`Action cannot be applied to a cell with status '${i.status}'`);return OM(e.definition.run({ref:n,cell:i,a:i.obj,params:r,state:this},this.globalContext),o)})}transaction(e,r){return ie.create("State Transaction",n=>N(this,null,function*(){let o=this.inTransaction,i=this._tree.asImmutable(),a=!1;try{o||this.behaviors.isUpdating.next(!0),this.inTransaction=!0,this.inTransactionError=!1,yield e(n),this.inTransactionError&&(a=!0,yield this.updateTree(i).runInContext(n))}catch(s){if(a||(a=!0,yield this.updateTree(i).runInContext(n),this.events.log.next(cu.error("Error during state transaction, reverting"))),o)throw this.inTransactionError=!0,s;if(r?.rethrowErrors)throw s;console.error(s)}finally{o||(this.inTransaction=!1,this.events.changed.next({state:this,inTransaction:!1}),this.behaviors.isUpdating.next(!1),a||(r?.canUndo?this.addHistory(i,typeof r.canUndo=="string"?r.canUndo:void 0):this.clearHistory()))}}))}get inUpdate(){return this._inUpdate}updateTree(e,r){let n={tree:e,options:r};return ie.create("Update Tree",o=>N(this,null,function*(){if(!(yield this.updateQueue.enqueue(n)))return;this._inUpdate=!0;let a=r?.canUndo?this._tree.asImmutable():void 0,s=!1;this.inTransaction||this.behaviors.isUpdating.next(!0);try{if(Df.is(e)){if(e.editInfo.applied)throw new Error("This builder has already been applied. Create a new builder for further state updates");e.editInfo.applied=!0}this.reverted=!1;let l=r&&(r.revertIfAborted||r.revertOnError)?yield this._revertibleTreeUpdate(o,n,r):yield this._updateTree(o,n);return s=this.reverted,l.ctx.hadError&&(this.inTransactionError=!0),l.cell?new z0(l.cell.transform.ref,this):void 0}finally{this._inUpdate=!1,this.updateQueue.handled(n),this.inTransaction||(this.behaviors.isUpdating.next(!1),r?.canUndo?s||this.addHistory(a,typeof r.canUndo=="string"?r.canUndo:void 0):this.undoingHistory||this.clearHistory())}}),()=>{this.updateQueue.remove(n)})}_revertibleTreeUpdate(e,r,n){return N(this,null,function*(){let o=this.tree,i=yield this._updateTree(e,r);return(i.ctx.hadError||i.ctx.wasAborted)&&n.revertOnError||i.ctx.wasAborted&&n.revertIfAborted?(this.reverted=!0,yield this._updateTree(e,{tree:o,options:r.options})):i})}_updateTree(e,r){return N(this,null,function*(){let n=!1,o=this.updateTreeAndCreateCtx(r.tree,e,r.options);try{if(n=yield jpe(o),Df.isTo(r.tree)){let i=this.select(r.tree.ref)[0];return{ctx:o,cell:i}}return{ctx:o}}finally{this.spine.current=void 0,n&&this.events.changed.next({state:this,inTransaction:this.inTransaction})}})}updateTreeAndCreateCtx(e,r,n){let o=(Df.is(e)?e.getTree():e).asTransient(),i=this._tree;this._tree=o;let a=this.cells,s={parent:this,editInfo:Df.is(e)?e.editInfo:void 0,errorFree:this.errorFree,taskCtx:r,oldTree:i,tree:o,cells:this.cells,spine:this.spine,results:[],options:w(w({},Gpe),n),changed:!1,hadError:!1,wasAborted:!1,newCurrent:void 0,getCellData:l=>{var c;return(c=a.get(l).obj)===null||c===void 0?void 0:c.data}};return this.errorFree=!0,s}constructor(e,r){this.errorFree=!0,this.ev=_s.create(),this.globalContext=void 0,this.events={cell:{stateUpdated:this.ev(),created:this.ev(),removed:this.ev()},object:{updated:this.ev(),created:this.ev(),removed:this.ev()},log:this.ev(),changed:this.ev(),historyUpdated:this.ev()},this.behaviors={currentObject:this.ev.behavior({state:this,ref:kt.RootRef}),isUpdating:this.ev.behavior(!1)},this.actions=new N2,this.cells=new Map,this.spine=new Af.Impl(this.cells),this.tryGetCellData=i=>{var a,s;let l=(s=(a=this.cells.get(i))===null||a===void 0?void 0:a.obj)===null||s===void 0?void 0:s.data;if(l===void 0)throw new Error(`Cell '${i}' data undefined.`);return l},this.historyCapacity=5,this.history=[],this.undoingHistory=!1,this.inTransaction=!1,this.inTransactionError=!1,this._inUpdate=!1,this.reverted=!1,this.updateQueue=new V2,this._tree=Nn.createEmpty(kt.createRoot(r&&r.rootState)).asTransient();let o=this._tree.root;this.runTask=r.runTask,r?.historyCapacity!==void 0&&(this.historyCapacity=r.historyCapacity),this.cells.set(o.ref,{parent:this,transform:o,sourceRef:void 0,obj:e,status:"ok",state:w({},o.state),errorText:void 0,params:{definition:{},values:{}},paramsNormalizedVersion:o.version,dependencies:{dependentBy:[],dependsOn:[]},cache:{}}),this.globalContext=r&&r.globalContext}};(function(t){function e(n,o){return new t(n,o)}t.create=e;let r;(function(n){function o(i,a){return!!a&&i.ref===a.transform.ref&&i.state===a.parent}n.isCell=o})(r=t.ObjectEvent||(t.ObjectEvent={}))})(Ll||(Ll={}));var Gpe={doNotLogTiming:!1,doNotUpdateCurrent:!0,revertIfAborted:!1,revertOnError:!1,canUndo:!1};function jpe(t){return N(this,null,function*(){let e=!!(t.editInfo&&t.editInfo.count===1&&t.editInfo.lastUpdate&&t.editInfo.sourceTree===t.oldTree),r,n=[],o;if(e)r=[],o=[t.editInfo.lastUpdate];else{r=Xpe(t);let s=t.parent.current,l=!1;for(let c of r)if(c===s){l=!0;break}if(l){let c=P8(t.oldTree,s,r,t.cells);t.parent.setCurrent(c)}for(let c=r.length-1;c>=0;c--){let u=t.cells.get(r[c]);u&&z2(u.transform,u.obj,u?.transform.params,u.cache,t.parent.globalContext)}for(let c of r){let u=t.cells.get(c);u&&(u.parent=void 0,Zpe(u));let d=u&&u.obj;t.cells.delete(c),n.push(d)}o=Hpe(t.cells,t.tree)}let i=tfe(t,o);for(let s of i.added)t.parent.events.cell.created.next({state:t.parent,ref:s.transform.ref,cell:s});for(let s=0;s<r.length;s++){let l=r[s],c=t.oldTree.transforms.get(l).parent;t.parent.events.object.removed.next({state:t.parent,ref:l,obj:n[s]}),t.parent.events.cell.removed.next({state:t.parent,ref:l,parent:c})}if(n.length&&(n=[]),i.dependent)for(let s of i.dependent)o.push(s.transform.ref);$pe(t,o);for(let s of o)yield D8(t,s);t.editInfo||Qpe(t);let a=t.newCurrent;for(let s of t.results)s.action==="created"?(t.parent.events.object.created.next({state:t.parent,ref:s.ref,obj:s.obj}),t.newCurrent||!t.tree.transforms.get(s.ref).state.isGhost&&s.obj!==Rr.Null&&(a=s.ref)):s.action==="updated"?t.parent.events.object.updated.next({state:t.parent,ref:s.ref,action:"in-place",obj:s.obj,oldData:s.oldData}):s.action==="replaced"&&t.parent.events.object.updated.next({state:t.parent,ref:s.ref,action:"recreate",obj:s.obj,oldObj:s.oldObj});if(a)t.options.doNotUpdateCurrent||t.parent.setCurrent(a);else{let s=t.parent.current,l=t.cells.get(s);l&&(l.obj===Rr.Null||l.status==="error"&&l.errorText===rfe)&&(a=P8(t.oldTree,s,[],t.cells),t.parent.setCurrent(a))}return r.length>0||o.length>0||t.changed})}function Hpe(t,e){let r={roots:[],cells:t};return Nn.doPreOrder(e,e.root,r,qpe),r.roots}function qpe(t,e,r){let n=r.cells.get(t.ref);return!n||n.transform.version!==t.version?(r.roots.push(t.ref),!1):!(n.status==="error"||n&&n.obj===Rr.Null)}function Wpe(t,e,r){!r.newTree.transforms.has(t.ref)&&r.cells.has(t.ref)&&r.deletes.push(t.ref)}function Xpe(t){let e={newTree:t.tree,cells:t.cells,deletes:[]};return Nn.doPostOrder(t.oldTree,t.oldTree.root,e,Wpe),e.deletes}function Ype(t,e,r){let n=r.cells.get(t.ref);!n||!kt.syncState(n.state,t.state)||r.parent.events.cell.stateUpdated.next({state:r.parent,ref:t.ref,cell:n})}function Qpe(t){Nn.doPreOrder(t.tree,t.tree.root,t,Ype)}function U2(t,e,r,n){let o=t.cells.get(e),i=o.status!==r;o.status=r,o.errorText=n,i&&t.parent.events.cell.stateUpdated.next({state:t.parent,ref:e,cell:o})}function Kpe(t,e,r){r.cells.get(t.ref).transform=t,U2(r,t.ref,"pending")}function $pe(t,e){for(let r of e)Nn.doPreOrder(t.tree,t.tree.transforms.get(r),t,Kpe)}function Zpe(t){for(let e of t.dependencies.dependsOn)nm(e.dependencies.dependentBy,t)}function Jpe(t,e,{ctx:r,added:n,visited:o}){if(o.add(t.ref),r.cells.has(t.ref))return;let i={parent:r.parent,transform:t,sourceRef:void 0,status:"pending",state:w({},t.state),errorText:void 0,params:void 0,paramsNormalizedVersion:"",dependencies:{dependentBy:[],dependsOn:[]},cache:void 0};r.cells.set(t.ref,i),n.push(i)}function efe(t,e){if(t.transform.dependsOn)for(let r of t.transform.dependsOn){if(!e.tree.transforms.get(r))throw new Error("Cannot depend on a non-existent transform.");let o=e.cells.get(r);Mo(t.dependencies.dependsOn,o),Mo(o.dependencies.dependentBy,t)}}function tfe(t,e){let r={ctx:t,visited:new Set,added:[]};for(let o of e)Nn.doPreOrder(t.tree,t.tree.transforms.get(o),r,Jpe);for(let o of r.added)efe(o,t);let n;return r.visited.forEach(o=>{let i=t.cells.get(o);for(let a of i.dependencies.dependentBy)r.visited.has(a.transform.ref)||(n||(n=Qc.create()),Qc.add(n,a.transform.ref,a))}),{added:r.added,dependent:n?n.array:void 0}}function P8(t,e,r,n){let o=new Set(r);return I8(t,e,o,n)}function I8(t,e,r,n){if(e===kt.RootRef)return e;let o=t.transforms.get(e),i=t.children.get(o.parent).values(),a,s=!1;for(;;){let l=i.next();if(l.done)break;if(r.has(l.value))continue;let c=n.get(l.value);if(!c||c.status==="error"||c.obj===Rr.Null)continue;let u=t.transforms.get(l.value);if(!u.state.isGhost){if(l.value===e){s=!0,r.has(e)||(a=e);continue}if(s)return u.ref;a=u.ref}}return a||I8(t,o.parent,r,n)}function BM(t,e,r,n){n||(t.hadError=!0,t.parent.errorFree=!1);let o=t.cells.get(e);if(r){t.wasAborted=t.wasAborted||ie.isAbort(r);let a=""+r;U2(t,e,"error",a),n||t.parent.events.log.next({type:"error",timestamp:new Date,message:a})}else o.params=void 0;if(o.obj){let a=o.obj;o.obj=void 0,o.cache=void 0,t.parent.events.object.removed.next({state:t.parent,ref:e,obj:a})}let i=t.tree.children.get(e).values();for(;;){let a=i.next();if(a.done)return;BM(t,a.value,void 0,n)}}var rfe="Parent is null";function D8(t,e){return N(this,null,function*(){U2(t,e,"processing");let r=!1;try{let o=ko(),i=yield ofe(t,e),a=ko()-o;i.action!=="none"&&(t.changed=!0),U2(t,e,"ok"),t.results.push(i),i.action==="created"?(r=i.obj===Rr.Null,!r&&!t.options.doNotLogTiming&&t.parent.events.log.next(cu.info(`Created ${i.obj.label} in ${p0(a)}.`))):i.action==="updated"?(r=i.obj===Rr.Null,!r&&!t.options.doNotLogTiming&&t.parent.events.log.next(cu.info(`Updated ${i.obj.label} in ${p0(a)}.`))):i.action==="replaced"&&(r=i.obj===Rr.Null,!r&&!t.options.doNotLogTiming&&t.parent.events.log.next(cu.info(`Updated ${i.obj.label} in ${p0(a)}.`)))}catch(o){t.changed=!0,t.hadError||(t.newCurrent=e),BM(t,e,o,!1),console.error(o);return}let n=t.tree.children.get(e).values();for(;;){let o=n.next();if(o.done)return;r?BM(t,o.value,void 0,!0):yield D8(t,o.value)}})}function nfe(t,e,r,n){let o=e.transformer.definition.params,i=o?o(r,t.parent.globalContext):{};if(n.paramsNormalizedVersion!==e.version)e.params=g.normalizeParams(i,e.params,"all"),n.paramsNormalizedVersion=e.version;else{let a=g.getDefaultValues(i);e.params=e.params?kz(e.params,a):a}return g.resolveRefs(i,e.params,t.getCellData),{definition:i,values:e.params}}function ofe(t,e){return N(this,null,function*(){var r;let{oldTree:n,tree:o}=t,i=t.cells.get(e),a=i.transform;if(i.transform.ref===kt.RootRef)return{action:"none"};let s=t.cells.get(i.transform.parent);if(s?.obj===Rr.Null)if(i.sourceRef=s.transform.ref,n.transforms.has(e)&&i.params){let m=i.params.values,p=i.cache;return z2(a,i.obj,m,p,t.parent.globalContext),i.params=void 0,i.obj=Rr.Null,{ref:e,action:"updated",obj:i.obj}}else return i.params=void 0,{ref:e,action:"created",obj:Rr.Null};let c=a.transformer.definition.from.length===0?s:lt.findAncestorOfType(o,t.cells,e,a.transformer.definition.from);if(!c)throw new Error(`No suitable parent found for '${e}'`);t.spine.current=i;let u=c.obj;i.sourceRef=c.transform.ref;let d=nfe(t,a,u,i);if(!n.transforms.has(e)||!i.params){i.params=d;let m=yield E8(t,i,a.transformer,u,d.values);return LM(m,a),i.obj=m,{ref:e,action:"created",obj:m}}else{let m=i.params.values,p=i.cache,h=(r=i.obj)===null||r===void 0?void 0:r.data,f=d.values;switch(i.params=d,i.obj&&i.obj!==Rr.Null?yield ife(t,i,a.transformer,u,i.obj,m,f):Se.UpdateResult.Recreate){case Se.UpdateResult.Recreate:{let v=i.obj;z2(a,v,m,p,t.parent.globalContext);let x=yield E8(t,i,a.transformer,u,f);return LM(x,a),i.obj=x,{ref:e,action:"replaced",oldObj:v,obj:x}}case Se.UpdateResult.Updated:return LM(i.obj,a),{ref:e,action:"updated",oldData:h,obj:i.obj};case Se.UpdateResult.Null:return z2(a,i.obj,m,p,t.parent.globalContext),i.obj=Rr.Null,{ref:e,action:"updated",obj:i.obj};default:return{action:"none"}}}})}function z2(t,e,r,n,o){var i,a;(a=(i=t.transformer.definition).dispose)===null||a===void 0||a.call(i,{b:e!==Rr.Null?e:void 0,params:r,cache:n},o)}function LM(t,e){!t||t===Rr.Null||(t.tags=e.tags)}function OM(t,e){return typeof t.runInContext=="function"?t.runInContext(e):t}function A8(t){if(t.dependencies.dependsOn.length===0)return;let e=Object.create(null);for(let r of t.dependencies.dependsOn){if(!r.obj)throw new Error("Unresolved dependency.");e[r.transform.ref]=r.obj}return e}function E8(t,e,r,n,o){return e.cache||(e.cache=Object.create(null)),OM(r.definition.apply({a:n,params:o,cache:e.cache,spine:t.spine,dependencies:A8(e)},t.parent.globalContext),t.taskCtx)}function ife(t,e,r,n,o,i,a){return N(this,null,function*(){return r.definition.update?(e.cache||(e.cache=Object.create(null)),OM(r.definition.update({a:n,oldParams:i,b:o,newParams:a,cache:e.cache,spine:t.spine,dependencies:A8(e)},t.parent.globalContext),t.taskCtx)):Se.UpdateResult.Recreate})}var X;(function(t){t.Create=Rr.factory();function e(m){return!!m&&m.type.typeClass==="Representation3D"}t.isRepresentation3D=e;function r(m){return!!m&&m.type.typeClass==="Behavior"}t.isBehavior=r;function n(m){return t.Create(U(w({},m),{typeClass:"Representation3D"}))}t.CreateRepresentation3D=n;function o(m){return t.Create(U(w({},m),{typeClass:"Behavior"}))}t.CreateBehavior=o;class i extends t.Create({name:"Root",typeClass:"Root"}){}t.Root=i;class a extends t.Create({name:"Group",typeClass:"Group"}){}t.Group=a;let s;(function(m){class p extends t.Create({name:"String Data",typeClass:"Data"}){}m.String=p;class h extends t.Create({name:"Binary Data",typeClass:"Data"}){}m.Binary=h;class f extends t.Create({name:"Data Blob",typeClass:"Data"}){}m.Blob=f})(s=t.Data||(t.Data={}));let l;(function(m){class p extends t.Create({name:"JSON Data",typeClass:"Data"}){}m.Json=p;class h extends t.Create({name:"CIF File",typeClass:"Data"}){}m.Cif=h;class f extends t.Create({name:"Cube File",typeClass:"Data"}){}m.Cube=f;class b extends t.Create({name:"PSF File",typeClass:"Data"}){}m.Psf=b;class v extends t.Create({name:"PRMTOP File",typeClass:"Data"}){}m.Prmtop=v;class x extends t.Create({name:"TOP File",typeClass:"Data"}){}m.Top=x;class S extends t.Create({name:"PLY File",typeClass:"Data"}){}m.Ply=S;class T extends t.Create({name:"CCP4/MRC/MAP File",typeClass:"Data"}){}m.Ccp4=T;class E extends t.Create({name:"DSN6/BRIX File",typeClass:"Data"}){}m.Dsn6=E;class _ extends t.Create({name:"DX File",typeClass:"Data"}){}m.Dx=_;class D extends t.Create({name:"Format Blob",typeClass:"Data"}){}m.Blob=D})(l=t.Format||(t.Format={}));let c;(function(m){class p extends t.Create({name:"Coordinates",typeClass:"Object"}){}m.Coordinates=p;class h extends t.Create({name:"Topology",typeClass:"Object"}){}m.Topology=h;class f extends t.Create({name:"Model",typeClass:"Object"}){}m.Model=f;class b extends t.Create({name:"Trajectory",typeClass:"Object"}){}m.Trajectory=b;class v extends t.Create({name:"Structure",typeClass:"Object"}){}m.Structure=v,function(x){class S extends n({name:"Structure 3D"}){}x.Representation3D=S;class T extends t.Create({name:"Structure 3D State",typeClass:"Object"}){}x.Representation3DState=T;class E extends t.Create({name:"Selections",typeClass:"Object"}){}x.Selections=E}(v=m.Structure||(m.Structure={}))})(c=t.Molecule||(t.Molecule={}));let u;(function(m){class p extends t.Create({name:"Volume",typeClass:"Object"}){}m.Data=p;class h extends t.Create({name:"Lazy Volume",typeClass:"Object"}){}m.Lazy=h;class f extends n({name:"Volume 3D"}){}m.Representation3D=f})(u=t.Volume||(t.Volume={}));let d;(function(m){class p extends t.Create({name:"Shape Provider",typeClass:"Object"}){}m.Provider=p;class h extends n({name:"Shape 3D"}){}m.Representation3D=h})(d=t.Shape||(t.Shape={}))})(X||(X={}));var Je;(function(t){t.CreateBuiltIn=Se.factory("ms-plugin"),t.BuiltIn=Se.builderFactory("ms-plugin")})(Je||(Je={}));var nv=class extends X.Create({name:"Volume Streaming",typeClass:"Object"}){},k8;(function(t){let e;(function(r){r.Float32="float32",r.Int8="int8"})(e=t.ValueType||(t.ValueType={}))})(k8||(k8={}));function kf(t,e){return`${t}${t[t.length-1]==="/"||e[0]==="/"?"":"/"}${e}`}var M8={get preferWebGl1(){if(typeof navigator>"u"||typeof window>"u")return!1;if(["Version/15.1 Safari","Version/15.2 Safari","Version/15.3 Safari"].some(o=>navigator.userAgent.indexOf(o)>0))return!0;let e=/iPad|iPhone|iPod/.test(navigator.userAgent),r=navigator.userAgent.includes("Macintosh"),n=navigator.maxTouchPoints>=4;return!window.MSStream&&(e||r&&n)}};var FM=class{toString(){return this.key}valueOf(){return this.key}constructor(e,r){this.key=e,this.defaultValue=r}};function Vn(t,e){return new FM(t,e)}var Wt={item:Vn,General:{IsBusyTimeoutMs:Vn("plugin-config.is-busy-timeout",750),DisableAntialiasing:Vn("plugin-config.disable-antialiasing",!1),DisablePreserveDrawingBuffer:Vn("plugin-config.disable-preserve-drawing-buffer",!1),PixelScale:Vn("plugin-config.pixel-scale",1),PickScale:Vn("plugin-config.pick-scale",.25),Transparency:Vn("plugin-config.transparency","wboit"),PreferWebGl1:Vn("plugin-config.prefer-webgl1",M8.preferWebGl1),AllowMajorPerformanceCaveat:Vn("plugin-config.allow-major-performance-caveat",!1),PowerPreference:Vn("plugin-config.power-preference","high-performance")},State:{DefaultServer:Vn("plugin-state.server","https://webchem.ncbr.muni.cz/molstar-state"),CurrentServer:Vn("plugin-state.server","https://webchem.ncbr.muni.cz/molstar-state"),HistoryCapacity:Vn("history-capacity.server",5)},VolumeStreaming:{Enabled:Vn("volume-streaming.enabled",!0),DefaultServer:Vn("volume-streaming.server","https://ds.litemol.org"),CanStream:Vn("volume-streaming.can-stream",(t,e)=>t.models.length===1&&Et.probablyHasDensityMap(t.models[0])),EmdbHeaderServer:Vn("volume-streaming.emdb-header-server","https://files.wwpdb.org/pub/emdb/structures")},Viewport:{ShowExpand:Vn("viewer.show-expand-button",!0),ShowControls:Vn("viewer.show-controls-button",!0),ShowSettings:Vn("viewer.show-settings-button",!0),ShowSelectionMode:Vn("viewer.show-selection-model-button",!0),ShowAnimation:Vn("viewer.show-animation-button",!0),ShowTrajectoryControls:Vn("viewer.show-trajectory-controls",!0)},Download:{DefaultPdbProvider:Vn("download.default-pdb-provider","pdbe"),DefaultEmdbProvider:Vn("download.default-emdb-provider","pdbe")},Structure:{SizeThresholds:Vn("structure.size-thresholds",ue.DefaultSizeThresholds),DefaultRepresentationPreset:Vn("structure.default-representation-preset","auto"),DefaultRepresentationPresetParams:Vn("structure.default-representation-preset-params",{}),SaccharideCompIdMapType:Vn("structure.saccharide-comp-id-map-type","default")},Background:{Styles:Vn("background.styles",[])}},G2=class{get(e){return this._config.has(e)?this._config.get(e):e.defaultValue}set(e,r){this._config.set(e,r)}delete(e){this._config.delete(e)}constructor(e){this._config=new Map,e&&e.forEach(([r,n])=>this._config.set(r,n))}};function R8(t,e="x-ray"){if(!t)return e;let r=t.models[0];return op.is(r.sourceData)?Et.hasEmMap(r)?"em":Et.hasXrayMap(r)?"x-ray":Et.isFromEm(r)?"em":Et.isFromXray(r)?"x-ray":e:e}function afe(t){let e=[];if(!op.is(t.sourceData))return[t.entryId];let{db_id:r,db_name:n,content_type:o}=t.sourceData.data.db.pdbx_database_related;if(!n.isDefined)return[t.entryId];for(let i=0,a=n.rowCount;i<a;++i)n.value(i).toUpperCase()==="EMDB"&&o.value(i)==="associated EM volume"&&e.push(r.value(i));return e}function sfe(t){return[t.entryId]}function L8(t,e){if(!e||!e.models.length)return[];let r=e.models[0];switch(t){case"em":return afe(r);case"x-ray":return sfe(r)}}function NM(t,e,r,n){return N(this,null,function*(){switch(t){case"emdb":return VM(e,r,n);case"pdbe":return lfe(e,r,n)}})}function VM(t,e,r){return N(this,null,function*(){let n=t.config.get(Wt.VolumeStreaming.EmdbHeaderServer),a=(yield t.fetch({url:`${n}/${r.toUpperCase()}/header/${r.toLowerCase()}.xml`,type:"xml"}).runInContext(e)).getElementsByTagName("map")[0].getElementsByTagName("contour"),s=a[0];for(let c=1;c<a.length;c++)if(a[c].getAttribute("primary")==="true"){s=a[c];break}return parseFloat(s.getElementsByTagName("level")[0].textContent)})}function lfe(t,e,r){return N(this,null,function*(){var n,o,i,a;r=r.toUpperCase();let s=yield t.fetch({url:`https://www.ebi.ac.uk/emdb/api/entry/map/${r}`,type:"json"}).runInContext(e),l=(o=(n=s?.map)===null||n===void 0?void 0:n.contour_list)===null||o===void 0?void 0:o.contour;return!l||l.length===0?cfe(t,e,r):(a=(i=l.find(c=>c.primary))===null||i===void 0?void 0:i.level)!==null&&a!==void 0?a:l[0].level})}function cfe(t,e,r){return N(this,null,function*(){var n,o,i;r=r.toUpperCase();let a=yield t.fetch({url:`https://www.ebi.ac.uk/pdbe/api/emdb/entry/map/${r}`,type:"json"}).runInContext(e),s=a?.[r],l;return((i=(o=(n=s?.[0])===null||n===void 0?void 0:n.map)===null||o===void 0?void 0:o.contour_level)===null||i===void 0?void 0:i.value)!==void 0&&(l=+s[0].map.contour_level.value),l})}function B8(t,e,r){return N(this,null,function*(){var n;let o=yield t.fetch({url:`https://www.ebi.ac.uk/pdbe/api/pdb/entry/summary/${r}`,type:"json"}).runInContext(e),i=o?.[r],a=[];if(!((n=i?.[0])===null||n===void 0)&&n.related_structures){let s=i[0].related_structures.filter(l=>l.resource==="EMDB"&&l.relationship==="associated EM volume");if(!s.length)throw new Error(`No related EMDB entry found for '${r}'.`);a.push(...s.map(l=>l.accession))}else throw new Error(`No related EMDB entry found for '${r}'.`);return a})}var rr;(function(t){class e extends X.Create({name:"Root",typeClass:"Root"}){}t.Root=e;class r extends X.Create({name:"Category",typeClass:"Object"}){}t.Category=r;class n extends X.CreateBehavior({name:"Behavior"}){}t.Behavior=n,t.Categories={common:"Common",representation:"Representation",interaction:"Interaction","custom-props":"Custom Properties",misc:"Miscellaneous"},t.CreateCategory=Je.BuiltIn({name:"create-behavior-category",display:{name:"Behavior Category"},from:e,to:r,params:{label:g.Text("",{isHidden:!0})}})({apply({params:u}){return new r({},{label:u.label})}});let o=new Map;function i(u){return o.get(u.id)}t.getCategoryId=i;function a(u){let d=Je.CreateBuiltIn({name:u.name,display:u.display,from:[e],to:[n],params:u.params,apply({params:m},p){let h=u.label?u.label(m):{label:u.display.name,description:u.display.description};return new n(new u.ctor(p,m),h)},update({b:m,newParams:p}){return ie.create("Update Behavior",()=>N(this,null,function*(){return m.data.update?(yield m.data.update(p))?Se.UpdateResult.Updated:Se.UpdateResult.Unchanged:Se.UpdateResult.Unchanged}))},canAutoUpdate:u.canAutoUpdate});return o.set(d.id,u.category),d}t.create=a;function s(u,d){return class{register(){this.sub=u.subscribe(this.ctx,m=>d(m,this.ctx))}dispose(){this.sub&&this.sub.unsubscribe(),this.sub=void 0}constructor(m){this.ctx=m,this.sub=void 0}}}t.simpleCommandHandler=s;class l{subscribeCommand(d,m){this.subs.push(d.subscribe(this.ctx,m))}subscribeObservable(d,m){this.subs.push(d.subscribe(m))}track(d){this.subs.push(d)}dispose(){for(let d of this.subs)d.unsubscribe();this.subs=[]}update(d){return Cg(d,this.params)?!1:(this.params=d,!0)}constructor(d,m){this.ctx=d,this.params=m,this.subs=[]}}t.Handler=l;class c{subscribeCommand(d,m){this.subs.push(d.subscribe(this.plugin,m))}subscribeObservable(d,m){let p=d.subscribe(m);return this.subs.push(p),{unsubscribe:()=>{let h=this.subs.indexOf(p);h>=0&&(this.subs.splice(h,1),p.unsubscribe())}}}dispose(){for(let d of this.subs)d.unsubscribe();this.subs=[]}constructor(d,m){this.plugin=d,this.params=m,this.subs=[]}}t.WithSubscribers=c})(rr||(rr={}));var ov;(function(t){function e(a,s){return{key:a,data:s}}function r(a){return{entries:Ox(),capacity:Math.max(1,a)}}t.create=r;function n(a,s){for(let l=a.entries.first;l;l=l.next)if(l.value.key===s)return a.entries.remove(l),a.entries.addLast(l.value),l.value.data}t.get=n;function o(a,s,l){let c;if(a.entries.count>=a.capacity){let u=a.entries.first;c=u.value.data,a.entries.remove(u)}return a.entries.addLast(e(s,l)),c}t.set=o;function i(a,s){for(let l=a.entries.first;l;l=l.next)if(l.value.key===s){a.entries.remove(l);break}}t.remove=i})(ov||(ov={}));function Tn(){let t=(e,r)=>e.commands.dispatch(t,r||{});return t.subscribe=(e,r)=>e.commands.subscribe(t,r),t.id=vo.create22(),t}var j2=class{constructor(){this.subs=new Map,this.disposing=!1}subscribe(e,r){let n=this.subs.get(e.id);return n||(n=[],this.subs.set(e.id,n)),n.push(r),{unsubscribe:()=>{let o=this.subs.get(e.id);if(!o)return;let i=o.indexOf(r);if(!(i<0)){for(let a=i+1;a<o.length;a++)o[a-1]=o[a];o.pop()}}}}dispatch(e,r){return new Promise((n,o)=>{if(this.disposing){o("disposed");return}if(!this.subs.get(e.id)){n();return}this.resolve({cmd:e,params:r,resolve:n,reject:o})})}dispose(){this.subs.clear()}resolve(e){return N(this,null,function*(){let r=this.subs.get(e.cmd.id);if(!r){e.resolve();return}try{for(let n of r)yield n(e.params);e.resolve()}catch(n){e.reject(n)}})}};var Re={State:{SetCurrentObject:Tn(),ApplyAction:Tn(),Update:Tn(),RemoveObject:Tn(),ToggleExpanded:Tn(),ToggleVisibility:Tn(),Snapshots:{Add:Tn(),Replace:Tn(),Move:Tn(),Remove:Tn(),Apply:Tn(),Clear:Tn(),Upload:Tn(),Fetch:Tn(),DownloadToFile:Tn(),OpenFile:Tn(),OpenUrl:Tn()}},Interactivity:{Object:{Highlight:Tn()},Structure:{Highlight:Tn(),Select:Tn()},ClearHighlights:Tn()},Layout:{Update:Tn()},Toast:{Show:Tn(),Hide:Tn()},Camera:{Reset:Tn(),SetSnapshot:Tn(),Focus:Tn(),OrientAxes:Tn(),ResetAxes:Tn()},Canvas3D:{SetSettings:Tn(),ResetSettings:Tn()}};var H2=class{constructor(e=!1){this.isRunning=!1,this.queue=[],this.counter=0,this.log=e}enqueue(e){this.log&&console.log("SingleAsyncQueue enqueue",this.counter),this.queue[0]={id:this.counter,func:e},this.counter++,this.run()}run(){return N(this,null,function*(){if(this.isRunning)return;let e=this.queue.pop();if(e){this.isRunning=!0;try{this.log&&console.log("SingleAsyncQueue run",e.id),yield e.func(),this.log&&console.log("SingleAsyncQueue complete",e.id)}finally{this.isRunning=!1,this.run()}}})}};var di=class extends X.CreateBehavior({name:"Volume Streaming"}){};(function(t){t.RootTag="volume-streaming-info";function e(l,c,u,d,m={}){var p,h,f,b;return g.Group({isoValue:xe.createIsoValueParam((p=m.isoValue)!==null&&p!==void 0?p:u,d),color:g.Color((h=m.color)!==null&&h!==void 0?h:c),wireframe:g.Boolean((f=m.wireframe)!==null&&f!==void 0?f:!1),opacity:g.Numeric((b=m.opacity)!==null&&b!==void 0?b:.3,{min:0,max:1,step:.01})},{label:l,isExpanded:!0})}let r={byteOffset:0,rate:1,sampleCount:[1,1,1],valuesInfo:[{mean:0,min:-1,max:1,sigma:.1},{mean:0,min:-1,max:1,sigma:.1}]};function n(l={}){let{data:c,defaultView:u,channelParams:d}=l,m=new Map;c&&c.entries.forEach(f=>m.set(f.dataId,f));let p=c?c.entries.map(f=>[f.dataId,f.dataId]):[],h=c?c.entries[0].dataId:"";return{entry:g.Mapped(h,p,f=>g.Group(o({entryData:m.get(f),defaultView:u,structure:c&&c.structure,channelParams:d})))}}t.createParams=n;function o(l){let{entryData:c,defaultView:u,structure:d,channelParams:m={}}=l,p=c||{kind:"em",header:{sampling:[r],availablePrecisions:[{precision:0,maxVoxels:0}]},emDefaultContourLevel:xe.IsoValue.relative(0)},h=d&&d.boundary.box||qe();return{view:g.MappedStatic(u||(p.kind==="em"?"auto":"selection-box"),{off:g.Group({}),box:g.Group({bottomLeft:g.Vec3(h.min),topRight:g.Vec3(h.max)},{description:"Static box defined by cartesian coords.",isFlat:!0}),"selection-box":g.Group({radius:g.Numeric(5,{min:0,max:50,step:.5},{description:"Radius in \u212B within which the volume is shown."}),bottomLeft:g.Vec3(y.create(0,0,0),{},{isHidden:!0}),topRight:g.Vec3(y.create(0,0,0),{},{isHidden:!0})},{description:"Box around focused element.",isFlat:!0}),"camera-target":g.Group({radius:g.Numeric(.5,{min:0,max:1,step:.05},{description:"Radius within which the volume is shown (relative to the field of view)."}),dynamicDetailLevel:i(p.header.availablePrecisions,0,{label:"Dynamic Detail"}),bottomLeft:g.Vec3(y.create(0,0,0),{},{isHidden:!0}),topRight:g.Vec3(y.create(0,0,0),{},{isHidden:!0})},{description:"Box around camera target.",isFlat:!0}),cell:g.Group({}),auto:g.Group({radius:g.Numeric(5,{min:0,max:50,step:.5},{description:"Radius in \u212B within which the volume is shown."}),selectionDetailLevel:i(p.header.availablePrecisions,6,{label:"Selection Detail"}),isSelection:g.Boolean(!1,{isHidden:!0}),bottomLeft:g.Vec3(h.min,{},{isHidden:!0}),topRight:g.Vec3(h.max,{},{isHidden:!0})},{description:"Box around focused element.",isFlat:!0})},{options:t.ViewTypeOptions,description:'Controls what of the volume is displayed. "Off" hides the volume alltogether. "Bounded box" shows the volume inside the given box. "Around Interaction" shows the volume around the focused element/atom. "Whole Structure" shows the volume for the whole structure.'}),detailLevel:i(p.header.availablePrecisions,3),channels:p.kind==="em"?g.Group({em:e("EM",ce(6524815),p.emDefaultContourLevel||xe.IsoValue.relative(1),p.header.sampling[0].valuesInfo[0],m.em)},{isFlat:!0}):g.Group({"2fo-fc":e("2Fo-Fc",ce(3367602),xe.IsoValue.relative(1.5),p.header.sampling[0].valuesInfo[0],m["2fo-fc"]),"fo-fc(+ve)":e("Fo-Fc(+ve)",ce(3390259),xe.IsoValue.relative(3),p.header.sampling[0].valuesInfo[1],m["fo-fc(+ve)"]),"fo-fc(-ve)":e("Fo-Fc(-ve)",ce(12268339),xe.IsoValue.relative(-3),p.header.sampling[0].valuesInfo[1],m["fo-fc(-ve)"])},{isFlat:!0})}}t.createEntryParams=o;function i(l,c,u){return g.Select(Math.min(c,l.length-1),l.map((d,m)=>[m,`${m+1} [ ${Math.pow(d.maxVoxels,1/3)|0}^3 cells ]`]),w({description:"Determines the maximum number of voxels. Depending on the size of the volume options are in the range from 1 (0.52M voxels) to 7 (25.17M voxels)."},u))}function a(l){return{entry:{name:l.entry.name,params:{detailLevel:l.entry.params.detailLevel,channels:l.entry.params.channels,view:{name:l.entry.params.view.name,params:w({},l.entry.params.view.params)}}}}}t.copyParams=a,t.ViewTypeOptions=[["off","Off"],["box","Bounded Box"],["selection-box","Around Focus"],["camera-target","Around Camera"],["cell","Whole Structure"],["auto","Auto"]],t.ChannelTypeOptions=[["em","em"],["2fo-fc","2fo-fc"],["fo-fc(+ve)","fo-fc(+ve)"],["fo-fc(-ve)","fo-fc(-ve)"]];class s extends rr.WithSubscribers{get info(){return this.infoMap.get(this.params.entry.name)}queryData(c){return N(this,null,function*(){let u=kf(this.data.serverUrl,`${this.info.kind}/${this.info.dataId.toLowerCase()}`);if(c){let{min:v,max:x}=c;u+=`/box/${v.map(S=>Math.round(1e3*S)/1e3).join(",")}/${x.map(S=>Math.round(1e3*S)/1e3).join(",")}`}else u+="/cell";let d=this.params.entry.params.detailLevel;this.params.entry.params.view.name==="auto"&&this.params.entry.params.view.params.isSelection&&(d=this.params.entry.params.view.params.selectionDetailLevel),this.params.entry.params.view.name==="camera-target"&&c&&(d=this.decideDetail(c,this.params.entry.params.view.params.dynamicDetailLevel)),u+=`?detail=${d}`;let m=ov.get(this.cache,u);if(m)return m.data;let p=Wr.getUrlAsset(this.plugin.managers.asset,u),h=yield this.plugin.runTask(this.plugin.managers.asset.resolve(p,"binary")),f=yield this.parseCif(h.data);if(!f)return;let b=ov.set(this.cache,u,{data:f,asset:h});return b&&b.asset.dispose(),f})}parseCif(c){return N(this,null,function*(){let u=yield this.plugin.runTask(lc.parseBinary(c));if(u.isError){this.plugin.log.error("VolumeStreaming, parsing CIF: "+u.toString());return}if(u.result.blocks.length<2){this.plugin.log.error("VolumeStreaming: Invalid data.");return}let d={};for(let m=1;m<u.result.blocks.length;m++){let p=u.result.blocks[m],h=lc.schema.densityServer(p),f=yield this.plugin.runTask(e2(h));d[p.header]=f}return d})}updateParams(c,u=!1){return N(this,null,function*(){let d=a(this.params),m=d.entry.params.view.name;m!=="off"&&m!=="cell"&&(d.entry.params.view.params.bottomLeft=c?.min||y.zero(),d.entry.params.view.params.topRight=c?.max||y.zero()),m==="auto"&&(d.entry.params.view.params.isSelection=u);let p=this.plugin.state.data,h=p.build().to(this.ref).update(d);yield Re.State.Update(this.plugin,{state:p,tree:h,options:{doNotUpdateCurrent:!0}})})}getStructureRoot(){return this.plugin.state.data.select(lt.Generators.byRef(this.ref).rootOfType(X.Molecule.Structure))[0]}register(c){this.ref=c,this.subscribeObservable(this.plugin.state.events.object.removed,u=>{!X.Molecule.Structure.is(u.obj)||!z.Loci.is(this.lastLoci)||this.lastLoci.structure===u.obj.data&&(this.lastLoci=St)}),this.subscribeObservable(this.plugin.state.events.object.updated,u=>{!X.Molecule.Structure.is(u.oldObj)||!z.Loci.is(this.lastLoci)||this.lastLoci.structure===u.oldObj.data&&(this.lastLoci=St)}),this.subscribeObservable(this.plugin.managers.structure.focus.behaviors.current,u=>{if(!this.plugin.state.data.tree.children.has(this.ref))return;let d=u?u.loci:St;switch(this.params.entry.params.view.name){case"auto":this.updateAuto(d);break;case"selection-box":this.updateSelectionBox(d);break;default:this.lastLoci=d;break}})}unregister(){let c=this.cache.entries.first;for(;c;)c.value.data.asset.dispose(),c=c.next}isCameraTargetSame(c,u){if(!c||!u)return!1;let d=y.equals(c.target,u.target),m=y.squaredDistance(c.target,c.position),p=y.squaredDistance(u.target,u.position),h=Math.abs(m-p)/m<.001;return d&&h}cameraTargetDistance(c){return y.distance(c.target,c.position)}getBoxFromLoci(c){var u,d,m;if(st.isEmpty(c)||Wn(c))return qe();let p=this.plugin.helpers.substructureParent.get(c.structure,!0);if(!p)return qe();let h=this.getStructureRoot();if(!h||((u=h.obj)===null||u===void 0?void 0:u.data)!==((d=p.obj)===null||d===void 0?void 0:d.data))return qe();let f=LT.get((m=h.obj)===null||m===void 0?void 0:m.data.models[0]);f&&W.invert(this._invTransform,f);let b=z.Loci.extendToWholeResidues(c),v=z.Loci.getBoundary(b,f&&!Number.isNaN(this._invTransform[0])?this._invTransform:void 0).box;return z.Loci.size(b)===1&&qe.expand(v,v,y.create(1,1,1)),v}updateAuto(c){this.updateQueue.enqueue(()=>N(this,null,function*(){this.lastLoci=c,Wn(c)?yield this.updateParams(this.info.kind==="x-ray"?this.data.structure.boundary.box:void 0,!1):yield this.updateParams(this.getBoxFromLoci(c),!0)}))}updateSelectionBox(c){this.updateQueue.enqueue(()=>N(this,null,function*(){st.areEqual(this.lastLoci,c)?this.lastLoci=St:this.lastLoci=c;let u=this.getBoxFromLoci(this.lastLoci);yield this.updateParams(u)}))}updateCameraTarget(c){this.updateQueue.enqueue(()=>N(this,null,function*(){var u,d,m;let p=(u=this.plugin.canvas3d)===null||u===void 0?void 0:u.props.camera.manualReset;try{p||(d=this.plugin.canvas3d)===null||d===void 0||d.setProps({camera:{manualReset:!0}});let h=this.boxFromCameraTarget(c,!0);yield this.updateParams(h)}finally{p||(m=this.plugin.canvas3d)===null||m===void 0||m.setProps({camera:{manualReset:p}})}}))}boxFromCameraTarget(c,u){var d;let m=c.target,p=this.cameraTargetDistance(c),f=Math.tan(.5*c.fov)*p,b=(d=this.plugin.canvas3d)===null||d===void 0?void 0:d.camera.viewport;b&&b.width>b.height&&(f*=b.width/b.height);let v=this.params.entry.params.view.name==="camera-target"?this.params.entry.params.view.params.radius:.5;f*=v;let x,S,T;if(u){let E=y.zero();qe.size(E,this.data.structure.boundary.box),x=Math.min(f,.5*E[0]),S=Math.min(f,.5*E[1]),T=Math.min(f,.5*E[2])}else x=S=T=f;return qe.create(y.create(m[0]-x,m[1]-S,m[2]-T),y.create(m[0]+x,m[1]+S,m[2]+T))}decideDetail(c,u){let d=this.info.kind==="x-ray"?qe.volume(this.data.structure.boundary.box):this.info.header.spacegroup.size.reduce((b,v)=>b*v,1),p=qe.volume(c)/d,h=this.info.header.availablePrecisions.length-1,f=u;for(;p<=.5&&f<h;)p*=2,f+=1;return f}update(c){return N(this,null,function*(){let u=c.entry.params.view.name==="selection-box"&&this.params&&this.params.entry&&this.params.entry.params&&this.params.entry.params.view&&this.params.entry.params.view.name!=="selection-box";this.params=c;let d,m=!1;switch(c.entry.params.view.name!=="camera-target"&&this.cameraTargetSubscription&&(this.cameraTargetSubscription.unsubscribe(),this.cameraTargetSubscription=void 0),c.entry.params.view.name){case"off":m=!0;break;case"box":d=qe.create(c.entry.params.view.params.bottomLeft,c.entry.params.view.params.topRight),m=qe.volume(d)<1e-4;break;case"selection-box":{u?d=this.getBoxFromLoci(this.lastLoci)||qe():d=qe.create(y.clone(c.entry.params.view.params.bottomLeft),y.clone(c.entry.params.view.params.topRight));let f=c.entry.params.view.params.radius;m=qe.volume(d)<1e-4,qe.expand(d,d,y.create(f,f,f));break}case"camera-target":this.cameraTargetSubscription||(this.cameraTargetSubscription=this.subscribeObservable(this.cameraTargetObservable,f=>this.updateCameraTarget(f))),d=this.boxFromCameraTarget(this.plugin.canvas3d.camera.getSnapshot(),!0);break;case"cell":d=this.info.kind==="x-ray"?this.data.structure.boundary.box:void 0;break;case"auto":if(d=c.entry.params.view.params.isSelection||this.info.kind==="x-ray"?qe.create(y.clone(c.entry.params.view.params.bottomLeft),y.clone(c.entry.params.view.params.topRight)):void 0,d&&(m=qe.volume(d)<1e-4,c.entry.params.view.params.isSelection)){let f=c.entry.params.view.params.radius;qe.expand(d,d,y.create(f,f,f))}break}let p=m?{}:yield this.queryData(d);if(!p)return!1;let h=c.entry.params.channels;return this.info.kind==="x-ray"?(this.channels["2fo-fc"]=this.createChannel(p["2FO-FC"]||xe.One,h["2fo-fc"],this.info.header.sampling[0].valuesInfo[0]),this.channels["fo-fc(+ve)"]=this.createChannel(p["FO-FC"]||xe.One,h["fo-fc(+ve)"],this.info.header.sampling[0].valuesInfo[1]),this.channels["fo-fc(-ve)"]=this.createChannel(p["FO-FC"]||xe.One,h["fo-fc(-ve)"],this.info.header.sampling[0].valuesInfo[1])):this.channels.em=this.createChannel(p.EM||xe.One,h.em,this.info.header.sampling[0].valuesInfo[0]),!0})}createChannel(c,u,d){let m=u;return{data:c,color:m.color,wireframe:m.wireframe,opacity:m.opacity,isoValue:m.isoValue.kind==="relative"?m.isoValue:xe.IsoValue.toRelative(m.isoValue,d)}}getDescription(){return this.params.entry.params.view.name==="selection-box"?"Selection":this.params.entry.params.view.name==="camera-target"?"Camera":this.params.entry.params.view.name==="box"?"Static Box":this.params.entry.params.view.name==="cell"?"Cell":""}constructor(c,u){super(c,{}),this.plugin=c,this.data=u,this.cache=ov.create(25),this.params={},this.lastLoci=St,this.ref="",this.cameraTargetObservable=this.plugin.canvas3d.didDraw.pipe(qc(500,void 0,{leading:!0,trailing:!0}),hz(()=>{var d;return(d=this.plugin.canvas3d)===null||d===void 0?void 0:d.camera.getSnapshot()}),yz((d,m)=>this.isCameraTargetSame(d,m)),d0(d=>d!==void 0)),this.cameraTargetSubscription=void 0,this.channels={},this._invTransform=W(),this.infoMap=new Map,this.data.entries.forEach(d=>this.infoMap.set(d.dataId,d)),this.updateQueue=new H2}}t.Behavior=s})(di||(di={}));var B3={};ua(B3,{ClippingStructureRepresentation3DFromBundle:()=>u0e,ClippingStructureRepresentation3DFromScript:()=>c0e,EmissiveStructureRepresentation3DFromBundle:()=>a0e,EmissiveStructureRepresentation3DFromScript:()=>i0e,ExplodeStructureRepresentation3D:()=>Jye,ModelUnitcell3D:()=>f0e,OverpaintStructureRepresentation3DFromBundle:()=>r0e,OverpaintStructureRepresentation3DFromScript:()=>t0e,ShapeRepresentation3D:()=>p0e,SpinStructureRepresentation3D:()=>e0e,StructureBoundingBox3D:()=>h0e,StructureRepresentation3D:()=>Tv,StructureSelectionsAngle3D:()=>y0e,StructureSelectionsDihedral3D:()=>v0e,StructureSelectionsDistance3D:()=>g0e,StructureSelectionsLabel3D:()=>b0e,StructureSelectionsOrientation3D:()=>x0e,StructureSelectionsPlane3D:()=>S0e,SubstanceStructureRepresentation3DFromBundle:()=>l0e,SubstanceStructureRepresentation3DFromScript:()=>s0e,ThemeStrengthRepresentation3D:()=>d0e,TransparencyStructureRepresentation3DFromBundle:()=>o0e,TransparencyStructureRepresentation3DFromScript:()=>n0e,UnwindStructureAssemblyRepresentation3D:()=>Zye,VolumeRepresentation3D:()=>m0e,VolumeRepresentation3DHelpers:()=>hu});var q2=ce(13421772),ufe="Assigns colors according to the Symbol Nomenclature for Glycans (SNFG).",O8={};function dfe(t){return O8}function F8(t,e){let r;if(t.structure){let{elements:n,getElementIndices:o}=t.structure.carbohydrates,i=(a,s)=>{if(!Pe.isAtomic(a))return q2;let l=o(a,s);return l.length>0?n[l[0]].component.color:q2};r=(a,s)=>s?zz.Secondary:z.Location.is(a)?i(a.unit,a.element):ze.isLocation(a)?i(a.aUnit,a.aUnit.elements[a.aIndex]):q2}else r=()=>q2;return{factory:F8,granularity:"group",color:r,props:e,description:ufe,legend:vs(Gz)}}var N8={name:"carbohydrate-symbol",label:"Carbohydrate Symbol",category:zt.Residue,factory:F8,getParams:dfe,defaultValues:g.getDefaultValues(O8),isApplicable:t=>!!t.structure&&t.structure.models.some(e=>Et.hasCarbohydrate(e))};var zM={hue:g.Interval([1,360],{min:0,max:360,step:1}),chroma:g.Interval([40,70],{min:0,max:100,step:1}),luminance:g.Interval([15,85],{min:0,max:100,step:1}),sort:g.Select("contrast",g.arrayToOptions(["none","contrast"]),{description:"no sorting leaves colors approximately ordered by hue"}),clusteringStepCount:g.Numeric(50,{min:10,max:200,step:1},{isHidden:!0}),minSampleCount:g.Numeric(800,{min:100,max:5e3,step:100},{isHidden:!0}),sampleCountFactor:g.Numeric(5,{min:1,max:100,step:1},{isHidden:!0})},iv=2,Hg=[0,0,0],qg=[0,0,0];function mfe(t,e){return em.toHcl(Hg,t),em.fromColor(qg,em.toColor(t)),Hg[0]>=e.hue[0]&&Hg[0]<=e.hue[1]&&Hg[1]>=e.chroma[0]&&Hg[1]<=e.chroma[1]&&Hg[2]>=e.luminance[0]&&Hg[2]<=e.luminance[1]&&qg[0]>=t[0]-iv&&qg[0]<=t[0]+iv&&qg[1]>=t[1]-iv&&qg[1]<=t[1]+iv&&qg[2]>=t[2]-iv&&qg[2]<=t[2]+iv}function pfe(t){let e=t.slice(0),r=[e.shift()];for(;e.length>0;){let n=r[r.length-1],o=0,i=Number.NEGATIVE_INFINITY;for(let a=0;a<e.length;++a){let s=em.distance(n,e[a]);s>i&&(i=s,o=a)}r.push(e.splice(o,1)[0])}return r}function ffe(t,e){let r=new Map,n=Math.ceil(Math.cbrt(t)),o=TA(),i=Math.max((e.hue[1]-e.hue[0])/n,1),a=Math.max((e.chroma[1]-e.chroma[0])/n,1),s=Math.max((e.luminance[1]-e.luminance[0])/n,1);for(let l=e.hue[0]+i/2;l<=e.hue[1];l+=i)for(let c=e.chroma[0]+a/2;c<=e.chroma[1];c+=a)for(let u=e.luminance[0]+s/2;u<=e.luminance[1];u+=s){let d=em.fromHcl(em(),TA.set(o,l,c,u));mfe(d,e)&&r.set(em.toColor(d),d)}return Array.from(r.values())}function V8(t,e){let r=1/0,n=0;for(let o=0;o<t.length;o++){let i=em.distance(e,t[o]);i<r&&(r=i,n=o)}return n}function z8(t,e={}){let r=w(w({},g.getDefaultValues(zM)),e);if(t<=0)return[];let n=ffe(Math.max(r.minSampleCount,t*r.sampleCountFactor),r);if(n.length<t)return console.warn("Not enough samples to generate distinct colors, increase sample count."),new Array(t).fill(ut.lightgrey);let o=[],i=[],a=Math.floor(n.length/t);for(let l=0;l<n.length&&(o.push(n[l]),i.push([]),!(o.length>=t));l+=a);for(let l=1;l<=r.clusteringStepCount;++l){let c=$s(i),u=$s(n);for(let m=0;m<o.length;++m){let p=V8(u,o[m]);c[m].push(n[p]),u.splice(p,1)}for(let m=0;m<u.length;++m){let p=V8(o,n[m]);c[p].push(n[m])}let d=$s(o);for(let m=0;m<c.length;++m){let p=c[m],h=p.length;if(h===0)continue;let f=0,b=0,v=0;for(let E of p)f+=E[0],b+=E[1],v+=E[2];let x=f/h,S=b/h,T=v/h;o[m]=[x,S,T]}if(ys(d,o))break}return(r.sort==="contrast"?pfe(o):o).map(l=>em.toColor(l))}var G8={type:"generate",colorList:"red-yellow-blue"};function Dn(t={}){let e=w(w({},G8),t);return{palette:g.MappedStatic(e.type,{colors:g.Group({list:g.ColorList(e.colorList)},{isFlat:!0}),generate:g.Group(U(w({},zM),{maxCount:g.Numeric(75,{min:1,max:250,step:1})}),{isFlat:!0})},{options:[["colors","Color List"],["generate","Generate Distinct"]]})}}var xQe=g.getDefaultValues(Dn()),U8={valueLabel:t=>`${t+1}`,minLabel:"Start",maxLabel:"End"};function zn(t,e,r={}){var n;let o,i;if(e.palette.name==="colors"&&e.palette.params.list.kind==="interpolate"){let{list:a}=e.palette.params,s=[0,t-1],{minLabel:l,maxLabel:c}=w(w({},U8),r),u=a.colors;u.length===0&&(u=Za(G8.colorList).list);let d=ki.create({listOrName:u,domain:s,minLabel:l,maxLabel:c});i=d.legend,o=d.color}else{let a;e.palette.name==="colors"?(a=e.palette.params.list.colors.map(u=>Array.isArray(u)?u[0]:u),a.length===0&&(a=Za("dark-2").list.map(u=>Array.isArray(u)?u[0]:u))):(t=Math.min(t,e.palette.params.maxCount),a=z8(t,e.palette.params));let s=(n=r.valueLabel)!==null&&n!==void 0?n:U8.valueLabel,l=a.length,c=[];for(let u=0;u<t;++u){let d=u%l;c[d]===void 0?c[d]=[s(u),a[d]]:c[d][0]+=`, ${s(u)}`}i=vs(c),o=u=>a[u%l]}return{color:o,legend:i}}var hfe="many-distinct",j8=ce(16448250),gfe="Gives every chain a color based on its `asym_id` value.",Mf=w({asymId:g.Select("auth",g.arrayToOptions(["auth","label"]))},Dn({type:"colors",colorList:hfe}));function yfe(t){var e;let r=g.clone(Mf);return!((e=t.structure)===null||e===void 0)&&e.models.some(n=>n.coarseHierarchy.isDefined)&&(r.asymId.defaultValue="label"),r}function vfe(t,e){switch(t.kind){case 0:return e==="auth"?Ne.chain.auth_asym_id:Ne.chain.label_asym_id;case 1:case 2:return Ne.coarse.asym_id}}function H8(t,e){let r=vfe(t.unit,e)(t);return t.structure.root.models.length>1?q8(t.unit.model,r):r}function q8(t,e){return`${e}|${(Et.Index.get(t).value||0)+1}`}function bfe(t,e){let r=new Map;for(let n of t.models){let o=Et.AsymIdOffset.get(n).value,i=(e==="auth"?o?.auth:o?.label)||0,a=0;n.properties.structAsymMap.forEach(({auth_id:s},l)=>{let c=e==="auth"?s:l,u=t.models.length>1?q8(n,c):c;r.has(u)||(r.set(u,a+i),++a)})}return r}function Rf(t,e){let r,n;if(t.structure){let o=z.Location.create(t.structure.root),i=bfe(t.structure.root,e.asymId),a=Array.from(i.keys()),s=c=>a[c],l=zn(i.size,e,{valueLabel:s});n=l.legend,r=c=>{let u;if(z.Location.is(c)){let d=H8(c,e.asymId);u=i.get(d)}else if(ze.isLocation(c)){o.unit=c.aUnit,o.element=c.aUnit.elements[c.aIndex];let d=H8(o,e.asymId);u=i.get(d)}return u===void 0?j8:l.color(u)}}else r=()=>j8;return{factory:Rf,granularity:"group",color:r,props:e,description:gfe,legend:n}}var W2={name:"chain-id",label:"Chain Id",category:zt.Chain,factory:Rf,getParams:yfe,defaultValues:g.getDefaultValues(Mf),isApplicable:t=>!!t.structure};var W8=ce(13421772),xfe="Gives every element (atom or coarse sphere/gaussian) a unique color based on the position (index) of the element in the list of elements in the structure.",X8=w({},Dn({type:"colors",colorList:"red-yellow-blue"}));function Sfe(t){return X8}function Y8(t,e){let r,n;if(t.structure){let{units:o}=t.structure.root,i=o.length,a=new Map,s=new Map,l=0;for(let u=0;u<i;++u)a.set(u,l),l+=o[u].elements.length,s.set(o[u].id,u);let c=zn(l,e);n=c.legend,r=u=>{if(z.Location.is(u)){let d=s.get(u.unit.id),m=we.findPredecessorIndex(o[d].elements,u.element);return c.color(a.get(d)+m)}else if(ze.isLocation(u)){let d=s.get(u.aUnit.id),m=we.findPredecessorIndex(o[d].elements,u.aUnit.elements[u.aIndex]);return c.color(a.get(d)+m)}return W8}}else r=()=>W8;return{factory:Y8,granularity:"groupInstance",preferSmoothing:!0,color:r,props:e,description:xfe,legend:n}}var Q8={name:"element-index",label:"Element Index",category:zt.Atom,factory:Y8,getParams:Sfe,defaultValues:g.getDefaultValues(X8),isApplicable:t=>!!t.structure};function Lf(t){let e={};return ro(t,(r,n)=>{e[n]=g.Color(t[n])}),e}var Cfe="many-distinct",K8=ce(13421772),Tfe="Assigns a color based on the operator name of a transformed chain.",X2=w({},Dn({type:"colors",colorList:Cfe}));function wfe(t){return g.clone(X2)}function _fe(t){let e=new Map;for(let r=0,n=t.units.length;r<n;++r){let o=t.units[r].conformation.operator.name;e.has(o)||e.set(o,e.size)}return e}function Y2(t,e){let r,n;if(t.structure){let o=_fe(t.structure.root),i=Array.from(o.keys()),a=l=>i[l],s=zn(o.size,e,{valueLabel:a});n=s.legend,r=l=>{let c;if(z.Location.is(l)){let u=l.unit.conformation.operator.name;c=o.get(u)}else if(ze.isLocation(l)){let u=l.aUnit.conformation.operator.name;c=o.get(u)}return c===void 0?K8:s.color(c)}}else r=()=>K8;return{factory:Y2,granularity:"instance",color:r,props:e,description:Tfe,legend:n}}var av={name:"operator-name",label:"Operator Name",category:zt.Symmetry,factory:Y2,getParams:wfe,defaultValues:g.getDefaultValues(X2),isApplicable:t=>!!t.structure};var Pfe="many-distinct",$8=ce(16448250),Efe="Gives every chain a color based on its `label_entity_id` value.",Bf=w({},Dn({type:"colors",colorList:Pfe}));function Ife(t){return g.clone(Bf)}function D1(t,e){return`${t}|${e}`}function Dfe(t){let e=new Map;for(let r=0,n=t.models.length;r<n;++r){let{label_entity_id:o}=t.models[r].atomicHierarchy.chains;for(let a=0,s=o.rowCount;a<s;++a){let l=D1(o.value(a),r);e.has(l)||e.set(l,e.size)}let{coarseHierarchy:i}=t.models[r];if(i.isDefined){let{entity_id:a}=i.spheres;for(let l=0,c=a.rowCount;l<c;++l){let u=D1(a.value(l),r);e.has(u)||e.set(u,e.size)}let{entity_id:s}=i.gaussians;for(let l=0,c=s.rowCount;l<c;++l){let u=D1(s.value(l),r);e.has(u)||e.set(u,e.size)}}}return e}function Z8(t){switch(t.unit.kind){case 0:return Ne.chain.label_entity_id(t);case 1:case 2:return Ne.coarse.entity_id(t)}}function Of(t,e){let r,n;if(t.structure){let o=z.Location.create(t.structure.root),i=Dfe(t.structure.root),a=Array.from(i.keys()),s=c=>a[c],l=zn(i.size,e,{valueLabel:s});n=l.legend,r=c=>{let u;if(z.Location.is(c)){let d=Z8(c),m=c.structure.models.indexOf(c.unit.model),p=D1(d,m);u=i.get(p)}else if(ze.isLocation(c)){o.unit=c.aUnit,o.element=c.aUnit.elements[c.aIndex];let d=Z8(o),m=o.structure.models.indexOf(o.unit.model),p=D1(d,m);u=i.get(p)}return u===void 0?$8:l.color(u)}}else r=()=>$8;return{factory:Of,granularity:"group",color:r,props:e,description:Efe,legend:n}}var J8={name:"entity-id",label:"Entity Id",category:zt.Chain,factory:Of,getParams:Ife,defaultValues:g.getDefaultValues(Bf),isApplicable:t=>!!t.structure};var GM="dark-2",Q2=ce(16448250),Afe="Gives ranges of a polymer chain a color based on the entity source it originates from (e.g. gene, plasmid, organism).",Ff=w({},Dn({type:"colors",colorList:GM}));function kfe(t){let e=g.clone(Ff);return t.structure&&t9(t.structure.root.models).srcKeySerialMap.size>tm[GM].list.length&&(e.palette.defaultValue.name="colors",e.palette.defaultValue.params=U(w({},e.palette.defaultValue.params),{list:{kind:"interpolate",colors:Za(GM).list}})),e}function e9(t,e){return`${t}|${e}`}function Mfe(t,e,r,n,o,i){return`${t}|${e}|${r}|${i||o||n}`}function UM(t,e,r,n,o,i,a,s){let{entity_id:l,pdbx_src_id:c,pdbx_beg_seq_num:u,pdbx_end_seq_num:d}=o;for(let m=0,p=o._rowCount;m<p;++m){let h=l.value(m),f=e9(r,h),b;if(t.has(f))b=t.get(f);else{let D=n.entities.getEntityIndex(h),P=n.sequence.sequences[D].sequence;b=new Int16Array(P.length),t.set(f,b)}let v=a?a.value(m):"",x=s?s.value(m)[0]:"",S=Mfe(r,h,i.value(m),c.value(m),v,x),T=u.valueKind(m)===0?u.value(m):1,E=d.valueKind(m)===0?d.value(m):b.length,_;e.has(S)?_=e.get(S):(_=e.size+1,e.set(S,_));for(let D=T,P=E;D<=P;++D)b[D-1]=_}}function t9(t){let e=new Map,r=new Map;for(let n=0,o=t.length;n<o;++n){let i=t[n];if(!op.is(i.sourceData))continue;let{entity_src_gen:a,entity_src_nat:s,pdbx_entity_src_syn:l}=i.sourceData.data.db;UM(e,r,n,i,a,a.pdbx_gene_src_scientific_name,a.plasmid_name,a.pdbx_gene_src_gene),UM(e,r,n,i,s,s.pdbx_organism_scientific,s.pdbx_plasmid_name),UM(e,r,n,i,l,l.organism_scientific)}return{seqToSrcByModelEntity:e,srcKeySerialMap:r}}function Rfe(t){let e=0;return Array.from(t.keys()).map(r=>{let n=r.split("|"),o=n[2];return`${iU(n[3])?`Unnamed ${++e}`:n[3]}${o?` (${o})`:""}`})}function Nf(t,e){let r,n;if(t.structure){let o=z.Location.create(t.structure),{models:i}=t.structure.root,{seqToSrcByModelEntity:a,srcKeySerialMap:s}=t9(i),l=Rfe(s),c=m=>l[m],u=zn(s.size,e,{valueLabel:c});n=u.legend;let d=m=>{let p=i.indexOf(m.unit.model),h=Ne.entity.id(m),f=e9(p,h),b=a.get(f);if(b){let v=b[Ne.residue.label_seq_id(m)-1]-1;return v===-1?Q2:u.color(v)}else return Q2};r=m=>z.Location.is(m)?d(m):ze.isLocation(m)?(o.unit=m.aUnit,o.element=m.aUnit.elements[m.aIndex],d(o)):Q2}else r=()=>Q2;return{factory:Nf,granularity:"group",color:r,props:e,description:Afe,legend:n}}var r9={name:"entity-source",label:"Entity Source",category:zt.Chain,factory:Nf,getParams:kfe,defaultValues:g.getDefaultValues(Ff),isApplicable:t=>!!t.structure};var n9=ce(13421772),Lfe="Gives every model a unique color based on its index.",Vf=w({},Dn({type:"colors",colorList:"many-distinct"}));function Bfe(t){return g.clone(Vf)}function zf(t,e){var r;let n,o;if(t.structure){let i=((r=Et.MaxIndex.get(t.structure.models[0]).value)!==null&&r!==void 0?r:-1)+1,a=zn(i,e);o=a.legend,n=s=>z.Location.is(s)?a.color(Et.Index.get(s.unit.model).value||0):ze.isLocation(s)?a.color(Et.Index.get(s.aUnit.model).value||0):n9}else n=()=>n9;return{factory:zf,granularity:"instance",color:n,props:e,description:Lfe,legend:o}}var o9={name:"model-index",label:"Model Index",category:zt.Chain,factory:zf,getParams:Bfe,defaultValues:g.getDefaultValues(Vf),isApplicable:t=>!!t.structure&&t.structure.elementCount>0};var i9=ce(13421772),Ofe="Gives every structure a unique color based on its index.",Uf=w({},Dn({type:"colors",colorList:"many-distinct"}));function Ffe(t){return g.clone(Uf)}function Gf(t,e){var r;let n,o;if(t.structure){let i=((r=ue.MaxIndex.get(t.structure).value)!==null&&r!==void 0?r:-1)+1,a=zn(i,e);o=a.legend,n=s=>z.Location.is(s)?a.color(ue.Index.get(s.structure).value||0):ze.isLocation(s)?a.color(ue.Index.get(s.aStructure).value||0):i9}else n=()=>i9;return{factory:Gf,granularity:"instance",color:n,props:e,description:Ofe,legend:o}}var a9={name:"structure-index",label:"Structure Index",category:zt.Chain,factory:Gf,getParams:Ffe,defaultValues:g.getDefaultValues(Uf),isApplicable:t=>!!t.structure&&t.structure.elementCount>0};var jM="dark-2",s9=ce(13421772),Nfe="Gives every chain instance (single chain or collection of single elements) a unique color based on the position (index) of the chain in the list of chains in the structure.",K2=w({},Dn({type:"colors",colorList:jM}));function Vfe(t){let e=g.clone(K2);return t.structure&&t.structure.root.units.length>tm[jM].list.length&&(e.palette.defaultValue.name="colors",e.palette.defaultValue.params=U(w({},e.palette.defaultValue.params),{list:{kind:"interpolate",colors:Za(jM).list}})),e}function $2(t,e){let r,n;if(t.structure){let{units:o}=t.structure.root,i=zn(o.length,e);n=i.legend;let a=new Map;for(let s=0,l=o.length;s<l;++s)a.set(o[s].id,i.color(s));r=s=>z.Location.is(s)?a.get(s.unit.id):ze.isLocation(s)?a.get(s.aUnit.id):s9}else r=()=>s9;return{factory:$2,granularity:"instance",color:r,props:e,description:Nfe,legend:n}}var l9={name:"unit-index",label:"Chain Instance",category:zt.Chain,factory:$2,getParams:Vfe,defaultValues:g.getDefaultValues(K2),isApplicable:t=>!!t.structure};var c9={H:16777215,D:16777152,T:16777120,HE:14286847,LI:13402367,BE:12779264,B:16758197,C:9474192,N:3166456,O:16715021,F:9494608,NE:11789301,NA:11230450,MG:9109248,AL:12560038,SI:1578e4,P:16744448,S:16777008,CL:2093087,AR:8442339,K:9388244,CA:4062976,SC:15132390,TI:12567239,V:10921643,CR:9083335,MN:10255047,FE:14706227,CO:15765664,NI:5296208,CU:13140019,ZN:8224944,GA:12750735,GE:6721423,AS:12419299,SE:16752896,BR:10889513,KR:6076625,RB:7351984,SR:65280,Y:9764863,ZR:9756896,NB:7586505,MO:5551541,TC:3907230,RU:2396047,RH:687500,PD:27013,AG:12632256,CD:16767375,IN:10909043,SN:6717568,SB:10380213,TE:13924864,I:9699476,XE:9699476,CS:5707663,BA:51456,LA:7394559,CE:16777159,PR:14286791,ND:13107143,PM:10747847,SM:9437127,EU:6422471,GD:4587463,TB:3211207,DY:2097095,HO:65436,ER:58997,TM:54354,YB:48952,LU:43812,HF:5096191,TA:5089023,W:2200790,RE:2522539,OS:2516630,IR:1528967,PT:13684960,AU:16765219,HG:12105936,TL:10900557,PB:5724513,BI:10375093,PO:11230208,AT:7688005,RN:4358806,FR:4325478,RA:32e3,AC:7384058,TH:47871,PA:41471,U:36863,NP:33023,PU:27647,AM:5528818,CM:7888099,BK:9064419,CF:10565332,ES:11739092,FM:11739066,MD:11734438,NO:12389767,LR:13041766,RF:13369433,DB:13697103,SG:14221381,BH:14680120,HS:15073326,MT:15400998,DS:16777215,RG:16777215,CN:16777215,UUT:16777215,FL:16777215,UUP:16777215,LV:16777215,UUH:16777215},u9=ce(16777215),zfe="Assigns a color to every atom according to its chemical element.",Z2={carbonColor:g.MappedStatic("chain-id",{"chain-id":g.Group(Mf),"unit-index":g.Group(K2,{label:"Chain Instance"}),"entity-id":g.Group(Bf),"entity-source":g.Group(Ff),"operator-name":g.Group(X2),"model-index":g.Group(Vf),"structure-index":g.Group(Uf),uniform:g.Group(ap),"element-symbol":g.EmptyGroup()},{description:"Use chain-id coloring for carbon atoms."}),saturation:g.Numeric(0,{min:-6,max:6,step:.1}),lightness:g.Numeric(.2,{min:-6,max:6,step:.1}),colors:g.MappedStatic("default",{default:g.EmptyGroup(),custom:g.Group(Lf(c9))})};function Ufe(t){return g.clone(Z2)}function Gfe(t,e){let r=t[e];return r===void 0?u9:r}function jfe(t,e){switch(e.name){case"chain-id":return Rf(t,e.params);case"unit-index":return $2(t,e.params);case"entity-id":return Of(t,e.params);case"entity-source":return Nf(t,e.params);case"operator-name":return Y2(t,e.params);case"model-index":return zf(t,e.params);case"structure-index":return Gf(t,e.params);case"uniform":return ud(t,e.params);case"element-symbol":return;default:ur(e)}}function J2(t,e){var r;let n=of(e.colors.name==="default"?c9:e.colors.params,e.saturation,e.lightness),o=(r=jfe(t,e.carbonColor))===null||r===void 0?void 0:r.color;function i(l,c){return o&&l==="C"?o(c,!1):Gfe(n,l)}function a(l){if(z.Location.is(l)){if(Pe.isAtomic(l.unit)){let{type_symbol:c}=l.unit.model.atomicHierarchy.atoms;return i(c.value(l.element),l)}}else if(ze.isLocation(l)&&Pe.isAtomic(l.aUnit)){let{type_symbol:c}=l.aUnit.model.atomicHierarchy.atoms,u=c.value(l.aUnit.elements[l.aIndex]);return i(u,l)}return u9}let s=e.carbonColor.name==="operator-name"||e.carbonColor.name==="unit-index"?"groupInstance":"group";return{factory:J2,granularity:s,preferSmoothing:!0,color:a,props:e,description:zfe,legend:vs(Object.keys(n).map(l=>[l,n[l]]))}}var d9={name:"element-symbol",label:"Element Symbol",category:zt.Atom,factory:J2,getParams:Ufe,defaultValues:g.getDefaultValues(Z2),isApplicable:t=>!!t.structure};var p9={water:3697840,ion:15729279,protein:12496596,RNA:16629894,DNA:12540695,PNA:4367514,saccharide:8374655},HM=ce(16777113),Hfe="Assigns a color based on the molecule type of a residue.",sv={saturation:g.Numeric(0,{min:-6,max:6,step:.1}),lightness:g.Numeric(0,{min:-6,max:6,step:.1}),colors:g.MappedStatic("default",{default:g.EmptyGroup(),custom:g.Group(Lf(p9))})};function qfe(t){return sv}function m9(t,e,r){switch(w0(e,r)){case 2:return t.water;case 3:return t.ion;case 5:return t.protein;case 6:return t.RNA;case 7:return t.DNA;case 8:return t.PNA;case 9:return t.saccharide}return HM}function lv(t,e){let r=of(e.colors.name==="default"?p9:e.colors.params,e.saturation,e.lightness);function n(o){return z.Location.is(o)?m9(r,o.unit,o.element):ze.isLocation(o)?m9(r,o.aUnit,o.aUnit.elements[o.aIndex]):HM}return{factory:lv,granularity:"group",color:n,props:e,description:Hfe,legend:vs(Object.keys(r).map(o=>[o,r[o]]).concat([["Other/unknown",HM]]))}}var f9={name:"molecule-type",label:"Molecule Type",category:zt.Residue,factory:lv,getParams:qfe,defaultValues:g.getDefaultValues(sv),isApplicable:t=>!!t.structure};var qM="dark-2",h9=ce(16448250),Wfe="Gives every polymer chain a color based on its `asym_id` value.",y9=w({},Dn({type:"colors",colorList:qM}));function Xfe(t){let e=g.clone(y9);return t.structure&&v9(t.structure.root).size>tm[qM].list.length&&(e.palette.defaultValue.name="colors",e.palette.defaultValue.params=U(w({},e.palette.defaultValue.params),{list:{kind:"interpolate",colors:Za(qM).list}})),e}function g9(t){switch(t.kind){case 0:return Ne.chain.label_asym_id;case 1:case 2:return Ne.coarse.asym_id}}function v9(t){let e=new Map;for(let r=0,n=t.unitSymmetryGroups.length;r<n;++r){let o=t.unitSymmetryGroups[r].units[0],{model:i}=o;if(Pe.isAtomic(o)){let{chainAtomSegments:a,chains:s}=i.atomicHierarchy,l=$r.transientSegments(a,o.elements);for(;l.hasNext;){let{index:c}=l.move(),u=s.label_entity_id.value(c),d=i.entities.getEntityIndex(u);if(i.entities.data.type.value(d)==="polymer"){let m=s.label_asym_id.value(c);e.has(m)||e.set(m,e.size)}}}else if(Pe.isCoarse(o)){let{chainElementSegments:a,asym_id:s,entity_id:l}=Pe.isSpheres(o)?i.coarseHierarchy.spheres:i.coarseHierarchy.gaussians,c=$r.transientSegments(a,o.elements);for(;c.hasNext;){let{index:u}=c.move(),d=a.offsets[u],m=l.value(d),p=i.entities.getEntityIndex(m);if(i.entities.data.type.value(p)==="polymer"){let h=s.value(d);e.has(h)||e.set(h,e.size)}}}}return e}function b9(t,e){let r,n;if(t.structure){let o=z.Location.create(t.structure),i=v9(t.structure.root),a=Array.from(i.keys()),s=c=>a[c],l=zn(i.size,e,{valueLabel:s});n=l.legend,r=c=>{let u;if(z.Location.is(c)){let d=g9(c.unit);u=i.get(d(c))}else if(ze.isLocation(c)){let d=g9(c.aUnit);o.unit=c.aUnit,o.element=c.aUnit.elements[c.aIndex],u=i.get(d(o))}return u===void 0?h9:l.color(u)}}else r=()=>h9;return{factory:b9,granularity:"group",color:r,props:e,description:Wfe,legend:n}}var x9={name:"polymer-id",label:"Polymer Chain Id",category:zt.Chain,factory:b9,getParams:Xfe,defaultValues:g.getDefaultValues(y9),isApplicable:t=>!!t.structure};var WM="dark-2",S9=ce(13421772),Yfe="Gives every polymer chain instance a unique color based on the position (index) of the polymer in the list of polymers in the structure.",C9=w({},Dn({type:"colors",colorList:WM}));function Qfe(t){let e=g.clone(C9);return t.structure&&T9(t.structure.root)>tm[WM].list.length&&(e.palette.defaultValue.name="colors",e.palette.defaultValue.params=U(w({},e.palette.defaultValue.params),{list:{kind:"interpolate",colors:Za(WM).list}})),e}function T9(t){let e=0,{units:r}=t;for(let n=0,o=r.length;n<o;++n)r[n].polymerElements.length>0&&++e;return e}function w9(t,e){let r,n;if(t.structure){let o=zn(T9(t.structure.root),e);n=o.legend;let{units:i}=t.structure.root,a=new Map;for(let s=0,l=0,c=i.length;s<c;++s)i[s].polymerElements.length>0&&(a.set(i[s].id,o.color(l)),++l);r=s=>{let l;return z.Location.is(s)?l=a.get(s.unit.id):ze.isLocation(s)&&(l=a.get(s.aUnit.id)),l!==void 0?l:S9}}else r=()=>S9;return{factory:w9,granularity:"instance",color:r,props:e,description:Yfe,legend:n}}var _9={name:"polymer-index",label:"Polymer Chain Instance",category:zt.Chain,factory:w9,getParams:Qfe,defaultValues:g.getDefaultValues(C9),isApplicable:t=>!!t.structure};var I9={ALA:9240460,ARG:124,ASN:16743536,ASP:10485826,CYS:16777072,GLN:16731212,GLU:6684672,GLY:15658734,HIS:7368959,ILE:19456,LEU:4546117,LYS:4671416,MET:12099650,PHE:5459026,PRO:5395026,SER:16740418,THR:12078080,TRP:5195264,TYR:9203788,VAL:16747775,A:14423100,G:3329330,I:10145074,C:16766720,T:4286945,U:4251856,DA:14423100,DG:3329330,DI:10145074,DC:16766720,DT:4286945,DU:4251856,APN:14423100,GPN:3329330,CPN:16766720,TPN:4286945},XM=ce(16711935),Kfe="Assigns a color to every residue according to its name.",tw={saturation:g.Numeric(0,{min:-6,max:6,step:.1}),lightness:g.Numeric(1,{min:-6,max:6,step:.1}),colors:g.MappedStatic("default",{default:g.EmptyGroup(),custom:g.Group(Lf(I9))})};function $fe(t){return tw}function P9(t,e){return t.model.atomicHierarchy.atoms.label_comp_id.value(e)}function E9(t,e){let r=t.coarseElements.seq_id_begin.value(e),n=t.coarseElements.seq_id_end.value(e);if(r===n){let o=t.coarseElements.entityKey[e];return t.model.sequence.byEntityKey[o].sequence.compId.value(r-1)}}function ew(t,e){let r=t[e];return r===void 0?XM:r}function rw(t,e){let r=of(e.colors.name==="default"?I9:e.colors.params,e.saturation,e.lightness);function n(o){if(z.Location.is(o))if(Pe.isAtomic(o.unit)){let i=P9(o.unit,o.element);return ew(r,i)}else{let i=E9(o.unit,o.element);if(i)return ew(r,i)}else if(ze.isLocation(o))if(Pe.isAtomic(o.aUnit)){let i=P9(o.aUnit,o.aUnit.elements[o.aIndex]);return ew(r,i)}else{let i=E9(o.aUnit,o.aUnit.elements[o.aIndex]);if(i)return ew(r,i)}return XM}return{factory:rw,granularity:"group",preferSmoothing:!0,color:n,props:e,description:Kfe,legend:vs(Object.keys(r).map(o=>[o,r[o]]).concat([["Unknown",XM]]))}}var D9={name:"residue-name",label:"Residue Name",category:zt.Residue,factory:rw,getParams:$fe,defaultValues:g.getDefaultValues(tw),isApplicable:t=>!!t.structure};var k9={alphaHelix:16711808,threeTenHelix:10485888,piHelix:6291584,betaTurn:6324479,betaStrand:16762880,coil:16777215,bend:6740169,turn:45670,dna:11403518,rna:16580962,carbohydrate:10921722},YM=ce(8421504),Zfe="Assigns a color based on the type of secondary structure and basic molecule type.",nw={saturation:g.Numeric(-1,{min:-6,max:6,step:.1}),lightness:g.Numeric(0,{min:-6,max:6,step:.1}),colors:g.MappedStatic("default",{default:g.EmptyGroup(),custom:g.Group(Lf(k9))})};function Jfe(t){return nw}function A9(t,e,r,n){let o=ts.create(0);if(n&&Pe.isAtomic(e)){let i=n.get(e.invariantId);i&&(o=i.type[i.getIndex(e.residueIndex[r])])}if(ts.is(o,2))return ts.is(o,2048)?t.threeTenHelix:ts.is(o,32768)?t.piHelix:t.alphaHelix;if(ts.is(o,4))return t.betaStrand;if(ts.is(o,8))return t.bend;if(ts.is(o,16))return t.turn;{let i=w0(e,r);if(i===7)return t.dna;if(i===6)return t.rna;if(i===9)return t.carbohydrate;if(i===5)return t.coil}return YM}function ow(t,e){let r=t.structure&&xs.get(t.structure),n=r?f0(r.id,r.version):-1,o=of(e.colors.name==="default"?k9:e.colors.params,e.saturation,e.lightness);function i(a){return z.Location.is(a)?A9(o,a.unit,a.element,r?.value):ze.isLocation(a)?A9(o,a.aUnit,a.aUnit.elements[a.aIndex],r?.value):YM}return{factory:ow,granularity:"group",preferSmoothing:!0,color:i,props:e,contextHash:n,description:Zfe,legend:vs(Object.keys(o).map(a=>[a,o[a]]).concat([["Other",YM]]))}}var M9={name:"secondary-structure",label:"Secondary Structure",category:zt.Residue,factory:ow,getParams:Jfe,defaultValues:g.getDefaultValues(nw),isApplicable:t=>!!t.structure,ensureCustomProperties:{attach:(t,e)=>e.structure?xs.attach(t,e.structure,void 0,!0):Promise.resolve(),detach:t=>t.structure&&xs.ref(t.structure,!1)}};var ehe=ce(13421772),the="Gives every polymer residue a color based on its `seq_id` value.",B9={list:g.ColorList("turbo",{presetKind:"scale"})};function rhe(t){return B9}function R9(t,e){let{model:r}=t;switch(t.kind){case 0:let n=r.atomicHierarchy.residueAtomSegments.index[e];return r.atomicHierarchy.residues.label_seq_id.value(n);case 1:return Math.round((r.coarseHierarchy.spheres.seq_id_begin.value(e)+r.coarseHierarchy.spheres.seq_id_end.value(e))/2);case 2:return Math.round((r.coarseHierarchy.gaussians.seq_id_begin.value(e)+r.coarseHierarchy.gaussians.seq_id_end.value(e))/2)}}function L9(t,e){let{model:r}=t,n="";switch(t.kind){case 0:let a=r.atomicHierarchy.chainAtomSegments.index[e];n=r.atomicHierarchy.chains.label_entity_id.value(a);break;case 1:n=r.coarseHierarchy.spheres.entity_id.value(e);break;case 2:n=r.coarseHierarchy.gaussians.entity_id.value(e);break}if(n==="")return 0;let o=r.entities.getEntityIndex(n);if(o===-1)return 0;let i=r.sequence.byEntityKey[o];return i===void 0?0:i.sequence.length}function O9(t,e){let r=ki.create({listOrName:e.list.colors,minLabel:"Start",maxLabel:"End"});return{factory:O9,granularity:"group",preferSmoothing:!0,color:o=>{if(z.Location.is(o)){let{unit:i,element:a}=o,s=R9(i,a);if(s>0){let l=L9(i,a);if(l)return r.setDomain(0,l-1),r.color(s)}}else if(ze.isLocation(o)){let{aUnit:i,aIndex:a}=o,s=R9(i,i.elements[a]);if(s>0){let l=L9(i,i.elements[a]);if(l)return r.setDomain(0,l-1),r.color(s)}}return ehe},props:e,description:the,legend:r?r.legend:void 0}}var F9={name:"sequence-id",label:"Sequence Id",category:zt.Residue,factory:O9,getParams:rhe,defaultValues:g.getDefaultValues(B9),isApplicable:t=>!!t.structure};var nhe=ce(16777113),ohe="Assigns a color based on the uncertainty or disorder of an element's position, e.g. B-factor or RMSF, depending on the data availability and experimental technique.",V9={domain:g.Interval([0,100]),list:g.ColorList("red-white-blue",{presetKind:"scale"})};function ihe(t){return V9}function N9(t,e){return Pe.isAtomic(t)?t.model.atomicConformation.B_iso_or_equiv.value(e):Pe.isSpheres(t)?t.model.coarseConformation.spheres.rmsf[e]:0}function z9(t,e){let r=ki.create({reverse:!0,domain:e.domain,listOrName:e.list.colors});function n(o){return z.Location.is(o)?r.color(N9(o.unit,o.element)):ze.isLocation(o)?r.color(N9(o.aUnit,o.aUnit.elements[o.aIndex])):nhe}return{factory:z9,granularity:"group",preferSmoothing:!0,color:n,props:e,description:ohe,legend:r?r.legend:void 0}}var U9={name:"uncertainty",label:"Uncertainty/Disorder",category:zt.Atom,factory:z9,getParams:ihe,defaultValues:g.getDefaultValues(V9),isApplicable:t=>!!t.structure&&t.structure.models.some(e=>e.atomicConformation.B_iso_or_equiv.isDefined||e.coarseHierarchy.isDefined)};var ahe=ce(15658734),she="Assigns an illustrative color that gives every chain a color based on the chosen style but with lighter carbons (inspired by David Goodsell's Molecule of the Month style).",G9={style:g.MappedStatic("entity-id",{uniform:g.Group(ap),"chain-id":g.Group(Mf),"entity-id":g.Group(Bf),"entity-source":g.Group(Ff),"molecule-type":g.Group(sv),"model-index":g.Group(Vf),"structure-index":g.Group(Uf)}),carbonLightness:g.Numeric(.8,{min:-6,max:6,step:.1})};function lhe(t){return g.clone(G9)}function che(t,e){switch(e.name){case"uniform":return ud(t,e.params);case"chain-id":return Rf(t,e.params);case"entity-id":return Of(t,e.params);case"entity-source":return Nf(t,e.params);case"molecule-type":return lv(t,e.params);case"model-index":return zf(t,e.params);case"structure-index":return Gf(t,e.params);default:ur(e)}}function j9(t,e){let{color:r,legend:n}=che(t,e.style);function o(a,s){let l=r(a,!1);return s==="C"?ce.lighten(l,e.carbonLightness):l}function i(a){if(z.Location.is(a)&&Pe.isAtomic(a.unit)){let s=a.unit.model.atomicHierarchy.atoms.type_symbol.value(a.element);return o(a,s)}else if(ze.isLocation(a)&&Pe.isAtomic(a.aUnit)){let s=a.aUnit.elements[a.aIndex],l=a.aUnit.model.atomicHierarchy.atoms.type_symbol.value(s);return o(a,l)}return ahe}return{factory:j9,granularity:"group",preferSmoothing:!0,color:i,props:e,description:she,legend:n}}var H9={name:"illustrative",label:"Illustrative",category:zt.Misc,factory:j9,getParams:lhe,defaultValues:g.getDefaultValues(G9),isApplicable:t=>!!t.structure};var uhe='Assigns a color to every amino acid according to the "Experimentally determined hydrophobicity scale for proteins at membrane interfaces" by Wimely and White (doi:10.1038/nsb1096-842).',X9={list:g.ColorList("red-yellow-green",{presetKind:"scale"}),scale:g.Select("DGwif",[["DGwif","DG water-membrane"],["DGwoct","DG water-octanol"],["Oct-IF","DG difference"]])};function dhe(t){return X9}var mhe={DGwif:0,DGwoct:1,"Oct-IF":2};function phe(t,e){let r=AT[t];return r===void 0?0:r[e]}function q9(t,e){return t.model.atomicHierarchy.atoms.label_comp_id.value(e)}function W9(t,e){let r=t.coarseElements.seq_id_begin.value(e),n=t.coarseElements.seq_id_end.value(e);if(r===n){let o=t.coarseElements.entityKey[e];return t.model.sequence.byEntityKey[o].sequence.compId.value(r-1)}}function Y9(t,e){let r=mhe[e.scale],n=1/0,o=-1/0;for(let s in AT){let l=AT[s][r];n=Math.min(n,l),o=Math.max(o,l)}let i=ki.create({listOrName:e.list.colors,domain:[o,n],minLabel:"Hydrophilic",maxLabel:"Hydrophobic"});function a(s){let l;return z.Location.is(s)?Pe.isAtomic(s.unit)?l=q9(s.unit,s.element):l=W9(s.unit,s.element):ze.isLocation(s)&&(Pe.isAtomic(s.aUnit)?l=q9(s.aUnit,s.aUnit.elements[s.aIndex]):l=W9(s.aUnit,s.aUnit.elements[s.aIndex])),i.color(l?phe(l,r):0)}return{factory:Y9,granularity:"group",preferSmoothing:!0,color:a,props:e,description:uhe,legend:i?i.legend:void 0}}var Q9={name:"hydrophobicity",label:"Hydrophobicity",category:zt.Residue,factory:Y9,getParams:dhe,defaultValues:g.getDefaultValues(X9),isApplicable:t=>!!t.structure};var K9=ce(13421772),fhe="Gives every model (frame) a unique color based on the index in its trajectory.",$9=w({},Dn({type:"colors",colorList:"purples"}));function hhe(t){return g.clone($9)}function Z9(t,e){var r,n;let o,i;if(t.structure){let{models:a}=t.structure.root,s=0;for(let u of a)s=Math.max(s,((r=Et.TrajectoryInfo.get(u))===null||r===void 0?void 0:r.size)||0);let l=zn(s,e);i=l.legend;let c=new Map;for(let u=0,d=a.length;u<d;++u){let m=((n=Et.TrajectoryInfo.get(a[u]))===null||n===void 0?void 0:n.index)||0;c.set(m,l.color(m))}o=u=>z.Location.is(u)?c.get(Et.TrajectoryInfo.get(u.unit.model).index):ze.isLocation(u)?c.get(Et.TrajectoryInfo.get(u.aUnit.model).index):K9}else o=()=>K9;return{factory:Z9,granularity:"instance",color:o,props:e,description:fhe,legend:i}}var J9={name:"trajectory-index",label:"Trajectory Index",category:zt.Chain,factory:Z9,getParams:hhe,defaultValues:g.getDefaultValues($9),isApplicable:t=>!!t.structure&&t.structure.elementCount>0&&Et.TrajectoryInfo.get(t.structure.models[0]).size>1};var ghe=ce(13421772),yhe="Assigns a color based on the occupancy of an atom.",tq={domain:g.Interval([0,1]),list:g.ColorList("purples",{presetKind:"scale"})};function vhe(t){return tq}function eq(t,e){return Pe.isAtomic(t)?t.model.atomicConformation.occupancy.value(e):0}function rq(t,e){let r=ki.create({reverse:!1,domain:e.domain,listOrName:e.list.colors});function n(o){return z.Location.is(o)?r.color(eq(o.unit,o.element)):ze.isLocation(o)?r.color(eq(o.aUnit,o.aUnit.elements[o.aIndex])):ghe}return{factory:rq,granularity:"group",preferSmoothing:!0,color:n,props:e,description:yhe,legend:r?r.legend:void 0}}var nq={name:"occupancy",label:"Occupancy",category:zt.Atom,factory:rq,getParams:vhe,defaultValues:g.getDefaultValues(tq),isApplicable:t=>!!t.structure&&t.structure.models.some(e=>e.atomicConformation.occupancy.isDefined)};var KM="dark-2",oq=ce(13421772),bhe="Assigns a color based on the operator HKL value of a transformed chain.",iq=w({},Dn({type:"colors",colorList:KM}));function xhe(t){let e=g.clone(iq);return t.structure&&aq(t.structure.root).map.size>tm[KM].list.length&&(e.palette.defaultValue.name="colors",e.palette.defaultValue.params=U(w({},e.palette.defaultValue.params),{list:{kind:"interpolate",colors:Za(KM).list}})),e}var A1=1e4;function $M(t){return t.map(e=>`${e+A1}`.padStart(5,"0")).join("")}function ZM(t){let e=oU(A1,0),r=parseInt(t.substr(0,e)),n=parseInt(t.substr(e,e)),o=parseInt(t.substr(e+e,e));return y.create(r-A1,n-A1,o-A1)}function QM(t){return t.map(e=>e+5).join("")}function aq(t){let e=new Map,r=new Set;for(let a=0,s=t.units.length;a<s;++a){let l=$M(t.units[a].conformation.operator.hkl);r.add(l)}let n=Array.from(r.values()).sort();n.forEach(a=>e.set(a,e.size));let o=ZM(n[0]),i=ZM(n[n.length-1]);return{min:o,max:i,map:e}}function sq(t,e){let r,n;if(t.structure){let{min:o,max:i,map:a}=aq(t.structure.root),s=[];a.forEach((u,d)=>{let m=u%a.size,p=QM(ZM(d));s[m]===void 0?s[m]=p:s[m]+=`, ${p}`});let l={minLabel:QM(o),maxLabel:QM(i),valueLabel:u=>s[u]},c=zn(a.size,e,l);n=c.legend,r=u=>{let d;if(z.Location.is(u)){let m=$M(u.unit.conformation.operator.hkl);d=a.get(m)}else if(ze.isLocation(u)){let m=$M(u.aUnit.conformation.operator.hkl);d=a.get(m)}return d===void 0?oq:c.color(d)}}else r=()=>oq;return{factory:sq,granularity:"instance",color:r,props:e,description:bhe,legend:n}}var lq={name:"operator-hkl",label:"Operator HKL",category:zt.Symmetry,factory:sq,getParams:xhe,defaultValues:g.getDefaultValues(iq),isApplicable:t=>!!t.structure};var vp;(function(t){t.Descriptor={name:"atom_partial_charge"},t.Provider=PT.create(t.Descriptor)})(vp||(vp={}));var JM=ce(16777113),She="Assigns a color based on the partial charge of an atom.",uq={domain:g.Interval([-1,1]),list:g.ColorList("red-white-blue",{presetKind:"scale"})};function Che(t){return uq}function cq(t,e){var r;return(r=vp.Provider.get(t.model))===null||r===void 0?void 0:r.data.value(e)}function dq(t,e){let r=ki.create({domain:e.domain,listOrName:e.list.colors});function n(o){if(z.Location.is(o)){let i=cq(o.unit,o.element);return i!==void 0?r.color(i):JM}else if(ze.isLocation(o)){let i=cq(o.aUnit,o.aUnit.elements[o.aIndex]);return i!==void 0?r.color(i):JM}return JM}return{factory:dq,granularity:"group",preferSmoothing:!0,color:n,props:e,description:She,legend:r?r.legend:void 0}}var mq={name:"partial-charge",label:"Partial Charge",category:zt.Atom,factory:dq,getParams:Che,defaultValues:g.getDefaultValues(uq),isApplicable:t=>!!t.structure&&t.structure.models.some(e=>vp.Provider.get(e)!==void 0)};var The="many-distinct",pq=ce(16448250),whe="Gives every atom a color based on its `label_atom_id` value.",fq=w({},Dn({type:"colors",colorList:The}));function _he(t){return g.clone(fq)}function Phe(t){let e=new Map;for(let r of t.models){let{label_atom_id:n}=r.atomicHierarchy.atoms;for(let o=0,i=n.rowCount;o<i;++o){let a=n.value(o);e.has(a)||e.set(a,e.size)}}return e}function hq(t,e){let r,n;if(t.structure){let o=z.Location.create(t.structure.root),i=Phe(t.structure.root),a=Array.from(i.keys()),s=c=>a[c],l=zn(i.size,e,{valueLabel:s});n=l.legend,r=c=>{let u;if(z.Location.is(c)){let d=Ne.atom.label_atom_id(c);u=i.get(d)}else if(ze.isLocation(c)){o.unit=c.aUnit,o.element=c.aUnit.elements[c.aIndex];let d=Ne.atom.label_atom_id(o);u=i.get(d)}return u===void 0?pq:l.color(u)}}else r=()=>pq;return{factory:hq,granularity:"group",preferSmoothing:!0,color:r,props:e,description:whe,legend:n}}var gq={name:"atom-id",label:"Atom Id",category:zt.Atom,factory:hq,getParams:_he,defaultValues:g.getDefaultValues(fq),isApplicable:t=>!!t.structure};var Ehe="Assign color based on the given value of a volume cell.",yq={colorList:g.ColorList({kind:"interpolate",colors:[[ut.white,0],[ut.red,.25],[ut.white,.5],[ut.blue,.75],[ut.white,1]]},{offsets:!0,isEssential:!0})};function Ihe(t){return yq}function vq(t,e){let r=ki.create({domain:[0,1],listOrName:e.colorList.colors}),n=[];for(let i=0;i<256;++i)n[i]=r.color(i/255);let o={colors:n,filter:"linear"};return{factory:vq,granularity:"direct",props:e,description:Ehe,legend:r.legend,palette:o}}var bq={name:"volume-value",label:"Volume Value",category:zt.Misc,factory:vq,getParams:Ihe,defaultValues:g.getDefaultValues(yq),isApplicable:t=>!!t.volume&&!xe.Segmentation.get(t.volume)};var xq=ce(13421772),Dhe="Gives every volume segment a unique color.",Sq=w({},Dn({type:"colors",colorList:"many-distinct"}));function Ahe(t){return g.clone(Sq)}function Cq(t,e){let r,n,o=t.volume&&xe.Segmentation.get(t.volume);if(o){let i=o.segments.size,a=Array.from(o.segments.keys()),s=zn(i,e);n=s.legend,r=l=>xe.Segment.isLocation(l)?s.color(a.indexOf(l.segment)):xq}else r=()=>xq;return{factory:Cq,granularity:"instance",color:r,props:e,description:Dhe,legend:n}}var Tq={name:"volume-segment",label:"Volume Segment",category:zt.Misc,factory:Cq,getParams:Ahe,defaultValues:g.getDefaultValues(Sq),isApplicable:t=>!!t.volume&&!!xe.Segmentation.get(t.volume)};var khe="Assigns a color based on volume value at a given vertex.",wq={volume:g.ValueRef(t=>t.state.data.selectQ(r=>r.root.subtree().filter(n=>{var o;return xe.is((o=n.obj)===null||o===void 0?void 0:o.data)})).map(r=>{var n,o;return[r.transform.ref,(o=(n=r.obj)===null||n===void 0?void 0:n.label)!==null&&o!==void 0?o:"<unknown>"]}),(t,e)=>e(t)),coloring:g.MappedStatic("absolute-value",{"absolute-value":g.Group({domain:g.MappedStatic("auto",{custom:g.Interval([-1,1]),auto:g.Group({symmetric:g.Boolean(!1,{description:"If true the automatic range is determined as [-|max|, |max|]."})})}),list:g.ColorList("red-white-blue",{presetKind:"scale"})}),"relative-value":g.Group({domain:g.MappedStatic("auto",{custom:g.Interval([-1,1]),auto:g.Group({symmetric:g.Boolean(!1,{description:"If true the automatic range is determined as [-|max|, |max|]."})})}),list:g.ColorList("red-white-blue",{presetKind:"scale"})})}),defaultColor:g.Color(ce(13421772)),normalOffset:g.Numeric(0,{min:0,max:20,step:.1},{description:"Offset vertex position along its normal by given amount."})};function _q(t,e){let r;try{r=e.volume.getValue()}catch{}let n;if(r){let o=e.coloring.params,{stats:i}=r.grid,a=o.domain.name==="custom"?o.domain.params:[i.min,i.max],s=e.coloring.name==="relative-value";if(o.domain.name==="auto"&&s&&(a[0]=(a[0]-i.mean)/i.sigma,a[1]=(a[1]-i.mean)/i.sigma),e.coloring.params.domain.name==="auto"&&e.coloring.params.domain.params.symmetric){let v=Math.max(Math.abs(a[0]),Math.abs(a[1]));a[0]=-v,a[1]=v}let l=ki.create({domain:a,listOrName:o.list.colors}),c=Sn.getGridToCartesianTransform(r.grid);W.invert(c,c);let u=y(),{dimensions:d,get:m}=r.grid.cells.space,p=r.grid.cells.data,[h,f,b]=d;n=v=>{if(!BU(v))return e.defaultColor;y.copy(u,v.position),e.normalOffset>0&&y.scaleAndAdd(u,u,v.normal,e.normalOffset),y.transformMat4(u,u,c);let x=Math.floor(u[0]),S=Math.floor(u[1]),T=Math.floor(u[2]);if(x<0||x>=h||S<0||S>=f||T<0||T>=b)return e.defaultColor;let E=u[0]-x,_=u[1]-S,D=u[2]-T,P=Math.min(x+1,h-1),A=Math.min(S+1,f-1),I=Math.min(T+1,b-1),k=m(p,x,S,T),M=m(p,P,S,T),R=m(p,x,A,T),B=m(p,P,A,T),F=fn(fn(k,M,E),fn(R,B,E),_);k=m(p,x,S,I),M=m(p,P,S,I),R=m(p,x,A,I),B=m(p,P,A,I);let G=fn(fn(k,M,E),fn(R,B,E),_),V=fn(F,G,D);return s&&(V=(V-i.mean)/i.sigma),l.color(V)}}else n=()=>e.defaultColor;return{factory:_q,granularity:"vertex",preferSmoothing:!0,color:n,props:e,description:khe}}var Pq={name:"external-volume",label:"External Volume",category:zt.Misc,factory:_q,getParams:()=>wq,defaultValues:g.getDefaultValues(wq),isApplicable:t=>!0};var Mhe="Uses separate themes for coloring mainchain and sidechain visuals.",Eq={mainchain:g.MappedStatic("molecule-type",{uniform:g.Group(ap),"chain-id":g.Group(Mf),"entity-id":g.Group(Bf),"entity-source":g.Group(Ff),"molecule-type":g.Group(sv),"model-index":g.Group(Vf),"structure-index":g.Group(Uf),"secondary-structure":g.Group(nw)}),sidechain:g.MappedStatic("residue-name",{uniform:g.Group(ap),"residue-name":g.Group(tw),"element-symbol":g.Group(Z2)})};function Rhe(t){return g.clone(Eq)}function Lhe(t,e){switch(e.name){case"uniform":return ud(t,e.params);case"chain-id":return Rf(t,e.params);case"entity-id":return Of(t,e.params);case"entity-source":return Nf(t,e.params);case"molecule-type":return lv(t,e.params);case"model-index":return zf(t,e.params);case"structure-index":return Gf(t,e.params);case"secondary-structure":return ow(t,e.params);default:ur(e)}}function Bhe(t,e){switch(e.name){case"uniform":return ud(t,e.params);case"residue-name":return rw(t,e.params);case"element-symbol":return J2(t,e.params);default:ur(e)}}function Iq(t,e){var r,n;let o=Lhe(t,e.mainchain),i=Bhe(t,e.sidechain);function a(l,c){return c?o.color(l,!1):i.color(l,!1)}let s=o.legend;return((r=o.legend)===null||r===void 0?void 0:r.kind)==="table-legend"&&((n=i.legend)===null||n===void 0?void 0:n.kind)==="table-legend"&&(s={kind:"table-legend",table:[...o.legend.table,...i.legend.table]}),{factory:Iq,granularity:"group",preferSmoothing:!1,color:a,props:e,description:Mhe,legend:s}}var Dq={name:"cartoon",label:"Cartoon",category:zt.Misc,factory:Iq,getParams:Rhe,defaultValues:g.getDefaultValues(Eq),isApplicable:t=>!!t.structure};var wo;(function(t){t.Category=zt,t.PaletteScale=(1<<24)-1,t.EmptyFactory=()=>t.Empty;let e=ce(13421772);t.Empty={factory:t.EmptyFactory,granularity:"uniform",color:()=>e,props:{}};function r(o,i){return o.contextHash===i.contextHash&&o.factory===i.factory&&ys(o.props,i.props)}t.areEqual=r,t.EmptyProvider={name:"",label:"",category:"",factory:t.EmptyFactory,getParams:()=>({}),defaultValues:{},isApplicable:()=>!0};function n(){return new cv(t.BuiltIn,t.EmptyProvider)}t.createRegistry=n,t.BuiltIn={"atom-id":gq,"carbohydrate-symbol":N8,cartoon:Dq,"chain-id":W2,"element-index":Q8,"element-symbol":d9,"entity-id":J8,"entity-source":r9,hydrophobicity:Q9,illustrative:H9,"model-index":o9,"molecule-type":f9,occupancy:nq,"operator-hkl":lq,"operator-name":av,"partial-charge":mq,"polymer-id":x9,"polymer-index":_9,"residue-name":D9,"secondary-structure":M9,"sequence-id":F9,"shape-group":uH,"structure-index":a9,"trajectory-index":J9,uncertainty:U9,"unit-index":l9,uniform:yj,"volume-segment":Tq,"volume-value":bq,"external-volume":Pq}})(wo||(wo={}));var Ohe=1,Fhe="Assigns a physical size, i.e. vdW radius for atoms or given radius for coarse spheres.",Aq={scale:g.Numeric(1,{min:.1,max:5,step:.1})};function Nhe(t){return Aq}function e3(t,e){return Pe.isAtomic(t)?ff(t.model.atomicHierarchy.atoms.type_symbol.value(e)):Pe.isSpheres(t)?t.model.coarseConformation.spheres.radius[e]:0}function kq(t,e){let r=e.scale===void 0?1:e.scale;function n(o){let i;return z.Location.is(o)?i=r*e3(o.unit,o.element):ze.isLocation(o)?i=r*Math.min(e3(o.aUnit,o.aUnit.elements[o.aIndex]),e3(o.bUnit,o.bUnit.elements[o.bIndex])):i=r*Ohe,i}return{factory:kq,granularity:"group",size:n,props:e,description:Fhe}}var Mq={name:"physical",label:"Physical",category:"",factory:kq,getParams:Nhe,defaultValues:g.getDefaultValues(Aq),isApplicable:t=>!!t.structure};var Vhe="Assigns a size reflecting the uncertainty or disorder of an element's position, e.g. B-factor or RMSF, depending on the data availability and experimental technique.",Lq={bfactorFactor:g.Numeric(.1,{min:0,max:1,step:.01}),rmsfFactor:g.Numeric(.05,{min:0,max:1,step:.01}),baseSize:g.Numeric(.2,{min:0,max:2,step:.1})};function zhe(t){return Lq}function Rq(t,e,r){return Pe.isAtomic(t)?t.model.atomicConformation.B_iso_or_equiv.value(e)*r.bfactorFactor:Pe.isSpheres(t)?t.model.coarseConformation.spheres.rmsf[e]*r.rmsfFactor:0}function Bq(t,e){function r(n){let o=e.baseSize;return z.Location.is(n)?o+=Rq(n.unit,n.element,e):ze.isLocation(n)&&(o+=Rq(n.aUnit,n.aUnit.elements[n.aIndex],e)),o}return{factory:Bq,granularity:"group",size:r,props:e,description:Vhe}}var Oq={name:"uncertainty",label:"Uncertainty/Disorder",category:"",factory:Bq,getParams:zhe,defaultValues:g.getDefaultValues(Lq),isApplicable:t=>!!t.structure&&t.structure.models.some(e=>e.atomicConformation.B_iso_or_equiv.isDefined||e.coarseHierarchy.isDefined)};var so;(function(t){t.EmptyFactory=()=>t.Empty,t.Empty={factory:t.EmptyFactory,granularity:"uniform",size:()=>1,props:{}};function e(n,o){return n.contextHash===o.contextHash&&n.factory===o.factory&&ys(n.props,o.props)}t.areEqual=e,t.EmptyProvider={name:"",label:"",category:"",factory:t.EmptyFactory,getParams:()=>({}),defaultValues:{},isApplicable:()=>!0};function r(){return new cv(t.BuiltIn,t.EmptyProvider)}t.createRegistry=r,t.BuiltIn={physical:Mq,"shape-group":lH,uncertainty:Oq,uniform:bj}})(so||(so={}));var An;(function(t){function e(i,a,s,l){l=l||r();let c=s.colorTheme,u=s.sizeTheme;return l.color=i.colorThemeRegistry.create(c.name,a,c.params),l.size=i.sizeThemeRegistry.create(u.name,a,u.params),l}t.create=e;function r(){return{color:wo.Empty,size:so.Empty}}t.createEmpty=r;function n(i,a,s,l){return N(this,null,function*(){var c,u;yield(c=a.colorThemeRegistry.get(l.colorTheme.name).ensureCustomProperties)===null||c===void 0?void 0:c.attach(i,s),yield(u=a.sizeThemeRegistry.get(l.sizeTheme.name).ensureCustomProperties)===null||u===void 0?void 0:u.attach(i,s)})}t.ensureDependencies=n;function o(i,a,s){var l,c;(l=i.colorThemeRegistry.get(s.colorTheme.name).ensureCustomProperties)===null||l===void 0||l.detach(a),(c=i.sizeThemeRegistry.get(s.sizeTheme.name).ensureCustomProperties)===null||c===void 0||c.detach(a)}t.releaseDependencies=o})(An||(An={}));function Fq(t){return t.map(e=>[e.name,e.provider.label,e.provider.category])}var cv=class{get default(){return this._list[0]}get list(){return this._list}get types(){return Fq(this._list)}constructor(e,r){this.emptyProvider=r,this._list=[],this._map=new Map,this._name=new Map,ro(e,(n,o)=>{if(n.name!==o)throw new Error(`Fix build in themes to have matching names. ${n.name} ${o}`);this.add(n)})}sort(){this._list.sort((e,r)=>e.provider.category===r.provider.category?e.provider.label<r.provider.label?-1:e.provider.label>r.provider.label?1:0:e.provider.category<r.provider.category?-1:1)}add(e){if(this._map.has(e.name))throw new Error(`${e.name} already registered.`);let r=e.name;this._list.push({name:r,provider:e}),this._map.set(r,e),this._name.set(e,r),this.sort()}remove(e){this._list.splice(this._list.findIndex(n=>n.name===e.name),1);let r=this._map.get(e.name);r&&(this._map.delete(e.name),this._name.delete(r))}has(e){return this._map.has(e.name)}get(e){return this._map.get(e)||this.emptyProvider}getName(e){if(!this._name.has(e))throw new Error(`'${e.label}' is not a registered theme provider.`);return this._name.get(e)}create(e,r,n={}){let o=this.get(e);return o.factory(r,w(w({},g.getDefaultValues(o.getParams(r))),n))}getApplicableList(e){return this._list.filter(r=>r.provider.isApplicable(e))}getApplicableTypes(e){return Fq(this.getApplicableList(e))}clear(){this._list.length=0,this._map.clear(),this._name.clear()}};var tt=function(t){return t[t.None=0]="None",t[t.Highlight=1]="Highlight",t[t.RemoveHighlight=2]="RemoveHighlight",t[t.Select=4]="Select",t[t.Deselect=8]="Deselect",t[t.Toggle=16]="Toggle",t[t.Clear=32]="Clear",t}(tt||{}),kn;(function(t){t.is=Wc.has,t.All=tt.Highlight|tt.RemoveHighlight|tt.Select|tt.Deselect|tt.Toggle|tt.Clear,t.Highlighting=tt.Highlight|tt.RemoveHighlight|tt.Clear,t.Selecting=tt.Select|tt.Deselect|tt.Toggle|tt.Clear;function e(r,n){return r===tt.Highlight&&n===tt.RemoveHighlight||r===tt.RemoveHighlight&&n===tt.Highlight||r===tt.Select&&n===tt.Deselect||r===tt.Deselect&&n===tt.Select||r===tt.Toggle&&n===tt.Toggle}t.isReverse=e})(kn||(kn={}));function Nq(t,e,r){t.fill(e,0,r)}function uv(t,e,r){switch(r){case tt.Highlight:t[e]|=1;break;case tt.RemoveHighlight:t[e]&=-2;break;case tt.Select:t[e]|=2;break;case tt.Deselect:t[e]&=-3;break;case tt.Toggle:t[e]^=2;break;case tt.Clear:t[e]=0;break}}function ka(t,e,r){if(r===tt.None)return!1;if(Oe.is(e)){let n=Oe.start(e),o=Oe.end(e),i=n+3>>2,a=i+(o-4*i>>2);if(a<=i){for(let m=n;m<o;++m)uv(t,m,r);return!0}let s=new Uint32Array(t.buffer,0,t.buffer.byteLength>>2),l=n,c=Math.min(4*i,o),u=Math.max(n,4*a),d=o;switch(r){case tt.Highlight:for(let m=i;m<a;++m)s[m]|=16843009;break;case tt.RemoveHighlight:for(let m=i;m<a;++m)s[m]&=-16843010;break;case tt.Select:for(let m=i;m<a;++m)s[m]|=33686018;break;case tt.Deselect:for(let m=i;m<a;++m)s[m]&=-33686019;break;case tt.Toggle:for(let m=i;m<a;++m)s[m]^=33686018;break;case tt.Clear:for(let m=i;m<a;++m)s[m]=0;break;default:ur(r)}for(let m=l;m<c;++m)uv(t,m,r);for(let m=u;m<d;++m)uv(t,m,r)}else switch(r){case tt.Highlight:for(let n=0,o=e.length;n<o;++n)t[e[n]]|=1;break;case tt.RemoveHighlight:for(let n=0,o=e.length;n<o;++n)t[e[n]]&=-2;break;case tt.Select:for(let n=0,o=e.length;n<o;++n)t[e[n]]|=2;break;case tt.Deselect:for(let n=0,o=e.length;n<o;++n)t[e[n]]&=-3;break;case tt.Toggle:for(let n=0,o=e.length;n<o;++n)t[e[n]]^=2;break;case tt.Clear:for(let n=0,o=e.length;n<o;++n)t[e[n]]=0;break;default:ur(r)}return!0}function Vq(t,e){let r=-1,n=-1;switch(t){case tt.Highlight:e===0||e===1?(r=1,n=1):e===2||e===3?(r=1,n=3):r=1;break;case tt.RemoveHighlight:e===0||e===1?(r=0,n=0):(e===2||e===3)&&(r=1,n=2);break;case tt.Select:e===1||e===3?(r=1,n=3):e===0||e===2?(r=1,n=2):r=1;break;case tt.Deselect:e===1||e===3?(r=1,n=1):(e===0||e===2)&&(r=0,n=0);break;case tt.Toggle:e===1?(r=1,n=3):e===2?(r=0,n=0):e===3?(r=1,n=1):e===0&&(r=1,n=2);break;case tt.Clear:r=0,n=0;break}return{average:r,status:n}}function zq(t,e){switch(t){case tt.Highlight:return .5;case tt.RemoveHighlight:return e===0?0:e===2||e===3?.5:-1;case tt.Select:return .5;case tt.Deselect:return e===1||e===3?.5:e===0?0:-1;case tt.Toggle:return e===-1?-1:.5;case tt.Clear:return e===-1?-1:e===0?0:.5;case tt.None:return-1;default:ur(t)}}function Jo(t,e){return{kind:t,layers:e}}(function(t){t.Empty={kind:"empty-loci",layers:[]};function e(c,u){if(c.layers.length===0&&u.layers.length===0)return!0;if(c.layers.length!==u.layers.length)return!1;for(let d=0,m=c.layers.length;d<m;++d)if(c.layers[d].value!==u.layers[d].value||!st.areEqual(c.layers[d].loci,u.layers[d].loci))return!1;return!0}t.areEqual=e;function r(c){return c.layers.length===0}t.isEmpty=r;function n(c,u){if(c.kind==="element-loci"){let d=[];for(let m of c.layers){let p=z.Loci.remap(m.loci,u);z.Loci.isEmpty(p)||d.push({loci:p,value:m.value})}return{kind:"element-loci",layers:d}}else return c}t.remap=n;function o(c){if(r(c))return c;if(c.kind==="element-loci"){let{structure:u}=c.layers[0].loci,d=new Map,m=z.Loci.none(u);for(let h=0,f=c.layers.length;h<f;++h){let{loci:b,value:v}=c.layers[f-h-1];b=z.Loci.subtract(b,m),m=z.Loci.union(b,m),z.Loci.isEmpty(b)||(d.has(v)&&(b=z.Loci.union(b,d.get(v))),d.set(v,b))}let p=[];return d.forEach((h,f)=>{p.push({loci:h,value:f})}),{kind:"element-loci",layers:p}}else return c}t.merge=o;function i(c,u){if(r(c))return c;if(c.kind==="element-loci"){let{structure:d}=c.layers[0].loci,m=[];for(let p of c.layers){let{loci:h,value:f}=p,b=z.Loci.remap(h,u);h=z.Loci.remap(b,d),z.Loci.isEmpty(h)||m.push({loci:h,value:f})}return{kind:"element-loci",layers:m}}else return c}t.filter=i;function a(c,u){let d=[];for(let m=0,p=c.length;m<p;++m){let{script:h,value:f}=c[m],b=Jr.toLoci(h,u);z.Loci.isEmpty(b)||d.push({loci:b,value:f})}return{kind:"element-loci",layers:d}}t.ofScript=a;function s(c,u){let d=[];for(let m=0,p=c.length;m<p;++m){let{bundle:h,value:f}=c[m],b=z.Bundle.toLoci(h,u.root);d.push({loci:b,value:f})}return{kind:"element-loci",layers:d}}t.ofBundle=s;function l(c){let u=[];for(let d=0,m=c.layers.length;d<m;++d){let{loci:p,value:h}=c.layers[d],f=z.Bundle.fromLoci(p);u.push({bundle:f,value:h})}return{kind:"element-loci",layers:u}}t.toBundle=l})(Jo||(Jo={}));var Bl;(function(t){function e(){return{updateTransform:!1,updateMatrix:!1,updateColor:!1,updateSize:!1,createGeometry:!1,createNew:!1,info:{}}}t.create=e;function r(n){n.updateTransform=!1,n.updateMatrix=!1,n.updateColor=!1,n.updateSize=!1,n.createGeometry=!1,n.createNew=!1}t.reset=r})(Bl||(Bl={}));var Uhe={lowestElementCount:1e6,lowerElementCount:5e5,lowElementCount:1e5,mediumElementCount:2e4,highElementCount:2e3,coarseGrainedFactor:10,elementCountFactor:1};function t3(t,e={}){let r=w(w({},Uhe),e),n=t.elementCount*r.elementCountFactor;return(t.isCoarseGrained||t.isCoarse)&&(n*=r.coarseGrainedFactor),n>r.lowestElementCount?"lowest":n>r.lowerElementCount?"lower":n>r.lowElementCount?"low":n>r.mediumElementCount?"medium":n>r.highElementCount?"high":"higher"}function Ghe(t){if(t.root.models.length===1){let e=rs.Provider.get(t.root.model);if(e&&e.spacegroup.name==="P 1"&&!pa.isZero(e.spacegroup.cell))return e.spacegroup.cell.volume}return qe.volume(t.root.boundary.box)}function k1(t,e){let r=li(t.quality,"auto"),n=li(t.detail,1),o=li(t.radialSegments,12),i=li(t.linearSegments,8),a=li(t.resolution,2),s=li(t.probePositions,12),l=li(t.doubleSided,!0),c=0;if(r==="auto"){if(e instanceof ue)r=t3(e.root),c=Ghe(e);else if(xe.is(e)){let[u,d,m]=e.grid.cells.space.dimensions;c=u*d*m,r=c<1e7?"medium":"low"}}switch(r){case"highest":n=3,o=36,i=18,a=.1,s=72,l=!0;break;case"higher":n=3,o=28,i=14,a=.3,s=48,l=!0;break;case"high":n=2,o=20,i=10,a=.5,s=36,l=!0;break;case"medium":n=1,o=12,i=8,a=.8,s=24,l=!0;break;case"low":n=0,o=8,i=3,a=1.3,s=24,l=!1;break;case"lower":n=0,o=4,i=2,a=3,s=12,l=!1;break;case"lowest":n=0,o=2,i=1,a=8,s=12,l=!1;break;case"custom":break}return a=Math.max(a,c/5e8),a=Math.min(a,20),t.transparentBackfaces==="off"&&(t.alpha!==void 0&&t.alpha<1||t.xrayShaded)&&(l=!1),{detail:n,radialSegments:o,linearSegments:i,resolution:a,probePositions:s,doubleSided:l}}var iw=y.set,Uq=y.normalize,Gq=y.sub,jq=y.addScalar,aw=y.scale,Hq=y.toArray;function jf(t,e,r,n){let o=!1;if(xe.isLoci(t)){if(!xe.areEquivalent(t.volume,e))return!1;n(Oe.ofLength(e.grid.cells.data.length))&&(o=!0)}else if(xe.Isosurface.isLoci(t)){if(!xe.areEquivalent(t.volume,e))return!1;if(r?.isoValue){if(!xe.IsoValue.areSame(t.isoValue,r.isoValue,e.grid.stats))return!1;n(Oe.ofLength(e.grid.cells.data.length))&&(o=!0)}else{let{stats:i,cells:{data:a}}=e.grid,s=i.sigma,l=xe.IsoValue.toAbsolute(t.isoValue,i).absoluteValue;for(let c=0,u=a.length;c<u;++c)bs(l,a[c],s)&&n(Oe.ofSingleton(c))&&(o=!0)}}else if(xe.Cell.isLoci(t)){if(!xe.areEquivalent(t.volume,e))return!1;Oe.is(t.indices)?n(t.indices)&&(o=!0):we.forEach(t.indices,i=>{n(Oe.ofSingleton(i))&&(o=!0)})}else if(xe.Segment.isLoci(t)){if(!xe.areEquivalent(t.volume,e))return!1;if(r?.segments){if(!tr.areIntersecting(t.segments,r.segments))return!1;n(Oe.ofLength(e.grid.cells.data.length))&&(o=!0)}else{let i=xe.Segmentation.get(e);if(i){let a=new Set;for(let c=0,u=t.segments.length;c<u;++c)no.add(a,i.segments.get(t.segments[c]));let s=Array.from(a.values()),l=e.grid.cells.data;for(let c=0,u=l.length;c<u;++c)s.includes(l[c])&&n(Oe.ofSingleton(c))&&(o=!0)}}}return o}function uu(t,e=0){let r=t[0]*t[1]*t[2],n=Math.sqrt(r),o=Math.pow(2,Math.ceil(Math.log(n)/Math.log(2))),i=t[0]+e,a=t[1]+e,s=1,l=i;return o<i*t[2]?(l=Math.floor(o/i),s=Math.ceil(t[2]/l),i*=l,a*=s):i*=t[2],{width:i,height:a,columns:l,rows:s,powerOfTwoSize:a<o?o:o*2}}function sw(t,e,r=0){let{cells:{space:n,data:o},stats:{max:i,min:a}}=t.grid,s=n.dimensions,{dataOffset:l}=n,{width:c,height:u}=uu(s,r),d=e==="data"?1:4,m=new Uint8Array(c*u*d),p={array:m,width:c,height:u},h=i-a,[f,b,v]=s,x=f+r,S=b+r,T=y(),E=y(),_=f-1,D=b-1,P=v-1;for(let A=0;A<v;++A)for(let I=0;I<b;++I)for(let k=0;k<f;++k){let M=Math.floor(A*x%c/x),R=Math.floor(A*x/c),B=M*x+k,F=d*(R*S*c+I*c+B),G=l(k,I,A);e==="data"?m[F]=Math.round((o[G]-a)/h*255):(e==="groups"?vf(G,m,F):(iw(T,o[l(Math.max(0,k-1),I,A)],o[l(k,Math.max(0,I-1),A)],o[l(k,I,Math.max(0,A-1))]),iw(E,o[l(Math.min(_,k+1),I,A)],o[l(k,Math.min(D,I+1),A)],o[l(k,I,Math.min(P,A+1))]),Uq(T,Gq(T,T,E)),jq(T,aw(T,T,.5),.5),Hq(aw(T,T,255),m,F)),m[F+3]=Math.round((o[G]-a)/h*255))}return p}function qq(t){let{cells:{space:e,data:r},stats:{max:n,min:o}}=t.grid,[i,a,s]=e.dimensions,{dataOffset:l}=e,c=new Uint8Array(i*a*s*4),u={array:c,width:i,height:a,depth:s},d=n-o,m=y(),p=y(),h=i-1,f=a-1,b=s-1,v=0;for(let x=0;x<s;++x)for(let S=0;S<a;++S)for(let T=0;T<i;++T){let E=l(T,S,x);iw(m,r[l(Math.max(0,T-1),S,x)],r[l(T,Math.max(0,S-1),x)],r[l(T,S,Math.max(0,x-1))]),iw(p,r[l(Math.min(h,T+1),S,x)],r[l(T,Math.min(f,S+1),x)],r[l(T,S,Math.min(b,x+1))]),Uq(m,Gq(m,m,p)),jq(m,aw(m,m,.5),.5),Hq(aw(m,m,255),c,v),c[v+3]=Math.round((r[E]-o)/d*255),v+=4}return u}function Wq(t,e,r,n=0){let o=t.grid.cells.data,i=qe.size(y(),r),a=t.grid.cells.space.dataOffset,{width:s,height:l}=uu(i,n),c=1,u=new Uint8Array(s*l*c),d={array:u,width:s,height:l},[m,p,h]=i,f=m-1,b=p-1,v=h-1,x=m+n,S=p+n,[T,E,_]=r.min,[D,P,A]=r.max;for(let I=0;I<h;++I)for(let k=0;k<p;++k)for(let M=0;M<m;++M){let R=Math.floor(I*x%s/x),B=Math.floor(I*x/s),F=R*x+M,G=c*(B*S*s+k*s+F),V=e.includes(o[a(M+T,k+E,I+_)])?255:0,H=e.includes(o[a(Math.min(f+D,M+1+T),k+E,I+_)])?255:0,Q=e.includes(o[a(Math.max(0,M-1+T),k+E,I+_)])?255:0,L=e.includes(o[a(M+T,Math.min(b+P,k+1+E),I+_)])?255:0,Y=e.includes(o[a(M+T,Math.max(0,k-1+E),I+_)])?255:0,j=e.includes(o[a(M+T,k+E,Math.min(v+A,I+1+_))])?255:0,O=e.includes(o[a(M+T,k+E,Math.max(0,I-1+_))])?255:0;u[G]=Math.round((V+V+H+Q+L+Y+j+O)/8)}return d}function M1(t,e,r,n,o){let{colorType:i,vertexCount:a,groupCount:s,positionBuffer:l,transformBuffer:c,groupBuffer:u,itemSize:d}=t,m=i.endsWith("Instance"),p=qe.fromSphere3D(qe(),m?t.boundingSphere:t.invariantBoundingSphere),h=1+e,f=qe.expand(qe(),p,y.create(h,h,h)),b=1/e,v=qe.scale(qe(),f,b),x=qe.size(y(),v);y.ceil(x,x),y.add(x,x,y.create(2,2,2));let{min:S}=f,[T,E]=x,{width:_,height:D}=uu(x),P=new Float32Array(_*D*d),A=new Float32Array(_*D),I=new Uint8Array(_*D*d),k={array:I,width:_,height:D,filter:"linear"},M=m?t.instanceCount:1,R=t.colorData.array;function B(O,J,$){let ae=Math.floor($*T%_/T),Z=Math.floor($*T/_),se=ae*T+O;return d*(Z*E*_+J*_+se)}let F=2,[G,V,H]=x,Q=y();for(let O=0;O<M;++O)for(let J=0;J<a;J+=r){y.fromArray(Q,l,J*3),m&&y.transformMat4Offset(Q,Q,c,0,0,O*16),y.sub(Q,Q,S),y.scale(Q,Q,b);let[$,ae,Z]=Q,se=Math.floor($),Me=Math.floor(ae),be=Math.floor(Z),_e=(O*s+u[J])*d,je=Math.max(0,se-F),gt=Math.max(0,Me-F),fr=Math.max(0,be-F),Nr=Math.min(G,se+F+2),Zt=Math.min(V,Me+F+2),oe=Math.min(H,be+F+2);for(let De=je;De<Nr;++De){let Le=De-$;for(let Qe=gt;Qe<Zt;++Qe){let Ue=Qe-ae;for(let Ke=fr;Ke<oe;++Ke){let Ve=Ke-Z,It=Math.sqrt(Le*Le+Ue*Ue+Ve*Ve);if(It>F)continue;let yt=F-It,pe=B(De,Qe,Ke);for(let Ae=0;Ae<d;++Ae)P[pe+Ae]+=R[_e+Ae]*yt;A[pe/d]+=yt}}}}for(let O=0,J=A.length;O<J;++O){let $=O*d,ae=A[O];for(let Z=0;Z<d;++Z)I[$+Z]=Math.round(P[$+Z]/ae)}let L=ne.create(_,D),Y=at.create(S[0],S[1],S[2],b),j=m?"volumeInstance":"volume";if(n){if(!o){let O=d===4?"rgba":d===3?"rgb":"alpha";o=n.resources.texture("image-uint8",O,"ubyte","linear")}return o.load(k),{kind:"volume",texture:o,gridTexDim:L,gridDim:x,gridTransform:Y,type:j}}else{let O=jhe({vertexCount:a,instanceCount:M,transformBuffer:c,positionBuffer:l,colorType:j,grid:I,gridDim:x,gridTexDim:L,gridTransform:Y,vertexStride:3,colorStride:d,outputStride:d});return{kind:"vertex",texture:O,texDim:ne.create(O.width,O.height),type:m?"vertexInstance":"vertex"}}}function jhe(t){let{vertexCount:e,positionBuffer:r,transformBuffer:n,grid:o,gridDim:i,gridTexDim:a,gridTransform:s,vertexStride:l,colorStride:c}=t,u=t.itemOffset||0,d=t.outputStride;if(d+u>c)throw new Error("outputStride + itemOffset must NOT be larger than colorStride");let m=t.colorType.endsWith("Instance"),p=m?t.instanceCount:1,h=Zr(Math.max(1,p*e),d,Uint8Array),{array:f}=h,[b,v]=i,x=a[0],S=y.fromArray(y(),s,0),T=s[3];function E(I,k,M){let R=Math.floor(M*b%x/b),B=Math.floor(M*b/x),F=R*b+I;return c*(B*v*x+k*x+F)}let _=y(),D=y(),P=y(),A=y();for(let I=0;I<p;++I)for(let k=0;k<e;++k){y.fromArray(_,r,k*l),m&&y.transformMat4Offset(_,_,n,0,0,I*16),y.sub(_,_,S),y.scale(_,_,T),y.floor(D,_),y.ceil(P,_),y.sub(A,_,D),y.sub(_,P,D),y.div(A,A,_);let[M,R,B]=D,[F,G,V]=P,[H,Q,L]=A,Y=E(M,R,B)+u,j=E(F,R,B)+u,O=E(M,R,V)+u,J=E(F,R,V)+u,$=E(M,G,B)+u,ae=E(F,G,B)+u,Z=E(M,G,V)+u,se=E(F,G,V)+u,Me=(I*e+k)*d;for(let be=0;be<d;++be){let _e=o[Y+be],je=o[j+be],gt=o[O+be],fr=o[J+be],Nr=o[$+be],Zt=o[ae+be],oe=o[Z+be],De=o[se+be],Le=fn(_e,je,H),Qe=fn(gt,fr,H),Ue=fn(Nr,Zt,H),Ke=fn(oe,De,H),Ve=fn(Le,Ue,Q),It=fn(Qe,Ke,Q);f[Me+be]=fn(Ve,It,L)}}return h}function Hhe(t){return t==="group"||t==="groupInstance"}function dv(t,e,r,n,o){if(!Hhe(t.dColorType.ref.value))return;let i=M1({vertexCount:t.uVertexCount.ref.value,instanceCount:t.uInstanceCount.ref.value,groupCount:t.uGroupCount.ref.value,transformBuffer:t.aTransform.ref.value,instanceBuffer:t.aInstance.ref.value,positionBuffer:t.aPosition.ref.value,groupBuffer:t.aGroup.ref.value,colorData:t.tColor.ref.value,colorType:t.dColorType.ref.value,boundingSphere:t.boundingSphere.ref.value,invariantBoundingSphere:t.invariantBoundingSphere.ref.value,itemSize:3},e,r,n,o);i.kind==="volume"?(C.updateIfChanged(t.dColorType,i.type),C.update(t.tColorGrid,i.texture),C.update(t.uColorTexDim,i.gridTexDim),C.update(t.uColorGridDim,i.gridDim),C.update(t.uColorGridTransform,i.gridTransform)):i.kind==="vertex"&&(C.updateIfChanged(t.dColorType,i.type),C.update(t.tColor,i.texture),C.update(t.uColorTexDim,i.texDim))}function qhe(t){return t==="groupInstance"}function Xq(t,e,r,n,o){if(!qhe(t.dOverpaintType.ref.value))return;let i=M1({vertexCount:t.uVertexCount.ref.value,instanceCount:t.uInstanceCount.ref.value,groupCount:t.uGroupCount.ref.value,transformBuffer:t.aTransform.ref.value,instanceBuffer:t.aInstance.ref.value,positionBuffer:t.aPosition.ref.value,groupBuffer:t.aGroup.ref.value,colorData:t.tOverpaint.ref.value,colorType:t.dOverpaintType.ref.value,boundingSphere:t.boundingSphere.ref.value,invariantBoundingSphere:t.invariantBoundingSphere.ref.value,itemSize:4},e,r,n,o);i.kind==="volume"?(C.updateIfChanged(t.dOverpaintType,i.type),C.update(t.tOverpaintGrid,i.texture),C.update(t.uOverpaintTexDim,i.gridTexDim),C.update(t.uOverpaintGridDim,i.gridDim),C.update(t.uOverpaintGridTransform,i.gridTransform)):i.kind==="vertex"&&(C.updateIfChanged(t.dOverpaintType,i.type),C.update(t.tOverpaint,i.texture),C.update(t.uOverpaintTexDim,i.texDim))}function Whe(t){return t==="groupInstance"}function Yq(t,e,r,n,o){if(!Whe(t.dTransparencyType.ref.value))return;let i=M1({vertexCount:t.uVertexCount.ref.value,instanceCount:t.uInstanceCount.ref.value,groupCount:t.uGroupCount.ref.value,transformBuffer:t.aTransform.ref.value,instanceBuffer:t.aInstance.ref.value,positionBuffer:t.aPosition.ref.value,groupBuffer:t.aGroup.ref.value,colorData:t.tTransparency.ref.value,colorType:t.dTransparencyType.ref.value,boundingSphere:t.boundingSphere.ref.value,invariantBoundingSphere:t.invariantBoundingSphere.ref.value,itemSize:1},e,r,n,o);i.kind==="volume"?(C.updateIfChanged(t.dTransparencyType,i.type),C.update(t.tTransparencyGrid,i.texture),C.update(t.uTransparencyTexDim,i.gridTexDim),C.update(t.uTransparencyGridDim,i.gridDim),C.update(t.uTransparencyGridTransform,i.gridTransform)):i.kind==="vertex"&&(C.updateIfChanged(t.dTransparencyType,i.type),C.update(t.tTransparency,i.texture),C.update(t.uTransparencyTexDim,i.texDim))}function Xhe(t){return t==="groupInstance"}function Qq(t,e,r,n,o){if(!Xhe(t.dEmissiveType.ref.value))return;let i=M1({vertexCount:t.uVertexCount.ref.value,instanceCount:t.uInstanceCount.ref.value,groupCount:t.uGroupCount.ref.value,transformBuffer:t.aTransform.ref.value,instanceBuffer:t.aInstance.ref.value,positionBuffer:t.aPosition.ref.value,groupBuffer:t.aGroup.ref.value,colorData:t.tEmissive.ref.value,colorType:t.dEmissiveType.ref.value,boundingSphere:t.boundingSphere.ref.value,invariantBoundingSphere:t.invariantBoundingSphere.ref.value,itemSize:1},e,r,n,o);i.kind==="volume"?(C.updateIfChanged(t.dEmissiveType,i.type),C.update(t.tEmissiveGrid,i.texture),C.update(t.uEmissiveTexDim,i.gridTexDim),C.update(t.uEmissiveGridDim,i.gridDim),C.update(t.uEmissiveGridTransform,i.gridTransform)):i.kind==="vertex"&&(C.updateIfChanged(t.dEmissiveType,i.type),C.update(t.tEmissive,i.texture),C.update(t.uEmissiveTexDim,i.texDim))}function Yhe(t){return t==="groupInstance"}function Kq(t,e,r,n,o){if(!Yhe(t.dSubstanceType.ref.value))return;let i=M1({vertexCount:t.uVertexCount.ref.value,instanceCount:t.uInstanceCount.ref.value,groupCount:t.uGroupCount.ref.value,transformBuffer:t.aTransform.ref.value,instanceBuffer:t.aInstance.ref.value,positionBuffer:t.aPosition.ref.value,groupBuffer:t.aGroup.ref.value,colorData:t.tSubstance.ref.value,colorType:t.dSubstanceType.ref.value,boundingSphere:t.boundingSphere.ref.value,invariantBoundingSphere:t.invariantBoundingSphere.ref.value,itemSize:4},e,r,n,o);i.kind==="volume"?(C.updateIfChanged(t.dSubstanceType,i.type),C.update(t.tSubstanceGrid,i.texture),C.update(t.uSubstanceTexDim,i.gridTexDim),C.update(t.uSubstanceGridDim,i.gridDim),C.update(t.uSubstanceGridTransform,i.gridTransform)):i.kind==="vertex"&&(C.updateIfChanged(t.dSubstanceType,i.type),C.update(t.tSubstance,i.texture),C.update(t.uSubstanceTexDim,i.texDim))}var $q=`
precision highp float;
precision highp sampler2D;

uniform sampler2D tColor;
uniform sampler2D tCount;
uniform vec2 uTexSize;

void main(void) {
    vec2 coords = gl_FragCoord.xy / uTexSize;
    vec4 color = texture2D(tColor, coords);
    float count = texture2D(tCount, coords).r;

    gl_FragColor = color / count;
}
`;var Zq=`
precision highp float;

varying vec3 vPosition;
varying vec4 vColor;

uniform float uCurrentSlice;
uniform float uCurrentX;
uniform float uCurrentY;
uniform float uResolution;

const float p = 2.0;

void main() {
    vec2 v = gl_FragCoord.xy - vec2(uCurrentX, uCurrentY) - 0.5;
    vec3 fragPos = vec3(v.x, v.y, uCurrentSlice);
    float dist = distance(fragPos, vPosition);
    if (dist > p) discard;

    float f = p - dist;
    gl_FragColor = vColor * f;
    gl_FragData[1] = vec4(f);
}
`;var Jq=`
precision highp float;

#include common
#include read_from_texture

uniform int uGroupCount;

attribute float aSample;
#define SampleID int(aSample)

attribute mat4 aTransform;
attribute float aInstance;

uniform vec2 uGeoTexDim;
uniform sampler2D tPosition;
uniform sampler2D tGroup;

uniform vec2 uColorTexDim;
uniform sampler2D tColor;

varying vec3 vPosition;
varying vec4 vColor;

uniform vec3 uBboxSize;
uniform vec3 uBboxMin;
uniform float uResolution;

void main() {
    vec3 position = readFromTexture(tPosition, SampleID, uGeoTexDim).xyz;
    float group = unpackRGBToInt(readFromTexture(tGroup, SampleID, uGeoTexDim).rgb);

    position = (aTransform * vec4(position, 1.0)).xyz;
    gl_PointSize = 7.0;
    vPosition = (position - uBboxMin) / uResolution;
    gl_Position = vec4(((position - uBboxMin) / uBboxSize) * 2.0 - 1.0, 1.0);

    #if defined(dColorType_group)
        vColor = readFromTexture(tColor, group, uColorTexDim);
    #elif defined(dColorType_groupInstance)
        vColor = readFromTexture(tColor, aInstance * float(uGroupCount) + group, uColorTexDim);
    #endif
}
`;var Qhe={drawCount:Mr("number"),instanceCount:Mr("number"),stride:Mr("number"),uGroupCount:ee("i","material"),aTransform:hr("float32",16,1),aInstance:hr("float32",1,1),aSample:hr("float32",1,0),uGeoTexDim:ee("v2","material"),tPosition:We("texture","rgba","float","nearest","material"),tGroup:We("texture","rgba","float","nearest","material"),uColorTexDim:ee("v2","material"),tColor:We("texture","rgba","ubyte","nearest","material"),dColorType:Ye("string",["group","groupInstance","vertex","vertexInstance"]),uCurrentSlice:ee("f"),uCurrentX:ee("f"),uCurrentY:ee("f"),uBboxMin:ee("v3","material"),uBboxSize:ee("v3","material"),uResolution:ee("f","material")},xc="color-accumulate",R1="color-count";function e7(t,e){let r=new Float32Array(t);for(let n=0;n<t;++n)r[n]=n*e;return r}function Khe(t,e,r,n,o){if(t.namedComputeRenderables[xc]){let i=y.sub(y(),r.max,r.min),a=t.namedComputeRenderables[xc].values,s=Math.round(e.vertexCount/o);(s>a.drawCount.ref.value||o!==a.stride.ref.value)&&C.update(a.aSample,e7(s,o)),C.updateIfChanged(a.drawCount,s),C.updateIfChanged(a.instanceCount,e.instanceCount),C.updateIfChanged(a.stride,o),C.updateIfChanged(a.uGroupCount,e.groupCount),C.update(a.aTransform,e.transformBuffer),C.update(a.aInstance,e.instanceBuffer),C.update(a.uGeoTexDim,ne.set(a.uGeoTexDim.ref.value,e.positionTexture.getWidth(),e.positionTexture.getHeight())),C.update(a.tPosition,e.positionTexture),C.update(a.tGroup,e.groupTexture),C.update(a.uColorTexDim,ne.set(a.uColorTexDim.ref.value,e.colorData.getWidth(),e.colorData.getHeight())),C.update(a.tColor,e.colorData),C.updateIfChanged(a.dColorType,e.colorType),C.updateIfChanged(a.uCurrentSlice,0),C.updateIfChanged(a.uCurrentX,0),C.updateIfChanged(a.uCurrentY,0),C.update(a.uBboxMin,r.min),C.update(a.uBboxSize,i),C.updateIfChanged(a.uResolution,n),t.namedComputeRenderables[xc].update()}else t.namedComputeRenderables[xc]=$he(t,e,r,n,o);return t.namedComputeRenderables[xc]}function $he(t,e,r,n,o){let i=y.sub(y(),r.max,r.min),a=Math.round(e.vertexCount/o),s={drawCount:C.create(a),instanceCount:C.create(e.instanceCount),stride:C.create(o),uGroupCount:C.create(e.groupCount),aTransform:C.create(e.transformBuffer),aInstance:C.create(e.instanceBuffer),aSample:C.create(e7(a,o)),uGeoTexDim:C.create(ne.create(e.positionTexture.getWidth(),e.positionTexture.getHeight())),tPosition:C.create(e.positionTexture),tGroup:C.create(e.groupTexture),uColorTexDim:C.create(ne.create(e.colorData.getWidth(),e.colorData.getHeight())),tColor:C.create(e.colorData),dColorType:C.create(e.colorType),uCurrentSlice:C.create(0),uCurrentX:C.create(0),uCurrentY:C.create(0),uBboxMin:C.create(r.min),uBboxSize:C.create(i),uResolution:C.create(n)},l=w({},Qhe),c=Qt("accumulate",Jq,Zq,{drawBuffers:"required"}),u=dr(t,"points",c,l,s);return mr(u,s)}function Zhe(t){let{gl:e,state:r}=t;r.disable(e.CULL_FACE),r.enable(e.BLEND),r.disable(e.DEPTH_TEST),r.enable(e.SCISSOR_TEST),r.depthMask(!1),r.clearColor(0,0,0,0),r.blendFunc(e.ONE,e.ONE),r.blendEquation(e.FUNC_ADD)}var Jhe=U(w({},Er),{tColor:We("texture","rgba","float","nearest"),tCount:We("texture","alpha","float","nearest"),uTexSize:ee("v2")}),L1="color-normalize";function ege(t,e,r){if(t.namedComputeRenderables[L1]){let n=t.namedComputeRenderables[L1].values;C.update(n.tColor,e),C.update(n.tCount,r),C.update(n.uTexSize,ne.set(n.uTexSize.ref.value,e.getWidth(),e.getHeight())),t.namedComputeRenderables[L1].update()}else t.namedComputeRenderables[L1]=tge(t,e,r);return t.namedComputeRenderables[L1]}function tge(t,e,r){let n=U(w({},Ir),{tColor:C.create(e),tCount:C.create(r),uTexSize:C.create(ne.create(e.getWidth(),e.getHeight()))}),o=w({},Jhe),i=Qt("normalize",zr,$q),a=dr(t,"triangles",i,o,n);return mr(a,n)}function rge(t){let{gl:e,state:r}=t;r.disable(e.CULL_FACE),r.enable(e.BLEND),r.disable(e.DEPTH_TEST),r.enable(e.SCISSOR_TEST),r.depthMask(!1),r.clearColor(0,0,0,0),r.blendFunc(e.ONE,e.ONE),r.blendEquation(e.FUNC_ADD)}function nge(t){let e=t[0]*t[1]*t[2],r=Math.sqrt(e),n=Math.pow(2,Math.ceil(Math.log(r)/Math.log(2))),o=0,i=t[1],a=1,s=t[2];return n<t[0]*t[2]?(s=Math.floor(n/t[0]),a=Math.ceil(t[2]/s),o=s*t[0],i*=a):o=t[0]*t[2],{texDimX:o,texDimY:i,texRows:a,texCols:s,powerOfTwoSize:i<n?n:n*2}}function B1(t,e,r,n,o){let{drawBuffers:i}=n.extensions;if(!i)throw new Error("need WebGL draw buffers");Ee&&n.timer.mark("calcTextureMeshColorSmoothing");let{gl:a,resources:s,state:l,extensions:{colorBufferHalfFloat:c,textureHalfFloat:u}}=n,d=t.colorType.endsWith("Instance"),m=qe.fromSphere3D(qe(),d?t.boundingSphere:t.invariantBoundingSphere),p=1+e,h=qe.expand(qe(),m,y.create(p,p,p)),f=1/e,b=qe.scale(qe(),h,f),v=qe.size(y(),b);y.ceil(v,v),y.add(v,v,y.create(2,2,2));let{min:x}=h,[S,T,E]=v,{texDimX:_,texDimY:D,texCols:P}=nge(v);n.namedFramebuffers[xc]||(n.namedFramebuffers[xc]=n.resources.framebuffer());let A=n.namedFramebuffers[xc];ct(a)?(n.namedTextures[xc]||(n.namedTextures[xc]=c&&u?s.texture("image-float16","rgba","fp16","nearest"):s.texture("image-float32","rgba","float","nearest")),n.namedTextures[R1]||(n.namedTextures[R1]=s.texture("image-float32","alpha","float","nearest"))):(n.namedTextures[xc]||(n.namedTextures[xc]=s.texture("image-float32","rgba","float","nearest")),n.namedTextures[R1]||(n.namedTextures[R1]=s.texture("image-float32","rgba","float","nearest")));let I=n.namedTextures[xc],k=n.namedTextures[R1];I.define(_,D),k.define(_,D),I.attachFramebuffer(A,0),k.attachFramebuffer(A,1);let M=Khe(n,t,h,e,r);l.currentRenderItemId=-1,A.bind(),i.drawBuffers([i.COLOR_ATTACHMENT0,i.COLOR_ATTACHMENT1]);let{uCurrentSlice:R,uCurrentX:B,uCurrentY:F}=M.values;Ee&&n.timer.mark("ColorAccumulate.render"),Zhe(n),l.viewport(0,0,_,D),l.scissor(0,0,_,D),a.clear(a.COLOR_BUFFER_BIT),C.update(F,0);let G=0,V=0,H=0;for(let j=0;j<E;++j)G>=P&&(G-=P,V+=T,H=0,C.update(F,V)),C.update(B,H),C.update(R,j),l.viewport(H,V,S,T),l.scissor(H,V,S,T),M.render(),++G,H+=S;I.detachFramebuffer(A,0),k.detachFramebuffer(A,1),i.drawBuffers([a.COLOR_ATTACHMENT0,a.NONE]),Ee&&n.timer.markEnd("ColorAccumulate.render"),Ee&&n.timer.mark("ColorNormalize.render"),(!o||uj(o))&&(o=s.texture("image-uint8","rgba","ubyte","linear")),o.define(_,D);let Q=ege(n,I,k);l.currentRenderItemId=-1,rge(n),o.attachFramebuffer(A,0),l.viewport(0,0,_,D),l.scissor(0,0,_,D),a.clear(a.COLOR_BUFFER_BIT),Q.render(),Ee&&n.timer.markEnd("ColorNormalize.render");let L=at.create(x[0],x[1],x[2],f),Y=d?"volumeInstance":"volume";return Ee&&n.timer.markEnd("calcTextureMeshColorSmoothing"),{texture:o,gridDim:v,gridTexDim:ne.create(_,D),gridTransform:L,type:Y}}var r3="color-smoothing-rgb",mv="color-smoothing-rgba",pv="color-smoothing-alpha";function oge(t){return t==="group"||t==="groupInstance"}function n3(t,e,r,n,o){if(!oge(t.dColorType.ref.value))return;r*=3,n.namedTextures[r3]||(n.namedTextures[r3]=n.resources.texture("image-uint8","rgb","ubyte","nearest"));let i=n.namedTextures[r3];i.load(t.tColor.ref.value);let a=B1({vertexCount:t.uVertexCount.ref.value,instanceCount:t.uInstanceCount.ref.value,groupCount:t.uGroupCount.ref.value,transformBuffer:t.aTransform.ref.value,instanceBuffer:t.aInstance.ref.value,positionTexture:t.tPosition.ref.value,groupTexture:t.tGroup.ref.value,colorData:i,colorType:t.dColorType.ref.value,boundingSphere:t.boundingSphere.ref.value,invariantBoundingSphere:t.invariantBoundingSphere.ref.value},e,r,n,o);C.updateIfChanged(t.dColorType,a.type),C.update(t.tColorGrid,a.texture),C.update(t.uColorTexDim,a.gridTexDim),C.update(t.uColorGridDim,a.gridDim),C.update(t.uColorGridTransform,a.gridTransform)}function ige(t){return t==="groupInstance"}function t7(t,e,r,n,o){if(!ige(t.dOverpaintType.ref.value))return;r*=3,n.namedTextures[mv]||(n.namedTextures[mv]=n.resources.texture("image-uint8","rgba","ubyte","nearest"));let i=n.namedTextures[mv];i.load(t.tOverpaint.ref.value);let a=B1({vertexCount:t.uVertexCount.ref.value,instanceCount:t.uInstanceCount.ref.value,groupCount:t.uGroupCount.ref.value,transformBuffer:t.aTransform.ref.value,instanceBuffer:t.aInstance.ref.value,positionTexture:t.tPosition.ref.value,groupTexture:t.tGroup.ref.value,colorData:i,colorType:t.dOverpaintType.ref.value,boundingSphere:t.boundingSphere.ref.value,invariantBoundingSphere:t.invariantBoundingSphere.ref.value},e,r,n,o);C.updateIfChanged(t.dOverpaintType,a.type),C.update(t.tOverpaintGrid,a.texture),C.update(t.uOverpaintTexDim,a.gridTexDim),C.update(t.uOverpaintGridDim,a.gridDim),C.update(t.uOverpaintGridTransform,a.gridTransform)}function age(t){return t==="groupInstance"}function r7(t,e,r,n,o){if(!age(t.dTransparencyType.ref.value))return;r*=3,n.namedTextures[pv]||(n.namedTextures[pv]=n.resources.texture("image-uint8","alpha","ubyte","nearest"));let i=n.namedTextures[pv];i.load(t.tTransparency.ref.value);let a=B1({vertexCount:t.uVertexCount.ref.value,instanceCount:t.uInstanceCount.ref.value,groupCount:t.uGroupCount.ref.value,transformBuffer:t.aTransform.ref.value,instanceBuffer:t.aInstance.ref.value,positionTexture:t.tPosition.ref.value,groupTexture:t.tGroup.ref.value,colorData:i,colorType:t.dTransparencyType.ref.value,boundingSphere:t.boundingSphere.ref.value,invariantBoundingSphere:t.invariantBoundingSphere.ref.value},e,r,n,o);C.updateIfChanged(t.dTransparencyType,a.type),C.update(t.tTransparencyGrid,a.texture),C.update(t.uTransparencyTexDim,a.gridTexDim),C.update(t.uTransparencyGridDim,a.gridDim),C.update(t.uTransparencyGridTransform,a.gridTransform)}function sge(t){return t==="groupInstance"}function n7(t,e,r,n,o){if(!sge(t.dEmissiveType.ref.value))return;r*=3,n.namedTextures[pv]||(n.namedTextures[pv]=n.resources.texture("image-uint8","alpha","ubyte","nearest"));let i=n.namedTextures[pv];i.load(t.tEmissive.ref.value);let a=B1({vertexCount:t.uVertexCount.ref.value,instanceCount:t.uInstanceCount.ref.value,groupCount:t.uGroupCount.ref.value,transformBuffer:t.aTransform.ref.value,instanceBuffer:t.aInstance.ref.value,positionTexture:t.tPosition.ref.value,groupTexture:t.tGroup.ref.value,colorData:i,colorType:t.dEmissiveType.ref.value,boundingSphere:t.boundingSphere.ref.value,invariantBoundingSphere:t.invariantBoundingSphere.ref.value},e,r,n,o);C.updateIfChanged(t.dEmissiveType,a.type),C.update(t.tEmissiveGrid,a.texture),C.update(t.uEmissiveTexDim,a.gridTexDim),C.update(t.uEmissiveGridDim,a.gridDim),C.update(t.uEmissiveGridTransform,a.gridTransform)}function lge(t){return t==="groupInstance"}function o7(t,e,r,n,o){if(!lge(t.dSubstanceType.ref.value))return;r*=3,n.namedTextures[mv]||(n.namedTextures[mv]=n.resources.texture("image-uint8","rgba","ubyte","nearest"));let i=n.namedTextures[mv];i.load(t.tSubstance.ref.value);let a=B1({vertexCount:t.uVertexCount.ref.value,instanceCount:t.uInstanceCount.ref.value,groupCount:t.uGroupCount.ref.value,transformBuffer:t.aTransform.ref.value,instanceBuffer:t.aInstance.ref.value,positionTexture:t.tPosition.ref.value,groupTexture:t.tGroup.ref.value,colorData:i,colorType:t.dSubstanceType.ref.value,boundingSphere:t.boundingSphere.ref.value,invariantBoundingSphere:t.invariantBoundingSphere.ref.value},e,r,n,o);C.updateIfChanged(t.dSubstanceType,a.type),C.update(t.tSubstanceGrid,a.texture),C.update(t.uSubstanceTexDim,a.gridTexDim),C.update(t.uSubstanceGridDim,a.gridDim),C.update(t.uSubstanceGridTransform,a.gridTransform)}var Vt;(function(t){function e(p,h){p&&(p.state.visible=h)}t.setVisibility=e;function r(p,h){p&&(p.state.alphaFactor=h)}t.setAlphaFactor=r;function n(p,h){p&&(p.state.pickable=h)}t.setPickable=n;function o(p,h){p&&(p.state.colorOnly=h)}t.setColorOnly=o;function i(p,h,f,b,v){if(!p||Wn(h))return!1;let{tMarker:x,uMarker:S,markerAverage:T,markerStatus:E,uGroupCount:_,instanceCount:D,instanceGranularity:P}=p.values,A=P.ref.value?D.ref.value:_.ref.value*D.ref.value,{array:I}=x.ref.value,k=E.ref.value;if(!So(h)){let F=0;if(b(h,G=>(F+=Oe.size(G),!0),!0),F===0)return!1;F===A&&(h=xf)}let M=!1,R=-1,B=-1;if(So(h)){let F=Vq(f,k);F.status!==-1?(M=k!==F.status,M&&Nq(I,F.status,A)):M=ka(I,Oe.ofLength(A),f),R=F.average,B=F.status}else M=b(h,F=>ka(I,F,f),!0),M&&(R=zq(f,k),v&&v.status!==-1&&R===-1&&kn.isReverse(v.action,f)&&st.areEqual(h,v.loci)&&(B=v.status,R=B===0?0:.5));return M&&(R===-1&&(R=LA(I,A),R===0&&(B=0)),v&&(v.action=f,v.loci=h,v.status=k),C.updateIfChanged(S,B),B===-1&&C.update(x,x.ref.value),C.updateIfChanged(T,R),C.updateIfChanged(E,B)),M}t.mark=i;function a(p,h,f,b,v){if(!p)return;let{tOverpaint:x,dOverpaintType:S,dOverpaint:T,uGroupCount:E,instanceCount:_,instanceGranularity:D}=p.values,P=D.ref.value?_.ref.value:E.ref.value*_.ref.value,A=D.ref.value?"instance":"groupInstance";Cj(h.layers.length?P:0,A,p.values);let{array:I}=x.ref.value;b&&XA(I,0,P);for(let k=0,M=h.layers.length;k<M;++k){let{loci:R,color:B,clear:F}=h.layers[k];f(R,V=>{let H=Oe.start(V),Q=Oe.end(V);return F?XA(I,H,Q):Sj(I,H,Q,B)},!1)}if(C.update(x,x.ref.value),C.updateIfChanged(S,A),C.updateIfChanged(T,h.layers.length>0),h.layers.length!==0&&A!=="instance"&&v&&El(v.props)){let{geometry:k,props:M,webgl:R}=v;if(k.kind==="mesh"){let{resolution:B,overpaintTexture:F}=k.meta,G=os(M.smoothColors,!0,B);G&&(Xq(p.values,G.resolution,G.stride,R,F),k.meta.overpaintTexture=p.values.tOverpaintGrid.ref.value)}else if(R&&k.kind==="texture-mesh"){let{resolution:B,overpaintTexture:F}=k.meta,G=os(M.smoothColors,!0,B);G&&(t7(p.values,G.resolution,G.stride,R,F),k.meta.overpaintTexture=p.values.tOverpaintGrid.ref.value)}}}t.setOverpaint=a;function s(p,h,f,b,v){if(!p)return;let{tTransparency:x,dTransparencyType:S,transparencyAverage:T,dTransparency:E,uGroupCount:_,instanceCount:D,instanceGranularity:P}=p.values,A=P.ref.value?D.ref.value:_.ref.value*D.ref.value,I=P.ref.value?"instance":"groupInstance";Pj(h.layers.length?A:0,I,p.values);let{array:k}=x.ref.value;b&&_j(k,0,A);for(let M=0,R=h.layers.length;M<R;++M){let{loci:B,value:F}=h.layers[M];f(B,V=>{let H=Oe.start(V),Q=Oe.end(V);return wj(k,H,Q,F)},!1)}if(C.update(x,x.ref.value),C.updateIfChanged(T,YA(k,A)),C.updateIfChanged(S,I),C.updateIfChanged(E,h.layers.length>0),h.layers.length!==0&&I!=="instance"&&v&&El(v.props)){let{geometry:M,props:R,webgl:B}=v;if(M.kind==="mesh"){let{resolution:F,transparencyTexture:G}=M.meta,V=os(R.smoothColors,!0,F);V&&(Yq(p.values,V.resolution,V.stride,B,G),M.meta.transparencyTexture=p.values.tTransparencyGrid.ref.value)}else if(B&&M.kind==="texture-mesh"){let{resolution:F,transparencyTexture:G}=M.meta,V=os(R.smoothColors,!0,F);V&&(r7(p.values,V.resolution,V.stride,B,G),M.meta.transparencyTexture=p.values.tTransparencyGrid.ref.value)}}}t.setTransparency=s;function l(p,h,f,b,v){if(!p)return;let{tEmissive:x,dEmissiveType:S,emissiveAverage:T,dEmissive:E,uGroupCount:_,instanceCount:D,instanceGranularity:P}=p.values,A=P.ref.value?D.ref.value:_.ref.value*D.ref.value,I=P.ref.value?"instance":"groupInstance";Fj(h.layers.length?A:0,I,p.values);let{array:k}=x.ref.value;b&&Oj(k,0,A);for(let M=0,R=h.layers.length;M<R;++M){let{loci:B,value:F}=h.layers[M];f(B,V=>{let H=Oe.start(V),Q=Oe.end(V);return Bj(k,H,Q,F)},!1)}if(C.update(x,x.ref.value),C.updateIfChanged(T,KA(k,A)),C.updateIfChanged(S,I),C.updateIfChanged(E,h.layers.length>0),h.layers.length!==0&&I!=="instance"&&v&&El(v.props)){let{geometry:M,props:R,webgl:B}=v;if(M.kind==="mesh"){let{resolution:F,emissiveTexture:G}=M.meta,V=os(R.smoothColors,!0,F);V&&(Qq(p.values,V.resolution,V.stride,B,G),M.meta.emissiveTexture=p.values.tEmissiveGrid.ref.value)}else if(B&&M.kind==="texture-mesh"){let{resolution:F,emissiveTexture:G}=M.meta,V=os(R.smoothColors,!0,F);V&&(n7(p.values,V.resolution,V.stride,B,G),M.meta.emissiveTexture=p.values.tEmissiveGrid.ref.value)}}}t.setEmissive=l;function c(p,h,f,b,v){if(!p)return;let{tSubstance:x,dSubstanceType:S,dSubstance:T,uGroupCount:E,instanceCount:_,instanceGranularity:D}=p.values,P=D.ref.value?_.ref.value:E.ref.value*_.ref.value,A=D.ref.value?"instance":"groupInstance";Rj(h.layers.length?P:0,A,p.values);let{array:I}=x.ref.value;b&&QA(I,0,P);for(let k=0,M=h.layers.length;k<M;++k){let{loci:R,material:B,clear:F}=h.layers[k];f(R,V=>{let H=Oe.start(V),Q=Oe.end(V);return F?QA(I,H,Q):Mj(I,H,Q,B)},!1)}if(C.update(x,x.ref.value),C.updateIfChanged(S,A),C.updateIfChanged(T,h.layers.length>0),h.layers.length!==0&&A!=="instance"&&v&&El(v.props)){let{geometry:k,props:M,webgl:R}=v;if(k.kind==="mesh"){let{resolution:B,substanceTexture:F}=k.meta,G=os(M.smoothColors,!0,B);G&&(Kq(p.values,G.resolution,G.stride,R,F),k.meta.substanceTexture=p.values.tSubstanceGrid.ref.value)}else if(R&&k.kind==="texture-mesh"){let{resolution:B,substanceTexture:F}=k.meta,G=os(M.smoothColors,!0,B);G&&(o7(p.values,G.resolution,G.stride,R,F),k.meta.substanceTexture=p.values.tSubstanceGrid.ref.value)}}}t.setSubstance=c;function u(p,h,f,b){if(!p)return;let{tClipping:v,dClippingType:x,dClipping:S,uGroupCount:T,instanceCount:E,instanceGranularity:_}=p.values,D=_.ref.value?E.ref.value:T.ref.value*E.ref.value,{layers:P}=h,A=_.ref.value?"instance":"groupInstance";Aj(P.length?D:0,A,p.values);let{array:I}=v.ref.value;b&&Dj(I,0,D);for(let k=0,M=h.layers.length;k<M;++k){let{loci:R,groups:B}=h.layers[k];f(R,G=>{let V=Oe.start(G),H=Oe.end(G);return Ij(I,V,H,B)},!1)}C.update(v,v.ref.value),C.updateIfChanged(x,A),C.updateIfChanged(S,h.layers.length>0)}t.setClipping=u;function d(p,h){p&&(C.updateIfChanged(p.values.uOverpaintStrength,h.overpaint),C.updateIfChanged(p.values.uTransparencyStrength,h.transparency),C.updateIfChanged(p.values.uEmissiveStrength,h.emissive),C.updateIfChanged(p.values.uSubstanceStrength,h.substance))}t.setThemeStrength=d;function m(p,h,f){if(!p||!h&&!f)return;let{values:b}=p;h&&(W.copy(b.matrix.ref.value,h),C.update(b.matrix,b.matrix.ref.value)),f?(b.extraTransform.ref.value.set(f),C.update(b.extraTransform,b.extraTransform.ref.value)):f===null&&(E0(b.extraTransform.ref.value,b.instanceCount.ref.value),C.update(b.extraTransform,b.extraTransform.ref.value)),WA(b,b.invariantBoundingSphere.ref.value,b.instanceGrid.ref.value.cellSize,b.instanceGrid.ref.value.batchSize);let v=Hn(b.invariantBoundingSphere.ref.value,b.transform.ref.value,b.instanceCount.ref.value,0);C.update(b.boundingSphere,v)}t.setTransform=m})(Vt||(Vt={}));function Xr(t,e){return{kind:t,layers:e}}(function(t){t.Empty={kind:"empty-loci",layers:[]};let e;(function(u){u.is=Wc.has;let d;(function(v){v[v.None=0]="None",v[v.One=1]="One",v[v.Two=2]="Two",v[v.Three=4]="Three",v[v.Four=8]="Four",v[v.Five=16]="Five",v[v.Six=32]="Six"})(d=u.Flag||(u.Flag={}));function m(v){return Wc.create(v)}u.create=m,u.Names={one:d.One,two:d.Two,three:d.Three,four:d.Four,five:d.Five,six:d.Six};function p(v){return v in u.Names}u.isName=p;function h(v){switch(v){case"one":return d.One;case"two":return d.Two;case"three":return d.Three;case"four":return d.Four;case"five":return d.Five;case"six":return d.Six}}u.fromName=h;function f(v){let x=d.None;for(let S=0,T=v.length;S<T;++S)x|=h(v[S]);return x}u.fromNames=f;function b(v){let x=[];return u.is(v,d.One)&&x.push("one"),u.is(v,d.Two)&&x.push("two"),u.is(v,d.Three)&&x.push("three"),u.is(v,d.Four)&&x.push("four"),u.is(v,d.Five)&&x.push("five"),u.is(v,d.Six)&&x.push("six"),x}u.toNames=b})(e=t.Groups||(t.Groups={}));function r(u,d){if(u.layers.length!==d.layers.length)return!1;for(let m=0,p=u.layers.length;m<p;++m)if(u.layers[m].groups!==d.layers[m].groups||!st.areEqual(u.layers[m].loci,d.layers[m].loci))return!1;return!0}t.areEqual=r;function n(u){return u.layers.length===0}t.isEmpty=n;function o(u,d){if(u.kind==="element-loci"){let m=[];for(let p of u.layers){let{loci:h,groups:f}=p;h=z.Loci.remap(h,d),z.Loci.isEmpty(h)||m.push({loci:h,groups:f})}return{kind:"element-loci",layers:m}}else return u}t.remap=o;function i(u){if(n(u))return u;if(u.kind==="element-loci"){let{structure:d}=u.layers[0].loci,m=new Map,p=z.Loci.none(d);for(let f=0,b=u.layers.length;f<b;++f){let{loci:v,groups:x}=u.layers[b-f-1];v=z.Loci.subtract(v,p),p=z.Loci.union(v,p),z.Loci.isEmpty(v)||(m.has(x)&&(v=z.Loci.union(v,m.get(x))),m.set(x,v))}let h=[];return m.forEach((f,b)=>{h.push({loci:f,groups:b})}),{kind:"element-loci",layers:h}}else return u}t.merge=i;function a(u,d){if(n(u))return u;if(u.kind==="element-loci"){let{structure:m}=u.layers[0].loci,p=[];for(let h of u.layers){let{loci:f,groups:b}=h,v=z.Loci.remap(f,d);f=z.Loci.remap(v,m),z.Loci.isEmpty(f)||p.push({loci:f,groups:b})}return{kind:"element-loci",layers:p}}else return u}t.filter=a;function s(u,d){let m=[];for(let p=0,h=u.length;p<h;++p){let{script:f,groups:b}=u[p],v=Jr.toLoci(f,d);z.Loci.isEmpty(v)||m.push({loci:v,groups:b})}return{kind:"element-loci",layers:m}}t.ofScript=s;function l(u,d){let m=[];for(let p=0,h=u.length;p<h;++p){let{bundle:f,groups:b}=u[p],v=z.Bundle.toLoci(f,d.root);m.push({loci:v,groups:b})}return{kind:"element-loci",layers:m}}t.ofBundle=l;function c(u){let d=[];for(let m=0,p=u.layers.length;m<p;++m){let{loci:h,groups:f}=u.layers[m],b=z.Bundle.fromLoci(h);d.push({bundle:b,groups:f})}return{kind:"element-loci",layers:d}}t.toBundle=c})(Xr||(Xr={}));function ei(t,e){return{kind:t,layers:e}}(function(t){t.Empty={kind:"empty-loci",layers:[]};function e(c,u){if(c.layers.length===0&&u.layers.length===0)return!0;if(c.layers.length!==u.layers.length)return!1;for(let d=0,m=c.layers.length;d<m;++d)if(c.layers[d].clear!==u.layers[d].clear||!lf(c.layers[d].material,u.layers[d].material)||!st.areEqual(c.layers[d].loci,u.layers[d].loci))return!1;return!0}t.areEqual=e;function r(c){return c.layers.length===0}t.isEmpty=r;function n(c,u){if(c.kind==="element-loci"){let d=[];for(let m of c.layers){let{loci:p,material:h,clear:f}=m;p=z.Loci.remap(p,u),z.Loci.isEmpty(p)||d.push({loci:p,material:h,clear:f})}return{kind:"element-loci",layers:d}}else return c}t.remap=n;function o(c){if(r(c))return c;if(c.kind==="element-loci"){let{structure:u}=c.layers[0].loci,d,m=new Map,p=z.Loci.none(u);for(let f=0,b=c.layers.length;f<b;++f){let{loci:v,material:x,clear:S}=c.layers[b-f-1];v=z.Loci.subtract(v,p),p=z.Loci.union(v,p),z.Loci.isEmpty(v)||(S?d=d?z.Loci.union(v,d):v:(m.has(x)&&(v=z.Loci.union(v,m.get(x))),m.set(x,v)))}let h=[];return d&&h.push({loci:d,material:Qo(),clear:!0}),m.forEach((f,b)=>{h.push({loci:f,material:b,clear:!1})}),{kind:"element-loci",layers:h}}else return c}t.merge=o;function i(c,u){if(r(c))return c;if(c.kind==="element-loci"){let{structure:d}=c.layers[0].loci,m=[];for(let p of c.layers){let{loci:h,material:f,clear:b}=p,v=z.Loci.remap(h,u);h=z.Loci.remap(v,d),z.Loci.isEmpty(h)||m.push({loci:h,material:f,clear:b})}return{kind:"element-loci",layers:m}}else return c}t.filter=i;function a(c,u){let d=[];for(let m=0,p=c.length;m<p;++m){let{script:h,material:f,clear:b}=c[m],v=Jr.toLoci(h,u);z.Loci.isEmpty(v)||d.push({loci:v,material:f,clear:b})}return{kind:"element-loci",layers:d}}t.ofScript=a;function s(c,u){let d=[];for(let m=0,p=c.length;m<p;++m){let{bundle:h,material:f,clear:b}=c[m],v=z.Bundle.toLoci(h,u.root);d.push({loci:v,material:f,clear:b})}return{kind:"element-loci",layers:d}}t.ofBundle=s;function l(c){let u=[];for(let d=0,m=c.layers.length;d<m;++d){let{loci:p,material:h,clear:f}=c.layers[d],b=z.Bundle.fromLoci(p);u.push({bundle:b,material:h,clear:f})}return{kind:"element-loci",layers:u}}t.toBundle=l})(ei||(ei={}));function ti(t,e){return{kind:t,layers:e}}(function(t){t.Empty={kind:"empty-loci",layers:[]};function e(c,u){if(c.layers.length===0&&u.layers.length===0)return!0;if(c.layers.length!==u.layers.length)return!1;for(let d=0,m=c.layers.length;d<m;++d)if(c.layers[d].value!==u.layers[d].value||!st.areEqual(c.layers[d].loci,u.layers[d].loci))return!1;return!0}t.areEqual=e;function r(c){return c.layers.length===0}t.isEmpty=r;function n(c,u){if(c.kind==="element-loci"){let d=[];for(let m of c.layers){let{loci:p,value:h}=m;p=z.Loci.remap(p,u),z.Loci.isEmpty(p)||d.push({loci:p,value:h})}return{kind:"element-loci",layers:d}}else return c}t.remap=n;function o(c){if(r(c))return c;if(c.kind==="element-loci"){let{structure:u}=c.layers[0].loci,d=new Map,m=z.Loci.none(u);for(let h=0,f=c.layers.length;h<f;++h){let{loci:b,value:v}=c.layers[f-h-1];b=z.Loci.subtract(b,m),m=z.Loci.union(b,m),z.Loci.isEmpty(b)||(d.has(v)&&(b=z.Loci.union(b,d.get(v))),d.set(v,b))}let p=[];return d.forEach((h,f)=>{p.push({loci:h,value:f})}),{kind:"element-loci",layers:p}}else return c}t.merge=o;function i(c,u){if(r(c))return c;if(c.kind==="element-loci"){let{structure:d}=c.layers[0].loci,m=[];for(let p of c.layers){let{loci:h,value:f}=p,b=z.Loci.remap(h,u);h=z.Loci.remap(b,d),z.Loci.isEmpty(h)||m.push({loci:h,value:f})}return{kind:"element-loci",layers:m}}else return c}t.filter=i;function a(c,u){let d=[];for(let m=0,p=c.length;m<p;++m){let{script:h,value:f}=c[m],b=Jr.toLoci(h,u);z.Loci.isEmpty(b)||d.push({loci:b,value:f})}return{kind:"element-loci",layers:d}}t.ofScript=a;function s(c,u){let d=[];for(let m=0,p=c.length;m<p;++m){let{bundle:h,value:f}=c[m],b=z.Bundle.toLoci(h,u.root);d.push({loci:b,value:f})}return{kind:"element-loci",layers:d}}t.ofBundle=s;function l(c){let u=[];for(let d=0,m=c.layers.length;d<m;++d){let{loci:p,value:h}=c.layers[d],f=z.Bundle.fromLoci(p);u.push({bundle:f,value:h})}return{kind:"element-loci",layers:u}}t.toBundle=l})(ti||(ti={}));var i7;(function(t){function e(r,n,o){return g.getDefaultValues(r.getParams(n,o))}t.getDetaultParams=e})(i7||(i7={}));var cge={name:"",label:"",description:"",factory:()=>rt.Empty,getParams:()=>({}),defaultValues:{},defaultColorTheme:wo.EmptyProvider,defaultSizeTheme:so.EmptyProvider,isApplicable:()=>!0};function a7(t){return t.map(e=>[e.name,e.provider.label])}var fv=class{get default(){return this._list[0]}get types(){return a7(this._list)}constructor(){this._list=[],this._map=new Map,this._name=new Map}add(e){if(this._map.has(e.name))throw new Error(`${e.name} already registered.`);this._list.push({name:e.name,provider:e}),this._map.set(e.name,e),this._name.set(e,e.name)}getName(e){if(!this._name.has(e))throw new Error(`'${e.label}' is not a registered represenatation provider.`);return this._name.get(e)}remove(e){let r=e.name;this._list.splice(this._list.findIndex(o=>o.name===r),1);let n=this._map.get(r);n&&(this._map.delete(r),this._name.delete(n))}get(e){return this._map.get(e)||cge}get list(){return this._list}getApplicableList(e){return this._list.filter(r=>r.provider.isApplicable(e))}getApplicableTypes(e){return a7(this.getApplicableList(e))}clear(){this._list.length=0,this._map.clear(),this._name.clear()}};var rt;(function(t){let e;(function(s){function l(u,d){return u.repr===d.repr&&st.areEqual(u.loci,d.loci)}s.areEqual=l;function c(u){return st.isEmpty(u.loci)}s.isEmpty=c,s.Empty={loci:St}})(e=t.Loci||(t.Loci={}));function r(){return{visible:!0,alphaFactor:1,pickable:!0,colorOnly:!1,syncManually:!1,transform:W.identity(),overpaint:io.Empty,transparency:Jo.Empty,emissive:ti.Empty,substance:ei.Empty,clipping:Xr.Empty,themeStrength:{overpaint:1,transparency:1,emissive:1,substance:1},markerActions:kn.All}}t.createState=r;function n(s,l){l.visible!==void 0&&(s.visible=l.visible),l.alphaFactor!==void 0&&(s.alphaFactor=l.alphaFactor),l.pickable!==void 0&&(s.pickable=l.pickable),l.colorOnly!==void 0&&(s.colorOnly=l.colorOnly),l.overpaint!==void 0&&(s.overpaint=l.overpaint),l.transparency!==void 0&&(s.transparency=l.transparency),l.emissive!==void 0&&(s.emissive=l.emissive),l.substance!==void 0&&(s.substance=l.substance),l.clipping!==void 0&&(s.clipping=l.clipping),l.themeStrength!==void 0&&(s.themeStrength=l.themeStrength),l.syncManually!==void 0&&(s.syncManually=l.syncManually),l.transform!==void 0&&W.copy(s.transform,l.transform),l.markerActions!==void 0&&(s.markerActions=l.markerActions)}t.updateState=n,t.StateBuilder={create:r,update:n},t.Empty={label:"",groupCount:0,renderObjects:[],geometryVersion:-1,props:{},params:{},updated:new ln,state:r(),theme:An.createEmpty(),createOrUpdate:()=>ie.constant("",void 0),setState:()=>{},setTheme:()=>{},getLoci:()=>St,getAllLoci:()=>[],eachLocation:()=>{},mark:()=>!1,destroy:()=>{}};class o{constructor(){this.curr=new Set,this.next=new Set,this._version=-1}get version(){return this._version}add(l,c){this.next.add(rm(l,c))}snapshot(){no.areEqual(this.curr,this.next)||(this._version+=1),[this.curr,this.next]=[this.next,this.curr],this.next.clear()}}t.GeometryState=o;function i(s,l,c,u,d){let m=0,p=new ln,h=new o,f=u.create(),b=An.createEmpty(),v,x,S,T={},E=Object.keys(d).map((_,D)=>{T[D]=_;let P=d[_](l,c);return P.setState(f),P});return{label:s,updated:p,get groupCount(){let _=0;if(x){let{visuals:D}=x;for(let P=0,A=E.length;P<A;++P)(!D||D.includes(T[P]))&&(_+=E[P].groupCount)}return _},get renderObjects(){let _=[];if(x){let{visuals:D}=x;for(let P=0,A=E.length;P<A;++P)(!D||D.includes(T[P]))&&_.push(...E[P].renderObjects)}return _},get geometryVersion(){return h.version},get props(){return x},get params(){return v},createOrUpdate:(_={},D)=>{D&&D!==S&&(v=c(l,D),S=D,x||(x=g.getDefaultValues(v)));let P=k1(Object.assign({},x,_),S);Object.assign(x,_,P);let{visuals:A}=x;return ie.create(`Creating or updating '${s}' representation`,I=>N(this,null,function*(){for(let k=0,M=E.length;k<M;++k)(!A||A.includes(T[k]))&&(yield E[k].createOrUpdate(x,S).runInContext(I)),h.add(k,E[k].geometryVersion);h.snapshot(),p.next(m++)}))},get state(){return f},get theme(){return b},getLoci:_=>{let{visuals:D}=x;for(let P=0,A=E.length;P<A;++P)if(!D||D.includes(T[P])){let I=E[P].getLoci(_);if(!Wn(I))return I}return St},getAllLoci:()=>{let _=[],{visuals:D}=x;for(let P=0,A=E.length;P<A;++P)(!D||D.includes(T[P]))&&_.push(...E[P].getAllLoci());return _},eachLocation:_=>{let{visuals:D}=x;for(let P=0,A=E.length;P<A;++P)(!D||D.includes(T[P]))&&E[P].eachLocation(_)},mark:(_,D)=>{let P=!1;for(let A=0,I=E.length;A<I;++A)P=E[A].mark(_,D)||P;return P},setState:_=>{u.update(f,_);for(let D=0,P=E.length;D<P;++D)E[D].setState(_)},setTheme:_=>{b=_;for(let D=0,P=E.length;D<P;++D)E[D].setTheme(_)},destroy(){for(let _=0,D=E.length;_<D;++_)E[_].destroy()}}}t.createMulti=i;function a(s,l){let c=0,u=new ln,d=new o,m=t.createState(),p=An.createEmpty(),h=g.clone(ge.Params),f=g.getDefaultValues(ge.Params);return{label:s,updated:u,get groupCount(){return l.values.uGroupCount.ref.value},get renderObjects(){return[l]},get geometryVersion(){return d.version},get props(){return f},get params(){return h},createOrUpdate:(b={})=>{let v=k1(Object.assign({},f,b));return Object.assign(f,b,v),ie.create(`Updating '${s}' representation`,x=>N(this,null,function*(){d.add(0,l.id),d.snapshot(),u.next(c++)}))},get state(){return m},get theme(){return p},getLoci:()=>St,getAllLoci:()=>[],eachLocation:()=>{},mark:(b,v)=>!1,setState:b=>{b.visible!==void 0&&Vt.setVisibility(l,b.visible),b.alphaFactor!==void 0&&Vt.setAlphaFactor(l,b.alphaFactor),b.pickable!==void 0&&Vt.setPickable(l,b.pickable),b.colorOnly!==void 0&&Vt.setColorOnly(l,b.colorOnly),b.overpaint,b.transparency,b.emissive,b.substance,b.clipping,b.themeStrength!==void 0&&Vt.setThemeStrength(l,b.themeStrength),b.transform!==void 0&&Vt.setTransform(l,b.transform),t.updateState(m,b)},setTheme:()=>{},destroy(){}}}t.fromRenderObject=a})(rt||(rt={}));function Yn(t,e,r={}){let n=0,o=new ln,i=rt.createState(),a=rl(),s=[],l,c,u=-1,d=An.createEmpty(),m=g.getDefaultValues(e.Params),p,h,f;r.modifyState&&rt.updateState(i,r.modifyState(i));let b=Bl.create();function v(E={},_){Bl.reset(b),!(!_&&!c)&&(_&&!c?b.createNew=!0:_&&c&&_.id===c.id||(_&&c&&_.id!==c.id?(b.updateTransform=!0,b.createGeometry=!0):_&&console.warn("unexpected state")),E.instanceGranularity!==m.instanceGranularity&&(b.updateTransform=!0),b.updateTransform&&(b.updateColor=!0,b.updateSize=!0,b.updateMatrix=!0),b.createGeometry&&(b.updateColor=!0,b.updateSize=!0))}function x(E={},_){return r.modifyProps&&(E=r.modifyProps(E)),ie.create("ShapeRepresentation.create",D=>N(this,null,function*(){let P=Object.assign(m,E),A=_?yield t(D,_,P,c):void 0;if(v(E,A),A&&(c=A,Object.assign(d,Yt.getTheme(c))),b.createNew){s.length=0,h=Yt.groupIterator(c);let I=Yt.createTransform(c.transforms,c.geometry.boundingSphere,P.cellSize,P.batchSize),k=e.createValues(c.geometry,I,h,d,P),M=e.createRenderableState(P);r.modifyState&&Object.assign(M,r.modifyState(M)),rt.updateState(i,M),l=tu(c.geometry.kind,k,M,a),l&&s.push(l),f=e.createPositionIterator(c.geometry,l.values)}else{if(!l)throw new Error("expected renderObject to be available");if(b.updateTransform){h=Yt.groupIterator(c);let{instanceCount:I,groupCount:k}=h;E.instanceGranularity?jr(I,"instance",l.values):jr(I*k,"groupInstance",l.values)}b.updateMatrix&&(Yt.createTransform(c.transforms,c.geometry.boundingSphere,P.cellSize,P.batchSize,l.values),"lodLevels"in l.values&&C.update(l.values.lodLevels,l.values.lodLevels.ref.value)),b.createGeometry&&(C.updateIfChanged(l.values.drawCount,eo.getDrawCount(c.geometry)),C.updateIfChanged(l.values.uVertexCount,eo.getVertexCount(c.geometry)),C.updateIfChanged(l.values.uGroupCount,eo.getGroupCount(c.geometry))),(b.updateTransform||b.createGeometry)&&(e.updateBoundingSphere(l.values,c.geometry),f=e.createPositionIterator(c.geometry,l.values)),b.updateColor&&uo(h,f,d.color,l.values),b.updateSize&&"uSize"in l.values&&Sa(h,d.size,l.values),e.updateValues(l.values,P),e.updateRenderableState(l.state,P)}m=P,(b.createGeometry||b.createNew)&&(u+=1),o.next(n++)}))}function S(E,_,D){let P=!1;if(!bi.isLoci(E)||bi.isLociEmpty(E)||E.shape!==_)return!1;for(let A of E.groups)D(Oe.ofSingleton(A.instance))&&(P=!0);return P}function T(E,_){return So(E)||Yt.isLoci(E)&&E.shape===c?m.instanceGranularity?_(Oe.ofBounds(0,c.transforms.length)):_(Oe.ofBounds(0,c.groupCount*c.transforms.length)):m.instanceGranularity?S(E,c,_):uge(E,c,_)}return{label:"Shape geometry",get groupCount(){return h?h.count:0},get props(){return m},get params(){return p},get state(){return i},get theme(){return d},renderObjects:s,get geometryVersion(){return u},updated:o,createOrUpdate:x,getLoci(E){let{objectId:_,groupId:D,instanceId:P}=E;return l&&l.id===_?bi.Loci(c,[{ids:we.ofSingleton(D),instance:P}]):St},getAllLoci(){return[Yt.Loci(c)]},eachLocation:E=>{for(h.reset();h.hasNext;){let{location:_,isSecondary:D}=h.move();E(_,D)}},mark(E,_){if(!kn.is(i.markerActions,_))return!1;if(bi.isLoci(E)||Yt.isLoci(E)){if(E.shape!==c)return!1}else if(!So(E))return!1;return Vt.mark(l,E,_,T)},setState(E){r.modifyState&&(E=r.modifyState(E)),l&&(E.visible!==void 0&&Vt.setVisibility(l,E.visible),E.alphaFactor!==void 0&&Vt.setAlphaFactor(l,E.alphaFactor),E.pickable!==void 0&&Vt.setPickable(l,E.pickable),E.colorOnly!==void 0&&Vt.setColorOnly(l,E.colorOnly),E.overpaint!==void 0&&Vt.setOverpaint(l,E.overpaint,T,!0),E.transparency!==void 0&&Vt.setTransparency(l,E.transparency,T,!0),E.substance!==void 0&&Vt.setSubstance(l,E.substance,T,!0),E.transform!==void 0&&Vt.setTransform(l,E.transform)),rt.updateState(i,E)},setTheme(E){ht&&console.warn("The `ShapeRepresentation` theme is fixed to `ShapeGroupColorTheme` and `ShapeGroupSizeTheme`. Colors are taken from `Shape.getColor` and sizes from `Shape.getSize`")},destroy(){s.length=0,l&&(l.state.disposed=!0,l=void 0)}}}function uge(t,e,r){if(!bi.isLoci(t)||t.shape!==e)return!1;let n=!1,{groupCount:o}=e,{groups:i}=t;for(let{ids:a,instance:s}of i)if(Oe.is(a)){let l=s*o+Oe.start(a),c=s*o+Oe.end(a);r(Oe.ofBounds(l,c))&&(n=!0)}else for(let l=0,c=a.length;l<c;l++){let u=s*o+a[l];r(Oe.ofSingleton(u))&&(n=!0)}return n}var s7=W(),bp=class{constructor(e){this.structure=e,this.groupUnitTransforms=[],this.unitOffsetMap=h0.Mutable(),this.groupIndexMap=h0.Mutable(),this._isIdentity=void 0,this.version=0,this.unitTransforms=new Float32Array(e.units.length*16),this.size=e.units.length,this.reset();let r=0;for(let n=0,o=e.unitSymmetryGroups.length;n<o;++n){let i=e.unitSymmetryGroups[n];this.groupIndexMap.set(i.hashCode,n);let a=this.unitTransforms.subarray(r,r+i.units.length*16);this.groupUnitTransforms.push(a);for(let s=0,l=i.units.length;s<l;++s)this.unitOffsetMap.set(i.units[s].id,r+s*16);r+=i.units.length*16}}reset(){this.version=0,E0(this.unitTransforms,this.size),this._isIdentity=!0}get isIdentity(){if(this._isIdentity===void 0){this._isIdentity=!0;for(let e=0,r=this.size*16;e<r;e+=16)if(W.fromArray(s7,this.unitTransforms,e),!W.isIdentity(s7)){this._isIdentity=!1;break}}return this._isIdentity}setTransform(e,r){this.version=(this.version+1)%2147483647,W.toArray(e,this.unitTransforms,this.unitOffsetMap.get(r.id)),this._isIdentity=void 0}getTransform(e,r){return W.fromArray(e,this.unitTransforms,this.unitOffsetMap.get(r.id))}getSymmetryGroupTransforms(e){return this.groupUnitTransforms[this.groupIndexMap.get(e.hashCode)]}};var l7=W();function o3(t,e,r){for(let n=0,o=t.units.length;n<o;n++){let i=t.units[n];Vz.lerpFromIdentity(l7,i.conformation.operator,r),e.setTransform(l7,i)}}var c7=y(),hv=y(),cw=W();function i3(t,e,r,n){let o=n.radius*r;for(let i=0,a=t.units.length;i<a;i++){let s=t.units[i];y.transformMat4(c7,s.lookup3d.boundary.sphere.center,s.conformation.operator.matrix),y.sub(hv,c7,n.center),y.setMagnitude(hv,hv,o),W.fromTranslation(cw,hv),e.setTransform(cw,s)}}var m7={axis:g.MappedStatic("custom",{structure:g.Group({principalAxis:g.Select("dirA",[["dirA","A"],["dirB","B"],["dirC","C"]])}),custom:g.Group({vector:g.Vec3(y.create(0,0,1))})}),origin:g.MappedStatic("structure",{structure:g.Group({}),custom:g.Group({vector:g.Vec3(y.create(0,0,0))})})};function a3(t,e){let r,n;return e.axis.name==="custom"?r=e.axis.params.vector:r=ue.getPrincipalAxes(t).momentsAxes[e.axis.params.principalAxis],e.origin.name==="custom"?n=e.origin.params.vector:n=ue.getPrincipalAxes(t).momentsAxes.origin,{axis:r,origin:n}}var u7=W(),d7=W(),lw=W();function s3(t,e,r,n,o){for(let i=0,a=t.units.length;i<a;i++){let s=t.units[i];y.negate(hv,o),W.fromTranslation(cw,hv),W.fromRotation(u7,Math.PI*r*2,n),W.fromTranslation(d7,o),W.mul(lw,u7,cw),W.mul(lw,d7,lw),e.setTransform(lw,s)}}var dge={radius:1,detail:0};function p7(t,e,r){let{radius:n,detail:o}=w(w({},dge),r),i=mge(),{vertices:a,indices:s}=i;c(o),RU(a,n);let l=new Float32Array(a.length);return OT(a,s,l,a.length/3,s.length/3),{vertices:new Float32Array(a),normals:new Float32Array(l),indices:new Uint32Array(s)};function c(d){let m=y(),p=y(),h=y();for(let f=0;f<e.length;f+=3)y.fromArray(m,t,e[f+0]*3),y.fromArray(p,t,e[f+1]*3),y.fromArray(h,t,e[f+2]*3),u(m,p,h,d)}function u(d,m,p,h){let f=Math.pow(2,h),b=[];for(let v=0;v<=f;++v){b[v]=[];let x=y();y.lerp(x,d,p,v/f);let S=y();y.lerp(S,m,p,v/f);let T=f-v;for(let E=0;E<=T;++E)if(E===0&&v===f)b[v][E]=x;else{let _=y();y.lerp(_,x,S,E/T),b[v][E]=_}}for(let v=0;v<f;++v)for(let x=0;x<2*(f-v)-1;++x){let S=Math.floor(x/2);x%2===0?i.add(b[v][S+1],b[v+1][S],b[v][S]):i.add(b[v][S+1],b[v+1][S+1],b[v+1][S])}}}function mge(){let t=[],e=[],r=new Map;function n(o){let i=`${o[0].toFixed(5)}|${o[1].toFixed(5)}|${o[2].toFixed(5)}`,a=r.get(i);return a===void 0&&(a=t.length/3,r.set(i,a),t.push(...o)),a}return{vertices:t,indices:e,add:(o,i,a)=>{e.push(n(o),n(i),n(a))}}}var du=(1+Math.sqrt(5))/2,f7=[-1,du,0,1,du,0,-1,-du,0,1,-du,0,0,-1,du,0,1,du,0,-1,-du,0,1,-du,du,0,-1,du,0,1,-du,0,-1,-du,0,1],pge=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],fge=[0,11,5,11,0,5,1,5,0,1,1,7,0,7,7,10,0,10,10,11,5,9,4,11,2,10,6,7,1,8,3,9,4,9,3,4,2,4,2,3,2,6,3,6,6,8,3,8,8,9,4,5,2,11,6,10,7,8,1,9],l3;function h7(){return l3||(l3=Dg(f7,pge)),l3}var fnt=am(f7,fge);var{vertices:hge,indices:gge}=h7();function Sd(t){return 10*Math.pow(Math.pow(2,t),2)+2}function g7(t){return p7(hge,gge,{detail:t,radius:1})}var y7=new Map,yge=W.identity();function vge(t,e,r){return W.scaleUniformly(t,W.fromTranslation(t,e),r)}function c3(t){let e=y7.get(t);return e===void 0&&(e=g7(t),y7.set(t,e)),e}function Jt(t,e,r,n){Te.addPrimitive(t,vge(yge,e,r),c3(n))}var Cd={radiusTop:1,radiusBottom:1,height:1,radialSegments:8,heightSegments:1,topCap:!1,bottomCap:!1,thetaStart:0,thetaLength:Math.PI*2};function v7(t){let{radiusTop:e,radiusBottom:r,height:n,radialSegments:o,heightSegments:i,topCap:a,bottomCap:s,thetaStart:l,thetaLength:c}=w(w({},Cd),t),u=[],d=[],m=[],p=0,h=[],f=n/2;return b(),a&&e>0&&v(!0),s&&r>0&&v(!1),{vertices:new Float32Array(d),normals:new Float32Array(m),indices:new Uint32Array(u)};function b(){let x=y.zero(),S=(r-e)/n;for(let T=0;T<=i;++T){let E=[],_=T/i,D=_*(r-e)+e;for(let P=0;P<=o;++P){let I=P/o*c+l,k=Math.sin(I),M=Math.cos(I);d.push(D*k,-_*n+f,D*M),y.normalize(x,y.set(x,k,S,M)),m.push(...x),E.push(p++)}h.push(E)}for(let T=0;T<o;++T)for(let E=0;E<i;++E){let _=h[E][T],D=h[E+1][T],P=h[E+1][T+1],A=h[E][T+1];u.push(_,D,A),u.push(D,P,A)}}function v(x){let S=x===!0?e:r,T=x===!0?1:-1,E=p;for(let D=1;D<=o;++D)d.push(0,f*T,0),m.push(0,T,0),++p;let _=p;for(let D=0;D<=o;++D){let A=D/o*c+l,I=Math.cos(A),k=Math.sin(A);d.push(S*k,f*T,S*I),m.push(0,T,0),++p}for(let D=0;D<o;++D){let P=E+D,A=_+D;x===!0?u.push(A,A+1,P):u.push(A+1,A,P)}}}var b7=y(),x7=y(),Ol=y(),Fl=y(),pm=y(),gv=y(),bge={height:1,topCap:!0,bottomCap:!0};function Wg(t,e){let r=t.length/3;if(r<3)throw new Error("need at least 3 points to build a prism");let{height:n,topCap:o,bottomCap:i}=w(w({},bge),e),a=r*2,s=r*4,l=(o?1:0)+(i?1:0);r===3?(a+=l,s+=l*3):r===4?(a+=l*2,s+=l*4):(a+=l*r,s+=l*r*3);let c=pd(a,s),u=n*.5;y.set(b7,0,0,-u),y.set(x7,0,0,u);for(let d=0;d<r;++d){let m=(d+1)%r;y.set(Ol,t[d*3],t[d*3+1],-u),y.set(Fl,t[m*3],t[m*3+1],-u),y.set(pm,t[m*3],t[m*3+1],u),y.set(gv,t[d*3],t[d*3+1],u),c.addQuad(Ol,Fl,pm,gv)}if(r===3)o&&(y.set(Ol,t[0],t[1],-u),y.set(Fl,t[3],t[4],-u),y.set(pm,t[6],t[7],-u),c.add(pm,Fl,Ol)),i&&(y.set(Ol,t[0],t[1],u),y.set(Fl,t[3],t[4],u),y.set(pm,t[6],t[7],u),c.add(Ol,Fl,pm));else if(r===4)o&&(y.set(Ol,t[0],t[1],-u),y.set(Fl,t[3],t[4],-u),y.set(pm,t[6],t[7],-u),y.set(gv,t[9],t[10],-u),c.addQuad(gv,pm,Fl,Ol)),i&&(y.set(Ol,t[0],t[1],u),y.set(Fl,t[3],t[4],u),y.set(pm,t[6],t[7],u),y.set(gv,t[9],t[10],u),c.addQuad(Ol,Fl,pm,gv));else for(let d=0;d<r;++d){let m=(d+1)%r;o&&(y.set(Ol,t[d*3],t[d*3+1],-u),y.set(Fl,t[m*3],t[m*3+1],-u),c.add(b7,Fl,Ol)),i&&(y.set(Ol,t[d*3],t[d*3+1],u),y.set(Fl,t[m*3],t[m*3+1],u),c.add(Ol,Fl,x7))}return c.getPrimitive()}var u3;function S7(){return u3||(u3=Wg(tl(4,!1))),u3}var d3;function C7(){return d3||(d3=Wg(tl(5,!1))),d3}var m3;function T7(){return m3||(m3=Wg(tl(6,!1))),m3}var p3;function w7(){return p3||(p3=Wg(tl(6,!0))),p3}var f3;function _7(){return f3||(f3=Wg(tl(7,!1))),f3}var P7=new Map,E7=y.create(0,1,0),gm=y(),uw=y(),I7=y(),Hf=W(),D7=W(),A7=y(),hm=y(),h3=y();function dw(t,e,r,n,o){return y.setMagnitude(uw,r,n/2),y.add(I7,e,uw),o?y.matchDirection(h3,E7,uw):y.copy(h3,E7),y.set(A7,1,n,1),y.makeRotation(D7,h3,uw),W.scale(t,D7,A7),W.setTranslation(t,I7)}var fm=new Int32Array(9);function xge(t){var e,r,n,o,i,a,s,l,c;return fm[0]=Math.round(1e3*((e=t.radiusTop)!==null&&e!==void 0?e:Cd.radiusTop)),fm[1]=Math.round(1e3*((r=t.radiusBottom)!==null&&r!==void 0?r:Cd.radiusBottom)),fm[2]=Math.round(1e3*((n=t.height)!==null&&n!==void 0?n:Cd.height)),fm[3]=(o=t.radialSegments)!==null&&o!==void 0?o:Cd.radialSegments,fm[4]=(i=t.heightSegments)!==null&&i!==void 0?i:Cd.heightSegments,fm[5]=((a=t.topCap)!==null&&a!==void 0?a:Cd.topCap)?1:0,fm[6]=((s=t.bottomCap)!==null&&s!==void 0?s:Cd.bottomCap)?1:0,fm[7]=Math.round(1e3*((l=t.thetaStart)!==null&&l!==void 0?l:Cd.thetaStart)),fm[8]=Math.round(1e3*((c=t.thetaLength)!==null&&c!==void 0?c:Cd.thetaLength)),Ai(fm)}function mw(t){let e=xge(t),r=P7.get(e);if(r===void 0){if(t.radialSegments&&t.radialSegments<=4){let n=Math.max(3,t.radialSegments),o=Wg(tl(n,!0,t.radiusTop),t);r=A0(o,W.rotX90)}else r=v7(t);P7.set(e,r)}return r}function nr(t,e,r,n,o){let i=y.distance(e,r)*n;y.sub(gm,r,e),dw(Hf,e,gm,i,!0),Te.addPrimitive(t,Hf,mw(o))}function k7(t,e,r,n,o,i){let a=y.distance(e,r)*n,s=mw(i);y.sub(gm,r,e),y.add(hm,e,o),dw(Hf,hm,gm,a,!0),Te.addPrimitive(t,Hf,s),y.sub(hm,e,o),dw(Hf,hm,gm,a,!0),Te.addPrimitive(t,Hf,s)}function Xg(t,e,r,n,o,i,a){let s=y.distance(e,r)*n,l=o%2!==0,c=Math.floor((o+1)/2),u=s/(o+.5),d=mw(a);y.setMagnitude(gm,y.sub(gm,r,e),u),y.copy(hm,e);for(let m=0;m<c;++m)y.add(hm,hm,gm),l&&m===c-1&&(!i&&a.topCap&&(a.topCap=!1,d=mw(a)),u/=2),dw(Hf,hm,gm,u,!1),Te.addPrimitive(t,Hf,d),y.add(hm,hm,gm)}var zo=y(),M7=Dt(),Td=y(),mu=y(),xp=y(),pw=y(),Ps=y.fromArray,Sge=y.triangleNormal,R7=y.copy,fw=y.transformMat4,L7=y.transformMat3,B7=Dt.directionTransform,Es=he.add3,hw=he.add,Te;(function(t){function e(m=2048,p=1024,h){return{currentGroup:-1,vertices:he.create(Float32Array,3,p,h?h.vertexBuffer.ref.value:m),normals:he.create(Float32Array,3,p,h?h.normalBuffer.ref.value:m),indices:he.create(Uint32Array,3,p*3,h?h.indexBuffer.ref.value:m*3),groups:he.create(Float32Array,1,p,h?h.groupBuffer.ref.value:m),mesh:h}}t.createState=e;function r(m,p,h,f){let{vertices:b,normals:v,indices:x,groups:S,currentGroup:T}=m,E=b.elementCount;Es(b,p[0],p[1],p[2]),Es(b,h[0],h[1],h[2]),Es(b,f[0],f[1],f[2]),Sge(zo,p,h,f);for(let _=0;_<3;++_)Es(v,zo[0],zo[1],zo[2]),hw(S,T);Es(x,E,E+1,E+2)}t.addTriangle=r;function n(m,p,h,f,b){let{vertices:v,normals:x,indices:S,groups:T,currentGroup:E}=m,_=v.elementCount;Es(v,p[0],p[1],p[2]),Es(v,h[0],h[1],h[2]),Es(v,f[0],f[1],f[2]);for(let D=0;D<3;++D)Es(x,b[0],b[1],b[2]),hw(T,E);Es(S,_,_+1,_+2)}t.addTriangleWithNormal=n;function o(m,p,h){Ps(xp,p,h[0]*3),Ps(pw,p,h[1]*3);for(let f=2,b=h.length;f<b;f+=2)R7(Td,xp),R7(mu,pw),Ps(xp,p,h[f]*3),Ps(pw,p,h[f+1]*3),r(m,Td,mu,xp),r(m,mu,pw,xp)}t.addTriangleStrip=o;function i(m,p,h){Ps(Td,p,h[0]*3);for(let f=2,b=h.length;f<b;++f)Ps(mu,p,h[f-1]*3),Ps(xp,p,h[f]*3),r(m,Td,xp,mu)}t.addTriangleFan=i;function a(m,p,h,f){Ps(Td,p,h[0]*3);for(let b=2,v=h.length;b<v;++b)Ps(mu,p,h[b-1]*3),Ps(xp,p,h[b]*3),n(m,Td,xp,mu,f)}t.addTriangleFanWithNormal=a;function s(m,p,h){let{vertices:f,normals:b,indices:v}=h,{vertices:x,normals:S,indices:T,groups:E,currentGroup:_}=m,D=x.elementCount,P=B7(M7,p);for(let A=0,I=f.length;A<I;A+=3)fw(zo,Ps(zo,f,A),p),Es(x,zo[0],zo[1],zo[2]),L7(zo,Ps(zo,b,A),P),Es(S,zo[0],zo[1],zo[2]),hw(E,_);for(let A=0,I=v.length;A<I;A+=3)Es(T,v[A]+D,v[A+1]+D,v[A+2]+D)}t.addPrimitive=s;function l(m,p,h){let{vertices:f,normals:b,indices:v}=h,{vertices:x,normals:S,indices:T,groups:E,currentGroup:_}=m,D=x.elementCount,P=B7(M7,p);for(let A=0,I=f.length;A<I;A+=3)fw(zo,Ps(zo,f,A),p),Es(x,zo[0],zo[1],zo[2]),L7(zo,Ps(zo,b,A),P),Es(S,-zo[0],-zo[1],-zo[2]),hw(E,_);for(let A=0,I=v.length;A<I;A+=3)Es(T,v[A+2]+D,v[A+1]+D,v[A]+D)}t.addPrimitiveFlipped=l;function c(m,p,h,f,b,v){let{vertices:x,edges:S}=h,T={radiusTop:f,radiusBottom:f,radialSegments:v};for(let E=0,_=S.length;E<_;E+=2)Ps(Td,x,S[E]*3),Ps(mu,x,S[E+1]*3),fw(Td,Td,p),fw(mu,mu,p),Jt(m,Td,f,b),Jt(m,mu,f,b),nr(m,Td,mu,1,T)}t.addCage=c;function u(m,p,h){s(m,p,{vertices:h.vertexBuffer.ref.value.subarray(0,h.vertexCount*3),normals:h.normalBuffer.ref.value.subarray(0,h.vertexCount*3),indices:h.indexBuffer.ref.value.subarray(0,h.triangleCount*3)})}t.addMesh=u;function d(m){let{vertices:p,normals:h,indices:f,groups:b,mesh:v}=m,x=he.compact(p,!0),S=he.compact(f,!0),T=he.compact(h,!0),E=he.compact(b,!0);return Be.create(x,S,T,E,m.vertices.elementCount,m.indices.elementCount,v)}t.getMesh=d})(Te||(Te={}));var Cge=W.fromTranslation(W(),y.create(.5,.5,.5)),Tge=ik(ok(JT()),Cge),wd=y(),O7=W(),wge={origin:"Origin",model:"Model"},_ge={corner:"Corner",center:"Center"},Pge=U(w({},Be.Params),{cellColor:g.Color(ut.orange),cellScale:g.Numeric(2,{min:.1,max:5,step:.1}),ref:g.Select("model",g.objectToOptions(wge),{isEssential:!0}),attachment:g.Select("corner",g.objectToOptions(_ge),{isEssential:!0})}),Ege={mesh:(t,e)=>Yn(Dge,Be.Utils)},g3=w({},Pge);function Ige(t,e,r){let n=Te.createState(256,128,r),{fromFractional:o}=t.symmetry.spacegroup.cell;y.copy(wd,t.ref),e.attachment==="center"?(y.trunc(wd,wd),y.subScalar(wd,wd,.5)):y.floor(wd,wd),W.fromTranslation(O7,wd);let i=ik(ok(Tge),O7),a=Math.cbrt(t.symmetry.spacegroup.cell.volume)/300*e.cellScale;n.currentGroup=1,Te.addCage(n,o,i,a,2,20);let s=te.fromDimensionsAndTransform(te(),y.unit,o);y.transformMat4(wd,wd,o),te.translate(s,s,wd),te.expand(s,s,a);let l=Te.getMesh(n);return l.setBoundingSphere(s),l}function Dge(t,e,r,n){let o=Ige(e,r,n&&n.geometry),i=RT.getUnitcellLabel(e.symmetry);return Yt.create(i,e,o,()=>r.cellColor,()=>1,()=>i)}function y3(t,e,r){let n=y();return r.ref==="model"&&y.transformMat4(n,Et.getCenter(t),e.spacegroup.cell.toFractional),{symmetry:e,ref:n}}function F7(t,e){return rt.createMulti("Unit Cell",t,e,rt.StateBuilder,Ege)}var pu=new Uint16Array([0,1,2,1,3,2]),Yg=he.add3,Ma=he.add2,N7=he.add,Is;(function(t){function e(r={},n=2048,o=1024,i){n*=2,o*=2;let a=he.create(Float32Array,3,o,i?i.centerBuffer.ref.value:n),s=he.create(Float32Array,2,o,i?i.mappingBuffer.ref.value:n),l=he.create(Float32Array,1,o,i?i.depthBuffer.ref.value:n),c=he.create(Uint32Array,3,o,i?i.indexBuffer.ref.value:n),u=he.create(Float32Array,1,o,i?i.groupBuffer.ref.value:n),d=he.create(Float32Array,2,o,i?i.tcoordBuffer.ref.value:n),m=w(w({},g.getDefaultValues(Bo.Params)),r),{attachment:p,background:h,backgroundMargin:f,tether:b,tetherLength:v,tetherBaseWidth:x}=m,S=Gj(m),T=1/2.5*f,E=S.buffer/S.lineHeight,_=(D,P,A,I,k)=>{Yg(a,D,P,A),N7(l,I),N7(u,k)};return{add:(D,P,A,I,k,M,R)=>{let B=0,F=D.length;for(let J=0;J<F;++J){let $=S.get(D[J]);B+=$.nw-2*E}let G=1/1.25,V,H;if(p.startsWith("top")?V=G:p.startsWith("middle")?V=G/2:V=0,p.endsWith("right")?H=B:p.endsWith("center")?H=B/2:H=0,b)switch(p){case"bottom-left":H-=v/2+T+.1,V-=v/2+T;break;case"bottom-center":V-=v+T;break;case"bottom-right":H+=v/2+T+.1,V-=v/2+T;break;case"middle-left":H-=v+T+.1;break;case"middle-center":break;case"middle-right":H+=v+T+.1;break;case"top-left":H-=v/2+T+.1,V+=v/2+T;break;case"top-center":V+=v+T;break;case"top-right":H+=v/2+T+.1,V+=v/2+T;break}let Q=(-H-T-.1)*M,L=(B-H+T+.1)*M,Y=(G-V+T)*M,j=(-V-T)*M;if(h){Ma(s,Q,Y),Ma(s,Q,j),Ma(s,L,Y),Ma(s,L,j);let J=a.elementCount;for(let $=0;$<4;++$)Ma(d,10,10),_(P,A,I,k,R);Yg(c,J+pu[0],J+pu[1],J+pu[2]),Yg(c,J+pu[3],J+pu[4],J+pu[5])}if(b){let J,$,ae,Z,se,Me,be,_e,je=v*M,gt=x*M;switch(p){case"bottom-left":J=Q-je/2,ae=Q+gt/2,se=Q,be=Q,$=j-je/2,Z=j,Me=j+gt/2,_e=j;break;case"bottom-center":J=0,ae=gt/2,se=-gt/2,be=0,$=j-je,Z=j,Me=j,_e=j;break;case"bottom-right":J=L+je/2,ae=L,se=L-gt/2,be=L,$=j-je/2,Z=j+gt/2,Me=j,_e=j;break;case"middle-left":J=Q-je,ae=Q,se=Q,be=Q,$=0,Z=-gt/2,Me=gt/2,_e=0;break;case"middle-center":J=0,ae=0,se=0,be=0,$=0,Z=0,Me=0,_e=0;break;case"middle-right":J=L+je,ae=L,se=L,be=L,$=0,Z=gt/2,Me=-gt/2,_e=0;break;case"top-left":J=Q-je/2,ae=Q+gt/2,se=Q,be=Q,$=Y+je/2,Z=Y,Me=Y-gt/2,_e=Y;break;case"top-center":J=0,ae=gt/2,se=-gt/2,be=0,$=Y+je,Z=Y,Me=Y,_e=Y;break;case"top-right":J=L+je/2,ae=L,se=L-gt/2,be=L,$=Y+je/2,Z=Y-gt/2,Me=Y,_e=Y;break;default:ur(p)}Ma(s,J,$),Ma(s,ae,Z),Ma(s,se,Me),Ma(s,be,_e);let fr=a.elementCount;for(let Nr=0;Nr<4;++Nr)Ma(d,10,10),_(P,A,I,k,R);Yg(c,fr,fr+1,fr+3),Yg(c,fr,fr+3,fr+2)}H+=E,V+=E;let O=0;for(let J=0;J<F;++J){let $=S.get(D[J]),ae=(O-H)*M,Z=(O+$.nw-H)*M,se=($.nh-V)*M,Me=-V*M;Ma(s,ae,se),Ma(s,ae,Me),Ma(s,Z,se),Ma(s,Z,Me);let be=S.texture.width,_e=S.texture.height;Ma(d,$.x/be,$.y/_e),Ma(d,$.x/be,($.y+$.h)/_e),Ma(d,($.x+$.w)/be,$.y/_e),Ma(d,($.x+$.w)/be,($.y+$.h)/_e),O+=$.nw-2*E;let je=a.elementCount;for(let gt=0;gt<4;++gt)_(P,A,I,k,R);Yg(c,je+pu[0],je+pu[1],je+pu[2]),Yg(c,je+pu[3],je+pu[4],je+pu[5])}},getText:()=>{let D=S.texture,P=he.compact(a,!0),A=he.compact(s,!0),I=he.compact(l,!0),k=he.compact(c,!0),M=he.compact(u,!0),R=he.compact(d,!0);return Bo.create(D,P,A,I,k,M,R,c.elementCount/2,i)}}}t.create=e})(Is||(Is={}));var vv={granularity:"element",condensed:!1,reverse:!1,countsOnly:!1,hidePrefix:!1,htmlStyling:!0};function fu(t,e={}){var r;switch(t.kind){case"structure-loci":return t.structure.models.map(d=>d.entry).filter(d=>!!d).join(", ");case"element-loci":return Qg(z.Stats.ofLoci(t),e);case"bond-loci":let n=t.bonds[0];return n?F1(n,e):"";case"shape-loci":return t.shape.name;case"group-loci":let o=t.groups[0];return o?t.shape.getLabel(we.start(o.ids),o.instance):"";case"every-loci":return"Everything";case"empty-loci":return"Nothing";case"data-loci":return t.getLabel();case"volume-loci":return t.volume.label||"Volume";case"isosurface-loci":return[`${t.volume.label||"Volume"}`,`Isosurface at ${xe.IsoValue.toString(t.isoValue)}`].join(" | ");case"cell-loci":let i=we.size(t.indices),a=we.start(t.indices),s=xe.IsoValue.absolute(t.volume.grid.cells.data[a]),l=xe.IsoValue.toRelative(s,t.volume.grid.stats),c=[`${t.volume.label||"Volume"}`,`${i===1?`Cell #${a}`:`${i} Cells`}`];return i===1&&c.push(`${xe.IsoValue.toString(s)} (${xe.IsoValue.toString(l)})`),c.join(" | ");case"segment-loci":let u=(r=xe.Segmentation.get(t.volume))===null||r===void 0?void 0:r.labels;if(u&&t.segments.length===1){let d=u[t.segments[0]];if(d)return d}return[`${t.volume.label||"Volume"}`,`${t.segments.length===1?`Segment ${t.segments[0]}`:`${t.segments.length} Segments`}`].join(" | ")}}function yv(t,e){return t===1?`1 ${e}`:`${t} ${e}s`}function O1(t,e,r,n,o,i){return`${Sc(e,{granularity:r,hidePrefix:n,reverse:o,condensed:i})} <small>[+ ${yv(t-1,`other ${m0(r)}`)}]</small>`}function Age(t){let{elements:e,model:r}=t,{chainAtomSegments:n,residueAtomSegments:o}=r.atomicHierarchy,i=n.offsets[n.index[e[0]]],a=n.offsets[n.index[e[e.length-1]]+1]-1;return o.index[a]-o.index[i]+1}function Qg(t,e={}){let r=w(w({},vv),e),n=kge(t,r.countsOnly,r.hidePrefix,r.condensed,r.reverse);return r.htmlStyling?n:sd(n)}function qf(t,e={}){let r=z.Stats.create();for(let n of t)z.Stats.add(r,r,z.Stats.ofLoci(n));return Qg(r,e)}function kge(t,e=!1,r=!1,n=!1,o=!1){let{structureCount:i,chainCount:a,residueCount:s,conformationCount:l,elementCount:c}=t;if(!e&&c===1&&s===0&&a===0)return Sc(t.firstElementLoc,{hidePrefix:r,condensed:n,granularity:"element",reverse:o});if(!e&&c===0&&s===1&&a===0)return Sc(t.firstResidueLoc,{hidePrefix:r,condensed:n,granularity:"residue",reverse:o});if(!e&&c===0&&s===0&&a===1){let{unit:u}=t.firstChainLoc,d=Pe.isAtomic(u)&&Age(u)===1||Pe.Traits.is(u.traits,Pe.Trait.MultiChain)?"residue":"chain";return Sc(t.firstChainLoc,{hidePrefix:r,condensed:n,granularity:d,reverse:o})}else if(e){let u=[];return i>0&&u.push(yv(i,"Structure")),a>0&&u.push(yv(a,"Chain")),s>0&&u.push(yv(s,"Residue")),l>0&&u.push(yv(l,"Conformation")),c>0&&u.push(yv(c,"Element")),u.join("<small> + </small>")}else{let u=[];return i>0&&u.push(i===1?Sc(t.firstStructureLoc,{hidePrefix:r,condensed:n,granularity:"structure",reverse:o}):O1(i,t.firstStructureLoc,"structure",r,o,n)),a>0&&(u.push(a===1?Sc(t.firstChainLoc,{condensed:n,granularity:"chain",hidePrefix:r,reverse:o}):O1(a,t.firstChainLoc,"chain",r,o,n)),r=!0),s>0&&(u.push(s===1?Sc(t.firstResidueLoc,{condensed:n,granularity:"residue",hidePrefix:r,reverse:o}):O1(s,t.firstResidueLoc,"residue",r,o,n)),r=!0),l>0&&(u.push(l===1?Sc(t.firstConformationLoc,{condensed:n,granularity:"conformation",hidePrefix:r,reverse:o}):O1(l,t.firstConformationLoc,"conformation",r,o,n)),r=!0),c>0&&u.push(c===1?Sc(t.firstElementLoc,{condensed:n,granularity:"element",hidePrefix:r,reverse:o}):O1(c,t.firstElementLoc,"element",r,o,n)),u.join("<small> + </small>")}}function F1(t,e={}){return gw({loci:[z.Loci(t.aStructure,[{unit:t.aUnit,indices:we.ofSingleton(t.aIndex)}]),z.Loci(t.bStructure,[{unit:t.bUnit,indices:we.ofSingleton(t.bIndex)}])]},e)}function gw(t,e={}){let r=w(w({},vv),e),n=Mge(t,r);return r.htmlStyling?n:sd(n)}function Mge(t,e){let{granularity:r,hidePrefix:n,reverse:o,condensed:i}=e,a=!0;for(let s of t.loci)if(!z.Loci.is(s)||z.Loci.size(s)!==1){a=!1;break}if(a){let l=t.loci.map(u=>{let{unit:d,indices:m}=u.elements[0];return z.Location.create(u.structure,d,d.elements[we.start(m)])}).map(u=>V7(u,r,n,o||i));if(i)return l.map(u=>u[0].replace(/\[.*\]/g,"").trim()).filter(u=>!!u).join(" \u2014 ");let c=0;for(let u=0,d=Math.min(...l.map(m=>m.length))-1;u<d;++u){let m=!0;for(let p=1,h=l.length;p<h;++p)if(l[0][u]!==l[p][u]){m=!1;break}if(m)c+=1;else break}if(c>0){let u=[l[0].join(" | ")];for(let d=1,m=l.length;d<m;++d)u.push(l[d].slice(c).filter(p=>!!p).join(" | "));return u.join(" \u2014 ")}else return l.map(u=>u.filter(d=>!!d).join(" | ")).filter(u=>!!u).join("</br>")}else return t.loci.map(l=>fu(l,e)).filter(l=>!!l).join(i?" \u2014 ":"</br>")}function Sc(t,e={}){var r,n;let o=w(w({},vv),e),i=V7(t,o.granularity,o.hidePrefix,o.reverse||o.condensed),a=o.condensed?(n=(r=i[0])===null||r===void 0?void 0:r.replace(/\[.*\]/g,"").trim())!==null&&n!==void 0?n:"":i.filter(s=>!!s).join(" | ");return o.htmlStyling?a:sd(a)}function V7(t,e="element",r=!1,n=!1){let o=[];if(!r){let i=t.unit.model.entry;i.length>30&&(i=i.substr(0,27)+"\u2026"),o.push(`<small>${i}</small>`),e!=="structure"&&(o.push(`<small>Model ${t.unit.model.modelNum}</small>`),o.push(`<small>Instance ${t.unit.conformation.operator.name}</small>`))}return Pe.isAtomic(t.unit)?o.push(...Rge(t,e,n)):Pe.isCoarse(t.unit)?o.push(...Lge(t,e)):o.push("Unknown"),n?o.reverse():o}function Rge(t,e,r=!1){let n=z.Location.residueIndex(t),o=Ne.chain.label_asym_id(t),i=Ne.chain.auth_asym_id(t),a=t.unit.model.atomicHierarchy.residues.label_seq_id.valueKind(n)===0,s=Ne.residue.label_seq_id(t),l=Ne.residue.auth_seq_id(t),c=Ne.residue.pdbx_PDB_ins_code(t),u=Ne.atom.label_comp_id(t),d=Ne.atom.label_atom_id(t),m=Ne.atom.label_alt_id(t),p=Ne.atom.occupancy(t),h=Ne.residue.microheterogeneityCompIds(t),f=e==="residue"&&h.length>1?`(${h.join("|")})`:u,b=[];switch(e){case"element":b.push(`<b>${d}</b>${m?`%${m}`:""}`);case"conformation":e==="conformation"&&m&&b.push(`<small>Conformation</small> <b>${m}</b>`);case"residue":let v=s===l||!a?l:s;b.push(`<b>${f} ${v}</b>${v!==l?` <small>[auth</small> <b>${l}</b><small>]</small>`:""}<b>${c||""}</b>`);case"chain":o===i?b.push(`<b>${o}</b>`):e==="chain"&&Pe.Traits.is(t.unit.traits,Pe.Trait.MultiChain)?b.push(`<small>[auth</small> <b>${i}</b><small>]</small>`):b.push(`<b>${o}</b> <small>[auth</small> <b>${i}</b><small>]</small>`)}return b.length>0&&p!==1&&!r&&(b[0]=`${b[0]} <small>[occupancy</small> <b>${Math.round(100*p)/100}</b><small>]</small>`),b.reverse()}function Lge(t,e){let r=Ne.coarse.asym_id(t),n=Ne.coarse.seq_id_begin(t),o=Ne.coarse.seq_id_end(t),i=[];switch(e){case"element":case"conformation":case"residue":if(n===o){let a=Ne.coarse.entityKey(t),l=t.unit.model.sequence.byEntityKey[a].sequence.compId.value(n-1);i.push(`<b>${l} ${n}</b>`)}else i.push(`<b>${n}-${o}</b>`);case"chain":i.push(`<b>${r}</b>`)}return i.reverse()}function bv(t,e={}){let r=w(U(w({},vv),{measureOnly:!1,unitLabel:"\u212B"}),e),[n,o]=t.loci.map(s=>st.getCenter(s)),i=`${y.distance(n,o).toFixed(2)} ${r.unitLabel}`;if(r.measureOnly)return i;let a=gw(t,r);return r.condensed?`${i} | ${a}`:`Distance ${i}</br>${a}`}function xv(t,e={}){let r=w(U(w({},vv),{measureOnly:!1}),e),[n,o,i]=t.loci.map(u=>st.getCenter(u)),a=y.sub(y(),n,o),s=y.sub(y(),i,o),l=`${Jd(y.angle(a,s)).toFixed(2)}\xB0`;if(r.measureOnly)return l;let c=gw(t,r);return r.condensed?`${l} | ${c}`:`Angle ${l}</br>${c}`}function Sv(t,e={}){let r=w(U(w({},vv),{measureOnly:!1}),e),[n,o,i,a]=t.loci.map(c=>st.getCenter(c)),s=`${Jd(y.dihedralAngle(n,o,i,a)).toFixed(2)}\xB0`;if(r.measureOnly)return s;let l=gw(t,r);return r.condensed?`${s} | ${l}`:`Dihedral ${s}</br>${l}`}var v3={customText:g.Text("",{label:"Text",description:"Override the label with custom value.",isEssential:!0}),textColor:g.Color(ut.black,{isEssential:!0}),textSize:g.Numeric(.5,{min:.1,max:10,step:.1},{isEssential:!0})},Wf=U(w(w({},Bo.Params),v3),{borderWidth:g.Numeric(.2,{min:0,max:.5,step:.01})});var z7={unitLabel:g.Text("\u212B",{isEssential:!0})},Bge=U(w(w({},Sr.Params),z7),{lineSizeAttenuation:g.Boolean(!0),linesColor:g.Color(ut.lightgreen,{isEssential:!0}),linesSize:g.Numeric(.075,{min:.01,max:5,step:.01}),dashLength:g.Numeric(.2,{min:.01,max:.2,step:.01})}),Oge=w(w({},Wf),z7),U7={lines:(t,e)=>Yn(Vge,Sr.Utils,{modifyState:r=>U(w({},r),{markerActions:kn.Highlighting})}),text:(t,e)=>Yn(Uge,Bo.Utils,{modifyState:r=>U(w({},r),{markerActions:tt.None})})},b3=U(w(w({},Bge),Oge),{visuals:g.MultiSelect(["lines","text"],g.objectToOptions(U7))});function Fge(){return{sphereA:te(),sphereB:te(),center:y(),distance:0}}function G7(t,e){let{sphereA:r,sphereB:n,center:o}=e,[i,a]=t.loci;return st.getBoundingSphere(i,r),st.getBoundingSphere(a,n),y.add(o,r.center,n.center),y.scale(o,o,.5),e.distance=y.distance(r.center,n.center),e}var N1=Fge();function j7(t,e){return t.pairs.length===1?`Distance ${bv(t.pairs[0],{unitLabel:e,measureOnly:!0})}`:`${t.pairs.length} Distances`}function Nge(t,e,r){let n=vi.create(128,64,r);for(let o=0,i=t.pairs.length;o<i;++o)G7(t.pairs[o],N1),n.addFixedLengthDashes(N1.sphereA.center,N1.sphereB.center,e.dashLength,o);return n.getLines()}function Vge(t,e,r,n){let o=Nge(e,r,n&&n.geometry),i=j7(e,r.unitLabel),a=s=>bv(e.pairs[s],r);return Yt.create(i,e,o,()=>r.linesColor,()=>r.linesSize,a)}function zge(t,e,r){let n=Is.create(e,128,64,r);for(let o=0,i=t.pairs.length;o<i;++o){G7(t.pairs[o],N1);let{center:a,distance:s,sphereA:l,sphereB:c}=N1,u=e.customText||`${s.toFixed(2)} ${e.unitLabel}`,m=Math.max(2,l.radius,c.radius)/2;n.add(u,a[0],a[1],a[2],1,m,o)}return n.getText()}function Uge(t,e,r,n){let o=zge(e,r,n&&n.geometry),i=j7(e,r.unitLabel),a=s=>bv(e.pairs[s],r);return Yt.create(i,e,o,()=>r.textColor,()=>r.textSize,a)}function H7(t,e){return rt.createMulti("Distance",t,e,rt.StateBuilder,U7)}function x3(t){let e=t[0].loci,r=t[1].loci;return{pairs:[{loci:[e,r]}]}}function S3(t){let e=t[0].loci,r=t[1].loci,n=t[2].loci;return{triples:[{loci:[e,r,n]}]}}function C3(t){let e=t[0].loci,r=t[1].loci,n=t[2].loci,o=t[3].loci;return{quads:[{loci:[e,r,n,o]}]}}function T3(t){return{infos:[{loci:t[0].loci}]}}function w3(t){return{locis:t.map(e=>e.loci)}}function _3(t){return{locis:t.map(e=>e.loci)}}var Gge=w({},Wf),q7={text:(t,e)=>Yn(Wge,Bo.Utils)},P3=U(w({},Gge),{scaleByRadius:g.Boolean(!0),visuals:g.MultiSelect(["text"],g.objectToOptions(q7)),snapshotKey:g.Text("",{isEssential:!0,disableInteractiveUpdates:!0,description:"Activate the snapshot with the provided key when clicking on the label"}),tooltip:g.Text("",{isEssential:!0,multiline:!0,disableInteractiveUpdates:!0,placeholder:"Tooltip",description:"Tooltip text to be displayed when hovering over the label"})}),jge=te();function E3(t,e=!1){return t.label||fu(t.loci,{hidePrefix:!0,htmlStyling:!1,condensed:e})}function Hge(t){return t.infos.length===1?E3(t.infos[0]):`${t.infos.length} Labels`}function qge(t,e,r){let n=Is.create(e,128,64,r),o=e.customText.trim();for(let i=0,a=t.infos.length;i<a;++i){let s=t.infos[i],l=st.getBoundingSphere(s.loci,jge);if(!l)continue;let{center:c,radius:u}=l,d=o||E3(s,!0);n.add(d,c[0],c[1],c[2],e.scaleByRadius?u/.9:0,e.scaleByRadius?Math.max(1,u):1,i)}return n.getText()}function Wge(t,e,r,n){var o,i;let a=qge(e,r,n&&n.geometry),s=Hge(e),l=(i=(o=r.tooltip)===null||o===void 0?void 0:o.trim())!==null&&i!==void 0?i:"",c=r.customText.trim(),u;return l?u=d=>l:c?u=d=>c:u=d=>E3(e.infos[d]),Yt.create(s,e,a,()=>r.textColor,()=>r.textSize,u)}function W7(t,e){return rt.createMulti("Label",t,e,rt.StateBuilder,q7)}var Kg=y(),Xge=W.identity(),$g=new Float32Array(6*3),Yge=new Uint8Array([0,1,2,3,4,5]);function X7(t,e,r,n,o){let{origin:i,dirA:a,dirB:s,dirC:l}=e;y.add(Kg,i,a),y.toArray(y.add(Kg,i,a),$g,0),y.toArray(y.sub(Kg,i,a),$g,3),y.toArray(y.add(Kg,i,s),$g,6),y.toArray(y.sub(Kg,i,s),$g,9),y.toArray(y.add(Kg,i,l),$g,12),y.toArray(y.sub(Kg,i,l),$g,15);let c=am($g,Yge),u=Yc.volume(e),d=Math.cbrt(u)/300*r;Te.addCage(t,Xge,c,d,n,o)}var pit=y.zero(),fit=y.zero();var Xf=y(),Qge=y(),Kge=y(),$ge=y(),Zge=W.identity(),Y7=new Float32Array(8*3),Jge=new Uint8Array([0,1,0,3,0,6,1,2,1,7,2,3,2,4,3,5,4,5,4,7,5,6,6,7]);function Q7(t,e,r,n,o){let{origin:i,dirA:a,dirB:s,dirC:l}=e,c=y.negate(Qge,a),u=y.negate(Kge,s),d=y.negate($ge,l),m=0,p=function(v,x,S){y.copy(Xf,i),y.add(Xf,Xf,v),y.add(Xf,Xf,x),y.add(Xf,Xf,S),y.toArray(Xf,Y7,m),m+=3};p(a,s,l),p(a,s,d),p(a,u,d),p(a,u,l),p(c,u,d),p(c,u,l),p(c,s,l),p(c,s,d);let h=am(Y7,Jge),f=Yc.volume(e),b=Math.cbrt(f)/300*r;Te.addCage(t,Zge,h,b,n,o)}var eye=W.identity(),K7=y();function tye(t,e,r,n,o){return y.add(K7,e,r),W.targetTo(t,e,K7,n),W.setTranslation(t,e),W.scale(t,t,o)}function Cv(t,e,r,n,o,i){Te.addPrimitive(t,tye(eye,e,r,n,o),c3(i))}var I3={color:g.Color(ut.orange),scaleFactor:g.Numeric(1,{min:.1,max:10,step:.1}),radiusScale:g.Numeric(2,{min:.1,max:10,step:.1})},rye=w(w({},Be.Params),I3),nye=w(w({},Be.Params),I3),oye=w(w({},Be.Params),I3),$7={axes:(t,e)=>Yn(sye,Be.Utils),box:(t,e)=>Yn(uye,Be.Utils),ellipsoid:(t,e)=>Yn(pye,Be.Utils)},D3=U(w(w(w({},rye),nye),oye),{visuals:g.MultiSelect(["box"],g.objectToOptions($7))});function iye(t){return`Principal Axes of ${qf(t,{countsOnly:!0})}`}function aye(t,e,r){let n=Te.createState(256,128,r),o=z.Loci.getPrincipalAxesMany(t.locis);return Yc.scale(o.momentsAxes,o.momentsAxes,e.scaleFactor),n.currentGroup=0,X7(n,o.momentsAxes,e.radiusScale,2,20),Te.getMesh(n)}function sye(t,e,r,n){let o=aye(e,r,n&&n.geometry),i=iye(e.locis);return Yt.create(i,e,o,()=>r.color,()=>1,()=>i)}function lye(t){return`Oriented Box of ${qf(t,{countsOnly:!0})}`}function cye(t,e,r){let n=Te.createState(256,128,r),o=z.Loci.getPrincipalAxesMany(t.locis);return Yc.scale(o.boxAxes,o.boxAxes,e.scaleFactor),n.currentGroup=0,Q7(n,o.boxAxes,e.radiusScale,2,20),Te.getMesh(n)}function uye(t,e,r,n){let o=cye(e,r,n&&n.geometry),i=lye(e.locis);return Yt.create(i,e,o,()=>r.color,()=>1,()=>i)}function dye(t){return`Oriented Ellipsoid of ${qf(t,{countsOnly:!0})}`}function mye(t,e,r){let n=Te.createState(256,128,r),i=z.Loci.getPrincipalAxesMany(t.locis).boxAxes,{origin:a,dirA:s,dirB:l}=i,c=Yc.size(y(),i);y.scale(c,c,.5*e.scaleFactor);let u=y.create(c[2],c[1],c[0]);return n.currentGroup=0,Cv(n,a,s,l,u,2),Te.getMesh(n)}function pye(t,e,r,n){let o=mye(e,r,n&&n.geometry),i=dye(e.locis);return Yt.create(i,e,o,()=>r.color,()=>1,()=>i)}function Z7(t,e){let r=rt.createMulti("Orientation",t,e,rt.StateBuilder,$7);return r.setState({markerActions:kn.Highlighting}),r}var fye={radius:1,segments:36,thetaStart:0,thetaLength:Math.PI*2};function yw(t){let{radius:e,segments:r,thetaStart:n,thetaLength:o}=w(w({},fye),t),i=o===Math.PI*2,a=i?r+1:r+2,s=new Float32Array(a*3),l=new Float32Array(a*3),c=new Uint32Array(r*3);s[0]=0,s[1]=0,s[2]=0,l[0]=0,l[1]=1,l[2]=0;for(let u=0,d=3;u<r;++u,d+=3){let m=n+u/r*o;s[d]=e*Math.sin(m),s[d+1]=0,s[d+2]=e*Math.cos(m),l[d]=0,l[d+1]=1,l[d+2]=0}for(let u=1,d=0;u<r;++u,d+=3)c[d]=u,c[d+1]=u+1,c[d+2]=0;if(i){let u=(r-1)*3;c[u]=r,c[u+1]=1,c[u+2]=0}else{let u=n+o,d=(r+1)*3;s[d]=e*Math.sin(u),s[d+1]=0,s[d+2]=e*Math.cos(u),l[d]=0,l[d+1]=1,l[d+2]=0;let m=(r-1)*3;c[m]=r,c[m+1]=r+1,c[m+2]=0}return{vertices:s,normals:l,indices:c}}var J7={color:g.Color(ut.lightgreen),arcScale:g.Numeric(.7,{min:.01,max:1,step:.01})},eW=U(w(w({},Sr.Params),J7),{lineSizeAttenuation:g.Boolean(!0),linesSize:g.Numeric(.04,{min:.01,max:5,step:.01}),dashLength:g.Numeric(.04,{min:.01,max:.2,step:.01})}),hye=w({},eW),gye=w({},eW),yye=U(w(w({},Be.Params),J7),{ignoreLight:g.Boolean(!0),sectorOpacity:g.Numeric(.75,{min:0,max:1,step:.01})}),tW={vectors:(t,e)=>Yn(xye,Sr.Utils,{modifyState:r=>U(w({},r),{pickable:!1})}),arc:(t,e)=>Yn(Cye,Sr.Utils,{modifyState:r=>U(w({},r),{pickable:!1})}),sector:(t,e)=>Yn(wye,Be.Utils,{modifyProps:r=>U(w({},r),{alpha:r.sectorOpacity}),modifyState:r=>U(w({},r),{markerActions:kn.Highlighting})}),text:(t,e)=>Yn(Pye,Bo.Utils,{modifyState:r=>U(w({},r),{markerActions:tt.None})})},A3=U(w(w(w(w({},hye),gye),yye),Wf),{visuals:g.MultiSelect(["vectors","sector","text"],g.objectToOptions(tW))});function vye(){return{sphereA:te(),sphereB:te(),sphereC:te(),arcDirA:y(),arcDirC:y(),arcNormal:y(),radius:0,angle:0}}var Yf=y(),V1=W();function vw(t,e,r){let{sphereA:n,sphereB:o,sphereC:i}=e,{arcDirA:a,arcDirC:s,arcNormal:l}=e,[c,u,d]=t.loci;st.getBoundingSphere(c,n),st.getBoundingSphere(u,o),st.getBoundingSphere(d,i),y.sub(a,n.center,o.center),y.sub(s,i.center,o.center),y.cross(l,a,s);let p=Math.min(y.magnitude(a),y.magnitude(s))*r;return e.radius=p,e.angle=y.angle(a,s),e}function rW(t,e){let{radius:r,angle:n}=t,o=e?ST(n,r)/e:32;W.targetTo(V1,t.sphereB.center,t.sphereA.center,t.arcNormal),W.setTranslation(V1,t.sphereB.center),W.mul(V1,V1,W.rotY180);let i=yw({radius:r,thetaLength:n,segments:o});return A0(i,V1)}var Ra=vye();function bw(t){return t.triples.length===1?`Angle ${xv(t.triples[0],{measureOnly:!0})}`:`${t.triples.length} Angles`}function bye(t,e,r){let n=vi.create(128,64,r);for(let o=0,i=t.triples.length;o<i;++o)vw(t.triples[o],Ra,e.arcScale),n.addFixedLengthDashes(Ra.sphereB.center,Ra.sphereA.center,e.dashLength,o),n.addFixedLengthDashes(Ra.sphereB.center,Ra.sphereC.center,e.dashLength,o);return n.getLines()}function xye(t,e,r,n){let o=bye(e,r,n&&n.geometry),i=bw(e);return Yt.create(i,e,o,()=>r.color,()=>r.linesSize,()=>"")}function Sye(t,e,r){let n=vi.create(128,64,r);for(let o=0,i=t.triples.length;o<i;++o){vw(t.triples[o],Ra,e.arcScale);let a=rW(Ra,e.dashLength),{indices:s,vertices:l}=a;for(let c=0,u=s.length;c<u;c+=3){if(c%2===1)continue;let d=s[c]*3,m=s[c+1]*3,p=l[d],h=l[d+1],f=l[d+2],b=l[m],v=l[m+1],x=l[m+2];n.add(p,h,f,b,v,x,o)}}return n.getLines()}function Cye(t,e,r,n){let o=Sye(e,r,n&&n.geometry),i=bw(e);return Yt.create(i,e,o,()=>r.color,()=>r.linesSize,()=>"")}function Tye(t,e,r){let n=Te.createState(128,64,r);for(let o=0,i=t.triples.length;o<i;++o){vw(t.triples[o],Ra,e.arcScale);let a=rW(Ra);n.currentGroup=o,Te.addPrimitive(n,W.id,a),Te.addPrimitiveFlipped(n,W.id,a)}return Te.getMesh(n)}function wye(t,e,r,n){let o=Tye(e,r,n&&n.geometry),i=bw(e),a=s=>xv(e.triples[s]);return Yt.create(i,e,o,()=>r.color,()=>1,a)}function _ye(t,e,r){let n=Is.create(e,128,64,r);for(let o=0,i=t.triples.length;o<i;++o){vw(t.triples[o],Ra,e.arcScale),y.add(Yf,Ra.arcDirA,Ra.arcDirC),y.setMagnitude(Yf,Yf,Ra.radius),y.add(Yf,Ra.sphereB.center,Yf);let a=Jd(Ra.angle).toFixed(2),s=e.customText||`${a}\xB0`,c=Math.max(2,Ra.sphereA.radius,Ra.sphereB.radius,Ra.sphereC.radius)/2;n.add(s,Yf[0],Yf[1],Yf[2],.1,c,o)}return n.getText()}function Pye(t,e,r,n){let o=_ye(e,r,n&&n.geometry),i=bw(e),a=s=>xv(e.triples[s]);return Yt.create(i,e,o,()=>r.textColor,()=>r.textSize,a)}function nW(t,e){return rt.createMulti("Angle",t,e,rt.StateBuilder,tW)}var oW={color:g.Color(ut.lightgreen),arcScale:g.Numeric(.7,{min:.01,max:1,step:.01})},xw=U(w(w({},Sr.Params),oW),{lineSizeAttenuation:g.Boolean(!0),linesSize:g.Numeric(.04,{min:.01,max:5,step:.01}),dashLength:g.Numeric(.04,{min:.01,max:.2,step:.01})}),Eye=w({},xw),Iye=w({},xw),Dye=w({},xw),Aye=w({},xw),kye=U(w(w({},Be.Params),oW),{ignoreLight:g.Boolean(!0),sectorOpacity:g.Numeric(.75,{min:0,max:1,step:.01})}),iW={vectors:(t,e)=>Yn(Lye,Sr.Utils,{modifyState:r=>U(w({},r),{pickable:!1})}),extenders:(t,e)=>Yn(zye,Sr.Utils,{modifyState:r=>U(w({},r),{pickable:!1})}),connector:(t,e)=>Yn(Oye,Sr.Utils,{modifyState:r=>U(w({},r),{pickable:!1})}),arms:(t,e)=>Yn(Nye,Sr.Utils,{modifyState:r=>U(w({},r),{pickable:!1})}),arc:(t,e)=>Yn(Gye,Sr.Utils,{modifyState:r=>U(w({},r),{pickable:!1})}),sector:(t,e)=>Yn(Hye,Be.Utils,{modifyProps:r=>U(w({},r),{alpha:r.sectorOpacity}),modifyState:r=>U(w({},r),{markerActions:kn.Highlighting})}),text:(t,e)=>Yn(Wye,Bo.Utils,{modifyState:r=>U(w({},r),{markerActions:tt.None})})},k3=U(w(w(w(w(w(w({},Eye),Iye),Dye),Aye),kye),Wf),{visuals:g.MultiSelect(["extenders","arms","sector","text"],g.objectToOptions(iW))});function Mye(){return{sphereA:te(),sphereB:te(),sphereC:te(),sphereD:te(),dirBA:y(),dirCD:y(),projA:y(),projD:y(),arcPointA:y(),arcPointD:y(),arcDirA:y(),arcDirD:y(),arcCenter:y(),arcNormal:y(),radius:0,angle:0}}var Ds=y(),z1=W();function Zg(t,e,r){let{sphereA:n,sphereB:o,sphereC:i,sphereD:a,dirBA:s,dirCD:l,projA:c,projD:u}=e,{arcPointA:d,arcPointD:m,arcDirA:p,arcDirD:h,arcCenter:f,arcNormal:b}=e,[v,x,S,T]=t.loci;st.getBoundingSphere(v,n),st.getBoundingSphere(x,o),st.getBoundingSphere(S,i),st.getBoundingSphere(T,a),y.add(f,o.center,i.center),y.scale(f,f,.5),y.sub(s,n.center,o.center),y.sub(l,a.center,i.center),y.add(d,f,s),y.add(m,f,l),y.sub(b,i.center,o.center),y.orthogonalize(p,b,s),y.orthogonalize(h,b,l),y.projectPointOnVector(c,d,p,f),y.projectPointOnVector(u,m,h,f);let _=Math.min(y.distance(c,f),y.distance(u,f))*r;y.setMagnitude(p,p,_),y.setMagnitude(h,h,_),y.add(d,f,p),y.add(m,f,h),e.radius=_,e.angle=y.dihedralAngle(n.center,o.center,i.center,a.center),y.matchDirection(Ds,b,y.sub(Ds,d,n.center));let D=y.angle(s,Ds),P=_/Math.cos(D-Sg);y.add(c,o.center,y.setMagnitude(Ds,s,P)),y.matchDirection(Ds,b,y.sub(Ds,m,a.center));let A=y.angle(l,Ds),I=_/Math.cos(A-Sg);return y.add(u,i.center,y.setMagnitude(Ds,l,I)),e}function aW(t,e){let{radius:r,angle:n}=t,o=e?ST(n,r)/e:32;W.targetTo(z1,t.arcCenter,n<0?t.arcPointD:t.arcPointA,t.arcNormal),W.setTranslation(z1,t.arcCenter),W.mul(z1,z1,W.rotY180);let i=yw({radius:r,thetaLength:Math.abs(n),segments:o});return A0(i,z1)}var wn=Mye();function Jg(t){return t.quads.length===1?`Dihedral ${Sv(t.quads[0],{measureOnly:!0})}`:`${t.quads.length} Dihedrals`}function Rye(t,e,r){let n=vi.create(128,64,r);for(let o=0,i=t.quads.length;o<i;++o)Zg(t.quads[o],wn,e.arcScale),n.addFixedLengthDashes(wn.arcCenter,wn.arcPointA,e.dashLength,o),n.addFixedLengthDashes(wn.arcCenter,wn.arcPointD,e.dashLength,o);return n.getLines()}function Lye(t,e,r,n){let o=Rye(e,r,n&&n.geometry),i=Jg(e);return Yt.create(i,e,o,()=>r.color,()=>r.linesSize,()=>"")}function Bye(t,e,r){let n=vi.create(128,64,r);for(let o=0,i=t.quads.length;o<i;++o)Zg(t.quads[o],wn,e.arcScale),n.addFixedLengthDashes(wn.sphereB.center,wn.sphereC.center,e.dashLength,o);return n.getLines()}function Oye(t,e,r,n){let o=Bye(e,r,n&&n.geometry),i=Jg(e);return Yt.create(i,e,o,()=>r.color,()=>r.linesSize,()=>"")}function Fye(t,e,r){let n=vi.create(128,64,r);for(let o=0,i=t.quads.length;o<i;++o)Zg(t.quads[o],wn,e.arcScale),n.addFixedLengthDashes(wn.sphereB.center,wn.sphereA.center,e.dashLength,o),n.addFixedLengthDashes(wn.sphereC.center,wn.sphereD.center,e.dashLength,o);return n.getLines()}function Nye(t,e,r,n){let o=Fye(e,r,n&&n.geometry),i=Jg(e);return Yt.create(i,e,o,()=>r.color,()=>r.linesSize,()=>"")}function Vye(t,e,r){let n=vi.create(128,64,r);for(let o=0,i=t.quads.length;o<i;++o)Zg(t.quads[o],wn,e.arcScale),n.addFixedLengthDashes(wn.arcPointA,wn.projA,e.dashLength,o),n.addFixedLengthDashes(wn.arcPointD,wn.projD,e.dashLength,o);return n.getLines()}function zye(t,e,r,n){let o=Vye(e,r,n&&n.geometry),i=Jg(e);return Yt.create(i,e,o,()=>r.color,()=>r.linesSize,()=>"")}function Uye(t,e,r){let n=vi.create(128,64,r);for(let o=0,i=t.quads.length;o<i;++o){Zg(t.quads[o],wn,e.arcScale);let a=aW(wn,e.dashLength),{indices:s,vertices:l}=a;for(let c=0,u=s.length;c<u;c+=3){if(c%2===1)continue;let d=s[c]*3,m=s[c+1]*3,p=l[d],h=l[d+1],f=l[d+2],b=l[m],v=l[m+1],x=l[m+2];n.add(p,h,f,b,v,x,o)}}return n.getLines()}function Gye(t,e,r,n){let o=Uye(e,r,n&&n.geometry),i=Jg(e);return Yt.create(i,e,o,()=>r.color,()=>r.linesSize,()=>"")}function jye(t,e,r){let n=Te.createState(128,64,r);for(let o=0,i=t.quads.length;o<i;++o){Zg(t.quads[o],wn,e.arcScale);let a=aW(wn);n.currentGroup=o,Te.addPrimitive(n,W.id,a),Te.addPrimitiveFlipped(n,W.id,a)}return Te.getMesh(n)}function Hye(t,e,r,n){let o=jye(e,r,n&&n.geometry),i=Jg(e),a=s=>Sv(e.quads[s]);return Yt.create(i,e,o,()=>r.color,()=>1,a)}function qye(t,e,r){let n=Is.create(e,128,64,r);for(let o=0,i=t.quads.length;o<i;++o){Zg(t.quads[o],wn,e.arcScale),y.add(Ds,wn.arcDirA,wn.arcDirD),y.setMagnitude(Ds,Ds,wn.radius),y.add(Ds,wn.arcCenter,Ds);let a=Jd(wn.angle).toFixed(2);a==="-0.00"&&(a="0.00");let s=e.customText||`${a}\xB0`,c=Math.max(2,wn.sphereA.radius,wn.sphereB.radius,wn.sphereC.radius,wn.sphereD.radius)/2;n.add(s,Ds[0],Ds[1],Ds[2],.1,c,o)}return n.getText()}function Wye(t,e,r,n){let o=qye(e,r,n&&n.geometry),i=Jg(e),a=s=>Sv(e.quads[s]);return Yt.create(i,e,o,()=>r.textColor,()=>r.textSize,a)}function sW(t,e){return rt.createMulti("Dihedral",t,e,rt.StateBuilder,iW)}var M3={};ua(M3,{BoxShape3D:()=>Xye,getBoxMesh:()=>Sw});var Xye=Je.BuiltIn({name:"box-shape-3d",display:"Box Shape",from:X.Root,to:X.Shape.Provider,params:{bottomLeft:g.Vec3(y()),topRight:g.Vec3(y.create(1,1,1)),radius:g.Numeric(.15,{min:.01,max:4,step:.01}),color:g.Color(ut.red)}})({canAutoUpdate(){return!0},apply({params:t}){return ie.create("Shape Representation",e=>N(this,null,function*(){return new X.Shape.Provider({label:"Box",data:t,params:Be.Params,getShape:(r,n)=>{let o=Sw(qe.create(t.bottomLeft,t.topRight),t.radius);return Yt.create("Box",n,o,()=>n.color,()=>1,()=>"Box")},geometryUtils:Be.Utils},{label:"Box"})}))}});function Sw(t,e,r){let n=y.sub(y(),t.max,t.min),o=W.fromTranslation(W(),y.create(.5,.5,.5)),i=W.fromScaling(W(),n),a=W.fromTranslation(W(),t.min),s=W.mul3(W(),a,i,o),l=Te.createState(256,128,r);l.currentGroup=1,Te.addCage(l,s,JT(),e,2,20);let c=Te.getMesh(l),u=y.scaleAndAdd(y(),t.min,n,.5),d=y.distance(t.min,u);return c.setBoundingSphere(te.create(u,d)),c}var lW={vertices:new Float32Array([-.5,.5,0,.5,.5,0,-.5,-.5,0,.5,-.5,0]),normals:new Float32Array([0,0,1,0,0,1,0,0,1,0,0,1]),indices:new Uint32Array([0,2,1,1,2,3])},zat={vertices:lW.vertices,edges:new Uint32Array([0,1,2,3,3,1,2,0])};function cW(){return lW}var Yye=U(w({},Be.Params),{color:g.Color(ut.orange),scaleFactor:g.Numeric(1,{min:.1,max:10,step:.1})}),uW={plane:(t,e)=>Yn($ye,Be.Utils)},L3=U(w({},Yye),{visuals:g.MultiSelect(["plane"],g.objectToOptions(uW))});function Qye(t){return`Best Fit Plane of ${qf(t,{countsOnly:!0})}`}var Qf=W(),R3=y();function Kye(t,e,r){let n=Te.createState(256,128,r),i=z.Loci.getPrincipalAxesMany(t.locis).boxAxes,a=cW();return y.add(R3,i.origin,i.dirC),W.targetTo(Qf,R3,i.origin,i.dirB),W.scale(Qf,Qf,Yc.size(R3,i)),W.scaleUniformly(Qf,Qf,e.scaleFactor),W.setTranslation(Qf,i.origin),n.currentGroup=0,Te.addPrimitive(n,Qf,a),Te.addPrimitiveFlipped(n,Qf,a),Te.getMesh(n)}function $ye(t,e,r,n){let o=Kye(e,r,n&&n.geometry),i=Qye(e.locis);return Yt.create(i,e,o,()=>r.color,()=>1,()=>i)}function dW(t,e){let r=rt.createMulti("Plane",t,e,rt.StateBuilder,uW);return r.setState({markerActions:kn.Highlighting}),r}var Tv=Je.BuiltIn({name:"structure-representation-3d",display:"3D Representation",from:X.Molecule.Structure,to:X.Molecule.Structure.Representation3D,params:(t,e)=>{let{registry:r,themes:n}=e.representation.structure,o=r.get(r.default.name);if(!t){let s={help:l=>{let{name:c,params:u}=l,m=n.colorThemeRegistry.get(c).factory({},u);return{description:m.description,legend:m.legend}}};return{type:g.Mapped(r.default.name,r.types,l=>g.Group(r.get(l).getParams(n,ue.Empty))),colorTheme:g.Mapped(o.defaultColorTheme.name,n.colorThemeRegistry.types,l=>g.Group(n.colorThemeRegistry.get(l).getParams({structure:ue.Empty})),s),sizeTheme:g.Mapped(o.defaultSizeTheme.name,n.sizeThemeRegistry.types,l=>g.Group(n.sizeThemeRegistry.get(l).getParams({structure:ue.Empty})))}}let i={structure:t.data},a={help:s=>{let{name:l,params:c}=s,d=n.colorThemeRegistry.get(l).factory(i,c);return{description:d.description,legend:d.legend}}};return{type:g.Mapped(r.default.name,r.getApplicableTypes(t.data),s=>g.Group(r.get(s).getParams(n,t.data))),colorTheme:g.Mapped(o.defaultColorTheme.name,n.colorThemeRegistry.getApplicableTypes(i),s=>g.Group(n.colorThemeRegistry.get(s).getParams(i)),a),sizeTheme:g.Mapped(o.defaultSizeTheme.name,n.sizeThemeRegistry.getApplicableTypes(i),s=>g.Group(n.sizeThemeRegistry.get(s).getParams(i)))}}})({canAutoUpdate({a:t,oldParams:e,newParams:r}){return t.data.elementCount<1e4||e.type.name===r.type.name&&r.type.params.quality!=="custom"},apply({a:t,params:e,cache:r},n){return ie.create("Structure Representation",o=>N(this,null,function*(){var i,a;let s={runtime:o,assetManager:n.managers.asset},l=n.representation.structure.registry.get(e.type.name),c=((i=l.getData)===null||i===void 0?void 0:i.call(l,t.data,e.type.params))||t.data;l.ensureCustomProperties&&(yield l.ensureCustomProperties.attach(s,c));let u=l.factory(w({webgl:(a=n.canvas3d)===null||a===void 0?void 0:a.webgl},n.representation.structure.themes),l.getParams);yield An.ensureDependencies(s,n.representation.structure.themes,{structure:c},e),u.setTheme(An.create(n.representation.structure.themes,{structure:c},e));let d=e.type.params||{};return yield u.createOrUpdate(d,c).runInContext(o),new X.Molecule.Structure.Representation3D({repr:u,sourceData:t.data},{label:l.label})}))},update({a:t,b:e,oldParams:r,newParams:n,cache:o},i){return ie.create("Structure Representation",a=>N(this,null,function*(){var s,l;if(n.type.name!==r.type.name)return Se.UpdateResult.Recreate;let c=i.representation.structure.registry.get(n.type.name);if(!((s=c.mustRecreate)===null||s===void 0)&&s.call(c,r.type.params,n.type.params))return Se.UpdateResult.Recreate;let u=((l=c.getData)===null||l===void 0?void 0:l.call(c,t.data,n.type.params))||t.data,d={runtime:a,assetManager:i.managers.asset};c.ensureCustomProperties&&(yield c.ensureCustomProperties.attach(d,u)),An.releaseDependencies(i.representation.structure.themes,{structure:e.data.sourceData},r),yield An.ensureDependencies(d,i.representation.structure.themes,{structure:u},n),e.data.repr.setTheme(An.create(i.representation.structure.themes,{structure:u},n));let m=w(w({},e.data.repr.props),n.type.params);return yield e.data.repr.createOrUpdate(m,u).runInContext(a),e.data.sourceData=t.data,Se.UpdateResult.Updated}))},dispose({b:t,params:e},r){if(!t||!e)return;let n=t.data.sourceData,o=r.representation.structure.registry.get(e.type.name);o.ensureCustomProperties&&o.ensureCustomProperties.detach(n),An.releaseDependencies(r.representation.structure.themes,{structure:n},e)},interpolate(t,e,r){if(t.colorTheme.name!=="uniform"||e.colorTheme.name!=="uniform")return r<=.5?t:e;let n=t.colorTheme.params.value,o=e.colorTheme.params.value,i=ce.interpolate(n,o,r);return{type:r<=.5?t.type:e.type,colorTheme:{name:"uniform",params:{value:i}},sizeTheme:r<=.5?t.sizeTheme:e.sizeTheme}}}),Zye=Je.BuiltIn({name:"unwind-structure-assembly-representation-3d",display:"Unwind Assembly 3D Representation",from:X.Molecule.Structure.Representation3D,to:X.Molecule.Structure.Representation3DState,params:{t:g.Numeric(0,{min:0,max:1,step:.01})}})({canAutoUpdate(){return!0},apply({a:t,params:e}){let r=t.data.sourceData,n=new bp(r);return o3(r,n,e.t),new X.Molecule.Structure.Representation3DState({state:{unitTransforms:n},initialState:{unitTransforms:new bp(r)},info:r,repr:t.data.repr},{label:`Unwind T = ${e.t.toFixed(2)}`})},update({a:t,b:e,newParams:r,oldParams:n}){let o=e.data.info;if(t.data.sourceData!==o)return Se.UpdateResult.Recreate;if(t.data.repr!==e.data.repr)return Se.UpdateResult.Recreate;if(n.t===r.t)return Se.UpdateResult.Unchanged;let i=e.data.state.unitTransforms;return o3(o,i,r.t),e.label=`Unwind T = ${r.t.toFixed(2)}`,e.data.repr=t.data.repr,Se.UpdateResult.Updated}}),Jye=Je.BuiltIn({name:"explode-structure-representation-3d",display:"Explode 3D Representation",from:X.Molecule.Structure.Representation3D,to:X.Molecule.Structure.Representation3DState,params:{t:g.Numeric(0,{min:0,max:1,step:.01})}})({canAutoUpdate(){return!0},apply({a:t,params:e}){let r=t.data.sourceData,n=new bp(r);return i3(r,n,e.t,r.root.boundary.sphere),new X.Molecule.Structure.Representation3DState({state:{unitTransforms:n},initialState:{unitTransforms:new bp(r)},info:r,repr:t.data.repr},{label:`Explode T = ${e.t.toFixed(2)}`})},update({a:t,b:e,newParams:r,oldParams:n}){let o=t.data.sourceData;if(e.data.info!==o)return Se.UpdateResult.Recreate;if(t.data.repr!==e.data.repr)return Se.UpdateResult.Recreate;if(n.t===r.t)return Se.UpdateResult.Unchanged;let i=e.data.state.unitTransforms;return i3(o,i,r.t,o.root.boundary.sphere),e.label=`Explode T = ${r.t.toFixed(2)}`,e.data.repr=t.data.repr,Se.UpdateResult.Updated}}),e0e=Je.BuiltIn({name:"spin-structure-representation-3d",display:"Spin 3D Representation",from:X.Molecule.Structure.Representation3D,to:X.Molecule.Structure.Representation3DState,params:w({t:g.Numeric(0,{min:0,max:1,step:.01})},m7)})({canAutoUpdate(){return!0},apply({a:t,params:e}){let r=t.data.sourceData,n=new bp(r),{axis:o,origin:i}=a3(r.root,e);return s3(r,n,e.t,o,i),new X.Molecule.Structure.Representation3DState({state:{unitTransforms:n},initialState:{unitTransforms:new bp(r)},info:r,repr:t.data.repr},{label:`Spin T = ${e.t.toFixed(2)}`})},update({a:t,b:e,newParams:r,oldParams:n}){let o=t.data.sourceData;if(e.data.info!==o)return Se.UpdateResult.Recreate;if(t.data.repr!==e.data.repr)return Se.UpdateResult.Recreate;if(n.t===r.t&&n.axis===r.axis&&n.origin===r.origin)return Se.UpdateResult.Unchanged;let i=e.data.state.unitTransforms,{axis:a,origin:s}=a3(o.root,r);return s3(o,i,r.t,a,s),e.label=`Spin T = ${r.t.toFixed(2)}`,e.data.repr=t.data.repr,Se.UpdateResult.Updated}}),t0e=Je.BuiltIn({name:"overpaint-structure-representation-3d-from-script",display:"Overpaint 3D Representation",from:X.Molecule.Structure.Representation3D,to:X.Molecule.Structure.Representation3DState,params:()=>({layers:g.ObjectList({script:g.Script(Jr("(sel.atom.all)","mol-script")),color:g.Color(ut.blueviolet),clear:g.Boolean(!1)},t=>`${t.clear?"Clear":ce.toRgbString(t.color)}`,{defaultValue:[{script:Jr("(sel.atom.all)","mol-script"),color:ut.blueviolet,clear:!1}]})})})({canAutoUpdate(){return!0},apply({a:t,params:e}){let r=t.data.sourceData,n=t.data.repr.geometryVersion,o=io.ofScript(e.layers,r);return new X.Molecule.Structure.Representation3DState({state:{overpaint:o},initialState:{overpaint:io.Empty},info:{structure:r,geometryVersion:n},repr:t.data.repr},{label:`Overpaint (${o.layers.length} Layers)`})},update({a:t,b:e,newParams:r,oldParams:n}){let o=e.data.info,i=t.data.sourceData;if(i!==o.structure)return Se.UpdateResult.Recreate;if(t.data.repr!==e.data.repr)return Se.UpdateResult.Recreate;let a=t.data.repr.geometryVersion;if(a!==o.geometryVersion&&El(t.data.repr.props))return Se.UpdateResult.Recreate;let s=e.data.state.overpaint,l=io.ofScript(r.layers,i);return io.areEqual(s,l)?Se.UpdateResult.Unchanged:(o.geometryVersion=a,e.data.state.overpaint=l,e.data.repr=t.data.repr,e.label=`Overpaint (${l.layers.length} Layers)`,Se.UpdateResult.Updated)}}),r0e=Je.BuiltIn({name:"overpaint-structure-representation-3d-from-bundle",display:"Overpaint 3D Representation",from:X.Molecule.Structure.Representation3D,to:X.Molecule.Structure.Representation3DState,params:()=>({layers:g.ObjectList({bundle:g.Value(z.Bundle.Empty),color:g.Color(ut.blueviolet),clear:g.Boolean(!1)},t=>`${t.clear?"Clear":ce.toRgbString(t.color)}`,{defaultValue:[{bundle:z.Bundle.Empty,color:ut.blueviolet,clear:!1}],isHidden:!0})})})({canAutoUpdate(){return!0},apply({a:t,params:e}){let r=t.data.sourceData,n=t.data.repr.geometryVersion,o=io.ofBundle(e.layers,r);return new X.Molecule.Structure.Representation3DState({state:{overpaint:o},initialState:{overpaint:io.Empty},info:{structure:r,geometryVersion:n},repr:t.data.repr},{label:`Overpaint (${o.layers.length} Layers)`})},update({a:t,b:e,newParams:r,oldParams:n}){let o=e.data.info,i=t.data.sourceData;if(i!==o.structure)return Se.UpdateResult.Recreate;if(t.data.repr!==e.data.repr)return Se.UpdateResult.Recreate;let a=t.data.repr.geometryVersion;if(a!==o.geometryVersion&&El(t.data.repr.props))return Se.UpdateResult.Recreate;let s=e.data.state.overpaint,l=io.ofBundle(r.layers,i);return io.areEqual(s,l)?Se.UpdateResult.Unchanged:(o.geometryVersion=a,e.data.state.overpaint=l,e.data.repr=t.data.repr,e.label=`Overpaint (${l.layers.length} Layers)`,Se.UpdateResult.Updated)}}),n0e=Je.BuiltIn({name:"transparency-structure-representation-3d-from-script",display:"Transparency 3D Representation",from:X.Molecule.Structure.Representation3D,to:X.Molecule.Structure.Representation3DState,params:()=>({layers:g.ObjectList({script:g.Script(Jr("(sel.atom.all)","mol-script")),value:g.Numeric(.5,{min:0,max:1,step:.01},{label:"Transparency"})},t=>`Transparency (${t.value})`,{defaultValue:[{script:Jr("(sel.atom.all)","mol-script"),value:.5}]})})})({canAutoUpdate(){return!0},apply({a:t,params:e}){let r=t.data.sourceData,n=t.data.repr.geometryVersion,o=Jo.ofScript(e.layers,r);return new X.Molecule.Structure.Representation3DState({state:{transparency:o},initialState:{transparency:Jo.Empty},info:{structure:r,geometryVersion:n},repr:t.data.repr},{label:`Transparency (${o.layers.length} Layers)`})},update({a:t,b:e,newParams:r,oldParams:n}){let o=e.data.info,i=t.data.sourceData;if(i!==o.structure)return Se.UpdateResult.Recreate;if(t.data.repr!==e.data.repr)return Se.UpdateResult.Recreate;let a=t.data.repr.geometryVersion;if(a!==o.geometryVersion&&El(t.data.repr.props))return Se.UpdateResult.Recreate;let s=e.data.state.transparency,l=Jo.ofScript(r.layers,i);return Jo.areEqual(s,l)?Se.UpdateResult.Unchanged:(o.geometryVersion=a,e.data.state.transparency=l,e.data.repr=t.data.repr,e.label=`Transparency (${l.layers.length} Layers)`,Se.UpdateResult.Updated)}}),o0e=Je.BuiltIn({name:"transparency-structure-representation-3d-from-bundle",display:"Transparency 3D Representation",from:X.Molecule.Structure.Representation3D,to:X.Molecule.Structure.Representation3DState,params:()=>({layers:g.ObjectList({bundle:g.Value(z.Bundle.Empty),value:g.Numeric(.5,{min:0,max:1,step:.01},{label:"Transparency"})},t=>`Transparency (${t.value})`,{defaultValue:[{bundle:z.Bundle.Empty,value:.5}],isHidden:!0})})})({canAutoUpdate(){return!0},apply({a:t,params:e}){let r=t.data.sourceData,n=t.data.repr.geometryVersion,o=Jo.ofBundle(e.layers,r);return new X.Molecule.Structure.Representation3DState({state:{transparency:o},initialState:{transparency:Jo.Empty},info:{structure:r,geometryVersion:n},repr:t.data.repr},{label:`Transparency (${o.layers.length} Layers)`})},update({a:t,b:e,newParams:r,oldParams:n}){let o=e.data.info,i=t.data.sourceData;if(i!==o.structure)return Se.UpdateResult.Recreate;if(t.data.repr!==e.data.repr)return Se.UpdateResult.Recreate;let a=t.data.repr.geometryVersion;if(a!==o.geometryVersion&&El(t.data.repr.props))return Se.UpdateResult.Recreate;let s=e.data.state.transparency,l=Jo.ofBundle(r.layers,i);return Jo.areEqual(s,l)?Se.UpdateResult.Unchanged:(o.geometryVersion=a,e.data.state.transparency=l,e.data.repr=t.data.repr,e.label=`Transparency (${l.layers.length} Layers)`,Se.UpdateResult.Updated)}}),i0e=Je.BuiltIn({name:"emissive-structure-representation-3d-from-script",display:"Emissive 3D Representation",from:X.Molecule.Structure.Representation3D,to:X.Molecule.Structure.Representation3DState,params:()=>({layers:g.ObjectList({script:g.Script(Jr("(sel.atom.all)","mol-script")),value:g.Numeric(.5,{min:0,max:1,step:.01},{label:"Emissive"})},t=>`Emissive (${t.value})`,{defaultValue:[{script:Jr("(sel.atom.all)","mol-script"),value:.5}]})})})({canAutoUpdate(){return!0},apply({a:t,params:e}){let r=t.data.sourceData,n=t.data.repr.geometryVersion,o=ti.ofScript(e.layers,r);return new X.Molecule.Structure.Representation3DState({state:{emissive:o},initialState:{emissive:ti.Empty},info:{structure:r,geometryVersion:n},repr:t.data.repr},{label:`Emissive (${o.layers.length} Layers)`})},update({a:t,b:e,newParams:r,oldParams:n}){let o=e.data.info,i=t.data.sourceData;if(i!==o.structure)return Se.UpdateResult.Recreate;if(t.data.repr!==e.data.repr)return Se.UpdateResult.Recreate;let a=t.data.repr.geometryVersion;if(a!==o.geometryVersion&&El(t.data.repr.props))return Se.UpdateResult.Recreate;let s=e.data.state.emissive,l=ti.ofScript(r.layers,i);return ti.areEqual(s,l)?Se.UpdateResult.Unchanged:(o.geometryVersion=a,e.data.state.emissive=l,e.data.repr=t.data.repr,e.label=`Emissive (${l.layers.length} Layers)`,Se.UpdateResult.Updated)}}),a0e=Je.BuiltIn({name:"emissive-structure-representation-3d-from-bundle",display:"Emissive 3D Representation",from:X.Molecule.Structure.Representation3D,to:X.Molecule.Structure.Representation3DState,params:()=>({layers:g.ObjectList({bundle:g.Value(z.Bundle.Empty),value:g.Numeric(.5,{min:0,max:1,step:.01},{label:"Emissive"})},t=>`Emissive (${t.value})`,{defaultValue:[{bundle:z.Bundle.Empty,value:.5}],isHidden:!0})})})({canAutoUpdate(){return!0},apply({a:t,params:e}){let r=t.data.sourceData,n=t.data.repr.geometryVersion,o=ti.ofBundle(e.layers,r);return new X.Molecule.Structure.Representation3DState({state:{emissive:o},initialState:{emissive:ti.Empty},info:{structure:r,geometryVersion:n},repr:t.data.repr},{label:`Emissive (${o.layers.length} Layers)`})},update({a:t,b:e,newParams:r,oldParams:n}){let o=e.data.info,i=t.data.sourceData;if(i!==o.structure)return Se.UpdateResult.Recreate;if(t.data.repr!==e.data.repr)return Se.UpdateResult.Recreate;let a=t.data.repr.geometryVersion;if(a!==o.geometryVersion&&El(t.data.repr.props))return Se.UpdateResult.Recreate;let s=e.data.state.emissive,l=ti.ofBundle(r.layers,i);return ti.areEqual(s,l)?Se.UpdateResult.Unchanged:(o.geometryVersion=a,e.data.state.emissive=l,e.data.repr=t.data.repr,e.label=`Emissive (${l.layers.length} Layers)`,Se.UpdateResult.Updated)}}),s0e=Je.BuiltIn({name:"substance-structure-representation-3d-from-script",display:"Substance 3D Representation",from:X.Molecule.Structure.Representation3D,to:X.Molecule.Structure.Representation3DState,params:()=>({layers:g.ObjectList({script:g.Script(Jr("(sel.atom.all)","mol-script")),material:Qo.getParam(),clear:g.Boolean(!1)},t=>`${t.clear?"Clear":Qo.toString(t.material)}`,{defaultValue:[{script:Jr("(sel.atom.all)","mol-script"),material:Qo({roughness:1}),clear:!1}]})})})({canAutoUpdate(){return!0},apply({a:t,params:e}){let r=t.data.sourceData,n=t.data.repr.geometryVersion,o=ei.ofScript(e.layers,r);return new X.Molecule.Structure.Representation3DState({state:{substance:o},initialState:{substance:ei.Empty},info:{structure:r,geometryVersion:n},repr:t.data.repr},{label:`Substance (${o.layers.length} Layers)`})},update({a:t,b:e,newParams:r,oldParams:n}){let o=e.data.info,i=t.data.sourceData;if(i!==o.structure)return Se.UpdateResult.Recreate;if(t.data.repr!==e.data.repr)return Se.UpdateResult.Recreate;let a=t.data.repr.geometryVersion;if(a!==o.geometryVersion&&El(t.data.repr.props))return Se.UpdateResult.Recreate;let s=e.data.state.substance,l=ei.ofScript(r.layers,i);return ei.areEqual(s,l)?Se.UpdateResult.Unchanged:(o.geometryVersion=a,e.data.state.substance=l,e.data.repr=t.data.repr,e.label=`Substance (${l.layers.length} Layers)`,Se.UpdateResult.Updated)}}),l0e=Je.BuiltIn({name:"substance-structure-representation-3d-from-bundle",display:"Substance 3D Representation",from:X.Molecule.Structure.Representation3D,to:X.Molecule.Structure.Representation3DState,params:()=>({layers:g.ObjectList({bundle:g.Value(z.Bundle.Empty),material:Qo.getParam(),clear:g.Boolean(!1)},t=>`${t.clear?"Clear":Qo.toString(t.material)}`,{defaultValue:[{bundle:z.Bundle.Empty,material:Qo({roughness:1}),clear:!1}],isHidden:!0})})})({canAutoUpdate(){return!0},apply({a:t,params:e}){let r=t.data.sourceData,n=t.data.repr.geometryVersion,o=ei.ofBundle(e.layers,r);return new X.Molecule.Structure.Representation3DState({state:{substance:o},initialState:{substance:ei.Empty},info:{structure:r,geometryVersion:n},repr:t.data.repr},{label:`Substance (${o.layers.length} Layers)`})},update({a:t,b:e,newParams:r,oldParams:n}){let o=e.data.info,i=t.data.sourceData;if(i!==o.structure)return Se.UpdateResult.Recreate;if(t.data.repr!==e.data.repr)return Se.UpdateResult.Recreate;let a=t.data.repr.geometryVersion;if(a!==o.geometryVersion&&El(t.data.repr.props))return Se.UpdateResult.Recreate;let s=e.data.state.substance,l=ei.ofBundle(r.layers,i);return ei.areEqual(s,l)?Se.UpdateResult.Unchanged:(o.geometryVersion=a,e.data.state.substance=l,e.data.repr=t.data.repr,e.label=`Substance (${l.layers.length} Layers)`,Se.UpdateResult.Updated)}}),c0e=Je.BuiltIn({name:"clipping-structure-representation-3d-from-script",display:"Clipping 3D Representation",from:X.Molecule.Structure.Representation3D,to:X.Molecule.Structure.Representation3DState,params:()=>({layers:g.ObjectList({script:g.Script(Jr("(sel.atom.all)","mol-script")),groups:g.Converted(t=>Xr.Groups.toNames(t),t=>Xr.Groups.fromNames(t),g.MultiSelect(Tg(Xr.Groups.Names),g.objectToOptions(Xr.Groups.Names)))},t=>`${Xr.Groups.toNames(t.groups).length} group(s)`,{defaultValue:[{script:Jr("(sel.atom.all)","mol-script"),groups:Xr.Groups.Flag.None}]})})})({canAutoUpdate(){return!0},apply({a:t,params:e}){let r=t.data.sourceData,n=Xr.ofScript(e.layers,r);return new X.Molecule.Structure.Representation3DState({state:{clipping:n},initialState:{clipping:Xr.Empty},info:r,repr:t.data.repr},{label:`Clipping (${n.layers.length} Layers)`})},update({a:t,b:e,newParams:r,oldParams:n}){let o=e.data.info;if(t.data.sourceData!==o)return Se.UpdateResult.Recreate;if(t.data.repr!==e.data.repr)return Se.UpdateResult.Recreate;let i=e.data.state.clipping,a=Xr.ofScript(r.layers,o);return Xr.areEqual(i,a)?Se.UpdateResult.Unchanged:(e.data.state.clipping=a,e.data.repr=t.data.repr,e.label=`Clipping (${a.layers.length} Layers)`,Se.UpdateResult.Updated)}}),u0e=Je.BuiltIn({name:"clipping-structure-representation-3d-from-bundle",display:"Clipping 3D Representation",from:X.Molecule.Structure.Representation3D,to:X.Molecule.Structure.Representation3DState,params:()=>({layers:g.ObjectList({bundle:g.Value(z.Bundle.Empty),groups:g.Converted(t=>Xr.Groups.toNames(t),t=>Xr.Groups.fromNames(t),g.MultiSelect(Tg(Xr.Groups.Names),g.objectToOptions(Xr.Groups.Names)))},t=>`${Xr.Groups.toNames(t.groups).length} group(s)`,{defaultValue:[{bundle:z.Bundle.Empty,groups:Xr.Groups.Flag.None}],isHidden:!0})})})({canAutoUpdate(){return!0},apply({a:t,params:e}){let r=t.data.sourceData,n=Xr.ofBundle(e.layers,r);return new X.Molecule.Structure.Representation3DState({state:{clipping:n},initialState:{clipping:Xr.Empty},info:r,repr:t.data.repr},{label:`Clipping (${n.layers.length} Layers)`})},update({a:t,b:e,newParams:r,oldParams:n}){let o=e.data.info;if(t.data.sourceData!==o)return Se.UpdateResult.Recreate;if(t.data.repr!==e.data.repr)return Se.UpdateResult.Recreate;let i=e.data.state.clipping,a=Xr.ofBundle(r.layers,o);return Xr.areEqual(i,a)?Se.UpdateResult.Unchanged:(e.data.state.clipping=a,e.data.repr=t.data.repr,e.label=`Clipping (${a.layers.length} Layers)`,Se.UpdateResult.Updated)}}),d0e=Je.BuiltIn({name:"theme-strength-representation-3d",display:"Theme Strength 3D Representation",from:X.Molecule.Structure.Representation3D,to:X.Molecule.Structure.Representation3DState,params:()=>({overpaintStrength:g.Numeric(1,{min:0,max:1,step:.01}),transparencyStrength:g.Numeric(1,{min:0,max:1,step:.01}),emissiveStrength:g.Numeric(1,{min:0,max:1,step:.01}),substanceStrength:g.Numeric(1,{min:0,max:1,step:.01})})})({canAutoUpdate(){return!0},apply({a:t,params:e}){return new X.Molecule.Structure.Representation3DState({state:{themeStrength:{overpaint:e.overpaintStrength,transparency:e.transparencyStrength,emissive:e.emissiveStrength,substance:e.substanceStrength}},initialState:{themeStrength:{overpaint:1,transparency:1,emissive:1,substance:1}},info:{},repr:t.data.repr},{label:"Theme Strength",description:`${e.overpaintStrength.toFixed(2)}, ${e.transparencyStrength.toFixed(2)}, ${e.emissiveStrength.toFixed(2)}, ${e.substanceStrength.toFixed(2)}`})},update({a:t,b:e,newParams:r,oldParams:n}){var o,i,a,s;return r.overpaintStrength===((o=e.data.state.themeStrength)===null||o===void 0?void 0:o.overpaint)&&r.transparencyStrength===((i=e.data.state.themeStrength)===null||i===void 0?void 0:i.transparency)&&r.emissiveStrength===((a=e.data.state.themeStrength)===null||a===void 0?void 0:a.emissive)&&r.substanceStrength===((s=e.data.state.themeStrength)===null||s===void 0?void 0:s.substance)?Se.UpdateResult.Unchanged:(e.data.state.themeStrength={overpaint:r.overpaintStrength,transparency:r.transparencyStrength,emissive:r.emissiveStrength,substance:r.substanceStrength},e.data.repr=t.data.repr,e.label="Theme Strength",e.description=`${r.overpaintStrength.toFixed(2)}, ${r.transparencyStrength.toFixed(2)}, ${r.emissiveStrength.toFixed(2)}, ${r.substanceStrength.toFixed(2)}`,Se.UpdateResult.Updated)},interpolate(t,e,r){return{overpaintStrength:fn(t.overpaintStrength,e.overpaintStrength,r),transparencyStrength:fn(t.transparencyStrength,e.transparencyStrength,r),emissiveStrength:fn(t.emissiveStrength,e.emissiveStrength,r),substanceStrength:fn(t.substanceStrength,e.substanceStrength,r)}}}),hu;(function(t){function e(o,i,a,s,l,c,u,d){let m=o.representation.volume.registry.get(i),p=o.representation.volume.themes.colorThemeRegistry.get(l||m.defaultColorTheme.name),h=o.representation.volume.themes.sizeThemeRegistry.get(u||m.defaultSizeTheme.name),f=g.getDefaultValues(m.getParams(o.representation.volume.themes,a));return{type:{name:i,params:s?w(w({},f),s):f},colorTheme:{name:p.name,params:c?w(w({},p.defaultValues),c):p.defaultValues},sizeTheme:{name:h.name,params:d?w(w({},h.defaultValues),d):h.defaultValues}}}t.getDefaultParams=e;function r(o,i,a,s,l,c,u){let d=o.representation.volume.registry.get(i),m=o.representation.volume.themes.colorThemeRegistry.get(s||d.defaultColorTheme.name),p=o.representation.volume.themes.sizeThemeRegistry.get(c||d.defaultSizeTheme.name);return{type:{name:i,params:a?w(w({},d.defaultValues),a):d.defaultValues},colorTheme:{name:d.defaultColorTheme.name,params:l?w(w({},m.defaultValues),l):m.defaultValues},sizeTheme:{name:d.defaultSizeTheme.name,params:u?w(w({},p.defaultValues),u):p.defaultValues}}}t.getDefaultParamsStatic=r;function n(o){var i,a,s,l;if(o.isoValue)return xe.IsoValue.toString(o.isoValue);if(!((a=(i=o.renderMode)===null||i===void 0?void 0:i.params)===null||a===void 0)&&a.isoValue)return xe.IsoValue.toString((l=(s=o.renderMode)===null||s===void 0?void 0:s.params)===null||l===void 0?void 0:l.isoValue)}t.getDescription=n})(hu||(hu={}));var m0e=Je.BuiltIn({name:"volume-representation-3d",display:"3D Representation",from:X.Volume.Data,to:X.Volume.Representation3D,params:(t,e)=>{let{registry:r,themes:n}=e.representation.volume,o=r.get(r.default.name);if(!t)return{type:g.Mapped(r.default.name,r.types,a=>g.Group(r.get(a).getParams(n,xe.One))),colorTheme:g.Mapped(o.defaultColorTheme.name,n.colorThemeRegistry.types,a=>g.Group(n.colorThemeRegistry.get(a).getParams({volume:xe.One}))),sizeTheme:g.Mapped(o.defaultSizeTheme.name,n.sizeThemeRegistry.types,a=>g.Group(n.sizeThemeRegistry.get(a).getParams({volume:xe.One})))};let i={volume:t.data};return{type:g.Mapped(r.default.name,r.types,a=>g.Group(r.get(a).getParams(n,t.data))),colorTheme:g.Mapped(o.defaultColorTheme.name,n.colorThemeRegistry.getApplicableTypes(i),a=>g.Group(n.colorThemeRegistry.get(a).getParams(i))),sizeTheme:g.Mapped(o.defaultSizeTheme.name,n.sizeThemeRegistry.getApplicableTypes(i),a=>g.Group(n.sizeThemeRegistry.get(a).getParams(i)))}}})({canAutoUpdate({oldParams:t,newParams:e}){return t.type.name===e.type.name},apply({a:t,params:e},r){return ie.create("Volume Representation",n=>N(this,null,function*(){var o;let i={runtime:n,assetManager:r.managers.asset},a=r.representation.volume.registry.get(e.type.name);a.ensureCustomProperties&&(yield a.ensureCustomProperties.attach(i,t.data));let s=a.factory(w({webgl:(o=r.canvas3d)===null||o===void 0?void 0:o.webgl},r.representation.volume.themes),a.getParams);s.setTheme(An.create(r.representation.volume.themes,{volume:t.data},e));let l=e.type.params||{};return yield s.createOrUpdate(l,t.data).runInContext(n),new X.Volume.Representation3D({repr:s,sourceData:t.data},{label:a.label,description:hu.getDescription(l)})}))},update({a:t,b:e,oldParams:r,newParams:n},o){return ie.create("Volume Representation",i=>N(this,null,function*(){var a;if(n.type.name!==r.type.name)return(a=o.representation.volume.registry.get(r.type.name).ensureCustomProperties)===null||a===void 0||a.detach(t.data),Se.UpdateResult.Recreate;let s=w(w({},e.data.repr.props),n.type.params);return e.data.repr.setTheme(An.create(o.representation.volume.themes,{volume:t.data},n)),yield e.data.repr.createOrUpdate(s,t.data).runInContext(i),e.data.sourceData=t.data,e.description=hu.getDescription(s),Se.UpdateResult.Updated}))}});var p0e=Je.BuiltIn({name:"shape-representation-3d",display:"3D Representation",from:X.Shape.Provider,to:X.Shape.Representation3D,params:(t,e)=>t?t.data.params:ge.Params})({canAutoUpdate(){return!0},apply({a:t,params:e},r){return ie.create("Shape Representation",n=>N(this,null,function*(){let o=w(w({},g.getDefaultValues(t.data.params)),e),i=Yn(t.data.getShape,t.data.geometryUtils);return yield i.createOrUpdate(o,t.data.data).runInContext(n),new X.Shape.Representation3D({repr:i,sourceData:t.data},{label:t.data.label})}))},update({a:t,b:e,oldParams:r,newParams:n},o){return ie.create("Shape Representation",i=>N(this,null,function*(){let a=w(w({},e.data.repr.props),n);return yield e.data.repr.createOrUpdate(a,t.data.data).runInContext(i),e.data.sourceData=t.data,Se.UpdateResult.Updated}))}});var f0e=Je.BuiltIn({name:"model-unitcell-3d",display:"Model Unit Cell",from:X.Molecule.Model,to:X.Shape.Representation3D,params:()=>w({},g3)})({isApplicable:t=>!!rs.Provider.get(t.data),canAutoUpdate({oldParams:t,newParams:e}){return!0},apply({a:t,params:e},r){return ie.create("Model Unit Cell",n=>N(this,null,function*(){var o;let i=rs.Provider.get(t.data);if(!i)return Rr.Null;let a=y3(t.data,i,e),s=F7(w({webgl:(o=r.canvas3d)===null||o===void 0?void 0:o.webgl},r.representation.structure.themes),()=>g3);return yield s.createOrUpdate(e,a).runInContext(n),new X.Shape.Representation3D({repr:s,sourceData:a},{label:"Unit Cell",description:i.spacegroup.name})}))},update({a:t,b:e,newParams:r}){return ie.create("Model Unit Cell",n=>N(this,null,function*(){let o=rs.Provider.get(t.data);if(!o)return Se.UpdateResult.Null;let i=w(w({},e.data.repr.props),r),a=y3(t.data,o,i);return yield e.data.repr.createOrUpdate(i,a).runInContext(n),e.data.sourceData=a,Se.UpdateResult.Updated}))}});var h0e=Je.BuiltIn({name:"structure-bounding-box-3d",display:"Bounding Box",from:X.Molecule.Structure,to:X.Shape.Representation3D,params:w({radius:g.Numeric(.05,{min:.01,max:4,step:.01},{isEssential:!0}),color:g.Color(ut.red,{isEssential:!0})},Be.Params)})({canAutoUpdate(){return!0},apply({a:t,params:e},r){return ie.create("Bounding Box",n=>N(this,null,function*(){let o=Yn((i,a,s,l)=>{let c=Sw(a.box,a.radius,l?.geometry);return Yt.create("Bouding Box",a,c,()=>a.color,()=>1,()=>"Bounding Box")},Be.Utils);return yield o.createOrUpdate(e,{box:t.data.boundary.box,radius:e.radius,color:e.color}).runInContext(n),new X.Shape.Representation3D({repr:o,sourceData:t.data},{label:"Bounding Box"})}))},update({a:t,b:e,oldParams:r,newParams:n},o){return ie.create("Bounding Box",i=>N(this,null,function*(){return yield e.data.repr.createOrUpdate(n,{box:t.data.boundary.box,radius:n.radius,color:n.color}).runInContext(i),e.data.sourceData=t.data,Se.UpdateResult.Updated}))}});var g0e=Je.BuiltIn({name:"structure-selections-distance-3d",display:"3D Distance",from:X.Molecule.Structure.Selections,to:X.Shape.Representation3D,params:()=>w({},b3)})({canAutoUpdate({oldParams:t,newParams:e}){return!0},apply({a:t,params:e},r){return ie.create("Structure Distance",n=>N(this,null,function*(){var o;let i=x3(t.data),a=H7(w({webgl:(o=r.canvas3d)===null||o===void 0?void 0:o.webgl},r.representation.structure.themes),()=>b3);return yield a.createOrUpdate(e,i).runInContext(n),new X.Shape.Representation3D({repr:a,sourceData:i},{label:"Distance"})}))},update({a:t,b:e,oldParams:r,newParams:n},o){return ie.create("Structure Distance",i=>N(this,null,function*(){let a=w(w({},e.data.repr.props),n),s=x3(t.data);return yield e.data.repr.createOrUpdate(a,s).runInContext(i),e.data.sourceData=s,Se.UpdateResult.Updated}))}});var y0e=Je.BuiltIn({name:"structure-selections-angle-3d",display:"3D Angle",from:X.Molecule.Structure.Selections,to:X.Shape.Representation3D,params:()=>w({},A3)})({canAutoUpdate({oldParams:t,newParams:e}){return!0},apply({a:t,params:e},r){return ie.create("Structure Angle",n=>N(this,null,function*(){var o;let i=S3(t.data),a=nW(w({webgl:(o=r.canvas3d)===null||o===void 0?void 0:o.webgl},r.representation.structure.themes),()=>A3);return yield a.createOrUpdate(e,i).runInContext(n),new X.Shape.Representation3D({repr:a,sourceData:i},{label:"Angle"})}))},update({a:t,b:e,oldParams:r,newParams:n},o){return ie.create("Structure Angle",i=>N(this,null,function*(){let a=w(w({},e.data.repr.props),n),s=S3(t.data);return yield e.data.repr.createOrUpdate(a,s).runInContext(i),e.data.sourceData=s,Se.UpdateResult.Updated}))}});var v0e=Je.BuiltIn({name:"structure-selections-dihedral-3d",display:"3D Dihedral",from:X.Molecule.Structure.Selections,to:X.Shape.Representation3D,params:()=>w({},k3)})({canAutoUpdate({oldParams:t,newParams:e}){return!0},apply({a:t,params:e},r){return ie.create("Structure Dihedral",n=>N(this,null,function*(){var o;let i=C3(t.data),a=sW(w({webgl:(o=r.canvas3d)===null||o===void 0?void 0:o.webgl},r.representation.structure.themes),()=>k3);return yield a.createOrUpdate(e,i).runInContext(n),new X.Shape.Representation3D({repr:a,sourceData:i},{label:"Dihedral"})}))},update({a:t,b:e,oldParams:r,newParams:n},o){return ie.create("Structure Dihedral",i=>N(this,null,function*(){let a=w(w({},e.data.repr.props),n),s=C3(t.data);return yield e.data.repr.createOrUpdate(a,s).runInContext(i),e.data.sourceData=s,Se.UpdateResult.Updated}))}});var b0e=Je.BuiltIn({name:"structure-selections-label-3d",display:"3D Label",from:X.Molecule.Structure.Selections,to:X.Shape.Representation3D,params:()=>w({},P3)})({canAutoUpdate({oldParams:t,newParams:e}){return!0},apply({a:t,params:e},r){return ie.create("Structure Label",n=>N(this,null,function*(){var o,i,a;let s=T3(t.data),l=W7(w({webgl:(o=r.canvas3d)===null||o===void 0?void 0:o.webgl},r.representation.structure.themes),()=>P3);yield l.createOrUpdate(e,s).runInContext(n);let c=!!(!((i=e.snapshotKey)===null||i===void 0)&&i.trim()||!((a=e.tooltip)===null||a===void 0)&&a.trim());return l.setState({pickable:c,markerActions:c?kn.Highlighting:tt.None}),new X.Shape.Representation3D({repr:l,sourceData:s},{label:"Label"})}))},update({a:t,b:e,oldParams:r,newParams:n},o){return ie.create("Structure Label",i=>N(this,null,function*(){var a,s;let l=w(w({},e.data.repr.props),n),c=T3(t.data);yield e.data.repr.createOrUpdate(l,c).runInContext(i),e.data.sourceData=c;let u=!!(!((a=n.snapshotKey)===null||a===void 0)&&a.trim()||!((s=n.tooltip)===null||s===void 0)&&s.trim());return e.data.repr.setState({pickable:u,markerActions:u?kn.Highlighting:tt.None}),Se.UpdateResult.Updated}))}});var x0e=Je.BuiltIn({name:"structure-selections-orientation-3d",display:"3D Orientation",from:X.Molecule.Structure.Selections,to:X.Shape.Representation3D,params:()=>w({},D3)})({canAutoUpdate({oldParams:t,newParams:e}){return!0},apply({a:t,params:e},r){return ie.create("Structure Orientation",n=>N(this,null,function*(){var o;let i=w3(t.data),a=Z7(w({webgl:(o=r.canvas3d)===null||o===void 0?void 0:o.webgl},r.representation.structure.themes),()=>D3);return yield a.createOrUpdate(e,i).runInContext(n),new X.Shape.Representation3D({repr:a,sourceData:i},{label:"Orientation"})}))},update({a:t,b:e,oldParams:r,newParams:n},o){return ie.create("Structure Orientation",i=>N(this,null,function*(){let a=w(w({},e.data.repr.props),n),s=w3(t.data);return yield e.data.repr.createOrUpdate(a,s).runInContext(i),e.data.sourceData=s,Se.UpdateResult.Updated}))}});var S0e=Je.BuiltIn({name:"structure-selections-plane-3d",display:"3D Plane",from:X.Molecule.Structure.Selections,to:X.Shape.Representation3D,params:()=>w({},L3)})({canAutoUpdate({oldParams:t,newParams:e}){return!0},apply({a:t,params:e},r){return ie.create("Structure Plane",n=>N(this,null,function*(){var o;let i=_3(t.data),a=dW(w({webgl:(o=r.canvas3d)===null||o===void 0?void 0:o.webgl},r.representation.structure.themes),()=>L3);return yield a.createOrUpdate(e,i).runInContext(n),new X.Shape.Representation3D({repr:a,sourceData:i},{label:"Plane"})}))},update({a:t,b:e,oldParams:r,newParams:n},o){return ie.create("Structure Plane",i=>N(this,null,function*(){let a=w(w({},e.data.repr.props),n),s=_3(t.data);return yield e.data.repr.createOrUpdate(a,s).runInContext(i),e.data.sourceData=s,Se.UpdateResult.Updated}))}});function Kf(t,e,r){return{i:t,j:e,k:r}}function gu(t,e){return{a:t,b:e}}var Uo=[Kf(0,0,0),Kf(1,0,0),Kf(1,1,0),Kf(0,1,0),Kf(0,0,1),Kf(1,0,1),Kf(1,1,1),Kf(0,1,1)],mW=[gu(Uo[0],Uo[1]),gu(Uo[1],Uo[2]),gu(Uo[2],Uo[3]),gu(Uo[3],Uo[0]),gu(Uo[4],Uo[5]),gu(Uo[5],Uo[6]),gu(Uo[6],Uo[7]),gu(Uo[7],Uo[4]),gu(Uo[0],Uo[4]),gu(Uo[1],Uo[5]),gu(Uo[2],Uo[6]),gu(Uo[3],Uo[7])],pW=[{i:0,j:0,k:0,e:0},{i:1,j:0,k:0,e:1},{i:0,j:1,k:0,e:0},{i:0,j:0,k:0,e:1},{i:0,j:0,k:1,e:0},{i:1,j:0,k:1,e:1},{i:0,j:1,k:1,e:0},{i:0,j:0,k:1,e:1},{i:0,j:0,k:0,e:2},{i:1,j:0,k:0,e:2},{i:1,j:1,k:0,e:2},{i:0,j:1,k:0,e:2}],fW=[0,265,515,778,1030,1295,1541,1804,2060,2309,2575,2822,3082,3331,3593,3840,400,153,915,666,1430,1183,1941,1692,2460,2197,2975,2710,3482,3219,3993,3728,560,825,51,314,1590,1855,1077,1340,2620,2869,2111,2358,3642,3891,3129,3376,928,681,419,170,1958,1711,1445,1196,2988,2725,2479,2214,4010,3747,3497,3232,1120,1385,1635,1898,102,367,613,876,3180,3429,3695,3942,2154,2403,2665,2912,1520,1273,2035,1786,502,255,1013,764,3580,3317,4095,3830,2554,2291,3065,2800,1616,1881,1107,1370,598,863,85,348,3676,3925,3167,3414,2650,2899,2137,2384,1984,1737,1475,1226,966,719,453,204,4044,3781,3535,3270,3018,2755,2505,2240,2240,2505,2755,3018,3270,3535,3781,4044,204,453,719,966,1226,1475,1737,1984,2384,2137,2899,2650,3414,3167,3925,3676,348,85,863,598,1370,1107,1881,1616,2800,3065,2291,2554,3830,4095,3317,3580,764,1013,255,502,1786,2035,1273,1520,2912,2665,2403,2154,3942,3695,3429,3180,876,613,367,102,1898,1635,1385,1120,3232,3497,3747,4010,2214,2479,2725,2988,1196,1445,1711,1958,170,419,681,928,3376,3129,3891,3642,2358,2111,2869,2620,1340,1077,1855,1590,314,51,825,560,3728,3993,3219,3482,2710,2975,2197,2460,1692,1941,1183,1430,666,915,153,400,3840,3593,3331,3082,2822,2575,2309,2060,1804,1541,1295,1030,778,515,265,0],$f=[[],[0,8,3],[0,1,9],[1,8,3,9,8,1],[1,2,10],[0,8,3,1,2,10],[9,2,10,0,2,9],[2,8,3,2,10,8,10,9,8],[3,11,2],[0,11,2,8,11,0],[1,9,0,2,3,11],[1,11,2,1,9,11,9,8,11],[3,10,1,11,10,3],[0,10,1,0,8,10,8,11,10],[3,9,0,3,11,9,11,10,9],[9,8,10,10,8,11],[4,7,8],[4,3,0,7,3,4],[0,1,9,8,4,7],[4,1,9,4,7,1,7,3,1],[1,2,10,8,4,7],[3,4,7,3,0,4,1,2,10],[9,2,10,9,0,2,8,4,7],[2,10,9,2,9,7,2,7,3,7,9,4],[8,4,7,3,11,2],[11,4,7,11,2,4,2,0,4],[9,0,1,8,4,7,2,3,11],[4,7,11,9,4,11,9,11,2,9,2,1],[3,10,1,3,11,10,7,8,4],[1,11,10,1,4,11,1,0,4,7,11,4],[4,7,8,9,0,11,9,11,10,11,0,3],[4,7,11,4,11,9,9,11,10],[9,5,4],[9,5,4,0,8,3],[0,5,4,1,5,0],[8,5,4,8,3,5,3,1,5],[1,2,10,9,5,4],[3,0,8,1,2,10,4,9,5],[5,2,10,5,4,2,4,0,2],[2,10,5,3,2,5,3,5,4,3,4,8],[9,5,4,2,3,11],[0,11,2,0,8,11,4,9,5],[0,5,4,0,1,5,2,3,11],[2,1,5,2,5,8,2,8,11,4,8,5],[10,3,11,10,1,3,9,5,4],[4,9,5,0,8,1,8,10,1,8,11,10],[5,4,0,5,0,11,5,11,10,11,0,3],[5,4,8,5,8,10,10,8,11],[9,7,8,5,7,9],[9,3,0,9,5,3,5,7,3],[0,7,8,0,1,7,1,5,7],[1,5,3,3,5,7],[9,7,8,9,5,7,10,1,2],[10,1,2,9,5,0,5,3,0,5,7,3],[8,0,2,8,2,5,8,5,7,10,5,2],[2,10,5,2,5,3,3,5,7],[7,9,5,7,8,9,3,11,2],[9,5,7,9,7,2,9,2,0,2,7,11],[2,3,11,0,1,8,1,7,8,1,5,7],[11,2,1,11,1,7,7,1,5],[9,5,8,8,5,7,10,1,3,10,3,11],[5,7,0,5,0,9,7,11,0,1,0,10,11,10,0],[11,10,0,11,0,3,10,5,0,8,0,7,5,7,0],[11,10,5,7,11,5],[10,6,5],[0,8,3,5,10,6],[9,0,1,5,10,6],[1,8,3,1,9,8,5,10,6],[1,6,5,2,6,1],[1,6,5,1,2,6,3,0,8],[9,6,5,9,0,6,0,2,6],[5,9,8,5,8,2,5,2,6,3,2,8],[2,3,11,10,6,5],[11,0,8,11,2,0,10,6,5],[0,1,9,2,3,11,5,10,6],[5,10,6,1,9,2,9,11,2,9,8,11],[6,3,11,6,5,3,5,1,3],[0,8,11,0,11,5,0,5,1,5,11,6],[3,11,6,0,3,6,0,6,5,0,5,9],[6,5,9,6,9,11,11,9,8],[5,10,6,4,7,8],[4,3,0,4,7,3,6,5,10],[1,9,0,5,10,6,8,4,7],[10,6,5,1,9,7,1,7,3,7,9,4],[6,1,2,6,5,1,4,7,8],[1,2,5,5,2,6,3,0,4,3,4,7],[8,4,7,9,0,5,0,6,5,0,2,6],[7,3,9,7,9,4,3,2,9,5,9,6,2,6,9],[3,11,2,7,8,4,10,6,5],[5,10,6,4,7,2,4,2,0,2,7,11],[0,1,9,4,7,8,2,3,11,5,10,6],[9,2,1,9,11,2,9,4,11,7,11,4,5,10,6],[8,4,7,3,11,5,3,5,1,5,11,6],[5,1,11,5,11,6,1,0,11,7,11,4,0,4,11],[0,5,9,0,6,5,0,3,6,11,6,3,8,4,7],[6,5,9,6,9,11,4,7,9,7,11,9],[10,4,9,6,4,10],[4,10,6,4,9,10,0,8,3],[10,0,1,10,6,0,6,4,0],[8,3,1,8,1,6,8,6,4,6,1,10],[1,4,9,1,2,4,2,6,4],[3,0,8,1,2,9,2,4,9,2,6,4],[0,2,4,4,2,6],[8,3,2,8,2,4,4,2,6],[10,4,9,10,6,4,11,2,3],[0,8,2,2,8,11,4,9,10,4,10,6],[3,11,2,0,1,6,0,6,4,6,1,10],[6,4,1,6,1,10,4,8,1,2,1,11,8,11,1],[9,6,4,9,3,6,9,1,3,11,6,3],[8,11,1,8,1,0,11,6,1,9,1,4,6,4,1],[3,11,6,3,6,0,0,6,4],[6,4,8,11,6,8],[7,10,6,7,8,10,8,9,10],[0,7,3,0,10,7,0,9,10,6,7,10],[10,6,7,1,10,7,1,7,8,1,8,0],[10,6,7,10,7,1,1,7,3],[1,2,6,1,6,8,1,8,9,8,6,7],[2,6,9,2,9,1,6,7,9,0,9,3,7,3,9],[7,8,0,7,0,6,6,0,2],[7,3,2,6,7,2],[2,3,11,10,6,8,10,8,9,8,6,7],[2,0,7,2,7,11,0,9,7,6,7,10,9,10,7],[1,8,0,1,7,8,1,10,7,6,7,10,2,3,11],[11,2,1,11,1,7,10,6,1,6,7,1],[8,9,6,8,6,7,9,1,6,11,6,3,1,3,6],[0,9,1,11,6,7],[7,8,0,7,0,6,3,11,0,11,6,0],[7,11,6],[7,6,11],[3,0,8,11,7,6],[0,1,9,11,7,6],[8,1,9,8,3,1,11,7,6],[10,1,2,6,11,7],[1,2,10,3,0,8,6,11,7],[2,9,0,2,10,9,6,11,7],[6,11,7,2,10,3,10,8,3,10,9,8],[7,2,3,6,2,7],[7,0,8,7,6,0,6,2,0],[2,7,6,2,3,7,0,1,9],[1,6,2,1,8,6,1,9,8,8,7,6],[10,7,6,10,1,7,1,3,7],[10,7,6,1,7,10,1,8,7,1,0,8],[0,3,7,0,7,10,0,10,9,6,10,7],[7,6,10,7,10,8,8,10,9],[6,8,4,11,8,6],[3,6,11,3,0,6,0,4,6],[8,6,11,8,4,6,9,0,1],[9,4,6,9,6,3,9,3,1,11,3,6],[6,8,4,6,11,8,2,10,1],[1,2,10,3,0,11,0,6,11,0,4,6],[4,11,8,4,6,11,0,2,9,2,10,9],[10,9,3,10,3,2,9,4,3,11,3,6,4,6,3],[8,2,3,8,4,2,4,6,2],[0,4,2,4,6,2],[1,9,0,2,3,4,2,4,6,4,3,8],[1,9,4,1,4,2,2,4,6],[8,1,3,8,6,1,8,4,6,6,10,1],[10,1,0,10,0,6,6,0,4],[4,6,3,4,3,8,6,10,3,0,3,9,10,9,3],[10,9,4,6,10,4],[4,9,5,7,6,11],[0,8,3,4,9,5,11,7,6],[5,0,1,5,4,0,7,6,11],[11,7,6,8,3,4,3,5,4,3,1,5],[9,5,4,10,1,2,7,6,11],[6,11,7,1,2,10,0,8,3,4,9,5],[7,6,11,5,4,10,4,2,10,4,0,2],[3,4,8,3,5,4,3,2,5,10,5,2,11,7,6],[7,2,3,7,6,2,5,4,9],[9,5,4,0,8,6,0,6,2,6,8,7],[3,6,2,3,7,6,1,5,0,5,4,0],[6,2,8,6,8,7,2,1,8,4,8,5,1,5,8],[9,5,4,10,1,6,1,7,6,1,3,7],[1,6,10,1,7,6,1,0,7,8,7,0,9,5,4],[4,0,10,4,10,5,0,3,10,6,10,7,3,7,10],[7,6,10,7,10,8,5,4,10,4,8,10],[6,9,5,6,11,9,11,8,9],[3,6,11,0,6,3,0,5,6,0,9,5],[0,11,8,0,5,11,0,1,5,5,6,11],[6,11,3,6,3,5,5,3,1],[1,2,10,9,5,11,9,11,8,11,5,6],[0,11,3,0,6,11,0,9,6,5,6,9,1,2,10],[11,8,5,11,5,6,8,0,5,10,5,2,0,2,5],[6,11,3,6,3,5,2,10,3,10,5,3],[5,8,9,5,2,8,5,6,2,3,8,2],[9,5,6,9,6,0,0,6,2],[1,5,8,1,8,0,5,6,8,3,8,2,6,2,8],[1,5,6,2,1,6],[1,3,6,1,6,10,3,8,6,5,6,9,8,9,6],[10,1,0,10,0,6,9,5,0,5,6,0],[0,3,8,5,6,10],[10,5,6],[11,5,10,7,5,11],[11,5,10,11,7,5,8,3,0],[5,11,7,5,10,11,1,9,0],[10,7,5,10,11,7,9,8,1,8,3,1],[11,1,2,11,7,1,7,5,1],[0,8,3,1,2,7,1,7,5,7,2,11],[9,7,5,9,2,7,9,0,2,2,11,7],[7,5,2,7,2,11,5,9,2,3,2,8,9,8,2],[2,5,10,2,3,5,3,7,5],[8,2,0,8,5,2,8,7,5,10,2,5],[9,0,1,5,10,3,5,3,7,3,10,2],[9,8,2,9,2,1,8,7,2,10,2,5,7,5,2],[1,3,5,3,7,5],[0,8,7,0,7,1,1,7,5],[9,0,3,9,3,5,5,3,7],[9,8,7,5,9,7],[5,8,4,5,10,8,10,11,8],[5,0,4,5,11,0,5,10,11,11,3,0],[0,1,9,8,4,10,8,10,11,10,4,5],[10,11,4,10,4,5,11,3,4,9,4,1,3,1,4],[2,5,1,2,8,5,2,11,8,4,5,8],[0,4,11,0,11,3,4,5,11,2,11,1,5,1,11],[0,2,5,0,5,9,2,11,5,4,5,8,11,8,5],[9,4,5,2,11,3],[2,5,10,3,5,2,3,4,5,3,8,4],[5,10,2,5,2,4,4,2,0],[3,10,2,3,5,10,3,8,5,4,5,8,0,1,9],[5,10,2,5,2,4,1,9,2,9,4,2],[8,4,5,8,5,3,3,5,1],[0,4,5,1,0,5],[8,4,5,8,5,3,9,0,5,0,3,5],[9,4,5],[4,11,7,4,9,11,9,10,11],[0,8,3,4,9,7,9,11,7,9,10,11],[1,10,11,1,11,4,1,4,0,7,4,11],[3,1,4,3,4,8,1,10,4,7,4,11,10,11,4],[4,11,7,9,11,4,9,2,11,9,1,2],[9,7,4,9,11,7,9,1,11,2,11,1,0,8,3],[11,7,4,11,4,2,2,4,0],[11,7,4,11,4,2,8,3,4,3,2,4],[2,9,10,2,7,9,2,3,7,7,4,9],[9,10,7,9,7,4,10,2,7,8,7,0,2,0,7],[3,7,10,3,10,2,7,4,10,1,10,0,4,0,10],[1,10,2,8,7,4],[4,9,1,4,1,7,7,1,3],[4,9,1,4,1,7,0,8,1,8,7,1],[4,0,3,7,4,3],[4,8,7],[9,10,8,10,11,8],[3,0,9,3,9,11,11,9,10],[0,1,10,0,10,8,8,10,11],[3,1,10,11,3,10],[1,2,11,1,11,9,9,11,8],[3,0,9,3,9,11,1,2,9,2,11,9],[0,2,11,8,0,11],[3,2,11],[2,3,8,2,8,10,10,8,9],[9,10,2,0,9,2],[2,3,8,2,8,10,0,1,8,1,10,8],[1,10,2],[1,3,8,9,1,8],[0,9,1],[0,3,8],[]],Cw=[[0,4,4,4,2,0,0,0,2,2,0,0],[4,0,4,4,0,8,0,0,0,8,8,0],[4,4,0,4,0,0,8,0,0,0,8,8],[4,4,4,0,0,0,0,1,1,0,0,1],[2,0,0,0,0,8,8,8,2,2,0,0],[0,8,0,0,8,0,8,8,0,8,8,0],[0,0,8,0,8,8,0,8,0,0,8,8],[0,0,0,1,8,8,8,0,1,0,0,1],[2,0,0,1,2,0,0,1,0,2,0,1],[2,8,0,0,2,8,0,0,2,0,8,0],[0,8,8,0,0,8,8,0,0,8,0,8],[0,0,8,1,0,0,8,1,1,0,8,0]];function hW(t,e){let r=Math.min(65536,t*4),n=he.create(Float32Array,3,t,e&&e.vertexBuffer.ref.value),o=he.create(Float32Array,3,t,e&&e.normalBuffer.ref.value),i=he.create(Float32Array,1,t,e&&e.groupBuffer.ref.value),a=he.create(Uint32Array,3,r,e&&e.indexBuffer.ref.value),s=0,l=0;return{addVertex:(c,u,d)=>(++s,he.add3(n,c,u,d)),addNormal:(c,u,d)=>{he.add3(o,c,u,d)},addGroup:c=>{he.add(i,c)},addTriangle:(c,u,d,m)=>{let p=c[u],h=c[d],f=c[m];p>=0&&h>=0&&f>=0&&(++l,he.add3(a,p,h,f))},get:()=>{let c=he.compact(n,!0),u=he.compact(o,!0),d=he.compact(a,!0),m=he.compact(i,!0);return Be.create(c,d,u,m,s,l,e)}}}function gW(t,e){let r=he.create(Float32Array,3,t),n=he.create(Float32Array,1,t),o=he.create(Float32Array,2,t),i=0;return{addVertex:(a,s,l)=>he.add3(r,a,s,l),addNormal:()=>hs,addGroup:a=>{he.add(n,a)},addTriangle:(a,s,l,c,u)=>{let d=a[s],m=a[l],p=a[c];d>=0&&m>=0&&p>=0&&(Cw[s][l]&u&&(++i,he.add2(o,a[s],a[l])),Cw[l][c]&u&&(++i,he.add2(o,a[l],a[c])),Cw[s][c]&u&&(++i,he.add2(o,a[s],a[c])))},get:()=>{let a=he.compact(r,!0),s=he.compact(o,!0),l=he.compact(n,!0),c=vi.create(i,i/10,e);for(let u=0;u<i;++u){let d=s[u*2],m=s[u*2+1];c.add(a[d*3],a[d*3+1],a[d*3+2],a[m*3],a[m*3+1],a[m*3+2],l[d])}return c.getLines()}}}function yW(t){return U(w({},t),{bottomLeft:li(t.bottomLeft,[0,0,0]),topRight:li(t.topRight,t.scalarField.space.dimensions)})}function vW(t){return{dX:t.topRight[0]-t.bottomLeft[0],dY:t.topRight[1]-t.bottomLeft[1],dZ:t.topRight[2]-t.bottomLeft[2]}}function ym(t,e){return ie.create("Marching Cubes Mesh",r=>N(this,null,function*(){let n=yW(t),{dX:o,dY:i,dZ:a}=vW(n),s=Math.min(262144,Math.max(o*i*a/32,1024)),l=hW(s,e);return yield new Tw(r,l,n).run(),l.get()}))}function wv(t,e){return ie.create("Marching Cubes Lines",r=>N(this,null,function*(){let n=yW(t),{dX:o,dY:i,dZ:a}=vW(n),s=Math.min(262144,Math.max(o*i*a/32,1024)),l=gW(s,e);return yield new Tw(r,l,n).run(),l.get()}))}var Tw=class{doSlices(){return N(this,null,function*(){let e=0;this.edgeFilter=15;for(let r=this.minZ;r<this.maxZ;r++,this.edgeFilter&=-5)this.slice(r),e+=this.sliceSize,this.ctx.shouldUpdate&&(yield this.ctx.update({message:"Computing surface...",current:e,max:this.size}))})}slice(e){this.edgeFilter|=2;for(let r=this.minY;r<this.maxY;r++,this.edgeFilter&=-3){this.edgeFilter|=1;for(let n=this.minX;n<this.maxX;n++,this.edgeFilter&=-2)this.state.processCell(n,r,e,this.edgeFilter)}this.state.clearEdgeVertexIndexSlice(e)}run(){return N(this,null,function*(){yield this.doSlices()})}constructor(e,r,n){this.ctx=e,this.minX=0,this.minY=0,this.minZ=0,this.maxX=0,this.maxY=0,this.maxZ=0,this.state=new O3(r,n),this.minX=n.bottomLeft[0],this.minY=n.bottomLeft[1],this.minZ=n.bottomLeft[2],this.maxX=n.topRight[0]-1,this.maxY=n.topRight[1]-1,this.maxZ=n.topRight[2]-1,this.size=(this.maxX-this.minX)*(this.maxY-this.minY)*(this.maxZ-this.minZ),this.sliceSize=(this.maxX-this.minX)*(this.maxY-this.minY)}},O3=class{get3dOffsetFromEdgeInfo(e){return this.nX*((this.k+e.k)%2*this.nY+this.j+e.j)+this.i+e.i}clearEdgeVertexIndexSlice(e){let r=e%2===0?0:3*this.nX*this.nY,n=e%2===0?3*this.nX*this.nY:this.verticesOnEdges.length;this.verticesOnEdges.fill(0,r,n)}interpolate(e){let r=pW[e],n=3*this.get3dOffsetFromEdgeInfo(r)+r.e,o=this.verticesOnEdges[n];if(o>0)return o-1;let i=this.scalarField,a=this.scalarFieldGet,s=mW[e],l=s.a,c=s.b,u=l.i+this.i,d=l.j+this.j,m=l.k+this.k,p=c.i+this.i,h=c.j+this.j,f=c.k+this.k,b=a(i,u,d,m),v=a(i,p,h,f),x=(this.isoLevel-b)/(b-v);if(this.idField){let R=this.idFieldGet(this.idField,u,d,m),B=this.idFieldGet(this.idField,p,h,f),F=x<.5?R:B;if(F===-1&&(F=x<.5?B:R),F===-2)return-1;this.builder.addGroup(F)}else this.builder.addGroup(0);let S=this.builder.addVertex(u+x*(u-p),d+x*(d-h),m+x*(m-f));this.verticesOnEdges[n]=S+1;let T=a(i,Math.max(0,u-1),d,m)-a(i,Math.min(this.nX-1,u+1),d,m),E=a(i,u,Math.max(0,d-1),m)-a(i,u,Math.min(this.nY-1,d+1),m),_=a(i,u,d,Math.max(0,m-1))-a(i,u,d,Math.min(this.nZ,m+1)),D=a(i,Math.max(0,p-1),h,f)-a(i,Math.min(this.nX-1,p+1),h,f),P=a(i,p,Math.max(0,h-1),f)-a(i,p,Math.min(this.nY-1,h+1),f),A=a(i,p,h,Math.max(0,f-1))-a(i,p,h,Math.min(this.nZ-1,f+1)),I=T+x*(T-D),k=E+x*(E-P),M=_+x*(_-A);return this.isoLevel>=0?this.builder.addNormal(I,k,M):this.builder.addNormal(-I,-k,-M),S}constructor(e,r){this.builder=e,this.vertList=[0,0,0,0,0,0,0,0,0,0,0,0],this.i=0,this.j=0,this.k=0;let n=r.scalarField.space.dimensions;this.nX=n[0],this.nY=n[1],this.nZ=n[2],this.isoLevel=r.isoLevel,this.scalarFieldGet=r.scalarField.space.get,this.scalarField=r.scalarField.data,r.idField&&(this.idField=r.idField.data,this.idFieldGet=r.idField.space.get),this.verticesOnEdges=new Int32Array(3*this.nX*this.nY*2)}get(e,r,n){return this.scalarFieldGet(this.scalarField,e,r,n)}processCell(e,r,n,o){let i=0;if(this.get(e,r,n)<this.isoLevel&&(i|=1),this.get(e+1,r,n)<this.isoLevel&&(i|=2),this.get(e+1,r+1,n)<this.isoLevel&&(i|=4),this.get(e,r+1,n)<this.isoLevel&&(i|=8),this.get(e,r,n+1)<this.isoLevel&&(i|=16),this.get(e+1,r,n+1)<this.isoLevel&&(i|=32),this.get(e+1,r+1,n+1)<this.isoLevel&&(i|=64),this.get(e,r+1,n+1)<this.isoLevel&&(i|=128),i===0||i===255)return;this.i=e,this.j=r,this.k=n;let a=fW[i];(a&1)>0&&(this.vertList[0]=this.interpolate(0)),(a&2)>0&&(this.vertList[1]=this.interpolate(1)),(a&4)>0&&(this.vertList[2]=this.interpolate(2)),(a&8)>0&&(this.vertList[3]=this.interpolate(3)),(a&16)>0&&(this.vertList[4]=this.interpolate(4)),(a&32)>0&&(this.vertList[5]=this.interpolate(5)),(a&64)>0&&(this.vertList[6]=this.interpolate(6)),(a&128)>0&&(this.vertList[7]=this.interpolate(7)),(a&256)>0&&(this.vertList[8]=this.interpolate(8)),(a&512)>0&&(this.vertList[9]=this.interpolate(9)),(a&1024)>0&&(this.vertList[10]=this.interpolate(10)),(a&2048)>0&&(this.vertList[11]=this.interpolate(11));let s=$f[i];for(let l=0;l<s.length;l+=3){let c=s[l],u=s[l+1],d=s[l+2];this.isoLevel>=0?this.builder.addTriangle(this.vertList,c,u,d,o):this.builder.addTriangle(this.vertList,d,u,c,o)}}};function C0e(t,e,r,n,o,i){let{createValues:a,createRenderableState:s}=eo.getUtils(e),l=I0(),c=a(e,l,r,n,o),u=s(o);return tu(e.kind,c,u,i)}function _d(t,e){let{defaultProps:r,createGeometry:n,createLocationIterator:o,getLoci:i,eachLocation:a,setUpdateState:s,mustRecreate:l,dispose:c}=t,{updateValues:u,updateBoundingSphere:d,updateRenderableState:m,createPositionIterator:p}=t.geometryUtils,h=Bl.create(),f,b,v,x,S,T=Object.assign({},r),E=An.createEmpty(),_,D,P,A=-1,I,k;function M(V,H,Q,L){if(!Q&&!_)throw new Error("missing volume");if(b=Object.assign({},T,H),v=V,x=Q,S=L,Bl.reset(h),f?(!xe.areEquivalent(x,_)||S!==D)&&(h.createNew=!0):h.createNew=!0,h.createNew){h.createGeometry=!0;return}s(h,Q,b,T,v,E),wo.areEqual(V.color,E.color)||(h.updateColor=!0),h.createGeometry&&(h.updateColor=!0),b.instanceGranularity!==T.instanceGranularity&&(h.updateTransform=!0)}function R(V){if(h.createNew)if(I=o(x,S),V)f=C0e(x,V,I,v,b,e),k=p(V,f.values);else throw new Error("expected geometry to be given");else{if(!f)throw new Error("expected renderObject to be available");if(h.updateTransform){I=o(x,S);let{instanceCount:H,groupCount:Q}=I;b.instanceGranularity?jr(H,"instance",f.values):jr(H*Q,"groupInstance",f.values)}else I.reset();if(h.createGeometry)if(V)C.updateIfChanged(f.values.drawCount,eo.getDrawCount(V)),C.updateIfChanged(f.values.uVertexCount,eo.getVertexCount(V)),C.updateIfChanged(f.values.uGroupCount,eo.getGroupCount(V));else throw new Error("expected geometry to be given");(h.updateTransform||h.createGeometry)&&(d(f.values,V||P),k=p(V||P,f.values)),h.updateSize&&"uSize"in f.values&&Sa(I,v.size,f.values),h.updateColor&&uo(I,k,v.color,f.values),u(f.values,b),m(f.state,b)}T=b,E=v,_=x,D=S,V&&(P=V,A+=1)}function B(V,H,Q,L){let Y=!1;if(xe.Cell.isLoci(V)){if(xe.Cell.isLociEmpty(V)||!xe.areEquivalent(V.volume,H))return!1;L(Oe.ofSingleton(0))&&(Y=!0)}else if(xe.Segment.isLoci(V)){if(xe.Segment.isLociEmpty(V)||!xe.areEquivalent(V.volume,H)||!tr.has(V.segments,Q))return!1;L(Oe.ofSingleton(0))&&(Y=!0)}return Y}function F(V,H){return So(V)?T.instanceGranularity?H(Oe.ofBounds(0,I.instanceCount)):H(Oe.ofBounds(0,I.groupCount*I.instanceCount)):T.instanceGranularity?B(V,_,D,H):a(V,_,D,T,H)}return{get groupCount(){return I?I.count:0},get renderObject(){return f},get geometryVersion(){return A},createOrUpdate(Y,j){return N(this,arguments,function*(V,H,Q={},L){if(M(H,Q,L?.volume||_,L?.key||D),h.createGeometry){let O=n(V,x,S,v,b,P);return af(O)?O.then(R):R(O)}else R()})},getLoci(V){return f?i(V,_,D,T,f.id):St},eachLocation(V){for(I.reset();I.hasNext;){let{location:H,isSecondary:Q}=I.move();V(H,Q)}},mark(V,H){return Vt.mark(f,V,H,F)},setVisibility(V){Vt.setVisibility(f,V)},setAlphaFactor(V){Vt.setAlphaFactor(f,V)},setPickable(V){Vt.setPickable(f,V)},setColorOnly(V){Vt.setColorOnly(f,V)},setTransform(V,H){Vt.setTransform(f,V,H)},setOverpaint(V){return Vt.setOverpaint(f,V,F,!0)},setTransparency(V){return Vt.setTransparency(f,V,F,!0)},setEmissive(V){return Vt.setEmissive(f,V,F,!0)},setSubstance(V){return Vt.setSubstance(f,V,F,!0)},setClipping(V){return Vt.setClipping(f,V,F,!0)},setThemeStrength(V){Vt.setThemeStrength(f,V)},destroy(){c?.(P),f&&(f.state.disposed=!0,f=void 0)},mustRecreate:l}}var blt=w({},ge.Params);function Sp(t,e,r,n,o,i=()=>[-1]){let a=0,{webgl:s}=e,l=new ln,c=new rt.GeometryState,u=rl(),d=[],m=rt.createState(),p=new Map,h,f,b,v,x=An.createEmpty();function S(I,k){return N(this,null,function*(){var M;let R=p.get(k);return R?!((M=R.mustRecreate)===null||M===void 0)&&M.call(R,{volume:h,key:k},v,s)&&(R.destroy(),R=n(u,h,k,v,s),p.set(k,R)):(R=n(u,h,k,v,s),p.set(k,R)),R.createOrUpdate({webgl:s,runtime:I},x,v,{volume:h,key:k})})}function T(I={},k){k&&k!==h&&(b=r(e,k),h=k,v||(v=g.getDefaultValues(b)));let M=k1(Object.assign({},v,I),h);return Object.assign(v,I,M),f=i(v),ie.create("Creating or updating VolumeRepresentation",R=>N(this,null,function*(){let B=new Set(p.keys());for(let F=0,G=f.length;F<G;++F){let V=f[F];B.delete(V);let H=S(R,V);H&&(yield H)}B.forEach(F=>{var G;(G=p.get(F))===null||G===void 0||G.destroy(),p.delete(F)}),d.length=0,p.forEach(F=>{F.renderObject&&(d.push(F.renderObject),c.add(F.renderObject.id,F.geometryVersion))}),c.snapshot(),l.next(a++)}))}function E(I,k){let M=!1;return p.forEach(R=>{M=R.mark(I,k)||M}),M}function _(I,k){k.visible!==void 0&&I&&I.setVisibility(k.visible),k.alphaFactor!==void 0&&I&&I.setAlphaFactor(k.alphaFactor),k.pickable!==void 0&&I&&I.setPickable(k.pickable),k.overpaint!==void 0&&I&&I.setOverpaint(k.overpaint),k.transparency!==void 0&&I&&I.setTransparency(k.transparency),k.emissive!==void 0&&I&&I.setEmissive(k.emissive),k.substance!==void 0&&I&&I.setSubstance(k.substance),k.clipping!==void 0&&I&&I.setClipping(k.clipping),k.transform!==void 0&&I&&I.setTransform(k.transform),k.themeStrength!==void 0&&I&&I.setThemeStrength(k.themeStrength)}function D(I){let{visible:k,alphaFactor:M,pickable:R,overpaint:B,transparency:F,emissive:G,substance:V,clipping:H,transform:Q,themeStrength:L,syncManually:Y,markerActions:j}=I,O={};k!==void 0&&(O.visible=k),M!==void 0&&(O.alphaFactor=M),R!==void 0&&(O.pickable=R),B!==void 0&&(O.overpaint=B),F!==void 0&&(O.transparency=F),G!==void 0&&(O.emissive=G),V!==void 0&&(O.substance=V),H!==void 0&&(O.clipping=H),L!==void 0&&(O.themeStrength=L),Q!==void 0&&!W.areEqual(Q,m.transform,1e-6)&&(O.transform=Q),Y!==void 0&&(O.syncManually=Y),j!==void 0&&(O.markerActions=j),p.forEach(J=>_(J,O)),rt.updateState(m,I)}function P(I){x=I}function A(){p.forEach(I=>I.destroy()),p.clear()}return{label:t,get groupCount(){let I=0;return p.forEach(k=>{k.renderObject&&(I+=k.groupCount)}),I},get props(){return v},get params(){return b},get state(){return m},get theme(){return x},get geometryVersion(){return c.version},renderObjects:d,updated:l,createOrUpdate:T,setState:D,setTheme:P,getLoci:I=>{let k=St;return p.forEach(M=>{let R=M.getLoci(I);Wn(R)||(k=R)}),k},getAllLoci:()=>[o(h,v)],eachLocation:I=>{p.forEach(k=>{k.eachLocation(I)})},mark:E,destroy:A}}var bW=`
precision highp float;
precision highp int;

#if __VERSION__ == 100
    precision highp sampler2D;
    uniform sampler2D tTexture;
#else
    precision highp isampler2D;
    uniform isampler2D tTexture;
#endif

void main(void) {
    #if __VERSION__ == 100
        gl_FragColor = texture2D(tTexture, vec2(0.5));
    #else
        gl_FragColor = ivec4(texture2D(tTexture, vec2(0.5)).r);
    #endif
}
`;var T0e=U(w({},Er),{tTexture:We("texture","rgba","float","nearest")}),yu="histopyramid-sum";function w0e(t,e){if(t.namedComputeRenderables[yu]){let r=t.namedComputeRenderables[yu].values;C.update(r.tTexture,e),t.namedComputeRenderables[yu].update()}else t.namedComputeRenderables[yu]=_0e(t,e);return t.namedComputeRenderables[yu]}function _0e(t,e){let r=U(w({},Ir),{tTexture:C.create(e)}),n=w({},T0e),o=Qt("sum",zr,bW,{},{0:"ivec4"}),i=dr(t,"triangles",o,n,r);return mr(i,r)}function P0e(t){let{gl:e,state:r}=t;r.disable(e.CULL_FACE),r.disable(e.BLEND),r.disable(e.DEPTH_TEST),r.disable(e.SCISSOR_TEST),r.depthMask(!1),r.colorMask(!0,!0,!0,!0),r.clearColor(0,0,0,0)}var ww=new Uint8Array(4),xW=new Int32Array(4);function SW(t,e){Ee&&t.timer.mark("getHistopyramidSum");let{gl:r,state:n,resources:o}=t,i=w0e(t,e);t.state.currentRenderItemId=-1,t.namedFramebuffers[yu]||(t.namedFramebuffers[yu]=o.framebuffer());let a=t.namedFramebuffers[yu];return t.namedTextures[yu]||(t.namedTextures[yu]=ct(r)?o.texture("image-int32","rgba","int","nearest"):o.texture("image-uint8","rgba","ubyte","nearest"),t.namedTextures[yu].define(1,1)),t.namedTextures[yu].attachFramebuffer(a,0),P0e(t),n.viewport(0,0,1,1),i.render(),r.finish(),t.readPixels(0,0,1,1,ct(r)?xW:ww),t.unbindFramebuffer(),Ee&&t.timer.markEnd("getHistopyramidSum"),ct(r)?xW[0]:Ig(ww[0],ww[1],ww[2])}var CW=`
precision highp float;
precision highp int;
precision highp sampler2D;

uniform sampler2D tInputLevel;

// previous level used to evaluate the new level
#if __VERSION__ == 100
    uniform sampler2D tPreviousLevel;
#else
    precision highp isampler2D;
    uniform isampler2D tPreviousLevel;
#endif

// inverted size of the previous level texture.
uniform float uSize;
uniform float uTexSize;
uniform bool uFirst;

#include common

void main(void) {
    float k = 0.5 * uSize;
    vec2 position = floor((gl_FragCoord.xy / uTexSize) / uSize) * uSize;

    #if __VERSION__ == 100
        float a, b, c, d;

        if (uFirst) {
            a = texture2D(tInputLevel, position).r * 255.0;
            b = texture2D(tInputLevel, position + vec2(k, 0.0)).r * 255.0;
            c = texture2D(tInputLevel, position + vec2(0.0, k)).r * 255.0;
            d = texture2D(tInputLevel, position + vec2(k, k)).r * 255.0;
        } else {
            a = unpackRGBToInt(texture2D(tPreviousLevel, position).rgb);
            b = unpackRGBToInt(texture2D(tPreviousLevel, position + vec2(k, 0.0)).rgb);
            c = unpackRGBToInt(texture2D(tPreviousLevel, position + vec2(0.0, k)).rgb);
            d = unpackRGBToInt(texture2D(tPreviousLevel, position + vec2(k, k)).rgb);
        }
        gl_FragColor = vec4(packIntToRGB(a + b + c + d), 1.0);
    #else
        int a, b, c, d;

        if (uFirst) {
            a = int(texture2D(tInputLevel, position).r * 255.0);
            b = int(texture2D(tInputLevel, position + vec2(k, 0.0)).r * 255.0);
            c = int(texture2D(tInputLevel, position + vec2(0.0, k)).r * 255.0);
            d = int(texture2D(tInputLevel, position + vec2(k, k)).r * 255.0);
        } else {
            a = texture2D(tPreviousLevel, position).r;
            b = texture2D(tPreviousLevel, position + vec2(k, 0.0)).r;
            c = texture2D(tPreviousLevel, position + vec2(0.0, k)).r;
            d = texture2D(tPreviousLevel, position + vec2(k, k)).r;
        }
        gl_FragColor = ivec4(a + b + c + d);
    #endif
}
`;var E0e=U(w({},Er),{tInputLevel:We("texture","rgba","float","nearest"),tPreviousLevel:We("texture","rgba","float","nearest"),uSize:ee("f"),uTexSize:ee("f"),uFirst:ee("b")}),Zf="histogram-pyramid";function I0e(t,e,r){if(t.namedComputeRenderables[Zf]){let n=t.namedComputeRenderables[Zf].values;C.update(n.tInputLevel,e),C.update(n.tPreviousLevel,r),t.namedComputeRenderables[Zf].update()}else t.namedComputeRenderables[Zf]=D0e(t,e,r);return t.namedComputeRenderables[Zf]}function D0e(t,e,r){let n=U(w({},Ir),{tInputLevel:C.create(e),tPreviousLevel:C.create(r),uSize:C.create(0),uTexSize:C.create(0),uFirst:C.create(!0)}),o=w({},E0e),i=Qt("reduction",zr,CW,{},{0:"ivec4"}),a=dr(t,"triangles",i,o,n);return mr(a,n)}function A0e(t,e){let r=Math.pow(2,e),n=`level${e}`,o=t.isWebGL2?_w(n,t,"image-int32","alpha","int","nearest"):_w(n,t,"image-uint8","rgba","ubyte","nearest");o.define(r,r);let i=M0e(n,t);return i||(i=TW(n,t),o.attachFramebuffer(i,0)),{texture:o,framebuffer:i}}function k0e(t){let{gl:e,state:r}=t;r.disable(e.CULL_FACE),r.disable(e.BLEND),r.disable(e.DEPTH_TEST),r.enable(e.SCISSOR_TEST),r.depthMask(!1),r.colorMask(!0,!0,!0,!0),r.clearColor(0,0,0,0)}function TW(t,e){let r=`${Zf}-${t}`;return e.namedFramebuffers[r]||(e.namedFramebuffers[r]=e.resources.framebuffer()),e.namedFramebuffers[r]}function _w(t,e,r,n,o,i){let a=`${Zf}-${t}`;return e.namedTextures[a]||(e.namedTextures[a]=e.resources.texture(r,n,o,i)),e.namedTextures[a]}function M0e(t,e){let r=`${Zf}-${t}`;return e.namedFramebuffers[r]}function wW(t,e,r,n){Ee&&t.timer.mark("createHistogramPyramid");let{gl:o,state:i}=t,a=e.getWidth(),s=e.getHeight();if(a!==s||!nf(a))throw new Error("inputTexture must be of square power-of-two size");let l=Math.ceil(Math.log(a)/Math.log(2)),c=Math.pow(2,l),u=Math.pow(2,l),d=Math.pow(2,l-1),m=t.isWebGL2?_w("pyramid",t,"image-int32","alpha","int","nearest"):_w("pyramid",t,"image-uint8","rgba","ubyte","nearest");m.define(u,d);let p=TW("pyramid",t);m.attachFramebuffer(p,0),i.viewport(0,0,u,d),ct(o)?o.clearBufferiv(o.COLOR,0,[0,0,0,0]):o.clear(o.COLOR_BUFFER_BIT);let h=[];for(let S=0;S<l;++S)h.push(A0e(t,S));let f=I0e(t,e,h[0].texture);i.currentRenderItemId=-1,k0e(t);let b=0;for(let S=0;S<l;S++){let T=l-1-S;h[T].framebuffer.bind();let _=Math.pow(2,T);C.update(f.values.uSize,Math.pow(2,S+1)/c),C.update(f.values.uTexSize,_),C.updateIfChanged(f.values.uFirst,S===0),S>0&&(C.update(f.values.tPreviousLevel,h[l-S].texture),f.update()),i.currentRenderItemId=-1,i.viewport(0,0,_,_),i.scissor(0,0,_,_),ct(o)?o.clearBufferiv(o.COLOR,0,[0,0,0,0]):o.clear(o.COLOR_BUFFER_BIT),i.scissor(0,0,n[0],n[1]),f.render(),m.bind(0),o.copyTexSubImage2D(o.TEXTURE_2D,0,b,0,0,0,_,_),m.unbind(0),b+=_}o.finish(),Ee&&t.timer.markEnd("createHistogramPyramid");let v=Math.max(1,SW(t,h[0].texture)),x=Math.ceil(v/Math.pow(2,l));return{pyramidTex:m,count:v,height:x,levels:l,scale:r}}var U1;function _W(){if(U1!==void 0)return U1;U1=Zr(16*16,1,Uint8Array);let{array:t}=U1;for(let e=0,r=$f.length;e<r;++e)t[e]=$f[e].length/3;return U1}var G1;function PW(){if(G1!==void 0)return G1;G1=Zr(64*64,1,Uint8Array);let{array:t}=G1;for(let e=0,r=$f.length;e<r;++e)for(let n=0;n<16;++n)n<$f[e].length?t[e*16+n]=$f[e][n]:t[e*16+n]=255;return G1}var EW=`
precision highp float;
precision highp int;
precision highp sampler2D;

#if __VERSION__ == 100
    uniform sampler2D tActiveVoxelsPyramid;
#else
    precision highp isampler2D;
    uniform isampler2D tActiveVoxelsPyramid;
#endif

uniform sampler2D tActiveVoxelsBase;
uniform sampler2D tVolumeData;
uniform sampler2D tTriIndices;

uniform float uIsoValue;
uniform float uLevels;
uniform float uSize;
uniform float uCount;
uniform bool uInvert;

uniform vec3 uGridDim;
uniform vec3 uGridTexDim;
uniform mat4 uGridTransform;

// scale to volume data coord
uniform vec2 uScale;

#include common

// cube corners (excluding origin)
const vec3 c1 = vec3(1., 0., 0.);
const vec3 c2 = vec3(1., 1., 0.);
const vec3 c3 = vec3(0., 1., 0.);
const vec3 c4 = vec3(0., 0., 1.);
const vec3 c5 = vec3(1., 0., 1.);
const vec3 c6 = vec3(1., 1., 1.);
const vec3 c7 = vec3(0., 1., 1.);

vec3 index3dFrom2d(vec2 coord) {
    vec2 gridTexPos = coord * uGridTexDim.xy;
    vec2 columnRow = ivec2Div(gridTexPos, uGridDim.xy);
    vec2 posXY = gridTexPos - columnRow * uGridDim.xy;
    float posZ = columnRow.y * intDiv(uGridTexDim.x, uGridDim.x) + columnRow.x;
    return vec3(posXY, posZ);
}

vec4 texture3dFrom2dNearest(sampler2D tex, vec3 pos, vec3 gridDim, vec2 texDim) {
    float zSlice = floor(pos.z * gridDim.z + 0.5); // round to nearest z-slice
    float column = intDiv(intMod(zSlice * gridDim.x, texDim.x), gridDim.x);
    float row = intDiv(zSlice * gridDim.x, texDim.x);
    vec2 coord = (vec2(column * gridDim.x, row * gridDim.y) + (pos.xy * gridDim.xy)) / (texDim / uScale);
    return texture2D(tex, coord + 0.5 / (texDim / uScale));
}

vec4 voxel(vec3 pos) {
    pos = min(max(vec3(0.0), pos), uGridDim - vec3(1.0));
    return texture3dFrom2dNearest(tVolumeData, pos / uGridDim, uGridDim, uGridTexDim.xy);
}

vec4 voxelPadded(vec3 pos) {
    pos = min(max(vec3(0.0), pos), uGridDim - vec3(vec2(2.0), 1.0)); // remove xy padding
    return texture3dFrom2dNearest(tVolumeData, pos / uGridDim, uGridDim, uGridTexDim.xy);
}

int idot2(const in ivec2 a, const in ivec2 b) {
    return a.x * b.x + a.y * b.y;
}

int idot4(const in ivec4 a, const in ivec4 b) {
    return a.x * b.x + a.y * b.y + a.z * b.z + a.w * b.w;
}

#if __VERSION__ == 100
    int pyramidVoxel(vec2 pos) {
        return int(unpackRGBToInt(texture2D(tActiveVoxelsPyramid, pos / (vec2(1.0, 0.5) * uSize)).rgb));
    }
#else
    int pyramidVoxel(vec2 pos) {
        return texture2D(tActiveVoxelsPyramid, pos / (vec2(1.0, 0.5) * uSize)).r;
    }
#endif

vec4 baseVoxel(vec2 pos) {
    return texture2D(tActiveVoxelsBase, pos / uSize);
}

vec4 getGroup(const in vec3 p) {
    vec3 gridDim = uGridDim - vec3(1.0, 1.0, 0.0); // remove xy padding
    // note that we swap x and z because the texture is flipped around y
    #if defined(dAxisOrder_012)
        float group = p.z + p.y * gridDim.z + p.x * gridDim.z * gridDim.y; // 210
    #elif defined(dAxisOrder_021)
        float group = p.y + p.z * gridDim.y + p.x * gridDim.y * gridDim.z; // 120
    #elif defined(dAxisOrder_102)
        float group = p.z + p.x * gridDim.z + p.y * gridDim.z * gridDim.x; // 201
    #elif defined(dAxisOrder_120)
        float group = p.x + p.z * gridDim.x + p.y * gridDim.x * gridDim.z; // 021
    #elif defined(dAxisOrder_201)
        float group = p.y + p.x * gridDim.y + p.z * gridDim.y * gridDim.x; // 102
    #elif defined(dAxisOrder_210)
        float group = p.x + p.y * gridDim.x + p.z * gridDim.x * gridDim.y; // 012
    #endif
    return vec4(group > 16777215.5 ? vec3(1.0) : packIntToRGB(group), 1.0);
}

void main(void) {
    // get 1D index
    int vI = int(gl_FragCoord.x) + int(gl_FragCoord.y) * int(uSize);

    // ignore 1D indices outside of the grid
    if(vI >= int(uCount)) discard;

    ivec2 offset = ivec2(int(uSize) - 2, 0);

    int start = 0;
    ivec4 starts = ivec4(0);
    ivec4 ends = ivec4(0);
    int diff = 2;
    ivec4 m = ivec4(0);
    ivec2 position = ivec2(0);
    ivec4 vI4 = ivec4(vI);

    ivec2 relativePosition = ivec2(0);
    int end = 0;
    ivec2 pos1 = ivec2(0);
    ivec2 pos2 = ivec2(0);
    ivec2 pos3 = ivec2(0);
    ivec2 pos4 = ivec2(0);
    ivec3 vI3 = ivec3(vI);
    ivec3 mask = ivec3(0);

    // traverse the different levels of the pyramid
    for(int i = 1; i < 14; i++) {
        if(float(i) >= uLevels) break;

        offset.x -= diff;
        diff *= 2;
        relativePosition = position + offset;

        end = start + pyramidVoxel(vec2(relativePosition));
        pos1 = ivec2(relativePosition);
        starts.x = start;
        ends.x = end;
        pos2 = ivec2(relativePosition + ivec2(1, 0));
        starts.y = ends.x;
        ends.y = ends.x + pyramidVoxel(vec2(pos2));
        pos3 = relativePosition + ivec2(0, 1);
        starts.z = ends.y;
        ends.z = ends.y + pyramidVoxel(vec2(pos3));
        pos4 = relativePosition + ivec2(1, 1);
        starts.w = ends.z;
        mask = ivec3(greaterThanEqual(vI3, starts.rgb)) * ivec3(lessThan(vI3, ends.rgb));
        m = ivec4(mask, 1 - int(any(bvec3(mask))));

        relativePosition = m.x * pos1 + m.y * pos2 + m.z * pos3 + m.w * pos4;
        start = idot4(m, starts);
        position = 2 * (relativePosition - offset);
    }

    end = start + int(baseVoxel(vec2(position)).r * 255.0);
    pos1 = position;
    starts.x = start;
    ends.x = end;
    pos2 = position + ivec2(1, 0);
    starts.y = ends.x;
    ends.y = ends.x + int(baseVoxel(vec2(pos2)).r * 255.0);
    pos3 = position + ivec2(0, 1);
    starts.z = ends.y;
    ends.z = ends.y + int(baseVoxel(vec2(pos3)).r * 255.0);
    pos4 = position + ivec2(1, 1);
    starts.w = ends.z;
    mask = ivec3(greaterThanEqual(vI3, starts.rgb)) * ivec3(lessThan(vI3, ends.rgb));
    m = ivec4(mask, 1 - int(any(bvec3(mask))));
    position = m.x * pos1 + m.y * pos2 + m.z * pos3 + m.w * pos4;

    vec2 coord2d = (vec2(position) / uSize) / uScale;
    vec3 coord3d = floor(index3dFrom2d(coord2d) + 0.5);

    float edgeIndex = floor(baseVoxel(vec2(position)).a * 255.0 + 0.5);

    // current vertex for the up to 15 MC cases
    int currentVertex = vI - idot4(m, starts);

    // ensure winding-order is the same for negative and positive iso-levels
    if (uInvert) {
        int v = imod(currentVertex + 1, 3);
        if (v == 1) currentVertex += 2;
        else if (v == 0) currentVertex -= 2;
    }

    // get index into triIndices table
    int mcIndex = 16 * int(edgeIndex) + currentVertex;
    vec4 mcData = texture2D(tTriIndices, vec2(imod(mcIndex, 64), mcIndex / 64) / 64.);

    // bit mask to avoid conditionals (see comment below) for getting MC case corner
    vec4 m0 = vec4(floor(mcData.a * 255.0 + 0.5));

    // get edge value masks
    vec4 m1 = vec4(equal(m0, vec4(0., 1., 2., 3.)));
    vec4 m2 = vec4(equal(m0, vec4(4., 5., 6., 7.)));
    vec4 m3 = vec4(equal(m0, vec4(8., 9., 10., 11.)));

    // apply bit masks
    vec3 b0 = coord3d +
                m1.y * c1 +
                m1.z * c2 +
                m1.w * c3 +
                m2.x * c4 +
                m2.y * c5 +
                m2.z * c6 +
                m2.w * c7 +
                m3.y * c1 +
                m3.z * c2 +
                m3.w * c3;
    vec3 b1 = coord3d +
                m1.x * c1 +
                m1.y * c2 +
                m1.z * c3 +
                m2.x * c5 +
                m2.y * c6 +
                m2.z * c7 +
                m2.w * c4 +
                m3.x * c4 +
                m3.y * c5 +
                m3.z * c6 +
                m3.w * c7;

    // the conditionals that are avoided by above bitmasks
    // vec3 b0 = coord3d;
    // vec3 b1 = coord3d;
    // if (mcIndex == 0.0) {
    //     b1 += c1;
    // } else if (mcIndex == 1.0) {
    //     b0 += c1; b1 += c2;
    // } else if (mcIndex == 2.0) {
    //     b0 += c2; b1 += c3;
    // } else if (mcIndex == 3.0) {
    //     b0 += c3;
    // } else if (mcIndex == 4.0) {
    //     b0 += c4; b1 += c5;
    // } else if (mcIndex == 5.0) {
    //     b0 += c5; b1 += c6;
    // } else if (mcIndex == 6.0) {
    //     b0 += c6; b1 += c7;
    // } else if (mcIndex == 7.0) {
    //     b0 += c7; b1 += c4;
    // } else if (mcIndex == 8.0) {
    //     b1 += c4;
    // } else if (mcIndex == 9.0) {
    //     b0 += c1; b1 += c5;
    // } else if (mcIndex == 10.0) {
    //     b0 += c2; b1 += c6;
    // } else if (mcIndex == 11.0) {
    //     b0 += c3; b1 += c7;
    // }
    // b0 = floor(b0 + 0.5);
    // b1 = floor(b1 + 0.5);

    vec4 d0 = voxel(b0);
    vec4 d1 = voxel(b1);

    float v0 = d0.a;
    float v1 = d1.a;

    float t = (uIsoValue - v0) / (v0 - v1);
    gl_FragData[0].xyz = (uGridTransform * vec4(b0 + t * (b0 - b1), 1.0)).xyz;

    // group id
    #if __VERSION__ == 100 || defined(dConstantGroup)
        // webgl1 does not support 'flat' interpolation (i.e. no interpolation)
        // ensure a constant group id per triangle as needed
        #ifdef dPackedGroup
            gl_FragData[1] = vec4(voxel(coord3d).rgb, 1.0);
        #else
            gl_FragData[1] = getGroup(coord3d);
        #endif
    #else
        #ifdef dPackedGroup
            gl_FragData[1] = vec4(t < 0.5 ? d0.rgb : d1.rgb, 1.0);
        #else
            gl_FragData[1] = getGroup(t < 0.5 ? b0 : b1);
        #endif
    #endif

    // normals from gradients
    vec3 n0 = -normalize(vec3(
        voxelPadded(b0 - c1).a - voxelPadded(b0 + c1).a,
        voxelPadded(b0 - c3).a - voxelPadded(b0 + c3).a,
        voxelPadded(b0 - c4).a - voxelPadded(b0 + c4).a
    ));
    vec3 n1 = -normalize(vec3(
        voxelPadded(b1 - c1).a - voxelPadded(b1 + c1).a,
        voxelPadded(b1 - c3).a - voxelPadded(b1 + c3).a,
        voxelPadded(b1 - c4).a - voxelPadded(b1 + c4).a
    ));
    gl_FragData[2].xyz = -vec3(
        n0.x + t * (n0.x - n1.x),
        n0.y + t * (n0.y - n1.y),
        n0.z + t * (n0.z - n1.z)
    );

    // ensure normal-direction is the same for negative and positive iso-levels
    if (uInvert) {
        gl_FragData[2].xyz *= -1.0;
    }

    // apply normal matrix
    gl_FragData[2].xyz *= transpose3(inverse3(mat3(uGridTransform)));
}
`;var IW=`
precision highp float;
precision highp int;
precision highp sampler2D;

uniform sampler2D tTriCount;
uniform sampler2D tVolumeData;

uniform float uIsoValue;
uniform vec3 uGridDim;
uniform vec3 uGridTexDim;
uniform vec2 uScale;

#include common

// cube corners (excluding origin)
const vec3 c1 = vec3(1., 0., 0.);
const vec3 c2 = vec3(1., 1., 0.);
const vec3 c3 = vec3(0., 1., 0.);
const vec3 c4 = vec3(0., 0., 1.);
const vec3 c5 = vec3(1., 0., 1.);
const vec3 c6 = vec3(1., 1., 1.);
const vec3 c7 = vec3(0., 1., 1.);

vec3 index3dFrom2d(vec2 coord) {
    vec2 gridTexPos = coord * uGridTexDim.xy;
    vec2 columnRow = ivec2Div(gridTexPos, uGridDim.xy);
    vec2 posXY = gridTexPos - columnRow * uGridDim.xy;
    float posZ = columnRow.y * intDiv(uGridTexDim.x, uGridDim.x) + columnRow.x;
    return vec3(posXY, posZ);
}

vec4 texture3dFrom2dNearest(sampler2D tex, vec3 pos, vec3 gridDim, vec2 texDim) {
    float zSlice = floor(pos.z * gridDim.z + 0.5); // round to nearest z-slice
    float column = intDiv(intMod(zSlice * gridDim.x, texDim.x), gridDim.x);
    float row = intDiv(zSlice * gridDim.x, texDim.x);
    vec2 coord = (vec2(column * gridDim.x, row * gridDim.y) + (pos.xy * gridDim.xy)) / (texDim / uScale);
    return texture2D(tex, coord);
}

vec4 voxel(vec3 pos) {
    pos = min(max(vec3(0.0), pos), uGridDim - vec3(1.0));
    return texture3dFrom2dNearest(tVolumeData, pos / uGridDim, uGridDim, uGridTexDim.xy);
}

void main(void) {
    vec2 uv = gl_FragCoord.xy / uGridTexDim.xy;
    vec3 posXYZ = index3dFrom2d(uv);

    // get MC case as the sum of corners that are below the given iso level
    float c = step(voxel(posXYZ).a, uIsoValue)
        + 2. * step(voxel(posXYZ + c1).a, uIsoValue)
        + 4. * step(voxel(posXYZ + c2).a, uIsoValue)
        + 8. * step(voxel(posXYZ + c3).a, uIsoValue)
        + 16. * step(voxel(posXYZ + c4).a, uIsoValue)
        + 32. * step(voxel(posXYZ + c5).a, uIsoValue)
        + 64. * step(voxel(posXYZ + c6).a, uIsoValue)
        + 128. * step(voxel(posXYZ + c7).a, uIsoValue);
    c *= step(c, 254.);

    // handle out of bounds positions
    posXYZ += 1.0;
    posXYZ.xy += 1.0; // pixel padding (usually ok even if the texture has no padding)
    if (posXYZ.x >= uGridDim.x || posXYZ.y >= uGridDim.y || posXYZ.z >= uGridDim.z)
        c = 0.0;

    // get total triangles to generate for calculated MC case from triCount texture
    float totalTrianglesToGenerate = texture2D(tTriCount, vec2(intMod(c, 16.), floor(c / 16.)) / 16.).a;
    gl_FragColor = vec4(vec3(totalTrianglesToGenerate * 3.0), c / 255.0);
}
`;var R0e=U(w({},Er),{tTriCount:We("image-uint8","alpha","ubyte","nearest"),tVolumeData:We("texture","rgba","ubyte","nearest"),uIsoValue:ee("f"),uGridDim:ee("v3"),uGridTexDim:ee("v3"),uScale:ee("v2")}),Pd="active-voxels";function L0e(t,e,r,n,o,i){if(t.namedComputeRenderables[Pd]){let a=t.namedComputeRenderables[Pd].values;C.update(a.uQuadScale,i),C.update(a.tVolumeData,e),C.updateIfChanged(a.uIsoValue,o),C.update(a.uGridDim,r),C.update(a.uGridTexDim,n),C.update(a.uScale,i),t.namedComputeRenderables[Pd].update()}else t.namedComputeRenderables[Pd]=B0e(t,e,r,n,o,i);return t.namedComputeRenderables[Pd]}function B0e(t,e,r,n,o,i){let a=U(w({},Ir),{tTriCount:C.create(_W()),uQuadScale:C.create(i),tVolumeData:C.create(e),uIsoValue:C.create(o),uGridDim:C.create(r),uGridTexDim:C.create(n),uScale:C.create(i)}),s=w({},R0e),l=Qt("active-voxels",zr,IW),c=dr(t,"triangles",l,s,a);return mr(c,a)}function O0e(t){let{gl:e,state:r}=t;r.disable(e.CULL_FACE),r.disable(e.BLEND),r.disable(e.DEPTH_TEST),r.enable(e.SCISSOR_TEST),r.depthMask(!1),r.colorMask(!0,!0,!0,!0),r.clearColor(0,0,0,0)}function DW(t,e,r,n,o,i){Ee&&t.timer.mark("calcActiveVoxels");let{gl:a,state:s,resources:l}=t,c=e.getWidth(),u=e.getHeight();t.namedFramebuffers[Pd]||(t.namedFramebuffers[Pd]=l.framebuffer());let d=t.namedFramebuffers[Pd];d.bind(),t.namedTextures[Pd]||(t.namedTextures[Pd]=l.texture("image-uint8","rgba","ubyte","nearest"));let m=t.namedTextures[Pd];m.define(c,u);let p=L0e(t,e,r,n,o,i);return t.state.currentRenderItemId=-1,m.attachFramebuffer(d,0),O0e(t),s.viewport(0,0,c,u),s.scissor(0,0,c,u),a.clear(a.COLOR_BUFFER_BIT),s.scissor(0,0,n[0],n[1]),p.render(),a.finish(),Ee&&t.timer.markEnd("calcActiveVoxels"),m}var F0e=U(w({},Er),{tTriIndices:We("image-uint8","alpha","ubyte","nearest"),tActiveVoxelsPyramid:We("texture","rgba","float","nearest"),tActiveVoxelsBase:We("texture","rgba","float","nearest"),tVolumeData:We("texture","rgba","ubyte","nearest"),uIsoValue:ee("f"),uSize:ee("f"),uLevels:ee("f"),uCount:ee("f"),uInvert:ee("b"),uGridDim:ee("v3"),uGridTexDim:ee("v3"),uGridTransform:ee("m4"),uScale:ee("v2"),dPackedGroup:Ye("boolean"),dAxisOrder:Ye("string",["012","021","102","120","201","210"]),dConstantGroup:Ye("boolean")}),Jf="isosurface";function N0e(t,e,r,n,o,i,a,s,l,c,u,d,m,p,h){if(t.namedComputeRenderables[Jf]){let f=t.namedComputeRenderables[Jf].values;C.update(f.tActiveVoxelsPyramid,e),C.update(f.tActiveVoxelsBase,r),C.update(f.tVolumeData,n),C.updateIfChanged(f.uIsoValue,s),C.updateIfChanged(f.uSize,Math.pow(2,l)),C.updateIfChanged(f.uLevels,l),C.updateIfChanged(f.uCount,u),C.updateIfChanged(f.uInvert,d),C.update(f.uGridDim,o),C.update(f.uGridTexDim,i),C.update(f.uGridTransform,a),C.update(f.uScale,c),C.updateIfChanged(f.dPackedGroup,m),C.updateIfChanged(f.dAxisOrder,p.join("")),C.updateIfChanged(f.dConstantGroup,h),t.namedComputeRenderables[Jf].update()}else t.namedComputeRenderables[Jf]=V0e(t,e,r,n,o,i,a,s,l,c,u,d,m,p,h);return t.namedComputeRenderables[Jf]}function V0e(t,e,r,n,o,i,a,s,l,c,u,d,m,p,h){let f=U(w({},Ir),{tTriIndices:C.create(PW()),tActiveVoxelsPyramid:C.create(e),tActiveVoxelsBase:C.create(r),tVolumeData:C.create(n),uIsoValue:C.create(s),uSize:C.create(Math.pow(2,l)),uLevels:C.create(l),uCount:C.create(u),uInvert:C.create(d),uGridDim:C.create(o),uGridTexDim:C.create(i),uGridTransform:C.create(a),uScale:C.create(c),dPackedGroup:C.create(m),dAxisOrder:C.create(p.join("")),dConstantGroup:C.create(h)}),b=w({},F0e),v=Qt("isosurface",zr,EW,{drawBuffers:"required"}),x=dr(t,"triangles",v,b,f);return mr(x,f)}function z0e(t){let{gl:e,state:r}=t;r.disable(e.CULL_FACE),r.disable(e.BLEND),r.disable(e.DEPTH_TEST),r.disable(e.SCISSOR_TEST),r.depthMask(!1),r.colorMask(!0,!0,!0,!0),r.clearColor(0,0,0,0)}function U0e(t,e,r,n,o,i,a,s,l,c,u,d,m,p,h){let{drawBuffers:f}=t.extensions;if(!f)throw new Error("need WebGL draw buffers");Ee&&t.timer.mark("createIsosurfaceBuffers");let{gl:b,state:v,resources:x,extensions:S}=t,{pyramidTex:T,height:E,levels:_,scale:D,count:P}=n,A=T.getWidth();t.namedFramebuffers[Jf]||(t.namedFramebuffers[Jf]=x.framebuffer());let I=t.namedFramebuffers[Jf];ct(b)?(m||(m=x.texture("image-float32","rgba","float","nearest")),p||(p=x.texture("image-uint8","rgba","ubyte","nearest")),h||(h=S.colorBufferHalfFloat&&S.textureHalfFloat?x.texture("image-float16","rgba","fp16","nearest"):x.texture("image-float32","rgba","float","nearest"))):(m||(m=x.texture("image-float32","rgba","float","nearest")),p||(p=x.texture("image-float32","rgba","float","nearest")),h||(h=x.texture("image-float32","rgba","float","nearest"))),m.define(A,E),p.define(A,E),h.define(A,E),m.attachFramebuffer(I,0),p.attachFramebuffer(I,1),h.attachFramebuffer(I,2);let k=N0e(t,T,e,r,o,i,a,s,_,D,P,l,c,u,d);return t.state.currentRenderItemId=-1,I.bind(),f.drawBuffers([f.COLOR_ATTACHMENT0,f.COLOR_ATTACHMENT1,f.COLOR_ATTACHMENT2]),z0e(t),v.viewport(0,0,A,E),b.clear(b.COLOR_BUFFER_BIT),k.render(),b.finish(),Ee&&t.timer.markEnd("createIsosurfaceBuffers"),{vertexTexture:m,groupTexture:p,normalTexture:h,vertexCount:P}}function ey(t,e,r,n,o,i,a,s,l,c,u,d,m,p){Ee&&t.timer.mark("extractIsosurface");let h=DW(t,e,r,n,a,o),f=wW(t,h,o,n),b=U0e(t,h,e,f,r,n,i,a,s,l,c,u,d,m,p);return Ee&&t.timer.markEnd("extractIsosurface"),b}var kW={isoValue:xe.IsoValueParam};function G0e(t){return t.extensions.colorBufferFloat&&t.extensions.textureFloat&&t.extensions.drawBuffers}var j1=1;function V3(t,e){if(t.grid.cells.data.length<Math.pow(10,3))return!1;let r=t.grid.cells.space.dimensions,{powerOfTwoSize:n}=uu(r,j1);return n<=e.maxTextureSize/2}function j0e(t,e,r,n,o){return n.tryUseGpu&&o&&G0e(o)&&V3(e,o)?X0e(t):q0e(t)}function AW(t,e){return xe.Isosurface.Loci(t,e.isoValue)}function z3(t,e,r,n,o){let{objectId:i,groupId:a}=t;if(o===i){let s=xe.PickingGranularity.get(e);return s==="volume"?xe.Loci(e):s==="object"?xe.Isosurface.Loci(e,n.isoValue):xe.Cell.Loci(e,Oe.ofSingleton(a))}return St}function U3(t,e,r,n,o){return jf(t,e,{isoValue:n.isoValue},o)}function H0e(t,e,r,n,o,i){return N(this,null,function*(){t.runtime.update({message:"Marching cubes..."});let a=Ri(new Int32Array(e.grid.cells.data.length)),s=yield ym({isoLevel:xe.IsoValue.toAbsolute(o.isoValue,e.grid.stats).absoluteValue,scalarField:e.grid.cells,idField:er.create(e.grid.cells.space,er.Data1(a))},i).runAsChild(t.runtime),l=Sn.getGridToCartesianTransform(e.grid);return Be.transform(s,l),t.webgl&&!t.webgl.isWebGL2?(Be.uniformTriangleGroup(s,!1),C.updateIfChanged(s.varyingGroup,!1)):C.updateIfChanged(s.varyingGroup,!0),s.setBoundingSphere(xe.Isosurface.getBoundingSphere(e,o.isoValue)),s})}var G3=U(w(w(w({},Be.Params),Ko.Params),kW),{quality:U(w({},Be.Params.quality),{isEssential:!1}),tryUseGpu:g.Boolean(!0)});function q0e(t){return _d({defaultProps:g.getDefaultValues(G3),createGeometry:H0e,createLocationIterator:e=>jt(e.grid.cells.data.length,1,1,()=>Lo),getLoci:z3,eachLocation:U3,setUpdateState:(e,r,n,o)=>{xe.IsoValue.areSame(n.isoValue,o.isoValue,r.grid.stats)||(e.createGeometry=!0)},geometryUtils:Be.Utils,mustRecreate:(e,r,n)=>r.tryUseGpu&&!!n&&V3(e.volume,n)},t)}var F3;(function(t){let e="volume-isosurface-texture";t.descriptor=Xc({name:e});function r(n,o){let{resources:i}=o,a=Sn.getGridToCartesianTransform(n.grid),s=y.clone(n.grid.cells.space.dimensions),{width:l,height:c,powerOfTwoSize:u}=uu(s,j1),d=y.create(l,c,0),m=ne.create(l/u,c/u);if(u>o.maxTextureSize/2)throw new Error("volume too large for gpu isosurface extraction");if(!n._propertyData[e]){n._propertyData[e]=i.texture("image-uint8","alpha","ubyte","linear");let p=n._propertyData[e];p.define(u,u),p.load(sw(n,"data",j1),!0),n.customProperties.add(t.descriptor),n.customProperties.assets(t.descriptor,[{dispose:()=>p.destroy()}])}return s[0]+=j1,s[1]+=j1,{texture:n._propertyData[e],transform:a,gridDimension:s,gridTexDim:d,gridTexScale:m}}t.get=r})(F3||(F3={}));function W0e(t,e,r,n,o,i){return N(this,null,function*(){if(!t.webgl)throw new Error("webgl context required to create volume isosurface texture-mesh");if(e.grid.cells.data.length<=1)return Ko.createEmpty(i);let{max:a,min:s}=e.grid.stats,l=a-s,c=xe.IsoValue.toAbsolute(o.isoValue,e.grid.stats).absoluteValue,u=(c-s)/l,{texture:d,gridDimension:m,gridTexDim:p,gridTexScale:h,transform:f}=F3.get(e,t.webgl),b=e.grid.cells.space.axisOrderSlowToFast,v=i?.doubleBuffer.get(),x=ey(t.webgl,d,m,p,h,f,u,c<0,!1,b,!0,v?.vertex,v?.group,v?.normal),S=e.grid.cells.data.length,T=xe.getBoundingSphere(e),E=Ko.create(x.vertexCount,S,x.vertexTexture,x.groupTexture,x.normalTexture,T,i);return E.meta.webgl=t.webgl,E})}function X0e(t){return _d({defaultProps:g.getDefaultValues(G3),createGeometry:W0e,createLocationIterator:e=>jt(e.grid.cells.data.length,1,1,()=>Lo),getLoci:z3,eachLocation:U3,setUpdateState:(e,r,n,o)=>{xe.IsoValue.areSame(n.isoValue,o.isoValue,r.grid.stats)||(e.createGeometry=!0)},geometryUtils:Ko.Utils,mustRecreate:(e,r,n)=>!r.tryUseGpu||!n||!V3(e.volume,n),dispose:e=>{e.vertexTexture.ref.value.destroy(),e.groupTexture.ref.value.destroy(),e.normalTexture.ref.value.destroy(),e.doubleBuffer.destroy()}},t)}function Y0e(t,e,r,n,o,i){return N(this,null,function*(){t.runtime.update({message:"Marching cubes..."});let a=Ri(new Int32Array(e.grid.cells.data.length)),s=yield wv({isoLevel:xe.IsoValue.toAbsolute(o.isoValue,e.grid.stats).absoluteValue,scalarField:e.grid.cells,idField:er.create(e.grid.cells.space,er.Data1(a))},i).runAsChild(t.runtime),l=Sn.getGridToCartesianTransform(e.grid);return Sr.transform(s,l),s.setBoundingSphere(xe.Isosurface.getBoundingSphere(e,o.isoValue)),s})}var MW=U(w(w({},Sr.Params),kW),{quality:U(w({},Sr.Params.quality),{isEssential:!1}),sizeFactor:g.Numeric(3,{min:0,max:10,step:.1})});function Q0e(t){return _d({defaultProps:g.getDefaultValues(MW),createGeometry:Y0e,createLocationIterator:e=>jt(e.grid.cells.data.length,1,1,()=>Lo),getLoci:z3,eachLocation:U3,setUpdateState:(e,r,n,o)=>{xe.IsoValue.areSame(n.isoValue,o.isoValue,r.grid.stats)||(e.createGeometry=!0)},geometryUtils:Sr.Utils},t)}var RW={solid:(t,e)=>Sp("Isosurface mesh",t,e,j0e,AW),wireframe:(t,e)=>Sp("Isosurface wireframe",t,e,Q0e,AW)},LW=U(w(w({},G3),MW),{visuals:g.MultiSelect(["solid"],g.objectToOptions(RW)),bumpFrequency:g.Numeric(1,{min:0,max:10,step:.1},ge.ShadingCategory)});function K0e(t,e){let r=g.clone(LW);return r.isoValue=xe.createIsoValueParam(xe.IsoValue.relative(2),e.grid.stats),r}function $0e(t,e){return rt.createMulti("Isosurface",t,e,rt.StateBuilder,RW)}var BW={name:"isosurface",label:"Isosurface",description:"Displays a triangulated isosurface of volumetric data.",factory:$0e,getParams:K0e,defaultValues:g.getDefaultValues(LW),defaultColorTheme:{name:"uniform"},defaultSizeTheme:{name:"uniform"},isApplicable:t=>!xe.isEmpty(t)&&!xe.Segmentation.get(t)};function Z0e(t,e,r,n,o,i){return N(this,null,function*(){let{dimension:{name:a},isoValue:s}=o,{space:l,data:c}=e.grid.cells,{min:u,max:d}=e.grid.stats,m=xe.IsoValue.toAbsolute(s,e.grid.stats).absoluteValue,p="color"in n.color?n.color.color(Lo,!1):ce(16777215),[h,f,b]=ce.toRgbNormalized(p),{width:v,height:x,x:S,y:T,z:E,x0:_,y0:D,z0:P,nx:A,ny:I,nz:k}=j3(e.grid,o),M=new Float32Array(a==="x"?[S,0,0,S,T,0,S,0,E,S,T,E]:a==="y"?[0,T,0,S,T,0,0,T,E,S,T,E]:[0,0,E,0,T,E,S,0,E,S,T,E]),R=new Uint8Array(v*x*4),B=J0e(e.grid,o),F=0;for(let Q=D;Q<I;++Q)for(let L=_;L<A;++L)for(let Y=P;Y<k;++Y){let j=l.get(c,L,Q,Y),O=(j-u)/(d-u);R[F]=h*O*2*255,R[F+1]=f*O*2*255,R[F+2]=b*O*2*255,R[F+3]=j>=m?255:0,F+=4}let G={width:v,height:x,array:R,flipY:!0},V={width:v,height:x,array:B,flipY:!0},H=Sn.getGridToCartesianTransform(e.grid);return $c(H,M,0,4),fd.create(G,M,V,i)})}function j3(t,e){let{dimension:{name:r,params:n}}=e,{space:o}=t.cells,i,a,s,l,c,u=0,d=0,m=0,[p,h,f]=o.dimensions;return r==="x"?(s=n,l=h-1,c=f-1,i=f,a=h,u=s,p=u+1):r==="y"?(s=p-1,l=n,c=f-1,i=f,a=p,d=l,h=d+1):(s=p-1,l=h-1,c=n,i=p,a=h,m=c,f=m+1),{width:i,height:a,x:s,y:l,z:c,x0:u,y0:d,z0:m,nx:p,ny:h,nz:f}}function J0e(t,e){let{space:r}=t.cells,{width:n,height:o,x0:i,y0:a,z0:s,nx:l,ny:c,nz:u}=j3(t,e),d=new Uint8Array(n*o*4),m=0;for(let p=a;p<c;++p)for(let h=i;h<l;++h)for(let f=s;f<u;++f)vf(r.dataOffset(h,p,f),d,m),m+=4;return d}function eve(t,e){let{space:r}=t.cells,{width:n,height:o,x0:i,y0:a,z0:s,nx:l,ny:c,nz:u}=j3(t,e),d=new Uint32Array(n*o),m=0;for(let p=a;p<c;++p)for(let h=i;h<l;++h)for(let f=s;f<u;++f)d[m]=r.dataOffset(h,p,f),m+=1;return d}function FW(t,e){let r=eve(t.grid,e);return xe.Cell.Loci(t,tr.ofUnsortedArray(r))}function tve(t,e,r,n,o){let{objectId:i,groupId:a}=t;if(o===i){let s=xe.PickingGranularity.get(e);return s==="volume"?xe.Loci(e):s==="object"?FW(e,n):xe.Cell.Loci(e,Oe.ofSingleton(a))}return St}function rve(t,e,r,n,o){return jf(t,e,void 0,o)}var H3=U(w({},fd.Params),{quality:U(w({},fd.Params.quality),{isEssential:!1}),dimension:g.MappedStatic("x",{x:g.Numeric(0,{min:0,max:0,step:1}),y:g.Numeric(0,{min:0,max:0,step:1}),z:g.Numeric(0,{min:0,max:0,step:1})},{isEssential:!0}),isoValue:xe.IsoValueParam});function nve(t,e){let r=g.clone(H3),n=e.grid.cells.space.dimensions;return r.dimension=g.MappedStatic("x",{x:g.Numeric(0,{min:0,max:n[0]-1,step:1}),y:g.Numeric(0,{min:0,max:n[1]-1,step:1}),z:g.Numeric(0,{min:0,max:n[2]-1,step:1})},{isEssential:!0}),r.isoValue=xe.createIsoValueParam(xe.IsoValue.absolute(e.grid.stats.min),e.grid.stats),r}function ove(t){return _d({defaultProps:g.getDefaultValues(H3),createGeometry:Z0e,createLocationIterator:e=>jt(e.grid.cells.data.length,1,1,()=>Lo),getLoci:tve,eachLocation:rve,setUpdateState:(e,r,n,o,i,a)=>{e.createGeometry=n.dimension.name!==o.dimension.name||n.dimension.params!==o.dimension.params||!xe.IsoValue.areSame(n.isoValue,o.isoValue,r.grid.stats)||!wo.areEqual(i.color,a.color)},geometryUtils:U(w({},fd.Utils),{createRenderableState:e=>{let r=fd.Utils.createRenderableState(e);return OW(r,e),r},updateRenderableState:OW})},t)}function OW(t,e){fd.Utils.updateRenderableState(t,e),t.opaque=!1,t.writeDepth=!0}function ive(t,e){return Sp("Slice",t,e,ove,FW)}var NW={name:"slice",label:"Slice",description:"Slice of volume rendered as image with interpolation.",factory:ive,getParams:nve,defaultValues:g.getDefaultValues(H3),defaultColorTheme:{name:"uniform"},defaultSizeTheme:{name:"uniform"},isApplicable:t=>!xe.isEmpty(t)&&!xe.Segmentation.get(t)};function VW(t,e){let r=qe();return qe.add(r,t),qe.transform(r,r,e),r}function ave(t,e,r,n){let o=r.grid.cells.space.dimensions,{width:i,height:a}=uu(o);if(Math.max(i,a)>e.maxTextureSize/2)throw new Error("volume too large for direct-volume rendering");let s=sw(r,"normals"),l=Sn.getGridToCartesianTransform(r.grid),c=VW(o,l),u=n?n.gridTexture.ref.value:e.resources.texture("image-uint8","rgba","ubyte","linear");u.load(s);let{unitToCartn:d,cellDim:m}=zW(r.grid),p=r.grid.cells.space.axisOrderSlowToFast;return ta.create(c,o,l,d,m,u,r.grid.stats,!1,p,n)}function zW(t){if(t.transform.kind==="matrix")return{unitToCartn:W.mul(W(),t.transform.matrix,W.fromScaling(W(),t.cells.space.dimensions)),cellDim:W.getScaling(y(),t.transform.matrix)};let e=t.transform.fractionalBox,r=qe.size(y(),e);return{unitToCartn:W.mul3(W(),t.transform.cell.fromFractional,W.fromTranslation(W(),e.min),W.fromScaling(W(),r)),cellDim:y.div(y(),t.transform.cell.size,t.cells.space.dimensions)}}function sve(t,e,r,n){let o=r.grid.cells.space.dimensions;if(Math.max(...o)>e.max3dTextureSize/2)throw new Error("volume too large for direct-volume rendering");let i=qq(r),a=Sn.getGridToCartesianTransform(r.grid),s=VW(o,a),l=n?n.gridTexture.ref.value:e.resources.texture("volume-uint8","rgba","ubyte","linear");l.load(i);let{unitToCartn:c,cellDim:u}=zW(r.grid),d=r.grid.cells.space.axisOrderSlowToFast;return ta.create(s,o,a,c,u,l,r.grid.stats,!1,d,n)}function lve(t,e,r,n,o,i){return N(this,null,function*(){let{runtime:a,webgl:s}=t;if(s===void 0)throw new Error("DirectVolumeVisual requires `webgl` in props");return s.isWebGL2?sve(a,s,e,i):ave(a,s,e,i)})}function cve(t,e){return xe.Loci(t)}function uve(t,e,r,n,o){let{objectId:i,groupId:a}=t;return o===i?xe.Cell.Loci(e,Oe.ofSingleton(a)):St}function dve(t,e,r,n,o){return jf(t,e,void 0,o)}var q3=U(w({},ta.Params),{quality:U(w({},ta.Params.quality),{isEssential:!1})});function mve(t,e){let r=g.clone(q3);return r.controlPoints.getVolume=()=>e,r}function pve(t){return _d({defaultProps:g.getDefaultValues(q3),createGeometry:lve,createLocationIterator:e=>jt(e.grid.cells.data.length,1,1,()=>Lo),getLoci:uve,eachLocation:dve,setUpdateState:(e,r,n,o)=>{},geometryUtils:ta.Utils,dispose:e=>{e.gridTexture.ref.value.destroy()}},t)}function fve(t,e){return Sp("Direct Volume",t,e,pve,cve)}var UW={name:"direct-volume",label:"Direct Volume",description:"Direct rendering of volumetric data.",factory:fve,getParams:mve,defaultValues:g.getDefaultValues(q3),defaultColorTheme:{name:"volume-value"},defaultSizeTheme:{name:"uniform"},isApplicable:t=>!xe.isEmpty(t)&&!xe.Segmentation.get(t)};var hve={segments:g.Converted(t=>t.map(e=>`${e}`),t=>t.map(e=>parseInt(e)),g.MultiSelect(["0"],g.arrayToOptions(["0"]),{isEssential:!0}))};function gve(t){return t.extensions.colorBufferFloat&&t.extensions.textureFloat&&t.extensions.drawBuffers}var H1=1;function X3(t,e){if(t.grid.cells.data.length<Math.pow(10,3))return!1;let r=t.grid.cells.space.dimensions,{powerOfTwoSize:n}=uu(r,H1);return n<=e.maxTextureSize/2}var yve=W();function GW(t,e){let r=Sn.getGridToCartesianTransform(t),n=W.fromTranslation(yve,e.min);return W.mul(W(),r,n)}function vve(t,e,r,n,o){return n.tryUseGpu&&o&&gve(o)&&X3(e,o)?_ve(t):Cve(t)}function bve(t,e){return xe.Segment.Loci(t,e.segments)}function jW(t,e,r,n,o){let{objectId:i,groupId:a}=t;if(o===i){let s=xe.PickingGranularity.get(e);return s==="volume"?xe.Loci(e):s==="object"?xe.Segment.Loci(e,[r]):xe.Cell.Loci(e,Oe.ofSingleton(a))}return St}function HW(t,e,r,n,o){let i=tr.ofSingleton(r);return jf(t,e,{segments:i},o)}function xve(t,e,r){let n=r.data,o=r.space.dataOffset,i=qe.size(y(),e),[a,s,l]=i,c=a-1,u=s-1,d=l-1,[m,p,h]=e.min,[f,b,v]=e.max,x=[...r.space.axisOrderSlowToFast],S=er.Space(i,x,Uint8Array),T=er.create(S,S.create()),E=T.data,_=S.set;for(let D=0;D<l;++D)for(let P=0;P<s;++P)for(let A=0;A<a;++A){let I=t.includes(n[o(A+m,P+p,D+h)])?255:0,k=t.includes(n[o(Math.min(c+f,A+1+m),P+p,D+h)])?255:0,M=t.includes(n[o(Math.max(0,A-1+m),P+p,D+h)])?255:0,R=t.includes(n[o(A+m,Math.min(u+b,P+1+p),D+h)])?255:0,B=t.includes(n[o(A+m,Math.max(0,P-1+p),D+h)])?255:0,F=t.includes(n[o(A+m,P+p,Math.min(d+v,D+1+h))])?255:0,G=t.includes(n[o(A+m,P+p,Math.max(0,D-1+h))])?255:0;_(E,A,P,D,Math.round((I+I+k+M+R+B+F+G)/8))}return T}function Sve(t,e,r,n,o,i){return N(this,null,function*(){let a=xe.Segmentation.get(e);if(!a)throw new Error("missing volume segmentation");t.runtime.update({message:"Marching cubes..."});let s=qe.clone(a.bounds[r]);qe.expand(s,s,y.create(2,2,2));let l=Array.from(a.segments.get(r).values()),c=xve(l,s,e.grid.cells),u=Ri(new Int32Array(c.data.length)),d=yield ym({isoLevel:128,scalarField:c,idField:er.create(c.space,er.Data1(u))},i).runAsChild(t.runtime),m=GW(e.grid,s);return Be.transform(d,m),t.webgl&&!t.webgl.isWebGL2?(Be.uniformTriangleGroup(d,!1),C.updateIfChanged(d.varyingGroup,!1)):C.updateIfChanged(d.varyingGroup,!0),d.setBoundingSphere(xe.Segment.getBoundingSphere(e,[r])),d})}var Y3=U(w(w(w({},Be.Params),Ko.Params),hve),{quality:U(w({},Be.Params.quality),{isEssential:!1}),tryUseGpu:g.Boolean(!0)});function Cve(t){return _d({defaultProps:g.getDefaultValues(Y3),createGeometry:Sve,createLocationIterator:(e,r)=>{let n=xe.Segment.Location(e,r);return jt(e.grid.cells.data.length,1,1,()=>n)},getLoci:jW,eachLocation:HW,setUpdateState:(e,r,n,o)=>{},geometryUtils:Be.Utils,mustRecreate:(e,r,n)=>r.tryUseGpu&&!!n&&X3(e.volume,n)},t)}var W3="segment-texture";function Tve(t,e,r){let n=xe.Segmentation.get(t);if(!n)throw new Error("missing volume segmentation");let{resources:o}=r,i=qe.clone(n.bounds[e]);qe.expand(i,i,y.create(2,2,2));let a=GW(t.grid,i),s=qe.size(y(),i),{width:l,height:c,powerOfTwoSize:u}=uu(s,H1),d=y.create(l,c,0),m=ne.create(l/u,c/u);if(u>r.maxTextureSize/2)throw new Error("volume too large for gpu segment extraction");r.namedTextures[W3]||(r.namedTextures[W3]=o.texture("image-uint8","alpha","ubyte","linear"));let p=r.namedTextures[W3];p.define(u,u);let h=Array.from(n.segments.get(e).values());return p.load(Wq(t,h,i,H1),!0),s[0]+=H1,s[1]+=H1,{texture:p,transform:a,gridDimension:s,gridTexDim:d,gridTexScale:m}}function wve(t,e,r,n,o,i){return N(this,null,function*(){if(!t.webgl)throw new Error("webgl context required to create volume segment texture-mesh");if(e.grid.cells.data.length<=1)return Ko.createEmpty(i);let{texture:a,gridDimension:s,gridTexDim:l,gridTexScale:c,transform:u}=Tve(e,r,t.webgl),d=e.grid.cells.space.axisOrderSlowToFast,m=i?.doubleBuffer.get(),p=ey(t.webgl,a,s,l,c,u,.5,!1,!1,d,!0,m?.vertex,m?.group,m?.normal),h=e.grid.cells.data.length;return Ko.create(p.vertexCount,h,p.vertexTexture,p.groupTexture,p.normalTexture,xe.Segment.getBoundingSphere(e,[r]),i)})}function _ve(t){return _d({defaultProps:g.getDefaultValues(Y3),createGeometry:wve,createLocationIterator:(e,r)=>{let n=xe.Segment.Location(e,r);return jt(e.grid.cells.data.length,1,1,()=>n)},getLoci:jW,eachLocation:HW,setUpdateState:(e,r,n,o)=>{},geometryUtils:Ko.Utils,mustRecreate:(e,r,n)=>!r.tryUseGpu||!n||!X3(e.volume,n),dispose:e=>{e.vertexTexture.ref.value.destroy(),e.groupTexture.ref.value.destroy(),e.normalTexture.ref.value.destroy(),e.doubleBuffer.destroy()}},t)}function Pve(t){return tr.ofUnsortedArray(t.segments)}var qW={segment:(t,e)=>Sp("Segment mesh",t,e,vve,bve,Pve)},WW=U(w({},Y3),{visuals:g.MultiSelect(["segment"],g.objectToOptions(qW)),bumpFrequency:g.Numeric(1,{min:0,max:10,step:.1},ge.ShadingCategory)});function Eve(t,e){let r=g.clone(WW),n=xe.Segmentation.get(e);if(n){let o=Array.from(n.segments.keys());r.segments=g.Converted(i=>i.map(a=>`${a}`),i=>i.map(a=>parseInt(a)),g.MultiSelect(o.map(i=>`${i}`),g.arrayToOptions(o.map(i=>`${i}`)),{isEssential:!0}))}return r}function Ive(t,e){return rt.createMulti("Segment",t,e,rt.StateBuilder,qW)}var XW={name:"segment",label:"Segment",description:"Displays a triangulated segment of volumetric data.",factory:Ive,getParams:Eve,defaultValues:g.getDefaultValues(WW),defaultColorTheme:{name:"volume-segment"},defaultSizeTheme:{name:"uniform"},isApplicable:t=>!xe.isEmpty(t)&&!!xe.Segmentation.get(t)};var eh=class t extends fv{constructor(){super(),ro(t.BuiltIn,(e,r)=>{if(e.name!==r)throw new Error(`Fix BuiltInVolumeRepresentations to have matching names. ${e.name} ${r}`);this.add(e)})}};(function(t){t.BuiltIn={isosurface:BW,slice:NW,"direct-volume":UW,segment:XW}})(eh||(eh={}));function YW(t,e,r,n){t.push({source:e==="em"?{name:"em",params:{isoValue:xe.IsoValue.absolute(n||0)}}:{name:"x-ray",params:{}},dataId:r})}var q1=Gi.build({display:{name:"Volume Streaming"},from:X.Molecule.Structure,params(t,e){let r=R8(t&&t.data),n=L8(r,t&&t.data);return{method:g.Select(r,[["em","EM"],["x-ray","X-Ray"]]),entries:g.ObjectList({id:g.Text(n[0]||"")},({id:o})=>o,{defaultValue:n.map(o=>({id:o}))}),defaultView:g.Select(r==="em"?"auto":"selection-box",di.ViewTypeOptions),options:g.Group({serverUrl:g.Text(e.config.get(Wt.VolumeStreaming.DefaultServer)||"https://ds.litemol.org"),behaviorRef:g.Text("",{isHidden:!0}),emContourProvider:g.Select("emdb",[["emdb","EMDB"],["pdbe","PDBe"]],{isHidden:!0}),channelParams:g.Value({},{isHidden:!0})})}},isApplicable:(t,e,r)=>{let n=r.config.get(Wt.VolumeStreaming.CanStream);return n?n(t.data,r):t.data.models.length===1&&Et.probablyHasDensityMap(t.data.models[0])}})(({ref:t,state:e,params:r},n)=>ie.create("Volume Streaming",o=>N(void 0,null,function*(){let i=[];for(let d=0,m=r.entries.length;d<m;++d){let p=r.entries[d].id.toLowerCase(),h;if(r.method==="em"){if(!p.toUpperCase().startsWith("EMD")){yield o.update("Getting EMDB info...");let f=yield B8(n,o,p);for(let b=0,v=f.length;b<v;++b){let x=f[b],S;try{S=yield NM(r.options.emContourProvider,n,o,x)}catch(T){console.info(`Could not get map info for ${x}: ${T}`);continue}YW(i,r.method,x,S||0)}continue}try{h=yield NM(r.options.emContourProvider,n,o,p)}catch(f){console.info(`Could not get map info for ${p}: ${f}`);continue}}YW(i,r.method,p,h||0)}let a=e.build().to(t).applyOrUpdateTagged(di.RootTag,Ave,{serverUrl:r.options.serverUrl,entries:i});yield a.commit();let s=a.selector;if(!s.isOk)return;let l=e.tree.children.get(s.ref);l?.size>0&&(yield n.managers.structure.hierarchy.remove(l?.toArray()));let c=s.cell.obj,u=e.build().to(a.ref).apply(W1,g.getDefaultValues(di.createParams({data:c.data,defaultView:r.defaultView,channelParams:r.options.channelParams})),{ref:r.options.behaviorRef?r.options.behaviorRef:void 0});r.method==="em"?u.apply(Pw,{channel:"em"},{state:{isGhost:!0},tags:"em"}):(u.apply(Pw,{channel:"2fo-fc"},{state:{isGhost:!0},tags:"2fo-fc"}),u.apply(Pw,{channel:"fo-fc(+ve)"},{state:{isGhost:!0},tags:"fo-fc(+ve)"}),u.apply(Pw,{channel:"fo-fc(-ve)"},{state:{isGhost:!0},tags:"fo-fc(-ve)"})),yield e.updateTree(u).runInContext(o)}))),KW=Gi.build({display:{name:"Boxify Volume Streaming",description:"Make the current box permanent."},from:di,isApplicable:t=>t.data.params.entry.params.view.name==="selection-box"})(({a:t,ref:e,state:r},n)=>{let o=t.data.params;if(o.entry.params.view.name!=="selection-box")return;let i=qe.create(y.clone(o.entry.params.view.params.bottomLeft),y.clone(o.entry.params.view.params.topRight)),a=o.entry.params.view.params.radius;qe.expand(i,i,y.create(a,a,a));let s=U(w({},o),{entry:{name:o.entry.name,params:U(w({},o.entry.params),{view:{name:"box",params:{bottomLeft:i.min,topRight:i.max}}})}});return r.updateTree(r.build().to(e).update(s))}),Dve={dataId:g.Text(""),source:g.MappedStatic("x-ray",{em:g.Group({isoValue:xe.createIsoValueParam(xe.IsoValue.relative(1))}),"x-ray":g.Group({})})};var Ave=Je.BuiltIn({name:"create-volume-streaming-info",display:{name:"Volume Streaming Info"},from:X.Molecule.Structure,to:nv,params(t){return{serverUrl:g.Text("https://ds.litemol.org"),entries:g.ObjectList(Dve,({dataId:e})=>e,{defaultValue:[{dataId:"",source:{name:"x-ray",params:{}}}]})}}})({apply:({a:t,params:e},r)=>ie.create("",n=>N(void 0,null,function*(){let o=[];for(let a=0,s=e.entries.length;a<s;++a){let l=e.entries[a],c=l.dataId,u=l.source.name==="em"?l.source.params.isoValue:xe.IsoValue.relative(1);yield n.update("Getting server header...");let d=yield r.fetch({url:kf(e.serverUrl,`${l.source.name}/${c.toLocaleLowerCase()}`),type:"json"}).runInContext(n);o.push({dataId:c,kind:l.source.name,header:d,emDefaultContourLevel:u})}let i={serverUrl:e.serverUrl,entries:o,structure:t.data};return new nv(i,{label:"Volume Server",description:`${o.map(a=>a.dataId).join(", ")}`})}))});var W1=Je.BuiltIn({name:"create-volume-streaming-behavior",display:{name:"Volume Streaming Behavior"},from:nv,to:di,params(t){return di.createParams({data:t&&t.data})}})({canAutoUpdate:({oldParams:t,newParams:e})=>t.entry.params.view===e.entry.params.view||e.entry.params.view.name==="selection-box"||e.entry.params.view.name==="camera-target"||e.entry.params.view.name==="off",apply:({a:t,params:e},r)=>ie.create("Volume streaming",n=>N(void 0,null,function*(){let o=new di.Behavior(r,t.data);return yield o.update(e),new di(o,{label:"Volume Streaming",description:o.getDescription()})})),update({a:t,b:e,oldParams:r,newParams:n}){return ie.create("Update Volume Streaming",o=>N(this,null,function*(){if(r.entry.name!==n.entry.name&&"em"in n.entry.params.channels){let{emDefaultContourLevel:a}=e.data.infoMap.get(n.entry.name);a&&(n.entry.params.channels.em.isoValue=a)}let i=(yield e.data.update(n))?Se.UpdateResult.Updated:Se.UpdateResult.Unchanged;return e.description=e.data.getDescription(),i}))}});var Pw=Je.BuiltIn({name:"create-volume-streaming-visual",display:{name:"Volume Streaming Visual"},from:di,to:X.Volume.Representation3D,params:{channel:g.Select("em",di.ChannelTypeOptions,{isHidden:!0})}})({apply:({a:t,params:e,spine:r},n)=>ie.create("Volume Representation",o=>N(void 0,null,function*(){var i,a;let s=t.data.channels[e.channel];if(!s)return Rr.Null;let l=QW(t.data,e.channel),c=eh.BuiltIn.isosurface,u=l.type.params||{},d=c.factory(w({webgl:(i=n.canvas3d)===null||i===void 0?void 0:i.webgl},n.representation.volume.themes),c.getParams);d.setTheme(An.create(n.representation.volume.themes,{volume:s.data},l));let m=(a=r.getAncestorOfType(X.Molecule.Structure))===null||a===void 0?void 0:a.data,p=m?.models.length===0?void 0:LT.get(m?.models[0]);return yield d.createOrUpdate(u,s.data).runInContext(o),p&&d.setState({transform:p}),new X.Volume.Representation3D({repr:d,sourceData:s.data},{label:`${Math.round(s.isoValue.relativeValue*100)/100} \u03C3 [${e.channel}]`})})),update:({a:t,b:e,newParams:r,spine:n},o)=>ie.create("Volume Representation",i=>N(void 0,null,function*(){let a=t.data.channels[r.channel];if(!a)return Se.UpdateResult.Unchanged;let s=e.data.repr.state.visible,l=QW(t.data,r.channel),c=w(w({},e.data.repr.props),l.type.params);return e.data.repr.setTheme(An.create(o.representation.volume.themes,{volume:a.data},l)),yield e.data.repr.createOrUpdate(c,a.data).runInContext(i),e.data.repr.setState({visible:s}),e.data.sourceData=a.data,Se.UpdateResult.Updated}))});function QW(t,e){let r=t.channels[e];return hu.getDefaultParamsStatic(t.plugin,"isosurface",{isoValue:r.isoValue,alpha:r.opacity,visuals:r.wireframe?["wireframe"]:["solid"]},"uniform",{value:r.color})}var As;(function(t){function e(n){return n}t.create=e;function r(n,o){var i,a;if(o.customDurationMs)return o.customDurationMs;let s=(a=(i=o.definition).getDuration)===null||a===void 0?void 0:a.call(i,o.params,n);if(s?.kind==="fixed")return s.durationMs}t.getDuration=r})(As||(As={}));var iR={};ua(iR,{Download:()=>tR,DownloadBlob:()=>rR,ImportJson:()=>qbe,ImportString:()=>Hbe,LazyVolume:()=>Xbe,ParseBlob:()=>Lbe,ParseCcp4:()=>Ube,ParseCif:()=>Bbe,ParseCube:()=>Obe,ParseDsn6:()=>Gbe,ParseDx:()=>jbe,ParseJson:()=>Wbe,ParsePly:()=>zbe,ParsePrmtop:()=>Nbe,ParsePsf:()=>Fbe,ParseTop:()=>Vbe,RawData:()=>nR,ReadFile:()=>oR});var al;(function(t){function e(s){let l=new DataView(s.buffer);return Object.assign(s.subarray(0),{readInt8:c=>l.getInt8(c),readUInt8:c=>l.getUint8(c),writeInt8:(c,u)=>l.setInt8(u,c),writeUInt8:(c,u)=>l.setUint8(u,c),readInt16LE:c=>l.getInt16(c,!0),readInt32LE:c=>l.getInt32(c,!0),readUInt16LE:c=>l.getUint16(c,!0),readUInt32LE:c=>l.getUint32(c,!0),readFloatLE:c=>l.getFloat32(c,!0),readDoubleLE:c=>l.getFloat64(c,!0),writeInt16LE:(c,u)=>l.setInt16(u,c,!0),writeInt32LE:(c,u)=>l.setInt32(u,c,!0),writeUInt16LE:(c,u)=>l.setUint16(u,c,!0),writeUInt32LE:(c,u)=>l.setUint32(u,c,!0),writeFloatLE:(c,u)=>l.setFloat32(u,c,!0),writeDoubleLE:(c,u)=>l.setFloat64(u,c,!0),readInt16BE:c=>l.getInt16(c,!1),readInt32BE:c=>l.getInt32(c,!1),readUInt16BE:c=>l.getUint16(c,!1),readUInt32BE:c=>l.getUint32(c,!1),readFloatBE:c=>l.getFloat32(c,!1),readDoubleBE:c=>l.getFloat64(c,!1),writeInt16BE:(c,u)=>l.setInt16(u,c,!1),writeInt32BE:(c,u)=>l.setInt32(u,c,!1),writeUInt16BE:(c,u)=>l.setUint16(u,c,!1),writeUInt32BE:(c,u)=>l.setUint32(u,c,!1),writeFloatBE:(c,u)=>l.setFloat32(u,c,!1),writeDoubleBE:(c,u)=>l.setFloat64(u,c,!1),copy:(c,u,d,m)=>(u=li(u,0),d=li(d,0),m=li(m,s.length),c.set(s.subarray(d,m),u),m-d)})}t.fromUint8Array=e;function r(s){return e(new Uint8Array(s))}t.fromArrayBuffer=r;function n(s){return s}t.fromBuffer=n,t.IsNativeEndianLittle=new Uint16Array(new Uint8Array([18,52]).buffer)[0]===13330;function o(s,l,c,u,d){for(let m=0,p=c;m<p;m+=u)for(let h=0;h<u;h++)l[d+m+u-h-1]=s[d+m+h]}t.flipByteOrder=o;function i(s,l=0,c){let u=new Int16Array(s,l,c);for(let d=0,m=u.length;d<m;++d){let p=u[d];u[d]=(p&255)<<8|p>>8&255}}t.flipByteOrderInPlace2=i;function a(s,l,c,u,d){t.IsNativeEndianLittle||!c||u<=1||o(s,l,c,u,d)}t.ensureLittleEndian=a})(al||(al={}));var _v;(function(t){function e(r,n){return{name:n,readBuffer:(o,i,a,s)=>{let l,c;if(typeof i=="number"){a=li(a,i);let u=o,d=Math.min(r.length,u+a);l=d-u,c=al.fromUint8Array(new Uint8Array(r.buffer,u,d-u))}else{a=li(a,i.length);let u=o,d=Math.min(r.length,u+a);i.set(r.subarray(u,d),s),l=d-u,c=i}return a!==l&&console.warn(`byteCount ${a} and bytesRead ${l} differ`),Promise.resolve({bytesRead:l,buffer:c})},writeBuffer:(o,i,a)=>(a=li(a,i.length),console.error(".writeBuffer not implemented for FileHandle.fromBuffer"),Promise.resolve(0)),writeBufferSync:(o,i,a)=>(a=li(a,i.length),console.error(".writeSync not implemented for FileHandle.fromBuffer"),0),close:hs}}t.fromBuffer=e})(_v||(_v={}));var Ba=function(t){return t.Float32="float32",t.Int8="int8",t.Int16="int16",t.Uint16="uint16",t}(Ba||{});function Q3(t){return t===Ba.Float32?4:t===Ba.Int16||t===Ba.Uint16?2:1}function kve(t,e,r=0,n){return t===Ba.Float32?new Float32Array(e,r,n):t===Ba.Int16?new Int16Array(e,r,n):t===Ba.Uint16?new Uint16Array(e,r,n):new Int8Array(e,r,n)}function $W(t,e){let r=Q3(e),n=new ArrayBuffer(r*t),o=al.fromArrayBuffer(n),i=al.IsNativeEndianLittle?n:new ArrayBuffer(r*t);return{type:e,elementByteSize:r,readBuffer:o,valuesBuffer:new Uint8Array(i),values:kve(e,i)}}function ZW(t,e,r,n,o,i){return N(this,null,function*(){return yield e.readBuffer(r,t.readBuffer,n,o),t.elementByteSize>1&&(i!==void 0&&i!==al.IsNativeEndianLittle||!al.IsNativeEndianLittle)&&al.flipByteOrder(t.readBuffer,t.valuesBuffer,n,t.elementByteSize,o),t.values})}function Mve(t){return N(this,null,function*(){let{buffer:r}=yield t.readBuffer(0,1024),n=String.fromCharCode(r.readUInt8(52*4),r.readUInt8(52*4+1),r.readUInt8(52*4+2),r.readUInt8(52*4+3));if(n!=="MAP ")throw new Error('ccp4 format error, missing "MAP " string');let o=[r.readUInt8(53*4),r.readUInt8(53*4+1)],i=!1;o[0]===68&&o[1]===65?i=!0:o[0]===17&&o[1]===17?i=!1:r.readInt32LE(12)<=16&&(i=!0);let a=i?c=>r.readInt32LE(c*4):c=>r.readInt32BE(c*4),s=i?c=>r.readFloatLE(c*4):c=>r.readFloatBE(c*4);return{header:{NC:a(0),NR:a(1),NS:a(2),MODE:a(3),NCSTART:a(4),NRSTART:a(5),NSSTART:a(6),NX:a(7),NY:a(8),NZ:a(9),xLength:s(10),yLength:s(11),zLength:s(12),alpha:s(13),beta:s(14),gamma:s(15),MAPC:a(16),MAPR:a(17),MAPS:a(18),AMIN:s(19),AMAX:s(20),AMEAN:s(21),ISPG:a(22),NSYMBT:a(23),LSKFLG:a(24),SKWMAT:[],SKWTRN:[],userFlag1:a(39),userFlag2:a(40),originX:s(49),originY:s(50),originZ:s(51),MAP:n,MACHST:o,ARMS:s(54)},littleEndian:i}})}function Rve(t,e,r,n,o,i){return N(this,null,function*(){if(eX(t)){let a=3*o;yield r.readBuffer(n,e.readBuffer,o,a);let s=new Int8Array(e.valuesBuffer.buffer,a),l=(t.AMAX-t.AMIN)/255,c=.5*(t.AMIN+t.AMAX+l);for(let u=0,d=o;u<d;++u)e.values[u]=l*s[u]+c}else yield ZW(e,r,n,o,0,i)})}function JW(t){switch(t){case 0:return Ba.Int8;case 1:return Ba.Int16;case 2:return Ba.Float32;case 3:throw new Error("mode 3 unsupported, complex 16-bit integers");case 4:throw new Error("mode 4 unsupported, complex 32-bit reals");case 6:Ba.Uint16;case 16:throw new Error("mode 16 unsupported, unsigned char * 3 (for rgb data, non-standard)")}throw new Error(`unknown mode '${t}'`)}function eX(t){return t.userFlag1===-128&&t.userFlag2===127}function K3(t){return eX(t)?Ba.Float32:JW(t.MODE)}function Lve(t){return 256*4+t.NSYMBT}function Bve(t,e,r){return N(this,null,function*(){yield r.update({message:"Parsing CCP4/MRC/MAP file..."});let{header:n,littleEndian:o}=yield Mve(t),i=Lve(n),a=JW(n.MODE),s=K3(n),l=n.NC*n.NR*n.NS,c=Q3(a),u=l*c,d=$W(l,s);return Rve(n,d,t,i,u,o),{header:n,values:d.values,name:t.name}})}function Ove(t,e){return ie.create("Parse CCP4/MRC/MAP",r=>N(this,null,function*(){try{return xr.success(yield Bve(t,e,r))}catch(n){return xr.error(n)}}))}function tX(t,e){return Ove(_v.fromBuffer(al.fromUint8Array(t),e),t.length)}var $3=512;function Nve(t){return{xStart:parseInt(t.substr(10,5)),yStart:parseInt(t.substr(15,5)),zStart:parseInt(t.substr(20,5)),xExtent:parseInt(t.substr(32,5)),yExtent:parseInt(t.substr(38,5)),zExtent:parseInt(t.substr(42,5)),xRate:parseInt(t.substr(52,5)),yRate:parseInt(t.substr(58,5)),zRate:parseInt(t.substr(62,5)),xlen:parseFloat(t.substr(73,10)),ylen:parseFloat(t.substr(83,10)),zlen:parseFloat(t.substr(93,10)),alpha:parseFloat(t.substr(103,10)),beta:parseFloat(t.substr(113,10)),gamma:parseFloat(t.substr(123,10)),divisor:parseFloat(t.substr(138,12)),summand:parseInt(t.substr(155,8)),sigma:parseFloat(t.substr(170,12))}}function Vve(t,e){let r=e?o=>t.readInt16LE(o*2):o=>t.readInt16BE(o*2),n=1/r(17);return{xStart:r(0),yStart:r(1),zStart:r(2),xExtent:r(3),yExtent:r(4),zExtent:r(5),xRate:r(6),yRate:r(7),zRate:r(8),xlen:r(9)*n,ylen:r(10)*n,zlen:r(11)*n,alpha:r(12)*n,beta:r(13)*n,gamma:r(14)*n,divisor:r(15)/100,summand:r(16),sigma:void 0}}function rX(t){let{xExtent:e,yExtent:r,zExtent:n}=t,o=Math.ceil(e/8),i=Math.ceil(r/8),a=Math.ceil(n/8);return{xBlocks:o,yBlocks:i,zBlocks:a}}function zve(t){return N(this,null,function*(){let{buffer:e}=yield t.readBuffer(0,$3),r=String.fromCharCode.apply(null,e),n=r.startsWith(":-)"),o=n||e.readInt16LE(18*2)===100;return{header:n?Nve(r):Vve(e,o),littleEndian:o}})}function Uve(t,e,r,n){return N(this,null,function*(){n||al.flipByteOrderInPlace2(e.buffer);let{divisor:o,summand:i,xExtent:a,yExtent:s,zExtent:l}=t,{xBlocks:c,yBlocks:u,zBlocks:d}=rX(t),m=0;for(let p=0;p<d;++p)for(let h=0;h<u;++h)for(let f=0;f<c;++f)for(let b=0;b<8;++b){let v=8*p+b;for(let x=0;x<8;++x){let S=8*h+x;for(let T=0;T<8;++T){let E=8*f+T;if(E<a&&S<s&&v<l){let _=(E*s+S)*l+v;r[_]=(e[m]-i)/o,++m}else{m+=8-T;break}}}}})}function Gve(t){let{xExtent:e,yExtent:r,zExtent:n}=t,{xBlocks:o,yBlocks:i,zBlocks:a}=rX(t),s=e*r*n,l=o*8*i*8*a*8,u=l*1;return{count:l,byteCount:u,valueCount:s}}function jve(t,e,r){return N(this,null,function*(){yield r.update({message:"Parsing DSN6/BRIX file..."});let{header:n,littleEndian:o}=yield zve(t),{buffer:i}=yield t.readBuffer($3,e-$3),{valueCount:a}=Gve(n),s=new Float32Array(a);return yield Uve(n,i,s,o),{header:n,values:s,name:t.name}})}function Hve(t,e){return ie.create("Parse DSN6/BRIX",r=>N(this,null,function*(){try{return xr.success(yield jve(t,e,r))}catch(n){return xr.error(n)}}))}function nX(t,e){return Hve(_v.fromBuffer(al.fromUint8Array(t),e),t.length)}var Wve={char:1,uchar:1,short:2,ushort:2,int:4,uint:4,float:4,double:8,int8:1,uint8:1,int16:2,uint16:2,int32:4,uint32:4,float32:4,float64:8},Xve=new Set(Object.keys(Wve));function Ew(t){if(!Xve.has(t))throw new Error(`unknown ply type '${t}'`);return t}function oX(t,e,r){let n=new Map;for(let o=0,i=e.length;o<i;++o)n.set(e[o],t[o]);return{comments:r,elementNames:e,getElement:o=>n.get(o)}}function Yve(t,e){let r=Fe(t);return{data:t,tokenizer:r,runtimeCtx:e,comments:[],elementSpecs:[],elements:[]}}function Qve(t){let e=t.data.indexOf("end_header",t.position);if(e===-1)throw new Error("no 'end_header' record found");t.tokenStart=t.position,t.tokenEnd=e,t.position=e,Fe.eatLine(t)}function Kve(t){let{tokenizer:e,comments:r,elementSpecs:n}=t;Qve(e);let o=Fe.getTokenString(e).split(/\r?\n/);if(o[0]!=="ply")throw new Error("data not starting with 'ply'");if(o[1]!=="format ascii 1.0")throw new Error("format not 'ascii 1.0'");let i,a,s;function l(){if(i!==void 0&&a!==void 0&&s!==void 0){let c=!1;for(let u=0,d=s.length;u<d;++u)if(s[u].kind==="list"){c=!0;break}c&&s.length,c?n.push({kind:"list",name:i,count:a,property:s[0]}):n.push({kind:"table",name:i,count:a,properties:s})}}for(let c=2,u=o.length;c<u;++c){let d=o[c],m=d.split(" ");if(d.startsWith("comment"))r.push(d.substr(8));else if(d.startsWith("element"))l(),s=[],i=m[1],a=parseInt(m[2]);else if(d.startsWith("property")){if(s===void 0)throw new Error("properties outside of element");m[1]==="list"?s.push({kind:"list",countType:Ew(m[2]),dataType:Ew(m[3]),name:m[4]}):s.push({kind:"column",type:Ew(m[1]),name:m[2]})}else d.startsWith("end_header")?l():console.warn("unknown header line")}}function $ve(t){let{elementSpecs:e}=t;for(let r=0,n=e.length;r<n;++r){let o=e[r];o.kind==="table"?Zve(t,o):o.kind==="list"&&Jve(t,o)}}function iX(t){switch(t){case"char":case"uchar":case"int8":case"uint8":case"short":case"ushort":case"int16":case"uint16":case"int":case"uint":case"int32":case"uint32":return K.Schema.int;case"float":case"double":case"float32":case"float64":return K.Schema.float}}function Zve(t,e){let{elements:r,tokenizer:n}=t,{count:o,properties:i}=e,a=i.length,s=[],l=[],c=[],u=new Map;for(let d=0,m=a;d<m;++d){let p=Ce.create(n.data,o*2);c.push(p)}for(let d=0,m=o;d<m;++d)for(let p=0,h=a;p<h;++p)Fe.skipWhitespace(n),Fe.markStart(n),Fe.eatValue(n),Ce.addUnchecked(c[p],n.tokenStart,n.tokenEnd);for(let d=0,m=a;d<m;++d){let{type:p,name:h}=i[d],f=PA(c[d],iX(p));s.push(h),l.push(p),u.set(h,f)}r.push({kind:"table",rowCount:o,propertyNames:s,propertyTypes:l,getProperty:d=>u.get(d)})}function Jve(t,e){let{elements:r,tokenizer:n}=t,{count:o,property:i}=e,a=Ce.create(n.data,o*2*3),s=new Uint32Array(o+1),l=0;for(let d=0,m=o;d<m;++d){for(Fe.skipWhitespace(n),Fe.markStart(n);Fe.skipWhitespace(n)!==10;)++l,Fe.markStart(n),Fe.eatValue(n),Ce.addToken(a,n);s[d+1]=l}let c={entries:[],count:0},u=PA(a,iX(i.dataType));r.push({kind:"list",rowCount:o,name:i.name,type:i.dataType,value:d=>{let m=s[d]+1,p=u.value(m-1);for(let h=m,f=m+p;h<f;++h)c.entries[h-m]=u.value(h);return c.count=p,c}})}function ebe(t,e){return N(this,null,function*(){let r=Yve(t,e);e.update({message:"Parsing...",current:0,max:t.length}),Kve(r),$ve(r);let{elements:n,elementSpecs:o,comments:i}=r,a=o.map(l=>l.name),s=oX(n,a,i);return xr.success(s)})}function aX(t){return ie.create("Parse PLY",e=>N(this,null,function*(){return yield ebe(t,e)}))}var{readLine:Dw,skipWhitespace:sX,eatValue:lX,eatLine:rbe,markStart:Z3}=Fe,Iw=/\s+/,nbe=/(^\*|REMARK)*/;function obe(t,e){return{tokenizer:t,runtimeCtx:e}}function ibe(t,e){return N(this,null,function*(){let{tokenizer:r}=t,n=Ce.create(r.data,e*2),o=Ce.create(r.data,e*2),i=Ce.create(r.data,e*2),a=Ce.create(r.data,e*2),s=Ce.create(r.data,e*2),l=Ce.create(r.data,e*2),c=Ce.create(r.data,e*2),u=Ce.create(r.data,e*2),{position:d}=r,m=Dw(r).trim();r.position=d;let p=m.split(Iw).length===7,h=p?6:8,{length:f}=r,b=0;return yield om(t.runtimeCtx,1e5,void 0,v=>{let x=Math.min(e-b,v);for(let S=0;S<x;++S){for(let T=0;T<h;++T)if(sX(r),Z3(r),lX(r),p)switch(T){case 0:Ce.addUnchecked(n,r.tokenStart,r.tokenEnd);break;case 1:Ce.addUnchecked(i,r.tokenStart,r.tokenEnd);break;case 2:Ce.addUnchecked(s,r.tokenStart,r.tokenEnd);break;case 3:Ce.addUnchecked(l,r.tokenStart,r.tokenEnd);break;case 4:Ce.addUnchecked(c,r.tokenStart,r.tokenEnd);break;case 5:Ce.addUnchecked(u,r.tokenStart,r.tokenEnd);break}else switch(T){case 0:Ce.addUnchecked(n,r.tokenStart,r.tokenEnd);break;case 1:Ce.addUnchecked(o,r.tokenStart,r.tokenEnd);break;case 2:Ce.addUnchecked(i,r.tokenStart,r.tokenEnd);break;case 3:Ce.addUnchecked(a,r.tokenStart,r.tokenEnd);break;case 4:Ce.addUnchecked(s,r.tokenStart,r.tokenEnd);break;case 5:Ce.addUnchecked(l,r.tokenStart,r.tokenEnd);break;case 6:Ce.addUnchecked(c,r.tokenStart,r.tokenEnd);break;case 7:Ce.addUnchecked(u,r.tokenStart,r.tokenEnd);break}rbe(r),Z3(r)}return b+=x,x},v=>v.update({message:"Parsing...",current:r.position,max:f})),{count:e,atomId:xt(n)(K.Schema.int),segmentName:p?xt(i)(K.Schema.str):xt(o)(K.Schema.str),residueId:xt(i)(K.Schema.int),residueName:p?xt(i)(K.Schema.str):xt(a)(K.Schema.str),atomName:xt(s)(K.Schema.str),atomType:xt(l)(K.Schema.str),charge:xt(c)(K.Schema.float),mass:xt(u)(K.Schema.float)}})}function abe(t,e){return N(this,null,function*(){let{tokenizer:r}=t,n=Ce.create(r.data,e*2),o=Ce.create(r.data,e*2),{length:i}=r,a=0;return yield om(t.runtimeCtx,10,void 0,s=>{let l=Math.min(e-a,s);for(let c=0;c<l;++c)for(let u=0;u<2;++u)switch(sX(r),Z3(r),lX(r),u){case 0:Ce.addUnchecked(n,r.tokenStart,r.tokenEnd);break;case 1:Ce.addUnchecked(o,r.tokenStart,r.tokenEnd);break}return a+=l,l},s=>s.update({message:"Parsing...",current:r.position,max:i})),{count:e,atomIdA:xt(n)(K.Schema.int),atomIdB:xt(o)(K.Schema.int)}})}function sbe(t,e){let r=[];for(let n=0;n<e;++n){let o=Dw(t.tokenizer);r.push(o.replace(nbe,"").trim())}return r}function lbe(t,e){return N(this,null,function*(){let r=Fe(t),n=obe(r,e),o,i,a,s=Dw(n.tokenizer).trim();for(;r.tokenEnd<r.length;){let c=Dw(n.tokenizer).trim();if(c.includes("!NTITLE")){let u=parseInt(c.split(Iw)[0]);o=sbe(n,u)}else if(c.includes("!NATOM")){let u=parseInt(c.split(Iw)[0]);i=yield ibe(n,u)}else if(c.includes("!NBOND")){let u=parseInt(c.split(Iw)[0]);a=yield abe(n,u);break}else c.includes("!NTHETA")||c.includes("!NPHI")||c.includes("!NIMPHI")||c.includes("!NDON")||c.includes("!NACC")||c.includes("!NNB")||c.includes("!NGRP NST2")||c.includes("!MOLNT")||c.includes("!NUMLP NUMLPH")||c.includes("!NCRTERM")}if(o===void 0&&(o=[]),i===void 0)return xr.error("no atoms data");if(a===void 0)return xr.error("no bonds data");let l={id:s,title:o,atoms:i,bonds:a};return xr.success(l)})}function cX(t){return ie.create("Parse PSF",e=>N(this,null,function*(){return yield lbe(t,e)}))}var uX=.529177210859;function cbe(t){let e=Fe.readLines(t,6),r=(x,S)=>{let T=+e[x].trim().split(/\s+/g)[S];return Number.isNaN(T)?0:T},n=x=>{let S=r(x+2,0),T=uX;return[Math.abs(S),y.create(r(x+2,1)*T,r(x+2,2)*T,r(x+2,3)*T),S]},o=e[0].trim(),i=e[1].trim(),[a,s,l]=n(0),[c,u]=n(1),[d,m]=n(2),[p,h]=n(3),f=ube(t,a,uX),b=[];if(l>=0){let x=r(2,4);x===0&&(x=1);for(let S=0;S<x;S++)b.push(S)}else{let x=Fe.readLine(t).trim().split(/\s+/g);for(let S=0,T=+x[0];S<T;S++)b.push(+x[S+1])}return{header:{orbitals:l<0,comment1:o,comment2:i,atomCount:a,origin:s,dim:y.create(c,d,p),basisX:u,basisY:m,basisZ:h,dataSetIds:b},atoms:f}}function ube(t,e,r){let n=new Int32Array(e),o=new Float64Array(e),i=new Float32Array(e),a=new Float32Array(e),s=new Float32Array(e);for(let l=0;l<e;l++){let c=Fe.readLine(t).trim().split(/\s+/g);n[l]=+c[0],o[l]=+c[1],i[l]=+c[2]*r,a[l]=+c[3]*r,s[l]=+c[4]*r}return{count:e,number:K.ofArray({array:n,schema:K.Schema.int}),nuclearCharge:K.ofArray({array:o,schema:K.Schema.float}),x:K.ofArray({array:i,schema:K.Schema.float}),y:K.ofArray({array:a,schema:K.Schema.float}),z:K.ofArray({array:s,schema:K.Schema.float})}}function dbe(t,e,r){let n=r.dim[0]*r.dim[1]*r.dim[2]*r.dataSetIds.length,o=100*100*100,i=new Float64Array(n),a=0;return om(t,o,i,(s,l)=>{let c=Math.min(n,a+s);for(let u=a;u<c;u++)Fe.skipWhitespace(e),e.tokenStart=e.position,Fe.eatValue(e),l[u]=wT(e.data,e.tokenStart,e.tokenEnd);return a=c,c===n?0:o},(s,l,c)=>s.update({current:Math.min(c,n),max:n}))}function dX(t,e){return ie.create("Parse Cube",r=>N(this,null,function*(){yield r.update("Reading header...");let n=Fe(t),{header:o,atoms:i}=cbe(n),a=yield dbe(r,n,o);return xr.success({header:o,atoms:i,values:a,name:e})}))}function mX(t){let e={h:y()},r=0,n=0,o=/\s+/g;for(;;){let i=Fe.readLine(t),a;if(i.startsWith("object 1"))a=i.split(o),e.dim=y.create(parseInt(a[5]),parseInt(a[6]),parseInt(a[7]));else if(i.startsWith("origin"))a=i.split(o),e.min=y.create(parseFloat(a[1]),parseFloat(a[2]),parseFloat(a[3]));else if(i.startsWith("delta"))a=i.split(o),n===0?e.h[0]=parseFloat(a[1]):n===1?e.h[1]=parseFloat(a[2]):n===2&&(e.h[2]=parseFloat(a[3])),n+=1;else if(i.startsWith("object 3")){r+=i.length+1;break}r+=i.length+1}return{header:e,headerByteCount:r}}function mbe(t,e,r){let n=r.dim[0]*r.dim[1]*r.dim[2],o=100*100*100,i=new Float64Array(n),a=0;return om(t,o,i,(s,l)=>{let c=Math.min(n,a+s);for(let u=a;u<c;u++)Fe.skipWhitespace(e),e.tokenStart=e.position,Fe.eatValue(e),l[u]=wT(e.data,e.tokenStart,e.tokenEnd);return a=c,c===n?0:o},(s,l,c)=>s.update({current:Math.min(c,n),max:n}))}function pbe(t,e,r){return N(this,null,function*(){yield t.update("Reading header...");let n=Fe(e),{header:o}=mX(n);yield t.update("Reading values...");let i=yield mbe(t,n,o);return xr.success({header:o,values:i,name:r})})}function fbe(t,e,r){return N(this,null,function*(){yield t.update("Reading header...");let n=aU(e,0,1e3),o=Fe(n),{header:i,headerByteCount:a}=mX(o);yield t.update("Reading values...");let s=i.dim[0]*i.dim[1]*i.dim[2],l=new DataView(e.buffer,e.byteOffset+a),c=new Float64Array(s);for(let u=0;u<s;u++)c[u]=l.getFloat64(u*8,!0);return xr.success({header:i,values:c,name:r})})}function pX(t,e){return ie.create("Parse DX",r=>typeof t=="string"?pbe(r,t,e):fbe(r,t,e))}var hbe={NATOM:"",NTYPES:"",NBONH:"",MBONA:"",NTHETH:"",MTHETA:"",NPHIH:"",MPHIA:"",NHPARM:"",NPARM:"",NNB:"",NRES:"",NBONA:"",NTHETA:"",NPHIA:"",NUMBND:"",NUMANG:"",NPTRA:"",NATYP:"",NPHB:"",IFPERT:"",NBPER:"",NGPER:"",NDPER:"",MBPER:"",MGPER:"",MDPER:"",IFBOX:"",NMXRS:"",IFCAP:"",NUMEXTRA:"",NCOPY:""},fX=Object.keys(hbe),{readLine:Aw,markLine:hX,trim:gbe}=Fe;function ybe(t,e){return{tokenizer:t,runtimeCtx:e}}function vbe(t){let{tokenizer:e}=t,r=[];for(;e.tokenEnd<e.length&&e.data[e.position]!=="%";){let n=Aw(e).trim();n&&r.push(n)}return r}function bbe(t){let{tokenizer:e}=t,r=Object.create(null);fX.forEach(o=>{r[o]=0});let n=0;for(;e.tokenEnd<e.length&&e.data[e.position]!=="%";){let o=Aw(e),i=Math.min(n+10,32);for(let a=0;n<i;++a,++n)r[fX[n]]=parseInt(o.substring(a*8,a*8+8).trim())}return r}function th(t,e,r,n){let{tokenizer:o}=t,i=Ce.create(o.data,e*2),a=0;for(;o.tokenEnd<o.length&&o.data[o.position]!=="%";){o.tokenStart=o.position;let s=Math.min(a+r,e);for(let l=0;a<s;++l,++a){let c=o.position;gbe(o,o.position,o.position+n),Ce.addUnchecked(i,o.tokenStart,o.tokenEnd),o.position=c+n}hX(o)}return i}function xbe(t,e){return N(this,null,function*(){let r=Fe(t),n=ybe(r,e),o=Object.create(null),i=0;for(;r.tokenEnd<r.length;){r.position-i>1e5&&e.shouldUpdate&&(i=r.position,yield e.update({current:r.position,max:r.length}));let a=Aw(n.tokenizer).trim();if(a.startsWith("%VERSION"))o.version=a.substring(8).trim();else if(a.startsWith("%FLAG")){let s=a.substring(5).trim();if(!Aw(n.tokenizer).trim().startsWith("%FORMAT"))throw new Error("expected %FORMAT");if(s==="TITLE")o.title=vbe(n);else if(s==="POINTERS")o.pointers=bbe(n);else if(s==="ATOM_NAME"){let c=th(n,o.pointers.NATOM,20,4);o.atomName=xt(c)(K.Schema.str)}else if(s==="CHARGE"){let c=th(n,o.pointers.NATOM,5,16);o.charge=xt(c)(K.Schema.float)}else if(s==="MASS"){let c=th(n,o.pointers.NATOM,5,16);o.mass=xt(c)(K.Schema.float)}else if(s==="RESIDUE_LABEL"){let c=th(n,o.pointers.NRES,20,4);o.residueLabel=xt(c)(K.Schema.str)}else if(s==="RESIDUE_POINTER"){let c=th(n,o.pointers.NRES,10,8);o.residuePointer=xt(c)(K.Schema.int)}else if(s==="BONDS_INC_HYDROGEN"){let c=th(n,o.pointers.NBONH*3,10,8);o.bondsIncHydrogen=xt(c)(K.Schema.int)}else if(s==="BONDS_WITHOUT_HYDROGEN"){let c=th(n,o.pointers.NBONA*3,10,8);o.bondsWithoutHydrogen=xt(c)(K.Schema.int)}else if(s==="RADII"){let c=th(n,o.pointers.NATOM,5,16);o.radii=xt(c)(K.Schema.float)}else for(;r.tokenEnd<r.length&&r.data[r.position]!=="%";)hX(r)}}return xr.success(o)})}function gX(t){return ie.create("Parse PRMTOP",e=>N(this,null,function*(){return yield xbe(t,e)}))}var Sbe={nr:K.Schema.Int(),type:K.Schema.Str(),resnr:K.Schema.Int(),residu:K.Schema.Str(),atom:K.Schema.Str(),cgnr:K.Schema.Int(),charge:K.Schema.Float(),mass:K.Schema.Float()},Cbe={ai:K.Schema.Int(),aj:K.Schema.Int()},Tbe={compound:K.Schema.Str(),molCount:K.Schema.Int()},{readLine:J3,markLine:rh,skipWhitespace:nh,markStart:kw,eatValue:eR,eatLine:wbe}=Fe;function _be(t,e){return{tokenizer:t,runtimeCtx:e}}var Pbe=/\[ (.+) \]/,Ebe=/\s+/;function Ibe(t){let{tokenizer:e}=t,r;for(;e.tokenEnd<e.length;){nh(e);let n=e.data[e.position];if(n==="[")break;if(n===";"||n==="*"){rh(e);continue}if(r!==void 0)throw new Error("more than one molName");r=J3(e).split(Ebe)[0]}if(r===void 0)throw new Error("missing molName");return r}function Dbe(t){let{tokenizer:e}=t,r=Ce.create(e.data,64),n=Ce.create(e.data,64),o=Ce.create(e.data,64),i=Ce.create(e.data,64),a=Ce.create(e.data,64),s=Ce.create(e.data,64),l=Ce.create(e.data,64),c=Ce.create(e.data,64);for(;e.tokenEnd<e.length;){nh(e);let u=e.data[e.position];if(u==="[")break;if(u===";"||u==="*"){rh(e);continue}for(let d=0;d<8;++d)switch(nh(e),kw(e),eR(e),d){case 0:Ce.add(r,e.tokenStart,e.tokenEnd);break;case 1:Ce.add(n,e.tokenStart,e.tokenEnd);break;case 2:Ce.add(o,e.tokenStart,e.tokenEnd);break;case 3:Ce.add(i,e.tokenStart,e.tokenEnd);break;case 4:Ce.add(a,e.tokenStart,e.tokenEnd);break;case 5:Ce.add(s,e.tokenStart,e.tokenEnd);break;case 6:Ce.add(l,e.tokenStart,e.tokenEnd);break;case 7:Ce.add(c,e.tokenStart,e.tokenEnd);break}rh(e)}return Xo.ofColumns(Sbe,{nr:xt(r)(K.Schema.int),type:xt(n)(K.Schema.str),resnr:xt(o)(K.Schema.int),residu:xt(i)(K.Schema.str),atom:xt(a)(K.Schema.str),cgnr:xt(s)(K.Schema.int),charge:xt(l)(K.Schema.float),mass:xt(c)(K.Schema.float)})}function Abe(t){let{tokenizer:e}=t,r=Ce.create(e.data,64),n=Ce.create(e.data,64);for(;e.tokenEnd<e.length;){nh(e);let o=e.data[e.position];if(o==="[")break;if(o===";"||o==="*"){rh(e);continue}for(let i=0;i<2;++i)switch(nh(e),kw(e),eR(e),i){case 0:Ce.add(r,e.tokenStart,e.tokenEnd);break;case 1:Ce.add(n,e.tokenStart,e.tokenEnd);break}rh(e)}return Xo.ofColumns(Cbe,{ai:xt(r)(K.Schema.int),aj:xt(n)(K.Schema.int)})}function kbe(t){let{tokenizer:e}=t,r;for(;e.tokenEnd<e.length;){nh(e);let n=e.data[e.position];if(n==="[")break;if(n===";"||n==="*"){rh(e);continue}if(r!==void 0)throw new Error("more than one system");r=J3(e).trim()}if(r===void 0)throw new Error("missing system");return r}function Mbe(t){let{tokenizer:e}=t,r=Ce.create(e.data,64),n=Ce.create(e.data,64);for(;e.tokenEnd<e.length&&(nh(e),!(e.position>=e.length));){let o=e.data[e.position];if(o==="[")break;if(o===";"||o==="*"){rh(e);continue}for(let i=0;i<2;++i)switch(nh(e),kw(e),eR(e),i){case 0:Ce.add(r,e.tokenStart,e.tokenEnd);break;case 1:Ce.add(n,e.tokenStart,e.tokenEnd);break}wbe(e),kw(e)}return Xo.ofColumns(Tbe,{compound:xt(r)(K.Schema.str),molCount:xt(n)(K.Schema.int)})}function Rbe(t,e){return N(this,null,function*(){let r=Fe(t),n=_be(r,e),o=Object.create(null),i=0;o.compounds={};let a={},s="";function l(){s&&a.atoms&&(o.compounds[s]=a,a={},s="")}for(;r.tokenEnd<r.length;){r.position-i>1e5&&e.shouldUpdate&&(i=r.position,yield e.update({current:r.position,max:r.length}));let c=J3(n.tokenizer).trim();if(!(!c||c[0]==="*"||c[0]===";")){if(c.startsWith("#include"))throw new Error("#include statements not allowed");if(c.startsWith("[")){let u=c.match(Pbe);if(u===null)throw new Error("expected field name");let d=u[1];if(d==="moleculetype")l(),s=Ibe(n);else if(d==="atoms")a.atoms=Dbe(n);else if(d==="bonds")a.bonds=Abe(n);else if(d==="system")o.system=kbe(n);else if(d==="molecules")l(),o.molecules=Mbe(n);else for(;r.tokenEnd<r.length&&r.data[r.position]!=="[";)rh(r)}}}return xr.success(o)})}function yX(t){return ie.create("Parse TOP",e=>N(this,null,function*(){return yield Rbe(t,e)}))}var tR=Je.BuiltIn({name:"download",display:{name:"Download",description:"Download string or binary data from the specified URL"},from:[X.Root],to:[X.Data.String,X.Data.Binary],params:{url:g.Url("https://www.ebi.ac.uk/pdbe/static/entry/1cbs_updated.cif",{description:"Resource URL. Must be the same domain or support CORS."}),label:g.Optional(g.Text("")),isBinary:g.Optional(g.Boolean(!1,{description:"If true, download data as binary (string otherwise)"}))}})({apply({params:t,cache:e},r){return ie.create("Download",n=>N(this,null,function*(){let o=Wr.getUrlAsset(r.managers.asset,t.url),i=yield r.managers.asset.resolve(o,t.isBinary?"binary":"string").runInContext(n);return e.asset=i,t.isBinary?new X.Data.Binary(i.data,{label:t.label?t.label:o.url}):new X.Data.String(i.data,{label:t.label?t.label:o.url})}))},dispose({cache:t}){var e;(e=t?.asset)===null||e===void 0||e.dispose()},update({oldParams:t,newParams:e,b:r}){return t.url!==e.url||t.isBinary!==e.isBinary?Se.UpdateResult.Recreate:t.label!==e.label?(r.label=e.label||(typeof e.url=="string"?e.url:e.url.url),Se.UpdateResult.Updated):Se.UpdateResult.Unchanged}}),rR=Je.BuiltIn({name:"download-blob",display:{name:"Download Blob",description:"Download multiple string or binary data from the specified URLs."},from:X.Root,to:X.Data.Blob,params:{sources:g.ObjectList({id:g.Text("",{label:"Unique ID"}),url:g.Url("https://www.ebi.ac.uk/pdbe/static/entry/1cbs_updated.cif",{description:"Resource URL. Must be the same domain or support CORS."}),isBinary:g.Optional(g.Boolean(!1,{description:"If true, download data as binary (string otherwise)"})),canFail:g.Optional(g.Boolean(!1,{description:"Indicate whether the download can fail and not be included in the blob as a result."}))},t=>`${t.id}: ${t.url}`),maxConcurrency:g.Optional(g.Numeric(4,{min:1,max:12,step:1},{description:"The maximum number of concurrent downloads."}))}})({apply({params:t,cache:e},r){return ie.create("Download Blob",n=>N(this,null,function*(){let o=[],i=yield PU(n,r.managers.asset,t.sources,t.maxConcurrency||4),a=[];for(let s=0;s<i.length;s++){let l=i[s],c=t.sources[s];l.kind==="error"?r.log.warn(`Download ${l.id} (${c.url}) failed: ${l.error}`):(a.push(l.result),o.push(c.isBinary?{id:l.id,kind:"binary",data:l.result.data}:{id:l.id,kind:"string",data:l.result.data}))}return e.assets=a,new X.Data.Blob(o,{label:"Data Blob",description:`${o.length} ${o.length===1?"entry":"entries"}`})}))},dispose({cache:t},e){let r=t?.assets;if(r)for(let n of r)n.dispose()}}),nR=Je.BuiltIn({name:"raw-data",display:{name:"Raw Data",description:"Raw data supplied by value."},from:[X.Root],to:[X.Data.String,X.Data.Binary],params:{data:g.Value("",{isHidden:!0}),label:g.Optional(g.Text(""))}})({apply({params:t}){return ie.create("Raw Data",()=>N(this,null,function*(){if(typeof t.data=="string")return new X.Data.String(t.data,{label:t.label?t.label:"String"});if(Array.isArray(t.data))return new X.Data.Binary(new Uint8Array(t.data),{label:t.label?t.label:"Binary"});if(t.data instanceof ArrayBuffer)return new X.Data.Binary(new Uint8Array(t.data),{label:t.label?t.label:"Binary"});if(t.data instanceof Uint8Array)return new X.Data.Binary(t.data,{label:t.label?t.label:"Binary"});ur(t.data)}))},update({oldParams:t,newParams:e,b:r}){return t.data!==e.data?Se.UpdateResult.Recreate:t.label!==e.label?(r.label=e.label||r.label,Se.UpdateResult.Updated):Se.UpdateResult.Unchanged},customSerialization:{toJSON(t){if(typeof t.data=="string"||Array.isArray(t.data))return t;if(t.data instanceof ArrayBuffer){let e=new Uint8Array(t.data),r=new Array(e.length);for(let n=0,o=e.length;n<o;n++)r[n]=e[n];return{data:r,label:t.label}}else if(t.data instanceof Uint8Array){let e=new Array(t.data.length);for(let r=0,n=t.data.length;r<n;r++)e[r]=t.data[r];return{data:e,label:t.label}}},fromJSON(t){return t}}}),oR=Je.BuiltIn({name:"read-file",display:{name:"Read File",description:"Read string or binary data from the specified file"},from:X.Root,to:[X.Data.String,X.Data.Binary],params:{file:g.File(),label:g.Optional(g.Text("")),isBinary:g.Optional(g.Boolean(!1,{description:"If true, open file as as binary (string otherwise)"}))}})({apply({params:t,cache:e},r){return ie.create("Open File",n=>N(this,null,function*(){if(t.file===null)return r.log.error("No file(s) selected"),Rr.Null;let o=yield r.managers.asset.resolve(t.file,t.isBinary?"binary":"string").runInContext(n);return e.asset=o,t.isBinary?new X.Data.Binary(o.data,{label:t.label?t.label:t.file.name}):new X.Data.String(o.data,{label:t.label?t.label:t.file.name})}))},dispose({cache:t}){var e;(e=t?.asset)===null||e===void 0||e.dispose()},update({oldParams:t,newParams:e,b:r}){var n;return t.label!==e.label?(r.label=e.label||((n=t.file)===null||n===void 0?void 0:n.name)||"",Se.UpdateResult.Updated):Se.UpdateResult.Unchanged},isSerializable:()=>({isSerializable:!1,reason:"Cannot serialize user loaded files."})}),Lbe=Je.BuiltIn({name:"parse-blob",display:{name:"Parse Blob",description:"Parse multiple data enties"},from:X.Data.Blob,to:X.Format.Blob,params:{formats:g.ObjectList({id:g.Text("",{label:"Unique ID"}),format:g.Select("cif",[["cif","cif"]])},t=>`${t.id}: ${t.format}`)}})({apply({a:t,params:e},r){return ie.create("Parse Blob",n=>N(this,null,function*(){let o=new Map;for(let a of e.formats)o.set(a.id,a.format);let i=[];for(let a of t.data){if(!o.has(a.id))continue;let s=yield(a.kind==="string"?lc.parse(a.data):lc.parseBinary(a.data)).runInContext(n);if(s.isError)throw new Error(`${a.id}: ${s.message}`);i.push({id:a.id,kind:"cif",data:s.result})}return new X.Format.Blob(i,{label:"Format Blob",description:`${i.length} ${i.length===1?"entry":"entries"}`})}))}}),Bbe=Je.BuiltIn({name:"parse-cif",display:{name:"Parse CIF",description:"Parse CIF from String or Binary data"},from:[X.Data.String,X.Data.Binary],to:X.Format.Cif})({apply({a:t}){return ie.create("Parse CIF",e=>N(this,null,function*(){let r=yield(typeof t.data=="string"?lc.parse(t.data):lc.parseBinary(t.data)).runInContext(e);if(r.isError)throw new Error(r.message);return r.result.blocks.length===0?Rr.Null:new X.Format.Cif(r.result)}))}}),Obe=Je.BuiltIn({name:"parse-cube",display:{name:"Parse Cube",description:"Parse Cube from String data"},from:X.Data.String,to:X.Format.Cube})({apply({a:t}){return ie.create("Parse Cube",e=>N(this,null,function*(){let r=yield dX(t.data,t.label).runInContext(e);if(r.isError)throw new Error(r.message);return new X.Format.Cube(r.result)}))}}),Fbe=Je.BuiltIn({name:"parse-psf",display:{name:"Parse PSF",description:"Parse PSF from String data"},from:[X.Data.String],to:X.Format.Psf})({apply({a:t}){return ie.create("Parse PSF",e=>N(this,null,function*(){let r=yield cX(t.data).runInContext(e);if(r.isError)throw new Error(r.message);return new X.Format.Psf(r.result)}))}}),Nbe=Je.BuiltIn({name:"parse-prmtop",display:{name:"Parse PRMTOP",description:"Parse PRMTOP from String data"},from:[X.Data.String],to:X.Format.Prmtop})({apply({a:t}){return ie.create("Parse PRMTOP",e=>N(this,null,function*(){let r=yield gX(t.data).runInContext(e);if(r.isError)throw new Error(r.message);return new X.Format.Prmtop(r.result)}))}}),Vbe=Je.BuiltIn({name:"parse-top",display:{name:"Parse TOP",description:"Parse TOP from String data"},from:[X.Data.String],to:X.Format.Top})({apply({a:t}){return ie.create("Parse TOP",e=>N(this,null,function*(){let r=yield yX(t.data).runInContext(e);if(r.isError)throw new Error(r.message);return new X.Format.Top(r.result)}))}}),zbe=Je.BuiltIn({name:"parse-ply",display:{name:"Parse PLY",description:"Parse PLY from String data"},from:[X.Data.String],to:X.Format.Ply})({apply({a:t}){return ie.create("Parse PLY",e=>N(this,null,function*(){let r=yield aX(t.data).runInContext(e);if(r.isError)throw new Error(r.message);return new X.Format.Ply(r.result,{label:r.result.comments[0]||"PLY Data"})}))}}),Ube=Je.BuiltIn({name:"parse-ccp4",display:{name:"Parse CCP4/MRC/MAP",description:"Parse CCP4/MRC/MAP from Binary data"},from:[X.Data.Binary],to:X.Format.Ccp4})({apply({a:t}){return ie.create("Parse CCP4/MRC/MAP",e=>N(this,null,function*(){let r=yield tX(t.data,t.label).runInContext(e);if(r.isError)throw new Error(r.message);return new X.Format.Ccp4(r.result)}))}}),Gbe=Je.BuiltIn({name:"parse-dsn6",display:{name:"Parse DSN6/BRIX",description:"Parse CCP4/BRIX from Binary data"},from:[X.Data.Binary],to:X.Format.Dsn6})({apply({a:t}){return ie.create("Parse DSN6/BRIX",e=>N(this,null,function*(){let r=yield nX(t.data,t.label).runInContext(e);if(r.isError)throw new Error(r.message);return new X.Format.Dsn6(r.result)}))}}),jbe=Je.BuiltIn({name:"parse-dx",display:{name:"Parse DX",description:"Parse DX from Binary/String data"},from:[X.Data.Binary,X.Data.String],to:X.Format.Dx})({apply({a:t}){return ie.create("Parse DX",e=>N(this,null,function*(){let r=yield pX(t.data,t.label).runInContext(e);if(r.isError)throw new Error(r.message);return new X.Format.Dx(r.result)}))}}),Hbe=Je.BuiltIn({name:"import-string",display:{name:"Import String",description:"Import given data as a string"},from:X.Root,to:X.Data.String,params:{data:g.Value(""),label:g.Optional(g.Text(""))}})({apply({params:{data:t,label:e}}){return new X.Data.String(t,{label:e||""})},update({oldParams:t,newParams:e,b:r}){return t.data!==e.data?Se.UpdateResult.Recreate:t.label!==e.label?(r.label=e.label||"",Se.UpdateResult.Updated):Se.UpdateResult.Unchanged},isSerializable:()=>({isSerializable:!1,reason:"Cannot serialize user imported strings."})}),qbe=Je.BuiltIn({name:"import-json",display:{name:"Import JSON",description:"Import given data as a JSON"},from:X.Root,to:X.Format.Json,params:{data:g.Value({}),label:g.Optional(g.Text(""))}})({apply({params:{data:t,label:e}}){return new X.Format.Json(t,{label:e||""})},update({oldParams:t,newParams:e,b:r}){return t.data!==e.data?Se.UpdateResult.Recreate:t.label!==e.label?(r.label=e.label||"",Se.UpdateResult.Updated):Se.UpdateResult.Unchanged},isSerializable:()=>({isSerializable:!1,reason:"Cannot serialize user imported JSON."})}),Wbe=Je.BuiltIn({name:"parse-json",display:{name:"Parse JSON",description:"Parse JSON from String data"},from:[X.Data.String],to:X.Format.Json})({apply({a:t}){return ie.create("Parse JSON",e=>N(this,null,function*(){let r=yield new Response(t.data).json();return new X.Format.Json(r)}))}}),Xbe=Je.BuiltIn({name:"lazy-volume",display:{name:"Lazy Volume",description:"A placeholder for lazy loaded volume representation"},from:X.Root,to:X.Volume.Lazy,params:{url:g.Url(""),isBinary:g.Boolean(!1),format:g.Text("ccp4"),entryId:g.Value("",{isHidden:!0}),isovalues:g.ObjectList({type:g.Text("relative"),value:g.Numeric(0),color:g.Color(ut.black),alpha:g.Numeric(1,{min:0,max:1,step:.01}),volumeIndex:g.Numeric(0)},t=>`${t.type} ${t.value}`)}})({apply({a:t,params:e}){return ie.create("Lazy Volume",r=>N(this,null,function*(){let n=Array.isArray(e.entryId)?e.entryId.join(", "):e.entryId;return new X.Volume.Lazy(e,{label:`${n||e.url}`,description:"Lazy Volume"})}))}});var aR={};ua(aR,{CreateGroup:()=>Ybe});var Ybe=Je.BuiltIn({name:"create-group",display:{name:"Group"},from:[],to:X.Group,params:{label:g.Text("Group"),description:g.Optional(g.Text(""))}})({apply({params:t}){return new X.Group({},t)},update({oldParams:t,newParams:e,b:r}){return Cg(t,e)?Se.UpdateResult.Unchanged:(r.label=e.label,r.description=e.description,Se.UpdateResult.Updated)}});var OR={};ua(OR,{CoordinatesFromDcd:()=>X1e,CoordinatesFromNctraj:()=>K1e,CoordinatesFromTrr:()=>Q1e,CoordinatesFromXtc:()=>Y1e,CustomModelProperties:()=>LR,CustomStructureProperties:()=>BR,ModelFromTrajectory:()=>RR,MultiStructureSelectionFromExpression:()=>ySe,ShapeFromPly:()=>TSe,StructureComplexElement:()=>SSe,StructureComplexElementTypes:()=>GY,StructureComponent:()=>CSe,StructureFromModel:()=>fSe,StructureFromTrajectory:()=>pSe,StructureSelectionFromBundle:()=>bSe,StructureSelectionFromExpression:()=>gSe,StructureSelectionFromScript:()=>vSe,TopologyFromPrmtop:()=>Z1e,TopologyFromPsf:()=>$1e,TopologyFromTop:()=>J1e,TrajectoryFromBlob:()=>tSe,TrajectoryFromCifCore:()=>uSe,TrajectoryFromCube:()=>cSe,TrajectoryFromGRO:()=>oSe,TrajectoryFromMOL:()=>aSe,TrajectoryFromMOL2:()=>lSe,TrajectoryFromMmCif:()=>rSe,TrajectoryFromModelAndCoordinates:()=>Nw,TrajectoryFromPDB:()=>nSe,TrajectoryFromSDF:()=>sSe,TrajectoryFromXYZ:()=>iSe,TransformStructureConformation:()=>hSe});function Qbe(t){let e=new DataView(t.buffer),r=Object.create(null),n=[],o=0,i=new Int32Array(t.buffer,0,23),a=i[0]!==e.getInt32(0);if(i[0]!==84){let f=t.byteLength;for(let b=0;b<f;b+=4)e.setFloat32(b,e.getFloat32(b),!0)}if(i[0]!==84)throw new Error("dcd bad format, header block start");if(String.fromCharCode(e.getUint8(4),e.getUint8(5),e.getUint8(6),e.getUint8(7))!=="CORD")throw new Error("dcd bad format, format string");let l=!1,c=!1,u=!1;if(i[22]!==0&&(l=!0,i[12]!==0&&(c=!0),i[13]===1&&(u=!0)),r.NSET=i[2],r.ISTART=i[3],r.NSAVC=i[4],r.NAMNF=i[10],l?r.DELTA=e.getFloat32(44,a):r.DELTA=e.getFloat64(44,a),i[22]!==84)throw new Error("dcd bad format, header block end");o=o+21*4+8;let d=e.getInt32(o,a),m=o+1;if((d-4)%80!==0)throw new Error("dcd bad format, title block start");if(r.TITLE=nU(t.subarray(m,d)),e.getInt32(m+d+4-1,a)!==d)throw new Error("dcd bad format, title block end");if(o=o+d+8,e.getInt32(o,a)!==4)throw new Error("dcd bad format, natom block start");if(r.NATOM=e.getInt32(o+4,a),e.getInt32(o+8,a)!==4)throw new Error("dcd bad format, natom block end");if(o=o+4+8,r.NAMNF>0)throw new Error("dcd format with fixed atoms unsupported, aborting");let p=r.NATOM,h=p*4;for(let f=0,b=r.NSET;f<b;++f){let v=Object.create(null);v.elementCount=p,c&&(o+=4,v.cell=[e.getFloat64(o,a),e.getFloat64(o+1,a),e.getFloat64(o+2*8,a),e.getFloat64(o+3*8,a),e.getFloat64(o+4*8,a),e.getFloat64(o+5*8,a)],o+=48,o+=4);for(let x=0;x<3;++x){if(e.getInt32(o,a)!==h)throw new Error(`dcd bad format, coord block start: ${f}, ${x}`);o+=4;let S=new Float32Array(t.buffer,o,p);if(x===0?v.x=S:x===1?v.y=S:v.z=S,o+=h,e.getInt32(o,a)!==h)throw new Error(`dcd bad format, coord block end: ${f}, ${x}`);o+=4}if(u){let x=e.getInt32(o,a);o+=4+x+4}n.push(v)}return{header:r,frames:n}}function vX(t){return ie.create("Parse DCD",e=>N(this,null,function*(){try{let r=Qbe(t);return xr.success(r)}catch(r){return xr.error(r)}}))}function bX(t){return function(e,r,n){return Kbe(t,e,r,n)}}function Kbe(t,e,r,n){let{data:o,indices:i,count:a}=t,{valueType:s}=n,l=s==="str"?c=>{let u=i[2*c]+e,d=i[2*c+1];if(u>=d)return"";let m=u+r;return m>d&&(m=d),vU(o,u,m)}:s==="int"?c=>{let u=i[2*c]+e;return u>i[2*c+1]?0:tp(o,u,u+r)}:c=>{let u=i[2*c]+e;return u>i[2*c+1]?0:Dz(o,u,u+r)};return{schema:n,__array:void 0,isDefined:!0,rowCount:a,value:l,valueKind:c=>0,toArray:c=>Iz.createAndFillArray(a,l,c),areValuesEqual:(c,u)=>l(c)===l(u)}}function $be(){return{title:"",timeInPs:0,hasVelocities:!1,precision:{position:0,velocity:0},box:[0,0,0]}}function Zbe(t,e){return{tokenizer:t,header:$be(),numberOfAtoms:0,runtimeCtx:e}}function Jbe(t){let{tokenizer:e,header:r}=t,n=Fe.readLine(e);n.trim().length===0&&(n=Fe.readLine(e));let o=n.lastIndexOf("t=");o>=0?(r.timeInPs=parseFloat(n.substring(o+2)),r.title=n.substring(0,o).trim(),r.title&&r.title[r.title.length-1]===","&&(r.title=r.title.substring(0,r.title.length-1))):r.title=n}function exe(t){let{tokenizer:e}=t;Fe.markLine(e);let r=Fe.getTokenString(e);t.numberOfAtoms=parseInt(r)}function txe(t){return N(this,null,function*(){let{tokenizer:e,numberOfAtoms:r}=t,n=yield Fe.readLinesAsync(e,r,t.runtimeCtx,1e5),i=e.data.substring(n.indices[0],n.indices[1]).substring(20).match(/\.\d+/g),a=i.length===6;t.header.hasVelocities=a,t.header.precision.position=i[0].length-1,t.header.precision.velocity=a?i[3].length-1:0;let s=20,l=t.header.precision.position+5,c=s+3*l,u=t.header.precision.velocity+4,d=bX(n),m=K.Undefined(t.numberOfAtoms,K.Schema.float);return{count:t.numberOfAtoms,residueNumber:d(0,5,K.Schema.int),residueName:d(5,5,K.Schema.str),atomName:d(10,5,K.Schema.str),atomNumber:d(15,5,K.Schema.int),x:d(s,l,K.Schema.float),y:d(s+l,l,K.Schema.float),z:d(s+2*l,l,K.Schema.float),vx:a?d(c,u,K.Schema.float):m,vy:a?d(c+u,u,K.Schema.float):m,vz:a?d(c+2*u,u,K.Schema.float):m}})}function rxe(t){let{tokenizer:e}=t,r=Fe.readLine(e).trim().split(/\s+/g);t.header.box=[+r[0],+r[1],+r[2]]}function nxe(t,e){return N(this,null,function*(){let r=Fe(t);yield e.update({message:"Parsing...",current:0,max:t.length});let n=[];for(;r.position<t.length;){let i=Zbe(r,e);Jbe(i),exe(i);let a=yield txe(i);rxe(i),n.push({header:i.header,atoms:a})}let o={structures:n};return xr.success(o)})}function xX(t){return ie.create("Parse GRO",e=>N(this,null,function*(){return yield nxe(t,e)}))}function SX(t,e,r=!1){return ie.create("Parse PDB",n=>N(this,null,function*(){return xr.success({lines:yield Fe.readAllLinesAsync(t,n),id:e,isPdbqt:r})}))}function _X(t){let e=t&&t.getElement("vertex"),r=t&&t.getElement("material"),n={group:"",vRed:"",vGreen:"",vBlue:"",mRed:"",mGreen:"",mBlue:""},o=[["",""]],i=[["",""]];if(e){for(let l=0,c=e.propertyNames.length;l<c;++l){let u=e.propertyNames[l],d=e.propertyTypes[l];(d==="uchar"||d==="uint8"||d==="ushort"||d==="uint16"||d==="uint"||d==="uint32"||d==="int")&&o.push([u,u]),(d==="uchar"||d==="uint8")&&i.push([u,u])}e.propertyNames.includes("atomid")?n.group="atomid":e.propertyNames.includes("material_index")&&(n.group="material_index"),e.propertyNames.includes("red")&&(n.vRed="red"),e.propertyNames.includes("green")&&(n.vGreen="green"),e.propertyNames.includes("blue")&&(n.vBlue="blue")}let a=[["",""]];if(r){for(let l=0,c=r.propertyNames.length;l<c;++l){let u=r.propertyNames[l],d=r.propertyTypes[l];(d==="uchar"||d==="uint8")&&a.push([u,u])}r.propertyNames.includes("red")&&(n.mRed="red"),r.propertyNames.includes("green")&&(n.mGreen="green"),r.propertyNames.includes("blue")&&(n.mBlue="blue")}let s=n.vRed&&n.vGreen&&n.vBlue?"vertex":n.mRed&&n.mGreen&&n.mBlue?"material":"uniform";return U(w({},Be.Params),{coloring:g.MappedStatic(s,{vertex:g.Group({red:g.Select(n.vRed,i,{label:"Red Property"}),green:g.Select(n.vGreen,i,{label:"Green Property"}),blue:g.Select(n.vBlue,i,{label:"Blue Property"})},{isFlat:!0}),material:g.Group({red:g.Select(n.mRed,a,{label:"Red Property"}),green:g.Select(n.mGreen,a,{label:"Green Property"}),blue:g.Select(n.mBlue,a,{label:"Blue Property"})},{isFlat:!0}),uniform:g.Group({color:g.Color(ut.grey),saturation:g.Numeric(0,{min:-6,max:6,step:.1}),lightness:g.Numeric(0,{min:-6,max:6,step:.1})},{isFlat:!0})}),grouping:g.MappedStatic(n.group?"vertex":"none",{vertex:g.Group({group:g.Select(n.group,o,{label:"Group Property"})},{isFlat:!0}),none:g.Group({})})})}var CX=_X();function oxe(t,e,r,n,o){let{vertices:i,normals:a,groups:s}=r,l=n.getProperty("x"),c=n.getProperty("y"),u=n.getProperty("z");if(!l||!c||!u)throw new Error("missing coordinate properties");let d=n.getProperty("nx"),m=n.getProperty("ny"),p=n.getProperty("nz"),h=!!d&&!!m&&!!p;for(let f=t;f<e;++f)he.add3(i,l.value(f),c.value(f),u.value(f)),h&&he.add3(a,d.value(f),m.value(f),p.value(f)),he.add(s,o[f])}function ixe(t,e,r,n){let{indices:o}=r;for(let i=t;i<e;++i){let{entries:a,count:s}=n.value(i);s===3?he.add3(o,a[0],a[1],a[2]):s===4&&(he.add3(o,a[2],a[1],a[0]),he.add3(o,a[2],a[0],a[3]))}}function axe(t,e,r,n,o){return N(this,null,function*(){let i=Te.createState(e.rowCount,e.rowCount/4,o),a=e.getProperty("x"),s=e.getProperty("y"),l=e.getProperty("z");if(!a||!s||!l)throw new Error("missing coordinate properties");let c=e.getProperty("nx"),u=e.getProperty("ny"),d=e.getProperty("nz"),m=!!c&&!!u&&!!d,p=1e5;for(let f=0,b=e.rowCount;f<b;f+=p)oxe(f,Math.min(f+p,b),i,e,n),t.shouldUpdate&&(yield t.update({message:"adding ply mesh vertices",current:f,max:b}));for(let f=0,b=r.rowCount;f<b;f+=p)ixe(f,Math.min(f+p,b),i,r),t.shouldUpdate&&(yield t.update({message:"adding ply mesh faces",current:f,max:b}));let h=Te.getMesh(i);return m||Be.computeNormals(h),C.updateIfChanged(h.varyingGroup,!0),h})}var Cp=K.Schema.int;function sxe(t,e){let{grouping:r}=e,{rowCount:n}=t,o=r.name==="vertex"?t.getProperty(r.params.group):void 0,i=r.name==="vertex"?ic(r.params.group):"Vertex",a=o?o.toArray({array:Uint32Array}):Ri(new Uint32Array(n)),s=o?Mi(a):n-1,l=new Uint32Array(s+1);for(let c=0,u=a.length;c<u;++c)l[a[c]]=c;return{ids:a,map:l,label:i}}function TX(t,e,r){let{coloring:n}=r,{rowCount:o}=t,i,a,s;if(n.name==="vertex")i=t.getProperty(n.params.red)||K.ofConst(127,o,Cp),a=t.getProperty(n.params.green)||K.ofConst(127,o,Cp),s=t.getProperty(n.params.blue)||K.ofConst(127,o,Cp);else if(n.name==="material")i=e&&e.getProperty(n.params.red)||K.ofConst(127,o,Cp),a=e&&e.getProperty(n.params.green)||K.ofConst(127,o,Cp),s=e&&e.getProperty(n.params.blue)||K.ofConst(127,o,Cp);else{let l=n.params.color;l=ce.saturate(l,n.params.saturation),l=ce.lighten(l,n.params.lightness);let[c,u,d]=ce.toRgb(l);i=K.ofConst(c,o,Cp),a=K.ofConst(u,o,Cp),s=K.ofConst(d,o,Cp)}return{kind:n.name,red:i,green:a,blue:s}}function wX(t,e,r,n){let{kind:o,red:i,green:a,blue:s}=r,{ids:l,map:c,label:u}=n,{source:d,transforms:m}=t;return Yt.create("ply-mesh",d,e,p=>{let h=o==="material"?p:c[p];return ce.fromRgb(i.value(h),a.value(h),s.value(h))},()=>1,p=>`${u} ${l[p]}`,m)}function lxe(){let t,e,r,n,o,i;return(s,l,c,u)=>N(this,null,function*(){let d=l.source.getElement("vertex");if(!d)throw new Error("missing vertex element");let m=l.source.getElement("face");if(!m)throw new Error("missing face element");let p=l.source.getElement("material"),h=!1,f=!1;return(!t||t!==t)&&(h=!0),(!e||!g.isParamEqual(CX.grouping,e.grouping,c.grouping))&&(h=!0),(!e||!g.isParamEqual(CX.coloring,e.coloring,c.coloring))&&(f=!0),h?(o=TX(d,p,c),i=sxe(d,c),n=yield axe(s,d,m,i.ids,u&&u.geometry),r=wX(l,n,o,i)):f&&(o=TX(d,p,c),r=wX(l,n,o,i)),t=l,e=$s(c),r})}function PX(t,e){return ie.create("Shape Provider",r=>N(this,null,function*(){return{label:"Mesh",data:{source:t,transforms:e?.transforms},params:_X(t),getShape:lxe(),geometryUtils:Be.Utils}}))}function Cc(){return Cc.empty()}(function(t){function e(o,i){return{size:o,anglesInRadians:i}}t.create=e;function r(){return e(y(),y())}t.empty=r;function n(o,i,a){let s=y.magnitude(o),l=y.magnitude(i),c=y.magnitude(a),u=Math.acos(y.dot(i,a)/(l*c)),d=Math.acos(y.dot(o,a)/(s*c)),m=Math.acos(y.dot(o,i)/(s*l));return s<=0||l<=0||c<=0||u>=Math.PI||d>=Math.PI||m>=Math.PI?r():e(y.create(s,l,c),y.create(u,d,m))}t.fromBasis=n})(Cc||(Cc={}));var cxe=20.45482949774598;function EX(t){return ie.create("Parse DCD",e=>N(this,null,function*(){yield e.update("Converting to coordinates");let{header:r}=t,n=r.DELTA?ma(r.DELTA*cxe,"ps"):ma(1,"step"),o=r.ISTART>=1?ma((r.ISTART-1)*n.value,n.unit):ma(0,n.unit),i=[];for(let a=0,s=t.frames.length;a<s;++a){let l=t.frames[a],c={elementCount:l.elementCount,time:ma(o.value+n.value*a,n.unit),x:l.x,y:l.y,z:l.z,xyzOrdering:{isIdentity:!0}};if(l.cell){let u=l.cell;u[1]>=-1&&u[1]<=1&&u[3]>=-1&&u[3]<=1&&u[4]>=-1&&u[4]<=1?c.cell=Cc.create(y.create(u[0],u[2],u[5]),y.create(or(90-Math.asin(u[1])*90/Sg),or(90-Math.asin(u[3])*90/Sg),or(90-Math.asin(u[4])*90/Sg))):u[0]<0||u[1]<0||u[2]<0||u[3]<0||u[4]<0||u[5]<0||u[3]>180||u[4]>180||u[5]>180?c.cell=Cc.fromBasis(y.create(u[0],u[1],u[3]),y.create(u[1],u[2],u[4]),y.create(u[3],u[4],u[5])):c.cell=Cc.create(y.create(u[0],u[2],u[5]),y.create(or(bs(u[1],0,1e-6)?90:u[1]),or(bs(u[3],0,1e-6)?90:u[3]),or(bs(u[4],0,1e-6)?90:u[4])))}i.push(c)}return sf.create(i,n,o)}))}function Pv(t,e,r,n){let o=r,i=n-1,a=e.charCodeAt(o);for(;(a===32||a>=48&&a<=57)&&o<=i;)a=e.charCodeAt(++o);for(a=e.charCodeAt(i);(a===32||a>=48&&a<=57)&&i>=o;)a=e.charCodeAt(--i);if(++i,o===i)return Ce.add(t,o,i);if(o+1===i)return Ce.add(t,o,i);if(a=e.charCodeAt(o),o+2===i){let s=e.charCodeAt(o+1);if((a===78||a===110)&&(s===65||s===97)||(a===67||a===99)&&(s===76||s===108)||(a===70||a===102)&&(s===69||s===101)||(a===83||a===115)&&(s===73||s===105)||(a===66||a===98)&&(s===82||s===114)||(a===65||a===97)&&(s===83||s===115))return Ce.add(t,o,o+2)}if(a===67||a===99||a===72||a===104||a===78||a===110||a===79||a===111||a===80||a===112||a===83||a===115)return Ce.add(t,o,o+1);Ce.add(t,o,o)}var uxe=new Set(["NA","CL","FE","SI","BR","AS","LI"]),dxe=new Set(["C","H","N","O","P","S","F","B"]),mxe=/^[\s\d]+|[\s\d]+$/g;function vu(t,e){t=t.replace(mxe,"").toUpperCase();let r=t.length;if(r===0||r===1||uxe.has(t))return t;if(r===3&&e===t){if(t==="SOD")return"NA";if(t==="POT")return"K";if(t==="CES")return"CS";if(t==="CAL")return"CA";if(t==="CLA")return"CL"}return dxe.has(t[0])?t[0]:""}var sR="ABCDEFGHIJKLMNOPQRSTUVWXYZ";function pxe(t){let e=sR.length,r=t,n=0,o=sR[r%e];for(;r>=e;)r=Math.floor(r/e),o+=sR[r%e],n+=1;return n>=5&&console.warn("getChainId overflow"),o}var Tp=Pg(pxe);function fxe(t,e){let r=t.atomName,n=t.residueName,o=new Array(t.count),i=new Array(t.count),a=new Uint32Array(t.count),s=new Uint32Array(t.count),l=new Array(t.count),c=new Oi,u=new Fi(t.residueNumber,t.atomName),d="",m=0,p="",h=0,f=0,b=-1;for(let S=0,T=t.count;S<T;++S){let E=t.residueNumber.value(S);if(E!==b){let _=t.residueName.value(S),D=im(u.add(_,S).type,_);(D!==f||E!==b+1&&!(b===99999&&E===0))&&(p=Tp(m),m+=1,h=0),d=c.getEntityId(_,D,p),h+=1,b=E,f=D}o[S]=d,i[S]=p,a[S]=h,s[S]=S,l[S]=vu(t.atomName.value(S),t.residueName.value(S))}let v=K.ofStringArray(i),x=Xo.ofPartialColumns(ha.atom_site,{auth_asym_id:v,auth_atom_id:r,auth_comp_id:n,auth_seq_id:t.residueNumber,Cartn_x:K.ofFloatArray(K.mapToArray(t.x,S=>S*10,Float32Array)),Cartn_y:K.ofFloatArray(K.mapToArray(t.y,S=>S*10,Float32Array)),Cartn_z:K.ofFloatArray(K.mapToArray(t.z,S=>S*10,Float32Array)),id:K.ofIntArray(s),label_asym_id:v,label_atom_id:r,label_comp_id:n,label_seq_id:K.ofIntArray(a),label_entity_id:K.ofStringArray(o),occupancy:K.ofConst(1,t.count,K.Schema.float),type_symbol:K.ofStringArray(l),pdbx_PDB_model_num:K.ofConst(e,t.count,K.Schema.int)},t.count);return Bi({entity:c.getEntityTable(),chem_comp:u.getChemCompTable(),atom_site:x})}var lR;(function(t){function e(n){return n?.kind==="gro"}t.is=e;function r(n){return{kind:"gro",name:n.structures[0].header.title,data:n}}t.fromGro=r})(lR||(lR={}));function IX(t){return ie.create("Parse GRO",e=>N(this,null,function*(){let r=lR.fromGro(t),n=[];for(let o=0,i=t.structures.length;o<i;++o){let a=fxe(t.structures[o].atoms,o+1),s=yield wl(a,r,e);s.frameCount===1&&n.push(s.representative)}return new yf(n)}))}function AX(t,e){let r=(i,a)=>(e.substr(i,a)||"").trim(),n={entry_id:Ge.ofString(t),length_a:Ge.ofString(r(6,9)),length_b:Ge.ofString(r(15,9)),length_c:Ge.ofString(r(24,9)),angle_alpha:Ge.ofString(r(33,7)),angle_beta:Ge.ofString(r(40,7)),angle_gamma:Ge.ofString(r(47,7)),Z_PDB:Ge.ofString(r(66,4)),pdbx_unique_axis:Ge.ofString("?")},o={entry_id:Ge.ofString(t),"space_group_name_H-M":Ge.ofString(r(55,11)),Int_Tables_number:Ge.ofString("?"),cell_setting:Ge.ofString("?"),space_group_name_Hall:Ge.ofString("?")};return[Li.ofFields("cell",n),Li.ofFields("symmetry",o)]}function DX(t,e){return{id:t,details:e,groups:[]}}function kX(t,e,r){let n=[],o,i,a,s=1,l=1,c=f=>t.data.substring(t.indices[2*f],t.indices[2*f+1]);for(let f=e;f<r;f++){let b=c(f);if(b.substr(11,12)==="BIOMOLECULE:"){let v=b.substr(23).trim(),x=`Biomolecule ${v}`;b=c(f+1),b.substr(11,30)!=="APPLY THE FOLLOWING TO CHAINS:"&&(f++,x=b.substr(11).trim()),o=DX(v,x),n.push(o)}else if(b.substr(13,5)==="BIOMT"){let v=b.split(/\s+/),x=parseInt(b[18])-1;x===0&&(a=W.identity(),i.operators.push({id:s++,matrix:a})),W.setValue(a,x,0,parseFloat(v[4])),W.setValue(a,x,1,parseFloat(v[5])),W.setValue(a,x,2,parseFloat(v[6])),W.setValue(a,x,3,parseFloat(v[7]))}else if(b.substr(11,30)==="APPLY THE FOLLOWING TO CHAINS:"||b.substr(11,30)==="                   AND CHAINS:"){b.substr(11,5)==="APPLY"&&(i={chains:[],operators:[]},o.groups.push(i));let v=b.substr(41,30).split(",");for(let x=0,S=v.length;x<S;++x){let T=v[x].trim();T&&i.chains.push(T)}}else if(b.substr(11,33)==="APPLYING THE FOLLOWING TO CHAINS:"){o=DX(`${l}`,`Biomolecule ${l}`),n.push(o),l+=1,i={chains:[],operators:[]},o.groups.push(i),f++,b=c(f);let v=b.substr(11,69).split(",");for(let x=0,S=v.length;x<S;++x){let T=v[x].trim();T&&i.chains.push(T)}}}if(n.length===0)return[];let u={id:Ge.ofStrings(n.map(f=>f.id)),details:Ge.ofStrings(n.map(f=>f.details))},d=[];for(let f of n)for(let b of f.groups)d.push({assembly_id:f.id,oper_expression:b.operators.map(v=>v.id).join(","),asym_id_list:b.chains.join(",")});let m={assembly_id:Ge.ofStrings(d.map(f=>f.assembly_id)),oper_expression:Ge.ofStrings(d.map(f=>f.oper_expression)),asym_id_list:Ge.ofStrings(d.map(f=>f.asym_id_list))},p=[];for(let f of n)for(let b of f.groups)for(let v of b.operators){let x={id:""+v.id,type:"?",name:"?",symmetry_operation:"?"};for(let S=0;S<3;S++){for(let T=0;T<3;T++)x[`matrix[${S+1}][${T+1}]`]=""+W.getValue(v.matrix,S,T);x[`vector[${S+1}]`]=""+W.getValue(v.matrix,S,3)}p.push(x)}let h={id:Ge.ofStrings(p.map(f=>f.id)),type:Ge.ofStrings(p.map(f=>f.type)),name:Ge.ofStrings(p.map(f=>f.name)),symmetry_operation:Ge.ofStrings(p.map(f=>f.symmetry_operation))};for(let f=0;f<3;f++){for(let v=0;v<3;v++){let x=`matrix[${f+1}][${v+1}]`;h[x]=Ge.ofStrings(p.map(S=>S[x]))}let b=`vector[${f+1}]`;h[b]=Ge.ofStrings(p.map(v=>v[b]))}return[Li.ofFields("pdbx_struct_assembly",u),Li.ofFields("pdbx_struct_assembly_gen",m),Li.ofFields("pdbx_struct_oper_list",h)]}function MX(t,e,r){let n=[],o,i=c=>t.data.substring(t.indices[2*c],t.indices[2*c+1]);for(let c=e;c<r;c++){let u=i(c),d=u.split(/\s+/),m=parseInt(u[5])-1;m===0&&(o=W.identity(),n.push(o)),W.setValue(o,m,0,parseFloat(d[2])),W.setValue(o,m,1,parseFloat(d[3])),W.setValue(o,m,2,parseFloat(d[4])),W.setValue(o,m,3,parseFloat(d[5]))}if(n.length===0)return[];let a=[],s=1;for(let c of n){let u={id:"ncsop"+s++,code:".",details:"."};for(let d=0;d<3;d++){for(let m=0;m<3;m++)u[`matrix[${d+1}][${m+1}]`]=""+W.getValue(c,d,m);u[`vector[${d+1}]`]=""+W.getValue(c,d,3)}a.push(u)}let l={id:Ge.ofStrings(a.map(c=>c.id)),code:Ge.ofStrings(a.map(c=>c.code)),details:Ge.ofStrings(a.map(c=>c.details))};for(let c=0;c<3;c++){for(let d=0;d<3;d++){let m=`matrix[${c+1}][${d+1}]`;l[m]=Ge.ofStrings(a.map(p=>p[m]))}let u=`vector[${c+1}]`;l[u]=Ge.ofStrings(a.map(d=>d[u]))}return[Li.ofFields("struct_ncs_oper",l)]}var hxe={1:"helx_rh_al_p",2:"helx_rh_om_p",3:"helx_rh_pi_p",4:"helx_rh_ga_p",5:"helx_rh_3t_p",6:"helx_lh_al_p",7:"helx_lh_om_p",8:"helx_lh_ga_p",9:"helx_rh_27_p",10:"helx_rh_pp_p"};function gxe(t){return hxe[t]||"helx_p"}function RX(t,e,r){let n=[],o=u=>t.data.substring(t.indices[2*u],t.indices[2*u+1]);for(let u=e;u<r;u++){let d=o(u);n.push({serNum:d.substr(7,3).trim(),helixID:d.substr(11,3).trim(),initResName:d.substr(15,3).trim(),initChainID:d.substr(19,1).trim(),initSeqNum:d.substr(21,4).trim(),initICode:d.substr(25,1).trim(),endResName:d.substr(27,3).trim(),endChainID:d.substr(31,3).trim(),endSeqNum:d.substr(33,4).trim(),endICode:d.substr(37,1).trim(),helixClass:d.substr(38,2).trim(),comment:d.substr(40,30).trim(),length:d.substr(71,5).trim()})}let i=Ge.ofStrings(n.map(u=>u.initChainID)),a=Ge.ofStrings(n.map(u=>u.initResName)),s=Ge.ofStrings(n.map(u=>u.endChainID)),l=Ge.ofStrings(n.map(u=>u.endResName)),c={beg_label_asym_id:i,beg_label_comp_id:a,beg_label_seq_id:Ge.ofUndefined(n.length,K.Schema.int),beg_auth_asym_id:i,beg_auth_comp_id:a,beg_auth_seq_id:Ge.ofStrings(n.map(u=>u.initSeqNum)),conf_type_id:Ge.ofStrings(n.map(u=>gxe(u.helixClass))),details:Ge.ofStrings(n.map(u=>u.comment)),end_label_asym_id:s,end_label_comp_id:l,end_label_seq_id:Ge.ofUndefined(n.length,K.Schema.int),end_auth_asym_id:s,end_auth_comp_id:l,end_auth_seq_id:Ge.ofStrings(n.map(u=>u.endSeqNum)),id:Ge.ofStrings(n.map(u=>u.serNum)),pdbx_beg_PDB_ins_code:Ge.ofStrings(n.map(u=>u.initICode)),pdbx_end_PDB_ins_code:Ge.ofStrings(n.map(u=>u.endICode)),pdbx_PDB_helix_class:Ge.ofStrings(n.map(u=>u.helixClass)),pdbx_PDB_helix_length:Ge.ofStrings(n.map(u=>u.length)),pdbx_PDB_helix_id:Ge.ofStrings(n.map(u=>u.helixID))};return Li.ofFields("struct_conf",c)}function LX(t,e,r){let n=[],o=m=>t.data.substring(t.indices[2*m],t.indices[2*m+1]);for(let m=e;m<r;m++){let p=o(m);n.push({strand:p.substr(7,3).trim(),sheetID:p.substr(11,3).trim(),numStrands:p.substr(14,2).trim(),initResName:p.substr(17,3).trim(),initChainID:p.substr(21,1).trim(),initSeqNum:p.substr(22,4).trim(),initICode:p.substr(26,1).trim(),endResName:p.substr(28,3).trim(),endChainID:p.substr(32,1).trim(),endSeqNum:p.substr(33,4).trim(),endICode:p.substr(37,1).trim(),sense:p.substr(38,2).trim(),curAtom:p.substr(41,4).trim(),curResName:p.substr(45,3).trim(),curChainId:p.substr(49,1).trim(),curResSeq:p.substr(50,4).trim(),curICode:p.substr(54,1).trim(),prevAtom:p.substr(56,4).trim(),prevResName:p.substr(60,3).trim(),prevChainId:p.substr(64,1).trim(),prevResSeq:p.substr(65,4).trim(),prevICode:p.substr(69,1).trim()})}let i=Ge.ofStrings(n.map(m=>m.initChainID)),a=Ge.ofStrings(n.map(m=>m.initResName)),s=Ge.ofStrings(n.map(m=>m.initSeqNum)),l=Ge.ofStrings(n.map(m=>m.endChainID)),c=Ge.ofStrings(n.map(m=>m.endResName)),u=Ge.ofStrings(n.map(m=>m.endSeqNum)),d={beg_label_asym_id:i,beg_label_comp_id:a,beg_label_seq_id:s,beg_auth_asym_id:i,beg_auth_comp_id:a,beg_auth_seq_id:s,end_label_asym_id:l,end_label_comp_id:l,end_label_seq_id:u,end_auth_asym_id:l,end_auth_comp_id:c,end_auth_seq_id:u,id:Ge.ofStrings(n.map(m=>m.strand)),sheet_id:Ge.ofStrings(n.map(m=>m.sheetID)),pdbx_beg_PDB_ins_code:Ge.ofStrings(n.map(m=>m.initICode)),pdbx_end_PDB_ins_code:Ge.ofStrings(n.map(m=>m.endICode))};return Li.ofFields("struct_sheet_range",d)}var yxe={MOL_ID:"",MOLECULE:"",CHAIN:"",FRAGMENT:"",SYNONYM:"",EC:"",ENGINEERED:"",MUTATION:"",OTHER_DETAILS:""};function BX(t,e,r){let n=l=>t.data.substring(t.indices[2*l],t.indices[2*l+1]),o,i={chains:[],description:""},a=[];for(let l=e;l<r;l++){let u=n(l).substr(10,70).trim(),d=u.indexOf(":"),m=u.substring(0,d),p;m in yxe?(o=m,p=u.substring(d+2)):p=u,p=p.replace(/;$/,""),o==="MOL_ID"?(i={chains:[],description:""},a.push(i)):o==="MOLECULE"?(i.description&&(i.description+=" "),i.description+=p):o==="CHAIN"&&Array.prototype.push.apply(i.chains,p.split(/\s*,\s*/))}let s=[];for(let l of a)for(let c of l.chains)s.push({description:l.description,chains:[c]});return s}function OX(t,e,r){let n=i=>t.data.substring(t.indices[2*i],t.indices[2*i+1]),o=new Map;for(let i=e;i<r;i++){let a=n(i),s=a.substr(11,3).trim(),l=a.substr(15).trim();o.has(s)?o.set(s,`${o.get(s)} ${l}`):o.set(s,l)}return o}function FX(t,e){let r=()=>[],n=()=>Ce.create(t,2*e);return{index:0,group_PDB:n(),id:r(),auth_atom_id:n(),label_alt_id:n(),auth_comp_id:n(),auth_asym_id:n(),auth_seq_id:n(),pdbx_PDB_ins_code:n(),Cartn_x:n(),Cartn_y:n(),Cartn_z:n(),occupancy:n(),B_iso_or_equiv:n(),type_symbol:n(),pdbx_PDB_model_num:r(),label_entity_id:r(),partial_charge:n()}}function NX(t,e,r){let n=Ge.ofStrings(t.pdbx_PDB_model_num),o=Ge.ofTokens(t.auth_asym_id),i=Ge.ofTokens(t.auth_seq_id),a=Ge.ofTokens(t.pdbx_PDB_ins_code),s=Ge.ofTokens(t.auth_atom_id),l=Ge.ofTokens(t.auth_comp_id),c=Ge.ofStrings(t.id),u=n.str(0),d=o.str(0),m=i.int(0),p=a.str(0),h=d,f=m,b=new Map,v=new Map,x=[],S=[],T=[],E=!1;for(let A=0,I=c.rowCount;A<I;++A)if(a.str(A)!==""){E=!0;break}for(let A=0,I=c.rowCount;A<I;++A){let k=n.str(A),M=o.str(A),R=i.int(A),B=a.str(A),F=s.str(A);if(k!==u?(b.clear(),v.clear(),u=k,d=M,m=R,p=B,h=M,f=R):d!==M?(v.clear(),d=M,m=R,p=B,h=M,f=R):m!==R?(v.clear(),m===f?f=R:f+=1,m=R,p=B):p!==B&&(v.clear(),p=B,f+=1),b.has(M)){if(e.has(A)&&!r.hasAssemblies){let G=b.get(M)+1;b.set(M,G),h=`${M}_${G}`}}else b.set(M,0);if(x[A]=h,v.has(F)){let G=v.get(F)+1;v.set(F,G),F=`${F}_${G}`}else v.set(F,0);S[A]=F,E&&(T[A]=f)}let _=K.ofStringArray(x),D=K.ofStringArray(S),P=E?Ge.ofColumn(K.ofIntArray(T)):Ge.ofUndefined(t.index,K.Schema.int);return{auth_asym_id:o,auth_atom_id:s,auth_comp_id:l,auth_seq_id:i,B_iso_or_equiv:Ge.ofTokens(t.B_iso_or_equiv),Cartn_x:Ge.ofTokens(t.Cartn_x),Cartn_y:Ge.ofTokens(t.Cartn_y),Cartn_z:Ge.ofTokens(t.Cartn_z),group_PDB:Ge.ofTokens(t.group_PDB),id:c,label_alt_id:Ge.ofTokens(t.label_alt_id),label_asym_id:Ge.ofColumn(_),label_atom_id:Ge.ofColumn(D),label_comp_id:l,label_seq_id:P,label_entity_id:Ge.ofStrings(t.label_entity_id),occupancy:Nz(t.occupancy)?Ge.ofUndefined(t.index,K.Schema.float):Ge.ofTokens(t.occupancy),type_symbol:Ge.ofTokens(t.type_symbol),pdbx_PDB_ins_code:Ge.ofTokens(t.pdbx_PDB_ins_code),pdbx_PDB_model_num:n,partial_charge:Ge.ofTokens(t.partial_charge)}}function cR(t,e,r,n,o,i){let{data:a}=r,s=o-n;Ce.addToken(t.group_PDB,Fe.trim(r,n,n+6)),Fe.trim(r,n+6,n+11),t.id[t.index]=r.data.substring(r.tokenStart,r.tokenEnd),Ce.addToken(t.auth_atom_id,Fe.trim(r,n+12,n+16)),a.charCodeAt(n+16)===32?Ce.add(t.label_alt_id,0,0):Ce.add(t.label_alt_id,n+16,n+17),Ce.addToken(t.auth_comp_id,Fe.trim(r,n+17,n+20)),Ce.add(t.auth_asym_id,n+21,n+22),Ce.addToken(t.auth_seq_id,Fe.trim(r,n+22,n+26)),a.charCodeAt(n+26)===32?Ce.add(t.pdbx_PDB_ins_code,0,0):Ce.add(t.pdbx_PDB_ins_code,n+26,n+27),Ce.addToken(t.Cartn_x,Fe.trim(r,n+30,n+38)),Ce.addToken(t.Cartn_y,Fe.trim(r,n+38,n+46)),Ce.addToken(t.Cartn_z,Fe.trim(r,n+46,n+54)),Ce.addToken(t.occupancy,Fe.trim(r,n+54,n+60)),s>=66?Ce.addToken(t.B_iso_or_equiv,Fe.trim(r,n+60,n+66)):Ce.add(t.B_iso_or_equiv,0,0),i&&Ce.addToken(t.partial_charge,Fe.trim(r,n+70,n+76)),s>=78&&!i?(Fe.trim(r,n+76,n+78),r.tokenStart<r.tokenEnd?Ce.addToken(t.type_symbol,r):Pv(t.type_symbol,a,n+12,n+16)):Pv(t.type_symbol,a,n+12,n+16),t.pdbx_PDB_model_num[t.index]=e,t.index++}function VX(t,e){let r=()=>[],n=()=>new Float32Array(e),o=()=>Ce.create(t,2*e);return{index:0,count:e,id:r(),type_symbol:o(),pdbx_label_atom_id:o(),pdbx_label_alt_id:o(),pdbx_label_comp_id:o(),pdbx_label_asym_id:o(),pdbx_label_seq_id:o(),pdbx_PDB_ins_code:o(),"U[1][1]":n(),"U[2][2]":n(),"U[3][3]":n(),"U[1][2]":n(),"U[1][3]":n(),"U[2][3]":n(),pdbx_auth_seq_id:o(),pdbx_auth_comp_id:o(),pdbx_auth_asym_id:o(),pdbx_auth_atom_id:o()}}function zX(t){let e=Ge.ofTokens(t.pdbx_auth_seq_id),r=Ge.ofTokens(t.pdbx_auth_comp_id),n=Ge.ofTokens(t.pdbx_auth_asym_id),o=Ge.ofTokens(t.pdbx_auth_atom_id),i={id:Ge.ofStrings(t.id),type_symbol:Ge.ofTokens(t.type_symbol),pdbx_label_atom_id:o,pdbx_label_alt_id:Ge.ofTokens(t.pdbx_label_alt_id),pdbx_label_comp_id:r,pdbx_label_asym_id:n,pdbx_label_seq_id:e,pdbx_PDB_ins_code:Ge.ofTokens(t.pdbx_PDB_ins_code),pdbx_auth_seq_id:e,pdbx_auth_comp_id:r,pdbx_auth_asym_id:n,pdbx_auth_atom_id:o};return i["U[1][1]"]=Ge.ofNumbers(t["U[1][1]"]),i["U[2][2]"]=Ge.ofNumbers(t["U[2][2]"]),i["U[3][3]"]=Ge.ofNumbers(t["U[3][3]"]),i["U[1][2]"]=Ge.ofNumbers(t["U[1][2]"]),i["U[1][3]"]=Ge.ofNumbers(t["U[1][3]"]),i["U[2][3]"]=Ge.ofNumbers(t["U[2][3]"]),i}function UX(t,e,r,n,o){let{data:i}=r,a=o-n;Fe.trim(r,n+6,n+11),t.id[t.index]=i.substring(r.tokenStart,r.tokenEnd),Ce.addToken(t.pdbx_auth_atom_id,Fe.trim(r,n+12,n+16)),i.charCodeAt(n+16)===32?Ce.add(t.pdbx_label_alt_id,0,0):Ce.add(t.pdbx_label_alt_id,n+16,n+17),Ce.addToken(t.pdbx_auth_comp_id,Fe.trim(r,n+17,n+20)),Ce.add(t.pdbx_auth_asym_id,n+21,n+22),Ce.addToken(t.pdbx_auth_seq_id,Fe.trim(r,n+22,n+26)),i.charCodeAt(n+26)===32?Ce.add(t.pdbx_PDB_ins_code,0,0):Ce.add(t.pdbx_PDB_ins_code,n+26,n+27),t["U[1][1]"][t.index]=tp(i,n+28,n+35)/1e4,t["U[2][2]"][t.index]=tp(i,n+35,n+42)/1e4,t["U[3][3]"][t.index]=tp(i,n+42,n+49)/1e4,t["U[1][2]"][t.index]=tp(i,n+49,n+56)/1e4,t["U[1][3]"][t.index]=tp(i,n+56,n+63)/1e4,t["U[2][3]"][t.index]=tp(i,n+63,n+70)/1e4,a>=78?(Fe.trim(r,n+76,n+78),r.tokenStart<r.tokenEnd?Ce.addToken(t.type_symbol,r):Pv(t.type_symbol,i,n+12,n+16)):Pv(t.type_symbol,i,n+12,n+16),t.index++}function GX(t,e,r,n){let o={};for(let D=0,P=n.id.rowCount;D<P;++D)o[n.id.str(D)]=D;let i=D=>t.data.substring(t.indices[2*D],t.indices[2*D+1]),a=[],s=[],l=[],c=[],u=[],d=[],m=[],p=[],h=[],f=[],b=[],v=[],x=[],S=[],T=[11,16,21,26],E=1;for(let D=e;D<r;D++){let P=i(D),A=o[parseInt(P.substr(6,5))],I={};if(A!==void 0)for(let k=0;k<4;++k){let M=parseInt(P.substr(T[k],5));if(Number.isNaN(M))continue;let R=o[M];R!==void 0&&(A>R||I[R]===void 0&&(a.push(`covale${E}`),s.push("covale"),l.push(n.label_asym_id.str(A)),c.push(n.label_seq_id.int(A)),u.push(n.auth_seq_id.int(A)),d.push(n.label_atom_id.str(A)),m.push(n.label_alt_id.str(A)),p.push(n.pdbx_PDB_ins_code.str(A)),h.push(n.label_asym_id.str(R)),f.push(n.label_seq_id.int(R)),b.push(n.auth_seq_id.int(R)),v.push(n.label_atom_id.str(R)),x.push(n.label_alt_id.str(R)),S.push(n.pdbx_PDB_ins_code.str(R)),E+=1))}}let _={id:Ge.ofStrings(a),conn_type_id:Ge.ofStrings(s),ptnr1_label_asym_id:Ge.ofStrings(l),ptnr1_label_seq_id:Ge.ofNumbers(c),ptnr1_auth_seq_id:Ge.ofNumbers(u),ptnr1_label_atom_id:Ge.ofStrings(d),pdbx_ptnr1_label_alt_id:Ge.ofStrings(m),pdbx_ptnr1_PDB_ins_code:Ge.ofStrings(p),ptnr2_label_asym_id:Ge.ofStrings(h),ptnr2_label_seq_id:Ge.ofNumbers(f),ptnr2_auth_seq_id:Ge.ofNumbers(b),ptnr2_label_atom_id:Ge.ofStrings(v),pdbx_ptnr2_label_alt_id:Ge.ofStrings(x),pdbx_ptnr2_PDB_ins_code:Ge.ofStrings(S)};return Li.ofFields("struct_conn",_)}function jX(t,e,r,n){let o=t.substring(e,r);n.id_code=o.substring(62,66).trim()||void 0,n.dep_date=o.substring(50,59).trim()||void 0,n.classification=o.substring(10,50).trim()||void 0}function HX(t){return N(this,null,function*(){let{lines:e}=t,{data:r,indices:n}=e,o=Fe(r),i=!!t.isPdbqt,a=0,s=0;for(let I=0,k=e.count;I<k;I++){let M=n[2*I],R=n[2*I+1];switch(r[M]){case"A":yo(r,M,R,"ATOM  ")?a++:yo(r,M,R,"ANISOU")&&s++;break;case"H":yo(r,M,R,"HETATM")&&a++;break}}let l={},c=FX(r,a),u=VX(r,s),d=new Oi,m=[],p=[],h=0,f="",b,v=!1,x=new Set;for(let I=0,k=e.count;I<k;I++){let M=n[2*I],R=n[2*I+1];switch(r[M]){case"A":yo(r,M,R,"ATOM  ")?(h||(h++,f=""+h),cR(c,f,o,M,R,i)):yo(r,M,R,"ANISOU")&&UX(u,f,o,M,R);break;case"C":if(yo(r,M,R,"CRYST1"))m.push(...AX(t.id||"?",r.substring(M,R)));else if(yo(r,M,R,"CONECT")){let B=I+1;for(;M=n[2*B],R=n[2*B+1],!!yo(r,M,R,"CONECT");)B++;b?ht&&console.log("only single CONECT block allowed, ignoring others"):b=[I,B],I=B-1}else if(yo(r,M,R,"COMPND")){let B=I+1;for(;M=n[2*B],R=n[2*B+1],!!yo(r,M,R,"COMPND");)B++;d.setCompounds(BX(e,I,B)),I=B-1}break;case"H":if(yo(r,M,R,"HEADER"))jX(r,M,R,l);else if(yo(r,M,R,"HETATM"))h||(h++,f=""+h),cR(c,f,o,M,R,i);else if(yo(r,M,R,"HELIX")){let B=I+1;for(;M=n[2*B],R=n[2*B+1],!!yo(r,M,R,"HELIX");)B++;m.push(RX(e,I,B)),I=B-1}else if(yo(r,M,R,"HETNAM")){let B=I+1;for(;M=n[2*B],R=n[2*B+1],!!yo(r,M,R,"HETNAM");)B++;p.push(...Array.from(OX(e,I,B).entries())),I=B-1}break;case"M":if(yo(r,M,R,"MODEL ")&&(h++,f=""+h),yo(r,M,R,"MTRIX")){let B=I+1;for(;M=n[2*B],R=n[2*B+1],!!yo(r,M,R,"MTRIX");)B++;m.push(...MX(e,I,B)),I=B-1}break;case"O":break;case"R":if(yo(r,M,R,"REMARK 350")){let B=I+1;for(;M=n[2*B],R=n[2*B+1],!!yo(r,M,R,"REMARK 350");)B++;m.push(...kX(e,I,B)),I=B-1,v=!0}break;case"S":if(yo(r,M,R,"SHEET")){let B=I+1;for(;M=n[2*B],R=n[2*B+1],!!yo(r,M,R,"SHEET");)B++;m.push(LX(e,I,B)),I=B-1}break;case"T":yo(r,M,R,"TER")&&x.add(c.index)}}if(l.id_code){let I={id:Ge.ofString(l.id_code)};m.push(Li.ofFields("entry",I))}if(l.classification){let I={pdbx_keywords:Ge.ofString(l.classification)};m.push(Li.ofFields("struct_keywords",I))}if(l.dep_date){let I={recvd_initial_deposition_date:Ge.ofString(l.dep_date)};m.push(Li.ofFields("pdbx_database_status",I))}let S=K.ofIntTokens(c.auth_seq_id),T=K.ofStringTokens(c.auth_atom_id),E=K.ofStringTokens(c.auth_comp_id),_=K.ofStringTokens(c.auth_asym_id),D=new Fi(S,T);D.setNames(p),d.setNames(p);for(let I=0,k=E.rowCount;I<k;++I){let M=E.value(I),R=im(D.add(M,I).type,M);c.label_entity_id[I]=d.getEntityId(M,R,_.value(I))}let P=NX(c,x,{hasAssemblies:v});i||delete P.partial_charge,b&&m.push(GX(e,b[0],b[1],P));let A={entity:Li.ofTable("entity",d.getEntityTable()),chem_comp:Li.ofTable("chem_comp",D.getChemCompTable()),atom_site:Li.ofFields("atom_site",P),atom_site_anisotrop:Li.ofFields("atom_site_anisotrop",zX(u))};for(let I of m)A[I.name]=I;return{header:t.id||"PDB",categoryNames:Object.keys(A),categories:A}})}var uR;(function(t){function e(n){return n?.kind==="pdb"}t.is=e;function r(n){return{kind:"pdb",name:n.id||"",data:n}}t.create=r})(uR||(uR={}));function qX(t){return ie.create("Parse PDB",e=>N(this,null,function*(){var r;yield e.update("Converting to mmCIF");let n=yield HX(t),o=op.fromFrame(n,void 0,uR.create(t)),i=Bi(o.data.db,!0),a=yield wl(i,o,e),s=(r=n.categories.atom_site)===null||r===void 0?void 0:r.getField("partial_charge");if(s&&a.frameCount===1){let l=a.representative,c=l.atomicHierarchy.atomSourceIndex,d=K.isIdentity(c)?void 0:c.toArray({array:Int32Array}),m=s.toFloatArray(),p=d?K.ofFloatArray(K.mapToArray(c,h=>m[h],Float32Array)):K.ofFloatArray(m);vp.Provider.set(l,{data:p,type:"GASTEIGER"})}return a}))}function vxe(t){let e=new Array(t.count),r=new Array(t.count),n=new Uint32Array(t.count),o=new Uint32Array(t.count),i=new Array(t.count),a=new Oi,s=new Fi(t.residueId,t.atomName),l="",c=0,u="",d=0,m=t.segmentName.value(0),p=!1,h=0,f=-1;for(let v=0,x=t.count;v<x;++v){let S=t.residueId.value(v),T=t.segmentName.value(v);if(m!==T?(u=Tp(c),c+=1,d=0,p=!0,m=T):p=!1,p||S!==f){let E=t.residueName.value(v),_=im(s.add(E,v).type,E);!p&&(_!==h||S!==f+1)&&(u=Tp(c),c+=1,d=0),l=a.getEntityId(E,_,u),d+=1,f=S,h=_}e[v]=l,r[v]=u,n[v]=d,o[v]=v,i[v]=vu(t.atomName.value(v),t.residueName.value(v))}let b=Xo.ofPartialColumns(ha.atom_site,{auth_asym_id:t.segmentName,auth_atom_id:t.atomName,auth_comp_id:t.residueName,auth_seq_id:t.residueId,id:K.ofIntArray(o),label_asym_id:K.ofStringArray(r),label_atom_id:t.atomName,label_comp_id:t.residueName,label_seq_id:K.ofIntArray(n),label_entity_id:K.ofStringArray(e),occupancy:K.ofConst(1,t.count,K.Schema.float),type_symbol:K.ofStringArray(i),pdbx_PDB_model_num:K.ofConst(1,t.count,K.Schema.int)},t.count);return Bi({entity:a.getEntityTable(),chem_comp:s.getChemCompTable(),atom_site:b})}var dR;(function(t){function e(n){return n?.kind==="psf"}t.is=e;function r(n){return{kind:"psf",name:n.id,data:n}}t.fromPsf=r})(dR||(dR={}));function WX(t){return ie.create("Parse PSF",e=>N(this,null,function*(){let r=dR.fromPsf(t),n=vxe(t.atoms),{atomIdA:o,atomIdB:i}=t.bonds,a={indexA:K.ofLambda({value:s=>o.value(s)-1,rowCount:o.rowCount,schema:o.schema}),indexB:K.ofLambda({value:s=>i.value(s)-1,rowCount:i.rowCount,schema:i.schema}),order:K.ofConst(1,t.bonds.count,K.Schema.int)};return g0.create(t.id,n,a,r)}))}var Ev={dynamicBonds:g.Optional(g.Boolean(!1,{description:"Ensure bonds are recalculated upon model changes. Also enables calculation of inter-unit bonds in water molecules and ions."}))},vm;(function(t){function e(l,c){let u=l&&rs.Provider.get(l),d=u?u.assemblies.map(v=>[v.id,`${v.id}: ${ic(v.details)}`]):[],m=u?!pa.isZero(u.spacegroup.cell):!0,p=[];if(u){let{operators:v}=u.spacegroup;for(let x=0,S=v.length;x<S;x++)p.push([x,`${x+1}: ${S0.getOperatorXyz(v[x])}`])}let h=[];l&&l.properties.structAsymMap.forEach(v=>{let x=v.id===v.auth_id?v.id:`${v.id} [auth ${v.auth_id}]`;h.push([v.id,x])});let f={auto:g.Group(Ev),model:g.Group(Ev),assembly:g.Group(w({id:g.Optional(l?g.Select(d.length?d[0][0]:"",d,{label:"Asm Id",description:"Assembly Id"}):g.Text("",{label:"Asm Id",description:"Assembly Id (use empty for the 1st assembly)"}))},Ev),{isFlat:!0}),"symmetry-mates":g.Group(w({radius:g.Numeric(5,{min:0,max:50,step:1})},Ev),{isFlat:!0}),symmetry:g.Group(w({ijkMin:g.Vec3(y.create(-1,-1,-1),{step:1},{label:"Min IJK",fieldLabels:{x:"I",y:"J",z:"K"}}),ijkMax:g.Vec3(y.create(1,1,1),{step:1},{label:"Max IJK",fieldLabels:{x:"I",y:"J",z:"K"}})},Ev),{isFlat:!0}),"symmetry-assembly":g.Group(w({generators:g.ObjectList({operators:g.ObjectList({index:g.Select(0,p),shift:g.Vec3(y(),{step:1},{label:"IJK",fieldLabels:{x:"I",y:"J",z:"K"}})},v=>`${v.index+1}_${v.shift.map(x=>x+5).join("")}`,{defaultValue:[]}),asymIds:g.MultiSelect([],h)},v=>`${v.asymIds.length} asym ids, ${v.operators.length} operators`,{defaultValue:[]})},Ev),{isFlat:!0})},b=[];return c==="auto"&&b.push(["auto","Auto"]),b.push(["model","Model"]),d.length>0&&b.push(["assembly","Assembly"]),m&&(b.push(["symmetry-mates","Symmetry Mates"]),b.push(["symmetry","Symmetry (indices)"]),b.push(["symmetry-assembly","Symmetry (assembly)"])),{type:g.MappedStatic(c||"model",f,{options:b})}}t.getParams=e;function r(l,c){return!(c.name==="symmetry-assembly"||c.name==="symmetry"&&l.name==="symmetry")}t.canAutoUpdate=r;function n(l,c,u,d,m){return N(this,null,function*(){let p,h=rs.Provider.get(u);!d&&h&&h.assemblies.length!==0&&(d=h.assemblies[0].id),!h||h.assemblies.length===0?l.log.warn(`Model '${u.entryId}' has no assembly, returning model structure.`):(p=RT.findAssembly(u,d||""),p||l.log.warn(`Model '${u.entryId}' has no assembly called '${d}', returning model structure.`));let f=ue.ofModel(u,m);if(!p){let x={label:"Model",description:ue.elementDescription(f)};return new X.Molecule.Structure(f,x)}d=p.id;let b=yield jx.buildAssembly(f,d).runInContext(c),v={label:`Assembly ${d}`,description:ue.elementDescription(b)};return new X.Molecule.Structure(b,v)})}function o(l,c,u,d,m){return N(this,null,function*(){let p=ue.ofModel(c,m),h=yield jx.buildSymmetryRange(p,u,d).runInContext(l),f={label:`Symmetry [${u}] to [${d}]`,description:ue.elementDescription(h)};return new X.Molecule.Structure(h,f)})}function i(l,c,u,d){return N(this,null,function*(){let m=ue.ofModel(c,d),p=yield jx.builderSymmetryMates(m,u).runInContext(l),h={label:"Symmetry Mates",description:ue.elementDescription(p)};return new X.Molecule.Structure(p,h)})}function a(l,c,u,d,m){return N(this,null,function*(){let p=ue.ofModel(c,m),h=yield jx.buildSymmetryAssembly(p,u,d).runInContext(l),f={label:"Symmetry Assembly",description:ue.elementDescription(h)};return new X.Molecule.Structure(h,f)})}function s(l,c,u,d){return N(this,null,function*(){let m=d?.params,p=rs.Provider.get(u);if(!p||!d||d.name==="model"){let h=ue.ofModel(u,m);return new X.Molecule.Structure(h,{label:"Model",description:ue.elementDescription(h)})}if(d.name==="auto")if(p.assemblies.length===0){let h=ue.ofModel(u,m);return new X.Molecule.Structure(h,{label:"Model",description:ue.elementDescription(h)})}else return n(l,c,u,void 0,m);if(d.name==="assembly")return n(l,c,u,d.params.id,m);if(d.name==="symmetry")return o(c,u,d.params.ijkMin,d.params.ijkMax,m);if(d.name==="symmetry-mates")return i(c,u,d.params.radius,m);if(d.name==="symmetry-assembly")return a(c,u,d.params.generators,p,m);ur(d)})}t.create=s})(vm||(vm={}));var Oa;(function(t){function e(s,l,c){return s.currentStructure!==c?!1:Jr.is(l)?!!s.script&&Jr.areEqual(s.script,l):s.expression===l}t.isUnchanged=e;function r(s,l){let c=Jr.is(l)?l:void 0,u=Jr.is(l)?Jr.toExpression(l):l,d=hd(u);return{script:c,expression:u,compiled:d,originalStructure:s,currentStructure:s}}t.create=r;function n(s,l){return s.compiled(new fa(l))}t.run=n;function o(s,l){let c=r(s,l);return{entry:c,selection:n(c,s)}}t.createAndRun=o;function i(s,l){return s.currentStructure=l,s.compiled(new fa(l))}t.updateStructure=i;function a(s,l,c){let u=hn.unionStructure(l);s.label=`${c||"Selection"}`,s.description=ue.elementDescription(u),s.data=u}t.updateStructureObject=a})(Oa||(Oa={}));var XX={H:"Hydrogen",HE:"Helium",LI:"Lithium",BE:"Beryllium",B:"Boron",C:"Carbon",N:"Nitrogen",O:"Oxygen",F:"Fluorine",NE:"Neon",NA:"Sodium",MG:"Magnesium",AL:"Aluminum",SI:"Silicon",P:"Phosphorus",S:"Sulfur",CL:"Chlorine",AR:"Argon",K:"Potassium",CA:"Calcium",SC:"Scandium",TI:"Titanium",V:"Vanadium",CR:"Chromium",MN:"Manganese",FE:"Iron",CO:"Cobalt",NI:"Nickel",CU:"Copper",ZN:"Zinc",GA:"Gallium",GE:"Germanium",AS:"Arsenic",SE:"Selenium",BR:"Bromine",KR:"Krypton",RB:"Rubidium",SR:"Strontium",Y:"Yttrium",ZR:"Zirconium",NB:"Niobium",MO:"Molybdenum",TC:"Technetium",RU:"Ruthenium",RH:"Rhodium",PD:"Palladium",AG:"Silver",CD:"Cadmium",IN:"Indium",SN:"Tin",SB:"Antimony",TE:"Tellurium",I:"Iodine",XE:"Xenon",CS:"Cesium",BA:"Barium",LA:"Lanthanum",CE:"Cerium",PR:"Praseodymium",ND:"Neodymium",PM:"Promethium",SM:"Samarium",EU:"Europium",GD:"Gadolinium",TB:"Terbium",DY:"Dysprosium",HO:"Holmium",ER:"Erbium",TM:"Thulium",YB:"Ytterbium",LU:"Lutetium",HF:"Hafnium",TA:"Tantalum",W:"Wolfram",RE:"Rhenium",OS:"Osmium",IR:"Iridium",PT:"Platinum",AU:"Gold",HG:"Mercury",TL:"Thallium",PB:"Lead",BI:"Bismuth",PO:"Polonium",AT:"Astatine",RN:"Radon",FR:"Francium",RA:"Radium",AC:"Actinium",TH:"Thorium",PA:"Protactinium",U:"Uranium",NP:"Neptunium",PU:"Plutonium",AM:"Americium",CM:"Curium",BK:"Berkelium",CF:"Californium",ES:"Einsteinium",FM:"Fermium",MD:"Mendelevium",NO:"Nobelium",LR:"Lawrencium",RF:"Rutherfordium",DB:"Dubnium",SG:"Seaborgium",BH:"Bohrium",HS:"Hassium",MT:"Meitnerium",DS:"Darmstadtium",RG:"Roentgenium",CN:"Copernicium",NH:"Nihonium",FL:"Flerovium",MC:"Moscovium",LV:"Livermorium",TS:"Tennessine",OG:"Oganesson"},bxe=new Set(["LI","NA","K","RB","CS","FR"]);function xxe(t){return bxe.has(t)}var Sxe=new Set(["BE","MG","CA","SR","BA","RA"]);function Cxe(t){return Sxe.has(t)}var Txe=new Set(["ZN","GA","CD","IN","SN","HG","TI","PB","BI","PO","CN"]);function wxe(t){return Txe.has(t)}var _xe=new Set(["F","CL","BR","I","AT"]);function mR(t){return _xe.has(t)}function pR(t){let e=P0(t);return e>=21&&e<=29||e>=39&&e<=47||e>=72&&e<=79||e>=104&&e<=108}function Pxe(t){let e=P0(t);return e>=57&&e<=71}function Exe(t){let e=P0(t);return e>=89&&e<=103}function YX(t){return xxe(t)||Cxe(t)||Pxe(t)||Exe(t)||pR(t)||wxe(t)}var Ur=function(t){return t.Type="Type",t.Structure="Structure Property",t.Atom="Atom Property",t.Bond="Bond Property",t.Residue="Residue Property",t.AminoAcid="Amino Acid",t.NucleicBase="Nucleic Base",t.Manipulate="Manipulate Selection",t.Validation="Validation",t.Misc="Miscellaneous",t.Internal="Internal",t}(Ur||{});function Lr(t,e,r={}){var n;let o;return{label:t,expression:e,description:r.description||"",category:(n=r.category)!==null&&n!==void 0?n:Ur.Misc,isHidden:!!r.isHidden,priority:r.priority||0,referencesCurrent:!!r.referencesCurrent,get query(){return o||(o=hd(e)),o},ensureCustomProperties:r.ensureCustomProperties,getSelection(a,s,l){return N(this,null,function*(){let c=a.managers.structure.selection.getStructure(l),u=c?hn.Sequence(l,[c]):hn.Empty(l);return r.ensureCustomProperties&&(yield r.ensureCustomProperties({runtime:s,assetManager:a.managers.asset},l)),o||(o=hd(e)),o(new fa(l,{currentSelection:u}))})}}}var Ixe=Lr("All",q.struct.generator.all(),{category:"",priority:1e3}),Dxe=Lr("Current Selection",q.internal.generator.current(),{category:"",referencesCurrent:!0}),Axe=Lr("Polymer",q.struct.modifier.union([q.struct.generator.atomGroups({"entity-test":q.core.logic.and([q.core.rel.eq([q.ammp("entityType"),"polymer"]),q.core.str.match([q.re("(polypeptide|cyclic-pseudo-peptide|peptide-like|nucleotide|peptide nucleic acid)","i"),q.ammp("entitySubtype")])])})]),{category:Ur.Type}),kxe=Lr("Trace",q.struct.modifier.union([q.struct.combinator.merge([q.struct.modifier.union([q.struct.generator.atomGroups({"entity-test":q.core.rel.eq([q.ammp("entityType"),"polymer"]),"chain-test":q.core.set.has([q.set("sphere","gaussian"),q.ammp("objectPrimitive")])})]),q.struct.modifier.union([q.struct.generator.atomGroups({"entity-test":q.core.rel.eq([q.ammp("entityType"),"polymer"]),"chain-test":q.core.rel.eq([q.ammp("objectPrimitive"),"atomistic"]),"atom-test":q.core.set.has([q.set("CA","P"),q.ammp("label_atom_id")])})])])]),{category:Ur.Structure}),Iv=q.core.logic.and([q.core.rel.eq([q.ammp("entityType"),"polymer"]),q.core.str.match([q.re("(polypeptide|cyclic-pseudo-peptide|peptide-like)","i"),q.ammp("entitySubtype")])]),Rw=q.core.logic.and([q.core.rel.eq([q.ammp("entityType"),"polymer"]),q.core.str.match([q.re("(nucleotide|peptide nucleic acid)","i"),q.ammp("entitySubtype")])]),ty=q.core.str.match([q.re("non-polymer|(amino|carboxy) terminus|peptide-like","i"),q.ammp("chemCompType")]),Mxe=Lr("Backbone",q.struct.modifier.union([q.struct.combinator.merge([q.struct.modifier.union([q.struct.generator.atomGroups({"entity-test":Iv,"chain-test":q.core.rel.eq([q.ammp("objectPrimitive"),"atomistic"]),"residue-test":q.core.logic.not([ty]),"atom-test":q.core.set.has([q.set(...no.toArray(ac)),q.ammp("label_atom_id")])})]),q.struct.modifier.union([q.struct.generator.atomGroups({"entity-test":Rw,"chain-test":q.core.rel.eq([q.ammp("objectPrimitive"),"atomistic"]),"residue-test":q.core.logic.not([ty]),"atom-test":q.core.set.has([q.set(...no.toArray(T0)),q.ammp("label_atom_id")])})])])]),{category:Ur.Structure}),Rxe=Lr("Sidechain",q.struct.modifier.union([q.struct.combinator.merge([q.struct.modifier.union([q.struct.generator.atomGroups({"entity-test":Iv,"chain-test":q.core.rel.eq([q.ammp("objectPrimitive"),"atomistic"]),"residue-test":q.core.logic.not([ty]),"atom-test":q.core.logic.or([q.core.logic.not([q.core.set.has([q.set(...no.toArray(ac)),q.ammp("label_atom_id")])])])})]),q.struct.modifier.union([q.struct.generator.atomGroups({"entity-test":Rw,"chain-test":q.core.rel.eq([q.ammp("objectPrimitive"),"atomistic"]),"residue-test":q.core.logic.not([ty]),"atom-test":q.core.logic.or([q.core.logic.not([q.core.set.has([q.set(...no.toArray(T0)),q.ammp("label_atom_id")])])])})])])]),{category:Ur.Structure}),Lxe=Lr("Sidechain with Trace",q.struct.modifier.union([q.struct.combinator.merge([q.struct.modifier.union([q.struct.generator.atomGroups({"entity-test":Iv,"chain-test":q.core.rel.eq([q.ammp("objectPrimitive"),"atomistic"]),"residue-test":q.core.logic.not([ty]),"atom-test":q.core.logic.or([q.core.logic.not([q.core.set.has([q.set(...no.toArray(ac)),q.ammp("label_atom_id")])]),q.core.rel.eq([q.ammp("label_atom_id"),"CA"]),q.core.logic.and([q.core.rel.eq([q.ammp("auth_comp_id"),"PRO"]),q.core.rel.eq([q.ammp("label_atom_id"),"N"])])])})]),q.struct.modifier.union([q.struct.generator.atomGroups({"entity-test":Rw,"chain-test":q.core.rel.eq([q.ammp("objectPrimitive"),"atomistic"]),"residue-test":q.core.logic.not([ty]),"atom-test":q.core.logic.or([q.core.logic.not([q.core.set.has([q.set(...no.toArray(T0)),q.ammp("label_atom_id")])]),q.core.rel.eq([q.ammp("label_atom_id"),"P"])])})])])]),{category:Ur.Structure}),Bxe=Lr("Protein",q.struct.modifier.union([q.struct.generator.atomGroups({"entity-test":Iv})]),{category:Ur.Type}),Oxe=Lr("Nucleic",q.struct.modifier.union([q.struct.generator.atomGroups({"entity-test":Rw})]),{category:Ur.Type}),Fxe=Lr("Helix",q.struct.modifier.union([q.struct.generator.atomGroups({"entity-test":Iv,"residue-test":q.core.flags.hasAny([q.ammp("secondaryStructureFlags"),q.core.type.bitflags([2])])})]),{category:Ur.Structure,ensureCustomProperties:(t,e)=>xs.attach(t,e)}),Nxe=Lr("Beta Strand/Sheet",q.struct.modifier.union([q.struct.generator.atomGroups({"entity-test":Iv,"residue-test":q.core.flags.hasAny([q.ammp("secondaryStructureFlags"),q.core.type.bitflags([4])])})]),{category:Ur.Structure,ensureCustomProperties:(t,e)=>xs.attach(t,e)}),Vxe=Lr("Water",q.struct.modifier.union([q.struct.generator.atomGroups({"entity-test":q.core.rel.eq([q.ammp("entityType"),"water"])})]),{category:Ur.Type}),zxe=Lr("Ion",q.struct.modifier.union([q.struct.generator.atomGroups({"entity-test":q.core.rel.eq([q.ammp("entitySubtype"),"ion"])})]),{category:Ur.Type}),Uxe=Lr("Lipid",q.struct.modifier.union([q.struct.generator.atomGroups({"entity-test":q.core.rel.eq([q.ammp("entitySubtype"),"lipid"])})]),{category:Ur.Type}),Lw=Lr("Carbohydrate",q.struct.modifier.union([q.struct.generator.atomGroups({"entity-test":q.core.logic.or([q.core.rel.eq([q.ammp("entityType"),"branched"]),q.core.logic.and([q.core.rel.eq([q.ammp("entityType"),"non-polymer"]),q.core.str.match([q.re("oligosaccharide","i"),q.ammp("entitySubtype")])])])})]),{category:Ur.Type}),QX=Lr("Carbohydrate with Connected",q.struct.modifier.union([q.struct.modifier.includeConnected({0:Lw.expression,"layer-count":1,"as-whole-residues":!0})]),{category:Ur.Internal,isHidden:!0}),KX=Lr("Connected to Carbohydrate",q.struct.modifier.union([q.struct.modifier.exceptBy({0:QX.expression,by:Lw.expression})]),{category:Ur.Internal,isHidden:!0}),hR=Lr("Ligand",q.struct.modifier.union([q.struct.modifier.exceptBy({0:q.struct.modifier.union([q.struct.combinator.merge([q.struct.modifier.union([q.struct.generator.atomGroups({"entity-test":q.core.logic.and([q.core.logic.or([q.core.rel.eq([q.ammp("entityType"),"non-polymer"]),q.core.rel.neq([q.ammp("entityPrdId"),""])]),q.core.logic.not([q.core.str.match([q.re("(oligosaccharide|lipid|ion)","i"),q.ammp("entitySubtype")])])]),"chain-test":q.core.rel.eq([q.ammp("objectPrimitive"),"atomistic"]),"residue-test":q.core.logic.not([q.core.str.match([q.re("saccharide","i"),q.ammp("chemCompType")])])})]),q.struct.modifier.union([q.struct.generator.atomGroups({"entity-test":q.core.rel.eq([q.ammp("entityType"),"polymer"]),"chain-test":q.core.rel.eq([q.ammp("objectPrimitive"),"atomistic"]),"residue-test":ty})])])]),by:q.struct.combinator.merge([q.struct.modifier.union([q.struct.generator.atomGroups({"entity-test":q.core.rel.eq([q.ammp("entityType"),"polymer"]),"chain-test":q.core.rel.eq([q.ammp("objectPrimitive"),"atomistic"]),"residue-test":q.core.set.has([q.set(...no.toArray(Vx)),q.ammp("label_comp_id")])})]),q.struct.generator.atomGroups({"chain-test":q.core.rel.eq([q.ammp("objectPrimitive"),"atomistic"]),"residue-test":q.core.set.has([q.set(...no.toArray(Qz)),q.ammp("label_comp_id")])})])})]),{category:Ur.Type}),$X=Lr("Ligand with Connected",q.struct.modifier.union([q.struct.modifier.exceptBy({0:q.struct.modifier.union([q.struct.modifier.includeConnected({0:hR.expression,"layer-count":1,"as-whole-residues":!0,"bond-test":q.core.flags.hasAny([q.struct.bondProperty.flags(),q.core.type.bitflags([3])])})]),by:Lw.expression})]),{category:Ur.Internal,isHidden:!0}),ZX=Lr("Connected to Ligand",q.struct.modifier.union([q.struct.modifier.exceptBy({0:$X.expression,by:hR.expression})]),{category:Ur.Internal,isHidden:!0}),Gxe=Lr("Connected to Ligand or Carbohydrate",q.struct.modifier.union([q.struct.combinator.merge([KX.expression,ZX.expression])]),{category:Ur.Internal,isHidden:!0}),jxe=Lr("Disulfide Bridges",q.struct.modifier.union([q.struct.combinator.merge([q.struct.modifier.union([q.struct.modifier.wholeResidues([q.struct.filter.isConnectedTo({0:q.struct.generator.atomGroups({"residue-test":q.core.set.has([q.set("CYS"),q.ammp("auth_comp_id")]),"atom-test":q.core.set.has([q.set("SG"),q.ammp("label_atom_id")])}),target:q.struct.generator.atomGroups({"residue-test":q.core.set.has([q.set("CYS"),q.ammp("auth_comp_id")]),"atom-test":q.core.set.has([q.set("SG"),q.ammp("label_atom_id")])}),"bond-test":!0})])]),q.struct.modifier.union([q.struct.modifier.wholeResidues([q.struct.modifier.union([q.struct.generator.bondedAtomicPairs({0:q.core.flags.hasAny([q.struct.bondProperty.flags(),q.core.type.bitflags([8])])})])])])])]),{category:Ur.Bond}),Hxe=Lr("NOS Bridges",q.struct.modifier.union([q.struct.modifier.wholeResidues([q.struct.filter.isConnectedTo({0:q.struct.generator.atomGroups({"residue-test":q.core.set.has([q.set("CSO","LYS"),q.ammp("auth_comp_id")]),"atom-test":q.core.set.has([q.set("OD","NZ"),q.ammp("label_atom_id")])}),target:q.struct.generator.atomGroups({"residue-test":q.core.set.has([q.set("CSO","LYS"),q.ammp("auth_comp_id")]),"atom-test":q.core.set.has([q.set("OD","NZ"),q.ammp("label_atom_id")])}),"bond-test":!0})])]),{category:Ur.Bond}),qxe=Lr("Non-standard Residues in Polymers",q.struct.modifier.union([q.struct.generator.atomGroups({"entity-test":q.core.rel.eq([q.ammp("entityType"),"polymer"]),"chain-test":q.core.rel.eq([q.ammp("objectPrimitive"),"atomistic"]),"residue-test":q.ammp("isNonStandard")})]),{category:Ur.Residue}),Wxe=Lr("Coarse Elements",q.struct.modifier.union([q.struct.generator.atomGroups({"chain-test":q.core.set.has([q.set("sphere","gaussian"),q.ammp("objectPrimitive")])})]),{category:Ur.Type}),Xxe=Lr("Rings in Residues",q.struct.modifier.union([q.struct.generator.rings()]),{category:Ur.Residue}),Yxe=Lr("Aromatic Rings in Residues",q.struct.modifier.union([q.struct.generator.rings({"only-aromatic":!0})]),{category:Ur.Residue}),Qxe=Lr("Surrounding Residues (5 \u212B) of Selection",q.struct.modifier.union([q.struct.modifier.exceptBy({0:q.struct.modifier.includeSurroundings({0:q.internal.generator.current(),radius:5,"as-whole-residues":!0}),by:q.internal.generator.current()})]),{description:"Select residues within 5 \u212B of the current selection.",category:Ur.Manipulate,referencesCurrent:!0}),Kxe=Lr("Surrounding Ligands (5 \u212B) of Selection",q.struct.modifier.union([q.struct.modifier.surroundingLigands({0:q.internal.generator.current(),radius:5,"include-water":!0})]),{description:"Select ligand components within 5 \u212B of the current selection.",category:Ur.Manipulate,referencesCurrent:!0}),$xe=Lr("Surrounding Atoms (5 \u212B) of Selection",q.struct.modifier.union([q.struct.modifier.exceptBy({0:q.struct.modifier.includeSurroundings({0:q.internal.generator.current(),radius:5,"as-whole-residues":!1}),by:q.internal.generator.current()})]),{description:"Select atoms within 5 \u212B of the current selection.",category:Ur.Manipulate,referencesCurrent:!0}),Zxe=Lr("Inverse / Complement of Selection",q.struct.modifier.union([q.struct.modifier.exceptBy({0:q.struct.generator.all(),by:q.internal.generator.current()})]),{description:"Select everything not in the current selection.",category:Ur.Manipulate,referencesCurrent:!0}),Jxe=Lr("Residues Covalently Bonded to Selection",q.struct.modifier.union([q.struct.modifier.includeConnected({0:q.internal.generator.current(),"layer-count":1,"as-whole-residues":!0})]),{description:"Select residues covalently bonded to current selection.",category:Ur.Manipulate,referencesCurrent:!0}),e1e=Lr("Covalently Bonded Component",q.struct.modifier.union([q.struct.modifier.includeConnected({0:q.internal.generator.current(),"fixed-point":!0})]),{description:"Select covalently bonded component based on current selection.",category:Ur.Manipulate,referencesCurrent:!0}),t1e=Lr("Residues with Cov. or Metallic Bond to Selection",q.struct.modifier.union([q.struct.modifier.includeConnected({0:q.internal.generator.current(),"layer-count":1,"as-whole-residues":!0,"bond-test":q.core.flags.hasAny([q.struct.bondProperty.flags(),q.core.type.bitflags([3])])})]),{description:"Select residues with covalent or metallic bond to current selection.",category:Ur.Manipulate,referencesCurrent:!0}),r1e=Lr("Whole Residues of Selection",q.struct.modifier.union([q.struct.modifier.wholeResidues({0:q.internal.generator.current()})]),{description:"Expand current selection to whole residues.",category:Ur.Manipulate,referencesCurrent:!0}),n1e=[[["HIS"],"Histidine"],[["ARG"],"Arginine"],[["LYS"],"Lysine"],[["ILE"],"Isoleucine"],[["PHE"],"Phenylalanine"],[["LEU"],"Leucine"],[["TRP"],"Tryptophan"],[["ALA"],"Alanine"],[["MET"],"Methionine"],[["PRO"],"Proline"],[["CYS"],"Cysteine"],[["ASN"],"Asparagine"],[["VAL"],"Valine"],[["GLY"],"Glycine"],[["SER"],"Serine"],[["GLN"],"Glutamine"],[["TYR"],"Tyrosine"],[["ASP"],"Aspartic Acid"],[["GLU"],"Glutamic Acid"],[["THR"],"Threonine"],[["SEC"],"Selenocysteine"],[["PYL"],"Pyrrolysine"],[["UNK"],"Unknown"]].sort((t,e)=>t[1]<e[1]?-1:t[1]>e[1]?1:0),o1e=[[["A","DA"],"Adenosine"],[["C","DC"],"Cytidine"],[["T","DT"],"Thymidine"],[["G","DG"],"Guanosine"],[["I","DI"],"Inosine"],[["U","DU"],"Uridine"],[["N","DN"],"Unknown"]].sort((t,e)=>t[1]<e[1]?-1:t[1]>e[1]?1:0);function fR([t,e],r,n=0){let o=t.length===1&&!JX.has(t[0])?`[${t[0]}] ${e}`:`${e} (${t.join(", ")})`;return Lr(o,q.struct.modifier.union([q.struct.generator.atomGroups({"residue-test":q.core.set.has([q.set(...t),q.ammp("auth_comp_id")])})]),{category:r,priority:n,description:o})}function i1e([t,e],r,n){let o=`${e} (${t.join(", ")})`;return Lr(o,q.struct.modifier.union([q.struct.generator.atomGroups({"atom-test":q.core.set.has([q.set(...t),q.acp("elementSymbol")])})]),{category:r,priority:n,description:o})}function a1e([t,e],r,n){let o=`${e}`;return Lr(`${e}`,q.struct.modifier.union([q.struct.generator.atomGroups({"entity-test":q.core.list.equal([q.list(...t),q.ammp("entityDescription")])})]),{category:r,priority:n,description:o})}var JX=no.unionMany(Xz,Kz,$z,Wz);function eY(t){let e=new Set;for(let n of t)n.uniqueElementSymbols.forEach(o=>e.add(o));let r=[];return e.forEach(n=>{let o=XX[n]||n;r.push(i1e([[n],o],"Element Symbol",0))}),r}function tY(t){let e=new Map,r=new Set;for(let o of t){o.uniqueResidueNames.forEach(i=>r.add(i));for(let i of o.models)o.uniqueResidueNames.forEach(a=>{let s=i.properties.chemicalComponentMap.get(a);s&&e.set(a,s.name)})}let n=[];return no.difference(r,JX).forEach(o=>{let i=e.get(o)||o;n.push(fR([[o],i],"Ligand/Non-standard Residue",200))}),n}function rY(t){let e=new Map,r=z.Location.create();for(let o of t){r.structure=o;for(let i of o.unitSymmetryGroups){r.unit=i.units[0],r.element=i.elements[0];let a=Ne.entity.type(r);if(a==="polymer"||a==="branched"){let s=Ne.entity.pdbx_description(r);e.set(s.join(", "),s)}}}let n=[];return e.forEach((o,i)=>{n.push(a1e([o,i],"Polymer/Carbohydrate Entities",300))}),n}var Qn={all:Ixe,current:Dxe,polymer:Axe,trace:kxe,backbone:Mxe,sidechain:Rxe,sidechainWithTrace:Lxe,protein:Bxe,nucleic:Oxe,helix:Fxe,beta:Nxe,water:Vxe,ion:zxe,lipid:Uxe,branched:Lw,branchedPlusConnected:QX,branchedConnectedOnly:KX,ligand:hR,ligandPlusConnected:$X,ligandConnectedOnly:ZX,connectedOnly:Gxe,disulfideBridges:jxe,nosBridges:Hxe,nonStandardPolymer:qxe,coarse:Wxe,ring:Xxe,aromaticRing:Yxe,surroundings:Qxe,surroundingLigands:Kxe,surroundingAtoms:$xe,complement:Zxe,covalentlyBonded:Jxe,covalentlyOrMetallicBonded:t1e,covalentlyBondedComponent:e1e,wholeResidues:r1e},Mw=class{add(e){this.list.push(e),this.options.push([e,e.label,e.category]),this.version+=1}remove(e){let r=this.list.indexOf(e);r!==-1&&(this.list.splice(r,1),this.options.splice(r,1),this.version+=1)}constructor(){this.list=[],this.options=[],this.version=1,this.list.push(...Object.values(Qn),...n1e.map(e=>fR(e,Ur.AminoAcid)),...o1e.map(e=>fR(e,Ur.NucleicBase))),this.options.push(...this.list.map(e=>[e,e.label,e.category]))}};var nY=()=>({type:g.MappedStatic("static",{static:g.Text("polymer"),expression:g.Value(q.struct.generator.all),bundle:g.Value(z.Bundle.Empty),script:g.Script({language:"mol-script",expression:"(sel.atom.all)"})},{isHidden:!0}),nullIfEmpty:g.Optional(g.Boolean(!0,{isHidden:!0})),label:g.Text("",{isHidden:!0})});function oY(t,e,r){r.source=t;let n=ue.Empty,o;switch(e.type.name){case"static":{let a;switch(e.type.params){case"all":a=Qn.all.query,o="All";break;case"polymer":a=Qn.polymer.query,o="Polymer";break;case"protein":a=Qn.protein.query,o="Protein";break;case"nucleic":a=Qn.nucleic.query,o="Nucleic";break;case"water":a=cn.internal.water(),o="Water";break;case"ion":a=Qn.ion.query,o="Ion";break;case"lipid":a=Qn.lipid.query,o="Lipid";break;case"branched":a=Qn.branchedPlusConnected.query,o="Branched";break;case"ligand":a=Qn.ligandPlusConnected.query,o="Ligand";break;case"non-standard":a=Qn.nonStandardPolymer.query,o="Non-standard";break;case"coarse":a=Qn.coarse.query,o="Coarse";break;default:ur(e.type)}let s=a(new fa(t));n=hn.unionStructure(s);break}case"script":case"expression":{let{selection:a,entry:s}=Oa.createAndRun(t,e.type.params);r.entry=s,n=hn.unionStructure(a);break}case"bundle":{if(e.type.params.hash!==t.hashCode)break;n=z.Bundle.toStructure(e.type.params,t);break}}if(e.nullIfEmpty&&n.elementCount===0)return Rr.Null;let i={label:`${e.label||o||"Component"}`,description:ue.elementDescription(n)};return new X.Molecule.Structure(n,i)}function iY(t,e,r,n,o){if(r.type.name!==n.type.name)return Se.UpdateResult.Recreate;let i=!1;switch(n.type.name){case"static":return r.type.params!==n.type.params?Se.UpdateResult.Recreate:ue.areEquivalent(t,o.source)?e.data.model===t.model?Se.UpdateResult.Unchanged:Et.areHierarchiesEqual(t.model,e.data.model)?(e.data=e.data.remapModel(t.model),Se.UpdateResult.Updated):Se.UpdateResult.Recreate:Se.UpdateResult.Recreate;case"script":if(!Jr.areEqual(r.type.params,n.type.params))return Se.UpdateResult.Recreate;case"expression":{if(r.type.params!==n.type.params)return Se.UpdateResult.Recreate;if(t===o.source)break;let a=o.entry,s=Oa.updateStructure(a,t);o.source=t,e.data=hn.unionStructure(s),Oa.updateStructureObject(e,s,n.label),i=!0;break}case"bundle":{if(t===o.source&&z.Bundle.areEqual(r.type.params,n.type.params))break;o.source=t,n.type.params.hash!==t.hashCode?(i=e.data.elementCount!==0,e.data=e.data.elementCount===0?e.data:ue.Empty):(i=!0,e.data=z.Bundle.toStructure(n.type.params,t));break}}if(i){if(n.nullIfEmpty&&e.data.elementCount===0)return Se.UpdateResult.Null;e.description=ue.elementDescription(e.data)}return r.label!==n.label&&(i=!0,e.label=`${n.label||e.label}`),i?Se.UpdateResult.Updated:Se.UpdateResult.Unchanged}function aY(t){switch(t){case 7:return-3;case 6:return-2;case 5:return-1;case 0:return 0;case 3:return 1;case 2:return 2;case 1:return 3;case 4:return 0;default:return console.error(`Value ${t} is outside the 0-7 range, defaulting to 0.`),0}}function gR(t,e){let r=Ce.create(t.data,e*2),n=Ce.create(t.data,e*2),o=Ce.create(t.data,e*2),i=Ce.create(t.data,e*2),a=Ce.create(t.data,e*2);for(let s=0;s<e;++s){Fe.markLine(t);let{tokenStart:l,position:c}=t;Fe.trim(t,l,l+10),Ce.addUnchecked(r,t.tokenStart,t.tokenEnd),Fe.trim(t,l+10,l+20),Ce.addUnchecked(n,t.tokenStart,t.tokenEnd),Fe.trim(t,l+20,l+30),Ce.addUnchecked(o,t.tokenStart,t.tokenEnd),Fe.trim(t,l+31,l+34),Ce.addUnchecked(i,t.tokenStart,t.tokenEnd),Fe.trim(t,l+36,l+39),Ce.addUnchecked(a,t.tokenStart,t.tokenEnd),t.position=c}return{count:e,x:xt(r)(K.Schema.float),y:xt(n)(K.Schema.float),z:xt(o)(K.Schema.float),type_symbol:xt(i)(K.Schema.str),formal_charge:xt(a)(K.Schema.int)}}function yR(t,e){let r=Ce.create(t.data,e*2),n=Ce.create(t.data,e*2),o=Ce.create(t.data,e*2);for(let i=0;i<e;++i){Fe.markLine(t);let{tokenStart:a,position:s}=t;Fe.trim(t,a,a+3),Ce.addUnchecked(r,t.tokenStart,t.tokenEnd),Fe.trim(t,a+3,a+6),Ce.addUnchecked(n,t.tokenStart,t.tokenEnd),Fe.trim(t,a+6,a+9),Ce.addUnchecked(o,t.tokenStart,t.tokenEnd),t.position=s}return{count:e,atomIdxA:xt(r)(K.Schema.int),atomIdxB:xt(n)(K.Schema.int),order:xt(o)(K.Schema.int)}}function s1e(t,e,r){Fe.trim(t,e+6,e+9);let n=parseInt(Fe.getTokenString(t));for(let o=0;o<n;++o){let i=9+o*8;Fe.trim(t,e+i,e+i+4);let a=Fe.getTokenString(t);r.atomIdx.push(+a),Fe.trim(t,e+i+4,e+i+8);let s=Fe.getTokenString(t);r.charge.push(+s)}Fe.eatLine(t)}function vR(t){let n={atomIdx:[],charge:[]};for(;t.position<t.length;){let{position:i}=t;Fe.trim(t,i+3,i+6);let a=Fe.getTokenString(t);if(a==="END")break;switch(Fe.eatLine(t),a){case"CHG":s1e(t,i,n);break;default:break}}return{atomIdx:K.ofIntArray(n.atomIdx),charge:K.ofIntArray(n.charge)}}function l1e(t){let e=Fe(t),r=Fe.readLine(e).trim(),n=Fe.readLine(e).trim(),o=Fe.readLine(e).trim(),i=Fe.readLine(e),a=+i.substr(0,3),s=+i.substr(3,3),l=gR(e,a),c=yR(e,s),u=vR(e),d={title:r,program:n,comment:o,atoms:l,bonds:c,formalCharges:u};return xr.success(d)}function sY(t){return ie.create("Parse Mol",()=>N(this,null,function*(){return l1e(t)}))}function xR(t,e,r){return N(this,null,function*(){let{atoms:n,bonds:o,formalCharges:i}=t,a=K.ofConst("MOL",t.atoms.count,K.Schema.str),s=K.ofConst("A",t.atoms.count,K.Schema.str),l=K.asArrayColumn(n.type_symbol),c=K.ofConst(1,n.count,K.Schema.int),u=new Int32Array(t.atoms.count);if(i.atomIdx.rowCount>0)for(let b=0;b<i.atomIdx.rowCount;b++)u[i.atomIdx.value(b)-1]=i.charge.value(b);else for(let b=0;b<t.atoms.count;b++)u[b]=aY(n.formal_charge.value(b));let d=Xo.ofPartialColumns(ha.atom_site,{auth_asym_id:s,auth_atom_id:l,auth_comp_id:a,auth_seq_id:c,Cartn_x:K.asArrayColumn(n.x,Float32Array),Cartn_y:K.asArrayColumn(n.y,Float32Array),Cartn_z:K.asArrayColumn(n.z,Float32Array),id:K.range(0,n.count-1),label_asym_id:s,label_atom_id:l,label_comp_id:a,label_seq_id:c,label_entity_id:K.ofConst("1",n.count,K.Schema.str),occupancy:K.ofConst(1,n.count,K.Schema.float),type_symbol:l,pdbx_PDB_model_num:K.ofConst(1,n.count,K.Schema.int),pdbx_formal_charge:K.ofIntArray(u)},n.count),m=new Oi;m.setNames([["MOL","Unknown Entity"]]),m.getEntityId("MOL",0,"A");let p=new Fi(c,l);p.setNames([["MOL","Unknown Molecule"]]),p.add("MOL",0);let h=Bi({entity:m.getEntityTable(),chem_comp:p.getChemCompTable(),atom_site:d}),f=yield wl(h,e??bR.create(t),r);if(f.frameCount>0){let b=K.ofIntArray(K.mapToArray(o.atomIdxA,T=>T-1,Int32Array)),v=K.ofIntArray(K.mapToArray(o.atomIdxB,T=>T-1,Int32Array)),x=K.asArrayColumn(o.order,Int32Array),S=ld.fromData({pairs:{indexA:b,indexB:v,order:x},count:n.count},{maxDistance:1/0});ld.Provider.set(f.representative,S)}return f})}var bR;(function(t){function e(n){return n?.kind==="mol"}t.is=e;function r(n){return{kind:"mol",name:n.title,data:n}}t.create=r})(bR||(bR={}));function lY(t){return ie.create("Parse MOL",e=>xR(t,void 0,e))}function c1e(t){let e=t.it_number.value(0),r=t["name_h-m_full"].value(0).replace("-"," ");return t.it_number.isDefined?(t["name_h-m_full"].isDefined,e):r}function u1e(t){let{cell:e,space_group:r}=t,n=c1e(r),o=pa.create(n,y.create(e.length_a.value(0),e.length_b.value(0),e.length_c.value(0)),y.scale(y(),y.create(e.angle_alpha.value(0),e.angle_beta.value(0),e.angle_gamma.value(0)),Math.PI/180));return{spacegroup:S0.create(o),assemblies:[],isNonStandardCrystalFrame:!1,ncsOperators:[]}}function d1e(t,e,r){return N(this,null,function*(){var n;let o=t.atom_site._rowCount,i=K.ofConst("MOL",o,K.Schema.str),a=K.ofConst("A",o,K.Schema.str),s=K.ofConst(1,o,K.Schema.int),l=u1e(t),c=l.spacegroup.cell.fromFractional,{fract_x:u,fract_y:d,fract_z:m}=t.atom_site,p=new Float32Array(o),h=new Float32Array(o),f=new Float32Array(o),b=y();for(let k=0;k<o;++k)y.set(b,u.value(k),d.value(k),m.value(k)),y.transformMat4(b,b,c),p[k]=b[0],h[k]=b[1],f[k]=b[2];let{type_symbol:v,label:x}=t.atom_site,S,T;if(v.isDefined){let k=new Array(o),M=new Int8Array(o);for(let R=0;R<o;++R){let B=v.value(R),F=B.length;B[F-1]==="+"?(k[R]=B.substring(0,F-2),M[R]=parseInt(B[F-2])):B[F-2]==="+"?(k[R]=B.substring(0,F-2),M[R]=parseInt(B[F-1])):B[F-1]==="-"?(k[R]=B.substring(0,F-2),M[R]=-parseInt(B[F-2])):B[F-2]==="-"?(k[R]=B.substring(0,F-2),M[R]=-parseInt(B[F-1])):(k[R]=B,M[R]=0)}S=K.ofStringArray(k),T=K.ofIntArray(M)}else{let k=new Array(o);for(let M=0;M<o;++M)k[M]=vu(x.value(M),"");S=K.ofStringArray(k),T=K.Undefined(o,K.Schema.int)}let E=Xo.ofPartialColumns(ha.atom_site,{auth_asym_id:a,auth_atom_id:x,auth_comp_id:i,auth_seq_id:s,Cartn_x:K.ofFloatArray(p),Cartn_y:K.ofFloatArray(h),Cartn_z:K.ofFloatArray(f),id:K.range(0,o-1),label_asym_id:a,label_atom_id:x,label_comp_id:i,label_seq_id:s,label_entity_id:K.ofConst("1",o,K.Schema.str),occupancy:t.atom_site.occupancy.isDefined?t.atom_site.occupancy:K.ofConst(1,o,K.Schema.float),type_symbol:S,pdbx_formal_charge:T,pdbx_PDB_model_num:K.ofConst(1,o,K.Schema.int),B_iso_or_equiv:t.atom_site.u_iso_or_equiv},o),_=t.chemical.name_common.value(0)||t.chemical.name_systematic.value(0)||t.chemical_formula.sum.value(0),D=new Oi;D.setNames([["MOL",_||"Unknown Entity"]]),D.getEntityId("MOL",0,"A");let P=new Fi(s,t.atom_site.type_symbol);P.setNames([["MOL",_||"Unknown Molecule"]]),P.add("MOL",0);let A=Bi({entity:D.getEntityTable(),chem_comp:P.getChemCompTable(),atom_site:E}),I=yield wl(A,e,r);if(I.frameCount>0){let k=I.representative;rs.Provider.set(k,l);let M=t.geom_bond._rowCount;if(M>0){let R={},{label:B}=t.atom_site;for(let Z=0,se=B.rowCount;Z<se;++Z)R[B.value(Z)]=Z;let F=(n=e.data.frame.categories.ccdc_geom_bond_type)===null||n===void 0?void 0:n.getField(""),G=[],V=[],H=[],Q=[],L=[],Y=new Set,j=0,{atom_site_label_1:O,atom_site_label_2:J,valence:$,distance:ae}=t.geom_bond;for(let Z=0;Z<M;++Z){let se=R[O.value(Z)],Me=R[J.value(Z)],be=se<Me?rm(se,Me):rm(Me,se);if(!Y.has(be)){if(Y.add(be),G[j]=se,V[j]=Me,Q[j]=ae.value(Z)||-1,F){let _e=F.str(Z);_e==="D"?(H[j]=2,L[j]=1):_e==="A"?(H[j]=1,L[j]=17):(H[j]=1,L[j]=1)}else L[j]=1,H[j]=$.isDefined?$.value(Z):1;j+=1}}ld.Provider.set(k,ld.fromData({pairs:{indexA:K.ofIntArray(G),indexB:K.ofIntArray(V),order:K.ofIntArray(H),distance:K.ofFloatArray(Q),flag:K.ofIntArray(L)},count:o}))}}return I})}function m1e(t){if(!X1.is(t.sourceData))return;let{atom_site:e,atom_site_aniso:r}=t.sourceData.data.db,n=Xo.ofPartialColumns(hf.Schema,{U:r.u},r._rowCount),o=hf.getElementToAnsiotropFromLabel(e.label,r.label);return{data:n,elementToAnsiotrop:o}}function p1e(t){return X1.is(t.sourceData)?t.sourceData.data.db.atom_site_aniso.u.isDefined:!1}hf.Provider.formatRegistry.add("cifCore",m1e,p1e);var X1;(function(t){function e(n){return n?.kind==="cifCore"}t.is=e;function r(n,o){return o||(o=lc.schema.cifCore(n)),{kind:"cifCore",name:o.database_code.depnum_ccdc_archive.value(0)||o.database_code.depnum_ccdc_fiz.value(0)||o.database_code.icsd.value(0)||o.database_code.mdf.value(0)||o.database_code.nbs.value(0)||o.database_code.csd.value(0)||o.database_code.cod.value(0)||o._name,data:{db:o,frame:n}}}t.fromFrame=r})(X1||(X1={}));function cY(t){let e=X1.fromFrame(t);return ie.create("Parse CIF Core",r=>d1e(e.data.db,e,r))}function f1e(t,e){return N(this,null,function*(){let{atoms:r}=t,n=K.ofConst("MOL",t.atoms.count,K.Schema.str),o=K.ofConst("A",t.atoms.count,K.Schema.str),i=K.ofArray({array:K.mapToArray(r.number,d=>qz(d)),schema:K.Schema.Aliased(K.Schema.str)}),a=K.ofConst(1,r.count,K.Schema.int),s=Xo.ofPartialColumns(ha.atom_site,{auth_asym_id:o,auth_atom_id:i,auth_comp_id:n,auth_seq_id:a,Cartn_x:K.asArrayColumn(r.x,Float32Array),Cartn_y:K.asArrayColumn(r.y,Float32Array),Cartn_z:K.asArrayColumn(r.z,Float32Array),id:K.range(0,r.count-1),label_asym_id:o,label_atom_id:i,label_comp_id:n,label_seq_id:a,label_entity_id:K.ofConst("1",r.count,K.Schema.str),occupancy:K.ofConst(1,r.count,K.Schema.float),type_symbol:i,pdbx_PDB_model_num:K.ofConst(1,r.count,K.Schema.int)},r.count),l=new Oi;l.setNames([["MOL","Unknown Entity"]]),l.getEntityId("MOL",0,"A");let c=new Fi(a,i);c.setNames([["MOL","Unknown Molecule"]]),c.add("MOL",0);let u=Bi({entity:l.getEntityTable(),chem_comp:c.getChemCompTable(),atom_site:s});return yield wl(u,SR.create(t),e)})}var SR;(function(t){function e(n){return n?.kind==="cube"}t.is=e;function r(n){return{kind:"cube",name:n.header.comment1,data:n}}t.create=r})(SR||(SR={}));function uY(t){return ie.create("Parse Cube",e=>f1e(t,e))}var{skipWhitespace:CR,eatValue:dY,markLine:bu,getTokenString:xu,readLine:mY}=Fe;function h1e(){return{mol_name:"",num_atoms:0,num_bonds:0,num_subst:0,num_feat:0,num_sets:0,mol_type:"",charge_type:"",status_bits:"",mol_comment:""}}function g1e(t,e){return{tokenizer:t,molecule:h1e(),runtimeCtx:e}}var pY=/\s+/g;function y1e(t){let{tokenizer:e,molecule:r}=t;for(;xu(e)!=="@<TRIPOS>MOLECULE"&&e.position<e.data.length;)bu(e);bu(e),r.mol_name=xu(e),bu(e);let n=xu(e).trim().split(pY);r.num_atoms=parseInt(n[0]),r.num_bonds=parseInt(n[1]),r.num_subst=parseInt(n[2]),r.num_feat=parseInt(n[3]),r.num_sets=parseInt(n[4]),bu(e);let o=xu(e);if(o.startsWith("@<TRIPOS>"))return;r.mol_type=o,bu(e);let i=xu(e);if(i.startsWith("@<TRIPOS>"))return;r.charge_type=i,bu(e);let a=xu(e);if(a.startsWith("@<TRIPOS>"))return;r.status_bits=a,bu(e);let s=xu(e);s.startsWith("@<TRIPOS>")||(r.mol_comment=s)}function v1e(t){return N(this,null,function*(){let{tokenizer:e,molecule:r}=t;for(;xu(e)!=="@<TRIPOS>ATOM"&&e.position<e.data.length;)bu(e);let n=e.position,o=e.lineNumber,s=mY(e).trim().split(/\s+/g).length,l=Ce.create(e.data,r.num_atoms*2),c=Ce.create(e.data,r.num_atoms*2),u=Ce.create(e.data,r.num_atoms*2),d=Ce.create(e.data,r.num_atoms*2),m=Ce.create(e.data,r.num_atoms*2),p=Ce.create(e.data,r.num_atoms*2),h=Ce.create(e.data,r.num_atoms*2),f=Ce.create(e.data,r.num_atoms*2),b=Ce.create(e.data,r.num_atoms*2),v=Ce.create(e.data,r.num_atoms*2),x=K.Undefined(r.num_atoms,K.Schema.float),S=K.Undefined(r.num_atoms,K.Schema.int),T=K.Undefined(r.num_atoms,K.Schema.str);e.position=n,e.lineNumber=o;let{length:E}=e,_=0;return yield om(t.runtimeCtx,1e5,void 0,P=>{let A=Math.min(r.num_atoms-_,P);for(let I=0;I<A;I++)for(let k=0;k<s;k++)switch(CR(e),e.tokenStart=e.position,dY(e),k){case 0:Ce.addUnchecked(l,e.tokenStart,e.tokenEnd);break;case 1:Ce.addUnchecked(c,e.tokenStart,e.tokenEnd);break;case 2:Ce.addUnchecked(u,e.tokenStart,e.tokenEnd);break;case 3:Ce.addUnchecked(d,e.tokenStart,e.tokenEnd);break;case 4:Ce.addUnchecked(m,e.tokenStart,e.tokenEnd);break;case 5:Ce.addUnchecked(p,e.tokenStart,e.tokenEnd);break;case 6:Ce.addUnchecked(h,e.tokenStart,e.tokenEnd);break;case 7:Ce.addUnchecked(f,e.tokenStart,e.tokenEnd);break;case 8:Ce.addUnchecked(b,e.tokenStart,e.tokenEnd);break;case 9:Ce.addUnchecked(v,e.tokenStart,e.tokenEnd);break}return _+=A,A},P=>P.update({message:"Parsing...",current:e.position,max:E})),{count:r.num_atoms,atom_id:xt(l)(K.Schema.int),atom_name:xt(c)(K.Schema.str),x:xt(u)(K.Schema.float),y:xt(d)(K.Schema.float),z:xt(m)(K.Schema.float),atom_type:s>5?xt(p)(K.Schema.str):T,subst_id:s>6?xt(h)(K.Schema.int):S,subst_name:s>7?xt(f)(K.Schema.str):T,charge:s>8?xt(b)(K.Schema.float):x,status_bit:s>9?xt(v)(K.Schema.str):T}})}function b1e(t){return N(this,null,function*(){let{tokenizer:e,molecule:r}=t;for(;xu(e)!=="@<TRIPOS>BOND"&&e.position<e.data.length;)bu(e);let n=e.position,o=e.lineNumber,s=mY(e).trim().split(/\s+/g).length,l=Ce.create(e.data,r.num_bonds*2),c=Ce.create(e.data,r.num_bonds*2),u=Ce.create(e.data,r.num_bonds*2),d=Ce.create(e.data,r.num_bonds*2),m=Ce.create(e.data,r.num_bonds*2);e.position=n,e.lineNumber=o;let{length:p}=e,h=0;return yield om(t.runtimeCtx,1e5,void 0,b=>{let v=Math.min(r.num_bonds-h,b);for(let x=0;x<v;x++)for(let S=0;S<s;S++)switch(CR(e),e.tokenStart=e.position,dY(e),S){case 0:Ce.addUnchecked(l,e.tokenStart,e.tokenEnd);break;case 1:Ce.addUnchecked(c,e.tokenStart,e.tokenEnd);break;case 2:Ce.addUnchecked(u,e.tokenStart,e.tokenEnd);break;case 3:Ce.addUnchecked(d,e.tokenStart,e.tokenEnd);break;default:Ce.addUnchecked(m,e.tokenStart,e.tokenEnd);break}return h+=v,v},b=>b.update({message:"Parsing...",current:e.position,max:p})),{count:r.num_bonds,bond_id:xt(l)(K.Schema.int),origin_atom_id:xt(c)(K.Schema.int),target_atom_id:xt(u)(K.Schema.int),bond_type:xt(d)(K.Schema.str),status_bits:s>4?xt(m)(K.Schema.str):K.Undefined(r.num_bonds,K.Schema.str)}})}function x1e(t){let{tokenizer:e}=t;for(;e.position<e.data.length;){let n=xu(e);if(n==="@<TRIPOS>MOLECULE")return;if(n==="@<TRIPOS>CRYSIN")break;bu(e)}if(e.position>=e.data.length)return;bu(e);let r=xu(e).trim().split(pY);return{a:parseFloat(r[0]),b:parseFloat(r[1]),c:parseFloat(r[2]),alpha:parseFloat(r[3]),beta:parseFloat(r[4]),gamma:parseFloat(r[5]),spaceGroup:parseInt(r[6],10),setting:parseInt(r[7],10)}}function S1e(t,e,r){return N(this,null,function*(){let n=Fe(e);t.update({message:"Parsing...",current:0,max:e.length});let o=[];for(;n.position<e.length;){let a=g1e(n,t);y1e(a);let s=yield v1e(a),l=yield b1e(a),c=x1e(a);for(o.push({molecule:a.molecule,atoms:s,bonds:l,crysin:c}),CR(n);xu(n)!=="@<TRIPOS>MOLECULE"&&n.position<n.data.length;)bu(n)}let i={name:r,structures:o};return xr.success(i)})}function fY(t,e){return ie.create("Parse MOL2",r=>N(this,null,function*(){return yield S1e(r,t,e)}))}function C1e(t,e){return N(this,null,function*(){let r=[];for(let n=0,o=t.structures.length;n<o;++n){let{molecule:i,atoms:a,bonds:s,crysin:l}=t.structures[n],c=K.ofConst("A",a.count,K.Schema.str),u=new Array(a.count),d=!1;for(let v=0;v<a.count;++v)if(a.atom_type.value(v).includes(".")){d=!0;break}for(let v=0;v<a.count;++v)u[v]=d?a.atom_type.value(v).split(".")[0].toUpperCase():vu(a.atom_name.value(v),a.subst_name.value(v));let m=Xo.ofPartialColumns(ha.atom_site,{auth_asym_id:c,auth_atom_id:K.asArrayColumn(a.atom_name),auth_comp_id:a.subst_name,auth_seq_id:a.subst_id,Cartn_x:K.asArrayColumn(a.x,Float32Array),Cartn_y:K.asArrayColumn(a.y,Float32Array),Cartn_z:K.asArrayColumn(a.z,Float32Array),id:K.asArrayColumn(a.atom_id),label_asym_id:c,label_atom_id:K.asArrayColumn(a.atom_name),label_comp_id:a.subst_name,label_seq_id:a.subst_id,label_entity_id:K.ofConst("1",a.count,K.Schema.str),occupancy:K.ofConst(1,a.count,K.Schema.float),type_symbol:K.ofStringArray(u),pdbx_PDB_model_num:K.ofConst(n,a.count,K.Schema.int)},a.count),p=new Oi;p.setNames([["MOL",i.mol_name||"Unknown Entity"]]),p.getEntityId("MOL",0,"A");let h=new Fi(a.subst_id,a.atom_name);for(let v=0,x=a.subst_name.rowCount;v<x;++v)h.add(a.subst_name.value(v),v);let f=Bi({entity:p.getEntityTable(),chem_comp:h.getChemCompTable(),atom_site:m}),b=yield wl(f,TR.create(t),e);if(b.frameCount>0){let v=K.ofIntArray(K.mapToArray(s.origin_atom_id,P=>P-1,Int32Array)),x=K.ofIntArray(K.mapToArray(s.target_atom_id,P=>P-1,Int32Array)),S=s.bond_id,T=K.ofIntArray(K.mapToArray(s.bond_type,P=>{switch(P){case"ar":case"am":case"un":return 1;case"du":case"nc":return 0;default:return parseInt(P)}},Int8Array)),E=K.ofIntArray(K.mapToArray(s.bond_type,P=>{switch(P){case"ar":case"am":return 17;case"du":case"nc":return 0;case"un":default:return 1}},Int8Array)),_=ld.fromData({pairs:{key:S,indexA:v,indexB:x,order:T,flag:E},count:a.count},{maxDistance:l?-1:1/0}),D=b.representative;if(ld.Provider.set(D,_),vp.Provider.set(D,{data:a.charge,type:i.charge_type}),l){let P=T1e(l);P&&rs.Provider.set(D,P)}r.push(D)}}return new yf(r)})}function T1e(t){if(t.setting!==1)return;let e=pa.create(t.spaceGroup,y.create(t.a,t.b,t.c),y.scale(y(),y.create(t.alpha,t.beta,t.gamma),Math.PI/180));return{spacegroup:S0.create(e),assemblies:[],isNonStandardCrystalFrame:!1,ncsOperators:[]}}var TR;(function(t){function e(n){return n?.kind==="mol2"}t.is=e;function r(n){return{kind:"mol2",name:n.name,data:n}}t.create=r})(TR||(TR={}));function hY(t){return ie.create("Parse MOL2",e=>C1e(t,e))}var Dv=new Uint32Array([0,0,0,0,0,0,0,0,0,8,10,12,16,20,25,32,40,50,64,80,101,128,161,203,256,322,406,512,645,812,1024,1290,1625,2048,2580,3250,4096,5060,6501,8192,10321,13003,16384,20642,26007,32768,41285,52015,65536,82570,104031,131072,165140,208063,262144,330280,416127,524287,660561,832255,1048576,1321122,1664510,2097152,2642245,3329021,4194304,5284491,6658042,8388607,10568983,13316085,16777216]),wR=9,Nl;(function(t){function e(u){let d=1,m=0;for(;u>=d&&m<32;)m++,d<<=1;return m}t.sizeOfInt=e;let r=new Uint8Array(32);function n(u,d){let m=1,p=0;r[0]=1;for(let f=0;f<u;f++){let b,v=0;for(b=0;b<m;b++)v+=r[b]*d[f],r[b]=v&255,v>>=8;for(;v!==0;)r[b++]=v&255,v>>=8;m=b}let h=1;for(m--;r[m]>=h;)p++,h*=2;return p+m*8}t.sizeOfInts=n;let o=new ArrayBuffer(8*3);t.buf=new Int32Array(o);let i=new Uint32Array(o);function a(u,d,m){let p=m,h=(1<<p)-1,f=i[1],b=i[2],v=t.buf[0],x=0;for(;p>=8;)b=b<<8|u[d+v++],x|=b>>f<<p-8,p-=8;return p>0&&(f<p&&(f+=8,b=b<<8|u[d+v++]),f-=p,x|=b>>f&(1<<p)-1),x&=h,t.buf[0]=v,t.buf[1]=f,t.buf[2]=b,x}t.decodeBits=a;function s(u,d){let m=i[2],p=t.buf[0];return m=m<<8|u[d+p],t.buf[0]=p+1,t.buf[2]=m,m>>i[1]&255}let l=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];function c(u,d,m,p,h){let f=m,b=0;for(l[0]=0,l[1]=0,l[2]=0,l[3]=0;f>8;)l[b++]=s(u,d),f-=8;f>0&&(l[b++]=a(u,d,f));for(let v=2;v>0;v--){let x=0,S=p[v];for(let T=b-1;T>=0;T--){x=x<<8|l[T];let E=x/S|0;l[T]=E,x=x-E*S}h[v]=x}h[0]=l[0]|l[1]<<8|l[2]<<16|l[3]<<24}t.decodeInts=c})(Nl||(Nl={}));function w1e(){throw new Error("(xdrfile error) Undefined error.")}function _1e(t,e){return N(this,null,function*(){let r=new DataView(e.buffer,e.byteOffset),n={frames:[],boxes:[],times:[],timeOffset:0,deltaTime:0},o=n.frames,i=n.boxes,a=n.times,s=[0,0,0,0,0,0],l=[0,0,0],c=[0,0,0],u=[0,0,0],d=[.1,.1,.1],m=[.1,.1,.1],p=0,h=Nl.buf;for(;;){let f,b=r.getInt32(p+4);p+=12,a.push(r.getFloat32(p)),p+=4;let v=new Float32Array(9);for(let x=0;x<9;++x)v[x]=r.getFloat32(p)*10,p+=4;if(i.push(v),b<=9){f={count:b/3,x:new Float32Array(b/3),y:new Float32Array(b/3),z:new Float32Array(b/3)};for(let x=0;x<b/3;++x)f.x[x]=r.getFloat32(p),f.y[x]=r.getFloat32(p),f.z[x]=r.getFloat32(p),p+=4}else{h[0]=h[1]=h[2]=0,l[0]=l[1]=l[2]=0,u[0]=u[1]=u[2]=0,c[0]=c[1]=c[2]=0,d[0]=d[1]=d[2]=0,m[0]=m[1]=m[2]=0,f={count:b,x:new Float32Array(b),y:new Float32Array(b),z:new Float32Array(b)};let x=0,S=r.getInt32(p);p+=4;let T=r.getFloat32(p);p+=4,s[0]=r.getInt32(p),s[1]=r.getInt32(p+4),s[2]=r.getInt32(p+8),s[3]=r.getInt32(p+12),s[4]=r.getInt32(p+16),s[5]=r.getInt32(p+20),l[0]=s[3]-s[0]+1,l[1]=s[4]-s[1]+1,l[2]=s[5]-s[2]+1,p+=24;let E;(l[0]|l[1]|l[2])>16777215?(c[0]=Nl.sizeOfInt(l[0]),c[1]=Nl.sizeOfInt(l[1]),c[2]=Nl.sizeOfInt(l[2]),E=0):E=Nl.sizeOfInts(3,l);let _=r.getInt32(p);p+=4;let D=_-1;D=wR>D?wR:D;let P=Dv[D]/2|0,A=Dv[_]/2|0;u[0]=u[1]=u[2]=Dv[_];let I=Math.ceil(r.getInt32(p)/4)*4;p+=4;let k=1/T,M=0,R=0;for(d[0]=d[1]=d[2]=0;R<S;){E===0?(d[0]=Nl.decodeBits(e,p,c[0]),d[1]=Nl.decodeBits(e,p,c[1]),d[2]=Nl.decodeBits(e,p,c[2])):Nl.decodeInts(e,p,E,l,d),R++,d[0]+=s[0],d[1]+=s[1],d[2]+=s[2],m[0]=d[0],m[1]=d[1],m[2]=d[2];let B=Nl.decodeBits(e,p,1),F=0;if(B===1&&(M=Nl.decodeBits(e,p,5),F=M%3,M-=F,F--),M>0){d[0]=d[1]=d[2]=0;for(let G=0;G<M;G+=3){if(Nl.decodeInts(e,p,_,u,d),R++,d[0]+=m[0]-A,d[1]+=m[1]-A,d[2]+=m[2]-A,G===0){let V=d[0];d[0]=m[0],m[0]=V,V=d[1],d[1]=m[1],m[1]=V,V=d[2],d[2]=m[2],m[2]=V,f.x[x]=m[0]*k,f.y[x]=m[1]*k,f.z[x]=m[2]*k,x++}else m[0]=d[0],m[1]=d[1],m[2]=d[2];f.x[x]=d[0]*k,f.y[x]=d[1]*k,f.z[x]=d[2]*k,x++}}else f.x[x]=d[0]*k,f.y[x]=d[1]*k,f.z[x]=d[2]*k,x++;_+=F,F<0?(A=P,_>wR?P=Dv[_-1]/2|0:P=0):F>0&&(P=A,A=Dv[_]/2|0),u[0]=u[1]=u[2]=Dv[_],(u[0]===0||u[1]===0||u[2]===0)&&w1e()}p+=I}for(let x=0;x<b;x++)f.x[x]*=10,f.y[x]*=10,f.z[x]*=10;if(o.push(f),t.shouldUpdate&&(yield t.update({current:p,max:e.length})),p>=e.length)break}return a.length>=1&&(n.timeOffset=a[0]),a.length>=2&&(n.deltaTime=a[1]-a[0]),n})}function gY(t){return ie.create("Parse XTC",e=>N(this,null,function*(){try{e.update({canAbort:!0,message:"Parsing trajectory..."});let r=yield _1e(e,t);return xr.success(r)}catch(r){return xr.error(""+r)}}))}function yY(t){return ie.create("Parse XTC",e=>N(this,null,function*(){yield e.update("Converting to coordinates");let r=ma(t.deltaTime,"step"),n=ma(t.timeOffset,r.unit),o=[];for(let i=0,a=t.frames.length;i<a;++i){let s=t.boxes[i],l=y.fromArray(y(),s,0),c=y.fromArray(y(),s,3),u=y.fromArray(y(),s,6);o.push({elementCount:t.frames[i].count,cell:Cc.fromBasis(l,c,u),x:t.frames[i].x,y:t.frames[i].y,z:t.frames[i].z,xyzOrdering:{isIdentity:!0},time:ma(n.value+r.value*i,r.unit)})}return sf.create(o,r,n)}))}function P1e(t){let e=t.position>=t.data.length-1?0:+Fe.readLine(t);isNaN(e)&&(e=0);let r=Fe.readLine(t),n=new Float64Array(e),o=new Float64Array(e),i=new Float64Array(e),a=new Array(e);for(let s=0;s<e;++s){let c=Fe.readLineTrim(t).split(/\s+/g);a[s]=c[0],n[s]=+c[1],o[s]=+c[2],i[s]=+c[3]}return{count:e,comment:r,x:K.ofFloatArray(n),y:K.ofFloatArray(o),z:K.ofFloatArray(i),type_symbol:K.ofStringArray(a)}}function E1e(t){let e=Fe(t),r=[];for(;;){let o=P1e(e);if(o.count===0)break;r.push(o)}let n={molecules:r};return xr.success(n)}function vY(t){return ie.create("Parse Mol",()=>N(this,null,function*(){return E1e(t)}))}function I1e(t,e){let{molecules:r}=t,n=0;for(let S of r)n+=S.count;let o=new Array(n),i=new Int32Array(n),a=new Float32Array(n),s=new Float32Array(n),l=new Float32Array(n),c=new Int32Array(n),u=0;for(let S=0;S<r.length;S++){let T=r[S];for(let E=0;E<T.count;E++)o[u]=T.type_symbol.value(E),a[u]=T.x.value(E),s[u]=T.y.value(E),l[u]=T.z.value(E),i[u]=E,c[u]=S,u++}let d=K.ofConst("MOL",n,K.Schema.str),m=K.ofConst("A",n,K.Schema.str),p=K.ofConst(1,n,K.Schema.int),h=K.ofStringArray(o),f=Xo.ofPartialColumns(ha.atom_site,{auth_asym_id:m,auth_atom_id:h,auth_comp_id:d,auth_seq_id:p,Cartn_x:K.ofFloatArray(a),Cartn_y:K.ofFloatArray(s),Cartn_z:K.ofFloatArray(l),id:K.ofIntArray(i),label_asym_id:m,label_atom_id:h,label_comp_id:d,label_seq_id:p,label_entity_id:K.ofConst("1",n,K.Schema.str),occupancy:K.ofConst(1,n,K.Schema.float),type_symbol:h,pdbx_PDB_model_num:K.ofIntArray(c)},n),b=new Oi;b.setNames([["MOL","Unknown Entity"]]),b.getEntityId("MOL",0,"A");let v=new Fi(p,h);v.setNames([["MOL","Unknown Molecule"]]),v.add("MOL",0);let x=Bi({entity:b.getEntityTable(),chem_comp:v.getChemCompTable(),atom_site:f});return wl(x,_R.create(t),e)}var _R;(function(t){function e(n){return n?.kind==="xyz"}t.is=e;function r(n){return{kind:"xyz",name:"xyz",data:n}}t.create=r})(_R||(_R={}));function bY(t){return ie.create("Parse XYZ",e=>I1e(t,e))}function xY(t){return t.trim().endsWith("V3000")}function SY(t){let e=Ce.create(t.data,1),r=Ce.create(t.data,1);return Fe.eatLine(t),_p(t),_p(t),_p(t),wp(t,e),wp(t,r),Fe.eatLine(t),{atomCount:xt(e)(K.Schema.int).value(0),bondCount:xt(r)(K.Schema.int).value(0)}}function CY(t,e){let r=Ce.create(t.data,e*2),n=Ce.create(t.data,e*2),o=Ce.create(t.data,e*2),i=Ce.create(t.data,e*2);for(let a=0;a<e;++a){Fe.markLine(t),_p(t),_p(t),_p(t);let{position:s}=t;wp(t,i),wp(t,r),wp(t,n),wp(t,o),t.position=s}return Fe.eatLine(t),Fe.eatLine(t),{count:e,x:xt(r)(K.Schema.float),y:xt(n)(K.Schema.float),z:xt(o)(K.Schema.float),type_symbol:xt(i)(K.Schema.str),formal_charge:K.ofConst(0,e,K.Schema.int)}}function TY(t,e){let r=Ce.create(t.data,e*2),n=Ce.create(t.data,e*2),o=Ce.create(t.data,e*2);for(let i=0;i<e;++i){Fe.markLine(t),_p(t),_p(t),_p(t);let{position:a}=t;wp(t,o),wp(t,r),wp(t,n),t.position=a}return Fe.eatLine(t),Fe.eatLine(t),{count:e,atomIdxA:xt(r)(K.Schema.float),atomIdxB:xt(n)(K.Schema.float),order:xt(o)(K.Schema.float)}}function _p(t){Fe.skipWhitespace(t),Fe.eatValue(t)}function wp(t,e){let{position:r}=t;Fe.skipWhitespace(t),Fe.eatValue(t),Fe.trim(t,r,t.position),Ce.addUnchecked(e,t.tokenStart,t.tokenEnd)}var PR="$$$$";function D1e(t){let e=Ce.create(t.data,32),r=Ce.create(t.data,32);for(;t.position<t.length;){let n=Fe.readLine(t);if(n.startsWith(PR))break;if(n&&n.startsWith("> ")){Ce.add(e,t.tokenStart+2,t.tokenEnd),Fe.markLine(t);let o=t.tokenStart,i=t.tokenEnd,a=!1;for(;t.position<t.length;){let s=Fe.readLine(t);if(!s||s.startsWith(PR)||s.startsWith("> ")){Ce.add(r,o,i),a=!0;break}i=t.tokenEnd}a||Ce.add(r,o,i)}}return{dataHeader:xt(e)(K.Schema.str),data:xt(r)(K.Schema.str)}}function A1e(t){return{atomCount:+t.substr(0,3),bondCount:+t.substr(3,3)}}function k1e(t){let e=Fe.readLine(t).trim(),r=Fe.readLine(t).trim(),n=Fe.readLine(t).trim(),o=Fe.readLine(t),i=xY(o),{atomCount:a,bondCount:s}=i?SY(t):A1e(o);if(Number.isNaN(a)||Number.isNaN(s)){for(;t.position<t.length&&!Fe.readLine(t).startsWith(PR););return}let l={atomIdx:K.ofConst(0,a,K.Schema.int),charge:K.ofConst(0,a,K.Schema.int)},c=i?CY(t,a):gR(t,a),u=i?TY(t,s):yR(t,s),d=i?l:vR(t),m=D1e(t);return{molFile:{title:e,program:r,comment:n,atoms:c,bonds:u,formalCharges:d},dataItems:m}}function M1e(t){let e=Fe(t),r=[];for(;e.position<e.length;){let n=k1e(e);n&&r.push(n)}return xr.success({compounds:r})}function wY(t){return ie.create("Parse Sdf",()=>N(this,null,function*(){return M1e(t)}))}var ER;(function(t){function e(n){return n?.kind==="sdf"}t.is=e;function r(n){return{kind:"sdf",name:n.molFile.title,data:n}}t.create=r})(ER||(ER={}));function _Y(t){return ie.create("Parse SDF",e=>xR(t.molFile,ER.create(t),e))}function R1e(t){return N(this,null,function*(){let e=new DataView(t.buffer),r={frames:[],boxes:[],times:[],timeOffset:0,deltaTime:0},n=r.frames,o=r.boxes,i=r.times,a=0;for(;;){a+=8;let s=e.getInt32(a);a+=4,a+=s;let l=e.getInt32(a+8),c=e.getInt32(a+12),u=e.getInt32(a+16),d=e.getInt32(a+28),m=e.getInt32(a+32),p=e.getInt32(a+36),h=e.getInt32(a+40);a+=52;let f=l/9,b=h*3;if(f===8?i.push(e.getFloat64(a)):i.push(e.getFloat32(a)),a+=2*f,l){let v=new Float32Array(9);if(f===8)for(let x=0;x<9;++x)v[x]=e.getFloat64(a)*10,a+=8;else for(let x=0;x<9;++x)v[x]=e.getFloat32(a)*10,a+=4;o.push(v)}if(a+=c,a+=u,d){let v=new Float32Array(h),x=new Float32Array(h),S=new Float32Array(h);if(f===8)for(let T=0;T<h;++T)v[T]=e.getFloat64(a)*10,x[T]=e.getFloat64(a+8)*10,S[T]=e.getFloat64(a+16)*10,a+=24;else{let T=new Uint32Array(t.buffer,a,b);for(let _=0;_<b;++_){let D=T[_];T[_]=(D&255)<<24|(D&65280)<<8|D>>8&65280|D>>24&255}let E=new Float32Array(t.buffer,a,b);for(let _=0;_<h;++_)v[_]=E[_*3]*10,x[_]=E[_*3+1]*10,S[_]=E[_*3+2]*10,a+=12}n.push({count:h,x:v,y:x,z:S})}if(a+=m,a+=p,a>=t.byteLength)break}return i.length>=1&&(r.timeOffset=i[0]),i.length>=2&&(r.deltaTime=i[1]-i[0]),r})}function PY(t){return ie.create("Parse TRR",e=>N(this,null,function*(){try{e.update({canAbort:!0,message:"Parsing trajectory..."});let r=yield R1e(t);return xr.success(r)}catch(r){return xr.error(""+r)}}))}function EY(t){return ie.create("Parse TRR",e=>N(this,null,function*(){yield e.update("Converting to coordinates");let r=ma(t.deltaTime,"step"),n=ma(t.timeOffset,r.unit),o=[];for(let i=0,a=t.frames.length;i<a;++i){let s=t.boxes[i],l=y.fromArray(y(),s,0),c=y.fromArray(y(),s,3),u=y.fromArray(y(),s,6);o.push({elementCount:t.frames[i].count,cell:Cc.fromBasis(l,c,u),x:t.frames[i].x,y:t.frames[i].y,z:t.frames[i].z,xyzOrdering:{isIdentity:!0},time:ma(n.value+r.value*i,r.unit)})}return sf.create(o,r,n)}))}var IR=[],Bw=class{constructor(e,r={}){this._mark=0,this._marks=[],this.offset=0,this.littleEndian=!0;let n=!1;e===void 0&&(e=8192),typeof e=="number"?e=new ArrayBuffer(e):n=!0;let o=r.offset?r.offset>>>0:0,i=e.byteLength-o,a=o;e instanceof ArrayBuffer||(e.byteLength!==e.buffer.byteLength&&(a=e.byteOffset+o),e=e.buffer),n?this._lastWrittenByte=i:this._lastWrittenByte=0,this.buffer=e,this.length=i,this.byteLength=i,this.byteOffset=a,this._data=new DataView(this.buffer,a,i)}available(e=1){return this.offset+e<=this.length}isLittleEndian(){return this.littleEndian}setLittleEndian(){return this.littleEndian=!0,this}isBigEndian(){return!this.littleEndian}setBigEndian(){return this.littleEndian=!1,this}skip(e){return e===void 0&&(e=1),this.offset+=e,this}seek(e){return this.offset=e,this}mark(){return this._mark=this.offset,this}reset(){return this.offset=this._mark,this}pushMark(){return this._marks.push(this.offset),this}popMark(){let e=this._marks.pop();if(e===void 0)throw new Error("Mark stack empty");return this.seek(e),this}rewind(){return this.offset=0,this}ensureAvailable(e){if(e===void 0&&(e=1),!this.available(e)){let n=(this.offset+e)*2,o=new Uint8Array(n);o.set(new Uint8Array(this.buffer)),this.buffer=o.buffer,this.length=this.byteLength=n,this._data=new DataView(this.buffer)}return this}readBoolean(){return this.readUint8()!==0}readInt8(){return this._data.getInt8(this.offset++)}readUint8(){return this._data.getUint8(this.offset++)}readByte(){return this.readUint8()}readBytes(e){e===void 0&&(e=1);let r=new Uint8Array(e);for(let n=0;n<e;n++)r[n]=this.readByte();return r}readInt16(){let e=this._data.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}readUint16(){let e=this._data.getUint16(this.offset,this.littleEndian);return this.offset+=2,e}readInt32(){let e=this._data.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}readUint32(){let e=this._data.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}readFloat32(){let e=this._data.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}readFloat64(){let e=this._data.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}readChar(){return String.fromCharCode(this.readInt8())}readChars(e=1){IR.length=e;for(let r=0;r<e;r++)IR[r]=this.readChar();return IR.join("")}writeBoolean(e=!1){return this.writeUint8(e?255:0),this}writeInt8(e){return this.ensureAvailable(1),this._data.setInt8(this.offset++,e),this._updateLastWrittenByte(),this}writeUint8(e){return this.ensureAvailable(1),this._data.setUint8(this.offset++,e),this._updateLastWrittenByte(),this}writeByte(e){return this.writeUint8(e)}writeBytes(e){this.ensureAvailable(e.length);for(let r=0;r<e.length;r++)this._data.setUint8(this.offset++,e[r]);return this._updateLastWrittenByte(),this}writeInt16(e){return this.ensureAvailable(2),this._data.setInt16(this.offset,e,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeUint16(e){return this.ensureAvailable(2),this._data.setUint16(this.offset,e,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeInt32(e){return this.ensureAvailable(4),this._data.setInt32(this.offset,e,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeUint32(e){return this.ensureAvailable(4),this._data.setUint32(this.offset,e,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat32(e){return this.ensureAvailable(4),this._data.setFloat32(this.offset,e,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat64(e){return this.ensureAvailable(8),this._data.setFloat64(this.offset,e,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeChar(e){return this.writeUint8(e.charCodeAt(0))}writeChars(e){for(let r=0;r<e.length;r++)this.writeUint8(e.charCodeAt(r));return this}toArray(){return new Uint8Array(this.buffer,this.byteOffset,this._lastWrittenByte)}_updateLastWrittenByte(){this.offset>this._lastWrittenByte&&(this._lastWrittenByte=this.offset)}};function Su(t,e){if(t)throw new TypeError("Not a valid NetCDF v3.x file: "+e)}function IY(t){t.offset%4!==0&&t.skip(4-t.offset%4)}function DR(t){let e=t.readUint32(),r=t.readChars(e);return IY(t),r}var Go={BYTE:1,CHAR:2,SHORT:3,INT:4,FLOAT:5,DOUBLE:6};function DY(t){switch(Number(t)){case Go.BYTE:return"byte";case Go.CHAR:return"char";case Go.SHORT:return"short";case Go.INT:return"int";case Go.FLOAT:return"float";case Go.DOUBLE:return"double";default:return"undefined"}}function AY(t){switch(Number(t)){case Go.BYTE:return 1;case Go.CHAR:return 1;case Go.SHORT:return 2;case Go.INT:return 4;case Go.FLOAT:return 4;case Go.DOUBLE:return 8;default:return-1}}function kY(t){switch(String(t)){case"byte":return Go.BYTE;case"char":return Go.CHAR;case"short":return Go.SHORT;case"int":return Go.INT;case"float":return Go.FLOAT;case"double":return Go.DOUBLE;default:return-1}}function Ow(t,e){if(t!==1){let r=new Array(t);for(let n=0;n<t;n++)r[n]=e();return r}else return e()}function AR(t,e,r){switch(e){case Go.BYTE:return t.readBytes(r);case Go.CHAR:return L1e(t.readChars(r));case Go.SHORT:return Ow(r,t.readInt16.bind(t));case Go.INT:return Ow(r,t.readInt32.bind(t));case Go.FLOAT:return Ow(r,t.readFloat32.bind(t));case Go.DOUBLE:return Ow(r,t.readFloat64.bind(t));default:Su(!0,"non valid type "+e);return}}function L1e(t){return t.charCodeAt(t.length-1)===0?t.substring(0,t.length-1):t}function B1e(t,e){let r=kY(e.type),n=e.size/AY(r),o=new Array(n);for(let i=0;i<n;i++)o[i]=AR(t,r,1);return o}function O1e(t,e,r){let n=kY(e.type),o=e.size?e.size/AY(n):1,i=r.length,a=new Array(i),s=r.recordStep;for(let l=0;l<i;l++){let c=t.offset;a[l]=AR(t,n,o),t.seek(c+s)}return a}var Av=0,F1e=10,N1e=11,V1e=12;function z1e(t,e){let r={recordDimension:{length:t.readUint32()}};r.version=e;let n=U1e(t);r.recordDimension.id=n.recordId,r.recordDimension.name=n.recordName,r.dimensions=n.dimensions,r.globalAttributes=MY(t);let o=G1e(t,n.recordId,e);return r.variables=o.variables,r.recordDimension.recordStep=o.recordStep,r}function U1e(t){let e,r,n,o=t.readUint32();if(o===Av)return Su(t.readUint32()!==Av,"wrong empty tag for list of dimensions"),[];{Su(o!==F1e,"wrong tag for list of dimensions");let i=t.readUint32();e=new Array(i);for(let a=0;a<i;a++){let s=DR(t),l=t.readUint32();l===0&&(r=a,n=s),e[a]={name:s,size:l}}return{dimensions:e,recordId:r,recordName:n}}}function MY(t){let e,r=t.readUint32();if(r===Av)return Su(t.readUint32()!==Av,"wrong empty tag for list of attributes"),[];{Su(r!==V1e,"wrong tag for list of attributes");let n=t.readUint32();e=new Array(n);for(let o=0;o<n;o++){let i=DR(t),a=t.readUint32();Su(a<1||a>6,"non valid type "+a);let s=t.readUint32(),l=AR(t,a,s);IY(t),e[o]={name:i,type:DY(a),value:l}}}return e}function G1e(t,e,r){let n=t.readUint32(),o=0,i;if(n===Av)return Su(t.readUint32()!==Av,"wrong empty tag for list of variables"),[];{Su(n!==N1e,"wrong tag for list of variables");let a=t.readUint32();i=new Array(a);for(let s=0;s<a;s++){let l=DR(t),c=t.readUint32(),u=new Array(c);for(let f=0;f<c;f++)u[f]=t.readUint32();let d=MY(t),m=t.readUint32();Su(m<1&&m>6,"non valid type "+m);let p=t.readUint32(),h=t.readUint32();r===2&&(Su(h>0,"offsets larger than 4GB not supported"),h=t.readUint32()),u[0]===e&&(o+=p),i[s]={name:l,dimensions:u,attributes:d,type:DY(m),size:p,offset:h,record:u[0]===e}}}return{variables:i,recordStep:o}}var Fw=class{constructor(e){let r=new Bw(e);r.setBigEndian(),Su(r.readChars(3)!=="CDF","should start with CDF");let n=r.readByte();Su(n>2,"unknown version"),this.header=z1e(r,n),this.buffer=r}get version(){return this.header.version===1?"classic format":"64-bit offset format"}get recordDimension(){return this.header.recordDimension}get dimensions(){return this.header.dimensions}get globalAttributes(){return this.header.globalAttributes}get variables(){return this.header.variables}hasDataVariable(e){return this.header.variables&&this.header.variables.findIndex(r=>r.name===e)!==-1}getDataVariable(e){var r;let n;if(typeof e=="string"?n=(r=this.header.variables)===null||r===void 0?void 0:r.find(o=>o.name===e):n=e,n===void 0)throw new Error("variable not found");return this.buffer.seek(n.offset),n.record?O1e(this.buffer,n,this.header.recordDimension):B1e(this.buffer,n)}};function j1e(t){return N(this,null,function*(){let e=new Fw(t),r={coordinates:[],time:[],timeOffset:0,deltaTime:1};for(let n of e.getDataVariable("coordinates"))r.coordinates.push(n);if(e.hasDataVariable("velocities")){let n=[];for(let o of e.getDataVariable("velocities"))n.push(o);r.velocities=n}if(e.hasDataVariable("forces")){let n=[];for(let o of e.getDataVariable("forces"))n.push(o);r.forces=n}if(e.hasDataVariable("cell_lengths")){let n=[];for(let o of e.getDataVariable("cell_lengths"))n.push(o);r.cell_lengths=n}if(e.hasDataVariable("cell_angles")){let n=[];for(let o of e.getDataVariable("cell_angles"))n.push(o);r.cell_angles=n}if(e.hasDataVariable("time")){let n=[];for(let o of e.getDataVariable("time"))n.push(o);r.time=n}return r.time&&(r.time.length>=1&&(r.timeOffset=r.time[0]),r.time.length>=2&&(r.deltaTime=r.time[1]-r.time[0])),r})}function RY(t){return ie.create("Parse NCTRAJ",e=>N(this,null,function*(){try{e.update({canAbort:!0,message:"Parsing trajectory..."});let r=yield j1e(t);return xr.success(r)}catch(r){return xr.error(""+r)}}))}function LY(t){return ie.create("Parse NCTRAJ",e=>N(this,null,function*(){yield e.update("Converting to coordinates");let r=ma(t.deltaTime,"step"),n=ma(t.timeOffset,r.unit),o=[];for(let i=0,a=t.coordinates.length;i<a;++i){let s=t.coordinates[i],l=s.length/3,c=new Float32Array(l),u=new Float32Array(l),d=new Float32Array(l);for(let p=0,h=s.length;p<h;p+=3)c[p/3]=s[p],u[p/3]=s[p+1],d[p/3]=s[p+2];let m={elementCount:l,x:c,y:u,z:d,xyzOrdering:{isIdentity:!0},time:ma(n.value+r.value*i,r.unit)};if(t.cell_lengths){let p=t.cell_lengths[i],h=y.scale(y(),y.unitX,p[0]),f=y.scale(y(),y.unitY,p[1]),b=y.scale(y(),y.unitZ,p[2]);m.cell=Cc.fromBasis(h,f,b)}o.push(m)}return sf.create(o,r,n)}))}function H1e(t){let{pointers:e,residuePointer:r,residueLabel:n,atomName:o}=t,i=e.NATOM,a=e.NRES,s=new Uint32Array(i),l=[],c=(R,B,F)=>{let G=n.value(R);for(let V=B,H=F;V<H;++V)s[V]=R+1,l[V]=G};for(let R=0,B=a-1;R<B;++R)c(R,r.value(R)-1,r.value(R+1)-1);c(a-1,r.value(a-1)-1,i);let u=K.ofIntArray(s),d=K.ofStringArray(l),m=new Array(i),p=new Array(i),h=new Uint32Array(i),f=new Uint32Array(i),b=new Oi,v=new Fi(u,o),x="",S=0,T="",E=0,_=0,D=-1;for(let R=0,B=i;R<B;++R){let F=u.value(R);if(F!==D){let G=d.value(R),V=im(v.add(G,R).type,G);V!==_&&(T=Tp(S),S+=1,E=0),x=b.getEntityId(G,V,T),E+=1,D=F,_=V}m[R]=x,p[R]=T,h[R]=E,f[R]=R}let P=K.ofIntArray(f),A=K.ofStringArray(p),I=new Array(i);for(let R=0;R<i;++R)I[R]=vu(o.value(R),d.value(R));let k=Xo.ofPartialColumns(ha.atom_site,{auth_asym_id:A,auth_atom_id:K.asArrayColumn(o),auth_comp_id:d,auth_seq_id:u,id:K.asArrayColumn(P),label_asym_id:A,label_atom_id:K.asArrayColumn(o),label_comp_id:d,label_seq_id:K.ofIntArray(h),label_entity_id:K.ofStringArray(m),occupancy:K.ofConst(1,i,K.Schema.float),type_symbol:K.ofStringArray(I),pdbx_PDB_model_num:K.ofConst(1,i,K.Schema.int)},i);return Bi({entity:b.getEntityTable(),chem_comp:v.getChemCompTable(),atom_site:k})}var kR;(function(t){function e(n){return n?.kind==="prmtop"}t.is=e;function r(n){return{kind:"prmtop",name:n.title.join(" ")||"PRMTOP",data:n}}t.fromPrmtop=r})(kR||(kR={}));function BY(t){return ie.create("Parse PRMTOP",e=>N(this,null,function*(){let r=kR.fromPrmtop(t),n=H1e(t),{pointers:{NBONH:o,NBONA:i},bondsIncHydrogen:a,bondsWithoutHydrogen:s}=t,l=o+i,c={indexA:K.ofLambda({value:u=>u<o?a.value(u*3)/3:s.value((u-o)*3)/3,rowCount:l,schema:K.Schema.int}),indexB:K.ofLambda({value:u=>u<o?a.value(u*3+1)/3:s.value((u-o)*3+1)/3,rowCount:l,schema:K.Schema.int}),order:K.ofConst(1,l,K.Schema.int)};return g0.create(t.title.join(" ")||"PRMTOP",n,c,r)}))}function q1e(t){let{molecules:e,compounds:r}=t,n={},o=0;for(let R=0,B=e._rowCount;R<B;++R){let F=e.compound.value(R),G=e.molCount.value(R),{atoms:V}=r[F];K.asArrayColumn(V.atom),K.asArrayColumn(V.resnr),K.asArrayColumn(V.residu),o+=G*V._rowCount;let H=V.resnr.value(0);n[F]=!0;for(let Q=1,L=V._rowCount;Q<L;++Q){let Y=V.resnr.value(Q);if(Y!==H){n[F]=!1;break}H=Y}}let i=new Array(o),a=new Uint32Array(o),s=new Array(o),l=0;for(let R=0,B=e._rowCount;R<B;++R){let F=e.compound.value(R),G=e.molCount.value(R),{atoms:V}=r[F],H=n[F];for(let Q=0;Q<G;++Q)for(let L=0,Y=V._rowCount;L<Y;++L)i[l]=V.atom.value(L),a[l]=V.resnr.value(L),s[l]=V.residu.value(L),H&&(a[l]+=Q),l+=1}let c=K.ofStringArray(i),u=K.ofIntArray(a),d=K.ofStringArray(s),m=new Array(o),p=new Array(o),h=new Uint32Array(o),f=new Uint32Array(o),b=new Oi,v=new Fi(u,c),x="",S=0,T="",E=0,_=0,D=-1;for(let R=0,B=o;R<B;++R){let F=u.value(R);if(F!==D){let G=d.value(R),V=im(v.add(G,R).type,G);V!==_&&(T=Tp(S),S+=1,E=0),x=b.getEntityId(G,V,T),E+=1,D=F,_=V}m[R]=x,p[R]=T,h[R]=E,f[R]=R}let P=K.ofIntArray(f),A=K.ofStringArray(p),I=new Array(o);for(let R=0;R<o;++R)I[R]=vu(c.value(R),d.value(R));let k=Xo.ofPartialColumns(ha.atom_site,{auth_asym_id:A,auth_atom_id:K.asArrayColumn(c),auth_comp_id:d,auth_seq_id:u,id:K.asArrayColumn(P),label_asym_id:A,label_atom_id:K.asArrayColumn(c),label_comp_id:d,label_seq_id:K.ofIntArray(h),label_entity_id:K.ofStringArray(m),occupancy:K.ofConst(1,o,K.Schema.float),type_symbol:K.ofStringArray(I),pdbx_PDB_model_num:K.ofConst(1,o,K.Schema.int)},o);return Bi({entity:b.getEntityTable(),chem_comp:v.getChemCompTable(),atom_site:k})}function W1e(t){let{molecules:e,compounds:r}=t,n=[],o=[],i=0;for(let a=0,s=e._rowCount;a<s;++a){let l=e.compound.value(a),c=e.molCount.value(a),{atoms:u,bonds:d}=r[l];if(d)for(let m=0;m<c;++m){for(let p=0,h=d._rowCount;p<h;++p)n.push(d.ai.value(p)-1+i),o.push(d.aj.value(p)-1+i);i+=u._rowCount}else if(l==="TIP3")for(let m=0;m<c;++m)n.push(0+i),o.push(1+i),n.push(0+i),o.push(2+i),i+=u._rowCount;else i+=c*u._rowCount}return{indexA:K.ofIntArray(n),indexB:K.ofIntArray(o),order:K.ofConst(1,n.length,K.Schema.int)}}var MR;(function(t){function e(n){return n?.kind==="top"}t.is=e;function r(n){return{kind:"top",name:n.system||"TOP",data:n}}t.fromTop=r})(MR||(MR={}));function OY(t){return ie.create("Parse TOP",e=>N(this,null,function*(){let r=MR.fromTop(t),n=q1e(t),o=W1e(t);return g0.create(t.system||"TOP",n,o,r)}))}var X1e=Je.BuiltIn({name:"coordinates-from-dcd",display:{name:"Parse DCD",description:"Parse DCD binary data."},from:[X.Data.Binary],to:X.Molecule.Coordinates})({apply({a:t}){return ie.create("Parse DCD",e=>N(this,null,function*(){let r=yield vX(t.data).runInContext(e);if(r.isError)throw new Error(r.message);let n=yield EX(r.result).runInContext(e);return new X.Molecule.Coordinates(n,{label:t.label,description:"Coordinates"})}))}}),Y1e=Je.BuiltIn({name:"coordinates-from-xtc",display:{name:"Parse XTC",description:"Parse XTC binary data."},from:[X.Data.Binary],to:X.Molecule.Coordinates})({apply({a:t}){return ie.create("Parse XTC",e=>N(this,null,function*(){let r=yield gY(t.data).runInContext(e);if(r.isError)throw new Error(r.message);let n=yield yY(r.result).runInContext(e);return new X.Molecule.Coordinates(n,{label:t.label,description:"Coordinates"})}))}}),Q1e=Je.BuiltIn({name:"coordinates-from-trr",display:{name:"Parse TRR",description:"Parse TRR binary data."},from:[X.Data.Binary],to:X.Molecule.Coordinates})({apply({a:t}){return ie.create("Parse TRR",e=>N(this,null,function*(){let r=yield PY(t.data).runInContext(e);if(r.isError)throw new Error(r.message);let n=yield EY(r.result).runInContext(e);return new X.Molecule.Coordinates(n,{label:t.label,description:"Coordinates"})}))}}),K1e=Je.BuiltIn({name:"coordinates-from-nctraj",display:{name:"Parse NCTRAJ",description:"Parse NCTRAJ binary data."},from:[X.Data.Binary],to:X.Molecule.Coordinates})({apply({a:t}){return ie.create("Parse NCTRAJ",e=>N(this,null,function*(){let r=yield RY(t.data).runInContext(e);if(r.isError)throw new Error(r.message);let n=yield LY(r.result).runInContext(e);return new X.Molecule.Coordinates(n,{label:t.label,description:"Coordinates"})}))}}),$1e=Je.BuiltIn({name:"topology-from-psf",display:{name:"PSF Topology",description:"Create topology from PSF."},from:[X.Format.Psf],to:X.Molecule.Topology})({apply({a:t}){return ie.create("Create Topology",e=>N(this,null,function*(){let r=yield WX(t.data).runInContext(e);return new X.Molecule.Topology(r,{label:r.label||t.label,description:"Topology"})}))}}),Z1e=Je.BuiltIn({name:"topology-from-prmtop",display:{name:"PRMTOP Topology",description:"Create topology from PRMTOP."},from:[X.Format.Prmtop],to:X.Molecule.Topology})({apply({a:t}){return ie.create("Create Topology",e=>N(this,null,function*(){let r=yield BY(t.data).runInContext(e);return new X.Molecule.Topology(r,{label:r.label||t.label,description:"Topology"})}))}}),J1e=Je.BuiltIn({name:"topology-from-top",display:{name:"TOP Topology",description:"Create topology from TOP."},from:[X.Format.Top],to:X.Molecule.Topology})({apply({a:t}){return ie.create("Create Topology",e=>N(this,null,function*(){let r=yield OY(t.data).runInContext(e);return new X.Molecule.Topology(r,{label:r.label||t.label,description:"Topology"})}))}});function eSe(t,e,r){return N(this,null,function*(){if(e.type===X.Molecule.Topology.type){let n=e.data;return yield Et.trajectoryFromTopologyAndCoordinates(n,r).runInContext(t)}else if(e.type===X.Molecule.Model.type){let n=e.data;return Et.trajectoryFromModelAndCoordinates(n,r)}throw new Error("no model/topology found")})}var Nw=Je.BuiltIn({name:"trajectory-from-model-and-coordinates",display:{name:"Trajectory from Topology & Coordinates",description:"Create a trajectory from existing model/topology and coordinates."},from:X.Root,to:X.Molecule.Trajectory,params:{modelRef:g.Text("",{isHidden:!0}),coordinatesRef:g.Text("",{isHidden:!0})}})({apply({params:t,dependencies:e}){return ie.create("Create trajectory from model/topology and coordinates",r=>N(this,null,function*(){let n=e[t.coordinatesRef].data,o=yield eSe(r,e[t.modelRef],n),i={label:"Trajectory",description:`${o.frameCount} model${o.frameCount===1?"":"s"}`};return new X.Molecule.Trajectory(o,i)}))}}),tSe=Je.BuiltIn({name:"trajectory-from-blob",display:{name:"Parse Blob",description:"Parse format blob into a single trajectory."},from:X.Format.Blob,to:X.Molecule.Trajectory})({apply({a:t}){return ie.create("Parse Format Blob",e=>N(this,null,function*(){let r=[];for(let o of t.data){if(o.kind!=="cif")continue;let i=o.data.blocks[0],a=yield BT(i).runInContext(e);if(a.frameCount===0)throw new Error("No models found.");for(let s=0;s<a.frameCount;s++){let l=yield ie.resolveInContext(a.getFrameAtIndex(s),e);r.push(l)}}for(let o=0;o<r.length;o++)Et.TrajectoryInfo.set(r[o],{index:o,size:r.length});let n={label:"Trajectory",description:`${r.length} model${r.length===1?"":"s"}`};return new X.Molecule.Trajectory(new yf(r),n)}))}});function Pp(t){return{label:`${t.representative.entry}`,description:`${t.frameCount} model${t.frameCount===1?"":"s"}`}}var rSe=Je.BuiltIn({name:"trajectory-from-mmcif",display:{name:"Trajectory from mmCIF",description:"Identify and create all separate models in the specified CIF data block"},from:X.Format.Cif,to:X.Molecule.Trajectory,params(t){if(!t)return{loadAllBlocks:g.Optional(g.Boolean(!1,{description:"If True, ignore Block Header and Block Index parameters and parse all datablocks into a single trajectory."})),blockHeader:g.Optional(g.Text(void 0,{description:"Header of the block to parse. If not specifed, Block Index parameter applies.",hideIf:n=>n.loadAllBlocks===!0})),blockIndex:g.Optional(g.Numeric(0,{min:0,step:1},{description:"Zero-based index of the block to parse. Only applies when Block Header parameter is not specified.",hideIf:n=>n.loadAllBlocks===!0||n.blockHeader}))};let{blocks:e}=t.data,r=e.map(n=>[n.header,n.header]);return r.push(["","[Use Block Index]"]),{loadAllBlocks:g.Optional(g.Boolean(!1,{description:"If True, ignore Block Header and Block Index parameters and parse all data blocks into a single trajectory."})),blockHeader:g.Optional(g.Select(e[0]&&e[0].header,r,{description:"Header of the block to parse. If not specifed, Block Index parameter applies.",hideIf:n=>n.loadAllBlocks===!0})),blockIndex:g.Optional(g.Numeric(0,{min:0,step:1,max:e.length-1},{description:"Zero-based index of the block to parse. Only applies when Block Header parameter is not specified.",hideIf:n=>n.loadAllBlocks===!0||n.blockHeader}))}}})({isApplicable:t=>t.data.blocks.length>0,apply({a:t,params:e}){return ie.create("Parse mmCIF",r=>N(this,null,function*(){var n;let o;if(e.loadAllBlocks){let a=[];for(let s of t.data.blocks){r.shouldUpdate&&(yield r.update(`Parsing ${s.header}...`));let l=yield BT(s).runInContext(r);for(let c=0;c<l.frameCount;c++)a.push(yield ie.resolveInContext(l.getFrameAtIndex(c),r))}o=new yf(a)}else{let a=e.blockHeader||t.data.blocks[(n=e.blockIndex)!==null&&n!==void 0?n:0].header,s=t.data.blocks.find(c=>c.header===a);if(!s)throw new Error(`Data block '${[a]}' not found.`);o=s.categoryNames.includes("chem_comp_atom")&&!s.categoryNames.includes("atom_site")&&!s.categoryNames.includes("ihm_sphere_obj_site")&&!s.categoryNames.includes("ihm_gaussian_obj_site")?yield CU(s).runInContext(r):yield BT(s,t.data).runInContext(r)}if(o.frameCount===0)throw new Error("No models found.");let i=Pp(o);return new X.Molecule.Trajectory(o,i)}))}}),nSe=Je.BuiltIn({name:"trajectory-from-pdb",display:{name:"Parse PDB",description:"Parse PDB string and create trajectory."},from:[X.Data.String],to:X.Molecule.Trajectory,params:{isPdbqt:g.Boolean(!1)}})({apply({a:t,params:e}){return ie.create("Parse PDB",r=>N(this,null,function*(){let n=yield SX(t.data,t.label,e.isPdbqt).runInContext(r);if(n.isError)throw new Error(n.message);let o=yield qX(n.result).runInContext(r),i=Pp(o);return new X.Molecule.Trajectory(o,i)}))}}),oSe=Je.BuiltIn({name:"trajectory-from-gro",display:{name:"Parse GRO",description:"Parse GRO string and create trajectory."},from:[X.Data.String],to:X.Molecule.Trajectory})({apply({a:t}){return ie.create("Parse GRO",e=>N(this,null,function*(){let r=yield xX(t.data).runInContext(e);if(r.isError)throw new Error(r.message);let n=yield IX(r.result).runInContext(e),o=Pp(n);return new X.Molecule.Trajectory(n,o)}))}}),iSe=Je.BuiltIn({name:"trajectory-from-xyz",display:{name:"Parse XYZ",description:"Parse XYZ string and create trajectory."},from:[X.Data.String],to:X.Molecule.Trajectory})({apply({a:t}){return ie.create("Parse XYZ",e=>N(this,null,function*(){let r=yield vY(t.data).runInContext(e);if(r.isError)throw new Error(r.message);let n=yield bY(r.result).runInContext(e),o=Pp(n);return new X.Molecule.Trajectory(n,o)}))}}),aSe=Je.BuiltIn({name:"trajectory-from-mol",display:{name:"Parse MOL",description:"Parse MOL string and create trajectory."},from:[X.Data.String],to:X.Molecule.Trajectory})({apply({a:t}){return ie.create("Parse MOL",e=>N(this,null,function*(){let r=yield sY(t.data).runInContext(e);if(r.isError)throw new Error(r.message);let n=yield lY(r.result).runInContext(e),o=Pp(n);return new X.Molecule.Trajectory(n,o)}))}}),sSe=Je.BuiltIn({name:"trajectory-from-sdf",display:{name:"Parse SDF",description:"Parse SDF string and create trajectory."},from:[X.Data.String],to:X.Molecule.Trajectory})({apply({a:t}){return ie.create("Parse SDF",e=>N(this,null,function*(){let r=yield wY(t.data).runInContext(e);if(r.isError)throw new Error(r.message);let n=[];for(let a of r.result.compounds){let s=yield _Y(a).runInContext(e);for(let l=0;l<s.frameCount;l++)n.push(yield ie.resolveInContext(s.getFrameAtIndex(l),e))}let o=new yf(n),i=Pp(o);return new X.Molecule.Trajectory(o,i)}))}}),lSe=Je.BuiltIn({name:"trajectory-from-mol2",display:{name:"Parse MOL2",description:"Parse MOL2 string and create trajectory."},from:[X.Data.String],to:X.Molecule.Trajectory})({apply({a:t}){return ie.create("Parse MOL2",e=>N(this,null,function*(){let r=yield fY(t.data,t.label).runInContext(e);if(r.isError)throw new Error(r.message);let n=yield hY(r.result).runInContext(e),o=Pp(n);return new X.Molecule.Trajectory(n,o)}))}}),cSe=Je.BuiltIn({name:"trajectory-from-cube",display:{name:"Parse Cube",description:"Parse Cube file to create a trajectory."},from:X.Format.Cube,to:X.Molecule.Trajectory})({apply({a:t}){return ie.create("Parse MOL",e=>N(this,null,function*(){let r=yield uY(t.data).runInContext(e),n=Pp(r);return new X.Molecule.Trajectory(r,n)}))}}),uSe=Je.BuiltIn({name:"trajectory-from-cif-core",display:{name:"Parse CIF Core",description:"Identify and create all separate models in the specified CIF data block"},from:X.Format.Cif,to:X.Molecule.Trajectory,params(t){if(!t)return{blockHeader:g.Optional(g.Text(void 0,{description:"Header of the block to parse. If none is specifed, the 1st data block in the file is used."}))};let{blocks:e}=t.data;return{blockHeader:g.Optional(g.Select(e[0]&&e[0].header,e.map(r=>[r.header,r.header]),{description:"Header of the block to parse"}))}}})({apply({a:t,params:e}){return ie.create("Parse CIF Core",r=>N(this,null,function*(){let n=e.blockHeader||t.data.blocks[0].header,o=t.data.blocks.find(s=>s.header===n);if(!o)throw new Error(`Data block '${[n]}' not found.`);let i=yield cY(o).runInContext(r);if(i.frameCount===0)throw new Error("No models found.");let a=Pp(i);return new X.Molecule.Trajectory(i,a)}))}}),dSe=t=>t+1,mSe=t=>t-1,RR=Je.BuiltIn({name:"model-from-trajectory",display:{name:"Molecular Model",description:"Create a molecular model from specified index in a trajectory."},from:X.Molecule.Trajectory,to:X.Molecule.Model,params:t=>t?{modelIndex:g.Converted(dSe,mSe,g.Numeric(1,{min:1,max:t.data.frameCount,step:1},{description:"Model Index",immediateUpdate:!0}))}:{modelIndex:g.Numeric(0,{},{description:"Zero-based index of the model",immediateUpdate:!0})}})({isApplicable:t=>t.data.frameCount>0,apply({a:t,params:e}){return ie.create("Model from Trajectory",r=>N(this,null,function*(){let n=e.modelIndex%t.data.frameCount;n<0&&(n+=t.data.frameCount);let o=yield ie.resolveInContext(t.data.getFrameAtIndex(n),r),i=`Model ${n+1}`,a=t.data.frameCount===1?void 0:`of ${t.data.frameCount}`;return new X.Molecule.Model(o,{label:i,description:a})}))},interpolate(t,e,r){return{modelIndex:r>=1?e.modelIndex:t.modelIndex+Math.floor((e.modelIndex-t.modelIndex+1)*r)}},dispose({b:t}){t?.data.customProperties.dispose()}}),pSe=Je.BuiltIn({name:"structure-from-trajectory",display:{name:"Structure from Trajectory",description:"Create a molecular structure from a trajectory."},from:X.Molecule.Trajectory,to:X.Molecule.Structure})({apply({a:t}){return ie.create("Build Structure",e=>N(this,null,function*(){let r=yield ue.ofTrajectory(t.data,e),n={label:"Ensemble",description:ue.elementDescription(r)};return new X.Molecule.Structure(r,n)}))},dispose({b:t}){t?.data.customPropertyDescriptors.dispose()}}),fSe=Je.BuiltIn({name:"structure-from-model",display:{name:"Structure",description:"Create a molecular structure (model, assembly, or symmetry) from the specified model."},from:X.Molecule.Model,to:X.Molecule.Structure,params(t){return vm.getParams(t&&t.data)}})({canAutoUpdate({oldParams:t,newParams:e}){return vm.canAutoUpdate(t.type,e.type)},apply({a:t,params:e},r){return ie.create("Build Structure",n=>N(this,null,function*(){return vm.create(r,n,t.data,e&&e.type)}))},update:({a:t,b:e,oldParams:r,newParams:n})=>ys(r,n)?e.data.model===t.data?Se.UpdateResult.Unchanged:Et.areHierarchiesEqual(t.data,e.data.model)?(e.data=e.data.remapModel(t.data),Se.UpdateResult.Updated):Se.UpdateResult.Recreate:Se.UpdateResult.Recreate,dispose({b:t}){t?.data.customPropertyDescriptors.dispose()}}),FY=y(),NY=W(),VY=W(),hSe=Je.BuiltIn({name:"transform-structure-conformation",display:{name:"Transform Conformation"},isDecorator:!0,from:X.Molecule.Structure,to:X.Molecule.Structure,params:{transform:g.MappedStatic("components",{components:g.Group({axis:g.Vec3(y.create(1,0,0)),angle:g.Numeric(0,{min:-180,max:180,step:.1}),translation:g.Vec3(y.create(0,0,0))},{isFlat:!0}),matrix:g.Group({data:g.Mat4(W.identity()),transpose:g.Boolean(!1)},{isFlat:!0})},{label:"Kind"})}})({canAutoUpdate({newParams:t}){return t.transform.name!=="matrix"},apply({a:t,params:e}){let r=W();if(e.transform.name==="components"){let{axis:o,angle:i,translation:a}=e.transform.params,s=t.data.boundary.sphere.center;W.fromTranslation(NY,y.negate(FY,s)),W.fromTranslation(VY,y.add(FY,s,a));let l=W.fromRotation(W(),Math.PI/180*i,y.normalize(y(),o));W.mul3(r,VY,l,NY)}else e.transform.name==="matrix"&&(W.copy(r,e.transform.params.data),e.transform.params.transpose&&W.transpose(r,r));let n=ue.transform(t.data,r);return new X.Molecule.Structure(n,{label:t.label,description:`${t.description} [Transformed]`})},dispose({b:t}){t?.data.customPropertyDescriptors.dispose()}}),gSe=Je.BuiltIn({name:"structure-selection-from-expression",display:{name:"Selection",description:"Create a molecular structure from the specified expression."},from:X.Molecule.Structure,to:X.Molecule.Structure,params:()=>({expression:g.Value(q.struct.generator.all,{isHidden:!0}),label:g.Optional(g.Text("",{isHidden:!0}))})})({apply({a:t,params:e,cache:r}){let{selection:n,entry:o}=Oa.createAndRun(t.data,e.expression);if(r.entry=o,hn.isEmpty(n))return Rr.Null;let i=hn.unionStructure(n),a={label:`${e.label||"Selection"}`,description:ue.elementDescription(i)};return new X.Molecule.Structure(i,a)},update:({a:t,b:e,oldParams:r,newParams:n,cache:o})=>{if(r.expression!==n.expression)return Se.UpdateResult.Recreate;let i=o.entry;if(i.currentStructure===t.data)return Se.UpdateResult.Unchanged;let a=Oa.updateStructure(i,t.data);return hn.isEmpty(a)?Se.UpdateResult.Null:(Oa.updateStructureObject(e,a,n.label),Se.UpdateResult.Updated)},dispose({b:t}){t?.data.customPropertyDescriptors.dispose()}}),ySe=Je.BuiltIn({name:"structure-multi-selection-from-expression",display:{name:"Multi-structure Measurement Selection",description:"Create selection object from multiple structures."},from:X.Root,to:X.Molecule.Structure.Selections,params:()=>({selections:g.ObjectList({key:g.Text(void 0,{description:"A unique key."}),ref:g.Text(),groupId:g.Optional(g.Text()),expression:g.Value(q.struct.generator.empty)},t=>t.ref,{isHidden:!0}),isTransitive:g.Optional(g.Boolean(!1,{isHidden:!0,description:"Remap the selections from the original structure if structurally equivalent."})),label:g.Optional(g.Text("",{isHidden:!0}))})})({apply({params:t,cache:e,dependencies:r}){let n=new Map,o=[],i=0;for(let s of t.selections){let{selection:l,entry:c}=Oa.createAndRun(r[s.ref].data,s.expression);n.set(s.key,c);let u=hn.toLociWithSourceUnits(l);o.push({key:s.key,loci:u,groupId:s.groupId}),i+=z.Loci.size(u)}e.entries=n;let a={label:`${t.label||"Multi-selection"}`,description:`${t.selections.length} source(s), ${i} element(s) total`};return new X.Molecule.Structure.Selections(o,a)},update:({b:t,oldParams:e,newParams:r,cache:n,dependencies:o})=>{if(!!e.isTransitive!=!!r.isTransitive)return Se.UpdateResult.Recreate;let i=n.entries,a=new Map,s=new Map;for(let d of t.data)s.set(d.key,d);let l=!1,c=0,u=[];for(let d of r.selections){let m=o[d.ref].data,p=!1;if(i.has(d.key)){let h=i.get(d.key);if(Oa.isUnchanged(h,d.expression,m)&&s.has(d.key)){let f=s.get(d.key);f.groupId!==d.groupId&&(f.groupId=d.groupId,l=!0),a.set(d.key,h),u.push(f),c+=z.Loci.size(f.loci);continue}if(h.expression!==d.expression)p=!0;else{let f=!1;if(r.isTransitive)if(ue.areUnitIdsAndIndicesEqual(h.originalStructure,m)){let b=Oa.run(h,h.originalStructure);h.currentStructure=m,a.set(d.key,h);let v=z.Loci.remap(hn.toLociWithSourceUnits(b),m);u.push({key:d.key,loci:v,groupId:d.groupId}),c+=z.Loci.size(v),l=!0}else f=!0;else f=!0;if(f){l=!0;let b=Oa.updateStructure(h,m);a.set(d.key,h);let v=hn.toLociWithSourceUnits(b);u.push({key:d.key,loci:v,groupId:d.groupId}),c+=z.Loci.size(v)}}}else p=!0;if(p){l=!0;let{selection:h,entry:f}=Oa.createAndRun(m,d.expression);a.set(d.key,f);let b=hn.toLociWithSourceUnits(h);u.push({key:d.key,loci:b}),c+=z.Loci.size(b)}}return l?(n.entries=a,t.data=u,t.label=`${r.label||"Multi-selection"}`,t.description=`${u.length} source(s), ${c} element(s) total`,Se.UpdateResult.Updated):Se.UpdateResult.Unchanged}}),vSe=Je.BuiltIn({name:"structure-selection-from-script",display:{name:"Selection",description:"Create a molecular structure from the specified script."},from:X.Molecule.Structure,to:X.Molecule.Structure,params:()=>({script:g.Script({language:"mol-script",expression:"(sel.atom.atom-groups :residue-test (= atom.resname ALA))"}),label:g.Optional(g.Text(""))})})({apply({a:t,params:e,cache:r}){let{selection:n,entry:o}=Oa.createAndRun(t.data,e.script);r.entry=o;let i=hn.unionStructure(n),a={label:`${e.label||"Selection"}`,description:ue.elementDescription(i)};return new X.Molecule.Structure(i,a)},update:({a:t,b:e,oldParams:r,newParams:n,cache:o})=>{if(!Jr.areEqual(r.script,n.script))return Se.UpdateResult.Recreate;let i=o.entry;if(i.currentStructure===t.data)return Se.UpdateResult.Unchanged;let a=Oa.updateStructure(i,t.data);return Oa.updateStructureObject(e,a,n.label),Se.UpdateResult.Updated},dispose({b:t}){t?.data.customPropertyDescriptors.dispose()}}),bSe=Je.BuiltIn({name:"structure-selection-from-bundle",display:{name:"Selection",description:"Create a molecular structure from the specified structure-element bundle."},from:X.Molecule.Structure,to:X.Molecule.Structure,params:()=>({bundle:g.Value(z.Bundle.Empty,{isHidden:!0}),label:g.Optional(g.Text("",{isHidden:!0}))})})({apply({a:t,params:e,cache:r}){if(e.bundle.hash!==t.data.hashCode)return Rr.Null;r.source=t.data;let n=z.Bundle.toStructure(e.bundle,t.data);if(n.elementCount===0)return Rr.Null;let o={label:`${e.label||"Selection"}`,description:ue.elementDescription(n)};return new X.Molecule.Structure(n,o)},update:({a:t,b:e,oldParams:r,newParams:n,cache:o})=>{if(!z.Bundle.areEqual(r.bundle,n.bundle))return Se.UpdateResult.Recreate;if(n.bundle.hash!==t.data.hashCode)return Se.UpdateResult.Null;if(o.source===t.data)return Se.UpdateResult.Unchanged;o.source=t.data;let i=z.Bundle.toStructure(n.bundle,t.data);return i.elementCount===0?Se.UpdateResult.Null:(e.label=`${n.label||"Selection"}`,e.description=ue.elementDescription(i),e.data=i,Se.UpdateResult.Updated)},dispose({b:t}){t?.data.customPropertyDescriptors.dispose()}}),GY={polymer:"polymer",protein:"protein",nucleic:"nucleic",water:"water",branched:"branched",ligand:"ligand","non-standard":"non-standard",coarse:"coarse","atomic-sequence":"atomic-sequence","atomic-het":"atomic-het",spheres:"spheres"},xSe=g.objectToOptions(GY),SSe=Je.BuiltIn({name:"structure-complex-element",display:{name:"Complex Element",description:"Create a molecular structure from the specified model."},from:X.Molecule.Structure,to:X.Molecule.Structure,params:{type:g.Select("atomic-sequence",xSe,{isHidden:!0})}})({apply({a:t,params:e}){let r,n;switch(e.type){case"polymer":r=Qn.polymer.query,n="Polymer";break;case"protein":r=Qn.protein.query,n="Protein";break;case"nucleic":r=Qn.nucleic.query,n="Nucleic";break;case"water":r=cn.internal.water(),n="Water";break;case"branched":r=Qn.branchedPlusConnected.query,n="Branched";break;case"ligand":r=Qn.ligandPlusConnected.query,n="Ligand";break;case"non-standard":r=Qn.nonStandardPolymer.query,n="Non-standard";break;case"coarse":r=Qn.coarse.query,n="Coarse";break;case"atomic-sequence":r=cn.internal.atomicSequence(),n="Sequence";break;case"atomic-het":r=cn.internal.atomicHet(),n="HET Groups/Ligands";break;case"spheres":r=cn.internal.spheres(),n="Coarse Spheres";break;default:ur(e.type)}let o=r(new fa(t.data)),i=hn.unionStructure(o);return i.elementCount===0?Rr.Null:new X.Molecule.Structure(i,{label:n,description:ue.elementDescription(i)})},dispose({b:t}){t?.data.customPropertyDescriptors.dispose()}}),CSe=Je.BuiltIn({name:"structure-component",display:{name:"Component",description:"A molecular structure component."},from:X.Molecule.Structure,to:X.Molecule.Structure,params:nY})({apply({a:t,params:e,cache:r}){return oY(t.data,e,r)},update:({a:t,b:e,oldParams:r,newParams:n,cache:o})=>iY(t.data,e,r,n,o),dispose({b:t}){t?.data.customPropertyDescriptors.dispose()}}),LR=Je.BuiltIn({name:"custom-model-properties",display:{name:"Custom Model Properties"},isDecorator:!0,from:X.Molecule.Model,to:X.Molecule.Model,params:(t,e)=>e.customModelProperties.getParams(t?.data)})({apply({a:t,params:e},r){return ie.create("Custom Props",n=>N(this,null,function*(){return yield zY(t.data,r,n,e),new X.Molecule.Model(t.data,{label:t.label,description:t.description})}))},update({a:t,b:e,oldParams:r,newParams:n},o){return ie.create("Custom Props",i=>N(this,null,function*(){e.data=t.data,e.label=t.label,e.description=t.description;for(let a of r.autoAttach){let s=o.customModelProperties.get(a);s&&t.data.customProperties.reference(s.descriptor,!1)}return yield zY(t.data,o,i,n),Se.UpdateResult.Updated}))},dispose({b:t}){t?.data.customProperties.dispose()}});function zY(t,e,r,n){return N(this,null,function*(){let o={runtime:r,assetManager:e.managers.asset},{autoAttach:i,properties:a}=n;for(let s of Object.keys(a)){let l=e.customModelProperties.get(s),c=a[s];if(i.includes(s)||l.isHidden)try{yield l.attach(o,t,c,!0)}catch(u){e.log.warn(`Error attaching model prop '${s}': ${u}`)}else l.set(t,c)}})}var BR=Je.BuiltIn({name:"custom-structure-properties",display:{name:"Custom Structure Properties"},isDecorator:!0,from:X.Molecule.Structure,to:X.Molecule.Structure,params:(t,e)=>e.customStructureProperties.getParams(t?.data.root)})({apply({a:t,params:e},r){return ie.create("Custom Props",n=>N(this,null,function*(){return yield UY(t.data.root,r,n,e),new X.Molecule.Structure(t.data,{label:t.label,description:t.description})}))},update({a:t,b:e,oldParams:r,newParams:n},o){return t.data!==e.data?Se.UpdateResult.Recreate:ie.create("Custom Props",i=>N(this,null,function*(){e.data=t.data,e.label=t.label,e.description=t.description;for(let a of r.autoAttach){let s=o.customStructureProperties.get(a);s&&t.data.customPropertyDescriptors.reference(s.descriptor,!1)}return yield UY(t.data.root,o,i,n),Se.UpdateResult.Updated}))},dispose({b:t}){t?.data.customPropertyDescriptors.dispose()}});function UY(t,e,r,n){return N(this,null,function*(){let o={runtime:r,assetManager:e.managers.asset},{autoAttach:i,properties:a}=n;for(let s of Object.keys(a)){let l=e.customStructureProperties.get(s),c=a[s];if(i.includes(s)||l.isHidden)try{yield l.attach(o,t,c,!0)}catch(u){e.log.warn(`Error attaching structure prop '${s}': ${u}`)}else l.set(t,c)}})}var TSe=Je.BuiltIn({name:"shape-from-ply",display:{name:"Shape from PLY",description:"Create Shape from PLY data"},from:X.Format.Ply,to:X.Shape.Provider,params(t){return{transforms:g.Optional(g.Value([],{isHidden:!0})),label:g.Optional(g.Text("",{isHidden:!0}))}}})({apply({a:t,params:e}){return ie.create("Create shape from PLY",r=>N(this,null,function*(){let n=yield PX(t.data,e).runInContext(r),o={label:e.label||"Shape"};return new X.Shape.Provider(n,o)}))}});var UR={};ua(UR,{AssignColorVolume:()=>MSe,VolumeFromCcp4:()=>PSe,VolumeFromCube:()=>ISe,VolumeFromDensityServerCif:()=>ASe,VolumeFromDsn6:()=>ESe,VolumeFromDx:()=>DSe,VolumeFromSegmentationCif:()=>kSe,VolumeTransform:()=>RSe});function wSe(t){return t.originX===0&&t.originY===0&&t.originZ===0?y.create(t.NCSTART,t.NRSTART,t.NSSTART):y.create(t.originX/(t.xLength/t.NX),t.originY/(t.yLength/t.NY),t.originZ/(t.zLength/t.NZ))}function _Se(t){let e=K3(t);switch(e){case Ba.Float32:return Float32Array;case Ba.Int8:return Int8Array;case Ba.Int16:return Int16Array;case Ba.Uint16:return Uint16Array}throw Error(`${e} is not a supported value format.`)}function jY(t,e){return ie.create("Create Volume",r=>N(this,null,function*(){let{header:n,values:o}=t,i=y.create(n.xLength,n.yLength,n.zLength);e&&e.voxelSize&&y.mul(i,i,e.voxelSize);let a=y.create(or(n.alpha),or(n.beta),or(n.gamma)),s=n.ISPG>65536?0:n.ISPG,l=pa.create(s||"P 1",i,a),c=y.create(n.MAPC-1,n.MAPR-1,n.MAPS-1),u=er.convertToCanonicalAxisIndicesFastToSlow(c),d=[n.NX,n.NY,n.NZ],m=u([n.NC,n.NR,n.NS]),p=wSe(n);e?.offset&&y.add(p,p,e.offset);let h=u(p),f=y.create(h[0]/d[0],h[1]/d[1],h[2]/d[2]),b=y.create(m[0]/d[0],m[1]/d[1],m[2]/d[2]),v=er.Space(m,er.invertAxisOrder(c),_Se(n)),x=er.create(v,er.Data1(o)),S=n.AMIN===0&&n.AMAX===0&&n.AMEAN===0&&n.ARMS===0;return{label:e?.label,entryId:e?.entryId,grid:{transform:{kind:"spacegroup",cell:l,fractionalBox:qe.create(f,y.add(y.zero(),f,b))},cells:x,stats:{min:isNaN(n.AMIN)||S?cf(o):n.AMIN,max:isNaN(n.AMAX)||S?Mi(o):n.AMAX,mean:isNaN(n.AMEAN)||S?uf(o):n.AMEAN,sigma:isNaN(n.ARMS)||n.ARMS===0?df(o):n.ARMS}},sourceData:FR.create(t),customProperties:new Tl,_propertyData:Object.create(null)}}))}var FR;(function(t){function e(n){return n?.kind==="ccp4"}t.is=e;function r(n){return{kind:"ccp4",name:n.name,data:n}}t.create=r})(FR||(FR={}));function HY(t,e){return ie.create("Create Volume",r=>N(this,null,function*(){let{header:n,values:o}=t,i=y.create(n.xlen,n.ylen,n.zlen);e&&e.voxelSize&&y.mul(i,i,e.voxelSize);let a=y.create(or(n.alpha),or(n.beta),or(n.gamma)),s=pa.create("P 1",i,a),l=[n.xRate,n.yRate,n.zRate],c=[n.xExtent,n.yExtent,n.zExtent],u=[n.xStart,n.yStart,n.zStart],d=y.create(u[0]/l[0],u[1]/l[1],u[2]/l[2]),m=y.create(c[0]/l[0],c[1]/l[1],c[2]/l[2]),p=er.Space(c,[0,1,2],Float32Array),h=er.create(p,er.Data1(o));return{label:e?.label,entryId:e?.entryId,grid:{transform:{kind:"spacegroup",cell:s,fractionalBox:qe.create(d,y.add(y.zero(),d,m))},cells:h,stats:{min:cf(o),max:Mi(o),mean:uf(o),sigma:n.sigma!==void 0?n.sigma:df(o)}},sourceData:NR.create(t),customProperties:new Tl,_propertyData:Object.create(null)}}))}var NR;(function(t){function e(n){return n?.kind==="dsn6"}t.is=e;function r(n){return{kind:"dsn6",name:n.name,data:n}}t.create=r})(NR||(NR={}));function qY(t,e){return ie.create("Create Volume",()=>N(this,null,function*(){let{header:r,values:n}=t,o=er.Space(r.dim,[0,1,2],Float64Array),i=er.create(o,er.Data1(n)),a=W.fromTranslation(W(),r.min),s=W.fromScaling(W(),r.h);return W.mul(a,a,s),{label:e?.label,entryId:e?.entryId,grid:{transform:{kind:"matrix",matrix:a},cells:i,stats:{min:cf(n),max:Mi(n),mean:uf(n),sigma:df(n)}},sourceData:VR.create(t),customProperties:new Tl,_propertyData:Object.create(null)}}))}var VR;(function(t){function e(n){return n?.kind==="dx"}t.is=e;function r(n){return{kind:"dx",name:n.name,data:n}}t.create=r})(VR||(VR={}));function WY(t,e){return ie.create("Create Segmentation Volume",r=>N(this,null,function*(){var n;let{volume_data_3d_info:o,segmentation_data_3d:i}=t,a=pa.create(o.spacegroup_number.value(0),y.ofArray(o.spacegroup_cell_size.value(0)),y.scale(y(),y.ofArray(o.spacegroup_cell_angles.value(0)),Math.PI/180)),s=o.axis_order.value(0),l=er.convertToCanonicalAxisIndicesFastToSlow(s),c=l(o.sample_count.value(0)),u=er.Space(c,er.invertAxisOrder(s),Float32Array),d=er.create(u,er.Data1(i.values.toArray({array:Float32Array}))),m=y.ofArray(l(o.origin.value(0))),p=y.ofArray(l(o.dimensions.value(0))),h={label:e?.label,entryId:void 0,grid:{transform:{kind:"spacegroup",cell:a,fractionalBox:qe.create(m,y.add(y(),m,p))},cells:d,stats:{min:0,max:1,mean:0,sigma:1}},sourceData:zR.create(t),customProperties:new Tl,_propertyData:{ownerId:e?.ownerId}};xe.PickingGranularity.set(h,"object");let f=new Map,b=new Map,{segment_id:v,set_id:x}=t.segmentation_data_table;for(let B=0,F=v.rowCount;B<F;++B){let G=v.value(B),V=x.value(B);V===0||G===0||(b.has(V)||b.set(V,new Set),b.get(V).add(G))}b.forEach((B,F)=>{B.forEach(G=>{f.has(G)||f.set(G,new Set),f.get(G).add(F)})});let S=[0,0,0],T=d.space.getCoords,E=d.data,[_,D,P]=h.grid.cells.space.dimensions,A=_-1,I=D-1,k=P-1,M={};b.forEach((B,F)=>{M[F]=[A,I,k,-1,-1,-1]});for(let B=0,F=E.length;B<F;++B){let G=E[B];if(G===0)continue;T(B,S);let V=M[G];S[0]<V[0]&&(V[0]=S[0]),S[1]<V[1]&&(V[1]=S[1]),S[2]<V[2]&&(V[2]=S[2]),S[0]>V[3]&&(V[3]=S[0]),S[1]>V[4]&&(V[4]=S[1]),S[2]>V[5]&&(V[5]=S[2])}let R={};return f.forEach((B,F)=>{R[F]=qe.create(y.create(A,I,k),y.create(-1,-1,-1))}),ro(M,(B,F)=>{b.get(parseInt(F)).forEach(G=>{let V=R[G];B[0]<V.min[0]&&(V.min[0]=B[0]),B[1]<V.min[1]&&(V.min[1]=B[1]),B[2]<V.min[2]&&(V.min[2]=B[2]),B[3]>V.max[0]&&(V.max[0]=B[3]),B[4]>V.max[1]&&(V.max[1]=B[4]),B[5]>V.max[2]&&(V.max[2]=B[5])})}),xe.Segmentation.set(h,{segments:f,sets:b,bounds:R,labels:(n=e?.segmentLabels)!==null&&n!==void 0?n:{}}),h}))}var zR;(function(t){function e(n){return n?.kind==="segcif"}t.is=e;function r(n){return{kind:"segcif",name:n._name,data:n}}t.create=r})(zR||(zR={}));var PSe=Je.BuiltIn({name:"volume-from-ccp4",display:{name:"Volume from CCP4/MRC/MAP",description:"Create Volume from CCP4/MRC/MAP data"},from:X.Format.Ccp4,to:X.Volume.Data,params(t){return{voxelSize:g.Vec3(y.create(1,1,1)),offset:g.Vec3(y.create(0,0,0)),entryId:g.Text("")}}})({apply({a:t,params:e}){return ie.create("Create volume from CCP4/MRC/MAP",r=>N(this,null,function*(){let n=yield jY(t.data,U(w({},e),{label:t.data.name||t.label})).runInContext(r),o={label:n.label||"Volume",description:`Volume ${t.data.header.NX}\xD7${t.data.header.NX}\xD7${t.data.header.NX}`};return new X.Volume.Data(n,o)}))},dispose({b:t}){t?.data.customProperties.dispose()}}),ESe=Je.BuiltIn({name:"volume-from-dsn6",display:{name:"Volume from DSN6/BRIX",description:"Create Volume from DSN6/BRIX data"},from:X.Format.Dsn6,to:X.Volume.Data,params(t){return{voxelSize:g.Vec3(y.create(1,1,1)),entryId:g.Text("")}}})({apply({a:t,params:e}){return ie.create("Create volume from DSN6/BRIX",r=>N(this,null,function*(){let n=yield HY(t.data,U(w({},e),{label:t.data.name||t.label})).runInContext(r),o={label:n.label||"Volume",description:`Volume ${t.data.header.xExtent}\xD7${t.data.header.yExtent}\xD7${t.data.header.zExtent}`};return new X.Volume.Data(n,o)}))},dispose({b:t}){t?.data.customProperties.dispose()}}),ISe=Je.BuiltIn({name:"volume-from-cube",display:{name:"Volume from Cube",description:"Create Volume from Cube data"},from:X.Format.Cube,to:X.Volume.Data,params(t){return{dataIndex:t?g.Select(0,t.data.header.dataSetIds.map((r,n)=>[n,`${r}`])):g.Numeric(0),entryId:g.Text("")}}})({apply({a:t,params:e}){return ie.create("Create volume from Cube",r=>N(this,null,function*(){let n=yield Zj(t.data,U(w({},e),{label:t.data.name||t.label})).runInContext(r),o={label:n.label||"Volume",description:`Volume ${t.data.header.dim[0]}\xD7${t.data.header.dim[1]}\xD7${t.data.header.dim[2]}`};return new X.Volume.Data(n,o)}))},dispose({b:t}){t?.data.customProperties.dispose()}}),DSe=Je.BuiltIn({name:"volume-from-dx",display:{name:"Parse DX",description:"Create volume from DX data."},from:X.Format.Dx,to:X.Volume.Data})({apply({a:t}){return ie.create("Parse DX",e=>N(this,null,function*(){let r=yield qY(t.data,{label:t.data.name||t.label}).runInContext(e),n={label:r.label||"Volume",description:`Volume ${t.data.header.dim[0]}\xD7${t.data.header.dim[1]}\xD7${t.data.header.dim[2]}`};return new X.Volume.Data(r,n)}))},dispose({b:t}){t?.data.customProperties.dispose()}}),ASe=Je.BuiltIn({name:"volume-from-density-server-cif",display:{name:"Volume from density-server CIF",description:"Identify and create all separate models in the specified CIF data block"},from:X.Format.Cif,to:X.Volume.Data,params(t){if(!t)return{blockHeader:g.Optional(g.Text(void 0,{description:"Header of the block to parse. If none is specifed, the 1st data block in the file is used."})),entryId:g.Text("")};let e=t.data.blocks.slice(1);return{blockHeader:g.Optional(g.Select(e[0]&&e[0].header,e.map(r=>[r.header,r.header]),{description:"Header of the block to parse"})),entryId:g.Text("")}}})({isApplicable:t=>t.data.blocks.length>0,apply({a:t,params:e}){return ie.create("Parse density-server CIF",r=>N(this,null,function*(){var n;let o=e.blockHeader||t.data.blocks[1].header,i=t.data.blocks.find(m=>m.header===o);if(!i)throw new Error(`Data block '${[o]}' not found.`);let a=lc.schema.densityServer(i),s=yield e2(a,{entryId:e.entryId}).runInContext(r),[l,c,u]=s.grid.cells.space.dimensions,d={label:(n=e.entryId)!==null&&n!==void 0?n:a.volume_data_3d_info.name.value(0),description:`Volume ${l}\xD7${c}\xD7${u}`};return new X.Volume.Data(s,d)}))},dispose({b:t}){t?.data.customProperties.dispose()}}),kSe=Je.BuiltIn({name:"volume-from-segmentation-cif",display:{name:"Volume from Segmentation CIF"},from:X.Format.Cif,to:X.Volume.Data,params(t){let e=t?.data.blocks.slice(1);return{blockHeader:e?g.Optional(g.Select(e[0]&&e[0].header,e.map(n=>[n.header,n.header]),{description:"Header of the block to parse"})):g.Optional(g.Text(void 0,{description:"Header of the block to parse. If none is specifed, the 1st data block in the file is used."})),segmentLabels:g.ObjectList({id:g.Numeric(-1),label:g.Text("")},n=>`${n.id} = ${n.label}`,{description:"Mapping of segment IDs to segment labels"}),ownerId:g.Text("",{isHidden:!0,description:"Reference to the object which manages this volume"})}}})({isApplicable:t=>t.data.blocks.length>0,apply({a:t,params:e}){return ie.create("Parse segmentation CIF",r=>N(this,null,function*(){let n=e.blockHeader||t.data.blocks[1].header,o=t.data.blocks.find(m=>m.header===n);if(!o)throw new Error(`Data block '${[n]}' not found.`);let i=lc.schema.segmentation(o),a={};for(let m of e.segmentLabels)a[m.id]=m.label;let s=yield WY(i,{segmentLabels:a,ownerId:e.ownerId}).runInContext(r),[l,c,u]=s.grid.cells.space.dimensions,d={label:i.volume_data_3d_info.name.value(0),description:`Segmentation ${l}\xD7${c}\xD7${u}`};return new X.Volume.Data(s,d)}))},dispose({b:t}){t?.data.customProperties.dispose()}}),MSe=Je.BuiltIn({name:"assign-color-volume",display:{name:"Assign Color Volume",description:"Assigns another volume to be available for coloring."},from:X.Volume.Data,to:X.Volume.Data,isDecorator:!0,params(t,e){if(!t)return{ref:g.Text()};let r=e.state.data.select(lt.Generators.root.subtree().ofType(X.Volume.Data).filter(n=>{var o;return!!n.obj&&!(!((o=n.obj)===null||o===void 0)&&o.data.colorVolume)&&n.obj!==t}));return r.length===0?{ref:g.Text("",{isHidden:!0})}:{ref:g.Select(r[0].transform.ref,r.map(n=>[n.transform.ref,n.obj.label]))}}})({apply({a:t,params:e,dependencies:r}){return ie.create("Assign Color Volume",n=>N(this,null,function*(){if(!r||!r[e.ref])throw new Error("Dependency not available.");let o=r[e.ref].data,i=U(w({},t.data),{colorVolume:o}),a={label:t.label,description:"Volume + Colors"};return new X.Volume.Data(i,a)}))}}),RSe=Je.BuiltIn({name:"volume-transform",display:{name:"Transform Volume"},isDecorator:!0,from:X.Volume.Data,to:X.Volume.Data,params:{transform:g.MappedStatic("matrix",{matrix:g.Group({data:g.Mat4(W.identity()),transpose:g.Boolean(!1)},{isFlat:!0})},{label:"Kind"})}})({canAutoUpdate({newParams:t}){return t.transform.name!=="matrix"},apply({a:t,params:e}){let r=W(),n=w({},t.data.grid.transform);W.copy(r,e.transform.params.data),e.transform.params.transpose&&W.transpose(r,r);let o=t.data.grid.transform.kind==="matrix"?t.data.grid.transform.matrix:Sn.getGridToCartesianTransform(t.data.grid);n={kind:"matrix",matrix:W.mul(W(),r,o)};let i=U(w({},t.data),{grid:U(w({},t.data.grid),{transform:n})});return new X.Volume.Data(i,{label:t.label,description:`${t.description} [Transformed]`})}});var de={Data:iR,Misc:aR,Model:OR,Volume:UR,Representation:B3,Shape:M3};var XY=As.create({name:"built-in.animate-assembly-unwind",display:{name:"Unwind Assembly"},isExportable:!0,params:t=>{let e=[["all","All"]],r=t.state.data.select(lt.Generators.rootsOfType(X.Molecule.Structure));for(let n of r)e.push([n.transform.ref,n.obj.data.models[0].label]);return{durationInMs:g.Numeric(3e3,{min:100,max:1e4,step:100}),playOnce:g.Boolean(!1),target:g.Select(e[0][0],e)}},canApply(t){let e=t.state.data,r=kt.RootRef;return{canApply:e.select(lt.Generators.ofType(X.Molecule.Structure.Representation3D,r)).length>0}},getDuration:t=>({kind:"fixed",durationMs:t.durationInMs}),initialState:()=>({t:0}),setup(t,e,r){let n=r.state.data,o=!t.target||t.target==="all"?kt.RootRef:t.target,i=n.select(lt.Generators.ofType(X.Molecule.Structure.Representation3D,o)),a=n.build(),s=!1;for(let l of i)n.select(lt.Generators.ofTransformer(de.Representation.UnwindStructureAssemblyRepresentation3D,l.transform.ref)).length>0||(s=!0,a.to(l).apply(de.Representation.UnwindStructureAssemblyRepresentation3D,{t:0},{tags:"animate-assembly-unwind"}));if(s)return a.commit({doNotUpdateCurrent:!0})},teardown(t,e,r){let n=r.state.data,o=n.select(lt.Generators.ofType(X.Molecule.Structure.Representation3DState).withTag("animate-assembly-unwind"));if(o.length===0)return;let i=n.build();for(let a of o)i.delete(a.transform.ref);return i.commit()},apply(t,e,r){return N(this,null,function*(){let n=r.plugin.state.data,o=!r.params.target||r.params.target==="all"?kt.RootRef:r.params.target,i=n.select(lt.Generators.ofTransformer(de.Representation.UnwindStructureAssemblyRepresentation3D,o));if(i.length===0)return{kind:"finished"};let a=n.build(),s=(e.current-e.lastApplied)/r.params.durationInMs,l=t.t+s,c=!1;r.params.playOnce&&l>=1?(c=!0,l=1):l=l%1;for(let u of i)a.to(u).update({t:l});return yield Re.State.Update(r.plugin,{state:n,tree:a,options:{doNotLogTiming:!0}}),c?{kind:"finished"}:{kind:"next",state:{t:l}}})}});var Vw=y(),YY=y(),QY=xn(),KY=As.create({name:"built-in.animate-camera-spin",display:{name:"Camera Spin",description:"Spin the 3D scene around the x-axis in view space"},isExportable:!0,params:()=>({durationInMs:g.Numeric(4e3,{min:100,max:2e4,step:100}),speed:g.Numeric(1,{min:1,max:10,step:1},{description:"How many times to spin in the specified duration."}),direction:g.Select("cw",[["cw","Clockwise"],["ccw","Counter Clockwise"]],{cycle:!0})}),initialState:(t,e)=>{var r;return{snapshot:(r=e.canvas3d)===null||r===void 0?void 0:r.camera.getSnapshot()}},getDuration:t=>({kind:"fixed",durationMs:t.durationInMs}),teardown:(t,e,r)=>{var n;(n=r.canvas3d)===null||n===void 0||n.requestCameraReset({snapshot:e.snapshot,durationMs:0})},apply(t,e,r){return N(this,null,function*(){var n,o;if(e.current===0)return{kind:"next",state:t};let i=t.snapshot;if(i.radiusMax<1e-4)return{kind:"finished"};let a=e.animation?((n=e.animation)===null||n===void 0?void 0:n.currentFrame)/(e.animation.frameCount+1):Wo(e.current/r.params.durationInMs,0,1),s=2*Math.PI*a*r.params.speed*(r.params.direction==="ccw"?-1:1);y.sub(Vw,i.position,i.target),y.normalize(YY,i.up),xn.setAxisAngle(QY,YY,s),y.transformQuat(Vw,Vw,QY);let l=y.add(y(),i.target,Vw);return(o=r.plugin.canvas3d)===null||o===void 0||o.requestCameraReset({snapshot:U(w({},i),{position:l}),durationMs:0}),a>=.99999?{kind:"finished"}:{kind:"next",state:t}})}});var $Y=As.create({name:"built-in.animate-model-index",display:{name:"Animate Trajectory"},isExportable:!0,params:()=>({mode:g.MappedStatic("loop",{palindrome:g.Group({}),loop:g.Group({direction:g.Select("forward",[["forward","Forward"],["backward","Backward"]])}),once:g.Group({direction:g.Select("forward",[["forward","Forward"],["backward","Backward"]])},{isFlat:!0})},{options:[["palindrome","Palindrome"],["loop","Loop"],["once","Once"]]}),duration:g.MappedStatic("fixed",{fixed:g.Group({durationInS:g.Numeric(5,{min:1,max:120,step:.1},{description:"Duration in seconds"})},{isFlat:!0}),computed:g.Group({targetFps:g.Numeric(30,{min:5,max:250,step:1},{label:"Target FPS"})},{isFlat:!0}),sequential:g.Group({maxFps:g.Numeric(30,{min:5,max:60,step:1})},{isFlat:!0})})}),canApply(t){let e=t.state.data,r=e.select(lt.Generators.ofTransformer(de.Model.ModelFromTrajectory));for(let n of r){let o=lt.findAncestorOfType(e.tree,e.cells,n.transform.ref,X.Molecule.Trajectory);if(o&&o.obj&&o.obj.data.frameCount>1)return{canApply:!0}}return{canApply:!1,reason:"No trajectory to animate"}},getDuration:(t,e)=>{var r;if(((r=t.duration)===null||r===void 0?void 0:r.name)==="fixed")return{kind:"fixed",durationMs:t.duration.params.durationInS*1e3};if(t.duration.name==="computed"){let n=e.state.data,o=n.select(lt.Generators.ofTransformer(de.Model.ModelFromTrajectory)),i=0;for(let a of o){let s=lt.findAncestorOfType(n.tree,n.cells,a.transform.ref,X.Molecule.Trajectory);if(!s||!s.obj)continue;let l=s.obj;i=Math.max(Math.ceil(1e3*l.data.frameCount/t.duration.params.targetFps),i)}return{kind:"fixed",durationMs:i}}return{kind:"unknown"}},initialState:()=>({}),apply(t,e,r){return N(this,null,function*(){if(r.params.duration.name==="sequential"&&e.current>0&&e.current-e.lastApplied<1e3/r.params.duration.params.maxFps)return{kind:"skip"};let n=r.plugin.state.data,o=n.select(lt.Generators.ofTransformer(de.Model.ModelFromTrajectory));if(o.length===0)return{kind:"finished"};let i=n.build(),a=r.params,s=t.palindromeDirections||{},l=!1,c=!0;for(let u of o){let d=lt.findAncestorOfType(n.tree,n.cells,u.transform.ref,X.Molecule.Trajectory);if(!d||!d.obj)continue;let m=d.obj;m.data.frameCount<=1||i.to(u).update(p=>{let h=m.data.frameCount;if(h!==1)c=!1;else return p;if(a.duration.name==="sequential"){let f=1;if(a.mode.name==="once"){if(f=a.mode.params.direction==="backward"?-1:1,f===-1&&p.modelIndex===0||f===1&&p.modelIndex===h-1)return l=!0,p}else a.mode.name==="palindrome"&&(p.modelIndex===0?f=1:p.modelIndex===h-1?f=-1:f=s[u.transform.ref]||1);s[u.transform.ref]=f;let b=(p.modelIndex+f)%h;return b<0&&(b+=h),l=l||f===-1&&b===0||f===1&&b===h-1,{modelIndex:b}}else{let f=a.duration.name==="fixed"?a.duration.params.durationInS*1e3:Math.ceil(1e3*m.data.frameCount/a.duration.params.targetFps);if(a.mode.name==="once"&&e.current>=f)return l=!0,{modelIndex:m.data.frameCount-1};let b=e.current%f/f;return a.mode.name==="loop"&&a.mode.params.direction==="backward"&&(b=1-b),a.mode.name==="palindrome"&&(b=2*b,b>1&&(b=2-b)),{modelIndex:Math.min(Math.floor(m.data.frameCount*b),m.data.frameCount-1)}}})}return c||(yield Re.State.Update(r.plugin,{state:n,tree:i,options:{doNotLogTiming:!0}})),c||a.mode.name==="once"&&l?{kind:"finished"}:a.mode.name==="palindrome"?{kind:"next",state:{palindromeDirections:s}}:{kind:"next",state:{}}})}});function ZY(t,e,r=!1){return N(this,null,function*(){var n,o,i,a;e.snapshot.data&&(yield t.runTask(t.state.data.setSnapshot(e.snapshot.data)),(n=t.canvas3d)===null||n===void 0||n.setProps({trackball:(i=(o=e.snapshot.canvas3d)===null||o===void 0?void 0:o.props)===null||i===void 0?void 0:i.trackball})),e.snapshot.camera&&((a=t.canvas3d)===null||a===void 0||a.requestCameraReset({snapshot:e.snapshot.camera.current,durationMs:r||e.snapshot.camera.transitionStyle==="instant"?0:e.snapshot.camera.transitionDurationInMs}))})}var JY=As.create({name:"built-in.animate-state-snapshots",display:{name:"State Snapshots"},isExportable:!0,params:()=>({}),canApply(t){let e=t.managers.snapshot.state.entries;return e.size<2?{canApply:!1,reason:"At least 2 states required."}:e.some(r=>!!r?.snapshot.startAnimation)?{canApply:!1,reason:"Nested animations not supported."}:{canApply:t.managers.snapshot.state.entries.size>1}},setup(t,e,r){let n=r.managers.snapshot.state.entries.get(0);ZY(r,n,!0)},getDuration:(t,e)=>({kind:"fixed",durationMs:e.managers.snapshot.state.entries.toArray().reduce((r,n)=>{var o;return r+((o=n.snapshot.durationInMs)!==null&&o!==void 0?o:0)},0)}),initialState:(t,e)=>{let r=e.managers.snapshot.state.entries.toArray();return{totalDuration:r.reduce((n,o)=>{var i;return n+((i=o.snapshot.durationInMs)!==null&&i!==void 0?i:0)},0),snapshots:r,currentIndex:0}},apply(t,e,r){return N(this,null,function*(){var n;if(e.current>=t.totalDuration)return{kind:"finished"};let o=0,i=0;for(let a of t.snapshots){if(o+=(n=a.snapshot.durationInMs)!==null&&n!==void 0?n:0,e.current<o)break;i++}return i>=t.snapshots.length?{kind:"finished"}:i===t.currentIndex?{kind:"skip"}:(yield ZY(r.plugin,t.snapshots[i]),{kind:"next",state:U(w({},t),{currentIndex:i})})})}});var GR={};ua(GR,{ApplyAction:()=>sQ,ClearHighlights:()=>mQ,Highlight:()=>dQ,RemoveObject:()=>lQ,SetCurrentObject:()=>iQ,Snapshots:()=>pQ,SyncBehaviors:()=>oQ,ToggleExpanded:()=>cQ,ToggleVisibility:()=>uQ,Update:()=>aQ,registerDefault:()=>FSe,setSubtreeVisibility:()=>Id});var Ed=class{constructor(){this.subs=void 0}subscribe(e,r){typeof this.subs>"u"&&(this.subs=[]);let n=e.subscribe(r);return this.subs.push(n),{unsubscribe:()=>{n&&this.subs&&nm(this.subs,n)&&(n.unsubscribe(),n=void 0)}}}get ev(){return this._ev||(this._ev=_s.create())}dispose(){if(this._ev&&this._ev.dispose(),this.subs){for(let e of this.subs)e.unsubscribe();this.subs=void 0}}},ji=class extends Ed{updateState(...e){let r=this.state,n=Mz(r,e);return n!==r?(this._state=n,!0):!1}get state(){return this._state}constructor(e){super(),this._state=e}};var Y1="4.3.0",eQ=new Date(typeof __MOLSTAR_DEBUG_TIMESTAMP__<"u"?__MOLSTAR_DEBUG_TIMESTAMP__:1716707835175);function LSe(t,e,r,n=1){t.width=Math.round(window.devicePixelRatio*n*e),t.height=Math.round(window.devicePixelRatio*n*r),Object.assign(t.style,{width:`${e}px`,height:`${r}px`})}function tQ(t,e,r=1){let n=window.innerWidth,o=window.innerHeight;e!==document.body&&(n=e.offsetWidth,o=e.offsetHeight),LSe(t,n,o,r)}function BSe(t,e,r,n){let o=atob(t.toDataURL(r,n).split(",")[1]),i=o.length,a=i>>2,s=new Uint8Array(i),l=new Uint32Array(s.buffer,0,a),c=0;for(let d=0;d<a;++d)l[d]=o.charCodeAt(c++)|o.charCodeAt(c++)<<8|o.charCodeAt(c++)<<16|o.charCodeAt(c++)<<24;let u=i&3;for(;u--;)s[c]=o.charCodeAt(c++);e(new Blob([s],{type:r||"image/png"}))}function Q1(t,e,r){return N(this,null,function*(){return new Promise((n,o)=>{let i=a=>{a?n(a):o("no blob returned")};HTMLCanvasElement.prototype.toBlob?t.toBlob(i,e,r):BSe(t,i,e,r)})})}var oh=(()=>{class t extends ji{getIndex(r){return this.state.entries.indexOf(r)}getEntry(r){if(r)return this.entryMap.get(r)}remove(r){let n=this.entryMap.get(r);n&&(n?.image&&this.plugin.managers.asset.delete(n.image),this.entryMap.delete(r),this.updateState({current:this.state.current===r?void 0:this.state.current,entries:this.state.entries.delete(this.getIndex(n))}),this.events.changed.next(void 0))}add(r){this.entryMap.set(r.snapshot.id,r),this.updateState({current:r.snapshot.id,entries:this.state.entries.push(r)}),this.events.changed.next(void 0)}replace(r,n,o){var i,a,s;let l=this.getEntry(r);if(!l)return;this.defaultSnapshotId=void 0,l?.image&&this.plugin.managers.asset.delete(l.image);let c=this.getIndex(l),u=t.Entry(n,{key:(i=o?.key)!==null&&i!==void 0?i:l.key,name:(a=o?.name)!==null&&a!==void 0?a:l.name,description:(s=o?.description)!==null&&s!==void 0?s:l.description,image:o?.image});this.entryMap.set(n.id,u),this.updateState({current:u.snapshot.id,entries:this.state.entries.set(c,u)}),this.events.changed.next(void 0)}move(r,n){let o=this.state.entries.size;if(o<2)return;let i=this.getEntry(r);if(!i)return;let a=this.getIndex(i),s=(a+n)%o;s<0&&(s+=o);let l=this.state.entries.get(s),c=this.state.entries.asMutable();c.set(s,i),c.set(a,l),this.updateState({current:i.snapshot.id,entries:c.asImmutable()}),this.events.changed.next(void 0)}update(r,n){var o,i,a;let s=this.getIndex(r);if(s<0)return;let l=this.state.entries.set(s,U(w({},r),{key:((o=n.key)===null||o===void 0?void 0:o.trim())||void 0,name:((i=n.name)===null||i===void 0?void 0:i.trim())||void 0,description:((a=n.description)===null||a===void 0?void 0:a.trim())||void 0}));this.updateState({entries:l}),this.entryMap.set(r.snapshot.id,this.state.entries.get(s)),this.events.changed.next(void 0)}clear(){this.state.entries.size!==0&&(this.entryMap.forEach(r=>{r?.image&&this.plugin.managers.asset.delete(r.image)}),this.entryMap.clear(),this.updateState({current:void 0,entries:mm()}),this.events.changed.next(void 0))}applyKey(r){let n=this.state.entries.find(o=>o.key===r);n&&(this.updateState({current:n.snapshot.id}),this.events.changed.next(void 0),this.plugin.state.setSnapshot(n.snapshot))}setCurrent(r){let n=this.getEntry(r);return n&&(this.updateState({current:r}),this.events.changed.next(void 0)),n&&n.snapshot}getNextId(r,n){let o=this.state.entries.size;if(!r){if(o===0)return;let s=n===-1?o-1:0;return this.state.entries.get(s).snapshot.id}let i=this.getEntry(r);if(!i)return;let a=this.getIndex(i);if(!(a<0))return a=(a+n)%o,a<0&&(a+=o),this.state.entries.get(a).snapshot.id}setStateSnapshot(r){return N(this,null,function*(){r.version,Y1,this.clear();let n=mm().asMutable();for(let s of r.entries)this.entryMap.set(s.snapshot.id,s),n.push(s);let o=r.current?r.current:r.entries.length>0?r.entries[0].snapshot.id:void 0;if(this.updateState({current:o,entries:n.asImmutable(),isPlaying:!1,nextSnapshotDelayInMs:r.playback?r.playback.nextSnapshotDelayInMs:t.DefaultNextSnapshotDelayInMs}),this.events.changed.next(void 0),!o)return;let i=this.getEntry(o),a=i&&i.snapshot;if(a)return yield this.plugin.state.setSnapshot(a),r.playback&&r.playback.isPlaying&&this.play(!0),a})}syncCurrent(r){return N(this,null,function*(){var n,o;let i=this.state.entries.size===0,a=this.state.entries.size===1&&this.state.current&&this.state.current===this.defaultSnapshotId;if(!i&&!a)return;let s=this.plugin.state.getSnapshot(r?.params),l=((o=(n=r?.params)===null||n===void 0?void 0:n.image)!==null&&o!==void 0?o:this.plugin.state.snapshotParams.value.image)?yield t.getCanvasImageAsset(this.plugin,`${s.id}-image.png`):void 0;if(i)this.add(t.Entry(s,{name:r?.name,description:r?.description,image:l}));else if(a){let c=this.getEntry(this.state.current);c?.image&&this.plugin.managers.asset.delete(c.image),this.replace(this.state.current,s,{image:l})}this.defaultSnapshotId=s.id})}getStateSnapshot(r){return N(this,null,function*(){return yield this.syncCurrent(r),{timestamp:+new Date,version:Y1,name:r&&r.name,description:r&&r.description,current:this.state.current,playback:{isPlaying:!!(r&&r.playOnLoad),nextSnapshotDelayInMs:this.state.nextSnapshotDelayInMs},entries:this.state.entries.valueSeq().toArray()}})}serialize(r){return N(this,null,function*(){let n=JSON.stringify(yield this.getStateSnapshot({params:r?.params}),null,2);if(!r?.type||r.type==="json"||r.type==="molj")return new Blob([n],{type:"application/json;charset=utf-8"});{let o=new Uint8Array(DA(n));IA(o,0,n);let i={"state.json":o},a=[];for(let{asset:l,file:c}of this.plugin.managers.asset.assets)a.push([l.id,l]),i[`assets/${l.id}`]=new Uint8Array(yield c.arrayBuffer());if(a.length>0){let l=JSON.stringify(a,null,2),c=new Uint8Array(DA(l));IA(c,0,l),i["assets.json"]=c}let s=yield this.plugin.runTask(wU(i));return new Blob([s],{type:"application/zip"})}})}open(r){return N(this,null,function*(){try{let n=r.name.toLowerCase();if(n.endsWith("json")||n.endsWith("molj")){let o=yield this.plugin.runTask(Gx(r,"string")),i=JSON.parse(o);t.isStateSnapshot(i)?yield this.setStateSnapshot(i):t.isStateSnapshot(i.data)?yield this.setStateSnapshot(i.data):yield this.plugin.state.setSnapshot(i)}else{let o=yield this.plugin.runTask(Gx(r,"zip")),i=Object.create(null);ro(o,(c,u)=>{if(u==="state.json"||u==="assets.json")return;let d=u.substring(u.indexOf("/")+1);i[d]=c});let a=new File([o["state.json"]],"state.json"),s=yield this.plugin.runTask(Gx(a,"string"));if(o["assets.json"]){let c=new File([o["assets.json"]],"assets.json"),u=JSON.parse(yield this.plugin.runTask(Gx(c,"string")));for(let[d,m]of u)this.plugin.managers.asset.set(m,new File([i[d]],m.name))}let l=JSON.parse(s);yield this.setStateSnapshot(l)}this.events.opened.next(void 0)}catch(n){console.error(n),this.plugin.log.error("Error reading state")}})}play(r=!1){if(this.updateState({isPlaying:!0}),r){let n=this.getEntry(this.state.current);if(!n){this.next();return}this.events.changed.next(void 0);let o=n.snapshot,i=typeof o.durationInMs<"u"?o.durationInMs:this.state.nextSnapshotDelayInMs;this.timeoutHandle=setTimeout(this.next,i)}else this.next()}stop(){this.updateState({isPlaying:!1}),typeof this.timeoutHandle<"u"&&clearTimeout(this.timeoutHandle),this.timeoutHandle=void 0,this.events.changed.next(void 0)}togglePlay(){this.state.isPlaying?(this.stop(),this.plugin.managers.animation.stop()):this.play()}dispose(){super.dispose(),this.entryMap.clear()}constructor(r){super({current:void 0,entries:mm(),isPlaying:!1,nextSnapshotDelayInMs:t.DefaultNextSnapshotDelayInMs}),this.plugin=r,this.entryMap=new Map,this.defaultSnapshotId=void 0,this.events={changed:this.ev(),opened:this.ev()},this.timeoutHandle=void 0,this.next=()=>N(this,null,function*(){this.timeoutHandle=void 0;let n=this.getNextId(this.state.current,1);if(!n||n===this.state.current){this.stop();return}let o=this.setCurrent(n);yield this.plugin.state.setSnapshot(o);let i=typeof o.durationInMs<"u"?o.durationInMs:this.state.nextSnapshotDelayInMs;this.state.isPlaying&&(this.timeoutHandle=setTimeout(this.next,i))})}}return t.DefaultNextSnapshotDelayInMs=1500,t})();(function(t){function e(o,i){return w({timestamp:+new Date,snapshot:o},i)}t.Entry=e;function r(o){let i=o;return!!i&&!!i.timestamp&&!!i.entries}t.isStateSnapshot=r;function n(o,i){return N(this,null,function*(){if(!o.helpers.viewportScreenshot)return;let a=o.helpers.viewportScreenshot.getPreview(512);if(!a)return;let s=yield Q1(a.canvas,"png"),l=new File([s],i),c={kind:"file",id:vo.create22(),name:i};return o.managers.asset.set(c,l),c})}t.getCanvasImageAsset=n})(oh||(oh={}));function rQ(){let t=new Date,e=t.getFullYear(),r=t.getMonth()+1,n=t.getDate(),o=t.getHours(),i=t.getMinutes(),a=t.getSeconds();return e+"-"+r+"-"+n+"-"+o+"-"+i+"-"+a}function OSe(t){window.open(t,"_blank")||(window.location.href=t)}function nQ(t){try{t.dispatchEvent(new MouseEvent("click"))}catch{let r=document.createEvent("MouseEvents");r.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),t.dispatchEvent(r)}}function zw(t,e="download"){if(t)if("download"in HTMLAnchorElement.prototype){let r=document.createElement("a");r.download=e,r.rel="noopener",typeof t=="string"?(r.href=t,nQ(r)):(r.href=URL.createObjectURL(t),setTimeout(()=>URL.revokeObjectURL(r.href),4e4),setTimeout(()=>nQ(r)))}else if(typeof navigator<"u"&&navigator.msSaveOrOpenBlob)navigator.msSaveOrOpenBlob(t,e);else{let r=window.navigator.userAgent,n=/Safari/i.test(r),o=/CriOS\/[\d]+/.test(r),i=a=>{OSe(o?a:a.replace(/^data:[^;]*;/,"data:attachment/file;"))};if((n||o)&&FileReader)if(t instanceof Blob){let a=new FileReader;a.onloadend=()=>i(a.result),a.readAsDataURL(t)}else i(t);else{let a=URL.createObjectURL(typeof t=="string"?new Blob([t]):t);location.href=a,setTimeout(()=>URL.revokeObjectURL(a),4e4)}}}function FSe(t){oQ(t),iQ(t),aQ(t),sQ(t),lQ(t),cQ(t),uQ(t),dQ(t),mQ(t),pQ(t)}function oQ(t){t.state.events.object.created.subscribe(e=>{X.isBehavior(e.obj)&&e.obj.data.register(e.ref)}),t.state.events.object.removed.subscribe(e=>{var r,n,o,i;X.isBehavior(e.obj)&&((n=(r=e.obj.data).unregister)===null||n===void 0||n.call(r),(i=(o=e.obj.data).dispose)===null||i===void 0||i.call(o))}),t.state.events.object.updated.subscribe(e=>{var r,n,o,i;e.action==="recreate"&&(e.oldObj&&X.isBehavior(e.oldObj)&&((n=(r=e.oldObj.data).unregister)===null||n===void 0||n.call(r),(i=(o=e.oldObj.data).dispose)===null||i===void 0||i.call(o)),e.obj&&X.isBehavior(e.obj)&&e.obj.data.register(e.ref))})}function iQ(t){Re.State.SetCurrentObject.subscribe(t,({state:e,ref:r})=>e.setCurrent(r))}function aQ(t){Re.State.Update.subscribe(t,({state:e,tree:r,options:n})=>t.runTask(e.updateTree(r,n)))}function sQ(t){Re.State.ApplyAction.subscribe(t,({state:e,action:r,ref:n})=>t.runTask(e.applyAction(r.action,r.params,n)))}function lQ(t){function e(r,n){let o=r.build().delete(n);return t.runTask(r.updateTree(o))}Re.State.RemoveObject.subscribe(t,({state:r,ref:n,removeParentGhosts:o})=>{if(o){let i=r.tree,a=i.transforms.get(n);if(a.parent===n)return e(r,n);for(;;){let s=i.children.get(a.parent);if(a.parent===a.ref||s.size>1)return e(r,a.ref);let l=i.transforms.get(a.parent);if(!l.state.isGhost)return e(r,a.ref);a=l}}else return e(r,n)})}function cQ(t){Re.State.ToggleExpanded.subscribe(t,({state:e,ref:r})=>e.updateCellState(r,({isCollapsed:n})=>({isCollapsed:!n})))}function uQ(t){Re.State.ToggleVisibility.subscribe(t,({state:e,ref:r})=>Id(e,r,!e.cells.get(r).state.isHidden))}function Id(t,e,r){Nn.doPreOrder(t.tree,t.transforms.get(e),{state:t,value:r},NSe)}function NSe(t,e,r){r.state.updateCellState(t.ref,{isHidden:r.value})}function dQ(t){Re.Interactivity.Object.Highlight.subscribe(t,({state:e,ref:r})=>{if(!t.canvas3d||t.isBusy)return;t.managers.interactivity.lociHighlights.clearHighlights();let n=typeof r=="string"?[r]:r;for(let o of n){let i=e.cells.get(o);if(i){if(X.Molecule.Structure.is(i.obj))t.managers.interactivity.lociHighlights.highlight({loci:ue.Loci(i.obj.data)},!1);else if(i&&X.isRepresentation3D(i.obj)){let{repr:a}=i.obj.data;for(let s of a.getAllLoci())t.managers.interactivity.lociHighlights.highlight({loci:s,repr:a},!1)}else if(X.Molecule.Structure.Selections.is(i.obj))for(let a of i.obj.data)t.managers.interactivity.lociHighlights.highlight({loci:a.loci},!1)}}})}function mQ(t){Re.Interactivity.ClearHighlights.subscribe(t,()=>{t.managers.interactivity.lociHighlights.clearHighlights()})}function pQ(t){t.config.set(Wt.State.CurrentServer,t.config.get(Wt.State.DefaultServer)),Re.State.Snapshots.Clear.subscribe(t,()=>{t.managers.snapshot.clear()}),Re.State.Snapshots.Remove.subscribe(t,({id:e})=>{t.managers.snapshot.remove(e)}),Re.State.Snapshots.Add.subscribe(t,i=>N(this,[i],function*({key:e,name:r,description:n,params:o}){var a;let s=t.state.getSnapshot(o),l=((a=o?.image)!==null&&a!==void 0?a:t.state.snapshotParams.value.image)?yield oh.getCanvasImageAsset(t,`${s.id}-image.png`):void 0,c=oh.Entry(s,{key:e,name:r,description:n,image:l});t.managers.snapshot.add(c)})),Re.State.Snapshots.Replace.subscribe(t,n=>N(this,[n],function*({id:e,params:r}){var o;let i=t.state.getSnapshot(r),a=((o=r?.image)!==null&&o!==void 0?o:t.state.snapshotParams.value.image)?yield oh.getCanvasImageAsset(t,`${i.id}-image.png`):void 0;t.managers.snapshot.replace(e,t.state.getSnapshot(r),{image:a})})),Re.State.Snapshots.Move.subscribe(t,({id:e,dir:r})=>{t.managers.snapshot.move(e,r)}),Re.State.Snapshots.Apply.subscribe(t,({id:e})=>{let r=t.managers.snapshot.setCurrent(e);if(r)return t.state.setSnapshot(r)}),Re.State.Snapshots.Upload.subscribe(t,a=>N(this,[a],function*({name:e,description:r,playOnLoad:n,serverUrl:o,params:i}){return fetch(kf(o,`set?name=${encodeURIComponent(e||"")}&description=${encodeURIComponent(r||"")}`),{method:"POST",mode:"cors",referrer:"no-referrer",headers:{"Content-Type":"application/json; charset=utf-8"},body:JSON.stringify(yield t.managers.snapshot.getStateSnapshot({name:e,description:r,playOnLoad:n}))})})),Re.State.Snapshots.Fetch.subscribe(t,r=>N(this,[r],function*({url:e}){let n=yield t.runTask(t.fetch({url:e,type:"json"}));yield t.managers.snapshot.setStateSnapshot(n.data)})),Re.State.Snapshots.DownloadToFile.subscribe(t,o=>N(this,[o],function*({name:e,type:r,params:n}){let i=`mol-star_state_${e||rQ()}.${r==="json"?"molj":"molx"}`,a=yield t.managers.snapshot.serialize({type:r,params:n});zw(a,`${i}`)})),Re.State.Snapshots.OpenFile.subscribe(t,({file:e})=>t.managers.snapshot.open(e)),Re.State.Snapshots.OpenUrl.subscribe(t,n=>N(this,[n],function*({url:e,type:r}){let o=yield t.runTask(t.fetch({url:e,type:"binary"}));return t.managers.snapshot.open(new File([o],`state.${r}`))}))}var HR={};ua(HR,{SyncRepresentationToCanvas:()=>fQ,SyncStructureRepresentation3DState:()=>hQ,UpdateRepresentationVisibility:()=>gQ,registerDefault:()=>VSe});function VSe(t){fQ(t),hQ(t),gQ(t)}function fQ(t){let e=t.state.data.events;e.object.created.subscribe(r=>{var n;X.isRepresentation3D(r.obj)&&(jR(r.state.cells.get(r.ref),r.obj.data.repr),r.obj.data.repr.setState({syncManually:!0}),(n=t.canvas3d)===null||n===void 0||n.add(r.obj.data.repr))}),e.object.updated.subscribe(r=>{var n,o;r.oldObj&&X.isRepresentation3D(r.oldObj)&&((n=t.canvas3d)===null||n===void 0||n.remove(r.oldObj.data.repr),r.oldObj.data.repr.destroy()),X.isRepresentation3D(r.obj)&&(jR(r.state.cells.get(r.ref),r.obj.data.repr),r.action==="recreate"&&r.obj.data.repr.setState({syncManually:!0}),(o=t.canvas3d)===null||o===void 0||o.add(r.obj.data.repr))}),e.object.removed.subscribe(r=>{var n;X.isRepresentation3D(r.obj)&&((n=t.canvas3d)===null||n===void 0||n.remove(r.obj.data.repr),r.obj.data.repr.destroy())})}function hQ(t){let e=t.state.data.events;e.object.created.subscribe(r=>{var n;if(!X.Molecule.Structure.Representation3DState.is(r.obj))return;let o=r.obj.data;o.repr.setState(o.state),(n=t.canvas3d)===null||n===void 0||n.update(o.repr)}),e.object.updated.subscribe(r=>{var n;if(!X.Molecule.Structure.Representation3DState.is(r.obj))return;let o=r.obj.data;o.repr.setState(o.state),(n=t.canvas3d)===null||n===void 0||n.update(o.repr)}),e.object.removed.subscribe(r=>{var n;if(!X.Molecule.Structure.Representation3DState.is(r.obj))return;let o=r.obj.data;o.repr.setState(o.initialState),(n=t.canvas3d)===null||n===void 0||n.update(o.repr)})}function gQ(t){t.state.data.events.cell.stateUpdated.subscribe(e=>{var r;let n=e.state.cells.get(e.ref);X.isRepresentation3D(n.obj)&&jR(n,n.obj.data.repr)&&((r=t.canvas3d)===null||r===void 0||r.syncVisibility())})}function jR(t,e){return e.state.visible===!!t.state.isHidden?(e.setState({visible:!t.state.isHidden}),!0):!1}var qR={};ua(qR,{Focus:()=>bQ,OrientAxes:()=>xQ,Reset:()=>yQ,ResetAxes:()=>SQ,SetSnapshot:()=>vQ,registerDefault:()=>zSe});function zSe(t){yQ(t),bQ(t),vQ(t),xQ(t),SQ(t)}function yQ(t){Re.Camera.Reset.subscribe(t,e=>{t.managers.camera.reset(e?.snapshot,e?.durationMs)})}function vQ(t){Re.Camera.SetSnapshot.subscribe(t,({snapshot:e,durationMs:r})=>{t.managers.camera.setSnapshot(e,r)})}function bQ(t){Re.Camera.Focus.subscribe(t,({center:e,radius:r,durationMs:n})=>{t.managers.camera.focusSphere({center:e,radius:r},{durationMs:n}),t.events.canvas3d.settingsUpdated.next(void 0)})}function xQ(t){Re.Camera.OrientAxes.subscribe(t,({structures:e,durationMs:r})=>{t.managers.camera.orientAxes(e,r)})}function SQ(t){Re.Camera.ResetAxes.subscribe(t,({durationMs:e})=>{t.managers.camera.resetAxes(e)})}var oL={};ua(oL,{Canvas3DSetSettings:()=>RK,registerDefault:()=>n2e});function _n(){return _n.zero()}(function(t){function e(){return{x:0,y:0,width:0,height:0}}t.zero=e;function r(l,c,u,d){return{x:l,y:c,width:u,height:d}}t.create=r;function n(l){return w({},l)}t.clone=n;function o(l,c){return Object.assign(l,c)}t.copy=o;function i(l,c,u,d,m){return l.x=c,l.y=u,l.width=d,l.height=m,l}t.set=i;function a(l,c){return l[0]=c.x,l[1]=c.y,l[2]=c.width,l[3]=c.height,l}t.toVec4=a;function s(l,c){return l.x===c.x&&l.y===c.y&&l.width===c.width&&l.height===c.height}t.equals=s})(_n||(_n={}));var bm=at();function CQ(t,e,r,n){let{x:o,y:i,width:a,height:s}=r;at.set(bm,e[0],e[1],e[2],1),at.transformMat4(bm,bm,n);let l=bm[3];return l!==0&&(bm[0]/=l,bm[1]/=l,bm[2]/=l),t[0]=(bm[0]+1)*a*.5+o,t[1]=(bm[1]+1)*s*.5+i,t[2]=(bm[2]+1)*.5,t[3]=l===0?0:1/l,t}function kv(t,e,r,n){let{x:o,y:i,width:a,height:s}=r,l=e[0]-o,c=e[1]-i,u=e[2];return t[0]=2*l/a-1,t[1]=2*c/s-1,t[2]=2*u-1,y.transformMat4(t,t,n)}function ih(t){if(typeof t=="object"){if("buttons"in t)return t.buttons;if("which"in t){let e=t.which;if(e===2)return 4;if(e===3)return 2;if(e>0)return 1<<e-1}}return 0}function ny(t){if(typeof t=="object"&&"button"in t){let e=t.button;if(e===1)return 4;if(e===2)return 2;if(e>=0)return 1<<e}return 0}function K1(t){return{alt:"altKey"in t?t.altKey:!1,shift:"shiftKey"in t?t.shiftKey:!1,control:"ctrlKey"in t?t.ctrlKey:!1,meta:"metaKey"in t?t.metaKey:!1}}var TQ={noScroll:!0,noMiddleClickScroll:!0,noContextMenu:!0,noPinchZoom:!0,noTextSelect:!0,preventGestures:!1,mask:(t,e)=>!0,pixelScale:1},na;(function(t){t.None=o();function e(i,a){return i.shift===a.shift&&i.alt===a.alt&&i.control===a.control&&i.meta===a.meta}t.areEqual=e;function r(i){return e(i,t.None)}t.areNone=r;function n(i){if(!i)return 0;let a=0;return i.shift&&a++,i.alt&&a++,i.control&&a++,i.meta&&a++,a}t.size=n;function o(i={}){return{shift:!!i.shift,alt:!!i.alt,control:!!i.control,meta:!!i.meta}}t.create=o})(na||(na={}));var yn;(function(t){t.has=Wc.has,t.create=Wc.create;let e;(function(r){r[r.None=0]="None",r[r.Primary=1]="Primary",r[r.Secondary=2]="Secondary",r[r.Auxilary=4]="Auxilary",r[r.Forth=8]="Forth",r[r.Five=16]="Five"})(e=t.Flag||(t.Flag={}))})(yn||(yn={}));var WR={key:"",code:"",modifiers:na.None,x:-1,y:-1,pageX:-1,pageY:-1,preventDefault:hs},ry=function(t){return t[t.Stopped=0]="Stopped",t[t.Started=1]="Started",t[t.Moving=2]="Moving",t}(ry||{});function wQ(){return{drag:new ln,interactionEnd:new ln,click:new ln,move:new ln,wheel:new ln,pinch:new ln,gesture:new ln,resize:new ln,leave:new ln,enter:new ln,modifiers:new ln,key:new ln,keyUp:new ln,keyDown:new ln,lock:new ln}}var USe=["Backspace","Delete"],Uw;(function(t){function e(n={}){let{noScroll:o,noContextMenu:i}=w(w({},TQ),n);return U(w({noScroll:o,noContextMenu:i,pointerLock:!1,width:0,height:0,pixelRatio:1},wQ()),{setPixelScale:hs,requestPointerLock:hs,exitPointerLock:hs,dispose:hs})}t.create=e;function r(n,o={}){let{noScroll:i,noMiddleClickScroll:a,noContextMenu:s,noPinchZoom:l,noTextSelect:c,mask:u,pixelScale:d,preventGestures:m}=w(w({},TQ),o),p=n.clientWidth*I(),h=n.clientHeight*I(),f=!1,b=_n(),v=0,x=0,S=ne(),T=ne(),E=ne(),_=ne(),D=ne(),P={shift:!1,alt:!1,control:!1,meta:!1},A={x:-1,y:-1,pageX:-1,pageY:-1};function I(){return window.devicePixelRatio*d}function k(){return w({},P)}function M(me){return me.target===document.body||me.target===n}let R=ry.Stopped,B=!1,F=yn.create(yn.Flag.None),G=yn.Flag.None,V=!1,H=!1,Q;typeof window.ResizeObserver<"u"&&(Q=new window.ResizeObserver(go));let L=wQ(),{drag:Y,interactionEnd:j,wheel:O,pinch:J,gesture:$,click:ae,move:Z,leave:se,enter:Me,resize:be,modifiers:_e,key:je,keyUp:gt,keyDown:fr,lock:Nr}=L;Zt();function Zt(){n.addEventListener("contextmenu",Qe,!1),n.addEventListener("wheel",_t,!1),n.addEventListener("mousedown",Bn,!1),window.addEventListener("mousemove",co,!1),window.addEventListener("mouseup",bn,!1),n.addEventListener("touchstart",_r,!1),n.addEventListener("touchmove",Ao,!1),n.addEventListener("touchend",qr,!1),n.addEventListener("gesturechange",On,!1),n.addEventListener("gesturestart",ho,!1),n.addEventListener("gestureend",$a,!1),window.addEventListener("blur",Ke),window.addEventListener("keyup",It,!1),window.addEventListener("keydown",Ve,!1),window.addEventListener("keypress",yt,!1),document.addEventListener("pointerlockchange",De,!1),document.addEventListener("pointerlockerror",Le,!1),Q!=null?Q.observe(n.parentElement):window.addEventListener("resize",go,!1)}function oe(){B||(B=!0,n.removeEventListener("contextmenu",Qe,!1),n.removeEventListener("wheel",_t,!1),n.removeEventListener("mousedown",Bn,!1),window.removeEventListener("mousemove",co,!1),window.removeEventListener("mouseup",bn,!1),n.removeEventListener("touchstart",_r,!1),n.removeEventListener("touchmove",Ao,!1),n.removeEventListener("touchend",qr,!1),n.removeEventListener("gesturechange",On,!1),n.removeEventListener("gesturestart",ho,!1),n.removeEventListener("gestureend",$a,!1),window.removeEventListener("blur",Ke),window.removeEventListener("keyup",It,!1),window.removeEventListener("keydown",Ve,!1),window.removeEventListener("keypress",yt,!1),document.removeEventListener("pointerlockchange",De,!1),document.removeEventListener("pointerlockerror",Le,!1),ea.remove(),Q!=null?(Q.unobserve(n.parentElement),Q.disconnect()):window.removeEventListener("resize",go,!1))}function De(){n.ownerDocument.pointerLockElement===n?f=!0:f=!1,ef(f),Nr.next(f)}function Le(){console.error("Unable to use Pointer Lock API"),f=!1,ef(f),Nr.next(f)}function Qe(me){u(me.clientX,me.clientY)&&s&&me.preventDefault()}function Ue(me){P.alt=me.altKey,P.shift=me.shiftKey,P.control=me.ctrlKey,P.meta=me.metaKey}function Ke(){(F||P.shift||P.alt||P.meta||P.control)&&(F=0,P.shift=P.alt=P.control=P.meta=!1)}function Ve(me){let Ft=!1;!P.alt&&me.altKey&&(Ft=!0,P.alt=!0),!P.shift&&me.shiftKey&&(Ft=!0,P.shift=!0),!P.control&&me.ctrlKey&&(Ft=!0,P.control=!0),!P.meta&&me.metaKey&&(Ft=!0,P.meta=!0),Ft&&V&&_e.next(k()),M(me)&&V&&fr.next(U(w({key:me.key,code:me.code,modifiers:k()},A),{preventDefault:()=>me.preventDefault()}))}function It(me){let Ft=!1;P.alt&&!me.altKey&&(Ft=!0,P.alt=!1),P.shift&&!me.shiftKey&&(Ft=!0,P.shift=!1),P.control&&!me.ctrlKey&&(Ft=!0,P.control=!1),P.meta&&!me.metaKey&&(Ft=!0,P.meta=!1),Ft&&V&&_e.next(k()),USe.includes(me.key)&&yt(me),M(me)&&V&&gt.next(U(w({key:me.key,code:me.code,modifiers:k()},A),{preventDefault:()=>me.preventDefault()}))}function yt(me){!M(me)||!V||je.next(U(w({key:me.key,code:me.code,modifiers:k()},A),{preventDefault:()=>me.preventDefault()}))}function pe(me){let Ft=me.touches[0],ke=me.touches[1];return{clientX:(Ft.clientX+ke.clientX)/2,clientY:(Ft.clientY+ke.clientY)/2,pageX:(Ft.pageX+ke.pageX)/2,pageY:(Ft.pageY+ke.pageY)/2,target:me.target}}function Ae(me){let Ft=me.touches[0].pageX-me.touches[1].pageX,ke=me.touches[0].pageY-me.touches[1].pageY;return Math.sqrt(Ft*Ft+ke*ke)}let $e=-1,ft,Pt=ne(),yr=ne();function Ze(me){$e<0||(ne.set(yr,me.touches[0].pageX,me.touches[0].pageY),$e+=ne.distance(Pt,yr),ne.copy(Pt,yr))}function _r(me){if(me.preventDefault(),ft=void 0,$e=-1,me.touches.length===1)$e=0,ne.set(Pt,me.touches[0].pageX,me.touches[0].pageY),ft=me.touches[0],F=G=yn.Flag.Primary,Ys(me.touches[0]);else if(me.touches.length===2){F=yn.Flag.Secondary&yn.Flag.Auxilary,G=yn.Flag.Secondary,Ys(pe(me));let Ft=Ae(me);v=Ft,J.next({distance:Ft,fraction:1,fractionDelta:0,delta:0,isStart:!0,buttons:F,button:G,modifiers:k()})}else me.touches.length===3&&(F=G=yn.Flag.Forth,Ys(pe(me)))}function qr(me){if(Ii(),ft&&$e<=4){let Ft=ft;if(!u(Ft.clientX,Ft.clientY))return;od(yr,Ft);let{pageX:ke,pageY:ot}=id(Ft),[Tt,sn]=yr;ae.next({x:Tt,y:sn,pageX:ke,pageY:ot,buttons:F,button:G,modifiers:k()})}ft=void 0}function Ao(me){if(G=yn.Flag.None,l&&(me.preventDefault(),me.stopPropagation(),me.originalEvent&&(me.originalEvent.preventDefault(),me.originalEvent.stopPropagation())),ft=void 0,me.touches.length===1)F=yn.Flag.Primary,ft=me.touches[0],Ze(me),He(me.touches[0]);else if(me.touches.length===2){let Ft=Ae(me),ke=v-Ft;if(Math.abs(ke)<4)F=yn.Flag.Secondary,He(pe(me));else{F=yn.Flag.Auxilary,Ue(me);let ot=v/Ft;J.next({delta:ke,fraction:ot,fractionDelta:x-ot,distance:Ft,isStart:!1,buttons:F,button:G,modifiers:k()}),x=ot}v=Ft}else me.touches.length===3&&(F=yn.Flag.Forth,He(pe(me)))}function Bn(me){Ue(me),F=ih(me),G=ny(me),a&&F===yn.Flag.Auxilary&&me.preventDefault,Ys(me)}function co(me){Ue(me),F=ih(me),G=yn.Flag.None,He(me)}function bn(me){Ue(me),F=ih(me),G=ny(me),Sl(me),Ii()}function Ii(){j.next(void 0)}function Ys(me){u(me.clientX,me.clientY)&&(od(T,me),ne.copy(S,T),Gc(T)&&(R=ry.Started))}function Sl(me){if(R=ry.Stopped,!!u(me.clientX,me.clientY)){if(od(E,me),!H&&ne.distance(E,S)<4){let{pageX:Ft,pageY:ke}=id(me),[ot,Tt]=E;ae.next({x:ot,y:Tt,pageX:Ft,pageY:ke,buttons:F,button:G,modifiers:k()})}H=!1}}function He(me){var Ft;od(E,me);let{pageX:ke,pageY:ot}=id(me),[Tt,sn]=E,{movementX:ca,movementY:fs}=me,Qs=Gc(E)&&u(me.clientX,me.clientY);if(V&&!Qs?se.next(void 0):!V&&Qs&&Me.next(void 0),V=Qs,A.x=Tt,A.y=sn,A.pageX=ke,A.pageY=ot,Z.next({x:Tt,y:sn,pageX:ke,pageY:ot,movementX:ca,movementY:fs,buttons:F,button:G,modifiers:k(),inside:Qs,onElement:me.target===n}),R===ry.Stopped||(c&&((Ft=me.preventDefault)===null||Ft===void 0||Ft.call(me)),ne.div(_,ne.sub(_,E,T),nd(D)),ne.magnitude(_)<1e-6))return;let Ks=R===ry.Started;if(Ks&&!u(me.clientX,me.clientY))return;ne.distance(E,S)>=4&&(H=!0);let[tf,rf]=_;Y.next({x:Tt,y:sn,dx:tf,dy:rf,pageX:ke,pageY:ot,buttons:F,button:G,modifiers:k(),isStart:Ks}),ne.copy(T,E),R=ry.Moving}function _t(me){if(!u(me.clientX,me.clientY))return;od(E,me);let{pageX:Ft,pageY:ke}=id(me),[ot,Tt]=E;i&&me.preventDefault();let sn=GSe(me);F=G=yn.Flag.Auxilary,(sn.dx||sn.dy||sn.dz)&&O.next(U(w({x:ot,y:Tt,pageX:Ft,pageY:ke},sn),{buttons:F,button:G,modifiers:k()}))}function Gt(me){var Ft,ke;m&&(me.preventDefault(),(Ft=me.stopImmediatePropagation)===null||Ft===void 0||Ft.call(me),(ke=me.stopPropagation)===null||ke===void 0||ke.call(me))}let Xt=0,Vr=0;function ho(me){Gt(me),Xt=me.scale,Vr=me.rotation,$.next({scale:me.scale,rotation:me.rotation,deltaRotation:0,deltaScale:0,isStart:!0})}function mt(me,Ft){$.next({scale:me.scale,rotation:me.rotation,deltaRotation:Vr-me.rotation,deltaScale:Xt-me.scale,isEnd:Ft}),Vr=me.rotation,Xt=me.scale}function On(me){Gt(me),mt(me)}function $a(me){Gt(me),mt(me,!0)}function go(){p=n.clientWidth*I(),h=n.clientHeight*I(),be.next({})}function Gc(me){if(n instanceof Window||n instanceof Document||n===document.body)return!0;{let Ft=n.getBoundingClientRect();return me[0]>=0&&me[1]>=0&&me[0]<Ft.width&&me[1]<Ft.height}}function nd(me){return me[0]=n.clientWidth,me[1]=n.clientHeight,me}function od(me,Ft){if(p=n.clientWidth*I(),h=n.clientHeight*I(),f){let ke=I();me[0]=(b.x+b.width/2)/ke,me[1]=(h-(b.y+b.height/2))/ke}else{let ke=n.getBoundingClientRect();me[0]=(Ft.clientX||0)-ke.left,me[1]=(Ft.clientY||0)-ke.top}return me}function id(me){return f?{pageX:Math.round(window.innerWidth/2)+b.x,pageY:Math.round(window.innerHeight/2)+b.y}:{pageX:me.pageX,pageY:me.pageY}}let oc=30,ea=vg();function vg(){var me;let Ft=document.createElement("div"),ke="30%",ot="10%",Tt=`#000 ${ke}, #0000 0 calc(100% - ${ke}), #000 0`,sn=`linear-gradient(0deg, ${Tt}) 50%/${ot} 100% no-repeat`,ca=`linear-gradient(90deg, ${Tt}) 50%/100% ${ot} no-repeat`;return Object.assign(Ft.style,{width:`${oc}px`,aspectRatio:1,background:`${sn}, ${ca}, radial-gradient(circle at 50%, #000 5%, #0000 5%)`,display:"none",zIndex:1e3,position:"absolute",mixBlendMode:"difference",filter:"invert(1)"}),(me=n.parentElement)===null||me===void 0||me.appendChild(Ft),Ft}function ef(me){if(ea.style.display=me?"block":"none",me){let Ft=I(),ke=(b.x+b.width/2)/Ft,ot=(b.y+b.height/2)/Ft;ea.style.width=`${oc}px`,ea.style.left=`calc(${ke}px - ${oc/2}px)`,ea.style.bottom=`calc(${ot}px - ${oc/2}px)`}}return U(w({get noScroll(){return i},set noScroll(me){i=me},get noContextMenu(){return s},set noContextMenu(me){s=me},get width(){return p},get height(){return h},get pixelRatio(){return I()},get pointerLock(){return f}},L),{setPixelScale:me=>{d=me,p=n.clientWidth*I(),h=n.clientHeight*I()},requestPointerLock:me=>{b=me,f||n.requestPointerLock()},exitPointerLock:()=>{f&&n.ownerDocument.exitPointerLock()},dispose:oe})}t.fromElement=r})(Uw||(Uw={}));function GSe(t){let o=0,i=0,a=0,s=0,l=0;return"detail"in t&&(i=t.detail),"wheelDelta"in t&&(i=-t.wheelDelta/120),"wheelDeltaY"in t&&(i=-t.wheelDeltaY/120),"wheelDeltaX"in t&&(o=-t.wheelDeltaX/120),"axis"in t&&t.axis===t.HORIZONTAL_AXIS&&(o=i,i=0),a=o*10,s=i*10,"deltaY"in t&&(s=t.deltaY),"deltaX"in t&&(a=t.deltaX),"deltaZ"in t&&(l=t.deltaZ),(a||s||l)&&t.deltaMode&&(t.deltaMode===1?(a*=40,s*=40,l*=40):(a*=800,s*=800,l*=800)),a&&!o&&(o=a<1?-1:1),s&&!i&&(i=s<1?-1:1),{spinX:o,spinY:i,dx:a,dy:s,dz:l}}var ah=function(t){return t[t.None=0]="None",t[t.Object=1]="Object",t[t.Instance=2]="Instance",t[t.Group=3]="Group",t}(ah||{}),Gw=function(t){return t[t.None=0]="None",t[t.Depth=1]="Depth",t[t.Mask=2]="Mask",t}(Gw||{}),jw={backgroundColor:g.Color(ce(0),{description:"Background color of the 3D canvas"}),pickingAlphaThreshold:g.Numeric(.5,{min:0,max:1,step:.01},{description:"The minimum opacity value needed for an object to be pickable."}),interiorDarkening:g.Numeric(.5,{min:0,max:1,step:.01}),interiorColorFlag:g.Boolean(!0,{label:"Use Interior Color"}),interiorColor:g.Color(ce.fromNormalizedRgb(.3,.3,.3)),colorMarker:g.Boolean(!0,{description:"Enable color marker"}),highlightColor:g.Color(ce.fromNormalizedRgb(1,.4,.6)),selectColor:g.Color(ce.fromNormalizedRgb(.2,1,.1)),dimColor:g.Color(ce.fromNormalizedRgb(1,1,1)),highlightStrength:g.Numeric(.3,{min:0,max:1,step:.1}),selectStrength:g.Numeric(.3,{min:0,max:1,step:.1}),dimStrength:g.Numeric(0,{min:0,max:1,step:.1}),markerPriority:g.Select(1,[[1,"Highlight"],[2,"Select"]]),xrayEdgeFalloff:g.Numeric(1,{min:0,max:3,step:.1}),exposure:g.Numeric(1,{min:0,max:3,step:.01}),light:g.ObjectList({inclination:g.Numeric(150,{min:0,max:180,step:1}),azimuth:g.Numeric(320,{min:0,max:360,step:1}),color:g.Color(ce.fromNormalizedRgb(1,1,1)),intensity:g.Numeric(.6,{min:0,max:5,step:.01})},t=>ce.toHexString(t.color),{defaultValue:[{inclination:150,azimuth:320,color:ce.fromNormalizedRgb(1,1,1),intensity:.6}]}),ambientColor:g.Color(ce.fromNormalizedRgb(1,1,1)),ambientIntensity:g.Numeric(.4,{min:0,max:2,step:.01})},_Q=y(),XR=y();function PQ(t,e){let r=t.length,{direction:n,color:o}=e||{direction:new Array(r*3).fill(0),color:new Array(r*3).fill(0)};for(let i=0;i<r;++i){let a=t[i];y.directionFromSpherical(_Q,or(a.inclination),or(a.azimuth),1),y.toArray(_Q,n,i*3),y.scale(XR,ce.toVec3Normalized(XR,a.color),a.intensity),y.toArray(XR,o,i*3)}return{count:r,direction:n,color:o}}var Hw;(function(t){function e(r,n={}){let{gl:o,state:i,stats:a}=r,s=g.merge(jw,g.getDefaultValues(jw),n),l=PQ(s.light),c=_n(),u=ne.create(o.drawingBufferWidth,o.drawingBufferHeight),d=ce.toVec3Normalized(y(),s.backgroundColor),m=!1,p=null,h=r.resources.texture("image-uint8","rgba","ubyte","nearest");h.define(1,1),h.load({array:new Uint8Array([255,255,255,255]),width:1,height:1});let f=[["tDepth",h]],b=W(),v=W(),x=W(),S=W(),T=W(),E=W(),_=W(),D=y(),P=y(),A=qn(),I=ne(),k=up(),M=y();y.scale(M,ce.toArrayNormalized(s.ambientColor,M,0),s.ambientIntensity);let R={uDrawId:C.create(0),uModel:C.create(W.identity()),uView:C.create(b),uInvView:C.create(v),uModelView:C.create(x),uInvModelView:C.create(S),uInvProjection:C.create(T),uProjection:C.create(W()),uModelViewProjection:C.create(E),uInvModelViewProjection:C.create(_),uIsOrtho:C.create(1),uViewOffset:C.create(I),uPixelRatio:C.create(r.pixelRatio),uViewport:C.create(_n.toVec4(at(),c)),uDrawingBufferSize:C.create(u),uCameraPosition:C.create(P),uCameraDir:C.create(D),uCameraPlane:C.create(qn.toArray(A,at(),0)),uNear:C.create(1),uFar:C.create(1e4),uFog:C.create(!0),uFogNear:C.create(1),uFogFar:C.create(1e4),uFogColor:C.create(d),uRenderMask:C.create(0),uMarkingDepthTest:C.create(!1),uPickType:C.create(ah.None),uMarkingType:C.create(Gw.None),uTransparentBackground:C.create(!1),uLightDirection:C.create(l.direction),uLightColor:C.create(l.color),uAmbientColor:C.create(M),uPickingAlphaThreshold:C.create(s.pickingAlphaThreshold),uInteriorDarkening:C.create(s.interiorDarkening),uInteriorColorFlag:C.create(s.interiorColorFlag),uInteriorColor:C.create(ce.toVec3Normalized(y(),s.interiorColor)),uHighlightColor:C.create(ce.toVec3Normalized(y(),s.highlightColor)),uSelectColor:C.create(ce.toVec3Normalized(y(),s.selectColor)),uDimColor:C.create(ce.toVec3Normalized(y(),s.dimColor)),uHighlightStrength:C.create(s.highlightStrength),uSelectStrength:C.create(s.selectStrength),uDimStrength:C.create(s.dimStrength),uMarkerPriority:C.create(s.markerPriority),uMarkerAverage:C.create(0),uXrayEdgeFalloff:C.create(s.xrayEdgeFalloff),uExposure:C.create(s.exposure)},B=Object.entries(R),F=!0,G=(oe,De,Le)=>{var Qe,Ue,Ke;if(oe.state.disposed||!oe.state.visible||!oe.state.pickable&&De==="pick"||!up.intersectsSphere3D(k,oe.values.boundingSphere.ref.value))return;let[Ve,It]=oe.values.uLod.ref.value;if(Ve!==0||It!==0){let{center:$e,radius:ft}=oe.values.boundingSphere.ref.value,Pt=qn.distanceToPoint(A,$e);if(Pt+ft<Ve||Pt-ft>It)return}let yt=oe.values.instanceGrid.ref.value.cellSize>1;yt||yt&&oe.values.lodLevels?oe.cull(A,k,p,r.stats):oe.uncull();let pe=!1;oe.values.dLightCount.ref.value!==l.count&&(C.update(oe.values.dLightCount,l.count),pe=!0),oe.values.dColorMarker.ref.value!==s.colorMarker&&(C.update(oe.values.dColorMarker,s.colorMarker),pe=!0),pe&&oe.update();let Ae=oe.getProgram(De);if(i.currentProgramId!==Ae.id&&(F=!0,Ae.use()),F&&(Ae.setUniforms(B),Ae.bindTextures(f,0),F=!1),oe.values.dGeometryType.ref.value==="directVolume"){if(De!=="color")return;i.disable(o.CULL_FACE),i.frontFace(o.CCW),Le===3&&(i.disable(o.DEPTH_TEST),i.depthMask(!1))}else Le===1?(i.enable(o.CULL_FACE),!((Qe=oe.values.dFlipSided)===null||Qe===void 0)&&Qe.ref.value?(i.frontFace(o.CW),i.cullFace(o.FRONT)):(i.frontFace(o.CCW),i.cullFace(o.BACK))):Le===2?(i.enable(o.CULL_FACE),!((Ue=oe.values.dFlipSided)===null||Ue===void 0)&&Ue.ref.value?(i.frontFace(o.CW),i.cullFace(o.BACK)):(i.frontFace(o.CCW),i.cullFace(o.FRONT))):(oe.values.uDoubleSided?oe.values.uDoubleSided.ref.value||oe.values.hasReflection.ref.value?i.disable(o.CULL_FACE):i.enable(o.CULL_FACE):i.disable(o.CULL_FACE),!((Ke=oe.values.dFlipSided)===null||Ke===void 0)&&Ke.ref.value?(i.frontFace(o.CW),i.cullFace(o.FRONT)):(i.frontFace(o.CCW),i.cullFace(o.BACK)));oe.render(De,f.length)},V=(oe,De)=>{C.update(R.uView,oe.view),C.update(R.uInvView,W.invert(v,oe.view)),C.update(R.uProjection,oe.projection),C.update(R.uInvProjection,W.invert(T,oe.projection)),C.updateIfChanged(R.uIsOrtho,oe.state.mode==="orthographic"?1:0),C.update(R.uViewOffset,oe.viewOffset.enabled?ne.set(I,oe.viewOffset.offsetX*16,oe.viewOffset.offsetY*16):ne.set(I,0,0)),C.update(R.uCameraPosition,y.copy(P,oe.state.position)),C.update(R.uCameraDir,y.normalize(D,y.sub(D,oe.state.target,oe.state.position))),C.updateIfChanged(R.uFar,oe.far),C.updateIfChanged(R.uNear,oe.near),C.updateIfChanged(R.uFog,oe.state.fog>0),C.updateIfChanged(R.uFogFar,oe.fogFar),C.updateIfChanged(R.uFogNear,oe.fogNear),C.updateIfChanged(R.uTransparentBackground,m),up.fromProjectionMatrix(k,oe.projectionView),qn.copy(A,k[5]),A.constant-=qn.distanceToPoint(A,P),C.update(R.uCameraPlane,qn.toArray(A,R.uCameraPlane.ref.value,0)),C.updateIfChanged(R.uMarkerAverage,De.markerAverage)},H=(oe,De,Le,Qe,Ue)=>{Bx(f,"tDepth",Le||h),C.update(R.uModel,oe.view),C.update(R.uModelView,W.mul(x,De.view,oe.view)),C.update(R.uInvModelView,W.invert(S,x)),C.update(R.uModelViewProjection,W.mul(E,x,De.projection)),C.update(R.uInvModelViewProjection,W.invert(_,E)),C.updateIfChanged(R.uRenderMask,Qe),C.updateIfChanged(R.uMarkingDepthTest,Ue),i.enable(o.SCISSOR_TEST),i.colorMask(!0,!0,!0,!0);let{x:Ke,y:Ve,width:It,height:yt}=c;i.viewport(Ke,Ve,It,yt),i.scissor(Ke,Ve,It,yt),F=!0,i.currentRenderItemId=-1},Q=function(oe){var De,Le,Qe,Ue;let Ke=Wo(oe.values.alpha.ref.value*oe.state.alphaFactor,0,1),Ve=((De=oe.values.dXrayShaded)===null||De===void 0?void 0:De.ref.value)==="on"||((Le=oe.values.dXrayShaded)===null||Le===void 0?void 0:Le.ref.value)==="inverted";return Ke===1&&oe.values.transparencyAverage.ref.value!==1&&oe.values.dGeometryType.ref.value!=="directVolume"&&((Qe=oe.values.dPointStyle)===null||Qe===void 0?void 0:Qe.ref.value)!=="fuzzy"&&!Ve||((Ue=oe.values.dTransparentBackfaces)===null||Ue===void 0?void 0:Ue.ref.value)==="opaque"},L=function(oe){var De,Le,Qe;let Ue=Wo(oe.values.alpha.ref.value*oe.state.alphaFactor,0,1),Ke=((De=oe.values.dXrayShaded)===null||De===void 0?void 0:De.ref.value)==="on"||((Le=oe.values.dXrayShaded)===null||Le===void 0?void 0:Le.ref.value)==="inverted";return Ue<1&&Ue!==0||oe.values.transparencyAverage.ref.value>0||oe.values.dGeometryType.ref.value==="directVolume"||((Qe=oe.values.dPointStyle)===null||Qe===void 0?void 0:Qe.ref.value)==="fuzzy"||oe.values.dGeometryType.ref.value==="text"||oe.values.dGeometryType.ref.value==="image"||Ke},Y=(oe,De,Le,Qe,Ue)=>{Ee&&r.timer.mark("Renderer.renderPick"),i.disable(o.BLEND),i.enable(o.DEPTH_TEST),i.depthMask(!0),H(oe,De,Qe,0,!1),C.updateIfChanged(R.uPickType,Ue);let{renderables:Ke}=oe;for(let Ve=0,It=Ke.length;Ve<It;++Ve)Ke[Ve].state.colorOnly||G(Ke[Ve],Le,0);Ee&&r.timer.markEnd("Renderer.renderPick")},j=(oe,De,Le)=>{Ee&&r.timer.mark("Renderer.renderDepth"),i.disable(o.BLEND),i.enable(o.DEPTH_TEST),i.depthMask(!0),H(oe,De,Le,0,!1);let{renderables:Qe}=oe;for(let Ue=0,Ke=Qe.length;Ue<Ke;++Ue)G(Qe[Ue],"depth",0);Ee&&r.timer.markEnd("Renderer.renderDepth")},O=(oe,De,Le)=>{Ee&&r.timer.mark("Renderer.renderDepthOpaque"),i.disable(o.BLEND),i.enable(o.DEPTH_TEST),i.depthMask(!0),H(oe,De,Le,1,!1);let{renderables:Qe}=oe;for(let Ue=0,Ke=Qe.length;Ue<Ke;++Ue){let Ve=Qe[Ue];Q(Ve)&&G(Ve,"depth",0)}Ee&&r.timer.markEnd("Renderer.renderDepthOpaque")},J=(oe,De,Le)=>{Ee&&r.timer.mark("Renderer.renderDepthTransparent"),i.disable(o.BLEND),i.enable(o.DEPTH_TEST),i.depthMask(!0),H(oe,De,Le,2,!1);let{renderables:Qe}=oe;for(let Ue=0,Ke=Qe.length;Ue<Ke;++Ue){let Ve=Qe[Ue];L(Ve)&&G(Ve,"depth",0)}Ee&&r.timer.markEnd("Renderer.renderDepthTransparent")},$=(oe,De,Le)=>{Ee&&r.timer.mark("Renderer.renderMarkingDepth"),i.disable(o.BLEND),i.enable(o.DEPTH_TEST),i.depthMask(!0),H(oe,De,Le,0,!1),C.updateIfChanged(R.uMarkingType,Gw.Depth);let{renderables:Qe}=oe;for(let Ue=0,Ke=Qe.length;Ue<Ke;++Ue){let Ve=Qe[Ue];Wo(Ve.values.alpha.ref.value*Ve.state.alphaFactor,0,1)!==0&&Ve.values.transparencyAverage.ref.value!==1&&Ve.values.markerAverage.ref.value!==1&&G(Qe[Ue],"marking",0)}Ee&&r.timer.markEnd("Renderer.renderMarkingDepth")},ae=(oe,De,Le)=>{Ee&&r.timer.mark("Renderer.renderMarkingMask"),i.disable(o.BLEND),i.enable(o.DEPTH_TEST),i.depthMask(!0),H(oe,De,Le,0,!!Le),C.updateIfChanged(R.uMarkingType,Gw.Mask);let{renderables:Qe}=oe;for(let Ue=0,Ke=Qe.length;Ue<Ke;++Ue)Qe[Ue].values.markerAverage.ref.value>0&&G(Qe[Ue],"marking",0);Ee&&r.timer.markEnd("Renderer.renderMarkingMask")},Z=(oe,De,Le)=>{Ee&&r.timer.mark("Renderer.renderEmissive"),i.disable(o.BLEND),i.enable(o.DEPTH_TEST),i.depthMask(!0),H(oe,De,Le,1,!1);let{renderables:Qe}=oe;for(let Ue=0,Ke=Qe.length;Ue<Ke;++Ue){let Ve=Qe[Ue];Q(Ve)&&G(Ve,"emissive",0)}Ee&&r.timer.markEnd("Renderer.renderEmissive")},se=(oe,De)=>{oe.hasOpaque&&Me(oe,De,null),oe.opacityAverage<1&&be(oe,De,null)},Me=(oe,De,Le)=>{Ee&&r.timer.mark("Renderer.renderBlendedOpaque"),i.disable(o.BLEND),i.enable(o.DEPTH_TEST),i.depthMask(!0),H(oe,De,Le,1,!1);let{renderables:Qe}=oe;for(let Ue=0,Ke=Qe.length;Ue<Ke;++Ue){let Ve=Qe[Ue];Q(Ve)&&G(Ve,"color",0)}Ee&&r.timer.markEnd("Renderer.renderBlendedOpaque")},be=(oe,De,Le)=>{var Qe,Ue;Ee&&r.timer.mark("Renderer.renderBlendedTransparent"),m?i.blendFunc(o.ONE,o.ONE_MINUS_SRC_ALPHA):i.blendFuncSeparate(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA,o.ONE,o.ONE_MINUS_SRC_ALPHA),i.enable(o.BLEND),i.enable(o.DEPTH_TEST),i.depthMask(!1),H(oe,De,Le,2,!1);let{renderables:Ke}=oe;for(let Ve=0,It=Ke.length;Ve<It;++Ve){let yt=Ke[Ve];L(yt)&&(!((Qe=yt.values.uDoubleSided)===null||Qe===void 0)&&Qe.ref.value?(((Ue=yt.values.dTransparentBackfaces)===null||Ue===void 0?void 0:Ue.ref.value)!=="opaque"&&G(yt,"color",2),G(yt,"color",1)):G(yt,"color",0))}Ee&&r.timer.markEnd("Renderer.renderBlendedTransparent")};return{clear:(oe,De)=>{i.enable(o.SCISSOR_TEST),i.enable(o.DEPTH_TEST),i.colorMask(!0,!0,!0,!0),i.depthMask(!0),m&&!De?i.clearColor(0,0,0,0):oe?i.clearColor(d[0],d[1],d[2],1):i.clearColor(1,1,1,1),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT)},clearDepth:(oe=!1)=>{i.enable(o.SCISSOR_TEST),oe?(i.colorMask(!0,!0,!0,!0),i.clearColor(1,1,1,1),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT)):(i.enable(o.DEPTH_TEST),i.depthMask(!0),o.clear(o.DEPTH_BUFFER_BIT))},update:V,renderPick:Y,renderDepth:j,renderDepthOpaque:O,renderDepthTransparent:J,renderMarkingDepth:$,renderMarkingMask:ae,renderEmissive:Z,renderBlended:se,renderBlendedOpaque:Me,renderBlendedTransparent:be,renderBlendedVolume:(oe,De,Le)=>{Ee&&r.timer.mark("Renderer.renderBlendedVolume"),i.blendFunc(o.ONE,o.ONE_MINUS_SRC_ALPHA),i.enable(o.BLEND),i.depthMask(!1),H(oe,De,Le,2,!1);let{renderables:Qe}=oe;for(let Ue=0,Ke=Qe.length;Ue<Ke;++Ue){let Ve=Qe[Ue];Ve.values.dGeometryType.ref.value==="directVolume"&&G(Ve,"color",3)}Ee&&r.timer.markEnd("Renderer.renderBlendedVolume")},renderWboitOpaque:(oe,De,Le)=>{Ee&&r.timer.mark("Renderer.renderWboitOpaque"),i.disable(o.BLEND),i.enable(o.DEPTH_TEST),i.depthMask(!0),H(oe,De,Le,1,!1);let{renderables:Qe}=oe;for(let Ue=0,Ke=Qe.length;Ue<Ke;++Ue){let Ve=Qe[Ue];Q(Ve)&&G(Ve,"color",0)}Ee&&r.timer.markEnd("Renderer.renderWboitOpaque")},renderWboitTransparent:(oe,De,Le)=>{Ee&&r.timer.mark("Renderer.renderWboitTransparent"),H(oe,De,Le,2,!1);let{renderables:Qe}=oe;for(let Ue=0,Ke=Qe.length;Ue<Ke;++Ue){let Ve=Qe[Ue];L(Ve)&&G(Ve,"color",0)}Ee&&r.timer.markEnd("Renderer.renderWboitTransparent")},renderDpoitOpaque:(oe,De,Le)=>{Ee&&r.timer.mark("Renderer.renderDpoitOpaque"),i.disable(o.BLEND),i.enable(o.DEPTH_TEST),i.depthMask(!0),H(oe,De,Le,1,!1);let{renderables:Qe}=oe;for(let Ue=0,Ke=Qe.length;Ue<Ke;++Ue){let Ve=Qe[Ue];Q(Ve)&&G(Ve,"color",0)}Ee&&r.timer.markEnd("Renderer.renderDpoitOpaque")},renderDpoitTransparent:(oe,De,Le,Qe)=>{Ee&&r.timer.mark("Renderer.renderDpoitTransparent"),i.enable(o.BLEND),Bx(f,"tDpoitDepth",Qe.depth),Bx(f,"tDpoitFrontColor",Qe.frontColor),Bx(f,"tDpoitBackColor",Qe.backColor),H(oe,De,Le,2,!1);let{renderables:Ue}=oe;for(let Ke=0,Ve=Ue.length;Ke<Ve;++Ke){let It=Ue[Ke];L(It)&&G(It,"color",0)}Ee&&r.timer.markEnd("Renderer.renderDpoitTransparent")},renderDpoitVolume:(oe,De,Le)=>{Ee&&r.timer.mark("Renderer.renderDpoitVolume"),i.blendFunc(o.ONE,o.ONE_MINUS_SRC_ALPHA),i.enable(o.BLEND),H(oe,De,Le,2,!1);let{renderables:Qe}=oe;for(let Ue=0,Ke=Qe.length;Ue<Ke;++Ue){let Ve=Qe[Ue];Ve.values.dGeometryType.ref.value==="directVolume"&&G(Ve,"color",0)}Ee&&r.timer.markEnd("Renderer.renderDpoitVolume")},setProps:oe=>{oe.backgroundColor!==void 0&&oe.backgroundColor!==s.backgroundColor&&(s.backgroundColor=oe.backgroundColor,ce.toVec3Normalized(d,s.backgroundColor),C.update(R.uFogColor,y.copy(R.uFogColor.ref.value,d))),oe.pickingAlphaThreshold!==void 0&&oe.pickingAlphaThreshold!==s.pickingAlphaThreshold&&(s.pickingAlphaThreshold=oe.pickingAlphaThreshold,C.update(R.uPickingAlphaThreshold,s.pickingAlphaThreshold)),oe.interiorDarkening!==void 0&&oe.interiorDarkening!==s.interiorDarkening&&(s.interiorDarkening=oe.interiorDarkening,C.update(R.uInteriorDarkening,s.interiorDarkening)),oe.interiorColorFlag!==void 0&&oe.interiorColorFlag!==s.interiorColorFlag&&(s.interiorColorFlag=oe.interiorColorFlag,C.update(R.uInteriorColorFlag,s.interiorColorFlag)),oe.interiorColor!==void 0&&oe.interiorColor!==s.interiorColor&&(s.interiorColor=oe.interiorColor,C.update(R.uInteriorColor,ce.toVec3Normalized(R.uInteriorColor.ref.value,s.interiorColor))),oe.colorMarker!==void 0&&oe.colorMarker!==s.colorMarker&&(s.colorMarker=oe.colorMarker),oe.highlightColor!==void 0&&oe.highlightColor!==s.highlightColor&&(s.highlightColor=oe.highlightColor,C.update(R.uHighlightColor,ce.toVec3Normalized(R.uHighlightColor.ref.value,s.highlightColor))),oe.selectColor!==void 0&&oe.selectColor!==s.selectColor&&(s.selectColor=oe.selectColor,C.update(R.uSelectColor,ce.toVec3Normalized(R.uSelectColor.ref.value,s.selectColor))),oe.dimColor!==void 0&&oe.dimColor!==s.dimColor&&(s.dimColor=oe.dimColor,C.update(R.uDimColor,ce.toVec3Normalized(R.uDimColor.ref.value,s.dimColor))),oe.highlightStrength!==void 0&&oe.highlightStrength!==s.highlightStrength&&(s.highlightStrength=oe.highlightStrength,C.update(R.uHighlightStrength,s.highlightStrength)),oe.selectStrength!==void 0&&oe.selectStrength!==s.selectStrength&&(s.selectStrength=oe.selectStrength,C.update(R.uSelectStrength,s.selectStrength)),oe.dimStrength!==void 0&&oe.dimStrength!==s.dimStrength&&(s.dimStrength=oe.dimStrength,C.update(R.uDimStrength,s.dimStrength)),oe.markerPriority!==void 0&&oe.markerPriority!==s.markerPriority&&(s.markerPriority=oe.markerPriority,C.update(R.uMarkerPriority,s.markerPriority)),oe.xrayEdgeFalloff!==void 0&&oe.xrayEdgeFalloff!==s.xrayEdgeFalloff&&(s.xrayEdgeFalloff=oe.xrayEdgeFalloff,C.update(R.uXrayEdgeFalloff,s.xrayEdgeFalloff)),oe.exposure!==void 0&&oe.exposure!==s.exposure&&(s.exposure=oe.exposure,C.update(R.uExposure,s.exposure)),oe.light!==void 0&&!ys(oe.light,s.light)&&(s.light=oe.light,Object.assign(l,PQ(oe.light,l)),C.update(R.uLightDirection,l.direction),C.update(R.uLightColor,l.color)),oe.ambientColor!==void 0&&oe.ambientColor!==s.ambientColor&&(s.ambientColor=oe.ambientColor,y.scale(M,ce.toArrayNormalized(s.ambientColor,M,0),s.ambientIntensity),C.update(R.uAmbientColor,M)),oe.ambientIntensity!==void 0&&oe.ambientIntensity!==s.ambientIntensity&&(s.ambientIntensity=oe.ambientIntensity,y.scale(M,ce.toArrayNormalized(s.ambientColor,M,0),s.ambientIntensity),C.update(R.uAmbientColor,M))},setViewport:(oe,De,Le,Qe)=>{i.viewport(oe,De,Le,Qe),i.scissor(oe,De,Le,Qe),(oe!==c.x||De!==c.y||Le!==c.width||Qe!==c.height)&&(_n.set(c,oe,De,Le,Qe),C.update(R.uViewport,at.set(R.uViewport.ref.value,oe,De,Le,Qe)))},setTransparentBackground:oe=>{m=oe},setDrawingBufferSize:(oe,De)=>{(oe!==u[0]||De!==u[1])&&C.update(R.uDrawingBufferSize,ne.set(u,oe,De))},setPixelRatio:oe=>{C.update(R.uPixelRatio,oe)},setOcclusionTest:oe=>{p=oe},props:s,get stats(){return{programCount:r.stats.resourceCounts.program,shaderCount:r.stats.resourceCounts.shader,attributeCount:r.stats.resourceCounts.attribute,elementsCount:r.stats.resourceCounts.elements,framebufferCount:r.stats.resourceCounts.framebuffer,renderbufferCount:r.stats.resourceCounts.renderbuffer,textureCount:r.stats.resourceCounts.texture,vertexArrayCount:r.stats.resourceCounts.vertexArray,drawCount:a.drawCount,instanceCount:a.instanceCount,instancedDrawCount:a.instancedDrawCount}},get light(){return l},dispose:()=>{}}}t.create=e})(Hw||(Hw={}));function Xe(t,e="",r=""){return Xe.create(t,e,r)}(function(t){function e(u,d="",m=""){return{triggers:u,action:d,description:m}}t.create=e;function r(u){return!!u&&Array.isArray(u.triggers)&&typeof u.action=="string"}t.isBinding=r,t.Empty={triggers:[],action:"",description:""};function n(u){return u.triggers.length===0||u.triggers.every(d=>d.buttons===void 0&&d.modifiers===void 0&&!d.code)}t.isEmpty=n;function o(u,d,m){return u.triggers.some(p=>l.match(p,d,m))}t.match=o;function i(u,d,m,p){return u.triggers.some(h=>l.matchKey(h,d,m,p))}t.matchKey=i;function a(u){return u.triggers.map(l.format).join(" or ")}t.formatTriggers=a;function s(u,d=""){let m=u.description||ic(d);return Cz(m,{triggers:"<i>"+a(u)+"</i>"})}t.format=s;function l(u,d){return l.create(u,d)}t.Trigger=l;function c(u,d){return l.create(void 0,d,u)}t.TriggerKey=c,function(u){function d(f,b,v){return{buttons:f,modifiers:b,code:v}}u.create=d,u.Empty={};function m(f,b,v){let{buttons:x,modifiers:S}=f;return x!==void 0&&(x===b||yn.has(x,b))&&(!S||na.areEqual(S,v))}u.match=m;function p(f,b,v,x){let{modifiers:S,code:T}=f;return T!==void 0&&(T===b||T.length===1&&b.length===4&&b.startsWith("Key")&&!!x&&x.length===1&&x.toUpperCase()===T.toUpperCase())&&(!S||na.areEqual(S,v))}u.matchKey=p;function h(f){let b=[],v=jSe(f.buttons,f.code);v&&b.push(v);let x=qSe(f.code);x&&b.push(x);let S=HSe(f.modifiers);return S&&b.push(S),b.join(" + ")}u.format=h}(l=t.Trigger||(t.Trigger={}))})(Xe||(Xe={}));var sh=yn;function jSe(t,e){let r=[];return t===void 0&&!e?r.push("any mouse button"):t===0?r.push("mouse hover"):t!==void 0&&(sh.has(t,sh.Flag.Primary)&&r.push("left mouse button"),sh.has(t,sh.Flag.Secondary)&&r.push("right mouse button"),sh.has(t,sh.Flag.Auxilary)&&r.push("wheel/middle mouse button"),sh.has(t,sh.Flag.Forth)&&r.push("three fingers")),r.join(" + ")}function HSe(t,e){let r=[];return t?(t.alt&&r.push("alt key"),t.control&&r.push("control key"),t.meta&&r.push("meta/command key"),t.shift&&r.push("shift key"),e&&r.length===0&&r.push("no key")):e&&r.push("any key"),r.join(" + ")}function qSe(t){return t?.startsWith("Key")&&(t=t.substring(3)),t&&Di(t).toLowerCase()}var lh=yn,Tc=na,ch=Xe.Trigger,Vl=Xe.TriggerKey,EQ={dragRotate:Xe([ch(lh.Flag.Primary,Tc.create())],"Rotate","Drag using ${triggers}"),dragRotateZ:Xe([ch(lh.Flag.Primary,Tc.create({shift:!0,control:!0}))],"Rotate around z-axis (roll)","Drag using ${triggers}"),dragPan:Xe([ch(lh.Flag.Secondary,Tc.create()),ch(lh.Flag.Primary,Tc.create({control:!0}))],"Pan","Drag using ${triggers}"),dragZoom:Xe.Empty,dragFocus:Xe([ch(lh.Flag.Forth,Tc.create())],"Focus","Drag using ${triggers}"),dragFocusZoom:Xe([ch(lh.Flag.Auxilary,Tc.create())],"Focus and zoom","Drag using ${triggers}"),scrollZoom:Xe([ch(lh.Flag.Auxilary,Tc.create())],"Zoom","Scroll using ${triggers}"),scrollFocus:Xe([ch(lh.Flag.Auxilary,Tc.create({shift:!0}))],"Clip","Scroll using ${triggers}"),scrollFocusZoom:Xe.Empty,keyMoveForward:Xe([Vl("KeyW")],"Move forward","Press ${triggers}"),keyMoveBack:Xe([Vl("KeyS")],"Move back","Press ${triggers}"),keyMoveLeft:Xe([Vl("KeyA")],"Move left","Press ${triggers}"),keyMoveRight:Xe([Vl("KeyD")],"Move right","Press ${triggers}"),keyMoveUp:Xe([Vl("KeyR")],"Move up","Press ${triggers}"),keyMoveDown:Xe([Vl("KeyF")],"Move down","Press ${triggers}"),keyRollLeft:Xe([Vl("KeyQ")],"Roll left","Press ${triggers}"),keyRollRight:Xe([Vl("KeyE")],"Roll right","Press ${triggers}"),keyPitchUp:Xe([Vl("ArrowUp",Tc.create({shift:!0}))],"Pitch up","Press ${triggers}"),keyPitchDown:Xe([Vl("ArrowDown",Tc.create({shift:!0}))],"Pitch down","Press ${triggers}"),keyYawLeft:Xe([Vl("ArrowLeft",Tc.create({shift:!0}))],"Yaw left","Press ${triggers}"),keyYawRight:Xe([Vl("ArrowRight",Tc.create({shift:!0}))],"Yaw right","Press ${triggers}"),boostMove:Xe([Vl("ShiftLeft")],"Boost move","Press ${triggers}"),enablePointerLock:Xe([Vl("Space",Tc.create({control:!0}))],"Enable pointer lock","Press ${triggers}")},YR={noScroll:g.Boolean(!0,{isHidden:!0}),rotateSpeed:g.Numeric(5,{min:1,max:10,step:1}),zoomSpeed:g.Numeric(7,{min:1,max:15,step:1}),panSpeed:g.Numeric(1,{min:.1,max:5,step:.1}),moveSpeed:g.Numeric(.75,{min:.1,max:3,step:.1}),boostMoveFactor:g.Numeric(5,{min:.1,max:10,step:.1}),flyMode:g.Boolean(!1),animate:g.MappedStatic("off",{off:g.EmptyGroup(),spin:g.Group({speed:g.Numeric(1,{min:-20,max:20,step:1})},{description:"Spin the 3D scene around the x-axis in view space"}),rock:g.Group({speed:g.Numeric(.3,{min:-5,max:5,step:.1}),angle:g.Numeric(10,{min:0,max:90,step:1},{description:"How many degrees to rotate in each direction."})},{description:"Rock the 3D scene around the x-axis in view space"})}),staticMoving:g.Boolean(!0,{isHidden:!0}),dynamicDampingFactor:g.Numeric(.2,{},{isHidden:!0}),minDistance:g.Numeric(.01,{},{isHidden:!0}),maxDistance:g.Numeric(1e150,{},{isHidden:!0}),gestureScaleFactor:g.Numeric(1,{},{isHidden:!0}),maxWheelDelta:g.Numeric(.02,{},{isHidden:!0}),bindings:g.Value(EQ,{isHidden:!0}),autoAdjustMinMaxDistance:g.MappedStatic("on",{off:g.EmptyGroup(),on:g.Group({minDistanceFactor:g.Numeric(0),minDistancePadding:g.Numeric(5),maxDistanceFactor:g.Numeric(10),maxDistanceMin:g.Numeric(20)})},{isHidden:!0})};var qw;(function(t){function e(r,n,o,i={}){let a=U(w(w({},g.getDefaultValues(YR)),i),{bindings:w(w({},EQ),i.bindings)}),s=a.bindings,l=_n.clone(n.viewport),c=!1,u=r.drag.subscribe(Sl),d=r.interactionEnd.subscribe(He),m=r.wheel.subscribe(_t),p=r.pinch.subscribe(Gt),h=r.gesture.subscribe(Xt),f=r.keyDown.subscribe(ho),b=r.keyUp.subscribe(mt),v=r.move.subscribe(Vr),x=r.lock.subscribe(go),S=r.leave.subscribe(nd),T=!1,E=y(),_=y(),D=ne(),P=ne(),A=y(),I=0,k=ne(),M=ne(),R=0,B=0,F=0,G=ne(),V=ne(),H=ne(),Q=ne(),L=ne(),Y=ne(),j=y.clone(n.target),O=y.clone(n.position),J=y.clone(n.up),$=ne();function ae(ke,ot){return ne.set($,(ke-l.x)/l.width,(ot-l.y)/l.height)}let Z=ne();function se(ke,ot){return ne.set(Z,(ke-l.width*.5-l.x)/(l.width*.5),(l.height+2*(l.y-ot))/l.width)}function Me(){let ke=r.width/r.height||1;return a.rotateSpeed*r.pixelRatio*ke}let be=y(),_e=xn(),je=y(),gt=y(),fr=y(),Nr=y();function Zt(){let ke=P[0]-D[0],ot=P[1]-D[1];y.set(Nr,ke,ot,0);let Tt=y.magnitude(Nr)*Me();Tt?(y.sub(_,n.position,n.target),y.normalize(je,_),y.normalize(gt,n.up),y.normalize(fr,y.cross(fr,gt,je)),y.setMagnitude(gt,gt,ot),y.setMagnitude(fr,fr,ke),y.add(Nr,gt,fr),y.normalize(be,y.cross(be,Nr,_)),xn.setAxisAngle(_e,be,Tt),y.transformQuat(_,_,_e),y.transformQuat(n.up,n.up,_e),y.copy(A,be),I=Tt):!a.staticMoving&&I&&(I*=Math.sqrt(1-a.dynamicDampingFactor),y.sub(_,n.position,n.target),xn.setAxisAngle(_e,A,I),y.transformQuat(_,_,_e),y.transformQuat(n.up,n.up,_e)),ne.copy(D,P)}let oe=xn(),De=y();function Le(){let ke=(Ze.rollRight-Ze.rollLeft)/45,ot=(M[0]-k[0])*-Math.sign(M[1]),Tt=(M[1]-k[1])*-Math.sign(M[0]),sn=-a.rotateSpeed*(-ot+Tt)+ke;sn?(y.normalize(De,_),xn.setAxisAngle(oe,De,sn),y.transformQuat(n.up,n.up,oe),R=sn):!a.staticMoving&&R&&(R*=Math.sqrt(1-a.dynamicDampingFactor),y.normalize(De,_),xn.setAxisAngle(oe,De,R),y.transformQuat(n.up,n.up,oe)),ne.copy(k,M)}let Qe=xn(),Ue=y();function Ke(){let ke=(Ze.pitchUp-Ze.pitchDown)/(a.flyMode?360:90),ot=-a.rotateSpeed*ke;ot?(y.cross(Ue,_,n.up),y.normalize(Ue,Ue),xn.setAxisAngle(Qe,Ue,ot),y.transformQuat(_,_,Qe),y.transformQuat(n.up,n.up,Qe),B=ot):!a.staticMoving&&B&&(B*=Math.sqrt(1-a.dynamicDampingFactor),y.cross(Ue,_,n.up),y.normalize(Ue,Ue),xn.setAxisAngle(Qe,Ue,B),y.transformQuat(_,_,Qe),y.transformQuat(n.up,n.up,Qe))}let Ve=xn(),It=y();function yt(){let ke=(Ze.yawRight-Ze.yawLeft)/(a.flyMode?360:90),ot=-a.rotateSpeed*ke;ot?(y.normalize(It,n.up),xn.setAxisAngle(Ve,It,ot),y.transformQuat(_,_,Ve),y.transformQuat(n.up,n.up,Ve),F=ot):!a.staticMoving&&F&&(F*=Math.sqrt(1-a.dynamicDampingFactor),y.normalize(It,n.up),xn.setAxisAngle(Ve,It,F),y.transformQuat(_,_,Ve),y.transformQuat(n.up,n.up,Ve))}function pe(){let ke=1+(V[1]-G[1])*a.zoomSpeed;ke!==1&&ke>0&&y.scale(_,_,ke),a.staticMoving?ne.copy(G,V):G[1]+=(V[1]-G[1])*a.dynamicDampingFactor}function Ae(){let ke=(Q[1]-H[1])*a.zoomSpeed;if(ke!==0){let ot=Math.max(1,n.state.radius+n.state.radius*ke);n.setState({radius:ot})}a.staticMoving?ne.copy(H,Q):H[1]+=(Q[1]-H[1])*a.dynamicDampingFactor}let $e=ne(),ft=y(),Pt=y();function yr(){if(ne.sub($e,ne.copy($e,Y),L),ne.squaredMagnitude($e)){let ke=r.pixelRatio*a.panSpeed;$e[0]*=1/n.zoom*n.viewport.width*ke,$e[1]*=1/n.zoom*n.viewport.height*ke,y.cross(Pt,y.copy(Pt,_),n.up),y.setMagnitude(Pt,Pt,$e[0]),y.setMagnitude(ft,n.up,$e[1]),y.add(Pt,Pt,ft),y.add(n.position,n.position,Pt),y.add(n.target,n.target,Pt),a.staticMoving?ne.copy(L,Y):(ne.sub($e,Y,L),ne.scale($e,$e,a.dynamicDampingFactor),ne.add(L,L,$e))}}let Ze={moveUp:0,moveDown:0,moveLeft:0,moveRight:0,moveForward:0,moveBack:0,pitchUp:0,pitchDown:0,yawLeft:0,yawRight:0,rollLeft:0,rollRight:0,boostMove:0},_r=y(),qr=y();function Ao(ke){y.sub(qr,n.position,n.target);let ot=Math.max(n.state.minNear,a.minDistance);y.setMagnitude(qr,qr,ot);let Tt=ke*(60/1e3)*a.moveSpeed*(Ze.boostMove===1?a.boostMoveFactor:1);if(Ze.moveForward===1&&(y.normalize(_r,qr),y.scaleAndSub(n.position,n.position,_r,Tt),(a.flyMode||r.pointerLock)&&y.sub(n.target,n.position,qr)),Ze.moveBack===1&&(y.normalize(_r,qr),y.scaleAndAdd(n.position,n.position,_r,Tt),(a.flyMode||r.pointerLock)&&y.sub(n.target,n.position,qr)),Ze.moveLeft===1&&(y.cross(_r,qr,n.up),y.normalize(_r,_r),a.flyMode||r.pointerLock?(y.scaleAndAdd(n.position,n.position,_r,Tt),y.sub(n.target,n.position,qr)):(y.scaleAndSub(n.position,n.position,_r,Tt),y.sub(n.target,n.position,_))),Ze.moveRight===1&&(y.cross(_r,qr,n.up),y.normalize(_r,_r),a.flyMode||r.pointerLock?(y.scaleAndSub(n.position,n.position,_r,Tt),y.sub(n.target,n.position,qr)):(y.scaleAndAdd(n.position,n.position,_r,Tt),y.sub(n.target,n.position,_))),Ze.moveUp===1&&(y.normalize(_r,n.up),a.flyMode||r.pointerLock?(y.scaleAndAdd(n.position,n.position,_r,Tt),y.sub(n.target,n.position,qr)):(y.scaleAndSub(n.position,n.position,_r,Tt),y.sub(n.target,n.position,_))),Ze.moveDown===1&&(y.normalize(_r,n.up),a.flyMode||r.pointerLock?(y.scaleAndSub(n.position,n.position,_r,Tt),y.sub(n.target,n.position,qr)):(y.scaleAndAdd(n.position,n.position,_r,Tt),y.sub(n.target,n.position,_))),a.flyMode||r.pointerLock){let sn=y.distance(n.position,o.boundingSphereVisible.center);n.setState({minFar:sn+o.boundingSphereVisible.radius})}}function Bn(){let ke=Math.min(Math.max(n.state.radiusMax*1e3,.01),a.maxDistance);y.squaredMagnitude(_)>ke*ke&&(y.setMagnitude(_,_,ke),y.add(n.position,n.target,_),ne.copy(G,V),ne.copy(H,Q)),y.squaredMagnitude(_)<a.minDistance*a.minDistance&&(y.setMagnitude(_,_,a.minDistance),y.add(n.position,n.target,_),ne.copy(G,V),ne.copy(H,Q))}function co(ke,ot){return ke*=r.pixelRatio,ot*=r.pixelRatio,ke>l.x+l.width||r.height-ot>l.y+l.height||ke<l.x||r.height-ot<l.y}let bn=-1;function Ii(ke){if(bn===ke)return;let ot=ke-bn;bn>0&&(a.animate.name==="spin"?oc(ot):a.animate.name==="rock"&&ef(ot)),y.sub(_,n.position,n.target),Zt(),Le(),Ke(),yt(),pe(),Ae(),yr(),y.add(n.position,n.target,_),Bn(),bn>0&&Ao(Math.min(ot,15*1e3/60)),y.sub(_,n.position,n.target),Bn(),y.squaredDistance(E,n.position)>1e-6&&y.copy(E,n.position),bn=ke}function Ys(){y.copy(n.target,j),y.copy(n.position,O),y.copy(n.up,J),y.sub(_,n.position,n.target),y.copy(E,n.position)}function Sl({x:ke,y:ot,pageX:Tt,pageY:sn,buttons:ca,modifiers:fs,isStart:Qs}){let Ks=co(ke,ot);if(Qs&&Ks||!Qs&&!T)return;T=!0,me();let tf=Xe.match(s.dragRotate,ca,fs),rf=Xe.match(s.dragRotateZ,ca,fs),i0=Xe.match(s.dragPan,ca,fs),a0=Xe.match(s.dragZoom,ca,fs),s0=Xe.match(s.dragFocus,ca,fs),bg=Xe.match(s.dragFocusZoom,ca,fs);se(Tt,sn),ae(Tt,sn);let l0=r.pixelRatio,c0=(ke*l0-l.width/2-l.x)/l.width,u0=-(r.height-ot*l0-l.height/2-l.y)/l.height;if(Qs&&(tf&&(ne.copy(P,Z),ne.copy(D,P)),rf&&(ne.set(M,c0,u0),ne.copy(k,M)),(a0||bg)&&(ne.copy(G,$),ne.copy(V,G)),s0&&(ne.copy(H,$),ne.copy(Q,H)),i0&&(ne.copy(L,$),ne.copy(Y,L))),tf&&ne.copy(P,Z),rf&&ne.set(M,c0,u0),(a0||bg)&&ne.copy(V,$),s0&&ne.copy(Q,$),bg){let xg=y.distance(n.state.position,n.state.target);n.setState({radius:xg/5})}i0&&ne.copy(Y,$)}function He(){T=!1}function _t({x:ke,y:ot,spinX:Tt,spinY:sn,dz:ca,buttons:fs,modifiers:Qs}){if(co(ke,ot))return;let Ks=vz(Tt*.075,sn*.075,ca*1e-4);Ks<-a.maxWheelDelta?Ks=-a.maxWheelDelta:Ks>a.maxWheelDelta&&(Ks=a.maxWheelDelta),Xe.match(s.scrollZoom,fs,Qs)&&(V[1]+=Ks),Xe.match(s.scrollFocus,fs,Qs)&&(Q[1]+=Ks)}function Gt({fractionDelta:ke,buttons:ot,modifiers:Tt}){Xe.match(s.scrollZoom,ot,Tt)&&(T=!0,V[1]+=a.gestureScaleFactor*ke)}function Xt({deltaScale:ke}){T=!0,V[1]+=a.gestureScaleFactor*ke}function Vr({movementX:ke,movementY:ot}){if(!r.pointerLock||ke===void 0||ot===void 0)return;let Tt=l.width*.5-l.x,sn=l.height*.5-l.y;ne.copy(D,se(Tt,sn)),ne.copy(P,se(ke+Tt,ot+sn))}function ho({modifiers:ke,code:ot,key:Tt,x:sn,y:ca}){co(sn,ca)||(Xe.matchKey(s.keyMoveForward,ot,ke,Tt)?Ze.moveForward=1:Xe.matchKey(s.keyMoveBack,ot,ke,Tt)?Ze.moveBack=1:Xe.matchKey(s.keyMoveLeft,ot,ke,Tt)?Ze.moveLeft=1:Xe.matchKey(s.keyMoveRight,ot,ke,Tt)?Ze.moveRight=1:Xe.matchKey(s.keyMoveUp,ot,ke,Tt)?Ze.moveUp=1:Xe.matchKey(s.keyMoveDown,ot,ke,Tt)?Ze.moveDown=1:Xe.matchKey(s.keyRollLeft,ot,ke,Tt)?Ze.rollLeft=1:Xe.matchKey(s.keyRollRight,ot,ke,Tt)?Ze.rollRight=1:Xe.matchKey(s.keyPitchUp,ot,ke,Tt)?Ze.pitchUp=1:Xe.matchKey(s.keyPitchDown,ot,ke,Tt)?Ze.pitchDown=1:Xe.matchKey(s.keyYawLeft,ot,ke,Tt)?Ze.yawLeft=1:Xe.matchKey(s.keyYawRight,ot,ke,Tt)&&(Ze.yawRight=1),Xe.matchKey(s.boostMove,ot,ke,Tt)&&(Ze.boostMove=1),Xe.matchKey(s.enablePointerLock,ot,ke,Tt)&&r.requestPointerLock(l))}function mt({modifiers:ke,code:ot,key:Tt,x:sn,y:ca}){var fs,Qs,Ks,tf,rf,i0,a0,s0,bg,l0,c0,u0;if(co(sn,ca))return;let xg=!1;ot.startsWith("Alt")?(xg=!0,ke.alt=!0):ot.startsWith("Shift")?(xg=!0,ke.shift=!0):ot.startsWith("Control")?(xg=!0,ke.control=!0):ot.startsWith("Meta")&&(xg=!0,ke.meta=!0);let Cl=[];xg?(Ze.moveForward&&Cl.push(((fs=s.keyMoveForward.triggers[0])===null||fs===void 0?void 0:fs.code)||""),Ze.moveBack&&Cl.push(((Qs=s.keyMoveBack.triggers[0])===null||Qs===void 0?void 0:Qs.code)||""),Ze.moveLeft&&Cl.push(((Ks=s.keyMoveLeft.triggers[0])===null||Ks===void 0?void 0:Ks.code)||""),Ze.moveRight&&Cl.push(((tf=s.keyMoveRight.triggers[0])===null||tf===void 0?void 0:tf.code)||""),Ze.moveUp&&Cl.push(((rf=s.keyMoveUp.triggers[0])===null||rf===void 0?void 0:rf.code)||""),Ze.moveDown&&Cl.push(((i0=s.keyMoveDown.triggers[0])===null||i0===void 0?void 0:i0.code)||""),Ze.rollLeft&&Cl.push(((a0=s.keyRollLeft.triggers[0])===null||a0===void 0?void 0:a0.code)||""),Ze.rollRight&&Cl.push(((s0=s.keyRollRight.triggers[0])===null||s0===void 0?void 0:s0.code)||""),Ze.pitchUp&&Cl.push(((bg=s.keyPitchUp.triggers[0])===null||bg===void 0?void 0:bg.code)||""),Ze.pitchDown&&Cl.push(((l0=s.keyPitchDown.triggers[0])===null||l0===void 0?void 0:l0.code)||""),Ze.yawLeft&&Cl.push(((c0=s.keyYawLeft.triggers[0])===null||c0===void 0?void 0:c0.code)||""),Ze.yawRight&&Cl.push(((u0=s.keyYawRight.triggers[0])===null||u0===void 0?void 0:u0.code)||"")):Cl.push(ot);for(let jc of Cl)Xe.matchKey(s.keyMoveForward,jc,ke,Tt)?Ze.moveForward=0:Xe.matchKey(s.keyMoveBack,jc,ke,Tt)?Ze.moveBack=0:Xe.matchKey(s.keyMoveLeft,jc,ke,Tt)?Ze.moveLeft=0:Xe.matchKey(s.keyMoveRight,jc,ke,Tt)?Ze.moveRight=0:Xe.matchKey(s.keyMoveUp,jc,ke,Tt)?Ze.moveUp=0:Xe.matchKey(s.keyMoveDown,jc,ke,Tt)?Ze.moveDown=0:Xe.matchKey(s.keyRollLeft,jc,ke,Tt)?Ze.rollLeft=0:Xe.matchKey(s.keyRollRight,jc,ke,Tt)?Ze.rollRight=0:Xe.matchKey(s.keyPitchUp,jc,ke,Tt)?Ze.pitchUp=0:Xe.matchKey(s.keyPitchDown,jc,ke,Tt)?Ze.pitchDown=0:Xe.matchKey(s.keyYawLeft,jc,ke,Tt)?Ze.yawLeft=0:Xe.matchKey(s.keyYawRight,jc,ke,Tt)&&(Ze.yawRight=0);Xe.matchKey(s.boostMove,ot,ke,Tt)&&(Ze.boostMove=0)}function On(){y.sub(qr,n.position,n.target);let ke=Math.max(n.state.minNear,a.minDistance);y.setMagnitude(qr,qr,ke),y.sub(n.target,n.position,qr);let ot=y.distance(n.position,o.boundingSphereVisible.center);n.setState({minFar:ot+o.boundingSphereVisible.radius})}function $a(){let{center:ke,radius:ot}=o.boundingSphereVisible;if(y.distance(n.position,ke)>ot){let sn=n.getFocus(ke,ot);n.setState(U(w({},sn),{minFar:0}))}else n.setState({minFar:0,radius:o.boundingSphereVisible.radius})}function go(ke){ke?On():$a()}function Gc(){Ze.moveForward=0,Ze.moveBack=0,Ze.moveLeft=0,Ze.moveRight=0,Ze.moveUp=0,Ze.moveDown=0,Ze.rollLeft=0,Ze.rollRight=0,Ze.pitchUp=0,Ze.pitchDown=0,Ze.yawLeft=0,Ze.yawRight=0,Ze.boostMove=0}function nd(){Gc()}function od(){c||(c=!0,u.unsubscribe(),m.unsubscribe(),p.unsubscribe(),h.unsubscribe(),d.unsubscribe(),f.unsubscribe(),b.unsubscribe(),v.unsubscribe(),x.unsubscribe(),S.unsubscribe())}let id=ne.create(.005,0);function oc(ke){if(a.animate.name!=="spin"||a.animate.params.speed===0||T)return;let ot=a.animate.params.speed/1e3;id[0]=60*Math.min(Math.abs(ke),1e3/8)/1e3*ot,ne.add(P,D,id)}let ea=0,vg=ne.create(.005,0);function ef(ke){if(a.animate.name!=="rock"||a.animate.params.speed===0||T)return;let ot=ke/1e3*a.animate.params.speed,Tt=or(a.animate.params.angle)/Me(),sn=Math.sin(ea*Math.PI*2)*Tt,ca=Math.sin((ea+ot)*Math.PI*2)*Tt;vg[0]=ca-sn,ne.add(P,D,vg),ea+=ot,ea>=1&&(ea=0)}function me(){ea=0}function Ft(ke){bn=-1,Ii(ke)}return{viewport:l,get isAnimating(){return a.animate.name!=="off"},get isMoving(){return Ze.moveForward===1||Ze.moveBack===1||Ze.moveLeft===1||Ze.moveRight===1||Ze.moveUp===1||Ze.moveDown===1||Ze.rollLeft===1||Ze.rollRight===1||Ze.pitchUp===1||Ze.pitchDown===1||Ze.yawLeft===1||Ze.yawRight===1},get props(){return a},setProps:ke=>{var ot;((ot=ke.animate)===null||ot===void 0?void 0:ot.name)==="rock"&&a.animate.name!=="rock"&&me(),ke.flyMode!==void 0&&ke.flyMode!==a.flyMode&&(ke.flyMode?On():$a()),Object.assign(a,ke),Object.assign(s,ke.bindings)},start:Ft,update:Ii,reset:Ys,dispose:od}}t.create=e})(qw||(qw={}));var $1;(function(t){function e(){return{view:W.identity(),position:y.create(0,0,0),direction:y.create(0,0,-1),up:y.create(0,1,0)}}t.create=e;let r=y.zero();function n(o){y.add(r,o.position,o.direction),W.lookAt(o.view,o.position,r,o.up)}t.update=n})($1||($1={}));var Ww=class{constructor(){this.removeList=Ox(),this.removeMap=new Map,this.addList=Ox(),this.addMap=new Map}get isEmpty(){return this.removeList.count===0&&this.addList.count===0}get size(){return this.removeMap.size+this.addMap.size}add(e){if(this.removeMap.has(e)){let n=this.removeMap.get(e);this.removeMap.delete(e),this.removeList.remove(n)}if(this.addMap.has(e))return;let r=this.addList.addLast(e);this.addMap.set(e,r)}remove(e){if(this.addMap.has(e)){let n=this.addMap.get(e);this.addMap.delete(e),this.addList.remove(n)}if(this.removeMap.has(e))return;let r=this.removeList.addLast(e);this.removeMap.set(e,r)}tryGetRemove(){let e=this.removeList.removeFirst();return e&&this.removeMap.delete(e),e}tryGetAdd(){let e=this.addList.removeFirst();return e&&this.addMap.delete(e),e}};var Z1=new Zs("98");function IQ(t,e,r){Z1.reset();for(let n=0,o=t.length;n<o;++n){if(r&&!t[n].state.visible)continue;let i=t[n].values.boundingSphere.ref.value;i.radius&&Z1.includeSphere(i)}Z1.finishedIncludeStep();for(let n=0,o=t.length;n<o;++n){if(r&&!t[n].state.visible)continue;let i=t[n].values.boundingSphere.ref.value;i.radius&&Z1.radiusSphere(i)}return Z1.getSphere(e)}function WSe(t,e){let r=t.getProgram("color").id,n=e.getProgram("color").id,o=t.materialId,i=e.materialId;return r!==n?r-n:o!==i?o-i:t.id-e.id}var xm;(function(t){function e(r,n="blended"){let o=new Map,i=[],a=te(),s=te(),l=[],c=[],u=!0,d=!0,m=!0,p=!0,h=!0,f=!0,b=0,v=0,x=0,S=!1,T=$1.create(),{view:E,position:_,direction:D,up:P}=T;function A(Y){if(o.has(Y))console.warn(`RenderObject with id '${Y.id}' already present`);else{let j=xH(r,Y,n);i.push(j),Y.type==="direct-volume"?c.push(j):l.push(j),o.set(Y,j),u=!0,d=!0}}function I(Y){let j=o.get(Y);j&&(j.dispose(),nm(i,j),nm(l,j),nm(c,j),o.delete(Y),u=!0,d=!0)}let k=100;function M(Y){let j=ko(),O=0;for(;;){let J=R.tryGetRemove();if(!J)break;if(I(J),++O%k===0&&ko()-j>Y)return!1}for(;;){let J=R.tryGetAdd();if(!J)break;if(A(J),++O%k===0&&ko()-j>Y)return!1}return i.sort(WSe),m=!0,p=!0,h=!0,f=!0,!0}let R=new Ww,B=-1;function F(){let Y=23;for(let j=0,O=i.length;j<O;++j)i[j].state.visible&&(Y=31*Y+i[j].id|0);return Y=Ez(Y),Y===-1&&(Y=0),Y}function G(){let Y=F();return Y!==B?(d=!0,m=!0,p=!0,h=!0,f=!0,B=Y,!0):!1}function V(){if(l.length===0)return 0;let Y=0,j=0;for(let O=0,J=l.length;O<J;++O)l[O].state.visible&&(j+=l[O].values.markerAverage.ref.value,Y+=1);return Y>0?j/Y:0}function H(){if(l.length===0)return 0;let Y=0,j=0;for(let O=0,J=l.length;O<J;++O)l[O].state.visible&&(j+=l[O].values.emissiveAverage.ref.value+l[O].values.uEmissive.ref.value,Y+=1);return Y>0?j/Y:0}function Q(){var Y,j;if(l.length===0)return 0;let O=0,J=0;for(let $=0,ae=l.length;$<ae;++$){let Z=l[$];if(!Z.state.visible)continue;let se=Wo(Z.values.alpha.ref.value*Z.state.alphaFactor,0,1),Me=!((Y=Z.values.dXrayShaded)===null||Y===void 0)&&Y.ref.value?.5:1,be=((j=Z.values.dPointStyle)===null||j===void 0?void 0:j.ref.value)==="fuzzy"?.5:1,_e=Z.values.dGeometryType.ref.value==="text"?.5:1;J+=(1-Z.values.transparencyAverage.ref.value)*se*Me*be*_e,O+=1}return O>0?J/O:0}function L(){var Y;if(l.length===0)return!1;for(let j=0,O=l.length;j<O;++j){let J=l[j];if(J.state.visible&&(J.state.opaque||J.state.alphaFactor===1&&J.values.alpha.ref.value===1&&J.values.transparencyAverage.ref.value!==1||((Y=J.values.dTransparentBackfaces)===null||Y===void 0?void 0:Y.ref.value)==="opaque"))return!0}return!1}return{view:E,position:_,direction:D,up:P,renderables:i,primitives:{view:E,position:_,direction:D,up:P,renderables:l},volumes:{view:E,position:_,direction:D,up:P,renderables:c},syncVisibility:G,setTransparency:Y=>{n=Y;for(let j=0,O=i.length;j<O;++j)i[j].setTransparency(Y)},update(Y,j){var O;if($1.update(T),Y)for(let J=0,$=Y.length;J<$;++J)(O=o.get(Y[J]))===null||O===void 0||O.update();else for(let J=0,$=i.length;J<$;++J)i[J].update();j?G():(u=!0,d=!0),m=!0,p=!0,h=!0,f=!0},add:Y=>R.add(Y),remove:Y=>R.remove(Y),commit:(Y=Number.MAX_VALUE)=>M(Y),get commitQueueSize(){return R.size},get needsCommit(){return!R.isEmpty},has:Y=>o.has(Y),clear:()=>{for(let Y=0,j=i.length;Y<j;++Y)i[Y].dispose();i.length=0,l.length=0,c.length=0,o.clear(),u=!0,d=!0},forEach:Y=>{o.forEach(Y)},get count(){return i.length},get boundingSphere(){return u&&(IQ(i,a,!1),u=!1),a},get boundingSphereVisible(){return d&&(IQ(i,s,!0),d=!1),s},get markerAverage(){return m&&(b=V(),m=!1),b},get emissiveAverage(){return p&&(v=H(),p=!1),v},get opacityAverage(){return h&&(x=Q(),h=!1),x},get hasOpaque(){return f&&(S=L(),f=!1),S}}}t.create=e})(xm||(xm={}));var Mv=class t{get source(){return this._source}get target(){return this._target}apply(e,r=0,n){if((!this.inTransition||r>0)&&an.copySnapshot(this._source,this.camera.state),this.inTransition||an.copySnapshot(this._target,this.camera.state),an.copySnapshot(this._target,e),this._target.radius>this._target.radiusMax&&(this._target.radius=this._target.radiusMax),this._target.radius<.01&&(this._target.radius=.01),this._target.radiusMax<.01&&(this._target.radiusMax=.01),!this.inTransition&&r<=0||typeof e.mode<"u"&&e.mode!==this.camera.state.mode){this.finish(this._target);return}this.inTransition=!0,this.func=n||t.defaultTransition,(!this.inTransition||r>0)&&(this.start=this.t,this.durationMs=r)}tick(e){this.t=e,this.update()}finish(e){an.copySnapshot(this.camera.state,e),this.inTransition=!1}update(){if(!this.inTransition)return;let e=Math.min((this.t-this.start)/this.durationMs,1);if(e===1){this.finish(this._target);return}this.func(this._current,e,this._source,this._target),an.copySnapshot(this.camera.state,this._current)}constructor(e){this.camera=e,this.t=0,this.func=t.defaultTransition,this.start=0,this.inTransition=!1,this.durationMs=0,this._source=an.createDefaultSnapshot(),this._target=an.createDefaultSnapshot(),this._current=an.createDefaultSnapshot()}};(function(t){let e=xn.identity();function r(n,o,i,a){an.copySnapshot(n,a),xn.slerp(e,xn.Identity,xn.rotationTo(e,i.up,a.up),o),y.transformQuat(n.up,i.up,e),y.lerp(n.target,i.target,a.target,o),y.lerp(n.position,i.position,a.position,o),n.radius=fn(i.radius,a.radius,o),n.radiusMax=fn(i.radiusMax,a.radiusMax,o),n.fov=fn(i.fov,a.fov,o),n.fog=fn(i.fog,a.fog,o)}t.defaultTransition=r})(Mv||(Mv={}));var DQ=y(),AQ=y(),Xw=at(),an=class t{get position(){return this.state.position}set position(e){y.copy(this.state.position,e)}get up(){return this.state.up}set up(e){y.copy(this.state.up,e)}get target(){return this.state.target}set target(e){y.copy(this.state.target,e)}update(){let e=this.state;if(e.radiusMax===0)return!1;let r=2*Math.tan(e.fov/2)*y.distance(e.position,e.target);switch(this.zoom=this.viewport.height/r,QSe(this),this.state.mode){case"orthographic":XSe(this);break;case"perspective":YSe(this);break;default:ur(this.state.mode)}let n=!W.areEqual(this.projection,this.prevProjection,1e-6)||!W.areEqual(this.view,this.prevView,1e-6);if(n){if(W.mul(this.projectionView,this.projection,this.view),!W.tryInvert(this.inverseProjectionView,this.projectionView))return W.copy(this.view,this.prevView),W.copy(this.projection,this.prevProjection),W.mul(this.projectionView,this.projection,this.view),!1;W.copy(this.prevView,this.view),W.copy(this.prevProjection,this.projection)}return n}setState(e,r){this.transition.apply(e,r),this.stateChanged.next(e)}getSnapshot(){return t.copySnapshot(t.createDefaultSnapshot(),this.state)}getTargetDistance(e){return t.targetDistance(e,this.state.mode,this.state.fov,this.viewport.width,this.viewport.height)}getFocus(e,r,n,o,i){var a,s;let l=Math.max(r,.01),c=this.getTargetDistance(l);y.sub(this.deltaDirection,(a=i?.target)!==null&&a!==void 0?a:this.target,(s=i?.position)!==null&&s!==void 0?s:this.position),o&&y.matchDirection(this.deltaDirection,o,this.deltaDirection),y.setMagnitude(this.deltaDirection,this.deltaDirection,c),y.sub(this.newPosition,e,this.deltaDirection);let u=t.copySnapshot(t.createDefaultSnapshot(),this.state);return u.target=y.clone(e),u.radius=l,u.position=y.clone(this.newPosition),n&&y.matchDirection(u.up,n,u.up),u}getCenter(e,r){y.sub(this.deltaDirection,this.target,this.position),y.sub(this.newPosition,e,this.deltaDirection);let n=t.copySnapshot(t.createDefaultSnapshot(),this.state);return n.target=y.clone(e),n.position=y.clone(this.newPosition),r&&(n.radius=Math.max(r,.01)),n}getInvariantFocus(e,r,n,o){let i=Math.max(r,.01),a=this.getTargetDistance(i);y.copy(this.deltaDirection,o),y.setMagnitude(this.deltaDirection,this.deltaDirection,a),y.sub(this.newPosition,e,this.deltaDirection);let s=t.copySnapshot(t.createDefaultSnapshot(),this.state);return s.target=y.clone(e),s.radius=i,s.position=y.clone(this.newPosition),y.copy(s.up,n),s}focus(e,r,n,o,i){r>0&&this.setState(this.getFocus(e,r,o,i),n)}center(e,r){this.setState(this.getCenter(e),r)}project(e,r){return CQ(e,r,this.viewport,this.projectionView)}unproject(e,r){return kv(e,r,this.viewport,this.inverseProjectionView)}getPixelSize(e){return this.project(Xw,e),this.unproject(DQ,Xw),Xw[0]+=1,this.unproject(AQ,Xw),y.distance(DQ,AQ)}constructor(e,r=_n.create(0,0,128,128)){this.view=W.identity(),this.projection=W.identity(),this.projectionView=W.identity(),this.inverseProjectionView=W.identity(),this.state=t.createDefaultSnapshot(),this.viewOffset=t.ViewOffset(),this.near=1,this.far=1e4,this.fogNear=5e3,this.fogFar=1e4,this.zoom=1,this.transition=new Mv(this),this.stateChanged=new da(this.state),this.prevProjection=W.identity(),this.prevView=W.identity(),this.deltaDirection=y(),this.newPosition=y(),this.viewport=r,t.copySnapshot(this.state,e)}};(function(t){function e(){return{enabled:!1,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}}t.ViewOffset=e;function r(l,c,u,d,m,p,h){l.fullWidth=c,l.fullHeight=u,l.offsetX=d,l.offsetY=m,l.width=p,l.height=h}t.setViewOffset=r;function n(l,c){l.enabled=c.enabled,l.fullWidth=c.fullWidth,l.fullHeight=c.fullHeight,l.offsetX=c.offsetX,l.offsetY=c.offsetY,l.width=c.width,l.height=c.height}t.copyViewOffset=n;function o(l,c,u,d,m){let p=Math.max(l,.01),h=d/m,f=m<d?1:h;return Math.abs(c==="orthographic"?p/f/Math.tan(u/2):p/f/Math.sin(u/2))}t.targetDistance=o;function i(){return{mode:"perspective",fov:Math.PI/4,position:y.create(0,0,100),up:y.create(0,1,0),target:y.create(0,0,0),radius:0,radiusMax:10,fog:50,clipFar:!0,minNear:5,minFar:0}}t.createDefaultSnapshot=i;function a(l,c){return c&&(typeof c.mode<"u"&&(l.mode=c.mode),typeof c.fov<"u"&&(l.fov=c.fov),typeof c.position<"u"&&y.copy(l.position,c.position),typeof c.up<"u"&&y.copy(l.up,c.up),typeof c.target<"u"&&y.copy(l.target,c.target),typeof c.radius<"u"&&(l.radius=c.radius),typeof c.radiusMax<"u"&&(l.radiusMax=c.radiusMax),typeof c.fog<"u"&&(l.fog=c.fog),typeof c.clipFar<"u"&&(l.clipFar=c.clipFar),typeof c.minNear<"u"&&(l.minNear=c.minNear),typeof c.minFar<"u"&&(l.minFar=c.minFar)),l}t.copySnapshot=a;function s(l,c){return l.mode===c.mode&&l.fov===c.fov&&l.radius===c.radius&&l.radiusMax===c.radiusMax&&l.fog===c.fog&&l.clipFar===c.clipFar&&l.minNear===c.minNear&&l.minFar===c.minFar&&y.exactEquals(l.position,c.position)&&y.exactEquals(l.up,c.up)&&y.exactEquals(l.target,c.target)}t.areSnapshotsEqual=s})(an||(an={}));function XSe(t){let{viewport:e,zoom:r,near:n,far:o,viewOffset:i}=t,a=-e.width/2,s=e.width/2,l=e.height/2,c=-e.height/2,u=(s-a)/(2*r),d=(l-c)/(2*r),m=(s+a)/2,p=(l+c)/2,h=m-u,f=m+u,b=p+d,v=p-d;if(i.enabled){let x=r/(i.width/i.fullWidth),S=r/(i.height/i.fullHeight),T=(s-a)/i.width,E=(l-c)/i.height;h+=T*(i.offsetX/x),f=h+T*(i.width/x),b-=E*(i.offsetY/S),v=b-E*(i.height/S)}W.ortho(t.projection,h,f,b,v,n,o),W.lookAt(t.view,t.position,t.target,t.up)}function YSe(t){let e=t.viewport.width/t.viewport.height,{near:r,far:n,viewOffset:o}=t,i=r*Math.tan(.5*t.state.fov),a=2*i,s=e*a,l=-.5*s;o.enabled&&(l+=o.offsetX*s/o.fullWidth,i-=o.offsetY*a/o.fullHeight,s*=o.width/o.fullWidth,a*=o.height/o.fullHeight),W.perspective(t.projection,l,l+s,i,i-a,r,n),W.lookAt(t.view,t.position,t.target,t.up)}function QSe(t){let{radius:e,radiusMax:r,mode:n,fog:o,clipFar:i,minNear:a,minFar:s}=t.state;e<.01&&(e=.01);let l=Math.max(i?e:r,s),c=y.distance(t.position,t.target),u=c-e,d=c+l;u=Math.max(Math.min(r,a),u),d=Math.max(a,d),u===d&&(d=u+.01);let m=-(50-o)/50,p=c-l*m,h=d;t.near=u,t.far=d,t.fogNear=p,t.fogFar=h}var J1={sceneBoundingSpheres:g.Boolean(!1,{description:"Show full scene bounding spheres."}),visibleSceneBoundingSpheres:g.Boolean(!1,{description:"Show visible scene bounding spheres."}),objectBoundingSpheres:g.Boolean(!1,{description:"Show bounding spheres of visible render objects."}),instanceBoundingSpheres:g.Boolean(!1,{description:"Show bounding spheres of visible instances."})},Qw=class{constructor(e,r,n){this.objectsData=new Map,this.instancesData=new Map,this.scene=xm.create(e,"blended"),this.parent=r,this._props=w(w({},g.getDefaultValues(J1)),n)}update(){let e=Yw(this.scene,this.parent.boundingSphere,this.sceneData,ut.lightgrey,$Se);e&&(this.sceneData=e);let r=Yw(this.scene,this.parent.boundingSphereVisible,this.visibleSceneData,ut.black,ZSe);r&&(this.visibleSceneData=r),this.parent.forEach((n,o)=>{let i=this.objectsData.get(o),a=Yw(this.scene,n.values.boundingSphere.ref.value,i,ut.tomato,JSe);a&&this.objectsData.set(o,a);let s=this.instancesData.get(o),l=Yw(this.scene,n.values.invariantBoundingSphere.ref.value,s,ut.skyblue,eCe,{aTransform:o.values.aTransform,matrix:o.values.matrix,transform:o.values.transform,extraTransform:o.values.extraTransform,uInstanceCount:o.values.uInstanceCount,instanceCount:o.values.instanceCount,aInstance:o.values.aInstance,hasReflection:o.values.hasReflection,instanceGrid:o.values.instanceGrid});l&&this.instancesData.set(o,l)}),this.objectsData.forEach((n,o)=>{this.parent.has(o)||(this.scene.remove(n.renderObject),this.objectsData.delete(o))}),this.instancesData.forEach((n,o)=>{this.parent.has(o)||(this.scene.remove(n.renderObject),this.instancesData.delete(o))}),this.scene.update(void 0,!1),this.scene.commit()}syncVisibility(){this.sceneData&&(this.sceneData.renderObject.state.visible=this._props.sceneBoundingSpheres),this.visibleSceneData&&(this.visibleSceneData.renderObject.state.visible=this._props.visibleSceneBoundingSpheres),this.parent.forEach((e,r)=>{let n=this.objectsData.get(r);n&&(n.renderObject.state.visible=r.state.visible&&this._props.objectBoundingSpheres);let o=this.instancesData.get(r);o&&(o.renderObject.state.visible=r.state.visible&&this._props.instanceBoundingSpheres)})}clear(){this.sceneData=void 0,this.objectsData.clear(),this.scene.clear()}get isEnabled(){return this._props.sceneBoundingSpheres||this._props.visibleSceneBoundingSpheres||this._props.objectBoundingSpheres||this._props.instanceBoundingSpheres}get props(){return this._props}setProps(e){Object.assign(this._props,e),this.isEnabled&&this.update()}};function Yw(t,e,r,n,o,i){if(!r||!te.equals(r.boundingSphere,e)){let a=KSe(e,r&&r.mesh),s=r?r.renderObject:tCe(a,n,o,i);return r?C.updateIfChanged(s.values.drawCount,eo.getDrawCount(a)):t.add(s),{boundingSphere:te.clone(e),renderObject:s,mesh:a}}}function KSe(t,e){let n=Sd(2),o=Te.createState(n,n/2,e);if(t.radius&&(Jt(o,t.center,t.radius,2),te.hasExtrema(t)))for(let i of t.extrema)Jt(o,i,1,0);return Te.getMesh(o)}var $Se=rl(),ZSe=rl(),JSe=rl(),eCe=rl();function tCe(t,e,r,n){let o=Be.Utils.createValuesSimple(t,{alpha:.1,doubleSided:!1,cellSize:0,batchSize:0},e,1,n);return tu("mesh",o,{disposed:!1,visible:!0,alphaFactor:1,pickable:!1,colorOnly:!1,opaque:!1,writeDepth:!1},r)}var oy=function(t){return t[t.Move=0]="Move",t[t.Click=1]="Click",t[t.Drag=2]="Drag",t}(oy||{}),QR=y(),KR=y(),kQ=y(),$R={maxFps:g.Numeric(30,{min:10,max:60,step:10}),preferAtomPixelPadding:g.Numeric(3,{min:0,max:20,step:1},{description:"Number of extra pixels at which to prefer atoms over bonds."})},Kw=class{setProps(e){Object.assign(this.props,e)}identify(e,r){let n=this.startX!==this.endX||this.startY!==this.endY||this.input.pointerLock&&!this.controls.isMoving;if(e===oy.Drag){n&&!this.outsideViewport(this.startX,this.startY)&&(this.events.drag.next({current:this.prevLoci,buttons:this.buttons,button:this.button,modifiers:this.modifiers,pageStart:ne.create(this.startX,this.startY),pageEnd:ne.create(this.endX,this.endY)}),this.startX=this.endX,this.startY=this.endY);return}if(n){let i=this.canvasIdentify(this.endX,this.endY);this.id=i?.id,this.position=i?.position,this.startX=this.endX,this.startY=this.endY}if(e===oy.Click){let i=this.getLoci(this.id,this.position);this.events.click.next({current:i,buttons:this.buttons,button:this.button,modifiers:this.modifiers,page:ne.create(this.endX,this.endY),position:this.position}),this.prevLoci=i;return}if(!this.inside||this.currentIdentifyT!==r||!n||this.outsideViewport(this.endX,this.endY))return;let o=this.getLoci(this.id,this.position);this.events.hover.next({current:o,buttons:this.buttons,button:this.button,modifiers:this.modifiers,page:ne.create(this.endX,this.endY),position:this.position}),this.prevLoci=o}tick(e){this.inside&&e-this.prevT>1e3/this.props.maxFps&&(this.prevT=e,this.currentIdentifyT=e,this.identify(this.isInteracting?oy.Drag:oy.Move,e))}leave(){this.inside=!1,rt.Loci.isEmpty(this.prevLoci)||(this.prevLoci=rt.Loci.Empty,this.events.hover.next({current:this.prevLoci,buttons:this.buttons,button:this.button,modifiers:this.modifiers}))}move(e,r,n,o,i){this.inside=!0,this.buttons=n,this.button=o,this.modifiers=i,this.endX=e,this.endY=r}click(e,r,n,o,i){this.endX=e,this.endY=r,this.buttons=n,this.button=o,this.modifiers=i,this.identify(oy.Click,0)}drag(e,r,n,o,i){this.endX=e,this.endY=r,this.buttons=n,this.button=o,this.modifiers=i,this.identify(oy.Drag,0)}modify(e){na.areEqual(e,this.modifiers)||(this.modifiers=e,this.events.hover.next({current:this.prevLoci,buttons:this.buttons,button:this.button,modifiers:this.modifiers,page:ne.create(this.endX,this.endY),position:this.position}))}outsideViewport(e,r){let{input:n,camera:{viewport:o}}=this;return e*=n.pixelRatio,r*=n.pixelRatio,e>o.x+o.width||n.height-r>o.y+o.height||e<o.x||n.height-r<o.y}getLoci(e,r){var n;let{repr:o,loci:i}=this.lociGetter(e);if(r&&o&&ze.isLoci(i)&&i.bonds.length===2){let{aUnit:a,aIndex:s}=i.bonds[0];a.conformation.position(a.elements[s],QR),y.sub(kQ,this.camera.state.position,this.camera.state.target),y.projectPointOnPlane(KR,r,kQ,QR);let l=this.camera.getPixelSize(KR),c=o.theme.size.size(i.bonds[0])*((n=o.props.sizeFactor)!==null&&n!==void 0?n:1);if(o.props.lineSizeAttenuation===!1&&(c*=l/2),c+=this.props.preferAtomPixelPadding*l,y.distance(KR,QR)<c)return{repr:o,loci:ze.toFirstStructureElementLoci(i)}}return{repr:o,loci:i}}dispose(){this.ev.dispose()}constructor(e,r,n,o,i,a={}){this.canvasIdentify=e,this.lociGetter=r,this.input=n,this.camera=o,this.controls=i,this.ev=_s.create(),this.events={hover:this.ev(),drag:this.ev(),click:this.ev()},this.startX=-1,this.startY=-1,this.endX=-1,this.endY=-1,this.id=void 0,this.position=void 0,this.currentIdentifyT=0,this.isInteracting=!1,this.prevLoci=rt.Loci.Empty,this.prevT=0,this.inside=!1,this.buttons=yn.create(0),this.button=yn.create(0),this.modifiers=na.None,this.props=w(w({},g.getDefaultValues($R)),a),n.drag.subscribe(({x:s,y:l,buttons:c,button:u,modifiers:d})=>{this.isInteracting=!0,this.drag(s,l,c,u,d)}),n.move.subscribe(({x:s,y:l,inside:c,buttons:u,button:d,modifiers:m,onElement:p})=>{if(!(!c||this.isInteracting)){if(!p){this.leave();return}this.move(s,l,u,d,m)}}),n.leave.subscribe(()=>{this.leave()}),n.click.subscribe(({x:s,y:l,buttons:c,button:u,modifiers:d})=>{this.outsideViewport(s,l)||this.click(s,l,c,u,d)}),n.interactionEnd.subscribe(()=>{this.isInteracting=!1}),n.modifiers.subscribe(s=>{this.modify(s)})}};var MQ=`
precision highp float;
precision highp int;
precision highp sampler2D;

uniform sampler2D tDepthOpaque;
uniform sampler2D tDepthTransparent;
uniform vec2 uTexSize;

uniform float uNear;
uniform float uFar;
uniform mat4 uInvProjection;

uniform float uOutlineThreshold;

#include common

float getViewZ(const in float depth) {
    #if dOrthographic == 1
        return orthographicDepthToViewZ(depth, uNear, uFar);
    #else
        return perspectiveDepthToViewZ(depth, uNear, uFar);
    #endif
}

float getDepthOpaque(const in vec2 coords) {
    #ifdef depthTextureSupport
        return texture2D(tDepthOpaque, coords).r;
    #else
        return unpackRGBAToDepth(texture2D(tDepthOpaque, coords));
    #endif
}

float getDepthTransparent(const in vec2 coords) {
    #ifdef dTransparentOutline
        return unpackRGBAToDepth(texture2D(tDepthTransparent, coords));
    #else
        return 1.0;
    #endif
}

bool isBackground(const in float depth) {
    return depth == 1.0;
}

float getPixelSize(const in vec2 coords, const in float depth) {
    vec3 viewPos0 = screenSpaceToViewSpace(vec3(coords, depth), uInvProjection);
    vec3 viewPos1 = screenSpaceToViewSpace(vec3(coords + vec2(1.0, 0.0) / uTexSize, depth), uInvProjection);
    return distance(viewPos0, viewPos1);
}

void main(void) {
    float backgroundViewZ = 2.0 * uFar;

    vec2 coords = gl_FragCoord.xy / uTexSize;
    vec2 invTexSize = 1.0 / uTexSize;

    float selfDepthOpaque = getDepthOpaque(coords);
    float selfViewZOpaque = isBackground(selfDepthOpaque) ? backgroundViewZ : getViewZ(selfDepthOpaque);
    float pixelSizeOpaque = getPixelSize(coords, selfDepthOpaque) * uOutlineThreshold;

    float selfDepthTransparent = getDepthTransparent(coords);
    float selfViewZTransparent = isBackground(selfDepthTransparent) ? backgroundViewZ : getViewZ(selfDepthTransparent);
    float pixelSizeTransparent = getPixelSize(coords, selfDepthTransparent) * uOutlineThreshold;

    float outline = 1.0;
    float bestDepth = 1.0;
    float transparentFlag = 0.0;

    for (int y = -1; y <= 1; y++) {
        for (int x = -1; x <= 1; x++) {
            vec2 sampleCoords = coords + vec2(float(x), float(y)) * invTexSize;

            float sampleDepthOpaque = getDepthOpaque(sampleCoords);
            float sampleDepthTransparent = getDepthTransparent(sampleCoords);

            float sampleViewZOpaque = isBackground(sampleDepthOpaque) ? backgroundViewZ : getViewZ(sampleDepthOpaque);
            if (abs(selfViewZOpaque - sampleViewZOpaque) > pixelSizeOpaque && selfDepthOpaque > sampleDepthOpaque && sampleDepthOpaque <= bestDepth) {
                outline = 0.0;
                bestDepth = sampleDepthOpaque;
            }

            if (sampleDepthTransparent < sampleDepthOpaque) {
                float sampleViewZTransparent = isBackground(sampleDepthTransparent) ? backgroundViewZ : getViewZ(sampleDepthTransparent);
                if (abs(selfViewZTransparent - sampleViewZTransparent) > pixelSizeTransparent && selfDepthTransparent > sampleDepthTransparent && sampleDepthTransparent <= bestDepth) {
                    outline = 0.0;
                    bestDepth = sampleDepthTransparent;
                    transparentFlag = 1.0;
                }
            }
        }
    }

    gl_FragColor = vec4(outline, packUnitIntervalToRG(bestDepth), transparentFlag);
}
`;var RQ=`
precision highp float;
precision highp int;
precision highp sampler2D;

#include common

uniform sampler2D tDepth;
uniform sampler2D tDepthHalf;
uniform sampler2D tDepthQuarter;
uniform vec2 uTexSize;
uniform vec4 uBounds;

uniform vec3 uSamples[dNSamples];

uniform mat4 uProjection;
uniform mat4 uInvProjection;

#ifdef dMultiScale
    uniform float uLevelRadius[dLevels];
    uniform float uLevelBias[dLevels];
    uniform float uNearThreshold;
    uniform float uFarThreshold;
#else
    uniform float uRadius;
#endif
uniform float uBias;

float smootherstep(float edge0, float edge1, float x) {
    x = clamp((x - edge0) / (edge1 - edge0), 0.0, 1.0);
    return x * x * x * (x * (x * 6.0 - 15.0) + 10.0);
}

float noise(const in vec2 coords) {
    float a = 12.9898;
    float b = 78.233;
    float c = 43758.5453;
    float dt = dot(coords, vec2(a,b));
    float sn = mod(dt, PI);
    return abs(fract(sin(sn) * c)); // is abs necessary?
}

vec2 getNoiseVec2(const in vec2 coords) {
    return vec2(noise(coords), noise(coords + vec2(PI, 2.71828)));
}

bool isBackground(const in float depth) {
    return depth == 1.0;
}

float getDepth(const in vec2 coords) {
    vec2 c = vec2(clamp(coords.x, uBounds.x, uBounds.z), clamp(coords.y, uBounds.y, uBounds.w));
    #ifdef depthTextureSupport
        return texture2D(tDepth, c).r;
    #else
        return unpackRGBAToDepth(texture2D(tDepth, c));
    #endif
}

#define dQuarterThreshold 0.1
#define dHalfThreshold 0.05

float getMappedDepth(const in vec2 coords, const in vec2 selfCoords) {
    vec2 c = vec2(clamp(coords.x, uBounds.x, uBounds.z), clamp(coords.y, uBounds.y, uBounds.w));
    float d = distance(coords, selfCoords);
    #ifdef depthTextureSupport
        if (d > dQuarterThreshold) {
            return texture2D(tDepthQuarter, c).r;
        } else if (d > dHalfThreshold) {
            return texture2D(tDepthHalf, c).r;
        } else {
            return texture2D(tDepth, c).r;
        }
    #else
        if (d > dQuarterThreshold) {
            return unpackRGBAToDepth(texture2D(tDepthQuarter, c));
        } else if (d > dHalfThreshold) {
            return unpackRGBAToDepth(texture2D(tDepthHalf, c));
        } else {
            return unpackRGBAToDepth(texture2D(tDepth, c));
        }
    #endif
}

// adapted from https://gist.github.com/bgolus/a07ed65602c009d5e2f753826e8078a0
vec3 viewNormalAtPixelPositionAccurate(vec2 vpos) {
    // current pixel's depth
    float c = getDepth(vpos);

    // get current pixel's view space position
    vec3 viewSpacePos_c = screenSpaceToViewSpace(vec3(vpos, c), uInvProjection);

    // get view space position at 1 pixel offsets in each major direction
    vec3 viewSpacePos_l = screenSpaceToViewSpace(vec3(vpos + vec2(-1.0, 0.0) / uTexSize, getDepth(vpos + vec2(-1.0, 0.0) / uTexSize)), uInvProjection);
    vec3 viewSpacePos_r = screenSpaceToViewSpace(vec3(vpos + vec2( 1.0, 0.0) / uTexSize, getDepth(vpos + vec2( 1.0, 0.0) / uTexSize)), uInvProjection);
    vec3 viewSpacePos_d = screenSpaceToViewSpace(vec3(vpos + vec2( 0.0,-1.0) / uTexSize, getDepth(vpos + vec2( 0.0,-1.0) / uTexSize)), uInvProjection);
    vec3 viewSpacePos_u = screenSpaceToViewSpace(vec3(vpos + vec2( 0.0, 1.0) / uTexSize, getDepth(vpos + vec2( 0.0, 1.0) / uTexSize)), uInvProjection);

    // get the difference between the current and each offset position
    vec3 l = viewSpacePos_c - viewSpacePos_l;
    vec3 r = viewSpacePos_r - viewSpacePos_c;
    vec3 d = viewSpacePos_c - viewSpacePos_d;
    vec3 u = viewSpacePos_u - viewSpacePos_c;

    // get depth values at 1 & 2 pixels offsets from current along the horizontal axis
    vec4 H = vec4(
        getDepth(vpos + vec2(-1.0, 0.0) / uTexSize),
        getDepth(vpos + vec2( 1.0, 0.0) / uTexSize),
        getDepth(vpos + vec2(-2.0, 0.0) / uTexSize),
        getDepth(vpos + vec2( 2.0, 0.0) / uTexSize)
    );

    // get depth values at 1 & 2 pixels offsets from current along the vertical axis
    vec4 V = vec4(
        getDepth(vpos + vec2(0.0,-1.0) / uTexSize),
        getDepth(vpos + vec2(0.0, 1.0) / uTexSize),
        getDepth(vpos + vec2(0.0,-2.0) / uTexSize),
        getDepth(vpos + vec2(0.0, 2.0) / uTexSize)
    );

    // current pixel's depth difference from slope of offset depth samples
    // differs from original article because we're using non-linear depth values
    // see article's comments
    vec2 he = abs((2.0 * H.xy - H.zw) - c);
    vec2 ve = abs((2.0 * V.xy - V.zw) - c);

    // pick horizontal and vertical diff with the smallest depth difference from slopes
    vec3 hDeriv = he.x < he.y ? l : r;
    vec3 vDeriv = ve.x < ve.y ? d : u;

    // get view space normal from the cross product of the best derivatives
    vec3 viewNormal = normalize(cross(hDeriv, vDeriv));

    return viewNormal;
}

float getPixelSize(const in vec2 coords, const in float depth) {
    vec3 viewPos0 = screenSpaceToViewSpace(vec3(coords, depth), uInvProjection);
    vec3 viewPos1 = screenSpaceToViewSpace(vec3(coords + vec2(1.0, 0.0) / uTexSize, depth), uInvProjection);
    return distance(viewPos0, viewPos1);
}

// StarCraft II Ambient Occlusion by [Filion and McNaughton 2008]
void main(void) {
    vec2 invTexSize = 1.0 / uTexSize;
    vec2 selfCoords = gl_FragCoord.xy * invTexSize;

    float selfDepth = getDepth(selfCoords);
    vec2 selfPackedDepth = packUnitIntervalToRG(selfDepth);

    if (isBackground(selfDepth)) {
        gl_FragColor = vec4(packUnitIntervalToRG(1.0), selfPackedDepth);
        return;
    }

    vec3 selfViewNormal = viewNormalAtPixelPositionAccurate(selfCoords);
    vec3 selfViewPos = screenSpaceToViewSpace(vec3(selfCoords, selfDepth), uInvProjection);

    vec3 randomVec = normalize(vec3(getNoiseVec2(selfCoords) * 2.0 - 1.0, 0.0));
    vec3 tangent = normalize(randomVec - selfViewNormal * dot(randomVec, selfViewNormal));
    vec3 bitangent = cross(selfViewNormal, tangent);
    mat3 TBN = mat3(tangent, bitangent, selfViewNormal);

    float occlusion = 0.0;
    #ifdef dMultiScale
        float pixelSize = getPixelSize(selfCoords, selfDepth);

        for(int l = 0; l < dLevels; l++) {
            // TODO: smooth transition
            if (pixelSize * uNearThreshold > uLevelRadius[l]) continue;
            if (pixelSize * uFarThreshold < uLevelRadius[l]) continue;

            float levelOcclusion = 0.0;
            for(int i = 0; i < dNSamples; i++) {
                // get sample position:
                vec3 sampleViewPos = TBN * uSamples[i];
                sampleViewPos = selfViewPos + sampleViewPos * uLevelRadius[l];

                // project sample position:
                vec4 offset = vec4(sampleViewPos, 1.0);
                offset = uProjection * offset;
                offset.xyz = (offset.xyz / offset.w) * 0.5 + 0.5;

                // get sample depth:
                float sampleDepth = getMappedDepth(offset.xy, selfCoords);
                float sampleViewZ = screenSpaceToViewSpace(vec3(offset.xy, sampleDepth), uInvProjection).z;
                levelOcclusion += step(sampleViewPos.z + 0.025, sampleViewZ) * smootherstep(0.0, 1.0, uLevelRadius[l] / abs(selfViewPos.z - sampleViewZ)) * uLevelBias[l];
            }
            occlusion = max(occlusion, levelOcclusion);
        }
    #else
        for(int i = 0; i < dNSamples; i++) {
            vec3 sampleViewPos = TBN * uSamples[i];
            sampleViewPos = selfViewPos + sampleViewPos * uRadius;

            vec4 offset = vec4(sampleViewPos, 1.0);
            offset = uProjection * offset;
            offset.xyz = (offset.xyz / offset.w) * 0.5 + 0.5;

            float sampleDepth = getMappedDepth(offset.xy, selfCoords);
            float sampleViewZ = screenSpaceToViewSpace(vec3(offset.xy, sampleDepth), uInvProjection).z;

            occlusion += step(sampleViewPos.z + 0.025, sampleViewZ) * smootherstep(0.0, 1.0, uRadius / abs(selfViewPos.z - sampleViewZ));
        }
    #endif
    occlusion = 1.0 - (uBias * occlusion / float(dNSamples));

    vec2 packedOcclusion = packUnitIntervalToRG(clamp(occlusion, 0.01, 1.0));

    gl_FragColor = vec4(packedOcclusion, selfPackedDepth);
}
`;var LQ=`
precision highp float;
precision highp int;
precision highp sampler2D;

uniform sampler2D tSsaoDepth;
uniform vec2 uTexSize;
uniform vec4 uBounds;

uniform float uKernel[dOcclusionKernelSize];

uniform float uBlurDirectionX;
uniform float uBlurDirectionY;

uniform mat4 uInvProjection;
uniform float uNear;
uniform float uFar;

#include common

float getViewZ(const in float depth) {
    #if dOrthographic == 1
        return orthographicDepthToViewZ(depth, uNear, uFar);
    #else
        return perspectiveDepthToViewZ(depth, uNear, uFar);
    #endif
}

bool isBackground(const in float depth) {
    return depth == 1.0;
}

bool outsideBounds(const in vec2 p) {
    return p.x < uBounds.x || p.y < uBounds.y || p.x > uBounds.z || p.y > uBounds.w;
}

float getPixelSize(const in vec2 coords, const in float depth) {
    vec3 viewPos0 = screenSpaceToViewSpace(vec3(coords, depth), uInvProjection);
    vec3 viewPos1 = screenSpaceToViewSpace(vec3(coords + vec2(1.0, 0.0) / uTexSize, depth), uInvProjection);
    return distance(viewPos0, viewPos1);
}

void main(void) {
    vec2 coords = gl_FragCoord.xy / uTexSize;

    vec2 packedDepth = texture2D(tSsaoDepth, coords).zw;

    if (outsideBounds(coords)) {
        gl_FragColor = vec4(packUnitIntervalToRG(1.0), packedDepth);
        return;
    }

    float selfDepth = unpackRGToUnitInterval(packedDepth);
    // if background and if second pass
    if (isBackground(selfDepth) && uBlurDirectionY != 0.0) {
        gl_FragColor = vec4(packUnitIntervalToRG(1.0), packedDepth);
        return;
    }

    float selfViewZ = getViewZ(selfDepth);
    float pixelSize = getPixelSize(coords, selfDepth);
    // max diff depth between two pixels
    float maxDiffViewZ = 1.0;

    vec2 offset = vec2(uBlurDirectionX, uBlurDirectionY) / uTexSize;

    float sum = 0.0;
    float kernelSum = 0.0;
    // only if kernelSize is odd
    for (int i = -dOcclusionKernelSize / 2; i <= dOcclusionKernelSize / 2; i++) {
        if (abs(float(i)) > 1.0 && abs(float(i)) * pixelSize > 0.8) continue;

        vec2 sampleCoords = coords + float(i) * offset;
        if (outsideBounds(sampleCoords)) {
            continue;
        }

        vec4 sampleSsaoDepth = texture2D(tSsaoDepth, sampleCoords);

        float sampleDepth = unpackRGToUnitInterval(sampleSsaoDepth.zw);
        if (isBackground(sampleDepth)) {
            continue;
        }

        float sampleViewZ = getViewZ(sampleDepth);
        if (abs(selfViewZ - sampleViewZ) > maxDiffViewZ) {
            continue;
        }

        float kernel = uKernel[int(abs(float(i)))]; // abs is not defined for int in webgl1
        float sampleValue = unpackRGToUnitInterval(sampleSsaoDepth.xy);

        sum += kernel * sampleValue;
        kernelSum += kernel;
    }
    gl_FragColor = vec4(packUnitIntervalToRG(sum / kernelSum), packedDepth);
}
`;var BQ=`
precision highp float;
precision highp int;
precision highp sampler2D;

uniform sampler2D tSsaoDepth;
uniform sampler2D tColor;
uniform sampler2D tDepthOpaque;
uniform sampler2D tDepthTransparent;
uniform sampler2D tShadows;
uniform sampler2D tOutlines;
uniform vec2 uTexSize;

uniform float uNear;
uniform float uFar;
uniform float uFogNear;
uniform float uFogFar;
uniform vec3 uFogColor;
uniform vec3 uOutlineColor;
uniform vec3 uOcclusionColor;
uniform bool uTransparentBackground;
uniform vec2 uOcclusionOffset;

#include common

float getViewZ(const in float depth) {
    #if dOrthographic == 1
        return orthographicDepthToViewZ(depth, uNear, uFar);
    #else
        return perspectiveDepthToViewZ(depth, uNear, uFar);
    #endif
}

float getDepthOpaque(const in vec2 coords) {
    #ifdef depthTextureSupport
        return texture2D(tDepthOpaque, coords).r;
    #else
        return unpackRGBAToDepth(texture2D(tDepthOpaque, coords));
    #endif
}

float getDepthTransparent(const in vec2 coords) {
    #ifdef dTransparentOutline
        return unpackRGBAToDepth(texture2D(tDepthTransparent, coords));
    #else
        return 1.0;
    #endif
}

bool isBackground(const in float depth) {
    return depth == 1.0;
}

float getOutline(const in vec2 coords, const in float opaqueDepth, out float closestTexel) {
    float backgroundViewZ = 2.0 * uFar;
    vec2 invTexSize = 1.0 / uTexSize;

    float transparentDepth = getDepthTransparent(coords);
    float opaqueSelfViewZ = isBackground(opaqueDepth) ? backgroundViewZ : getViewZ(opaqueDepth);
    float transparentSelfViewZ = isBackground(transparentDepth) ? backgroundViewZ : getViewZ(transparentDepth);
    float selfDepth = min(opaqueDepth, transparentDepth);

    float outline = 1.0;
    closestTexel = 1.0;
    for (int y = -dOutlineScale; y <= dOutlineScale; y++) {
        for (int x = -dOutlineScale; x <= dOutlineScale; x++) {
            if (x * x + y * y > dOutlineScale * dOutlineScale) {
                continue;
            }

            vec2 sampleCoords = coords + vec2(float(x), float(y)) * invTexSize;

            vec4 sampleOutlineCombined = texture2D(tOutlines, sampleCoords);
            float sampleOutline = sampleOutlineCombined.r;
            float sampleOutlineDepth = unpackRGToUnitInterval(sampleOutlineCombined.gb);
            float sampleOutlineViewZ = isBackground(sampleOutlineDepth) ? backgroundViewZ : getViewZ(sampleOutlineDepth);

            float selfViewZ = sampleOutlineCombined.a == 0.0 ? opaqueSelfViewZ : transparentSelfViewZ;
            if (sampleOutline == 0.0 && sampleOutlineDepth < closestTexel) {
                outline = 0.0;
                closestTexel = sampleOutlineDepth;
            }
        }
    }
    return closestTexel < opaqueDepth ? outline : 1.0;
}

float getSsao(vec2 coords) {
    float rawSsao = unpackRGToUnitInterval(texture2D(tSsaoDepth, coords).xy);
    if (rawSsao > 0.999) {
        return 1.0;
    } else if (rawSsao > 0.001) {
        return rawSsao;
    }
    // treat values close to 0.0 as errors and return no occlusion
    return 1.0;
}

void main(void) {
    vec2 coords = gl_FragCoord.xy / uTexSize;
    vec4 color = texture2D(tColor, coords);

    float viewDist;
    float fogFactor;
    float opaqueDepth = getDepthOpaque(coords);

    #ifdef dOcclusionEnable
        if (!isBackground(opaqueDepth)) {
            viewDist = abs(getViewZ(opaqueDepth));
            fogFactor = smoothstep(uFogNear, uFogFar, viewDist);
            float occlusionFactor = getSsao(coords + uOcclusionOffset);
            if (!uTransparentBackground) {
                color.rgb = mix(mix(uOcclusionColor, uFogColor, fogFactor), color.rgb, occlusionFactor);
            } else {
                color.rgb = mix(uOcclusionColor * (1.0 - fogFactor), color.rgb, occlusionFactor);
            }
        }
    #endif

    #ifdef dShadowEnable
        if (!isBackground(opaqueDepth)) {
            viewDist = abs(getViewZ(opaqueDepth));
            fogFactor = smoothstep(uFogNear, uFogFar, viewDist);
            vec4 shadow = texture2D(tShadows, coords);
            if (!uTransparentBackground) {
                color.rgb = mix(mix(vec3(0), uFogColor, fogFactor), color.rgb, shadow.a);
            } else {
                color.rgb = mix(vec3(0) * (1.0 - fogFactor), color.rgb, shadow.a);
            }
        }
    #endif

    // outline needs to be handled after occlusion and shadow to keep them clean
    #ifdef dOutlineEnable
        float closestTexel;
        float outline = getOutline(coords, opaqueDepth, closestTexel);
        if (outline == 0.0) {
            viewDist = abs(getViewZ(closestTexel));
            fogFactor = smoothstep(uFogNear, uFogFar, viewDist);
            if (!uTransparentBackground) {
                color.rgb = mix(uOutlineColor, uFogColor, fogFactor);
            } else {
                color.a = 1.0 - fogFactor;
                color.rgb = mix(uOutlineColor, color.rgb, fogFactor);
            }
        }
    #endif

    gl_FragColor = color;
}
`;var OQ=`
precision highp float;
precision highp int;
precision highp sampler2D;

uniform sampler2D tColor;
uniform vec2 uTexSizeInv;

// adapted from https://github.com/kosua20/Rendu
// MIT License Copyright (c) 2017 Simon Rodriguez

#define QUALITY(q) ((q) < 5 ? 1.0 : ((q) > 5 ? ((q) < 10 ? 2.0 : ((q) < 11 ? 4.0 : 8.0)) : 1.5))

float rgb2luma(vec3 rgb){
    return sqrt(dot(rgb, vec3(0.299, 0.587, 0.114)));
}

float sampleLuma(vec2 uv) {
    return rgb2luma(texture2D(tColor, uv).rgb);
}

float sampleLuma(vec2 uv, float uOffset, float vOffset) {
    uv += uTexSizeInv * vec2(uOffset, vOffset);
    return sampleLuma(uv);
}

void main(void) {
    vec2 coords = gl_FragCoord.xy * uTexSizeInv;
    vec2 inverseScreenSize = uTexSizeInv;

    vec4 colorCenter = texture2D(tColor, coords);

    // Luma at the current fragment
    float lumaCenter = rgb2luma(colorCenter.rgb);

    // Luma at the four direct neighbours of the current fragment.
    float lumaDown = sampleLuma(coords, 0.0, -1.0);
    float lumaUp = sampleLuma(coords, 0.0, 1.0);
    float lumaLeft = sampleLuma(coords, -1.0, 0.0);
    float lumaRight = sampleLuma(coords, 1.0, 0.0);

    // Find the maximum and minimum luma around the current fragment.
    float lumaMin = min(lumaCenter, min(min(lumaDown, lumaUp), min(lumaLeft, lumaRight)));
    float lumaMax = max(lumaCenter, max(max(lumaDown, lumaUp), max(lumaLeft, lumaRight)));

    // Compute the delta.
    float lumaRange = lumaMax - lumaMin;

    // If the luma variation is lower that a threshold (or if we are in a really dark area),
    // we are not on an edge, don't perform any AA.
    if (lumaRange < max(dEdgeThresholdMin, lumaMax * dEdgeThresholdMax)) {
        gl_FragColor = colorCenter;
        return;
    }

    // Query the 4 remaining corners lumas.
    float lumaDownLeft = sampleLuma(coords, -1.0, -1.0);
    float lumaUpRight = sampleLuma(coords, 1.0, 1.0);
    float lumaUpLeft = sampleLuma(coords, -1.0, 1.0);
    float lumaDownRight = sampleLuma(coords, 1.0, -1.0);

    // Combine the four edges lumas (using intermediary variables for future computations
    // with the same values).
    float lumaDownUp = lumaDown + lumaUp;
    float lumaLeftRight = lumaLeft + lumaRight;

    // Same for corners
    float lumaLeftCorners = lumaDownLeft + lumaUpLeft;
    float lumaDownCorners = lumaDownLeft + lumaDownRight;
    float lumaRightCorners = lumaDownRight + lumaUpRight;
    float lumaUpCorners = lumaUpRight + lumaUpLeft;

    // Compute an estimation of the gradient along the horizontal and vertical axis.
    float edgeHorizontal = abs(-2.0 * lumaLeft + lumaLeftCorners) + abs(-2.0 * lumaCenter + lumaDownUp) * 2.0 + abs(-2.0 * lumaRight + lumaRightCorners);
    float edgeVertical = abs(-2.0 * lumaUp + lumaUpCorners) + abs(-2.0 * lumaCenter + lumaLeftRight) * 2.0 + abs(-2.0 * lumaDown + lumaDownCorners);

    // Is the local edge horizontal or vertical ?
    bool isHorizontal = (edgeHorizontal >= edgeVertical);

    // Choose the step size (one pixel) accordingly.
    float stepLength = isHorizontal ? inverseScreenSize.y : inverseScreenSize.x;

    // Select the two neighboring texels lumas in the opposite direction to the local edge.
    float luma1 = isHorizontal ? lumaDown : lumaLeft;
    float luma2 = isHorizontal ? lumaUp : lumaRight;
    // Compute gradients in this direction.
    float gradient1 = luma1 - lumaCenter;
    float gradient2 = luma2 - lumaCenter;

    // Which direction is the steepest ?
    bool is1Steepest = abs(gradient1) >= abs(gradient2);

    // Gradient in the corresponding direction, normalized.
    float gradientScaled = 0.25 * max(abs(gradient1), abs(gradient2));

    // Average luma in the correct direction.
    float lumaLocalAverage = 0.0;
    if(is1Steepest){
        // Switch the direction
        stepLength = -stepLength;
        lumaLocalAverage = 0.5 * (luma1 + lumaCenter);
    } else {
        lumaLocalAverage = 0.5 * (luma2 + lumaCenter);
    }

    // Shift UV in the correct direction by half a pixel.
    vec2 currentUv = coords;
    if(isHorizontal){
        currentUv.y += stepLength * 0.5;
    } else {
        currentUv.x += stepLength * 0.5;
    }

    // Compute offset (for each iteration step) in the right direction.
    vec2 offset = isHorizontal ? vec2(inverseScreenSize.x, 0.0) : vec2(0.0, inverseScreenSize.y);
    // Compute UVs to explore on each side of the edge, orthogonally.
    // The QUALITY allows us to step faster.
    vec2 uv1 = currentUv - offset * QUALITY(0);
    vec2 uv2 = currentUv + offset * QUALITY(0);

    // Read the lumas at both current extremities of the exploration segment,
    // and compute the delta wrt to the local average luma.
    float lumaEnd1 = sampleLuma(uv1);
    float lumaEnd2 = sampleLuma(uv2);
    lumaEnd1 -= lumaLocalAverage;
    lumaEnd2 -= lumaLocalAverage;

    // If the luma deltas at the current extremities is larger than the local gradient,
    // we have reached the side of the edge.
    bool reached1 = abs(lumaEnd1) >= gradientScaled;
    bool reached2 = abs(lumaEnd2) >= gradientScaled;
    bool reachedBoth = reached1 && reached2;

    // If the side is not reached, we continue to explore in this direction.
    if(!reached1){
        uv1 -= offset * QUALITY(1);
    }
    if(!reached2){
        uv2 += offset * QUALITY(1);
    }

    // If both sides have not been reached, continue to explore.
    if(!reachedBoth){
        for(int i = 2; i < dIterations; i++){
            // If needed, read luma in 1st direction, compute delta.
            if(!reached1){
                lumaEnd1 = sampleLuma(uv1);
                lumaEnd1 = lumaEnd1 - lumaLocalAverage;
            }
            // If needed, read luma in opposite direction, compute delta.
            if(!reached2){
                lumaEnd2 = sampleLuma(uv2);
                lumaEnd2 = lumaEnd2 - lumaLocalAverage;
            }
            // If the luma deltas at the current extremities is larger than the local gradient,
            // we have reached the side of the edge.
            reached1 = abs(lumaEnd1) >= gradientScaled;
            reached2 = abs(lumaEnd2) >= gradientScaled;
            reachedBoth = reached1 && reached2;

            // If the side is not reached, we continue to explore in this direction,
            // with a variable quality.
            if(!reached1){
                uv1 -= offset * QUALITY(i);
            }
            if(!reached2){
                uv2 += offset * QUALITY(i);
            }

            // If both sides have been reached, stop the exploration.
            if(reachedBoth){
                break;
            }
        }
    }

    // Compute the distances to each side edge of the edge (!).
    float distance1 = isHorizontal ? (coords.x - uv1.x) : (coords.y - uv1.y);
    float distance2 = isHorizontal ? (uv2.x - coords.x) : (uv2.y - coords.y);

    // In which direction is the side of the edge closer ?
    bool isDirection1 = distance1 < distance2;
    float distanceFinal = min(distance1, distance2);

    // Thickness of the edge.
    float edgeThickness = (distance1 + distance2);

    // Is the luma at center smaller than the local average ?
    bool isLumaCenterSmaller = lumaCenter < lumaLocalAverage;

    // If the luma at center is smaller than at its neighbour,
    // the delta luma at each end should be positive (same variation).
    bool correctVariation1 = (lumaEnd1 < 0.0) != isLumaCenterSmaller;
    bool correctVariation2 = (lumaEnd2 < 0.0) != isLumaCenterSmaller;

    // Only keep the result in the direction of the closer side of the edge.
    bool correctVariation = isDirection1 ? correctVariation1 : correctVariation2;

    // UV offset: read in the direction of the closest side of the edge.
    float pixelOffset = - distanceFinal / edgeThickness + 0.5;

    // If the luma variation is incorrect, do not offset.
    float finalOffset = correctVariation ? pixelOffset : 0.0;

    // Sub-pixel shifting
    // Full weighted average of the luma over the 3x3 neighborhood.
    float lumaAverage = (1.0 / 12.0) * (2.0 * (lumaDownUp + lumaLeftRight) + lumaLeftCorners + lumaRightCorners);
    // Ratio of the delta between the global average and the center luma,
    // over the luma range in the 3x3 neighborhood.
    float subPixelOffset1 = clamp(abs(lumaAverage - lumaCenter) / lumaRange, 0.0, 1.0);
    float subPixelOffset2 = (-2.0 * subPixelOffset1 + 3.0) * subPixelOffset1 * subPixelOffset1;
    // Compute a sub-pixel offset based on this delta.
    float subPixelOffsetFinal = subPixelOffset2 * subPixelOffset2 * float(dSubpixelQuality);

    // Pick the biggest of the two offsets.
    finalOffset = max(finalOffset, subPixelOffsetFinal);

    // Compute the final UV coordinates.
    vec2 finalUv = coords;
    if(isHorizontal){
        finalUv.y += finalOffset * stepLength;
    } else {
        finalUv.x += finalOffset * stepLength;
    }

    // Read the color at the new UV coordinates, and use it.
    gl_FragColor = texture2D(tColor, finalUv);
}
`;var FQ={edgeThresholdMin:g.Numeric(.0312,{min:.0312,max:.0833,step:1e-4},{description:"Trims the algorithm from processing darks."}),edgeThresholdMax:g.Numeric(.063,{min:.063,max:.333,step:.001},{description:"The minimum amount of local contrast required to apply algorithm."}),iterations:g.Numeric(12,{min:0,max:16,step:1},{description:"Number of edge exploration steps."}),subpixelQuality:g.Numeric(.3,{min:0,max:1,step:.01},{description:"Choose the amount of sub-pixel aliasing removal."})},$w=class{constructor(e,r){this.webgl=e,this.renderable=oCe(e,r)}updateState(e){let{gl:r,state:n}=this.webgl;n.enable(r.SCISSOR_TEST),n.disable(r.BLEND),n.disable(r.DEPTH_TEST),n.depthMask(!1);let{x:o,y:i,width:a,height:s}=e;n.viewport(o,i,a,s),n.scissor(o,i,a,s),n.clearColor(0,0,0,1),r.clear(r.COLOR_BUFFER_BIT)}setSize(e,r){C.update(this.renderable.values.uTexSizeInv,ne.set(this.renderable.values.uTexSizeInv.ref.value,1/e,1/r))}update(e,r){let{values:n}=this.renderable,{edgeThresholdMin:o,edgeThresholdMax:i,iterations:a,subpixelQuality:s}=r,l=!1;n.tColor.ref.value!==e&&(C.update(this.renderable.values.tColor,e),l=!0),n.dEdgeThresholdMin.ref.value!==o&&(l=!0),C.updateIfChanged(n.dEdgeThresholdMin,o),n.dEdgeThresholdMax.ref.value!==i&&(l=!0),C.updateIfChanged(n.dEdgeThresholdMax,i),n.dIterations.ref.value!==a&&(l=!0),C.updateIfChanged(n.dIterations,a),n.dSubpixelQuality.ref.value!==s&&(l=!0),C.updateIfChanged(n.dSubpixelQuality,s),l&&this.renderable.update()}render(e,r){Ee&&this.webgl.timer.mark("FxaaPass.render"),r?r.bind():this.webgl.unbindFramebuffer(),this.updateState(e),this.renderable.render(),Ee&&this.webgl.timer.markEnd("FxaaPass.render")}},rCe=U(w({},Er),{tColor:We("texture","rgba","ubyte","linear"),uTexSizeInv:ee("v2"),dEdgeThresholdMin:Ye("number"),dEdgeThresholdMax:Ye("number"),dIterations:Ye("number"),dSubpixelQuality:Ye("number")}),nCe=Qt("fxaa",zr,OQ);function oCe(t,e){let r=e.getWidth(),n=e.getHeight(),o=U(w({},Ir),{tColor:C.create(e),uTexSizeInv:C.create(ne.create(1/r,1/n)),dEdgeThresholdMin:C.create(.0312),dEdgeThresholdMax:C.create(.125),dIterations:C.create(12),dSubpixelQuality:C.create(.3)}),i=w({},rCe),a=dr(t,"triangles",nCe,i,o);return mr(a,o)}var NQ=`
precision highp float;

attribute vec2 aPosition;
uniform vec2 uQuadScale;

uniform vec2 uTexSizeInv;
uniform vec4 uViewport;

varying vec2 vUv;
varying vec4 vOffset[2];

void SMAANeighborhoodBlendingVS(vec2 texCoord) {
    vOffset[0] = texCoord.xyxy + uTexSizeInv.xyxy * vec4(-1.0, 0.0, 0.0, 1.0); // WebGL port note: Changed sign in W component
    vOffset[1] = texCoord.xyxy + uTexSizeInv.xyxy * vec4(1.0, 0.0, 0.0, -1.0); // WebGL port note: Changed sign in W component
}

void main() {
    vec2 scale = uViewport.zw * uTexSizeInv;
    vec2 shift = uViewport.xy * uTexSizeInv;
    vUv = (aPosition + 1.0) * 0.5 * scale + shift;
    SMAANeighborhoodBlendingVS(vUv);
    vec2 position = aPosition * uQuadScale - vec2(1.0, 1.0) + uQuadScale;
    gl_Position = vec4(position, 0.0, 1.0);
}
`;var VQ=`
precision highp float;
precision highp int;
precision highp sampler2D;

uniform sampler2D tWeights;
uniform sampler2D tColor;
uniform vec2 uTexSizeInv;

varying vec2 vUv;
varying vec4 vOffset[2];

vec4 SMAANeighborhoodBlendingPS(vec2 texCoord, vec4 offset[2], sampler2D colorTex, sampler2D blendTex) {
    // Fetch the blending weights for current pixel:
    vec4 a;
    a.xz = texture2D(blendTex, texCoord).xz;
    a.y = texture2D(blendTex, offset[1].zw).g;
    a.w = texture2D(blendTex, offset[1].xy).a;

    // Is there any blending weight with a value greater than 0.0?
    if (dot(a, vec4(1.0, 1.0, 1.0, 1.0)) < 1e-5) {
        return texture2D(colorTex, texCoord, 0.0);
    } else {
        // Up to 4 lines can be crossing a pixel (one through each edge). We
        // favor blending by choosing the line with the maximum weight for each
        // direction:
        vec2 offset;
        offset.x = a.a > a.b ? a.a : -a.b; // left vs. right
        offset.y = a.g > a.r ? -a.g : a.r; // top vs. bottom // WebGL port note: Changed signs

        // Then we go in the direction that has the maximum weight:
        if (abs(offset.x) > abs(offset.y)) { // horizontal vs. vertical
            offset.y = 0.0;
        } else {
            offset.x = 0.0;
        }

        // Fetch the opposite color and lerp by hand:
        vec4 C = texture2D(colorTex, texCoord, 0.0);
        texCoord += sign(offset) * uTexSizeInv;
        vec4 Cop = texture2D(colorTex, texCoord, 0.0);
        float s = abs(offset.x) > abs(offset.y) ? abs(offset.x) : abs(offset.y);

        // WebGL port note: Added gamma correction
        C.xyz = pow(C.xyz, vec3(2.2));
        Cop.xyz = pow(Cop.xyz, vec3(2.2));
        vec4 mixed = mix(C, Cop, s);
        mixed.xyz = pow(mixed.xyz, vec3(1.0 / 2.2));

        return mixed;
    }
}

void main() {
    gl_FragColor = SMAANeighborhoodBlendingPS(vUv, vOffset, tColor, tWeights);
}
`;var zQ=`
precision highp float;

attribute vec2 aPosition;
uniform vec2 uQuadScale;

uniform vec2 uTexSizeInv;
uniform vec4 uViewport;

varying vec2 vUv;
varying vec4 vOffset[3];
varying vec2 vPixCoord;

void SMAABlendingWeightCalculationVS(vec2 texCoord) {
    vPixCoord = texCoord / uTexSizeInv;

    // We will use these offsets for the searches later on (see @PSEUDO_GATHER4):
    vOffset[0] = texCoord.xyxy + uTexSizeInv.xyxy * vec4(-0.25, 0.125, 1.25, 0.125); // WebGL port note: Changed sign in Y and W components
    vOffset[1] = texCoord.xyxy + uTexSizeInv.xyxy * vec4(-0.125, 0.25, -0.125, -1.25); // WebGL port note: Changed sign in Y and W components

    // And these for the searches, they indicate the ends of the loops:
    vOffset[2] = vec4(vOffset[0].xz, vOffset[1].yw) + vec4(-2.0, 2.0, -2.0, 2.0) * uTexSizeInv.xxyy * float(dMaxSearchSteps);
}

void main() {
    vec2 scale = uViewport.zw * uTexSizeInv;
    vec2 shift = uViewport.xy * uTexSizeInv;
    vUv = (aPosition + 1.0) * 0.5 * scale + shift;
    SMAABlendingWeightCalculationVS(vUv);
    vec2 position = aPosition * uQuadScale - vec2(1.0, 1.0) + uQuadScale;
    gl_Position = vec4(position, 0.0, 1.0);
}
`;var UQ=`
precision highp float;
precision highp int;
precision highp sampler2D;

#define SMAASampleLevelZeroOffset(tex, coord, offset) texture2D(tex, coord + float(offset) * uTexSizeInv, 0.0)

#define SMAA_AREATEX_MAX_DISTANCE 16
#define SMAA_AREATEX_PIXEL_SIZE (1.0 / vec2(160.0, 560.0))
#define SMAA_AREATEX_SUBTEX_SIZE (1.0 / 7.0)

uniform sampler2D tEdges;
uniform sampler2D tArea;
uniform sampler2D tSearch;
uniform vec2 uTexSizeInv;

varying vec2 vUv;
varying vec4 vOffset[3];
varying vec2 vPixCoord;

#if __VERSION__ == 100
    vec2 round(vec2 x) {
        return sign(x) * floor(abs(x) + 0.5);
    }
#endif

float SMAASearchLength(sampler2D searchTex, vec2 e, float bias, float scale) {
    // Not required if searchTex accesses are set to point:
    // float2 SEARCH_TEX_PIXEL_SIZE = 1.0 / float2(66.0, 33.0);
    // e = float2(bias, 0.0) + 0.5 * SEARCH_TEX_PIXEL_SIZE +
    //     e * float2(scale, 1.0) * float2(64.0, 32.0) * SEARCH_TEX_PIXEL_SIZE;
    e.r = bias + e.r * scale;
    return 255.0 * texture2D(searchTex, e, 0.0).r;
}

float SMAASearchXLeft(sampler2D edgesTex, sampler2D searchTex, vec2 texCoord, float end) {
    /**
     * @PSEUDO_GATHER4
     * This texCoord has been offset by (-0.25, -0.125) in the vertex shader to
     * sample between edge, thus fetching four edges in a row.
     * Sampling with different offsets in each direction allows to disambiguate
     * which edges are active from the four fetched ones.
     */
    vec2 e = vec2(0.0, 1.0);

    for (int i = 0; i < dMaxSearchSteps; i++) { // WebGL port note: Changed while to for
        e = texture2D( edgesTex, texCoord, 0.0).rg;
        texCoord -= vec2(2.0, 0.0) * uTexSizeInv;
        if (!(texCoord.x > end && e.g > 0.8281 && e.r == 0.0)) break;
    }

    // We correct the previous (-0.25, -0.125) offset we applied:
    texCoord.x += 0.25 * uTexSizeInv.x;

    // The searches are bias by 1, so adjust the coords accordingly:
    texCoord.x += uTexSizeInv.x;

    // Disambiguate the length added by the last step:
    texCoord.x += 2.0 * uTexSizeInv.x; // Undo last step
    texCoord.x -= uTexSizeInv.x * SMAASearchLength(searchTex, e, 0.0, 0.5);

    return texCoord.x;
}

float SMAASearchXRight(sampler2D edgesTex, sampler2D searchTex, vec2 texCoord, float end) {
    vec2 e = vec2( 0.0, 1.0 );

    for (int i = 0; i < dMaxSearchSteps; i++) { // WebGL port note: Changed while to for
        e = texture2D(edgesTex, texCoord, 0.0).rg;
        texCoord += vec2(2.0, 0.0) * uTexSizeInv;
        if (!(texCoord.x < end && e.g > 0.8281 && e.r == 0.0)) break;
    }

    texCoord.x -= 0.25 * uTexSizeInv.x;
    texCoord.x -= uTexSizeInv.x;
    texCoord.x -= 2.0 * uTexSizeInv.x;
    texCoord.x += uTexSizeInv.x * SMAASearchLength( searchTex, e, 0.5, 0.5 );

    return texCoord.x;
}

float SMAASearchYUp(sampler2D edgesTex, sampler2D searchTex, vec2 texCoord, float end) {
    vec2 e = vec2( 1.0, 0.0 );

    for (int i = 0; i < dMaxSearchSteps; i++) { // WebGL port note: Changed while to for
        e = texture2D(edgesTex, texCoord, 0.0).rg;
        texCoord += vec2(0.0, 2.0) * uTexSizeInv; // WebGL port note: Changed sign
        if (!(texCoord.y > end && e.r > 0.8281 && e.g == 0.0)) break;
    }

    texCoord.y -= 0.25 * uTexSizeInv.y; // WebGL port note: Changed sign
    texCoord.y -= uTexSizeInv.y; // WebGL port note: Changed sign
    texCoord.y -= 2.0 * uTexSizeInv.y; // WebGL port note: Changed sign
    texCoord.y += uTexSizeInv.y * SMAASearchLength(searchTex, e.gr, 0.0, 0.5); // WebGL port note: Changed sign

    return texCoord.y;
}

float SMAASearchYDown(sampler2D edgesTex, sampler2D searchTex, vec2 texCoord, float end) {
    vec2 e = vec2( 1.0, 0.0 );

    for (int i = 0; i < dMaxSearchSteps; i++) { // WebGL port note: Changed while to for
        e = texture2D(edgesTex, texCoord, 0.0).rg;
        texCoord -= vec2( 0.0, 2.0 ) * uTexSizeInv; // WebGL port note: Changed sign
        if (!(texCoord.y < end && e.r > 0.8281 && e.g == 0.0)) break;
    }

    texCoord.y += 0.25 * uTexSizeInv.y; // WebGL port note: Changed sign
    texCoord.y += uTexSizeInv.y; // WebGL port note: Changed sign
    texCoord.y += 2.0 * uTexSizeInv.y; // WebGL port note: Changed sign
    texCoord.y -= uTexSizeInv.y * SMAASearchLength(searchTex, e.gr, 0.5, 0.5); // WebGL port note: Changed sign

    return texCoord.y;
}

vec2 SMAAArea(sampler2D areaTex, vec2 dist, float e1, float e2, float offset) {
    // Rounding prevents precision errors of bilinear filtering:
    vec2 texCoord = float(SMAA_AREATEX_MAX_DISTANCE) * round(4.0 * vec2(e1, e2)) + dist;

    // We do a scale and bias for mapping to texel space:
    texCoord = SMAA_AREATEX_PIXEL_SIZE * texCoord + (0.5 * SMAA_AREATEX_PIXEL_SIZE);

    // Move to proper place, according to the subpixel offset:
    texCoord.y += SMAA_AREATEX_SUBTEX_SIZE * offset;

    return texture2D(areaTex, texCoord, 0.0).rg;
}

vec4 SMAABlendingWeightCalculationPS(vec2 texCoord, vec2 pixCoord, vec4 offset[3], sampler2D edgesTex, sampler2D areaTex, sampler2D searchTex, ivec4 subsampleIndices) {
    vec4 weights = vec4(0.0, 0.0, 0.0, 0.0);

    vec2 e = texture2D(edgesTex, texCoord).rg;

    if (e.g > 0.0) { // Edge at north
        vec2 d;

        // Find the distance to the left:
        vec2 coords;
        coords.x = SMAASearchXLeft(edgesTex, searchTex, offset[0].xy, offset[2].x );
        coords.y = offset[1].y; // offset[1].y = texCoord.y - 0.25 * uTexSizeInv.y (@CROSSING_OFFSET)
        d.x = coords.x;

        // Now fetch the left crossing edges, two at a time using bilinear
        // filtering. Sampling at -0.25 (see @CROSSING_OFFSET) enables to
        // discern what value each edge has:
        float e1 = texture2D(edgesTex, coords, 0.0).r;

        // Find the distance to the right:
        coords.x = SMAASearchXRight(edgesTex, searchTex, offset[0].zw, offset[2].y);
        d.y = coords.x;

        // We want the distances to be in pixel units (doing this here allow to
        // better interleave arithmetic and memory accesses):
        d = d / uTexSizeInv.x - pixCoord.x;

        // SMAAArea below needs a sqrt, as the areas texture is compressed
        // quadratically:
        vec2 sqrt_d = sqrt(abs(d));

        // Fetch the right crossing edges:
        coords.y -= 1.0 * uTexSizeInv.y; // WebGL port note: Added
        float e2 = SMAASampleLevelZeroOffset(edgesTex, coords, ivec2(1, 0)).r;

        // Ok, we know how this pattern looks like, now it is time for getting
        // the actual area:
        weights.rg = SMAAArea(areaTex, sqrt_d, e1, e2, float(subsampleIndices.y));
    }

    if (e.r > 0.0) { // Edge at west
        vec2 d;

        // Find the distance to the top:
        vec2 coords;

        coords.y = SMAASearchYUp(edgesTex, searchTex, offset[1].xy, offset[2].z );
        coords.x = offset[0].x; // offset[1].x = texCoord.x - 0.25 * uTexSizeInv.x;
        d.x = coords.y;

        // Fetch the top crossing edges:
        float e1 = texture2D(edgesTex, coords, 0.0).g;

        // Find the distance to the bottom:
        coords.y = SMAASearchYDown(edgesTex, searchTex, offset[1].zw, offset[2].w);
        d.y = coords.y;

        // We want the distances to be in pixel units:
        d = d / uTexSizeInv.y - pixCoord.y;

        // SMAAArea below needs a sqrt, as the areas texture is compressed
        // quadratically:
        vec2 sqrt_d = sqrt(abs(d));

        // Fetch the bottom crossing edges:
        coords.y -= 1.0 * uTexSizeInv.y; // WebGL port note: Added
        float e2 = SMAASampleLevelZeroOffset(edgesTex, coords, ivec2(0, 1)).g;

        // Get the area for this direction:
        weights.ba = SMAAArea(areaTex, sqrt_d, e1, e2, float(subsampleIndices.x));
    }

    return weights;
}

void main() {
    gl_FragColor = SMAABlendingWeightCalculationPS(vUv, vPixCoord, vOffset, tEdges, tArea, tSearch, ivec4(0.0));
}
`;var GQ=`
precision highp float;

attribute vec2 aPosition;
uniform vec2 uQuadScale;

uniform vec2 uTexSizeInv;
uniform vec4 uViewport;

varying vec2 vUv;
varying vec4 vOffset[3];

void SMAAEdgeDetectionVS(vec2 texCoord) {
    vOffset[0] = texCoord.xyxy + uTexSizeInv.xyxy * vec4(-1.0, 0.0, 0.0, 1.0); // WebGL port note: Changed sign in W component
    vOffset[1] = texCoord.xyxy + uTexSizeInv.xyxy * vec4(1.0, 0.0, 0.0, -1.0); // WebGL port note: Changed sign in W component
    vOffset[2] = texCoord.xyxy + uTexSizeInv.xyxy * vec4(-2.0, 0.0, 0.0, 2.0); // WebGL port note: Changed sign in W component
}

void main() {
    vec2 scale = uViewport.zw * uTexSizeInv;
    vec2 shift = uViewport.xy * uTexSizeInv;
    vUv = (aPosition + 1.0) * 0.5 * scale + shift;
    SMAAEdgeDetectionVS(vUv);
    vec2 position = aPosition * uQuadScale - vec2(1.0, 1.0) + uQuadScale;
    gl_Position = vec4(position, 0.0, 1.0);
}
`;var jQ=`
precision highp float;
precision highp int;
precision highp sampler2D;

uniform sampler2D tColor;
uniform vec2 uTexSizeInv;

varying vec2 vUv;
varying vec4 vOffset[3];

vec4 SMAAColorEdgeDetectionPS(vec2 texcoord, vec4 offset[3], sampler2D colorTex) {
    vec2 threshold = vec2(dEdgeThreshold, dEdgeThreshold);

    // Calculate color deltas:
    vec4 delta;
    vec3 C = texture2D(colorTex, texcoord).rgb;

    vec3 Cleft = texture2D(colorTex, offset[0].xy).rgb;
    vec3 t = abs(C - Cleft);
    delta.x = max(max(t.r, t.g), t.b);

    vec3 Ctop = texture2D(colorTex, offset[0].zw).rgb;
    t = abs(C - Ctop);
    delta.y = max(max(t.r, t.g), t.b);

    // We do the usual threshold:
    vec2 edges = step(threshold, delta.xy);

    // Then discard if there is no edge:
    if (dot(edges, vec2(1.0, 1.0 )) == 0.0)
        discard;

    // Calculate right and bottom deltas:
    vec3 Cright = texture2D(colorTex, offset[1].xy).rgb;
    t = abs( C - Cright );
    delta.z = max(max(t.r, t.g), t.b);

    vec3 Cbottom  = texture2D(colorTex, offset[1].zw).rgb;
    t = abs(C - Cbottom);
    delta.w = max(max(t.r, t.g), t.b);

    // Calculate the maximum delta in the direct neighborhood:
    float maxDelta = max(max(max(delta.x, delta.y), delta.z), delta.w );

    // Calculate left-left and top-top deltas:
    vec3 Cleftleft  = texture2D(colorTex, offset[2].xy).rgb;
    t = abs( C - Cleftleft );
    delta.z = max(max(t.r, t.g), t.b);

    vec3 Ctoptop = texture2D(colorTex, offset[2].zw).rgb;
    t = abs(C - Ctoptop);
    delta.w = max(max(t.r, t.g), t.b);

    // Calculate the final maximum delta:
    maxDelta = max(max(maxDelta, delta.z), delta.w);

    // Local contrast adaptation in action:
    edges.xy *= step(0.5 * maxDelta, delta.xy);

    return vec4(edges, 0.0, 0.0);
}

void main() {
    gl_FragColor = SMAAColorEdgeDetectionPS(vUv, vOffset, tColor);
}
`;var HQ={edgeThreshold:g.Numeric(.1,{min:.05,max:.15,step:.01}),maxSearchSteps:g.Numeric(16,{min:0,max:32,step:1})},Zw=class{get supported(){return this._supported}constructor(e,r){if(this.webgl=e,this._supported=!1,typeof HTMLImageElement>"u"){ht&&console.log('Missing "HTMLImageElement" required for "SMAA"');return}let n=r.getWidth(),o=r.getHeight();this.edgesTarget=e.createRenderTarget(n,o,!1,"uint8","linear"),this.weightsTarget=e.createRenderTarget(n,o,!1,"uint8","linear"),this.edgesRenderable=sCe(e,r),this.weightsRenderable=uCe(e,this.edgesTarget.texture),this.blendRenderable=pCe(e,r,this.weightsTarget.texture),this._supported=!0}updateState(e){let{gl:r,state:n}=this.webgl;n.enable(r.SCISSOR_TEST),n.disable(r.BLEND),n.disable(r.DEPTH_TEST),n.depthMask(!1);let{x:o,y:i,width:a,height:s}=e;n.viewport(o,i,a,s),n.scissor(o,i,a,s),n.colorMask(!0,!0,!0,!0),n.clearColor(0,0,0,1),r.clear(r.COLOR_BUFFER_BIT),C.update(this.edgesRenderable.values.uViewport,_n.toVec4(this.edgesRenderable.values.uViewport.ref.value,e)),C.update(this.weightsRenderable.values.uViewport,_n.toVec4(this.weightsRenderable.values.uViewport.ref.value,e)),C.update(this.blendRenderable.values.uViewport,_n.toVec4(this.blendRenderable.values.uViewport.ref.value,e))}setSize(e,r){let n=this.edgesTarget.getWidth(),o=this.edgesTarget.getHeight();(e!==n||r!==o)&&(this.edgesTarget.setSize(e,r),this.weightsTarget.setSize(e,r),C.update(this.edgesRenderable.values.uTexSizeInv,ne.set(this.edgesRenderable.values.uTexSizeInv.ref.value,1/e,1/r)),C.update(this.weightsRenderable.values.uTexSizeInv,ne.set(this.weightsRenderable.values.uTexSizeInv.ref.value,1/e,1/r)),C.update(this.blendRenderable.values.uTexSizeInv,ne.set(this.blendRenderable.values.uTexSizeInv.ref.value,1/e,1/r)))}update(e,r){let n=!1;this.edgesRenderable.values.tColor.ref.value!==e&&(C.update(this.edgesRenderable.values.tColor,e),n=!0),this.edgesRenderable.values.dEdgeThreshold.ref.value!==r.edgeThreshold&&(C.update(this.edgesRenderable.values.dEdgeThreshold,r.edgeThreshold),n=!0),n&&this.edgesRenderable.update(),this.weightsRenderable.values.dMaxSearchSteps.ref.value!==r.maxSearchSteps&&(C.update(this.weightsRenderable.values.dMaxSearchSteps,r.maxSearchSteps),this.weightsRenderable.update()),this.blendRenderable.values.tColor.ref.value!==e&&(C.update(this.blendRenderable.values.tColor,e),this.blendRenderable.update())}render(e,r){Ee&&this.webgl.timer.mark("SmaaPass.render"),this.edgesTarget.bind(),this.updateState(e),this.edgesRenderable.render(),this.weightsTarget.bind(),this.updateState(e),this.weightsRenderable.render(),r?r.bind():this.webgl.unbindFramebuffer(),this.updateState(e),this.blendRenderable.render(),Ee&&this.webgl.timer.markEnd("SmaaPass.render")}},iCe=U(w({},Er),{tColor:We("texture","rgba","ubyte","linear"),uTexSizeInv:ee("v2"),uViewport:ee("v4"),dEdgeThreshold:Ye("number")}),aCe=Qt("smaa-edges",GQ,jQ);function sCe(t,e){let r=e.getWidth(),n=e.getHeight(),o=U(w({},Ir),{tColor:C.create(e),uTexSizeInv:C.create(ne.create(1/r,1/n)),uViewport:C.create(at()),dEdgeThreshold:C.create(.1)}),i=w({},iCe),a=dr(t,"triangles",aCe,i,o);return mr(a,o)}var lCe=U(w({},Er),{tEdges:We("texture","rgba","ubyte","linear"),tArea:We("texture","rgb","ubyte","linear"),tSearch:We("texture","rgba","ubyte","nearest"),uTexSizeInv:ee("v2"),uViewport:ee("v4"),dMaxSearchSteps:Ye("number")}),cCe=Qt("smaa-weights",zQ,UQ);function uCe(t,e){let r=e.getWidth(),n=e.getHeight(),o=t.resources.texture("image-uint8","rgb","ubyte","linear"),i=t.resources.texture("image-uint8","rgba","ubyte","nearest"),a=U(w({},Ir),{tEdges:C.create(e),tArea:C.create(o),tSearch:C.create(i),uTexSizeInv:C.create(ne.create(1/r,1/n)),uViewport:C.create(at()),dMaxSearchSteps:C.create(16)});jA(fCe(),a.tArea,o),jA(hCe(),a.tSearch,i);let s=w({},lCe),l=dr(t,"triangles",cCe,s,a);return mr(l,a)}var dCe=U(w({},Er),{tColor:We("texture","rgba","ubyte","linear"),tWeights:We("texture","rgba","ubyte","linear"),uTexSizeInv:ee("v2"),uViewport:ee("v4")}),mCe=Qt("smaa-blend",NQ,VQ);function pCe(t,e,r){let n=e.getWidth(),o=e.getHeight(),i=U(w({},Ir),{tColor:C.create(e),tWeights:C.create(r),uTexSizeInv:C.create(ne.create(1/n,1/o)),uViewport:C.create(at())}),a=w({},dCe),s=dr(t,"triangles",mCe,a,i);return mr(s,i)}function fCe(){return"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKAAAAIwCAIAAACOVPcQAACBeklEQVR42u39W4xlWXrnh/3WWvuciIzMrKxrV8/0rWbY0+SQFKcb4owIkSIFCjY9AC1BT/LYBozRi+EX+cV+8IMsYAaCwRcBwjzMiw2jAWtgwC8WR5Q8mDFHZLNHTarZGrLJJllt1W2qKrsumZWZcTvn7L3W54e1vrXX3vuciLPPORFR1XE2EomorB0nVuz//r71re/y/1eMvb4Cb3N11xV/PP/2v4UBAwJG/7H8urx6/25/Gf8O5hypMQ0EEEQwAqLfoN/Z+97f/SW+/NvcgQk4sGBJK6H7N4PFVL+K+e0N11yNfkKvwUdwdlUAXPHHL38oa15f/i/46Ih6SuMSPmLAYAwyRKn7dfMGH97jaMFBYCJUgotIC2YAdu+LyW9vvubxAP8kAL8H/koAuOKP3+q6+xGnd5kdYCeECnGIJViwGJMAkQKfDvB3WZxjLKGh8VSCCzhwEWBpMc5/kBbjawT4HnwJfhr+pPBIu7uu+OOTo9vsmtQcniMBGkKFd4jDWMSCRUpLjJYNJkM+IRzQ+PQvIeAMTrBS2LEiaiR9b/5PuT6Ap/AcfAFO4Y3dA3DFH7/VS+M8k4baEAQfMI4QfbVDDGIRg7GKaIY52qAjTAgTvGBAPGIIghOCYAUrGFNgzA7Q3QhgCwfwAnwe5vDejgG44o/fbm1C5ZlYQvQDARPAIQGxCWBM+wWl37ZQESb4gImexGMDouhGLx1Cst0Saa4b4AqO4Hk4gxo+3DHAV/nx27p3JziPM2pVgoiia5MdEzCGULprIN7gEEeQ5IQxEBBBQnxhsDb5auGmAAYcHMA9eAAz8PBol8/xij9+C4Djlim4gJjWcwZBhCBgMIIYxGAVIkH3ZtcBuLdtRFMWsPGoY9rN+HoBji9VBYdwD2ZQg4cnO7OSq/z4rU5KKdwVbFAjNojCQzTlCLPFSxtamwh2jMUcEgg2Wm/6XgErIBhBckQtGN3CzbVacERgCnfgLswhnvqf7QyAq/z4rRZm1YglYE3affGITaZsdIe2FmMIpnOCap25I6jt2kCwCW0D1uAD9sZctNGXcQIHCkINDQgc78aCr+zjtw3BU/ijdpw3zhCwcaONwBvdeS2YZKkJNJsMPf2JKEvC28RXxxI0ASJyzQCjCEQrO4Q7sFArEzjZhaFc4cdv+/JFdKULM4px0DfUBI2hIsy06BqLhGTQEVdbfAIZXYMPesq6VoCHICzUyjwInO4Y411//LYLs6TDa9wvg2CC2rElgAnpTBziThxaL22MYhzfkghz6GAs2VHbbdM91VZu1MEEpupMMwKyVTb5ij9+u4VJG/5EgEMMmFF01cFai3isRbKbzb+YaU/MQbAm2XSMoUPAmvZzbuKYRIFApbtlrfFuUGd6vq2hXNnH78ZLh/iFhsQG3T4D1ib7k5CC6vY0DCbtrohgLEIClXiGtl10zc0CnEGIhhatLBva7NP58Tvw0qE8yWhARLQ8h4+AhQSP+I4F5xoU+VilGRJs6wnS7ruti/4KvAY/CfdgqjsMy4pf8fodQO8/gnuX3f/3xi3om1/h7THr+co3x93PP9+FBUfbNUjcjEmhcrkT+8K7ml7V10Jo05mpIEFy1NmCJWx9SIKKt+EjAL4Ez8EBVOB6havuT/rByPvHXK+9zUcfcbb254+9fydJknYnRr1oGfdaiAgpxu1Rx/Rek8KISftx3L+DfsLWAANn8Hvw0/AFeAGO9DFV3c6D+CcWbL8Dj9e7f+T1k8AZv/d7+PXWM/Z+VvdCrIvuAKO09RpEEQJM0Ci6+B4xhTWr4cZNOvhktabw0ta0rSJmqz3Yw5/AKXwenod7cAhTmBSPKf6JBdvH8IP17h95pXqw50/+BFnj88fev4NchyaK47OPhhtI8RFSvAfDSNh0Ck0p2gLxGkib5NJj/JWCr90EWQJvwBzO4AHcgztwAFN1evHPUVGwfXON+0debT1YeGON9Yy9/63X+OguiwmhIhQhD7l4sMqlG3D86Suc3qWZ4rWjI1X7u0Ytw6x3rIMeIOPDprfe2XzNgyj6PahhBjO4C3e6puDgXrdg+/5l948vF3bqwZetZ+z9Rx9zdIY5pInPK4Nk0t+l52xdK2B45Qd87nM8fsD5EfUhIcJcERw4RdqqH7Yde5V7m1vhNmtedkz6EDzUMF/2jJYWbC+4fzzA/Y+/8PPH3j9dcBAPIRP8JLXd5BpAu03aziOL3VVHZzz3CXWDPWd+SH2AnxIqQoTZpo9Ckc6HIrFbAbzNmlcg8Ag8NFDDAhbJvTBZXbC94P7t68EXfv6o+21gUtPETU7bbkLxvNKRFG2+KXzvtObonPP4rBvsgmaKj404DlshFole1Glfh02fE7bYR7dZ82oTewIBGn1Md6CG6YUF26X376oevOLzx95vhUmgblI6LBZwTCDY7vMq0op5WVXgsObOXJ+1x3qaBl9j1FeLxbhU9w1F+Wiba6s1X/TBz1LnUfuYDi4r2C69f1f14BWfP+p+W2GFKuC9phcELMYRRLur9DEZTUdEH+iEqWdaM7X4WOoPGI+ZYD2+wcQ+y+ioHUZ9dTDbArzxmi/bJI9BND0Ynd6lBdve/butBw8+f/T9D3ABa3AG8W3VPX4hBin+bj8dMMmSpp5pg7fJ6xrBFE2WQQEWnV8Qg3FbAWzYfM1rREEnmvkN2o1+acG2d/9u68GDzx91v3mAjb1zkpqT21OipPKO0b9TO5W0nTdOmAQm0TObts3aBKgwARtoPDiCT0gHgwnbArzxmtcLc08HgF1asN0C4Ms/fvD5I+7PhfqyXE/b7RbbrGyRQRT9ARZcwAUmgdoz0ehJ9Fn7QAhUjhDAQSw0bV3T3WbNa59jzmiP6GsWbGXDX2ytjy8+f9T97fiBPq9YeLdBmyuizZHaqXITnXiMUEEVcJ7K4j3BFPurtB4bixW8wTpweL8DC95szWMOqucFYGsWbGU7p3TxxxefP+r+oTVktxY0v5hbq3KiOKYnY8ddJVSBxuMMVffNbxwIOERShst73HZ78DZrHpmJmH3K6sGz0fe3UUj0eyRrSCGTTc+rjVNoGzNSv05srAxUBh8IhqChiQgVNIIBH3AVPnrsnXQZbLTm8ammv8eVXn/vWpaTem5IXRlt+U/LA21zhSb9cye6jcOfCnOwhIAYXAMVTUNV0QhVha9xjgA27ODJbLbmitt3tRN80lqG6N/khgot4ZVlOyO4WNg3OIMzhIZQpUEHieg2im6F91hB3I2tubql6BYNN9Hj5S7G0G2tahslBWKDnOiIvuAEDzakDQKDNFQT6gbn8E2y4BBubM230YIpBnDbMa+y3dx0n1S0BtuG62lCCXwcY0F72T1VRR3t2ONcsmDjbmzNt9RFs2LO2hQNyb022JisaI8rAWuw4HI3FuAIhZdOGIcdjLJvvObqlpqvWTJnnQbyi/1M9O8UxWhBs//H42I0q1Yb/XPGONzcmm+ri172mHKvZBpHkJaNJz6v9jxqiklDj3U4CA2ugpAaYMWqNXsdXbmJNd9egCnJEsphXNM+MnK3m0FCJ5S1kmJpa3DgPVbnQnPGWIDspW9ozbcO4K/9LkfaQO2KHuqlfFXSbdNzcEcwoqNEFE9zcIXu9/6n/ym/BC/C3aJLzEKPuYVlbFnfhZ8kcWxV3dbv4bKl28566wD+8C53aw49lTABp9PWbsB+knfc/Li3eVizf5vv/xmvnPKg5ihwKEwlrcHqucuVcVOxEv8aH37E3ZqpZypUulrHEtIWKUr+txHg+ojZDGlwnqmkGlzcVi1dLiNSJiHjfbRNOPwKpx9TVdTn3K05DBx4psIk4Ei8aCkJahRgffk4YnEXe07T4H2RR1u27E6wfQsBDofUgjFUFnwC2AiVtA+05J2zpiDK2Oa0c5fmAecN1iJzmpqFZxqYBCYhFTCsUNEmUnIcZ6aEA5rQVhEywG6w7HSW02XfOoBlQmjwulOFQAg66SvJblrTEX1YtJ3uG15T/BH1OfOQeuR8g/c0gdpT5fx2SKbs9EfHTKdM8A1GaJRHLVIwhcGyydZsbifAFVKl5EMKNU2Hryo+06BeTgqnxzYjThVySDikbtJPieco75lYfKAJOMEZBTjoITuWHXXZVhcUDIS2hpiXHV9Ku4u44bN5OYLDOkJo8w+xJSMbhBRHEdEs9JZUCkQrPMAvaHyLkxgkEHxiNkx/x2YB0mGsQ8EUWj/stW5YLhtS5SMu+/YBbNPDCkGTUybN8krRLBGPlZkVOA0j+a1+rkyQKWGaPHPLZOkJhioQYnVZ2hS3zVxMtgC46KuRwbJNd9nV2PHgb36F194ecf/Yeu2vAFe5nm/bRBFrnY4BauE8ERmZRFUn0k8hbftiVYSKMEme2dJCJSCGYAlNqh87bXOPdUkGy24P6d1ll21MBqqx48Fvv8ZHH8HZFY7j/uAq1xMJUFqCSUlJPmNbIiNsmwuMs/q9CMtsZsFO6SprzCS1Z7QL8xCQClEelpjTduDMsmWD8S1PT152BtvmIGvUeDA/yRn83u/x0/4qxoPHjx+PXY9pqX9bgMvh/Nz9kpP4pOe1/fYf3axUiMdHLlPpZCNjgtNFAhcHEDxTumNONhHrBduW+vOyY++70WWnPXj98eA4kOt/mj/5E05l9+O4o8ePx67HFqyC+qSSnyselqjZGaVK2TadbFLPWAQ4NBhHqDCCV7OTpo34AlSSylPtIdd2AJZlyzYQrDJ5lcWGNceD80CunPLGGzsfD+7wRb95NevJI5docQ3tgCyr5bGnyaPRlmwNsFELViOOx9loebGNq2moDOKpHLVP5al2cymWHbkfzGXL7kfRl44H9wZy33tvt+PB/Xnf93e+nh5ZlU18wCiRUa9m7kib9LYuOk+hudQNbxwm0AQqbfloimaB2lM5fChex+ylMwuTbfmXQtmWlenZljbdXTLuOxjI/fDDHY4Hjx8/Hrse0zXfPFxbUN1kKqSCCSk50m0Ajtx3ub9XHBKHXESb8iO6E+qGytF4nO0OG3SXzbJlhxBnKtKyl0NwybjvYCD30aMdjgePHz8eu56SVTBbgxJMliQ3Oauwg0QHxXE2Ez/EIReLdQj42Gzb4CLS0YJD9xUx7bsi0vJi5mUbW1QzL0h0PFk17rtiIPfJk52MB48fPx67npJJwyrBa2RCCQRTbGZSPCxTPOiND4G2pYyOQ4h4jINIJh5wFU1NFZt+IsZ59LSnDqBjZ2awbOku+yInunLcd8VA7rNnOxkPHj9+PGY9B0MWJJNozOJmlglvDMXDEozdhQWbgs/U6oBanGzLrdSNNnZFjOkmbi5bNt1lX7JLLhn3vXAg9/h4y/Hg8ePHI9dzQMEkWCgdRfYykYKnkP7D4rIujsujaKPBsB54vE2TS00ccvFY/Tth7JXeq1hz+qgVy04sAJawTsvOknHfCwdyT062HA8eP348Zj0vdoXF4pilKa2BROed+9fyw9rWRXeTFXESMOanvDZfJuJaSXouQdMdDJZtekZcLLvEeK04d8m474UDuaenW44Hjx8/Xns9YYqZpszGWB3AN/4VHw+k7WSFtJ3Qicuqb/NlVmgXWsxh570xg2UwxUw3WfO6B5nOuO8aA7lnZxuPB48fPx6znm1i4bsfcbaptF3zNT78eFPtwi1OaCNOqp1x3zUGcs/PN++AGD1+fMXrSVm2baTtPhPahbPhA71wIHd2bXzRa69nG+3CraTtPivahV/55tXWg8fyRY/9AdsY8VbSdp8V7cKrrgdfM//z6ILQFtJ2nxHtwmuoB4/kf74+gLeRtvvMaBdeSz34+vifx0YG20jbfTa0C6+tHrwe//NmOG0L8EbSdp8R7cLrrQe/996O+ai3ujQOskpTNULa7jOjXXj99eCd8lHvoFiwsbTdZ0a78PrrwTvlo966pLuRtB2fFe3Cm6oHP9kNH/W2FryxtN1nTLvwRurBO+Kj3pWXHidtx2dFu/Bm68Fb81HvykuPlrb7LGkX3mw9eGs+6h1Y8MbSdjegXcguQLjmevDpTQLMxtJ2N6NdyBZu9AbrwVvwUW+LbteULUpCdqm0HTelXbhNPe8G68Gb8lFvVfYfSNuxvrTdTWoXbozAzdaDZzfkorOj1oxVxlIMlpSIlpLrt8D4hrQL17z+c3h6hU/wv4Q/utps4+bm+6P/hIcf0JwQ5oQGPBL0eKPTYEXTW+eL/2DKn73J9BTXYANG57hz1cEMviVf/4tf5b/6C5pTQkMIWoAq7hTpOJjtAM4pxKu5vg5vXeUrtI09/Mo/5H+4z+Mp5xULh7cEm2QbRP2tFIKR7WM3fPf/jZ3SWCqLM2l4NxID5zB72HQXv3jj/8mLR5xXNA5v8EbFQEz7PpRfl1+MB/hlAN65qgDn3wTgH13hK7T59bmP+NIx1SHHU84nLOITt3iVz8mNO+lPrjGAnBFqmioNn1mTyk1ta47R6d4MrX7tjrnjYUpdUbv2rVr6YpVfsGG58AG8Ah9eyUN8CX4WfgV+G8LVWPDGb+Zd4cU584CtqSbMKxauxTg+dyn/LkVgA+IR8KHtejeFKRtTmLLpxN6mYVLjYxwXf5x2VofiZcp/lwKk4wGOpYDnoIZPdg/AAbwMfx0+ge9dgZvYjuqKe4HnGnykYo5TvJbG0Vj12JagRhwKa44H95ShkZa5RyLGGdfYvG7aw1TsF6iapPAS29mNS3NmsTQZCmgTzFwgL3upCTgtBTRwvGMAKrgLn4evwin8+afJRcff+8izUGUM63GOOuAs3tJkw7J4kyoNreqrpO6cYLQeFUd7TTpr5YOTLc9RUUogUOVJQ1GYJaFLAW0oTmKyYS46ZooP4S4EON3xQ5zC8/CX4CnM4c1PE8ApexpoYuzqlP3d4S3OJP8ZDK7cKWNaTlqmgDiiHwl1YsE41w1zT4iRTm3DBqxvOUsbMKKDa/EHxagtnta072ejc3DOIh5ojvh8l3tk1JF/AV6FU6jh3U8HwEazLgdCLYSQ+MYiAI2ltomkzttUb0gGHdSUUgsIYjTzLG3mObX4FBRaYtpDVNZrih9TgTeYOBxsEnN1gOCTM8Bsw/ieMc75w9kuAT6A+/AiHGvN/+Gn4KRkiuzpNNDYhDGFndWRpE6SVfm8U5bxnSgVV2jrg6JCKmneqey8VMFgq2+AM/i4L4RUbfSi27lNXZ7R7W9RTcq/q9fk4Xw3AMQd4I5ifAZz8FcVtm9SAom/dyN4lczJQW/kC42ZrHgcCoIf1oVMKkVItmMBi9cOeNHGLqOZk+QqQmrbc5YmYgxELUUN35z2iohstgfLIFmcMV7s4CFmI74L9+EFmGsi+tGnAOD4Yk9gIpo01Y4cA43BWGygMdr4YZekG3OBIUXXNukvJS8tqa06e+lSDCtnqqMFu6hWHXCF+WaYt64m9QBmNxi7Ioy7D+fa1yHw+FMAcPt7SysFLtoG4PXAk7JOA3aAxBRqUiAdU9Yp5lK3HLSRFtOim0sa8euEt08xvKjYjzeJ2GU7YawexrnKI9tmobInjFXCewpwriY9+RR4aaezFhMhGCppKwom0ChrgFlKzyPKkGlTW1YQrE9HJqu8hKGgMc6hVi5QRq0PZxNfrYNgE64utmRv6KKHRpxf6VDUaOvNP5jCEx5q185My/7RKz69UQu2im5k4/eownpxZxNLwiZ1AZTO2ZjWjkU9uaB2HFn6Q3u0JcsSx/qV9hTEApRzeBLDJQXxYmTnq7bdLa3+uqFrxLJ5w1TehnNHx5ECvCh2g2c3hHH5YsfdaSKddztfjQ6imKFGSyFwlLzxEGPp6r5IevVjk1AMx3wMqi1NxDVjLBiPs9tbsCkIY5we5/ML22zrCScFxnNtzsr9Wcc3CnD+pYO+4VXXiDE0oc/vQQ/fDK3oPESJMYXNmJa/DuloJZkcTpcYE8lIH8Dz8DJMiynNC86Mb2lNaaqP/+L7f2fcE/yP7/Lde8xfgSOdMxvOixZf/9p3+M4hT1+F+zApxg9XfUvYjc8qX2lfOOpK2gNRtB4flpFu9FTKCp2XJRgXnX6olp1zyYjTKJSkGmLE2NjUr1bxFM4AeAAHBUFIeSLqXR+NvH/M9fOnfHzOD2vCSyQJKzfgsCh+yi/Mmc35F2fUrw7miW33W9hBD1vpuUojFphIyvg7aTeoymDkIkeW3XLHmguMzbIAJejN6B5MDrhipE2y6SoFRO/AK/AcHHZHNIfiWrEe/C6cr3f/yOvrQKB+zMM55/GQdLDsR+ifr5Fiuu+/y+M78LzOE5dsNuXC3PYvYWd8NXvphLSkJIasrlD2/HOqQ+RjcRdjKTGWYhhVUm4yxlyiGPuMsZR7sMCHUBeTuNWA7if+ifXgc/hovftHXs/DV+Fvwe+f8shzMiMcweFgBly3//vwJfg5AN4450fn1Hd1Rm1aBLu22Dy3y3H2+OqMemkbGZ4jozcDjJf6596xOLpC0eMTHbKnxLxH27uZ/bMTGs2jOaMOY4m87CfQwF0dw53oa1k80JRuz/XgS+8fX3N9Af4qPIMfzKgCp4H5TDGe9GGeFPzSsZz80SlPTxXjgwJmC45njzgt2vbQ4b4OAdUK4/vWhO8d8v6EE8fMUsfakXbPpFJeLs2ubM/qdm/la3WP91uWhxXHjoWhyRUq2iJ/+5mA73zwIIo+LoZ/SgvIRjAd1IMvvn98PfgOvAJfhhm8scAKVWDuaRaK8aQ9f7vuPDH6Bj47ZXau7rqYJ66mTDwEDU6lLbCjCK0qTXyl5mnDoeNRxanj3FJbaksTk0faXxHxLrssgPkWB9LnA/MFleXcJozzjwsUvUG0X/QCve51qkMDXp9mtcyOy3rwBfdvVJK7D6/ACSzg3RoruIq5UDeESfEmVclDxnniU82vxMLtceD0hGZWzBNPMM/jSPne2OVatiTKUpY5vY7gc0LdUAWeWM5tH+O2I66AOWw9xT2BuyRVLGdoDHUsVRXOo/c+ZdRXvFfnxWyIV4upFLCl9eAL7h8Zv0QH8Ry8pA2cHzQpGesctVA37ZtklBTgHjyvdSeKY/RZw/kJMk0Y25cSNRWSigQtlULPTw+kzuJPeYEkXjQRpoGZobYsLF79pyd1dMRHInbgFTZqNLhDqiIsTNpoex2WLcy0/X6rHcdMMQvFSd5dWA++4P7xv89deACnmr36uGlL69bRCL6BSZsS6c0TU2TKK5gtWCzgAOOwQcurqk9j8whvziZSMLcq5hbuwBEsYjopUBkqw1yYBGpLA97SRElEmx5MCInBY5vgLk94iKqSWmhIGmkJ4Bi9m4L645J68LyY4wsFYBfUg5feP/6gWWm58IEmKQM89hq7KsZNaKtP5TxxrUZZVkNmMJtjbKrGxLNEbHPJxhqy7lAmbC32ZqeF6lTaknRWcYaFpfLUBh/rwaQycCCJmW15Kstv6jRHyJFry2C1ahkkIW0LO75s61+owxK1y3XqweX9m5YLM2DPFeOjn/iiqCKJ+yKXF8t5Yl/kNsqaSCryxPq5xWTFIaP8KSW0RYxqupaUf0RcTNSSdJZGcKYdYA6kdtrtmyBckfKXwqk0pHpUHlwWaffjNRBYFPUDWa8e3Lt/o0R0CdisKDM89cX0pvRHEfM8ca4t0s2Xx4kgo91MPQJ/0c9MQYq0co8MBh7bz1fio0UUHLR4aAIOvOmoYO6kwlEVODSSTliWtOtH6sPkrtctF9ZtJ9GIerBskvhdVS5cFNv9s1BU0AbdUgdK4FG+dRnjFmDTzniRMdZO1QhzMK355vigbdkpz9P6qjUGE5J2qAcXmwJ20cZUiAD0z+pGMx6xkzJkmEf40Hr4qZfVg2XzF9YOyoV5BjzVkUJngKf8lgNYwKECEHrCNDrWZzMlflS3yBhr/InyoUgBc/lKT4pxVrrC6g1YwcceK3BmNxZcAtz3j5EIpqguh9H6wc011YN75cKDLpFDxuwkrPQmUwW4KTbj9mZTwBwLq4aQMUZbHm1rylJ46dzR0dua2n3RYCWZsiHROeywyJGR7mXKlpryyCiouY56sFkBWEnkEB/raeh/Sw4162KeuAxMQpEkzy5alMY5wamMsWKKrtW2WpEWNnReZWONKWjrdsKZarpFjqCslq773PLmEhM448Pc3+FKr1+94vv/rfw4tEcu+lKTBe4kZSdijBrykwv9vbCMPcLQTygBjzVckSLPRVGslqdunwJ4oegtFOYb4SwxNgWLCmD7T9kVjTv5YDgpo0XBmN34Z/rEHp0sgyz7lngsrm4lvMm2Mr1zNOJYJ5cuxuQxwMGJq/TP5emlb8fsQBZviK4t8hFL+zbhtlpwaRSxQRWfeETjuauPsdGxsBVdO7nmP4xvzSoT29pRl7kGqz+k26B3Oy0YNV+SXbbQas1ctC/GarskRdFpKczVAF1ZXnLcpaMuzVe6lZ2g/1ndcvOVgRG3sdUAY1bKD6achijMPdMxV4muKVorSpiDHituH7rSTs7n/4y5DhRXo4FVBN4vO/zbAcxhENzGbHCzU/98Mcx5e7a31kWjw9FCe/zNeYyQjZsWb1uc7U33pN4Mji6hCLhivqfa9Ss6xLg031AgfesA/l99m9fgvnaF9JoE6bYKmkGNK3aPbHB96w3+DnxFm4hs0drLsk7U8kf/N/CvwQNtllna0rjq61sH8L80HAuvwH1tvBy2ChqWSCaYTaGN19sTvlfzFD6n+iKTbvtayfrfe9ueWh6GJFoxLdr7V72a5ZpvHcCPDzma0wTO4EgbLyedxstO81n57LYBOBzyfsOhUKsW1J1BB5vr/tz8RyqOFylQP9Tvst2JALsC5lsH8PyQ40DV4ANzYa4dedNiKNR1s+x2wwbR7q4/4cTxqEk4LWDebfisuo36JXLiWFjOtLrlNWh3K1rRS4xvHcDNlFnNmWBBAl5SWaL3oPOfnvbr5pdjVnEaeBJSYjuLEkyLLsWhKccadmOphZkOPgVdalj2QpSmfOsADhMWE2ZBu4+EEJI4wKTAuCoC4xwQbWXBltpxbjkXJtKxxabo9e7tyhlgb6gNlSbUpMh+l/FaqzVwewGu8BW1Zx7pTpQDJUjb8tsUTW6+GDXbMn3mLbXlXJiGdggxFAoUrtPS3wE4Nk02UZG2OOzlk7fRs7i95QCLo3E0jtrjnM7SR3uS1p4qtS2nJ5OwtQVHgOvArLBFijZUV9QtSl8dAY5d0E0hM0w3HS2DpIeB6m/A1+HfhJcGUq4sOxH+x3f5+VO+Ds9rYNI7zPXOYWPrtf8bYMx6fuOAX5jzNR0PdsuON+X1f7EERxMJJoU6GkTEWBvVolVlb5lh3tKCg6Wx1IbaMDdJ+9sUCc5KC46hKGCk3IVOS4TCqdBNfUs7Kd4iXf2RjnT/LLysJy3XDcHLh/vde3x8DoGvwgsa67vBk91G5Pe/HbOe7xwym0NXbtiuuDkGO2IJDh9oQvJ4cY4vdoqLDuoH9Zl2F/ofsekn8lkuhIlhQcffUtSjytFyp++p6NiE7Rqx/lodgKVoceEp/CP4FfjrquZaTtj2AvH5K/ywpn7M34K/SsoYDAdIN448I1/0/wveW289T1/lX5xBzc8N5IaHr0XMOQdHsIkDuJFifj20pBm5jzwUv9e2FhwRsvhAbalCIuIw3bhJihY3p6nTFFIZgiSYjfTf3aXuOjmeGn4bPoGvwl+CFzTRczBIuHBEeImHc37/lGfwZR0cXzVDOvaKfNHvwe+suZ771K/y/XcBlsoN996JpBhoE2toYxOznNEOS5TJc6Id5GEXLjrWo+LEWGNpPDU4WAwsIRROu+1vM+0oW37z/MBN9kqHnSArwPfgFJ7Cq/Ai3Ie7g7ncmI09v8sjzw9mzOAEXoIHxURueaAce5V80f/DOuuZwHM8vsMb5wBzOFWM7wymTXPAEvm4vcFpZ2ut0VZRjkiP2MlmLd6DIpbGSiHOjdnUHN90hRYmhTnmvhzp1iKDNj+b7t5hi79lWGwQ+HN9RsfFMy0FXbEwhfuczKgCbyxYwBmcFhhvo/7a44v+i3XWcwDP86PzpGQYdWh7csP5dBvZ1jNzdxC8pBGuxqSW5vw40nBpj5JhMwvOzN0RWqERHMr4Lv1kWX84xLR830G3j6yqZ1a8UstTlW+qJPOZ+sZ7xZPKTJLhiNOAFd6tk+jrTH31ncLOxid8+nzRb128HhUcru/y0Wn6iT254YPC6FtVSIMoW2sk727AhvTtrWKZTvgsmckfXYZWeNRXx/3YQ2OUxLDrbHtN11IwrgXT6c8dATDwLniYwxzO4RzuQqTKSC5gAofMZ1QBK3zQ4JWobFbcvJm87FK+6JXrKahLn54m3p+McXzzYtP8VF/QpJuh1OwieElEoI1pRxPS09FBrkq2tWCU59+HdhNtTIqKm8EBrw2RTOEDpG3IKo2Y7mFdLm3ZeVjYwVw11o/oznceMve4CgMfNym/utA/d/ILMR7gpXzRy9eDsgLcgbs8O2Va1L0zzIdwGGemTBuwROHeoMShkUc7P+ISY3KH5ZZeWqO8mFTxQYeXTNuzvvK5FGPdQfuu00DwYFY9dyhctEt+OJDdnucfpmyhzUJzfsJjr29l8S0bXBfwRS9ZT26tmMIdZucch5ZboMz3Nio3nIOsYHCGoDT4kUA9MiXEp9Xsui1S8th/kbWIrMBxDGLodWUQIWcvnXy+9M23xPiSMOiRPqM+YMXkUN3gXFrZJwXGzUaMpJfyRS9ZT0lPe8TpScuRlbMHeUmlaKDoNuy62iWNTWNFYjoxFzuJs8oR+RhRx7O4SVNSXpa0ZJQ0K1LAHDQ+D9IepkMXpcsq5EVCvClBUIzDhDoyKwDw1Lc59GbTeORivugw1IcuaEOaGWdNm+Ps5fQ7/tm0DjMegq3yM3vb5j12qUId5UZD2oxDSEWOZMSqFl/W+5oynWDa/aI04tJRQ2eTXusg86SQVu/nwSYwpW6wLjlqIzwLuxGIvoAvul0PS+ZNz0/akp/pniO/8JDnGyaCkzbhl6YcqmK/69prxPqtpx2+Km9al9sjL+rwMgHw4jE/C8/HQ3m1vBuL1fldbzd8mOueVJ92syqdEY4KJjSCde3mcRw2TA6szxedn+zwhZMps0XrqEsiUjnC1hw0TELC2Ek7uAAdzcheXv1BYLagspxpzSAoZZUsIzIq35MnFQ9DOrlNB30jq3L4pkhccKUAA8/ocvN1Rzx9QyOtERs4CVsJRK/DF71kPYrxYsGsm6RMh4cps5g1DOmM54Ly1ii0Hd3Y/BMk8VWFgBVmhqrkJCPBHAolwZaWzLR9Vb7bcWdX9NyUYE+uB2BKfuaeBUcjDljbYVY4DdtsVWvzRZdWnyUzDpjNl1Du3aloAjVJTNDpcIOVVhrHFF66lLfJL1zJr9PQ2nFJSBaKoDe+sAvLufZVHVzYh7W0h/c6AAZ+7Tvj6q9j68G/cTCS/3n1vLKHZwNi+P+pS0WkZNMBMUl+LDLuiE4omZy71r3UFMwNJV+VJ/GC5ixVUkBStsT4gGKh0Gm4Oy3qvq7Lbmq24nPdDuDR9deR11XzP4vFu3TYzfnIyiSVmgizUYGqkIXNdKTY9pgb9D2Ix5t0+NHkVzCdU03suWkkVZAoCONCn0T35gAeW38de43mf97sMOpSvj4aa1KYUm58USI7Wxxes03bAZdRzk6UtbzMaCQ6IxO0dy7X+XsjoD16hpsBeGz9dfzHj+R/Hp8nCxZRqkEDTaCKCSywjiaoMJ1TITE9eg7Jqnq8HL6gDwiZb0u0V0Rr/rmvqjxKuaLCX7ZWXTvAY+uvm3z8CP7nzVpngqrJpZKwWnCUjIviYVlirlGOzPLI3SMVyp/elvBUjjDkNhrtufFFErQ8pmdSlbK16toBHlt/HV8uHMX/vEGALkV3RJREiSlopxwdMXOZPLZ+ix+kAHpMKIk8UtE1ygtquttwxNhphrIZ1IBzjGF3IIGxGcBj6q8bHJBG8T9vdsoWrTFEuebEZuVxhhClH6P5Zo89OG9fwHNjtNQTpD0TG9PJLEYqvEY6Rlxy+ZZGfL0Aj62/bnQCXp//eeM4KzfQVJbgMQbUjlMFIm6TpcfWlZje7NBSV6IsEVmumWIbjiloUzQX9OzYdo8L1wjw2PrrpimONfmfNyzKklrgnEkSzT5QWYQW40YShyzqsRmMXbvVxKtGuYyMKaU1ugenLDm5Ily4iT14fP11Mx+xJv+zZ3MvnfdFqxU3a1W/FTB4m3Qfsyc1XUcdVhDeUDZXSFHHLQj/Y5jtC7ZqM0CXGwB4bP11i3LhOvzPGygYtiUBiwQV/4wFO0majijGsafHyRLu0yG6q35cL1rOpVxr2s5cM2jJYMCdc10Aj6q/blRpWJ//+dmm5psMl0KA2+AFRx9jMe2WbC4jQxnikd4DU8TwUjRVacgdlhmr3bpddzuJ9zXqr2xnxJfzP29RexdtjDVZqzkqa6PyvcojGrfkXiJ8SEtml/nYskicv0ivlxbqjemwUjMw5evdg8fUX9nOiC/lf94Q2i7MURk9nW1MSj5j8eAyV6y5CN2S6qbnw3vdA1Iwq+XOSCl663udN3IzLnrt+us25cI1+Z83SXQUldqQq0b5XOT17bGpLd6ssN1VMPf8c+jG8L3NeCnMdF+Ra3fRa9dft39/LuZ/3vwHoHrqGmQFafmiQw6eyzMxS05K4bL9uA+SKUQzCnSDkqOGokXyJvbgJ/BHI+qvY69//4rl20NsmK2ou2dTsyIALv/91/8n3P2Aao71WFGi8KKv1fRC5+J67Q/507/E/SOshqN5TsmYIjVt+kcjAx98iz/4SaojbIV1rexE7/C29HcYD/DX4a0rBOF5VTu7omsb11L/AWcVlcVZHSsqGuXLLp9ha8I//w3Mv+T4Ew7nTBsmgapoCrNFObIcN4pf/Ob/mrvHTGqqgAupL8qWjWPS9m/31jAe4DjA+4+uCoQoT/zOzlrNd3qd4SdphFxsUvYwGWbTWtISc3wNOWH+kHBMfc6kpmpwPgHWwqaSUG2ZWWheYOGQGaHB+eQ/kn6b3pOgLV+ODSn94wDvr8Bvb70/LLuiPPEr8OGVWfDmr45PZyccEmsVXZGe1pRNX9SU5+AVQkNTIVPCHF/jGmyDC9j4R9LfWcQvfiETmgMMUCMN1uNCakkweZsowdYobiMSlnKA93u7NzTXlSfe+SVbfnPQXmg9LpYAQxpwEtONyEyaueWM4FPjjyjG3uOaFmBTWDNgBXGEiQpsaWhnAqIijB07Dlsy3fUGeP989xbWkyf+FF2SNEtT1E0f4DYYVlxFlbaSMPIRMk/3iMU5pME2SIWJvjckciebkQuIRRyhUvkHg/iUljG5kzVog5hV7vIlCuBrmlhvgPfNHQM8lCf+FEGsYbMIBC0qC9a0uuy2wLXVbLBaP5kjHokCRxapkQyzI4QEcwgYHRZBp+XEFTqXFuNVzMtjXLJgX4gAid24Hjwc4N3dtVSe+NNiwTrzH4WVUOlDobUqr1FuAgYllc8pmzoVrELRHSIW8ViPxNy4xwjBpyR55I6J220qQTZYR4guvUICJiSpr9gFFle4RcF/OMB7BRiX8sSfhpNSO3lvEZCQfLUVTKT78Ek1LRLhWN+yLyTnp8qWUZ46b6vxdRGXfHVqx3eI75YaLa4iNNiK4NOW7wPW6lhbSOF9/M9qw8e/aoB3d156qTzxp8pXx5BKAsYSTOIIiPkp68GmTq7sZtvyzBQaRLNxIZ+paozHWoLFeExIhRBrWitHCAHrCF7/thhD8JhYz84wg93QRV88wLuLY8zF8sQ36qF1J455bOlgnELfshKVxYOXKVuKx0jaj22sczTQqPqtV/XDgpswmGTWWMSDw3ssyUunLLrVPGjYRsH5ggHeHSWiV8kT33ycFSfMgkoOK8apCye0J6VW6GOYvffgU9RWsukEi2kUV2nl4dOYUzRik9p7bcA4ggdJ53LxKcEe17B1R8eqAd7dOepV8sTXf5lhejoL85hUdhDdknPtKHFhljOT+bdq0hxbm35p2nc8+Ja1Iw+tJykgp0EWuAAZYwMVwac5KzYMslhvgHdHRrxKnvhTYcfKsxTxtTETkjHO7rr3zjoV25lAQHrqpV7bTiy2aXMmUhTBnKS91jhtR3GEoF0oLnWhWNnYgtcc4N0FxlcgT7yz3TgNIKkscx9jtV1ZKpWW+Ub1tc1eOv5ucdgpx+FJy9pgbLE7xDyXb/f+hLHVGeitHOi6A7ybo3sF8sS7w7cgdk0nJaOn3hLj3uyD0Zp5pazFIUXUpuTTU18d1EPkDoX8SkmWTnVIozEdbTcZjoqxhNHf1JrSS/AcvHjZ/SMHhL/7i5z+POsTUh/8BvNfYMTA8n+yU/MlTZxSJDRStqvEuLQKWwDctMTQogUDyQRoTQG5Kc6oQRE1yV1jCA7ri7jdZyK0sYTRjCR0Hnnd+y7nHxNgTULqw+8wj0mQKxpYvhjm9uSUxg+TTy7s2GtLUGcywhXSKZN275GsqlclX90J6bRI1aouxmgL7Q0Nen5ziM80SqMIo8cSOo+8XplT/5DHNWsSUr/6lLN/QQ3rDyzLruEW5enpf7KqZoShEduuSFOV7DLX7Ye+GmXb6/hnNNqKsVXuMDFpb9Y9eH3C6NGEzuOuI3gpMH/I6e+zDiH1fXi15t3vA1czsLws0TGEtmPEJdiiFPwlwKbgLHAFk4P6ZyPdymYYHGE0dutsChQBl2JcBFlrEkY/N5bQeXQ18gjunuMfMfsBlxJSx3niO485fwO4fGD5T/+3fPQqkneWVdwnw/3bMPkW9Wbqg+iC765Zk+xcT98ibKZc2EdgHcLoF8cSOo/Oc8fS+OyEULF4g4sJqXVcmfMfsc7A8v1/yfGXmL9I6Fn5pRwZhsPv0TxFNlAfZCvG+Oohi82UC5f/2IsJo0cTOm9YrDoKhFPEUr/LBYTUNht9zelHXDqwfPCIw4owp3mOcIQcLttWXFe3VZ/j5H3cIc0G6oPbCR+6Y2xF2EC5cGUm6wKC5tGEzhsWqw5hNidUiKX5gFWE1GXh4/Qplw4sVzOmx9QxU78g3EF6wnZlEN4FzJ1QPSLEZz1KfXC7vd8ssGdIbNUYpVx4UapyFUHzJoTOo1McSkeNn1M5MDQfs4qQuhhX5vQZFw8suwWTcyYTgioISk2YdmkhehG4PkE7w51inyAGGaU+uCXADabGzJR1fn3lwkty0asIo8cROm9Vy1g0yDxxtPvHDAmpu+PKnM8Ix1wwsGw91YJqhteaWgjYBmmQiebmSpwKKzE19hx7jkzSWOm66oPbzZ8Yj6kxVSpYjVAuvLzYMCRo3oTQecOOjjgi3NQ4l9K5/hOGhNTdcWVOTrlgYNkEXINbpCkBRyqhp+LdRB3g0OU6rMfW2HPCFFMV9nSp+uB2woepdbLBuJQyaw/ZFysXrlXwHxI0b0LovEkiOpXGA1Ijagf+KUNC6rKNa9bQnLFqYNkEnMc1uJrg2u64ELPBHpkgWbmwKpJoDhMwNbbGzAp7Yg31wS2T5rGtzit59PrKhesWG550CZpHEzpv2NGRaxlNjbMqpmEIzygJqQfjypycs2pg2cS2RY9r8HUqkqdEgKTWtWTKoRvOBPDYBltja2SO0RGjy9UHtxwRjA11ujbKF+ti5cIR9eCnxUg6owidtyoU5tK4NLji5Q3HCtiyF2IqLGYsHViOXTXOYxucDqG0HyttqYAKqYo3KTY1ekyDXRAm2AWh9JmsVh/ccg9WJ2E8YjG201sPq5ULxxX8n3XLXuMInbft2mk80rRGjCGctJ8/GFdmEQ9Ug4FlE1ll1Y7jtiraqm5Fe04VV8lvSVBL8hiPrfFVd8+7QH3Qbu2ipTVi8cvSGivc9cj8yvH11YMHdNSERtuOslM97feYFOPKzGcsI4zW0YGAbTAOaxCnxdfiYUmVWslxiIblCeAYr9VYR1gM7GmoPrilunSxxeT3DN/2eBQ9H11+nk1adn6VK71+5+Jfct4/el10/7KBZfNryUunWSCPxPECk1rdOv1WVSrQmpC+Tl46YD3ikQYcpunSQgzVB2VHFhxHVGKDgMEY5GLlQnP7FMDzw7IacAWnO6sBr12u+XanW2AO0wQ8pknnFhsL7KYIqhkEPmEXFkwaN5KQphbkUmG72wgw7WSm9RiL9QT925hkjiVIIhphFS9HKI6/8QAjlpXqg9W2C0apyaVDwKQwrwLY3j6ADR13ZyUNByQXHQu6RY09Hu6zMqXRaNZGS/KEJs0cJEe9VH1QdvBSJv9h09eiRmy0V2uJcqHcShcdvbSNg5fxkenkVprXM9rDVnX24/y9MVtncvbKY706anNl3ASll9a43UiacVquXGhvq4s2FP62NGKfQLIQYu9q1WmdMfmUrDGt8eDS0cXozH/fjmUH6Jruvm50hBDSaEU/2Ru2LEN/dl006TSc/g7tfJERxGMsgDUEr104pfWH9lQaN+M4KWQjwZbVc2rZVNHsyHal23wZtIs2JJqtIc/WLXXRFCpJkfE9jvWlfFbsNQ9pP5ZBS0zKh4R0aMFj1IjTcTnvi0Zz2rt7NdvQb2mgbju1plsH8MmbnEk7KbK0b+wC2iy3aX3szW8xeZvDwET6hWZYwqTXSSG+wMETKum0Dq/q+x62gt2ua2ppAo309TRk9TPazfV3qL9H8z7uhGqGqxNVg/FKx0HBl9OVUORn8Q8Jx9gFttGQUDr3tzcXX9xGgN0EpzN9mdZ3GATtPhL+CjxFDmkeEU6x56kqZRusLzALXVqkCN7zMEcqwjmywDQ6OhyUe0Xao1Qpyncrg6wKp9XfWDsaZplElvQ/b3sdweeghorwBDlHzgk1JmMc/wiERICVy2VJFdMjFuLQSp3S0W3+sngt2njwNgLssFGVQdJ0tu0KH4ky1LW4yrbkuaA6Iy9oz/qEMMXMMDWyIHhsAyFZc2peV9hc7kiKvfULxCl9iddfRK1f8kk9qvbdOoBtOg7ZkOZ5MsGrSHsokgLXUp9y88smniwWyuFSIRVmjplga3yD8Uij5QS1ZiM4U3Qw5QlSm2bXjFe6jzzBFtpg+/YBbLAWG7OPynNjlCw65fukGNdkJRf7yM1fOxVzbxOJVocFoYIaGwH22mIQkrvu1E2nGuebxIgW9U9TSiukPGU+Lt++c3DJPKhyhEEbXCQLUpae2exiKy6tMPe9mDRBFCEMTWrtwxN8qvuGnt6MoihKWS5NSyBhbH8StXoAz8PLOrRgLtOT/+4vcu+7vDLnqNvztOq7fmd8sMmY9Xzn1zj8Dq8+XVdu2Nv0IIySgEdQo3xVHps3Q5i3fLFsV4aiqzAiBhbgMDEd1uh8qZZ+lwhjkgokkOIv4xNJmyncdfUUzgB4oFMBtiu71Xumpz/P+cfUP+SlwFExwWW62r7b+LSPxqxn/gvMZ5z9C16t15UbNlq+jbGJtco7p8wbYlL4alSyfWdeuu0j7JA3JFNuVAwtst7F7FhWBbPFNKIUORndWtLraFLmMu7KFVDDOzqkeaiN33YAW/r76wR4XDN/yN1z7hejPau06EddkS/6XThfcz1fI/4K736fO48vlxt2PXJYFaeUkFS8U15XE3428xdtn2kc8GQlf1vkIaNRRnOMvLTWrZbElEHeLWi1o0dlKPAh1MVgbbVquPJ5+Cr8LU5/H/+I2QlHIU2ClXM9G8v7Rr7oc/hozfUUgsPnb3D+I+7WF8kNO92GY0SNvuxiE+2Bt8prVJTkzE64sfOstxuwfxUUoyk8VjcTlsqe2qITSFoSj6Epd4KsT6BZOWmtgE3hBfir8IzZDwgV4ZTZvD8VvPHERo8v+vL1DASHTz/i9OlKueHDjK5Rnx/JB1Vb1ioXdBra16dmt7dgik10yA/FwJSVY6XjA3oy4SqM2frqDPPSRMex9qs3XQtoWxMj7/Er8GWYsXgjaVz4OYumP2+9kbxvny/6kvWsEBw+fcb5bInc8APdhpOSs01tEqIkoiZjbAqKMruLbJYddHuHFRIyJcbdEdbl2sVLaySygunutBg96Y2/JjKRCdyHV+AEFtTvIpbKIXOamknYSiB6KV/0JetZITgcjjk5ZdaskBtWO86UF0ap6ozGXJk2WNiRUlCPFir66lzdm/SLSuK7EUdPz8f1z29Skq6F1fXg8+5UVR6bszncP4Tn4KUkkdJ8UFCY1zR1i8RmL/qQL3rlei4THG7OODlnKko4oI01kd3CaM08Ia18kC3GNoVaO9iDh+hWxSyTXFABXoau7Q6q9OxYg/OVEMw6jdbtSrJ9cBcewGmaZmg+bvkUnUUaGr+ZfnMH45Ivevl61hMcXsxYLFTu1hTm2zViCp7u0o5l+2PSUh9bDj6FgYypufBDhqK2+oXkiuHFHR3zfj+9PtA8oR0xnqX8qn+sx3bFODSbbF0X8EUvWQ8jBIcjo5bRmLOljDNtcqNtOe756h3l0VhKa9hDd2l1eqmsnh0MNMT/Cqnx6BInumhLT8luljzQ53RiJeA/0dxe5NK0o2fA1+GLXr6eNQWHNUOJssQaTRlGpLHKL9fD+IrQzTOMZS9fNQD4AnRNVxvTdjC+fJdcDDWQcyB00B0t9BDwTxXgaAfzDZ/DBXzRnfWMFRwuNqocOmX6OKNkY63h5n/fFcB28McVHqnXZVI27K0i4rDLNE9lDKV/rT+udVbD8dFFu2GGZ8mOt0kAXcoX3ZkIWVtw+MNf5NjR2FbivROHmhV1/pj2egv/fMGIOWTIWrV3Av8N9imV9IWml36H6cUjqEWNv9aNc+veb2sH46PRaHSuMBxvtW+twxctq0z+QsHhux8Q7rCY4Ct8lqsx7c6Sy0dl5T89rIeEuZKoVctIk1hNpfavER6yyH1Vvm3MbsUHy4ab4hWr/OZPcsRBphnaV65/ZcdYPNNwsjN/djlf9NqCw9U5ExCPcdhKxUgLSmfROpLp4WSUr8ojdwbncbvCf+a/YzRaEc6QOvXcGO256TXc5Lab9POvB+AWY7PigWYjzhifbovuunzRawsO24ZqQQAqguBtmpmPB7ysXJfyDDaV/aPGillgz1MdQg4u5MYaEtBNNHFjkRlSpd65lp4hd2AVPTfbV7FGpyIOfmNc/XVsPfg7vzaS/3nkvLL593ANLvMuRMGpQIhiF7kUEW9QDpAUbTWYBcbp4WpacHHY1aacqQyjGZS9HI3yCBT9kUZJhVOD+zUDvEH9ddR11fzPcTDQ5TlgB0KwqdXSavk9BC0pKp0WmcuowSw07VXmXC5guzSa4p0UvRw2lbDiYUx0ExJJRzWzi6Gm8cnEkfXXsdcG/M/jAJa0+bmCgdmQ9CYlNlSYZOKixmRsgiFxkrmW4l3KdFKv1DM8tk6WxPYJZhUUzcd8Kdtgrw/gkfXXDT7+avmfVak32qhtkg6NVdUS5wgkru1YzIkSduTW1FDwVWV3JQVJVuieTc0y4iDpFwc7/BvSalvKdQM8sv662cevz/+8sQVnjVAT0W2wLllw1JiMhJRxgDjCjLQsOzSFSgZqx7lAW1JW0e03yAD3asC+GD3NbQhbe+mN5GXH1F83KDOM4n/e5JIuH4NpdQARrFPBVptUNcjj4cVMcFSRTE2NpR1LEYbYMmfWpXgP9KejaPsLUhuvLCsVXznAG9dfx9SR1ud/3hZdCLHb1GMdPqRJgqDmm76mHbvOXDtiO2QPUcKo/TWkQ0i2JFXpBoo7vij1i1Lp3ADAo+qvG3V0rM//vFnnTE4hxd5Ka/Cor5YEdsLVJyKtDgVoHgtW11pWSjolPNMnrlrVj9Fv2Qn60twMwKPqr+N/wvr8z5tZcDsDrv06tkqyzESM85Ycv6XBWA2birlNCXrI6VbD2lx2L0vQO0QVTVVLH4SE67fgsfVXv8n7sz7/85Z7cMtbE6f088wSaR4kCkCm10s6pKbJhfqiUNGLq+0gLWC6eUAZFPnLjwqtKd8EwGvWX59t7iPW4X/eAN1svgRVSY990YZg06BD1ohLMtyFTI4pKTJsS9xREq9EOaPWiO2gpms7397x6nQJkbh+Fz2q/rqRROX6/M8bJrqlVW4l6JEptKeUFuMYUbtCQ7CIttpGc6MY93x1r1vgAnRXvY5cvwWPqb9uWQm+lP95QxdNMeWhOq1x0Db55C7GcUv2ZUuN6n8iKzsvOxibC//Yfs9Na8r2Rlz02vXXDT57FP/zJi66/EJSmsJKa8QxnoqW3VLQ+jZVUtJwJ8PNX1NQCwfNgdhhHD9on7PdRdrdGPF28rJr1F+3LBdeyv+8yYfLoMYet1vX4upNAjVvwOUWnlNXJXlkzk5Il6kqeoiL0C07qno+/CYBXq/+utlnsz7/Mzvy0tmI4zm4ag23PRN3t/CWryoUVJGm+5+K8RJ0V8Hc88/XHUX/HfiAq7t+BH+x6v8t438enWmdJwFA6ZINriLGKv/95f8lT9/FnyA1NMVEvQyaXuu+gz36f/DD73E4pwqpLcvm/o0Vle78n//+L/NPvoefp1pTJye6e4A/D082FERa5/opeH9zpvh13cNm19/4v/LDe5xMWTi8I0Ta0qKlK27AS/v3/r+/x/2GO9K2c7kVMonDpq7//jc5PKCxeNPpFVzaRr01wF8C4Pu76hXuX18H4LduTr79guuFD3n5BHfI+ZRFhY8w29TYhbbLi/bvBdqKE4fUgg1pBKnV3FEaCWOWyA+m3WpORZr/j+9TKJtW8yBTF2/ZEODI9/QavHkVdGFp/Pjn4Q+u5hXapsP5sOH+OXXA1LiKuqJxiMNbhTkbdJTCy4llEt6NnqRT4dhg1V3nbdrm6dYMecA1yTOL4PWTE9L5VzPFlLBCvlG58AhehnN4uHsAYinyJ+AZ/NkVvELbfOBUuOO5syBIEtiqHU1k9XeISX5bsimrkUUhnGDxourN8SgUsCZVtKyGbyGzHXdjOhsAvOAswSRyIBddRdEZWP6GZhNK/yjwew9ehBo+3jEADu7Ay2n8mDc+TS7awUHg0OMzR0LABhqLD4hJEh/BEGyBdGlSJoXYXtr+3HS4ijzVpgi0paWXtdruGTknXBz+11qT1Q2inxaTzQCO46P3lfLpyS4fou2PH/PupwZgCxNhGlj4IvUuWEsTkqMWm6i4xCSMc9N1RDQoCVcuGItJ/MRWefais+3synowi/dESgJjkilnWnBTGvRWmaw8oR15257t7CHmCf8HOn7cwI8+NQBXMBEmAa8PMRemrNCEhLGEhDQKcGZWS319BX9PFBEwGTbRBhLbDcaV3drFcDqk5kCTd2JF1Wp0HraqBx8U0wwBTnbpCadwBA/gTH/CDrcCs93LV8E0YlmmcyQRQnjBa8JESmGUfIjK/7fkaDJpmD2QptFNVJU1bbtIAjjWQizepOKptRjbzR9Kag6xZmMLLjHOtcLT3Tx9o/0EcTT1XN3E45u24AiwEypDJXihKjQxjLprEwcmRKclaDNZCVqr/V8mYWyFADbusiY5hvgFoU2vio49RgJLn5OsReRFN6tabeetiiy0V7KFHT3HyZLx491u95sn4K1QQSPKM9hNT0wMVvAWbzDSVdrKw4zRjZMyJIHkfq1VAVCDl/bUhNKlGq0zGr05+YAceXVPCttVk0oqjVwMPt+BBefx4yPtGVkUsqY3CHDPiCM5ngupUwCdbkpd8kbPrCWHhkmtIKLEetF2499eS1jZlIPGYnlcPXeM2KD9vLS0bW3ktYNqUllpKLn5ZrsxlIzxvDu5eHxzGLctkZLEY4PgSOg2IUVVcUONzUDBEpRaMoXNmUc0tFZrTZquiLyKxrSm3DvIW9Fil+AkhXu5PhEPx9mUNwqypDvZWdKlhIJQY7vn2OsnmBeOWnYZ0m1iwbbw1U60by5om47iHRV6fOgzjMf/DAZrlP40Z7syxpLK0lJ0gqaAK1c2KQKu7tabTXkLFz0sCftuwX++MyNeNn68k5Buq23YQhUh0SNTJa1ioQ0p4nUG2y0XilF1JqODqdImloPS4Bp111DEWT0jJjVv95uX9BBV7eB3bUWcu0acSVM23YZdd8R8UbQUxJ9wdu3oMuhdt929ME+mh6JXJ8di2RxbTi6TbrDquqV4aUKR2iwT6aZbyOwEXN3DUsWr8Hn4EhwNyHuXHh7/pdaUjtR7vnDh/d8c9xD/s5f501eQ1+CuDiCvGhk1AN/4Tf74RfxPwD3toLarR0zNtsnPzmS64KIRk861dMWCU8ArasG9T9H0ZBpsDGnjtAOM2+/LuIb2iIUGXNgl5ZmKD/Tw8TlaAuihaFP5yrw18v4x1898zIdP+DDAX1bM3GAMvPgRP/cJn3zCW013nrhHkrITyvYuwOUkcHuKlRSW5C6rzIdY4ppnF7J8aAJbQepgbJYBjCY9usGXDKQxq7RZfh9eg5d1UHMVATRaD/4BHK93/1iAgYZ/+jqPn8Dn4UExmWrpa3+ZOK6MvM3bjwfzxNWA2dhs8+51XHSPJiaAhGSpWevEs5xHLXcEGFXYiCONySH3fPWq93JIsBiSWvWyc3CAN+EcXoT7rCSANloPPoa31rt/5PUA/gp8Q/jDD3hyrjzlR8VkanfOvB1XPubt17vzxAfdSVbD1pzAnfgyF3ycadOTOTXhpEUoLC1HZyNGW3dtmjeXgr2r56JNmRwdNNWaQVBddd6rh4MhviEB9EFRD/7RGvePvCbwAL4Mx/D6M541hHO4D3e7g6PafdcZVw689z7NGTwo5om7A8sPhccT6qKcl9NJl9aM/9kX+e59Hh1yPqGuCCZxuITcsmNaJ5F7d0q6J3H48TO1/+M57085q2icdu2U+W36Ldllz9Agiv4YGljoEN908EzvDOrBF98/vtJwCC/BF2AG75xxEmjmMIcjxbjoaxqOK3/4hPOZzhMPBpYPG44CM0dTVm1LjLtUWWVz1Bcf8tEx0zs8O2A2YVHRxKYOiy/aOVoAaMu0i7ubu43njjmd4ibMHU1sIDHaQNKrZND/FZYdk54oCXetjq7E7IVl9eAL7t+oHnwXXtLx44czzoRFHBztYVwtH1d+NOMkupZ5MTM+gUmq90X+Bh9zjRlmaQ+m7YMqUL/veemcecAtOJ0yq1JnVlN27di2E0+Klp1tAJ4KRw1eMI7aJjsO3R8kPSI3fUFXnIOfdQe86sIIVtWDL7h//Ok6vj8vwDk08NEcI8zz7OhBy+WwalzZeZ4+0XniRfst9pAJqQHDGLzVQ2pheZnnv1OWhwO43/AgcvAEXEVVpa4db9sGvNK8wjaENHkfFQ4Ci5i7dqnQlPoLQrHXZDvO3BIXZbJOBrOaEbML6sFL798I4FhKihjHMsPjBUZYCMFr6nvaArxqXPn4lCa+cHfSa2cP27g3Z3ziYTRrcbQNGLQmGF3F3cBdzzzX7AILx0IB9rbwn9kx2G1FW3Inic+ZLIsVvKR8Zwfj0l1fkqo8LWY1M3IX14OX3r9RKTIO+d9XzAI8qRPGPn/4NC2n6o4rN8XJ82TOIvuVA8zLKUHRFgBCetlDZlqR1gLKjS39xoE7Bt8UvA6BxuEDjU3tFsEijgA+615tmZkXKqiEENrh41iLDDZNq4pKTWR3LZfnos81LOuNa15cD956vLMsJd1rqYp51gDUQqMYm2XsxnUhD2jg1DM7SeuJxxgrmpfISSXVIJIS5qJJSvJPEQ49DQTVIbYWJ9QWa/E2+c/oPK1drmC7WSfJRNKBO5Yjvcp7Gc3dmmI/Xh1kDTEuiSnWqQf37h+fTMhGnDf6dsS8SQfQWlqqwXXGlc/PEZ/SC5mtzIV0nAshlQdM/LvUtYutrEZ/Y+EAFtq1k28zQhOwLr1AIeANzhF8t9qzTdZf2qRKO6MWE9ohBYwibbOmrFtNmg3mcS+tB28xv2uKd/agYCvOP+GkSc+0lr7RXzyufL7QbkUpjLjEWFLqOIkAGu2B0tNlO9Eau2W1qcOUvVRgKzypKIQZ5KI3q0MLzqTNRYqiZOqmtqloIRlmkBHVpHmRYV6/HixbO6UC47KOFJnoMrVyr7wYz+SlW6GUaghYbY1I6kkxA2W1fSJokUdSh2LQ1GAimRGm0MT+uu57H5l7QgOWxERpO9moLRPgTtquWCfFlGlIjQaRly9odmzMOWY+IBO5tB4sW/0+VWGUh32qYk79EidWKrjWuiLpiVNGFWFRJVktyeXWmbgBBzVl8anPuXyNJlBJOlKLTgAbi/EYHVHxWiDaVR06GnHQNpJcWcK2jJtiCfG2sEHLzuI66sGrMK47nPIInPnu799935aOK2cvmvubrE38ZzZjrELCmXM2hM7UcpXD2oC3+ECVp7xtIuxptJ0jUr3sBmBS47TVxlvJ1Sqb/E0uLdvLj0lLr29ypdd/eMX3f6lrxGlKwKQxEGvw0qHbkbwrF3uHKwVENbIV2wZ13kNEF6zD+x24aLNMfDTCbDPnEikZFyTNttxWBXDaBuM8KtI2rmaMdUY7cXcUPstqTGvBGSrFWIpNMfbdea990bvAOC1YX0qbc6smDS1mPxSJoW4fwEXvjMmhlijDRq6qale6aJEuFGoppYDoBELQzLBuh/mZNx7jkinv0EtnUp50lO9hbNK57lZaMAWuWR5Yo9/kYwcYI0t4gWM47Umnl3YmpeBPqSyNp3K7s2DSAS/39KRuEN2bS4xvowV3dFRMx/VFcp2Yp8w2nTO9hCXtHG1kF1L4KlrJr2wKfyq77R7MKpFKzWlY9UkhYxyHWW6nBWPaudvEAl3CGcNpSXPZ6R9BbBtIl6cHL3gIBi+42CYXqCx1gfGWe7Ap0h3luyXdt1MKy4YUT9xSF01G16YEdWsouW9mgDHd3veyA97H+Ya47ZmEbqMY72oPztCGvK0onL44AvgC49saZKkWRz4veWljE1FHjbRJaWv6ZKKtl875h4CziFCZhG5rx7tefsl0aRT1bMHZjm8dwL/6u7wCRysaQblQoG5yAQN5zpatMNY/+yf8z+GLcH/Qn0iX2W2oEfXP4GvwQHuIL9AYGnaO3zqAX6946nkgqZNnUhx43DIdQtMFeOPrgy/y3Yd85HlJWwjLFkU3kFwq28xPnuPhMWeS+tDLV9Otllq7pQCf3uXJDN9wFDiUTgefHaiYbdfi3b3u8+iY6TnzhgehI1LTe8lcd7s1wJSzKbahCRxKKztTLXstGAiu3a6rPuQs5pk9TWAan5f0BZmGf7Ylxzzk/A7PAs4QPPPAHeFQ2hbFHszlgZuKZsJcUmbDC40sEU403cEjczstOEypa+YxevL4QBC8oRYqWdK6b7sK25tfE+oDZgtOQ2Jg8T41HGcBE6fTWHn4JtHcu9S7uYgU5KSCkl/mcnq+5/YBXOEr6lCUCwOTOM1taOI8mSxx1NsCXBEmLKbMAg5MkwbLmpBaFOPrNSlO2HnLiEqW3tHEwd8AeiQLmn+2gxjC3k6AxREqvKcJbTEzlpLiw4rNZK6oJdidbMMGX9FULKr0AkW+2qDEPBNNm5QAt2Ik2nftNWHetubosHLo2nG4vQA7GkcVCgVCgaDixHqo9UUn1A6OshapaNR/LPRYFV8siT1cCtJE0k/3WtaNSuUZYKPnsVIW0xXWnMUxq5+En4Kvw/MqQmVXnAXj9Z+9zM98zM/Agy7F/qqj2Nh67b8HjFnPP3iBn/tkpdzwEJX/whIcQUXOaikeliCRGUk7tiwF0rItwMEhjkZ309hikFoRAmLTpEXWuHS6y+am/KB/fM50aLEhGnSMwkpxzOov4H0AvgovwJ1iGzDLtJn/9BU+fAINfwUe6FHSLhu83viV/+/HrOePX+STT2B9uWGbrMHHLldRBlhS/CJQmcRxJFqZica01XixAZsYiH1uolZxLrR/SgxVIJjkpQP4PE9sE59LKLr7kltSBogS5tyszzH8Fvw8/AS8rNOg0xUS9fIaHwb+6et8Q/gyvKRjf5OusOzGx8evA/BP4IP11uN/grca5O0lcsPLJ5YjwI4QkJBOHa0WdMZYGxPbh2W2nR9v3WxEWqgp/G3+6VZbRLSAAZ3BhdhAaUL33VUSw9yjEsvbaQ9u4A/gGXwZXoEHOuU1GSj2chf+Mo+f8IcfcAxfIKVmyunRbYQVnoevwgfw3TXXcw++xNuP4fhyueEUNttEduRVaDttddoP0eSxLe2LENk6itYxlrxBNBYrNNKSQmeaLcm9c8UsaB5WyO6675yyQIAWSDpBVoA/gxmcwEvwoDv0m58UE7gHn+fJOa8/Ywan8EKRfjsopF83eCglX/Sfr7OeaRoQfvt1CGvIDccH5BCvw1sWIzRGC/66t0VTcLZQZtm6PlAasbOJ9iwWtUo7biktTSIPxnR24jxP1ZKaqq+2RcXM9OrBAm/AAs7hDJ5bNmGb+KIfwCs8a3jnjBrOFeMjHSCdbKr+2uOLfnOd9eiA8Hvvwwq54VbP2OqwkB48Ytc4YEOiH2vTXqodabfWEOzso4qxdbqD5L6tbtNPECqbhnA708DZH4QOJUXqScmUlks7Ot6FBuZw3n2mEbaUX7kDzxHOOQk8nKWMzAzu6ZZ8sOFw4RK+6PcuXo9tB4SbMz58ApfKDXf3szjNIIbGpD5TKTRxGkEMLjLl+K3wlWXBsCUxIDU+jbOiysESqAy1MGUJpXgwbTWzNOVEziIXZrJ+VIztl1PUBxTSo0dwn2bOmfDRPD3TRTGlfbCJvO9KvuhL1hMHhB9wPuPRLGHcdOWG2xc0U+5bQtAJT0nRTewXL1pgk2+rZAdeWmz3jxAqfNQQdzTlbF8uJ5ecEIWvTkevAHpwz7w78QujlD/Lr491bD8/1vhM2yrUQRrWXNQY4fGilfctMWYjL72UL/qS9eiA8EmN88nbNdour+PBbbAjOjIa4iBhfFg6rxeKdEGcL6p3EWR1Qq2Qkhs2DrnkRnmN9tG2EAqmgPw6hoL7Oza7B+3SCrR9tRftko+Lsf2F/mkTndN2LmzuMcKTuj/mX2+4Va3ki16+nnJY+S7MefpkidxwnV+4wkXH8TKnX0tsYzYp29DOOoSW1nf7nTh2akYiWmcJOuTidSaqESrTYpwjJJNVGQr+rLI7WsqerHW6Kp/oM2pKuV7T1QY9gjqlZp41/WfKpl56FV/0kvXQFRyeQ83xaTu5E8p5dNP3dUF34ihyI3GSpeCsywSh22ZJdWto9winhqifb7VRvgktxp13vyjrS0EjvrRfZ62uyqddSWaWYlwTPAtJZ2oZ3j/Sgi/mi+6vpzesfAcWNA0n8xVyw90GVFGuZjTXEQy+6GfLGLMLL523f5E0OmxVjDoOuRiH91RKU+vtoCtH7TgmvBLvtFXWLW15H9GTdVw8ow4IlRLeHECN9ym1e9K0I+Cbnhgv4Yu+aD2HaQJ80XDqOzSGAV4+4yCqBxrsJAX6ZTIoX36QnvzhhzzMfFW2dZVLOJfo0zbce5OvwXMFaZ81mOnlTVXpDZsQNuoYWveketKb5+6JOOsgX+NTm7H49fUTlx+WLuWL7qxnOFh4BxpmJx0p2gDzA/BUARuS6phR+pUsY7MMboAHx5xNsSVfVZcYSwqCKrqon7zM+8ecCkeS4nm3rINuaWvVNnMRI1IRpxTqx8PZUZ0Br/UEduo3B3hNvmgZfs9gQPj8vIOxd2kndir3awvJ6BLvoUuOfFWNYB0LR1OQJoUySKb9IlOBx74q1+ADC2G6rOdmFdJcD8BkfualA+BdjOOzP9uUhGUEX/TwhZsUduwRr8wNuXKurCixLBgpQI0mDbJr9dIqUuV+92ngkJZ7xduCk2yZKbfWrH1VBiTg9VdzsgRjW3CVXCvAwDd+c1z9dWw9+B+8MJL/eY15ZQ/HqvTwVdsZn5WQsgRRnMaWaecu3jFvMBEmgg+FJFZsnSl0zjB9OqPYaBD7qmoVyImFvzi41usesV0julaAR9dfR15Xzv9sEruRDyk1nb+QaLU67T885GTls6YgcY+UiMa25M/pwGrbCfzkvR3e0jjtuaFtnwuagHTSb5y7boBH119HXhvwP487jJLsLJ4XnUkHX5sLbS61dpiAXRoZSCrFJ+EjpeU3puVfitngYNo6PJrAigKktmwjyQdZpfq30mmtulaAx9Zfx15Xzv+cyeuiBFUs9zq8Kq+XB9a4PVvph3GV4E3y8HENJrN55H1X2p8VyqSKwVusJDKzXOZzplWdzBUFK9e+B4+uv468xvI/b5xtSAkBHQaPvtqWzllVvEOxPbuiE6+j2pvjcKsbvI7txnRErgfH7LdXqjq0IokKzga14GzQ23SSbCQvO6r+Or7SMIr/efOkkqSdMnj9mBx2DRsiY29Uj6+qK9ZrssCKaptR6HKURdwUYeUWA2kPzVKQO8ku2nU3Anhs/XWkBx3F/7wJtCTTTIKftthue1ty9xvNYLY/zo5KSbIuKbXpbEdSyeRyYdAIwKY2neyoc3+k1XUaufYga3T9daMUx/r8z1s10ITknIO0kuoMt+TB8jK0lpayqqjsJ2qtXAYwBU932zinimgmd6mTRDnQfr88q36NAI+tv24E8Pr8zxtasBqx0+xHH9HhlrwsxxNUfKOHQaZBITNf0uccj8GXiVmXAuPEAKSdN/4GLHhs/XWj92dN/uetNuBMnVR+XWDc25JLjo5Mg5IZIq226tmCsip2zZliL213YrTlL2hcFjpCduyim3M7/eB16q/blQsv5X/esDRbtJeabLIosWy3ycavwLhtxdWzbMmHiBTiVjJo6lCLjXZsi7p9PEPnsq6X6wd4bP11i0rD5fzPm/0A6brrIsllenZs0lCJlU4abakR59enZKrKe3BZihbTxlyZ2zl1+g0wvgmA166/bhwDrcn/7Ddz0eWZuJvfSESug6NzZsox3Z04FIxz0mUjMwVOOVTq1CQ0AhdbBGVdjG/CgsfUX7esJl3K/7ytWHRv683praW/8iDOCqWLLhpljDY1ZpzK75QiaZoOTpLKl60auHS/97oBXrv+umU9+FL+5+NtLFgjqVLCdbmj7pY5zPCPLOHNCwXGOcLquOhi8CmCWvbcuO73XmMUPab+ug3A6/A/78Bwe0bcS2+tgHn4J5pyS2WbOck0F51Vq3LcjhLvZ67p1ABbaL2H67bg78BfjKi/jr3+T/ABV3ilLmNXTI2SpvxWBtt6/Z//D0z/FXaGbSBgylzlsEGp+5//xrd4/ae4d8DUUjlslfIYS3t06HZpvfQtvv0N7AHWqtjP2pW08QD/FLy//da38vo8PNlKHf5y37Dxdfe/oj4kVIgFq3koLReSR76W/bx//n9k8jonZxzWTANVwEniDsg87sOSd/z7//PvMp3jQiptGVWFX2caezzAXwfgtzYUvbr0iozs32c3Uge7varH+CNE6cvEYmzbPZ9hMaYDdjK4V2iecf6EcEbdUDVUARda2KzO/JtCuDbNQB/iTeL0EG1JSO1jbXS+nLxtPMDPw1fh5+EPrgSEKE/8Gry5A73ui87AmxwdatyMEBCPNOCSKUeRZ2P6Myb5MRvgCHmA9ywsMifU+AYXcB6Xa5GibUC5TSyerxyh0j6QgLVpdyhfArRTTLqQjwe4HOD9s92D4Ap54odXAPBWLAwB02igG5Kkc+piN4lvODIFGAZgT+EO4Si1s7fjSR7vcQETUkRm9O+MXyo9OYhfe4xt9STQ2pcZRLayCV90b4D3jR0DYAfyxJ+eywg2IL7NTMXna7S/RpQ63JhWEM8U41ZyQGjwsVS0QBrEKLu8xwZsbi4wLcCT+OGidPIOCe1PiSc9Qt+go+vYqB7cG+B9d8cAD+WJPz0Am2gxXgU9IneOqDpAAXOsOltVuMzpdakJXrdPCzXiNVUpCeOos5cxnpQT39G+XVLhs1osQVvJKPZyNq8HDwd4d7pNDuWJPxVX7MSzqUDU6gfadKiNlUFTzLeFHHDlzO4kpa7aiKhBPGKwOqxsBAmYkOIpipyXcQSPlRTf+Tii0U3EJGaZsDER2qoB3h2hu0qe+NNwUooYU8y5mILbJe6OuX+2FTKy7bieTDAemaQyQ0CPthljSWO+xmFDIYiESjM5xKd6Ik5lvLq5GrQ3aCMLvmCA9wowLuWJb9xF59hVVP6O0CrBi3ZjZSNOvRy+I6klNVRJYRBaEzdN+imiUXQ8iVF8fsp+W4JXw7WISW7fDh7lptWkCwZ4d7QTXyBPfJMYK7SijjFppGnlIVJBJBYj7eUwtiP1IBXGI1XCsjNpbjENVpSAJ2hq2LTywEly3hUYazt31J8w2+aiLx3g3fohXixPfOMYm6zCGs9LVo9MoW3MCJE7R5u/WsOIjrqBoHUO0bJE9vxBpbhsd3+Nb4/vtPCZ4oZYCitNeYuC/8UDvDvy0qvkiW/cgqNqRyzqSZa/s0mqNGjtKOoTm14zZpUauiQgVfqtQiZjq7Q27JNaSK5ExRcrGCXO1FJYh6jR6CFqK7bZdQZ4t8g0rSlPfP1RdBtqaa9diqtzJkQ9duSryi2brQXbxDwbRUpFMBHjRj8+Nt7GDKgvph9okW7LX47gu0SpGnnFQ1S1lYldOsC7hYteR574ZuKs7Ei1lBsfdz7IZoxzzCVmmVqaSySzQbBVAWDek+N4jh9E/4VqZrJjPwiv9BC1XcvOWgO8275CVyBPvAtTVlDJfZkaZGU7NpqBogAj/xEHkeAuJihWYCxGN6e8+9JtSegFXF1TrhhLGP1fak3pebgPz192/8gB4d/6WT7+GdYnpH7hH/DJzzFiYPn/vjW0SgNpTNuPIZoAEZv8tlGw4+RLxy+ZjnKa5NdFoC7UaW0aduoYse6+bXg1DLg6UfRYwmhGEjqPvF75U558SANrElK/+MdpXvmqBpaXOa/MTZaa1DOcSiLaw9j0NNNst3c+63c7EKTpkvKHzu6bPbP0RkuHAVcbRY8ijP46MIbQeeT1mhA+5PV/inyDdQipf8LTvMXbwvoDy7IruDNVZKTfV4CTSRUYdybUCnGU7KUTDxLgCknqUm5aAW6/1p6eMsOYsphLzsHrE0Y/P5bQedx1F/4yPHnMB3/IOoTU9+BL8PhtjuFKBpZXnYNJxTuv+2XqolKR2UQgHhS5novuxVySJhBNRF3SoKK1XZbbXjVwWNyOjlqWJjrWJIy+P5bQedyldNScP+HZ61xKSK3jyrz+NiHG1hcOLL/+P+PDF2gOkekKGiNWKgJ+8Z/x8Iv4DdQHzcpZyF4v19I27w9/yPGDFQvmEpKtqv/TLiWMfn4sofMm9eAH8Ao0zzh7h4sJqYtxZd5/D7hkYPneDzl5idlzNHcIB0jVlQ+8ULzw/nc5/ojzl2juE0apD7LRnJxe04dMz2iOCFNtGFpTuXA5AhcTRo8mdN4kz30nVjEC4YTZQy4gpC7GlTlrePKhGsKKgeXpCYeO0MAd/GH7yKQUlXPLOasOH3FnSphjHuDvEu4gB8g66oNbtr6eMbFIA4fIBJkgayoXriw2XEDQPJrQeROAlY6aeYOcMf+IVYTU3XFlZufMHinGywaW3YLpObVBAsbjF4QJMsVUSayjk4voPsHJOQfPWDhCgDnmDl6XIRerD24HsGtw86RMHOLvVSHrKBdeVE26gKB5NKHzaIwLOmrqBWJYZDLhASG16c0Tn+CdRhWDgWXnqRZUTnPIHuMJTfLVpkoYy5CzylHVTGZMTwkGAo2HBlkQplrJX6U+uF1wZz2uwS1SQ12IqWaPuO4baZaEFBdukksJmkcTOm+YJSvoqPFzxFA/YUhIvWxcmSdPWTWwbAKVp6rxTtPFUZfKIwpzm4IoMfaYQLWgmlG5FME2gdBgm+J7J+rtS/XBbaVLsR7bpPQnpMFlo2doWaVceHk9+MkyguZNCJ1He+kuHTWyQAzNM5YSUg/GlTk9ZunAsg1qELVOhUSAK0LABIJHLKbqaEbHZLL1VA3VgqoiOKXYiS+HRyaEKgsfIqX64HYWbLRXy/qWoylIV9gudL1OWBNgBgTNmxA6b4txDT4gi3Ri7xFSLxtXpmmYnzAcWDZgY8d503LFogz5sbonDgkKcxGsWsE1OI+rcQtlgBBCSOKD1mtqYpIU8cTvBmAT0yZe+zUzeY92fYjTtGipXLhuR0ePoHk0ofNWBX+lo8Z7pAZDk8mEw5L7dVyZZoE/pTewbI6SNbiAL5xeygW4xPRuLCGbhcO4RIeTMFYHEJkYyEO9HmJfXMDEj/LaH781wHHZEtqSQ/69UnGpzH7LKIAZEDSPJnTesJTUa+rwTepI9dLJEawYV+ZkRn9g+QirD8vF8Mq0jFQ29js6kCS3E1+jZIhgPNanHdHFqFvPJLHqFwQqbIA4jhDxcNsOCCQLDomaL/dr5lyJaJU6FxPFjO3JOh3kVMcROo8u+C+jo05GjMF3P3/FuDLn5x2M04xXULPwaS6hBYki+MrMdZJSgPHlcB7nCR5bJ9Kr5ACUn9jk5kivdd8tk95SOGrtqu9lr2IhK65ZtEl7ZKrp7DrqwZfRUSN1el7+7NJxZbywOC8neNKTch5vsTEMNsoCCqHBCqIPRjIPkm0BjvFODGtto99rCl+d3wmHkW0FPdpZtC7MMcVtGFQjJLX5bdQ2+x9ypdc313uj8xlsrfuLgWXz1cRhZvJYX0iNVBRcVcmCXZs6aEf3RQF2WI/TcCbKmGU3IOoDJGDdDub0+hYckt6PlGu2BcxmhbTdj/klhccLGJMcqRjMJP1jW2ETqLSWJ/29MAoORluJ+6LPffBZbi5gqi5h6catQpmOT7/OFf5UorRpLzCqcMltBLhwd1are3kztrSzXO0LUbXRQcdLh/RdSZ+swRm819REDrtqzC4es6Gw4JCKlSnjYVpo0xeq33PrADbFLL3RuCmObVmPN+24kfa+AojDuM4umKe2QwCf6EN906HwjujaitDs5o0s1y+k3lgbT2W2i7FJdnwbLXhJUBq/9liTctSmFC/0OqUinb0QddTWamtjbHRFuWJJ6NpqZ8vO3fZJ37Db+2GkaPYLGHs7XTTdiFQJ68SkVJFVmY6McR5UycflNCsccHFaV9FNbR4NttLxw4pQ7wJd066Z0ohVbzihaxHVExd/ay04oxUKWt+AsdiQ9OUyZ2krzN19IZIwafSTFgIBnMV73ADj7V/K8u1MaY2sJp2HWm0f41tqwajEvdHWOJs510MaAqN4aoSiPCXtN2KSi46dUxHdaMquar82O1x5jqhDGvqmoE9LfxcY3zqA7/x3HA67r9ZG4O6Cuxu12/+TP+eLP+I+HErqDDCDVmBDO4larujNe7x8om2rMug0MX0rL1+IWwdwfR+p1TNTyNmVJ85ljWzbWuGv8/C7HD/izjkHNZNYlhZcUOKVzKFUxsxxN/kax+8zPWPSFKw80rJr9Tizyj3o1gEsdwgWGoxPezDdZ1TSENE1dLdNvuKL+I84nxKesZgxXVA1VA1OcL49dFlpFV5yJMhzyCmNQ+a4BqusPJ2bB+xo8V9u3x48VVIEPS/mc3DvAbXyoYr6VgDfh5do5hhHOCXMqBZUPhWYbWZECwVJljLgMUWOCB4MUuMaxGNUQDVI50TQ+S3kFgIcu2qKkNSHVoM0SHsgoZxP2d5HH8B9woOk4x5bPkKtAHucZsdykjxuIpbUrSILgrT8G7G5oCW+K0990o7E3T6AdW4TilH5kDjds+H64kS0mz24grtwlzDHBJqI8YJQExotPvoC4JBq0lEjjQkyBZ8oH2LnRsQ4Hu1QsgDTJbO8fQDnllitkxuVskoiKbRF9VwzMDvxHAdwB7mD9yCplhHFEyUWHx3WtwCbSMMTCUCcEmSGlg4gTXkHpZXWQ7kpznK3EmCHiXInqndkQjunG5kxTKEeGye7jWz9cyMR2mGiFQ15ENRBTbCp+Gh86vAyASdgmJq2MC6hoADQ3GosP0QHbnMHjyBQvQqfhy/BUbeHd5WY/G/9LK/8Ka8Jd7UFeNWEZvzPb458Dn8DGLOe3/wGL/4xP+HXlRt+M1PE2iLhR8t+lfgxsuh7AfO2AOf+owWhSZRYQbd622hbpKWKuU+XuvNzP0OseRDa+mObgDHJUSc/pKx31QdKffQ5OIJpt8GWjlgTwMc/w5MPCR/yl1XC2a2Yut54SvOtMev55Of45BOat9aWG27p2ZVORRvnEk1hqWMVUmqa7S2YtvlIpspuF1pt0syuZS2NV14mUidCSfzQzg+KqvIYCMljIx2YK2AO34fX4GWdu5xcIAb8MzTw+j/lyWM+Dw/gjs4GD6ehNgA48kX/AI7XXM/XAN4WHr+9ntywqoCakCqmKP0rmQrJJEErG2Upg1JObr01lKQy4jskWalKYfJ/EDLMpjNSHFEUAde2fltaDgmrNaWQ9+AAb8I5vKjz3L1n1LriB/BXkG/wwR9y/oRX4LlioHA4LzP2inzRx/DWmutRweFjeP3tNeSGlaE1Fde0OS11yOpmbIp2u/jF1n2RRZviJM0yBT3IZl2HWImKjQOxIyeU325b/qWyU9Moj1o07tS0G7qJDoGHg5m8yeCxMoEH8GU45tnrNM84D2l297DQ9t1YP7jki/7RmutRweEA77/HWXOh3HCxkRgldDQkAjNTMl2Iloc1qN5JfJeeTlyTRzxURTdn1Ixv2uKjs12AbdEWlBtmVdk2k7FFwj07PCZ9XAwW3dG+8xKzNFr4EnwBZpy9Qzhh3jDXebBpYcpuo4fQ44u+fD1dweEnHzI7v0xuuOALRUV8rXpFyfSTQYkhd7IHm07jpyhlkCmI0ALYqPTpUxXS+z4jgDj1Pflvmz5ecuItpIBxyTHpSTGWd9g1ApfD/bvwUhL4nT1EzqgX7cxfCcNmb3mPL/qi9SwTHJ49oj5ZLjccbTG3pRmlYi6JCG0mQrAt1+i2UXTZ2dv9IlQpN5naMYtviaXlTrFpoMsl3bOAFEa8sqPj2WCMrx3Yjx99qFwO59Aw/wgx+HlqNz8oZvA3exRDvuhL1jMQHPaOJ0+XyA3fp1OfM3qObEVdhxjvynxNMXQV4+GJyvOEFqeQBaIbbO7i63rpxCltdZShPFxkjM2FPVkn3TG+Rp9pO3l2RzFegGfxGDHIAh8SteR0C4HopXzRF61nheDw6TFN05Ebvq8M3VKKpGjjO6r7nhudTEGMtYM92HTDaR1FDMXJ1eThsbKfywyoWwrzRSXkc51flG3vIid62h29bIcFbTGhfV+faaB+ohj7dPN0C2e2lC96+XouFByen9AsunLDJZ9z7NExiUc0OuoYW6UZkIyx2YUR2z6/TiRjyKMx5GbbjLHvHuf7YmtKghf34LJfx63Yg8vrvN2zC7lY0x0tvKezo4HmGYDU+Gab6dFL+KI761lDcNifcjLrrr9LWZJctG1FfU1uwhoQE22ObjdfkSzY63CbU5hzs21WeTddH2BaL11Gi7lVdlxP1nkxqhnKhVY6knS3EPgVGg1JpN5cP/hivujOelhXcPj8HC/LyI6MkteVjlolBdMmF3a3DbsuAYhL44dxzthWSN065xxUd55Lmf0wRbOYOqH09/o9WbO2VtFdaMb4qBgtFJoT1SqoN8wPXMoXLb3p1PUEhxfnnLzGzBI0Ku7FxrKsNJj/8bn/H8fPIVOd3rfrklUB/DOeO+nkghgSPzrlPxluCMtOnDL4Yml6dK1r3vsgMxgtPOrMFUZbEUbTdIzii5beq72G4PD0DKnwjmBULUVFmy8t+k7fZ3pKc0Q4UC6jpVRqS9Umv8bxw35flZVOU1X7qkjnhZlsMbk24qQ6Hz7QcuL6sDC0iHHki96Uh2UdvmgZnjIvExy2TeJdMDZNSbdZyAHe/Yd1xsQhHiKzjh7GxQ4yqMPaywPkjMamvqrYpmO7Knad+ZQC5msCuAPWUoxrxVhrGv7a+KLXFhyONdTMrZ7ke23qiO40ZJUyzgYyX5XyL0mV7NiUzEs9mjtbMN0dERqwyAJpigad0B3/zRV7s4PIfXSu6YV/MK7+OrYe/JvfGMn/PHJe2fyUdtnFrKRNpXV0Y2559aWPt/G4BlvjTMtXlVIWCnNyA3YQBDmYIodFz41PvXPSa6rq9lWZawZ4dP115HXV/M/tnFkkrBOdzg6aP4pID+MZnTJ1SuuB6iZlyiox4HT2y3YBtkUKWooacBQUDTpjwaDt5poBHl1/HXltwP887lKKXxNUEyPqpGTyA699UqY/lt9yGdlUKra0fFWS+36iylVWrAyd7Uw0CZM0z7xKTOduznLIjG2Hx8cDPLb+OvK6Bv7n1DYci4CxUuRxrjBc0bb4vD3rN5Zz36ntLb83eVJIB8LiIzCmn6SMPjlX+yNlTjvIGjs+QzHPf60Aj62/jrzG8j9vYMFtm1VoRWCJdmw7z9N0t+c8cxZpPeK4aTRicS25QhrVtUp7U578chk4q04Wx4YoQSjFryUlpcQ1AbxZ/XVMknIU//OGl7Q6z9Zpxi0+3yFhSkjUDpnCIUhLWVX23KQ+L9vKvFKI0ZWFQgkDLvBoylrHNVmaw10zwCPrr5tlodfnf94EWnQ0lFRWy8pW9LbkLsyUVDc2NSTHGDtnD1uMtchjbCeb1mpxFP0YbcClhzdLu6lfO8Bj6q+bdT2sz/+8SZCV7VIxtt0DUn9L7r4cLYWDSXnseEpOGFuty0qbOVlS7NNzs5FOGJUqQpl2Q64/yBpZf90sxbE+//PGdZ02HSipCbmD6NItmQ4Lk5XUrGpDMkhbMm2ZVheNYV+VbUWTcv99+2NyX1VoafSuC+AN6q9bFIMv5X/eagNWXZxEa9JjlMwNWb00akGUkSoepp1/yRuuqHGbUn3UdBSTxBU6SEVklzWRUkPndVvw2PrrpjvxOvzPmwHc0hpmq82npi7GRro8dXp0KXnUQmhZbRL7NEVp1uuZmO45vuzKsHrktS3GLWXODVjw+vXXLYx4Hf7njRPd0i3aoAGX6W29GnaV5YdyDj9TFkakje7GHYzDoObfddHtOSpoi2SmzJHrB3hM/XUDDEbxP2/oosszcRlehWXUvzHv4TpBVktHqwenFo8uLVmy4DKLa5d3RtLrmrM3aMFr1183E4sewf+85VWeg1c5ag276NZrM9IJVNcmLEvDNaV62aq+14IAOGFsBt973Ra8Xv11YzXwNfmft7Jg2oS+XOyoC8/cwzi66Dhmgk38kUmP1CUiYWOX1bpD2zWXt2FCp7uq8703APAa9dfNdscR/M/bZLIyouVxqJfeWvG9Je+JVckHQ9+CI9NWxz+blX/KYYvO5n2tAP/vrlZ7+8/h9y+9qeB/Hnt967e5mevX10rALDWK//FaAT5MXdBXdP0C/BAes792c40H+AiAp1e1oH8HgH94g/Lttx1gp63op1eyoM/Bvw5/G/7xFbqJPcCXnmBiwDPb/YKO4FX4OjyCb289db2/Noqicw4i7N6TVtoz8tNwDH+8x/i6Ae7lmaQVENzJFb3Di/BFeAwz+Is9SjeQySpPqbLFlNmyz47z5a/AF+AYFvDmHqibSXTEzoT4Gc3OALaqAP4KPFUJ6n+1x+rGAM6Zd78bgJ0a8QN4GU614vxwD9e1Amy6CcskNrczLx1JIp6HE5UZD/DBHrFr2oNlgG4Odv226BodoryjGJ9q2T/AR3vQrsOCS0ctXZi3ruLlhpFDJYl4HmYtjQCP9rhdn4suySLKDt6wLcC52h8xPlcjju1fn+yhuw4LZsAGUuo2b4Fx2UwQu77uqRHXGtg92aN3tQCbFexc0uk93vhTXbct6y7MulLycoUljx8ngDMBg1tvJjAazpEmOtxlzclvj1vQf1Tx7QlPDpGpqgtdSKz/d9/hdy1vTfFHSmC9dGDZbLiezz7Ac801HirGZsWjydfZyPvHXL/Y8Mjzg8BxTZiuwKz4Eb8sBE9zznszmjvFwHKPIWUnwhqfVRcd4Ck0K6ate48m1oOfrX3/yOtvAsJ8zsPAM89sjnddmuLuDPjX9Bu/L7x7xpMzFk6nWtyQfPg278Gn4Aekz2ZgOmU9eJ37R14vwE/BL8G3aibCiWMWWDQ0ZtkPMnlcGeAu/Ag+8ZyecU5BPuy2ILD+sQqyZhAKmn7XZd+jIMTN9eBL7x95xVLSX4On8EcNlXDqmBlqS13jG4LpmGbkF/0CnOi3H8ETOIXzmnmtb0a16Tzxj1sUvQCBiXZGDtmB3KAefPH94xcUa/6vwRn80GOFyjEXFpba4A1e8KQfFF+259tx5XS4egYn8fQsLGrqGrHbztr+uByTahWuL1NUGbDpsnrwBfePPwHHIf9X4RnM4Z2ABWdxUBlqQ2PwhuDxoS0vvqB1JzS0P4h2nA/QgTrsJFn+Y3AOjs9JFC07CGWX1oNX3T/yHOzgDjwPn1PM3g9Jk9lZrMEpxnlPmBbjyo2+KFXRU52TJM/2ALcY57RUzjObbjqxVw++4P6RAOf58pcVsw9Daje3htriYrpDOonre3CudSe6bfkTEgHBHuDiyu5MCsc7BHhYDx7ePxLjqigXZsw+ijMHFhuwBmtoTPtOxOrTvYJDnC75dnUbhfwu/ZW9AgYd+peL68HD+0emKquiXHhWjJg/UrkJYzuiaL3E9aI/ytrCvAd4GcYZMCkSQxfUg3v3j8c4e90j5ZTPdvmJJGHnOCI2nHS8081X013pHuBlV1gB2MX1YNmWLHqqGN/TWmG0y6clJWthxNUl48q38Bi8vtMKyzzpFdSDhxZ5WBA5ZLt8Jv3895DduBlgbPYAj8C4B8hO68FDkoh5lydC4FiWvBOVqjYdqjiLv92t8yPDjrDaiHdUD15qkSURSGmXJwOMSxWAXYwr3zaAufJ66l+94vv3AO+vPcD7aw/w/toDvL/2AO+vPcD7aw/wHuD9tQd4f+0B3l97gPfXHuD9tQd4f+0B3l97gG8LwP8G/AL8O/A5OCq0Ys2KIdv/qOIXG/4mvFAMF16gZD+2Xvu/B8as5+8bfllWyg0zaNO5bfXj6vfhhwD86/Aq3NfRS9t9WPnhfnvCIw/CT8GLcFTMnpntdF/z9V+PWc/vWoIH+FL3Znv57PitcdGP4R/C34avw5fgRVUInCwbsn1yyA8C8zm/BH8NXoXnVE6wVPjdeCI38kX/3+Ct9dbz1pTmHFRu+Hm4O9Ch3clr99negxfwj+ER/DR8EV6B5+DuQOnTgUw5rnkY+FbNU3gNXh0o/JYTuWOvyBf9FvzX663HH/HejO8LwAl8Hl5YLTd8q7sqA3wbjuExfAFegQdwfyDoSkWY8swzEf6o4Qyewefg+cHNbqMQruSL/u/WWc+E5g7vnnEXgDmcDeSGb/F4cBcCgT+GGRzDU3hZYburAt9TEtHgbM6JoxJ+6NMzzTcf6c2bycv2+KK/f+l6LBzw5IwfqZJhA3M472pWT/ajKxnjv4AFnMEpnBTPND6s2J7qHbPAqcMK74T2mZ4VGB9uJA465It+/eL1WKhYOD7xHOkr1ajK7d0C4+ke4Hy9qXZwpgLr+Znm/uNFw8xQOSy8H9IzjUrd9+BIfenYaylf9FsXr8fBAadnPIEDna8IBcwlxnuA0/Wv6GAWPd7dDIKjMdSWueAsBj4M7TOd06qBbwDwKr7oleuxMOEcTuEZTHWvDYUO7aHqAe0Bbq+HEFRzOz7WVoTDQkVds7A4sIIxfCQdCefFRoIOF/NFL1mPab/nvOakSL/Q1aFtNpUb/nFOVX6gzyg/1nISyDfUhsokIzaBR9Kxm80s5mK+6P56il1jXic7nhQxsxSm3OwBHl4fFdLqi64nDQZvqE2at7cWAp/IVvrN6/BFL1mPhYrGMBfOi4PyjuSGf6wBBh7p/FZTghCNWGgMzlBbrNJoPJX2mW5mwZfyRffXo7OFi5pZcS4qZUrlViptrXtw+GQoyhDPS+ANjcGBNRiLCQDPZPMHuiZfdFpPSTcQwwKYdRNqpkjm7AFeeT0pJzALgo7g8YYGrMHS0iocy+YTm2vyRUvvpXCIpQ5pe666TJrcygnScUf/p0NDs/iAI/nqDHC8TmQT8x3NF91l76oDdQGwu61Z6E0ABv7uO1dbf/37Zlv+Zw/Pbh8f1s4Avur6657/+YYBvur6657/+YYBvur6657/+YYBvur6657/+aYBvuL6657/+VMA8FXWX/f8zzcN8BXXX/f8zzcNMFdbf93zP38KLPiK6697/uebtuArrr/u+Z9vGmCusP6653/+1FjwVdZf9/zPN7oHX339dc//fNMu+irrr3v+50+Bi+Zq6697/uebA/jz8Pudf9ht/fWv517J/XUzAP8C/BAeX9WCDrUpZ3/dEMBxgPcfbtTVvsYV5Yn32u03B3Ac4P3b8I+vxNBKeeL9dRMAlwO83959qGO78sT769oB7g3w/vGVYFzKE++v6wV4OMD7F7tckFkmT7y/rhHgpQO8b+4Y46XyxPvrugBeNcB7BRiX8sT767oAvmCA9woAHsoT76+rBJjLBnh3txOvkifeX1dswZcO8G6N7sXyxPvr6i340gHe3TnqVfLE++uKAb50gHcXLnrX8sR7gNdPRqwzwLu7Y/FO5Yn3AK9jXCMGeHdgxDuVJ75VAI8ljP7PAb3/RfjcZfePHBB+79dpfpH1CanN30d+mT1h9GqAxxJGM5LQeeQ1+Tb+EQJrElLb38VHQ94TRq900aMIo8cSOo+8Dp8QfsB8zpqE1NO3OI9Zrj1h9EV78PqE0WMJnUdeU6E+Jjyk/hbrEFIfeWbvId8H9oTRFwdZaxJGvziW0Hn0gqYB/wyZ0PwRlxJST+BOw9m77Amj14ii1yGM/txYQudN0qDzGe4EqfA/5GJCagsHcPaEPWH0esekSwmjRxM6b5JEcZ4ww50ilvAOFxBSx4yLW+A/YU8YvfY5+ALC6NGEzhtmyZoFZoarwBLeZxUhtY4rc3bKnjB6TKJjFUHzJoTOozF2YBpsjcyxDgzhQ1YRUse8+J4wenwmaylB82hC5w0zoRXUNXaRBmSMQUqiWSWkLsaVqc/ZE0aPTFUuJWgeTei8SfLZQeMxNaZSIzbII4aE1Nmr13P2hNHjc9E9guYNCZ032YlNwESMLcZiLQHkE4aE1BFg0yAR4z1h9AiAGRA0jyZ03tyIxWMajMPWBIsxYJCnlITU5ShiHYdZ94TR4wCmSxg9jtB5KyPGYzymAYexWEMwAPIsAdYdV6aObmNPGD0aYLoEzaMJnTc0Ygs+YDw0GAtqxBjkuP38bMRWCHn73xNGjz75P73WenCEJnhwyVe3AEe8TtKdJcYhBl97wuhNAObK66lvD/9J9NS75v17wuitAN5fe4D31x7g/bUHeH/tAd5fe4D3AO+vPcD7aw/w/toDvL/2AO+vPcD7aw/w/toDvAd4f/24ABzZ8o+KLsSLS+Pv/TqTb3P4hKlQrTGh+fbIBT0Axqznnb+L/V2mb3HkN5Mb/nEHeK7d4IcDld6lmDW/iH9E+AH1MdOw/Jlu2T1xNmY98sv4wHnD7D3uNHu54WUuOsBTbQuvBsPT/UfzNxGYzwkP8c+Yz3C+r/i6DcyRL/rZ+utRwWH5PmfvcvYEt9jLDS/bg0/B64DWKrQM8AL8FPwS9beQCe6EMKNZYJol37jBMy35otdaz0Bw2H/C2Smc7+WGB0HWDELBmOByA3r5QONo4V+DpzR/hFS4U8wMW1PXNB4TOqYz9urxRV++ntWCw/U59Ty9ebdWbrgfRS9AYKKN63ZokZVygr8GZ/gfIhZXIXPsAlNjPOLBby5c1eOLvmQ9lwkOy5x6QV1j5TYqpS05JtUgUHUp5toHGsVfn4NX4RnMCe+AxTpwmApTYxqMxwfCeJGjpXzRF61nbcHhUBPqWze9svwcHJ+S6NPscKrEjug78Dx8Lj3T8D4YxGIdxmJcwhi34fzZUr7olevZCw5vkOhoClq5zBPZAnygD/Tl9EzDh6kl3VhsHYcDEb+hCtJSvuiV69kLDm+WycrOTArHmB5/VYyP6jOVjwgGawk2zQOaTcc1L+aLXrKeveDwZqlKrw8U9Y1p66uK8dEzdYwBeUQAY7DbyYNezBfdWQ97weEtAKYQg2xJIkuveAT3dYeLGH+ShrWNwZgN0b2YL7qznr3g8JYAo5bQBziPjx7BPZ0d9RCQp4UZbnFdzBddor4XHN4KYMrB2qHFRIzzcLAHQZ5the5ovui94PCWAPefaYnxIdzRwdHCbuR4B+tbiy96Lzi8E4D7z7S0mEPd+eqO3cT53Z0Y8SV80XvB4Z0ADJi/f7X113f+7p7/+UYBvur6657/+YYBvur6657/+aYBvuL6657/+aYBvuL6657/+aYBvuL6657/+aYBvuL6657/+VMA8FXWX/f8z58OgK+y/rrnf75RgLna+uue//lTA/CV1V/3/M837aKvvv6653++UQvmauuve/7nTwfAV1N/3fM/fzr24Cuuv+75nz8FFnxl9dc9//MOr/8/glixwRuUfM4AAAAASUVORK5CYII="}function hCe(){return"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAAAhCAAAAABIXyLAAAAAOElEQVRIx2NgGAWjYBSMglEwEICREYRgFBZBqDCSLA2MGPUIVQETE9iNUAqLR5gIeoQKRgwXjwAAGn4AtaFeYLEAAAAASUVORK5CYII="}var qQ=`
precision mediump float;
precision mediump samplerCube;
precision mediump sampler2D;

#if defined(dVariant_skybox)
    uniform samplerCube tSkybox;
    uniform mat4 uViewDirectionProjectionInverse;
    uniform float uBlur;
    uniform float uOpacity;
    uniform float uSaturation;
    uniform float uLightness;
    uniform mat3 uRotation;
#elif defined(dVariant_image)
    uniform sampler2D tImage;
    uniform vec2 uImageScale;
    uniform vec2 uImageOffset;
    uniform float uBlur;
    uniform float uOpacity;
    uniform float uSaturation;
    uniform float uLightness;
#elif defined(dVariant_horizontalGradient) || defined(dVariant_radialGradient)
    uniform vec3 uGradientColorA;
    uniform vec3 uGradientColorB;
    uniform float uGradientRatio;
#endif

uniform vec2 uTexSize;
uniform vec4 uViewport;
uniform bool uViewportAdjusted;
varying vec4 vPosition;

// TODO: add as general pp option to remove banding?
// Iestyn's RGB dither from http://alex.vlachos.com/graphics/Alex_Vlachos_Advanced_VR_Rendering_GDC2015.pdf
vec3 ScreenSpaceDither(vec2 vScreenPos) {
    vec3 vDither = vec3(dot(vec2(171.0, 231.0), vScreenPos.xy));
    vDither.rgb = fract(vDither.rgb / vec3(103.0, 71.0, 97.0));
    return vDither.rgb / 255.0;
}

vec3 saturateColor(vec3 c, float amount) {
    // https://www.w3.org/TR/WCAG21/#dfn-relative-luminance
    const vec3 W = vec3(0.2125, 0.7154, 0.0721);
    vec3 intensity = vec3(dot(c, W));
    return mix(intensity, c, 1.0 + amount);
}

vec3 lightenColor(vec3 c, float amount) {
    return c + amount;
}

void main() {
    #if defined(dVariant_skybox)
        vec4 t = uViewDirectionProjectionInverse * vPosition;
        #ifdef enabledShaderTextureLod
            gl_FragColor = textureCubeLodEXT(tSkybox, uRotation * normalize(t.xyz / t.w), uBlur * 8.0);
        #else
            gl_FragColor = textureCube(tSkybox, uRotation * normalize(t.xyz / t.w));
        #endif
        gl_FragColor.a = uOpacity;
        gl_FragColor.rgb = lightenColor(saturateColor(gl_FragColor.rgb, uSaturation), uLightness);
    #elif defined(dVariant_image)
        vec2 coords;
        if (uViewportAdjusted) {
            coords = ((gl_FragCoord.xy - uViewport.xy) * (uTexSize / uViewport.zw) / uImageScale) + uImageOffset;
        } else {
            coords = (gl_FragCoord.xy / uImageScale) + uImageOffset;
        }
        #ifdef enabledShaderTextureLod
            gl_FragColor = texture2DLodEXT(tImage, vec2(coords.x, 1.0 - coords.y), uBlur * 8.0);
        #else
            gl_FragColor = texture2D(tImage, vec2(coords.x, 1.0 - coords.y));
        #endif
        gl_FragColor.a = uOpacity;
        gl_FragColor.rgb = lightenColor(saturateColor(gl_FragColor.rgb, uSaturation), uLightness);
    #elif defined(dVariant_horizontalGradient)
        float d;
        if (uViewportAdjusted) {
            d = ((gl_FragCoord.y - uViewport.y) * (uTexSize.y / uViewport.w) / uTexSize.y) + 1.0 - (uGradientRatio * 2.0);
        } else {
            d = (gl_FragCoord.y / uTexSize.y) + 1.0 - (uGradientRatio * 2.0);
        }
        gl_FragColor = vec4(mix(uGradientColorB, uGradientColorA, clamp(d, 0.0, 1.0)), 1.0);
        gl_FragColor.rgb += ScreenSpaceDither(gl_FragCoord.xy);
    #elif defined(dVariant_radialGradient)
        float d;
        if (uViewportAdjusted) {
            d = distance(vec2(0.5), (gl_FragCoord.xy - uViewport.xy) * (uTexSize / uViewport.zw) / uTexSize) + uGradientRatio - 0.5;
        } else {
            d = distance(vec2(0.5), gl_FragCoord.xy / uTexSize) + uGradientRatio - 0.5;
        }
        gl_FragColor = vec4(mix(uGradientColorB, uGradientColorA, 1.0 - clamp(d, 0.0, 1.0)), 1.0);
        gl_FragColor.rgb += ScreenSpaceDither(gl_FragCoord.xy);
    #endif
}
`;var WQ=`
precision mediump float;

attribute vec2 aPosition;

varying vec4 vPosition;

void main() {
    vPosition = vec4(aPosition, 1.0, 1.0);
    gl_Position = vec4(aPosition, 1.0, 1.0);
}
`;function eS(){return eS.zero()}(function(t){function e(){let p=[.1,0,0];return p[0]=0,p}t.zero=e;function r(p,h,f){let b=e();return b[0]=p,b[1]=h,b[2]=f,b}t.create=r;function n(p,h,f,b){return p[0]=h,p[0]=f,p[0]=b,p}t.set=n;function o(p){let h=e();return h[0]=p[0],h[1]=p[1],h[2]=p[2],h}t.clone=o;function i(p,h){return p[0]=h[0],p[1]=h[1],p[2]=h[2],p}t.copy=i;function a(p,h,f){let b=h[0],v=h[4],x=h[8],S=h[1],T=h[5],E=h[9],_=h[2],D=h[6],P=h[10];switch(f){case"XYZ":p[1]=Math.asin(Wo(x,-1,1)),Math.abs(x)<.9999999?(p[0]=Math.atan2(-E,P),p[2]=Math.atan2(-v,b)):(p[0]=Math.atan2(D,T),p[2]=0);break;case"YXZ":p[0]=Math.asin(-Wo(E,-1,1)),Math.abs(E)<.9999999?(p[1]=Math.atan2(x,P),p[2]=Math.atan2(S,T)):(p[1]=Math.atan2(-_,b),p[2]=0);break;case"ZXY":p[0]=Math.asin(Wo(D,-1,1)),Math.abs(D)<.9999999?(p[1]=Math.atan2(-_,P),p[2]=Math.atan2(-v,T)):(p[1]=0,p[2]=Math.atan2(S,b));break;case"ZYX":p[1]=Math.asin(-Wo(_,-1,1)),Math.abs(_)<.9999999?(p[0]=Math.atan2(D,P),p[2]=Math.atan2(S,b)):(p[0]=0,p[2]=Math.atan2(-v,T));break;case"YZX":p[2]=Math.asin(Wo(S,-1,1)),Math.abs(S)<.9999999?(p[0]=Math.atan2(-E,T),p[1]=Math.atan2(-_,b)):(p[0]=0,p[1]=Math.atan2(x,P));break;case"XZY":p[2]=Math.asin(-Wo(v,-1,1)),Math.abs(v)<.9999999?(p[0]=Math.atan2(D,T),p[1]=Math.atan2(x,b)):(p[0]=Math.atan2(-E,P),p[1]=0);break;default:ur(f)}return p}t.fromMat4=a;let s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];function l(p,h,f){return W.fromQuat(s,h),a(p,s,f)}t.fromQuat=l;function c(p,h){return n(p,h[0],h[1],h[2])}t.fromVec3=c;function u(p,h){return p[0]===h[0]&&p[1]===h[1]&&p[2]===h[2]}t.exactEquals=u;function d(p,h,f){return p[0]=h[f+0],p[1]=h[f+1],p[2]=h[f+2],p}t.fromArray=d;function m(p,h,f){return h[f+0]=p[0],h[f+1]=p[1],h[f+2]=p[2],h}t.toArray=m})(eS||(eS={}));var $Q={opacity:g.Numeric(1,{min:0,max:1,step:.01}),saturation:g.Numeric(0,{min:-1,max:1,step:.01}),lightness:g.Numeric(0,{min:-1,max:1,step:.01})},gCe=w({faces:g.MappedStatic("urls",{urls:g.Group({nx:g.Text("",{label:"Negative X / Left"}),ny:g.Text("",{label:"Negative Y / Bottom"}),nz:g.Text("",{label:"Negative Z / Back"}),px:g.Text("",{label:"Positive X / Right"}),py:g.Text("",{label:"Positive Y / Top"}),pz:g.Text("",{label:"Positive Z / Front"})},{isExpanded:!0,label:"URLs"}),files:g.Group({nx:g.File({label:"Negative X / Left",accept:"image/*"}),ny:g.File({label:"Negative Y / Bottom",accept:"image/*"}),nz:g.File({label:"Negative Z / Back",accept:"image/*"}),px:g.File({label:"Positive X / Right",accept:"image/*"}),py:g.File({label:"Positive Y / Top",accept:"image/*"}),pz:g.File({label:"Positive Z / Front",accept:"image/*"})},{isExpanded:!0,label:"Files"})}),blur:g.Numeric(0,{min:0,max:1,step:.01},{description:'Note, this only works in WebGL2 or when "EXT_shader_texture_lod" is available.'}),rotation:g.Group({x:g.Numeric(0,{min:0,max:360,step:1},{immediateUpdate:!0}),y:g.Numeric(0,{min:0,max:360,step:1},{immediateUpdate:!0}),z:g.Numeric(0,{min:0,max:360,step:1},{immediateUpdate:!0})})},$Q),yCe=U(w({source:g.MappedStatic("url",{url:g.Text(""),file:g.File({accept:"image/*"})}),blur:g.Numeric(0,{min:0,max:1,step:.01},{description:'Note, this only works in WebGL2 or with power-of-two images and when "EXT_shader_texture_lod" is available.'})},$Q),{coverage:g.Select("viewport",g.arrayToOptions(["viewport","canvas"]))}),vCe={topColor:g.Color(ce(14540253)),bottomColor:g.Color(ce(15658734)),ratio:g.Numeric(.5,{min:0,max:1,step:.01}),coverage:g.Select("viewport",g.arrayToOptions(["viewport","canvas"]))},bCe={centerColor:g.Color(ce(14540253)),edgeColor:g.Color(ce(15658734)),ratio:g.Numeric(.5,{min:0,max:1,step:.01}),coverage:g.Select("viewport",g.arrayToOptions(["viewport","canvas"]))},ZQ={variant:g.MappedStatic("off",{off:g.EmptyGroup(),skybox:g.Group(gCe,{isExpanded:!0}),image:g.Group(yCe,{isExpanded:!0}),horizontalGradient:g.Group(vCe,{isExpanded:!0}),radialGradient:g.Group(bCe,{isExpanded:!0})},{label:"Environment"})},Jw=class{constructor(e,r,n,o){this.webgl=e,this.assetManager=r,this.camera=new an,this.target=y(),this.position=y(),this.dir=y(),this.renderable=ICe(e,n,o)}setSize(e,r){let[n,o]=this.renderable.values.uTexSize.ref.value;(e!==n||r!==o)&&C.update(this.renderable.values.uTexSize,ne.set(this.renderable.values.uTexSize.ref.value,e,r))}clearSkybox(){this.skybox!==void 0&&(this.skybox.texture.destroy(),this.skybox.assets.forEach(e=>this.assetManager.release(e)),this.skybox=void 0)}updateSkybox(e,r,n){var o;let i=(o=this.skybox)===null||o===void 0?void 0:o.props.faces,a=r.faces.params;if(!a.nx||!a.ny||!a.nz||!a.px||!a.py||!a.pz){this.clearSkybox(),n?.(!1);return}if(!this.skybox||!i||!CCe(r.faces,this.skybox.props.faces)){this.clearSkybox();let{texture:u,assets:d}=TCe(this.webgl,this.assetManager,r.faces,m=>{this.skybox&&(this.skybox.loaded=!m),n?.(!0)});this.skybox={texture:u,props:w({},r),assets:d,loaded:!1},C.update(this.renderable.values.tSkybox,u),this.renderable.update()}else n?.(!1);if(!this.skybox)return;let s=e;e.state.mode==="orthographic"&&(this.camera.setState(U(w({},e.state),{mode:"perspective"})),this.camera.update(),s=this.camera);let l=this.renderable.values.uViewDirectionProjectionInverse.ref.value;y.sub(this.dir,s.state.position,s.state.target),y.setMagnitude(this.dir,this.dir,.1),y.copy(this.position,this.dir),W.lookAt(l,this.position,this.target,s.state.up),W.mul(l,s.projection,l),W.invert(l,l),C.update(this.renderable.values.uViewDirectionProjectionInverse,l);let c=this.renderable.values.uRotation.ref.value;Dt.fromEuler(c,eS.create(or(r.rotation.x),or(r.rotation.y),or(r.rotation.z)),"XYZ"),C.update(this.renderable.values.uRotation,c),C.updateIfChanged(this.renderable.values.uBlur,r.blur),C.updateIfChanged(this.renderable.values.uOpacity,r.opacity),C.updateIfChanged(this.renderable.values.uSaturation,r.saturation),C.updateIfChanged(this.renderable.values.uLightness,r.lightness),C.updateIfChanged(this.renderable.values.dVariant,"skybox"),this.renderable.update()}clearImage(){this.image!==void 0&&(this.image.texture.destroy(),this.assetManager.release(this.image.asset),this.image=void 0)}updateImage(e,r){if(!e.source.params){this.clearImage(),r?.(!1);return}if(!this.image||!this.image.props.source.params||!wCe(e.source,this.image.props.source)){this.clearImage();let{texture:n,asset:o}=_Ce(this.webgl,this.assetManager,e.source,i=>{this.image&&(this.image.loaded=!i),r?.(!0)});this.image={texture:n,props:w({},e),asset:o,loaded:!1},C.update(this.renderable.values.tImage,n),this.renderable.update()}else r?.(!1);this.image&&(C.updateIfChanged(this.renderable.values.uBlur,e.blur),C.updateIfChanged(this.renderable.values.uOpacity,e.opacity),C.updateIfChanged(this.renderable.values.uSaturation,e.saturation),C.updateIfChanged(this.renderable.values.uLightness,e.lightness),C.updateIfChanged(this.renderable.values.uViewportAdjusted,e.coverage==="viewport"),C.updateIfChanged(this.renderable.values.dVariant,"image"),this.renderable.update())}updateImageScaling(){var e,r;let n=this.renderable.values,[o,i]=n.uTexSize.ref.value,a=((e=this.image)===null||e===void 0?void 0:e.texture.getWidth())||0,s=((r=this.image)===null||r===void 0?void 0:r.texture.getHeight())||0,l=o/i,c=a/s;l<c?C.update(n.uImageScale,ne.set(n.uImageScale.ref.value,a*i/s,i)):C.update(n.uImageScale,ne.set(n.uImageScale.ref.value,o,s*o/a));let[u,d]=n.uImageScale.ref.value,m=u/d;m>l?C.update(n.uImageOffset,ne.set(n.uImageOffset.ref.value,(1-l/m)/2,0)):C.update(n.uImageOffset,ne.set(n.uImageOffset.ref.value,0,(1-m/l)/2))}updateGradient(e,r,n,o,i){C.update(this.renderable.values.uGradientColorA,ce.toVec3Normalized(this.renderable.values.uGradientColorA.ref.value,e)),C.update(this.renderable.values.uGradientColorB,ce.toVec3Normalized(this.renderable.values.uGradientColorB.ref.value,r)),C.updateIfChanged(this.renderable.values.uGradientRatio,n),C.updateIfChanged(this.renderable.values.uViewportAdjusted,i),C.updateIfChanged(this.renderable.values.dVariant,o),this.renderable.update()}update(e,r,n){if(r.variant.name==="off"){this.clearSkybox(),this.clearImage(),n?.(!1);return}else r.variant.name==="skybox"?(this.clearImage(),this.updateSkybox(e,r.variant.params,n)):r.variant.name==="image"?(this.clearSkybox(),this.updateImage(r.variant.params,n)):r.variant.name==="horizontalGradient"?(this.clearSkybox(),this.clearImage(),this.updateGradient(r.variant.params.topColor,r.variant.params.bottomColor,r.variant.params.ratio,r.variant.name,r.variant.params.coverage==="viewport"),n?.(!1)):r.variant.name==="radialGradient"&&(this.clearSkybox(),this.clearImage(),this.updateGradient(r.variant.params.centerColor,r.variant.params.edgeColor,r.variant.params.ratio,r.variant.name,r.variant.params.coverage==="viewport"),n?.(!1));let{x:o,y:i,width:a,height:s}=e.viewport;C.update(this.renderable.values.uViewport,at.set(this.renderable.values.uViewport.ref.value,o,i,a,s))}isEnabled(e){return!!(this.skybox&&this.skybox.loaded||this.image&&this.image.loaded||e.variant.name==="horizontalGradient"||e.variant.name==="radialGradient")}isReady(){return!!(this.skybox&&this.skybox.loaded||this.image&&this.image.loaded||this.renderable.values.dVariant.ref.value==="horizontalGradient"||this.renderable.values.dVariant.ref.value==="radialGradient")}render(){this.isReady()&&(this.renderable.values.dVariant.ref.value==="image"&&this.updateImageScaling(),Ee&&this.webgl.timer.mark("BackgroundPass.render"),this.renderable.render(),Ee&&this.webgl.timer.markEnd("BackgroundPass.render"))}dispose(){this.clearSkybox(),this.clearImage()}},XQ="background-skybox";function xCe(t,e){return e.name==="urls"?{nx:Wr.getUrlAsset(t,e.params.nx),ny:Wr.getUrlAsset(t,e.params.ny),nz:Wr.getUrlAsset(t,e.params.nz),px:Wr.getUrlAsset(t,e.params.px),py:Wr.getUrlAsset(t,e.params.py),pz:Wr.getUrlAsset(t,e.params.pz)}:{nx:e.params.nx,ny:e.params.ny,nz:e.params.nz,px:e.params.px,py:e.params.py,pz:e.params.pz}}function SCe(t,e){let r=n=>t.resolve(n,"binary").run().then(o=>new Blob([o.data]));return{nx:r(e.nx),ny:r(e.ny),nz:r(e.nz),px:r(e.px),py:r(e.py),pz:r(e.pz)}}function YQ(t){var e,r,n,o,i,a;return t.name==="urls"?`${XQ}_${t.params.nx}|${t.params.ny}|${t.params.nz}|${t.params.px}|${t.params.py}|${t.params.pz}`:`${XQ}_${(e=t.params.nx)===null||e===void 0?void 0:e.id}|${(r=t.params.ny)===null||r===void 0?void 0:r.id}|${(n=t.params.nz)===null||n===void 0?void 0:n.id}|${(o=t.params.px)===null||o===void 0?void 0:o.id}|${(i=t.params.py)===null||i===void 0?void 0:i.id}|${(a=t.params.pz)===null||a===void 0?void 0:a.id}`}function CCe(t,e){return YQ(t)===YQ(e)}function TCe(t,e,r,n){let o=xCe(e,r),i=SCe(e,o),a=[o.nx,o.ny,o.nz,o.px,o.py,o.pz];return typeof HTMLImageElement>"u"?(console.error('Missing "HTMLImageElement" required for background skybox'),n?.(!0),{texture:un(),assets:a}):{texture:t.resources.cubeTexture(i,!0,n),assets:a}}var QQ="background-image";function KQ(t){var e;return t.name==="url"?`${QQ}_${t.params}`:`${QQ}_${(e=t.params)===null||e===void 0?void 0:e.id}`}function wCe(t,e){return KQ(t)===KQ(e)}function _Ce(t,e,r,n){let o=r.name==="url"?Wr.getUrlAsset(e,r.params):r.params;if(typeof HTMLImageElement>"u")return console.error('Missing "HTMLImageElement" required for background image'),n?.(!0),{texture:un(),asset:o};let i=t.resources.texture("image-uint8","rgba","ubyte","linear"),a=new Image;return a.onload=()=>{i.load(a),(t.isWebGL2||nf(a.width)&&nf(a.height))&&i.mipmap(),n?.()},a.onerror=()=>{n?.(!0)},e.resolve(o,"binary").run().then(s=>{let l=new Blob([s.data]);a.src=URL.createObjectURL(l)}),{texture:i,asset:o}}var PCe={drawCount:Mr("number"),instanceCount:Mr("number"),aPosition:hr("float32",2,0),tSkybox:We("texture","rgba","ubyte","linear"),tImage:We("texture","rgba","ubyte","linear"),uImageScale:ee("v2"),uImageOffset:ee("v2"),uTexSize:ee("v2"),uViewport:ee("v4"),uViewportAdjusted:ee("b"),uViewDirectionProjectionInverse:ee("m4"),uGradientColorA:ee("v3"),uGradientColorB:ee("v3"),uGradientRatio:ee("f"),uBlur:ee("f"),uOpacity:ee("f"),uSaturation:ee("f"),uLightness:ee("f"),uRotation:ee("m3"),dVariant:Ye("string",["skybox","image","verticalGradient","horizontalGradient","radialGradient"])},ECe=Qt("background",WQ,qQ,{shaderTextureLod:"optional"});function ICe(t,e,r){let n={drawCount:C.create(6),instanceCount:C.create(1),aPosition:C.create(Jx),tSkybox:C.create(un()),tImage:C.create(un()),uImageScale:C.create(ne()),uImageOffset:C.create(ne()),uTexSize:C.create(ne.create(e,r)),uViewport:C.create(at()),uViewportAdjusted:C.create(!0),uViewDirectionProjectionInverse:C.create(W()),uGradientColorA:C.create(y()),uGradientColorB:C.create(y()),uGradientRatio:C.create(.5),uBlur:C.create(0),uOpacity:C.create(1),uSaturation:C.create(0),uLightness:C.create(0),uRotation:C.create(Dt.identity()),dVariant:C.create("skybox")},o=w({},PCe),i=dr(t,"triangles",ECe,o,n);return mr(i,n)}var JQ=`
precision highp float;
precision highp int;
precision highp sampler2D;

#include common

uniform sampler2D tDepth;
uniform vec2 uTexSize;
uniform vec4 uBounds;

uniform float uNear;
uniform float uFar;

#if dLightCount != 0
    uniform vec3 uLightDirection[dLightCount];
    uniform vec3 uLightColor[dLightCount];
#endif

uniform mat4 uProjection;
uniform mat4 uInvProjection;

uniform float uMaxDistance;
uniform float uTolerance;
uniform float uBias;

bool isBackground(const in float depth) {
    return depth == 1.0;
}

bool outsideBounds(const in vec2 p) {
    return p.x < uBounds.x || p.y < uBounds.y || p.x > uBounds.z || p.y > uBounds.w;
}

float getViewZ(const in float depth) {
    #if dOrthographic == 1
        return orthographicDepthToViewZ(depth, uNear, uFar);
    #else
        return perspectiveDepthToViewZ(depth, uNear, uFar);
    #endif
}

float getDepth(const in vec2 coords) {
    #ifdef depthTextureSupport
        return texture2D(tDepth, coords).r;
    #else
        return unpackRGBAToDepth(texture2D(tDepth, coords));
    #endif
}

float screenFade(const in vec2 coords) {
    vec2 c = (coords - uBounds.xy) / (uBounds.zw - uBounds.xy);
    vec2 fade = max(12.0 * abs(c - 0.5) - 5.0, vec2(0.0));
    return saturate(1.0 - dot(fade, fade));
}

// based on https://panoskarabelas.com/posts/screen_space_shadows/
float screenSpaceShadow(const in vec3 position, const in vec3 lightDirection, const in float stepLength) {
    // Ray position and direction (in view-space)
    vec3 rayPos = position;
    vec3 rayDir = -lightDirection;

    // Compute ray step
    vec3 rayStep = rayDir * stepLength;

    // Ray march towards the light
    float occlusion = 0.0;
    vec4 rayCoords = vec4(0.0);
    for (int i = 0; i < dSteps; ++i) {
        // Step the ray
        rayPos += rayStep;

        rayCoords = uProjection * vec4(rayPos, 1.0);
        rayCoords.xyz = (rayCoords.xyz / rayCoords.w) * 0.5 + 0.5;

        if (outsideBounds(rayCoords.xy))
            return 1.0;

        // Compute the difference between the ray's and the camera's depth
        float depth = getDepth(rayCoords.xy);
        float viewZ = getViewZ(depth);
        float zDelta = rayPos.z - viewZ;

        if (zDelta < uTolerance) {
            occlusion = 1.0;

            // Fade out as we approach the edges of the screen
            occlusion *= screenFade(rayCoords.xy);

            break;
        }
    }

    return 1.0 - (uBias * occlusion);
}

void main(void) {
    vec2 invTexSize = 1.0 / uTexSize;
    vec2 selfCoords = gl_FragCoord.xy * invTexSize;

    float selfDepth = getDepth(selfCoords);

    if (isBackground(selfDepth)) {
        gl_FragColor = vec4(0.0);
        return;
    }

    vec3 selfViewPos = screenSpaceToViewSpace(vec3(selfCoords, selfDepth), uInvProjection);
    float stepLength = uMaxDistance / float(dSteps);

    float o = 1.0;
    #if dLightCount != 0
        float sh[dLightCount];
        #pragma unroll_loop_start
        for (int i = 0; i < dLightCount; ++i) {
            sh[i] = screenSpaceShadow(selfViewPos, uLightDirection[i], stepLength);
            o = min(o, sh[i]);
        }
        #pragma unroll_loop_end
    #endif

    gl_FragColor = vec4(o);
}
`;var eK=`
precision mediump float;
precision mediump sampler2D;

uniform sampler2D tColor;
uniform vec2 uTexSizeInv;

uniform float uSharpness;

// adapted from https://www.shadertoy.com/view/stXSWB

/*
* FidelityFX Super Resolution scales up a low resolution
* image, while adding fine detail.
*
* MIT Open License
*
* https://gpuopen.com/fsr
*
* Left: FSR processed
* Right: Original texture, bilinear interpolation
*
* Mouse at top: Sharpness 0 stops (maximum)
* Mouse at bottom: Sharpness 2 stops (minimum)
*
* It works in two passes-
*   EASU upsamples the image with a clamped Lanczos kernel.
*   RCAS sharpens the image at the target resolution.
*
* I needed to make a few changes to improve readability and
* WebGL compatibility in an algorithm I don't fully understand.
* Expect bugs.
*
* Shader not currently running for WebGL1 targets (eg. mobile Safari)
*
* There is kind of no point to using FSR in Shadertoy, as it renders buffers
* at full target resolution. But this might be useful for WebGL based demos
* running smaller-than-target render buffers.
*
* For sharpening with a full resolution render buffer,
* FidelityFX CAS is a better option.
* https://www.shadertoy.com/view/ftsXzM
*
* For readability and compatibility, these optimisations have been removed:
*   * Fast approximate inverse and inversesqrt
*   * textureGather fetches (not WebGL compatible)
*   * Multiplying by reciprocal instead of division
*
* Apologies to AMD for the numerous slowdowns and errors I have introduced.
*
*/

/***** RCAS *****/
#define FSR_RCAS_LIMIT (0.25-(1.0/16.0))

// Input callback prototypes that need to be implemented by calling shader
vec4 FsrRcasLoadF(vec2 p);
//------------------------------------------------------------------------------------------------------------------------------
void FsrRcasCon(
    out float con,
    // The scale is {0.0 := maximum, to N>0, where N is the number of stops (halving) of the reduction of sharpness}.
    float sharpness
) {
    // Transform from stops to linear value.
    con = exp2(-sharpness);
}

vec3 FsrRcasF(
    vec2 ip, // Integer pixel position in output.
    float con
) {
    // Constant generated by RcasSetup().
    // Algorithm uses minimal 3x3 pixel neighborhood.
    //    b
    //  d e f
    //    h
    vec2 sp = vec2(ip);
    vec3 b = FsrRcasLoadF(sp + vec2( 0,-1)).rgb;
    vec3 d = FsrRcasLoadF(sp + vec2(-1, 0)).rgb;
    vec3 e = FsrRcasLoadF(sp).rgb;
    vec3 f = FsrRcasLoadF(sp + vec2( 1, 0)).rgb;
    vec3 h = FsrRcasLoadF(sp + vec2( 0, 1)).rgb;

    // Luma times 2.
    float bL = b.g + .5 * (b.b + b.r);
    float dL = d.g + .5 * (d.b + d.r);
    float eL = e.g + .5 * (e.b + e.r);
    float fL = f.g + .5 * (f.b + f.r);
    float hL = h.g + .5 * (h.b + h.r);

    // Noise detection.
    #ifdef dDenoise
        float nz = .25 * (bL + dL + fL + hL) - eL;
        nz=clamp(
            abs(nz)
            /(
                max(max(bL,dL),max(eL,max(fL,hL)))
                -min(min(bL,dL),min(eL,min(fL,hL)))
            ),
            0., 1.
        );
        nz=1.-.5*nz;
    #endif

    // Min and max of ring.
    vec3 mn4 = min(b, min(f, h));
    vec3 mx4 = max(b, max(f, h));

    // Immediate constants for peak range.
    vec2 peakC = vec2(1., -4.);

    // Limiters, these need to be high precision RCPs.
    vec3 hitMin = mn4 / (4. * mx4);
    vec3 hitMax = (peakC.x - mx4) / (4.* mn4 + peakC.y);
    vec3 lobeRGB = max(-hitMin, hitMax);
    float lobe = max(
        -FSR_RCAS_LIMIT,
        min(max(lobeRGB.r, max(lobeRGB.g, lobeRGB.b)), 0.)
    )*con;

    // Apply noise removal.
    #ifdef dDenoise
        lobe *= nz;
    #endif

    // Resolve, which needs the medium precision rcp approximation to avoid visible tonality changes.
    return (lobe * (b + d + h + f) + e) / (4. * lobe + 1.);
}


vec4 FsrRcasLoadF(vec2 p) {
    return texture2D(tColor, p * uTexSizeInv);
}

void main() {
    // Set up constants
    float con;
    FsrRcasCon(con, uSharpness);

    // Perform RCAS pass
    vec3 col = FsrRcasF(gl_FragCoord.xy, con);

    gl_FragColor = vec4(col, FsrRcasLoadF(gl_FragCoord.xy).a);
}
`;var tK={sharpness:g.Numeric(.5,{min:0,max:1,step:.05}),denoise:g.Boolean(!0)},e_=class{constructor(e,r){this.webgl=e,this.renderable=kCe(e,r)}updateState(e){let{gl:r,state:n}=this.webgl;n.enable(r.SCISSOR_TEST),n.disable(r.BLEND),n.disable(r.DEPTH_TEST),n.depthMask(!1);let{x:o,y:i,width:a,height:s}=e;n.viewport(o,i,a,s),n.scissor(o,i,a,s),n.clearColor(0,0,0,1),r.clear(r.COLOR_BUFFER_BIT)}setSize(e,r){C.update(this.renderable.values.uTexSizeInv,ne.set(this.renderable.values.uTexSizeInv.ref.value,1/e,1/r))}update(e,r){let{values:n}=this.renderable,{sharpness:o,denoise:i}=r,a=!1;n.tColor.ref.value!==e&&(C.update(this.renderable.values.tColor,e),a=!0),C.updateIfChanged(n.uSharpness,2-2*Math.pow(o,.25)),n.dDenoise.ref.value!==i&&(a=!0),C.updateIfChanged(n.dDenoise,i),a&&this.renderable.update()}render(e,r){Ee&&this.webgl.timer.mark("CasPass.render"),r?r.bind():this.webgl.unbindFramebuffer(),this.updateState(e),this.renderable.render(),Ee&&this.webgl.timer.markEnd("CasPass.render")}},DCe=U(w({},Er),{tColor:We("texture","rgba","ubyte","linear"),uTexSizeInv:ee("v2"),uSharpness:ee("f"),dDenoise:Ye("boolean")}),ACe=Qt("cas",zr,eK);function kCe(t,e){let r=e.getWidth(),n=e.getHeight(),o=U(w({},Ir),{tColor:C.create(e),uTexSizeInv:C.create(ne.create(1/r,1/n)),uSharpness:C.create(.5),dDenoise:C.create(!0)}),i=w({},DCe),a=dr(t,"triangles",ACe,i,o);return mr(a,o)}var rK=`
precision highp float;
precision highp int;
precision highp sampler2D;

#include common

uniform sampler2D tColor;
uniform sampler2D tDepthOpaque;
uniform sampler2D tDepthTransparent;

uniform vec2 uTexSize;
uniform vec4 uBounds;

uniform float uBlurSpread;
uniform float uInFocus;
uniform float uPPM;

uniform float uNear; // Near plane
uniform float uFar;  // Far plane

uniform mat4 uInvProjection; // Inverse projection
uniform mat4 uProjection; // projection

uniform int uMode; // 0-planar, 1-spherical
uniform vec3 uCenter; // Center of focus sphere in view space

// Function to convert depth value from depth buffer to view space Z
float getViewZ(const in float depth) {
    #if dOrthographic == 1
        return orthographicDepthToViewZ(depth, uNear, uFar);
    #else
        return perspectiveDepthToViewZ(depth, uNear, uFar);
    #endif
}

// Retrieve depth from opaque depth texture
float getDepthOpaque(const in vec2 coords) {
    #ifdef depthTextureSupport
        return texture2D(tDepthOpaque, coords).r;
    #else
        return unpackRGBAToDepth(texture2D(tDepthOpaque, coords));
    #endif
}

// Retrieve depth from transparent depth texture
float getDepthTransparent(const in vec2 coords) {
    return unpackRGBAToDepth(texture2D(tDepthTransparent, coords));
}

bool isBackground(const in float depth) {
    return depth == 1.0;
}

float getDepth(const in vec2 coords) {
    return min(getDepthOpaque(coords), getDepthTransparent(coords));
}

float getCOC(vec2 uv) {
    float depth = getDepth(uv);
    float viewDist = getViewZ(depth);
    vec3 aposition = screenSpaceToViewSpace(vec3(uv.xy, depth), uInvProjection);
    float focusDist = length(aposition - uCenter);
    float coc = 0.0;  // Circle of Confusion
    if (uMode == 0) { // planar Depth of field
        coc = (abs(viewDist) - uInFocus) / uPPM;  //focus distance, focus range
    } else if(uMode == 1) { // spherical Depth of field
        coc = focusDist / uPPM ;
    }
    coc = clamp(coc, -1.0, 1.0);
    return coc;
}

// Simple box blur for blurring the image
vec3 getBlurredImage(vec2 coords) {
    vec4 blurColor = vec4(0);
    vec2 texelSize = vec2(1.0 / uTexSize.x, 1.0 / uTexSize.y);
    float count = 0.0;
    for (int x = 0; x < int(dBlurSize); x++) {
        for (int y = 0; y < int(dBlurSize); y++) {
            vec2 offset = vec2(float(x) - float(dBlurSize) / 2.0, float(y) - float(dBlurSize) / 2.0);
            vec2 uvPixel = coords.xy + offset * texelSize * uBlurSpread;
            float coc = getCOC(uvPixel);
            coc = smoothstep(0.0, 1.0, abs(coc));
            // mix blurColor with new color with weight coc
            blurColor.rgb = blurColor.rgb + texture2D(tColor, uvPixel).xyz * coc;
            count+=coc;
        }
    }
    blurColor = blurColor / count;
    return blurColor.rgb;
}

// simplification from https://catlikecoding.com/unity/tutorials/advanced-rendering/depth-of-field/
void main() {
    vec2 uv = gl_FragCoord.xy / uTexSize;
    vec4 color = texture2D(tColor, uv);
    float depth = getDepth(uv);

    float viewDist = getViewZ(depth);

    vec3 aposition = screenSpaceToViewSpace(vec3(uv.xy, depth), uInvProjection);
    float focusDist = length(aposition - uCenter);
    vec3 blurColor = getBlurredImage(uv);

    float coc = getCOC(uv); // Circle of Confusion

    // for debugging the coc
    // color.rgb = (coc < 0.0) ? (1.0 - abs(coc)) * vec3(1.0,0.0,0.0) : vec3(0.0, 1.0 - coc, 0.0) ;//mix(color.rgb, blurColor.rgb, abs(coc));
    color.rgb = mix(color.rgb, blurColor, smoothstep(0.0, 1.0, abs(coc))); // Smooth blending based on CoC
    gl_FragColor = color;
}
`;var nK={blurSize:g.Numeric(9,{min:1,max:32,step:1}),blurSpread:g.Numeric(1,{min:0,max:10,step:.1}),inFocus:g.Numeric(0,{min:-5e3,max:5e3,step:1},{description:"Distance from the scene center that will be in focus"}),PPM:g.Numeric(20,{min:0,max:5e3,step:.1},{description:"Size of the area that will be in focus"}),center:g.Select("camera-target",g.arrayToOptions(["scene-center","camera-target"])),mode:g.Select("plane",g.arrayToOptions(["plane","sphere"]))},Sm=class{static isEnabled(e){return e.dof.name!=="off"}constructor(e,r,n){this.webgl=e,this.target=e.createRenderTarget(r,n,!1);let o=un();this.renderable=LCe(e,o,o,o)}updateState(e){let{gl:r,state:n}=this.webgl;n.enable(r.SCISSOR_TEST),n.disable(r.BLEND),n.disable(r.DEPTH_TEST),n.depthMask(!1);let{x:o,y:i,width:a,height:s}=e;n.viewport(o,i,a,s),n.scissor(o,i,a,s),n.clearColor(0,0,0,1),r.clear(r.COLOR_BUFFER_BIT)}setSize(e,r){let n=this.target.texture.getWidth(),o=this.target.texture.getHeight();(e!==n||r!==o)&&(this.target.setSize(e,r),C.update(this.renderable.values.uTexSize,ne.set(this.renderable.values.uTexSize.ref.value,e,r)))}update(e,r,n,o,i,a){let s=!1;this.renderable.values.tColor.ref.value!==r&&(C.update(this.renderable.values.tColor,r),s=!0),this.renderable.values.tDepthOpaque.ref.value!==n&&(C.update(this.renderable.values.tDepthOpaque,n),s=!0),this.renderable.values.tDepthTransparent.ref.value!==o&&(C.update(this.renderable.values.tDepthTransparent,o),s=!0);let l=e.state.mode==="orthographic"?1:0,c=this.renderable.values.uInvProjection.ref.value;W.invert(c,e.projection);let[u,d]=this.renderable.values.uTexSize.ref.value,m=e.viewport;C.update(this.renderable.values.uProjection,e.projection),C.update(this.renderable.values.uInvProjection,c),C.update(this.renderable.values.uMode,i.mode==="sphere"?1:0),at.set(this.renderable.values.uBounds.ref.value,m.x/u,m.y/d,(m.x+m.width)/u,(m.y+m.height)/d),C.update(this.renderable.values.uBounds,this.renderable.values.uBounds.ref.value),C.updateIfChanged(this.renderable.values.uNear,e.near),C.updateIfChanged(this.renderable.values.uFar,e.far),C.updateIfChanged(this.renderable.values.dOrthographic,l),this.renderable.values.dBlurSize.ref.value!==i.blurSize&&(C.update(this.renderable.values.dBlurSize,i.blurSize),s=!0);let p=i.center==="scene-center"?a.center:e.state.target,f=y.distance(e.state.position,p)+i.inFocus;C.updateIfChanged(this.renderable.values.uInFocus,f);let b=this.renderable.values.uCenter.ref.value;y.transformMat4(b,p,e.view),C.update(this.renderable.values.uCenter,b),C.updateIfChanged(this.renderable.values.uBlurSpread,i.blurSpread),C.updateIfChanged(this.renderable.values.uPPM,i.PPM),s&&this.renderable.update()}render(e,r){Ee&&this.webgl.timer.mark("DofPass.render"),r?r.bind():this.webgl.unbindFramebuffer(),this.updateState(e),this.renderable.render(),Ee&&this.webgl.timer.markEnd("DofPass.render")}},MCe=U(w({},Er),{tDepthOpaque:We("texture","rgba","ubyte","nearest"),tDepthTransparent:We("texture","rgba","ubyte","nearest"),tColor:We("texture","rgba","ubyte","nearest"),uTexSize:ee("v2"),uProjection:ee("m4"),uInvProjection:ee("m4"),uBounds:ee("v4"),uCenter:ee("v3"),uMode:ee("i"),dOrthographic:Ye("number"),uNear:ee("f"),uFar:ee("f"),dBlurSize:Ye("number"),uBlurSpread:ee("f"),uInFocus:ee("f"),uPPM:ee("f")}),RCe=Qt("dof",zr,rK);function LCe(t,e,r,n){let o=e.getWidth(),i=e.getHeight(),a=U(w({},Ir),{tDepthOpaque:C.create(r),tDepthTransparent:C.create(n),tColor:C.create(e),uTexSize:C.create(ne.create(o,i)),uProjection:C.create(W.identity()),uInvProjection:C.create(W.identity()),uBounds:C.create(at()),uCenter:C.create(y()),uMode:C.create(0),dOrthographic:C.create(0),uNear:C.create(1),uFar:C.create(1e4),dBlurSize:C.create(5),uBlurSpread:C.create(300),uInFocus:C.create(20),uPPM:C.create(20)}),s=w({},MCe),l=dr(t,"triangles",RCe,s,a);return mr(l,a)}var oK=`
precision highp float;
precision highp int;
precision highp sampler2D;

uniform vec2 uTexSizeInv;

uniform sampler2D tBlur1;
uniform sampler2D tBlur2;
uniform sampler2D tBlur3;
uniform sampler2D tBlur4;
uniform sampler2D tBlur5;
uniform float uBloomStrength;
uniform float uBloomRadius;
uniform float uBloomFactors[5];
uniform vec3 uBloomTints[5];

float lerpBloomFactor(const in float factor) {
    float mirrorFactor = 1.2 - factor;
    return mix(factor, mirrorFactor, uBloomRadius);
}

void main(void) {
    vec2 coords = gl_FragCoord.xy * uTexSizeInv;

    gl_FragColor = uBloomStrength * (
        lerpBloomFactor(uBloomFactors[0]) * vec4(uBloomTints[0], 1.0) * texture2D(tBlur1, coords) +
        lerpBloomFactor(uBloomFactors[1]) * vec4(uBloomTints[1], 1.0) * texture2D(tBlur2, coords) +
        lerpBloomFactor(uBloomFactors[2]) * vec4(uBloomTints[2], 1.0) * texture2D(tBlur3, coords) +
        lerpBloomFactor(uBloomFactors[3]) * vec4(uBloomTints[3], 1.0) * texture2D(tBlur4, coords) +
        lerpBloomFactor(uBloomFactors[4]) * vec4(uBloomTints[4], 1.0) * texture2D(tBlur5, coords)
    );
}
`;var iK=`
precision highp float;
precision highp int;
precision highp sampler2D;

uniform sampler2D tColor;
uniform sampler2D tEmissive;
uniform sampler2D tDepth;
uniform vec2 uTexSizeInv;

uniform vec3 uDefaultColor;
uniform float uDefaultOpacity;
uniform float uLuminosityThreshold;
uniform float uSmoothWidth;

#include common

float getDepth(const in vec2 coords) {
    #ifdef depthTextureSupport
        return texture2D(tDepth, coords).r;
    #else
        return unpackRGBAToDepth(texture2D(tDepth, coords));
    #endif
}

bool isBackground(const in float depth) {
    return depth == 1.0;
}

void main(void) {
    vec2 coords = gl_FragCoord.xy * uTexSizeInv;
    vec4 texel = texture2D(tColor, coords);
    float emissive = texture2D(tEmissive, coords).a;
    float depth = getDepth(coords);

    if (isBackground(depth)) {
        gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
        return;
    }

    vec4 outputColor = vec4(uDefaultColor.rgb, uDefaultOpacity);

    #if defined(dMode_luminosity)
        vec3 luma = vec3(0.299, 0.587, 0.114);
        float v = dot(texel.xyz, luma);
        float alpha = smoothstep(uLuminosityThreshold, uLuminosityThreshold + uSmoothWidth, v);

        gl_FragColor = mix(outputColor, texel, alpha);
    #elif defined(dMode_emissive)
        gl_FragColor = mix(outputColor, texel, emissive);
    #endif
}
`;var aK=`
precision highp float;
precision highp int;
precision highp sampler2D;

uniform sampler2D tInput;
uniform vec2 uTexSizeInv;

uniform vec2 uDirection;
uniform float uGaussianCoefficients[dKernelRadius];

void main(void) {
    vec2 coords = gl_FragCoord.xy * uTexSizeInv;
    float weightSum = uGaussianCoefficients[0];
    vec4 diffuseSum = texture2D(tInput, coords) * weightSum;

    for(int i = 1; i < dKernelRadius; ++i) {
        float x = float(i);
        float w = uGaussianCoefficients[i];
        vec2 offset = uDirection * uTexSizeInv * x;
        vec4 sample1 = texture2D(tInput, coords + offset);
        vec4 sample2 = texture2D(tInput, coords - offset);
        diffuseSum += (sample1 + sample2) * w;
        weightSum += 2.0 * w;
    }

    gl_FragColor = diffuseSum / weightSum;
}
`;var ZR=5,sK={strength:g.Numeric(1,{min:0,max:3,step:.1}),radius:g.Numeric(0,{min:0,max:1,step:.01}),threshold:g.Numeric(0,{min:0,max:1,step:.01},{description:"Luminosity threshold",hideIf:t=>t.mode==="emissive"}),mode:g.Select("emissive",[["luminosity","Luminosity"],["emissive","Emissive"]])},t_=class{static isEnabled(e){return e.bloom.name==="on"}constructor(e,r,n){this.webgl=e,this.horizontalBlurTargets=[],this.verticalBlurTargets=[],this.emissiveTarget=e.createRenderTarget(r,n,!0,"uint8","linear","rgba"),this.luminosityTarget=e.createRenderTarget(r,n,!1,"uint8","linear"),this.compositeTarget=e.createRenderTarget(r,n,!1,"uint8","linear");let o=Math.round(r/2),i=Math.round(n/2);for(let s=0;s<ZR;++s)this.horizontalBlurTargets[s]=e.createRenderTarget(o,i,!1,"uint8","linear"),this.verticalBlurTargets[s]=e.createRenderTarget(o,i,!1,"uint8","linear"),o=Math.round(o/2),i=Math.round(i/2);let a=un();this.luminosityRenderable=FCe(e,a,a,a),this.blurRenderable=HCe(e,a),this.compositeRenderable=XCe(e,r,n,this.verticalBlurTargets[0].texture,this.verticalBlurTargets[1].texture,this.verticalBlurTargets[2].texture,this.verticalBlurTargets[3].texture,this.verticalBlurTargets[4].texture),this.copyRenderable=dp(e,this.compositeTarget.texture)}setSize(e,r){let n=this.luminosityTarget.getWidth(),o=this.luminosityTarget.getHeight();if(e!==n||r!==o){this.emissiveTarget.setSize(e,r),this.luminosityTarget.setSize(e,r),this.compositeTarget.setSize(e,r);let i=Math.round(e/2),a=Math.round(r/2);for(let s=0;s<ZR;++s)this.horizontalBlurTargets[s].setSize(i,a),this.verticalBlurTargets[s].setSize(i,a),i=Math.round(i/2),a=Math.round(a/2);C.update(this.luminosityRenderable.values.uTexSizeInv,ne.set(this.compositeRenderable.values.uTexSizeInv.ref.value,1/e,1/r)),C.update(this.compositeRenderable.values.uTexSizeInv,ne.set(this.compositeRenderable.values.uTexSizeInv.ref.value,1/e,1/r)),C.update(this.copyRenderable.values.uTexSize,ne.set(this.copyRenderable.values.uTexSize.ref.value,e,r))}}update(e,r,n,o){let i=!1;this.luminosityRenderable.values.tColor.ref.value!==e&&(C.update(this.luminosityRenderable.values.tColor,e),i=!0),this.luminosityRenderable.values.tEmissive.ref.value!==r&&(C.update(this.luminosityRenderable.values.tEmissive,r),i=!0),this.luminosityRenderable.values.tDepth.ref.value!==n&&(C.update(this.luminosityRenderable.values.tDepth,n),i=!0),this.luminosityRenderable.values.dMode.ref.value!==o.mode&&(C.update(this.luminosityRenderable.values.dMode,o.mode),i=!0),C.updateIfChanged(this.luminosityRenderable.values.uLuminosityThreshold,o.threshold),i&&this.luminosityRenderable.update();let a=!1;this.blurRenderable.values.tInput.ref.value!==e&&(C.update(this.blurRenderable.values.tInput,e),a=!0),a&&this.blurRenderable.update(),C.update(this.compositeRenderable.values.uBloomRadius,o.radius),C.update(this.compositeRenderable.values.uBloomStrength,o.strength)}render(e,r){Ee&&this.webgl.timer.mark("BloomPass.render");let{gl:n,state:o}=this.webgl,{x:i,y:a,width:s,height:l}=e;o.viewport(i,a,s,l),o.scissor(i,a,s,l),o.enable(n.SCISSOR_TEST),o.disable(n.BLEND),o.disable(n.DEPTH_TEST),o.depthMask(!1),this.luminosityTarget.bind(),this.luminosityRenderable.render();for(let c=0;c<ZR;++c){let u=this.horizontalBlurTargets[c].getWidth(),d=this.horizontalBlurTargets[c].getHeight();o.viewport(0,0,u,d),o.scissor(0,0,u,d),C.update(this.blurRenderable.values.dKernelRadius,JR[c]),C.update(this.blurRenderable.values.uGaussianCoefficients,VCe(JR[c])),C.update(this.blurRenderable.values.uTexSizeInv,ne.set(this.blurRenderable.values.uTexSizeInv.ref.value,1/u,1/d)),this.horizontalBlurTargets[c].bind(),C.update(this.blurRenderable.values.tInput,c===0?this.luminosityTarget.texture:this.verticalBlurTargets[c-1].texture),C.update(this.blurRenderable.values.uDirection,zCe),this.blurRenderable.update(),this.blurRenderable.render(),this.verticalBlurTargets[c].bind(),C.update(this.blurRenderable.values.tInput,this.horizontalBlurTargets[c].texture),C.update(this.blurRenderable.values.uDirection,UCe),this.blurRenderable.update(),this.blurRenderable.render()}o.viewport(i,a,s,l),o.scissor(i,a,s,l),this.compositeTarget.bind(),this.compositeRenderable.update(),this.compositeRenderable.render(),r?r.bind():this.webgl.unbindFramebuffer(),o.enable(n.BLEND),o.blendFunc(n.ONE,n.ONE),this.copyRenderable.render(),Ee&&this.webgl.timer.markEnd("BloomPass.render")}},BCe=U(w({},Er),{tColor:We("texture","rgba","ubyte","linear"),tEmissive:We("texture","rgba","ubyte","linear"),tDepth:We("texture","rgba","ubyte","nearest"),uTexSizeInv:ee("v2"),uDefaultColor:ee("v3"),uDefaultOpacity:ee("f"),uLuminosityThreshold:ee("f"),uSmoothWidth:ee("f"),dMode:Ye("string",["luminosity","emissive"])}),OCe=Qt("Bloom Luminosity",zr,iK);function FCe(t,e,r,n){let o=e.getWidth(),i=e.getHeight(),a=U(w({},Ir),{tColor:C.create(e),tEmissive:C.create(r),tDepth:C.create(n),uTexSizeInv:C.create(ne.create(1/o,1/i)),uDefaultColor:C.create(y()),uDefaultOpacity:C.create(0),uLuminosityThreshold:C.create(0),uSmoothWidth:C.create(1),dMode:C.create("emissive")}),s=w({},BCe),l=dr(t,"triangles",OCe,s,a);return mr(l,a)}function NCe(t){let e=[];for(let r=0;r<t;++r)e.push(.39894*Math.exp(-.5*r*r/(t*t))/t);return e}var VCe=Pg(NCe),JR=[3,5,7,9,11],zCe=ne.create(1,0),UCe=ne.create(0,1),GCe=U(w({},Er),{tInput:We("texture","rgba","ubyte","linear"),uTexSizeInv:ee("v2"),uDirection:ee("v2"),uGaussianCoefficients:ee("f[]"),dKernelRadius:Ye("number")}),jCe=Qt("Bloom Blur",zr,aK);function HCe(t,e){let r=e.getWidth(),n=e.getHeight(),o=U(w({},Ir),{tInput:C.create(e),uTexSizeInv:C.create(ne.create(1/r,1/n)),uDirection:C.create(ne()),uGaussianCoefficients:C.create([]),dKernelRadius:C.create(JR[0])}),i=w({},GCe),a=dr(t,"triangles",jCe,i,o);return mr(a,o)}var qCe=U(w({},Er),{tBlur1:We("texture","rgba","ubyte","linear"),tBlur2:We("texture","rgba","ubyte","linear"),tBlur3:We("texture","rgba","ubyte","linear"),tBlur4:We("texture","rgba","ubyte","linear"),tBlur5:We("texture","rgba","ubyte","linear"),uTexSizeInv:ee("v2"),uBloomStrength:ee("f"),uBloomRadius:ee("f"),uBloomFactors:ee("f[]"),uBloomTints:ee("v3[]")}),WCe=Qt("Bloom Composite",zr,oK);function XCe(t,e,r,n,o,i,a,s){let l=U(w({},Ir),{uTexSizeInv:C.create(ne.create(e,r)),tBlur1:C.create(n),tBlur2:C.create(o),tBlur3:C.create(i),tBlur4:C.create(a),tBlur5:C.create(s),uBloomStrength:C.create(1),uBloomRadius:C.create(0),uBloomFactors:C.create([1,.8,.6,.4,.2]),uBloomTints:C.create(new Array(15).fill(1))}),c=w({},qCe),u=dr(t,"triangles",WCe,c,l);return mr(u,l)}var YCe=U(w({},Er),{tDepthOpaque:We("texture","rgba","ubyte","nearest"),tDepthTransparent:We("texture","rgba","ubyte","nearest"),uTexSize:ee("v2"),dOrthographic:Ye("number"),uNear:ee("f"),uFar:ee("f"),uInvProjection:ee("m4"),uOutlineThreshold:ee("f"),dTransparentOutline:Ye("boolean")});function QCe(t,e,r,n){let o=e.getWidth(),i=e.getHeight(),a=U(w({},Ir),{tDepthOpaque:C.create(e),tDepthTransparent:C.create(r),uTexSize:C.create(ne.create(o,i)),dOrthographic:C.create(0),uNear:C.create(1),uFar:C.create(1e4),uInvProjection:C.create(W.identity()),uOutlineThreshold:C.create(.33),dTransparentOutline:C.create(n)}),s=w({},YCe),l=Qt("outlines",zr,MQ),c=dr(t,"triangles",l,s,a);return mr(c,a)}var KCe=U(w({},Er),{tDepth:We("texture","rgba","ubyte","nearest"),uTexSize:ee("v2"),uProjection:ee("m4"),uInvProjection:ee("m4"),uBounds:ee("v4"),dOrthographic:Ye("number"),uNear:ee("f"),uFar:ee("f"),dSteps:Ye("number"),uMaxDistance:ee("f"),uTolerance:ee("f"),uBias:ee("f"),uLightDirection:ee("v3[]"),uLightColor:ee("v3[]"),dLightCount:Ye("number")});function $Ce(t,e){let r=e.getWidth(),n=e.getHeight(),o=U(w({},Ir),{tDepth:C.create(e),uTexSize:C.create(ne.create(r,n)),uProjection:C.create(W.identity()),uInvProjection:C.create(W.identity()),uBounds:C.create(at()),dOrthographic:C.create(0),uNear:C.create(1),uFar:C.create(1e4),dSteps:C.create(1),uMaxDistance:C.create(3),uTolerance:C.create(1),uBias:C.create(.6),uLightDirection:C.create([]),uLightColor:C.create([]),dLightCount:C.create(0)}),i=w({},KCe),a=Qt("shadows",zr,JQ),s=dr(t,"triangles",a,i,o);return mr(s,o)}var ZCe=U(w({},Er),{tDepth:We("texture","rgba","ubyte","nearest"),tDepthHalf:We("texture","rgba","ubyte","nearest"),tDepthQuarter:We("texture","rgba","ubyte","nearest"),uSamples:ee("v3[]"),dNSamples:Ye("number"),uProjection:ee("m4"),uInvProjection:ee("m4"),uBounds:ee("v4"),uTexSize:ee("v2"),uRadius:ee("f"),uBias:ee("f"),dMultiScale:Ye("boolean"),dLevels:Ye("number"),uLevelRadius:ee("f[]"),uLevelBias:ee("f[]"),uNearThreshold:ee("f"),uFarThreshold:ee("f")});function JCe(t,e,r,n){let o=U(w({},Ir),{tDepth:C.create(e),tDepthHalf:C.create(r),tDepthQuarter:C.create(n),uSamples:C.create(uK(32)),dNSamples:C.create(32),uProjection:C.create(W.identity()),uInvProjection:C.create(W.identity()),uBounds:C.create(at()),uTexSize:C.create(ne.create(t.gl.drawingBufferWidth,t.gl.drawingBufferHeight)),uRadius:C.create(Math.pow(2,5)),uBias:C.create(.8),dMultiScale:C.create(!1),dLevels:C.create(3),uLevelRadius:C.create([Math.pow(2,2),Math.pow(2,5),Math.pow(2,8)]),uLevelBias:C.create([.8,.8,.8]),uNearThreshold:C.create(10),uFarThreshold:C.create(1500)}),i=w({},ZCe),a=Qt("ssao",zr,RQ),s=dr(t,"triangles",a,i,o);return mr(s,o)}var eTe=U(w({},Er),{tSsaoDepth:We("texture","rgba","ubyte","nearest"),uTexSize:ee("v2"),uKernel:ee("f[]"),dOcclusionKernelSize:Ye("number"),uBlurDirectionX:ee("f"),uBlurDirectionY:ee("f"),uInvProjection:ee("m4"),uNear:ee("f"),uFar:ee("f"),uBounds:ee("v4"),dOrthographic:Ye("number")});function lK(t,e,r){let n=U(w({},Ir),{tSsaoDepth:C.create(e),uTexSize:C.create(ne.create(e.getWidth(),e.getHeight())),uKernel:C.create(cK(15)),dOcclusionKernelSize:C.create(15),uBlurDirectionX:C.create(r==="horizontal"?1:0),uBlurDirectionY:C.create(r==="vertical"?1:0),uInvProjection:C.create(W.identity()),uNear:C.create(0),uFar:C.create(1e4),uBounds:C.create(at()),dOrthographic:C.create(0)}),o=w({},eTe),i=Qt("ssao_blur",zr,LQ),a=dr(t,"triangles",i,o,n);return mr(a,n)}function cK(t){let e=t/3,r=Math.floor((t+1)/2),n=[];for(let o=0;o<r;o++)n.push(1/(Math.sqrt(2*Math.PI)*e)*Math.exp(-o*o/(2*e*e)));return n}var r_=[];for(let t=0;t<256;t++){let e=y();e[0]=Math.random()*2-1,e[1]=Math.random()*2-1,e[2]=Math.random(),y.normalize(e,e),y.scale(e,e,Math.random()),r_.push(e)}function uK(t){let e=[];for(let r=0;r<t;r++){let n=(r*r+2*r+1)/(t*t);n=.1+n*(1-.1),e.push(r_[r][0]*n),e.push(r_[r][1]*n),e.push(r_[r][2]*n)}return e}var tTe=U(w({},Er),{tSsaoDepth:We("texture","rgba","ubyte","nearest"),tColor:We("texture","rgba","ubyte","nearest"),tDepthOpaque:We("texture","rgba","ubyte","nearest"),tDepthTransparent:We("texture","rgba","ubyte","nearest"),tShadows:We("texture","rgba","ubyte","nearest"),tOutlines:We("texture","rgba","ubyte","nearest"),uTexSize:ee("v2"),dOrthographic:Ye("number"),uNear:ee("f"),uFar:ee("f"),uFogNear:ee("f"),uFogFar:ee("f"),uFogColor:ee("v3"),uOutlineColor:ee("v3"),uOcclusionColor:ee("v3"),uTransparentBackground:ee("b"),dOcclusionEnable:Ye("boolean"),uOcclusionOffset:ee("v2"),dShadowEnable:Ye("boolean"),dOutlineEnable:Ye("boolean"),dOutlineScale:Ye("number"),dTransparentOutline:Ye("boolean")});function rTe(t,e,r,n,o,i,a,s){let l=U(w({},Ir),{tSsaoDepth:C.create(a),tColor:C.create(e),tDepthOpaque:C.create(r),tDepthTransparent:C.create(n),tShadows:C.create(o),tOutlines:C.create(i),uTexSize:C.create(ne.create(e.getWidth(),e.getHeight())),dOrthographic:C.create(0),uNear:C.create(1),uFar:C.create(1e4),uFogNear:C.create(1e4),uFogFar:C.create(1e4),uFogColor:C.create(y.create(1,1,1)),uOutlineColor:C.create(y.create(0,0,0)),uOcclusionColor:C.create(y.create(0,0,0)),uTransparentBackground:C.create(!1),dOcclusionEnable:C.create(!0),uOcclusionOffset:C.create(ne.create(0,0)),dShadowEnable:C.create(!1),dOutlineEnable:C.create(!1),dOutlineScale:C.create(1),dTransparentOutline:C.create(s)}),c=w({},tTe),u=Qt("postprocessing",zr,BQ),d=dr(t,"triangles",u,c,l);return mr(d,l)}var Rv={occlusion:g.MappedStatic("on",{on:g.Group({samples:g.Numeric(32,{min:1,max:256,step:1}),multiScale:g.MappedStatic("off",{on:g.Group({levels:g.ObjectList({radius:g.Numeric(5,{min:0,max:20,step:.1},{description:"Final occlusion radius is 2^x"}),bias:g.Numeric(1,{min:0,max:3,step:.1})},t=>`${t.radius}, ${t.bias}`,{defaultValue:[{radius:2,bias:1},{radius:5,bias:1},{radius:8,bias:1},{radius:11,bias:1}]}),nearThreshold:g.Numeric(10,{min:0,max:50,step:1}),farThreshold:g.Numeric(1500,{min:0,max:1e4,step:100})}),off:g.Group({})},{cycle:!0}),radius:g.Numeric(5,{min:0,max:20,step:.1},{description:"Final occlusion radius is 2^x",hideIf:t=>t?.multiScale.name==="on"}),bias:g.Numeric(.8,{min:0,max:3,step:.1}),blurKernelSize:g.Numeric(15,{min:1,max:25,step:2}),resolutionScale:g.Numeric(1,{min:.1,max:1,step:.05},{description:"Adjust resolution of occlusion calculation"}),color:g.Color(ce(0))}),off:g.Group({})},{cycle:!0,description:"Darken occluded crevices with the ambient occlusion effect"}),shadow:g.MappedStatic("off",{on:g.Group({steps:g.Numeric(1,{min:1,max:64,step:1}),bias:g.Numeric(.6,{min:0,max:1,step:.01}),maxDistance:g.Numeric(3,{min:0,max:256,step:1}),tolerance:g.Numeric(1,{min:0,max:10,step:.1})}),off:g.Group({})},{cycle:!0,description:"Simplistic shadows"}),outline:g.MappedStatic("off",{on:g.Group({scale:g.Numeric(1,{min:1,max:5,step:1}),threshold:g.Numeric(.33,{min:.01,max:1,step:.01}),color:g.Color(ce(0)),includeTransparent:g.Boolean(!0,{description:"Whether to show outline for transparent objects"})}),off:g.Group({})},{cycle:!0,description:"Draw outline around 3D objects"}),dof:g.MappedStatic("off",{on:g.Group(nK),off:g.Group({})},{cycle:!0,description:"DOF"}),antialiasing:g.MappedStatic("smaa",{fxaa:g.Group(FQ),smaa:g.Group(HQ),off:g.Group({})},{options:[["fxaa","FXAA"],["smaa","SMAA"],["off","Off"]],description:"Smooth pixel edges"}),sharpening:g.MappedStatic("off",{on:g.Group(tK),off:g.Group({})},{cycle:!0,description:"Contrast Adaptive Sharpening"}),background:g.Group(ZQ,{isFlat:!0}),bloom:g.MappedStatic("on",{on:g.Group(sK),off:g.Group({})},{cycle:!0,description:"Bloom"})};function nTe(t,e){let r=t.length,{radius:n,bias:o}=e||{radius:new Array(r*3).fill(0),bias:new Array(r*3).fill(0)};t=t.slice().sort((i,a)=>i.radius-a.radius);for(let i=0;i<r;++i){let a=t[i];n[i]=Math.pow(2,a.radius),o[i]=a.bias}return{count:r,radius:n,bias:o}}var ls=class{static isEnabled(e){return e.occlusion.name==="on"||e.shadow.name==="on"||e.outline.name==="on"||e.background.variant.name!=="off"}static isTransparentOutlineEnabled(e){return e.outline.name==="on"&&e.outline.params.includeTransparent}calcSsaoScale(e){return Math.min(1,1/this.webgl.pixelRatio)*e}constructor(e,r,n){this.webgl=e,this.drawPass=n,this.bgColor=y(),this.occlusionOffset=[0,0],this.transparentBackground=!1;let{colorTarget:o,depthTextureTransparent:i,depthTextureOpaque:a}=n,s=o.getWidth(),l=o.getHeight();this.nSamples=1,this.blurKernelSize=1,this.ssaoScale=this.calcSsaoScale(1),this.levels=[],this.target=e.createRenderTarget(s,l,!1,"uint8","linear"),this.outlinesTarget=e.createRenderTarget(s,l,!1),this.outlinesRenderable=QCe(e,a,i,!0),this.shadowsTarget=e.createRenderTarget(s,l,!1),this.shadowsRenderable=$Ce(e,a),this.ssaoFramebuffer=e.resources.framebuffer(),this.ssaoBlurFirstPassFramebuffer=e.resources.framebuffer(),this.ssaoBlurSecondPassFramebuffer=e.resources.framebuffer();let c=Math.floor(s*this.ssaoScale),u=Math.floor(l*this.ssaoScale),d=Math.max(1,Math.floor(c*.5)),m=Math.max(1,Math.floor(u*.5)),p=Math.max(1,Math.floor(c*.25)),h=Math.max(1,Math.floor(u*.25));this.downsampledDepthTarget=n.packedDepth?e.createRenderTarget(c,u,!1,"uint8","nearest","rgba"):e.createRenderTarget(c,u,!1,"float32","nearest",e.isWebGL2?"alpha":"rgba"),this.downsampleDepthRenderable=dp(e,a);let f=this.ssaoScale===1?a:this.downsampledDepthTarget.texture;this.depthHalfTarget=n.packedDepth?e.createRenderTarget(d,m,!1,"uint8","nearest","rgba"):e.createRenderTarget(d,m,!1,"float32","nearest",e.isWebGL2?"alpha":"rgba"),this.depthHalfRenderable=dp(e,f),this.depthQuarterTarget=n.packedDepth?e.createRenderTarget(p,h,!1,"uint8","nearest","rgba"):e.createRenderTarget(p,h,!1,"float32","nearest",e.isWebGL2?"alpha":"rgba"),this.depthQuarterRenderable=dp(e,this.depthHalfTarget.texture),this.ssaoDepthTexture=e.resources.texture("image-uint8","rgba","ubyte","nearest"),this.ssaoDepthTexture.define(c,u),this.ssaoDepthTexture.attachFramebuffer(this.ssaoFramebuffer,"color0"),this.ssaoDepthBlurProxyTexture=e.resources.texture("image-uint8","rgba","ubyte","nearest"),this.ssaoDepthBlurProxyTexture.define(c,u),this.ssaoDepthBlurProxyTexture.attachFramebuffer(this.ssaoBlurFirstPassFramebuffer,"color0"),this.ssaoDepthTexture.attachFramebuffer(this.ssaoBlurSecondPassFramebuffer,"color0"),this.ssaoRenderable=JCe(e,f,this.depthHalfTarget.texture,this.depthQuarterTarget.texture),this.ssaoBlurFirstPassRenderable=lK(e,this.ssaoDepthTexture,"horizontal"),this.ssaoBlurSecondPassRenderable=lK(e,this.ssaoDepthBlurProxyTexture,"vertical"),this.renderable=rTe(e,o.texture,a,i,this.shadowsTarget.texture,this.outlinesTarget.texture,this.ssaoDepthTexture,!0),this.background=new Jw(e,r,s,l)}setSize(e,r){let[n,o]=this.renderable.values.uTexSize.ref.value,i=this.calcSsaoScale(1);if(e!==n||r!==o||this.ssaoScale!==i){this.ssaoScale=i,this.target.setSize(e,r),this.outlinesTarget.setSize(e,r),this.shadowsTarget.setSize(e,r);let a=Math.floor(e*this.ssaoScale),s=Math.floor(r*this.ssaoScale);this.downsampledDepthTarget.setSize(a,s),this.ssaoDepthTexture.define(a,s),this.ssaoDepthBlurProxyTexture.define(a,s);let l=Math.max(1,Math.floor(a*.5)),c=Math.max(1,Math.floor(s*.5));this.depthHalfTarget.setSize(l,c);let u=Math.max(1,Math.floor(a*.25)),d=Math.max(1,Math.floor(s*.25));this.depthQuarterTarget.setSize(u,d),C.update(this.renderable.values.uTexSize,ne.set(this.renderable.values.uTexSize.ref.value,e,r)),C.update(this.outlinesRenderable.values.uTexSize,ne.set(this.outlinesRenderable.values.uTexSize.ref.value,e,r)),C.update(this.shadowsRenderable.values.uTexSize,ne.set(this.shadowsRenderable.values.uTexSize.ref.value,e,r)),C.update(this.downsampleDepthRenderable.values.uTexSize,ne.set(this.downsampleDepthRenderable.values.uTexSize.ref.value,a,s)),C.update(this.depthHalfRenderable.values.uTexSize,ne.set(this.depthHalfRenderable.values.uTexSize.ref.value,l,c)),C.update(this.depthQuarterRenderable.values.uTexSize,ne.set(this.depthQuarterRenderable.values.uTexSize.ref.value,u,d)),C.update(this.ssaoRenderable.values.uTexSize,ne.set(this.ssaoRenderable.values.uTexSize.ref.value,a,s)),C.update(this.ssaoBlurFirstPassRenderable.values.uTexSize,ne.set(this.ssaoBlurFirstPassRenderable.values.uTexSize.ref.value,a,s)),C.update(this.ssaoBlurSecondPassRenderable.values.uTexSize,ne.set(this.ssaoBlurSecondPassRenderable.values.uTexSize.ref.value,a,s));let m=this.ssaoScale===1?this.drawPass.depthTextureOpaque:this.downsampledDepthTarget.texture;C.update(this.depthHalfRenderable.values.tColor,m),C.update(this.ssaoRenderable.values.tDepth,m),this.depthHalfRenderable.update(),this.ssaoRenderable.update(),this.background.setSize(e,r)}}updateState(e,r,n,o,i){var a;let s=!1,l=!1,c=!1,u=!1,d=!1,m=!1,p=e.state.mode==="orthographic"?1:0,h=o.outline.name==="on",f=o.shadow.name==="on",b=o.occlusion.name==="on",v=W.identity();W.invert(v,e.projection);let[x,S]=this.renderable.values.uTexSize.ref.value,T=e.viewport;if(o.occlusion.name==="on"){C.update(this.ssaoRenderable.values.uProjection,e.projection),C.update(this.ssaoRenderable.values.uInvProjection,v);let D=this.ssaoRenderable.values.uBounds,P=this.ssaoScale;at.set(D.ref.value,Math.floor(T.x*P)/(x*P),Math.floor(T.y*P)/(S*P),Math.ceil((T.x+T.width)*P)/(x*P),Math.ceil((T.y+T.height)*P)/(S*P)),C.update(D,D.ref.value),C.update(this.ssaoBlurFirstPassRenderable.values.uBounds,D.ref.value),C.update(this.ssaoBlurSecondPassRenderable.values.uBounds,D.ref.value),C.updateIfChanged(this.ssaoBlurFirstPassRenderable.values.uNear,e.near),C.updateIfChanged(this.ssaoBlurSecondPassRenderable.values.uNear,e.near),C.updateIfChanged(this.ssaoBlurFirstPassRenderable.values.uFar,e.far),C.updateIfChanged(this.ssaoBlurSecondPassRenderable.values.uFar,e.far),C.update(this.ssaoBlurFirstPassRenderable.values.uInvProjection,v),C.update(this.ssaoBlurSecondPassRenderable.values.uInvProjection,v),this.ssaoBlurFirstPassRenderable.values.dOrthographic.ref.value!==p&&(u=!0,C.update(this.ssaoBlurFirstPassRenderable.values.dOrthographic,p),C.update(this.ssaoBlurSecondPassRenderable.values.dOrthographic,p)),this.nSamples!==o.occlusion.params.samples&&(c=!0,this.nSamples=o.occlusion.params.samples,C.update(this.ssaoRenderable.values.uSamples,uK(this.nSamples)),C.updateIfChanged(this.ssaoRenderable.values.dNSamples,this.nSamples));let A=o.occlusion.params.multiScale.name==="on";if(this.ssaoRenderable.values.dMultiScale.ref.value!==A&&(c=!0,C.update(this.ssaoRenderable.values.dMultiScale,A)),o.occlusion.params.multiScale.name==="on"){let k=o.occlusion.params.multiScale.params;if(!ys(this.levels,k.levels)){c=!0,this.levels=k.levels;let M=nTe(k.levels);C.updateIfChanged(this.ssaoRenderable.values.dLevels,M.count),C.update(this.ssaoRenderable.values.uLevelRadius,M.radius),C.update(this.ssaoRenderable.values.uLevelBias,M.bias)}C.updateIfChanged(this.ssaoRenderable.values.uNearThreshold,k.nearThreshold),C.updateIfChanged(this.ssaoRenderable.values.uFarThreshold,k.farThreshold)}else C.updateIfChanged(this.ssaoRenderable.values.uRadius,Math.pow(2,o.occlusion.params.radius));if(C.updateIfChanged(this.ssaoRenderable.values.uBias,o.occlusion.params.bias),this.blurKernelSize!==o.occlusion.params.blurKernelSize){u=!0,this.blurKernelSize=o.occlusion.params.blurKernelSize;let k=cK(this.blurKernelSize);C.update(this.ssaoBlurFirstPassRenderable.values.uKernel,k),C.update(this.ssaoBlurSecondPassRenderable.values.uKernel,k),C.update(this.ssaoBlurFirstPassRenderable.values.dOcclusionKernelSize,this.blurKernelSize),C.update(this.ssaoBlurSecondPassRenderable.values.dOcclusionKernelSize,this.blurKernelSize)}let I=this.calcSsaoScale(o.occlusion.params.resolutionScale);if(this.ssaoScale!==I){c=!0,d=!0,this.ssaoScale=I;let k=Math.floor(x*this.ssaoScale),M=Math.floor(S*this.ssaoScale);this.downsampledDepthTarget.setSize(k,M),this.ssaoDepthTexture.define(k,M),this.ssaoDepthBlurProxyTexture.define(k,M);let R=Math.floor(k*.5),B=Math.floor(M*.5);this.depthHalfTarget.setSize(R,B);let F=Math.floor(k*.25),G=Math.floor(M*.25);this.depthQuarterTarget.setSize(F,G);let V=this.ssaoScale===1?this.drawPass.depthTextureOpaque:this.downsampledDepthTarget.texture;C.update(this.depthHalfRenderable.values.tColor,V),C.update(this.ssaoRenderable.values.tDepth,V),C.update(this.ssaoRenderable.values.tDepthHalf,this.depthHalfTarget.texture),C.update(this.ssaoRenderable.values.tDepthQuarter,this.depthQuarterTarget.texture),C.update(this.downsampleDepthRenderable.values.uTexSize,ne.set(this.downsampleDepthRenderable.values.uTexSize.ref.value,k,M)),C.update(this.depthHalfRenderable.values.uTexSize,ne.set(this.depthHalfRenderable.values.uTexSize.ref.value,R,B)),C.update(this.depthQuarterRenderable.values.uTexSize,ne.set(this.depthQuarterRenderable.values.uTexSize.ref.value,F,G)),C.update(this.ssaoRenderable.values.uTexSize,ne.set(this.ssaoRenderable.values.uTexSize.ref.value,k,M)),C.update(this.ssaoBlurFirstPassRenderable.values.uTexSize,ne.set(this.ssaoBlurFirstPassRenderable.values.uTexSize.ref.value,k,M)),C.update(this.ssaoBlurSecondPassRenderable.values.uTexSize,ne.set(this.ssaoBlurSecondPassRenderable.values.uTexSize.ref.value,k,M))}C.update(this.renderable.values.uOcclusionColor,ce.toVec3Normalized(this.renderable.values.uOcclusionColor.ref.value,o.occlusion.params.color))}if(o.shadow.name==="on"&&(C.update(this.shadowsRenderable.values.uProjection,e.projection),C.update(this.shadowsRenderable.values.uInvProjection,v),at.set(this.shadowsRenderable.values.uBounds.ref.value,T.x/x,T.y/S,(T.x+T.width)/x,(T.y+T.height)/S),C.update(this.shadowsRenderable.values.uBounds,this.shadowsRenderable.values.uBounds.ref.value),C.updateIfChanged(this.shadowsRenderable.values.uNear,e.near),C.updateIfChanged(this.shadowsRenderable.values.uFar,e.far),this.shadowsRenderable.values.dOrthographic.ref.value!==p&&(C.update(this.shadowsRenderable.values.dOrthographic,p),s=!0),C.updateIfChanged(this.shadowsRenderable.values.uMaxDistance,o.shadow.params.maxDistance),C.updateIfChanged(this.shadowsRenderable.values.uTolerance,o.shadow.params.tolerance),C.updateIfChanged(this.shadowsRenderable.values.uBias,o.shadow.params.bias),this.shadowsRenderable.values.dSteps.ref.value!==o.shadow.params.steps&&(C.update(this.shadowsRenderable.values.dSteps,o.shadow.params.steps),s=!0),C.update(this.shadowsRenderable.values.uLightDirection,i.direction),C.update(this.shadowsRenderable.values.uLightColor,i.color),this.shadowsRenderable.values.dLightCount.ref.value!==i.count&&(C.update(this.shadowsRenderable.values.dLightCount,i.count),s=!0)),o.outline.name==="on"){let D=(a=o.outline.params.includeTransparent)!==null&&a!==void 0?a:!0,P=Math.max(1,Math.round(o.outline.params.scale*this.webgl.pixelRatio))-1,A=50*o.outline.params.threshold*this.webgl.pixelRatio;C.updateIfChanged(this.outlinesRenderable.values.uNear,e.near),C.updateIfChanged(this.outlinesRenderable.values.uFar,e.far),C.update(this.outlinesRenderable.values.uInvProjection,v),this.outlinesRenderable.values.dTransparentOutline.ref.value!==D&&(m=!0,C.update(this.outlinesRenderable.values.dTransparentOutline,D)),this.outlinesRenderable.values.dOrthographic.ref.value!==p&&(m=!0,C.update(this.outlinesRenderable.values.dOrthographic,p)),C.updateIfChanged(this.outlinesRenderable.values.uOutlineThreshold,A),C.update(this.renderable.values.uOutlineColor,ce.toVec3Normalized(this.renderable.values.uOutlineColor.ref.value,o.outline.params.color)),this.renderable.values.dOutlineScale.ref.value!==P&&(l=!0,C.update(this.renderable.values.dOutlineScale,P)),this.renderable.values.dTransparentOutline.ref.value!==D&&(l=!0,C.update(this.renderable.values.dTransparentOutline,D))}C.updateIfChanged(this.renderable.values.uFar,e.far),C.updateIfChanged(this.renderable.values.uNear,e.near),C.updateIfChanged(this.renderable.values.uFogFar,e.fogFar),C.updateIfChanged(this.renderable.values.uFogNear,e.fogNear),C.update(this.renderable.values.uFogColor,ce.toVec3Normalized(this.renderable.values.uFogColor.ref.value,n)),C.updateIfChanged(this.renderable.values.uTransparentBackground,r),this.renderable.values.dOrthographic.ref.value!==p&&(l=!0,C.update(this.renderable.values.dOrthographic,p)),this.renderable.values.dOutlineEnable.ref.value!==h&&(l=!0,C.update(this.renderable.values.dOutlineEnable,h)),this.renderable.values.dShadowEnable.ref.value!==f&&(l=!0,C.update(this.renderable.values.dShadowEnable,f)),this.renderable.values.dOcclusionEnable.ref.value!==b&&(l=!0,C.update(this.renderable.values.dOcclusionEnable,b)),m&&this.outlinesRenderable.update(),s&&this.shadowsRenderable.update(),c&&this.ssaoRenderable.update(),u&&(this.ssaoBlurFirstPassRenderable.update(),this.ssaoBlurSecondPassRenderable.update()),d&&this.depthHalfRenderable.update(),l&&this.renderable.update();let{gl:E,state:_}=this.webgl;_.enable(E.SCISSOR_TEST),_.disable(E.BLEND),_.disable(E.DEPTH_TEST),_.depthMask(!1)}setOcclusionOffset(e,r){this.occlusionOffset[0]=e,this.occlusionOffset[1]=r,C.update(this.renderable.values.uOcclusionOffset,ne.set(this.renderable.values.uOcclusionOffset.ref.value,e,r))}setTransparentBackground(e){this.transparentBackground=e}render(e,r,n,o,i,a){Ee&&this.webgl.timer.mark("PostprocessingPass.render"),this.updateState(e,n,o,i,a);let{gl:s,state:l}=this.webgl,{x:c,y:u,width:d,height:m}=e.viewport;if(i.occlusion.name==="on"&&this.occlusionOffset[0]===0&&this.occlusionOffset[1]===0){Ee&&this.webgl.timer.mark("SSAO.render");let p=Math.floor(c*this.ssaoScale),h=Math.floor(u*this.ssaoScale),f=Math.ceil(d*this.ssaoScale),b=Math.ceil(m*this.ssaoScale);l.viewport(p,h,f,b),l.scissor(p,h,f,b),this.ssaoScale<1&&(Ee&&this.webgl.timer.mark("SSAO.downsample"),this.downsampledDepthTarget.bind(),this.downsampleDepthRenderable.render(),Ee&&this.webgl.timer.markEnd("SSAO.downsample")),Ee&&this.webgl.timer.mark("SSAO.half"),this.depthHalfTarget.bind(),this.depthHalfRenderable.render(),Ee&&this.webgl.timer.markEnd("SSAO.half"),Ee&&this.webgl.timer.mark("SSAO.quarter"),this.depthQuarterTarget.bind(),this.depthQuarterRenderable.render(),Ee&&this.webgl.timer.markEnd("SSAO.quarter"),this.ssaoFramebuffer.bind(),this.ssaoRenderable.render(),this.ssaoBlurFirstPassFramebuffer.bind(),this.ssaoBlurFirstPassRenderable.render(),this.ssaoBlurSecondPassFramebuffer.bind(),this.ssaoBlurSecondPassRenderable.render(),Ee&&this.webgl.timer.markEnd("SSAO.render")}l.viewport(c,u,d,m),l.scissor(c,u,d,m),i.outline.name==="on"&&(this.outlinesTarget.bind(),this.outlinesRenderable.render()),i.shadow.name==="on"&&(this.shadowsTarget.bind(),this.shadowsRenderable.render()),r?this.webgl.unbindFramebuffer():this.target.bind(),this.background.update(e,i.background),this.background.isEnabled(i.background)?(this.transparentBackground?l.clearColor(0,0,0,0):(ce.toVec3Normalized(this.bgColor,o),l.clearColor(this.bgColor[0],this.bgColor[1],this.bgColor[2],1)),s.clear(s.COLOR_BUFFER_BIT),l.enable(s.BLEND),l.blendFuncSeparate(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA,s.ONE,s.ONE_MINUS_SRC_ALPHA),this.background.render()):(l.clearColor(0,0,0,1),s.clear(s.COLOR_BUFFER_BIT)),this.renderable.render(),Ee&&this.webgl.timer.markEnd("PostprocessingPass.render")}},uh=class{static isEnabled(e){return e.antialiasing.name!=="off"}constructor(e,r,n){this.target=e.createRenderTarget(r,n,!1),this.internalTarget=e.createRenderTarget(r,n,!1),this.fxaa=new $w(e,this.target.texture),this.smaa=new Zw(e,this.target.texture),this.cas=new e_(e,this.target.texture)}setSize(e,r){let n=this.target.texture.getWidth(),o=this.target.texture.getHeight();(e!==n||r!==o)&&(this.target.setSize(e,r),this.internalTarget.setSize(e,r),this.fxaa.setSize(e,r),this.smaa.supported&&this.smaa.setSize(e,r),this.cas.setSize(e,r))}_renderFxaa(e,r,n,o){o.antialiasing.name==="fxaa"&&(this.fxaa.update(r,o.antialiasing.params),this.fxaa.render(e.viewport,n))}_renderSmaa(e,r,n,o){o.antialiasing.name==="smaa"&&(this.smaa.update(r,o.antialiasing.params),this.smaa.render(e.viewport,n))}_renderAntialiasing(e,r,n,o){o.antialiasing.name==="fxaa"?this._renderFxaa(e,r,n,o):o.antialiasing.name==="smaa"&&this._renderSmaa(e,r,n,o)}_renderCas(e,r,n,o){o.sharpening.name==="on"&&(o.antialiasing.name!=="off"&&(r=this.internalTarget.texture),this.cas.update(r,o.sharpening.params),this.cas.render(e.viewport,n))}render(e,r,n,o){if(o.antialiasing.name==="off"&&o.sharpening.name==="off")return;if(o.antialiasing.name==="smaa"&&!this.smaa.supported){console.error('SMAA not supported, missing "HTMLImageElement"');return}let i=n===!0?void 0:n===!1?this.target:n;o.sharpening.name==="off"?this._renderAntialiasing(e,r,i,o):o.antialiasing.name==="off"?this._renderCas(e,r,i,o):(this._renderAntialiasing(e,r,this.internalTarget,o),this._renderCas(e,r,i,o))}};var dK=`
precision highp float;
precision highp sampler2D;

uniform sampler2D tColor;
uniform vec2 uTexSize;
uniform float uWeight;

void main() {
    vec2 coords = gl_FragCoord.xy / uTexSize;
    gl_FragColor = texture2D(tColor, coords) * uWeight;
}
`;var oTe=U(w({},Er),{tColor:We("texture","rgba","ubyte","nearest"),uTexSize:ee("v2"),uWeight:ee("f")}),iTe=Qt("compose",zr,dK);function aTe(t,e){let r=U(w({},Ir),{tColor:C.create(e),uTexSize:C.create(ne.create(e.getWidth(),e.getHeight())),uWeight:C.create(1)}),n=w({},oTe),o=dr(t,"triangles",iTe,n,r);return mr(o,r)}var n_={mode:g.Select("temporal",[["off","Off"],["on","On"],["temporal","Temporal"]]),sampleLevel:g.Numeric(2,{min:0,max:5,step:1},{description:"Take level^2 samples."}),reduceFlicker:g.Boolean(!0,{description:'Reduce flicker in "temporal" mode.'})},Ep=class{static isEnabled(e){return e.mode!=="off"}constructor(e,r){this.webgl=e,this.drawPass=r;let{colorBufferFloat:n,textureFloat:o,colorBufferHalfFloat:i,textureHalfFloat:a}=e.extensions,s=r.colorTarget.getWidth(),l=r.colorTarget.getHeight();this.colorTarget=e.createRenderTarget(s,l,!1);let c=i&&a?"fp16":n&&o?"float32":"uint8";this.composeTarget=e.createRenderTarget(s,l,!1,c),this.holdTarget=e.createRenderTarget(s,l,!1),this.compose=aTe(e,r.colorTarget.texture)}syncSize(){let e=this.drawPass.colorTarget.getWidth(),r=this.drawPass.colorTarget.getHeight(),[n,o]=this.compose.values.uTexSize.ref.value;(e!==n||r!==o)&&(this.colorTarget.setSize(e,r),this.composeTarget.setSize(e,r),this.holdTarget.setSize(e,r),C.update(this.compose.values.uTexSize,ne.set(this.compose.values.uTexSize.ref.value,e,r)))}render(e,r,n,o,i){return n.multiSample.mode==="temporal"&&!i?this.renderTemporalMultiSample(e,r,n,o):(this.renderMultiSample(r,o,n),-2)}bindOutputTarget(e){e?this.webgl.unbindFramebuffer():this.colorTarget.bind()}renderMultiSample(e,r,n){let{camera:o}=e,{compose:i,composeTarget:a,drawPass:s,webgl:l}=this,{gl:c,state:u}=l;Ee&&l.timer.mark("MultiSamplePass.renderMultiSample");let d=eL[Math.max(0,Math.min(n.multiSample.sampleLevel,5))],{x:m,y:p,width:h,height:f}=o.viewport,b=1/d.length,v=1/32;o.viewOffset.enabled=!0,C.update(i.values.tColor,s.getColorTarget(n.postprocessing).texture),i.update();for(let x=0;x<d.length;++x){let S=d[x];an.setViewOffset(o.viewOffset,h,f,S[0],S[1],h,f),o.update();let T=-.5+(x+.5)/d.length,E=b+v*T;C.update(i.values.uWeight,E),x===0?s.postprocessing.setOcclusionOffset(0,0):s.postprocessing.setOcclusionOffset(S[0]/h,S[1]/f),s.render(e,n,!1),a.bind(),u.enable(c.BLEND),u.blendEquationSeparate(c.FUNC_ADD,c.FUNC_ADD),u.blendFuncSeparate(c.ONE,c.ONE,c.ONE,c.ONE),u.disable(c.DEPTH_TEST),u.depthMask(!1),u.viewport(m,p,h,f),u.scissor(m,p,h,f),x===0&&(u.clearColor(0,0,0,0),c.clear(c.COLOR_BUFFER_BIT)),i.render()}s.postprocessing.setOcclusionOffset(0,0),C.update(i.values.uWeight,1),C.update(i.values.tColor,a.texture),i.update(),this.bindOutputTarget(r),u.viewport(m,p,h,f),u.scissor(m,p,h,f),u.disable(c.BLEND),i.render(),o.viewOffset.enabled=!1,o.update(),Ee&&l.timer.markEnd("MultiSamplePass.renderMultiSample")}renderTemporalMultiSample(e,r,n,o){let{camera:i}=r,{compose:a,composeTarget:s,holdTarget:l,drawPass:c,webgl:u}=this,{gl:d,state:m}=u;Ee&&u.timer.mark("MultiSamplePass.renderTemporalMultiSample");let p=eL[Math.max(0,Math.min(n.multiSample.sampleLevel,5))];if(e===-2||e>=p.length)return-2;let{x:h,y:f,width:b,height:v}=i.viewport,x=1/p.length;if(e===-1)c.render(r,n,!1),C.update(a.values.uWeight,1),C.update(a.values.tColor,c.getColorTarget(n.postprocessing).texture),a.update(),l.bind(),m.disable(d.BLEND),m.disable(d.DEPTH_TEST),m.depthMask(!1),m.viewport(h,f,b,v),m.scissor(h,f,b,v),a.render(),e+=1;else{i.viewOffset.enabled=!0,C.update(a.values.tColor,c.getColorTarget(n.postprocessing).texture),C.update(a.values.uWeight,x),a.update();let T=Math.pow(2,Math.max(0,n.multiSample.sampleLevel-2));for(let E=0;E<T;++E){let _=p[e];if(an.setViewOffset(i.viewOffset,b,v,_[0],_[1],b,v),i.update(),e===0?c.postprocessing.setOcclusionOffset(0,0):c.postprocessing.setOcclusionOffset(_[0]/b,_[1]/v),c.render(r,n,!1),s.bind(),m.enable(d.BLEND),m.blendEquationSeparate(d.FUNC_ADD,d.FUNC_ADD),m.blendFuncSeparate(d.ONE,d.ONE,d.ONE,d.ONE),m.disable(d.DEPTH_TEST),m.depthMask(!1),m.viewport(h,f,b,v),m.scissor(h,f,b,v),e===0&&(m.clearColor(0,0,0,0),d.clear(d.COLOR_BUFFER_BIT)),a.render(),e+=1,e>=p.length)break}}c.postprocessing.setOcclusionOffset(0,0),this.bindOutputTarget(o),m.viewport(h,f,b,v),m.scissor(h,f,b,v);let S=e*x;return S>0&&(C.update(a.values.uWeight,1),C.update(a.values.tColor,s.texture),a.update(),m.disable(d.BLEND),a.render()),S<1&&(C.update(a.values.uWeight,1-S),C.update(a.values.tColor,l.texture),a.update(),S===0?m.disable(d.BLEND):m.enable(d.BLEND),a.render()),i.viewOffset.enabled=!1,i.update(),Ee&&u.timer.markEnd("MultiSamplePass.renderTemporalMultiSample"),e>=p.length?-2:e}},eL=[[[0,0]],[[0,0],[-4,-4]],[[0,0],[6,-2],[-6,2],[2,6]],[[0,0],[-1,3],[5,1],[-3,-5],[-5,5],[-7,-1],[3,7],[7,-7]],[[0,0],[-1,-3],[-3,2],[4,-1],[-5,-2],[2,5],[5,3],[3,-5],[-2,6],[0,-7],[-4,-6],[-6,4],[-8,0],[7,-4],[6,7],[-7,-8]],[[0,0],[-7,-5],[-3,-5],[-5,-4],[-1,-4],[-2,-2],[-6,-1],[-4,0],[-7,1],[-1,2],[-6,3],[-3,3],[-7,6],[-3,6],[-5,7],[-1,7],[5,-7],[1,-6],[6,-5],[4,-4],[2,-3],[7,-2],[1,-1],[4,-1],[2,1],[6,2],[0,4],[4,4],[2,5],[7,5],[5,6],[3,7]]];eL.forEach(t=>{t.forEach(e=>{e[0]*=.0625,e[1]*=.0625})});var Lv=class{update(e,r){return e&&(this.sampleIndex=-1),r.mode==="temporal"?this.sampleIndex!==-2:!1}render(e,r,n,o){return this.sampleIndex=this.multiSamplePass.render(this.sampleIndex,e,r,n,!!o),this.sampleIndex<0}constructor(e){this.multiSamplePass=e,this.sampleIndex=-2}};var tL={eyeSeparation:g.Numeric(.062,{min:.02,max:.1,step:.001},{description:"Distance between left and right camera."}),focus:g.Numeric(10,{min:1,max:20,step:.1},{description:"Apparent object distance."})},sTe=g.getDefaultValues(tL);var Dd=class{get viewport(){return this.parent.viewport}get viewOffset(){return this.parent.viewOffset}constructor(e,r={}){this.parent=e,this.left=new o_,this.right=new o_,this.props=w(w({},sTe),r)}setProps(e){Object.assign(this.props,e)}update(){this.parent.update(),lTe(this.parent,this.props,this.left,this.right)}};(function(t){function e(r){return"left"in r&&"right"in r}t.is=e})(Dd||(Dd={}));var o_=class{constructor(){this.viewport=_n.create(0,0,0,0),this.view=W(),this.projection=W(),this.projectionView=W(),this.inverseProjectionView=W(),this.state=an.createDefaultSnapshot(),this.viewOffset=an.ViewOffset(),this.far=0,this.near=0,this.fogFar=0,this.fogNear=0}},mK=W.identity(),pK=W.identity();function lTe(t,e,r,n){_n.copy(r.viewport,t.viewport),W.copy(r.view,t.view),W.copy(r.projection,t.projection),an.copySnapshot(r.state,t.state),an.copyViewOffset(r.viewOffset,t.viewOffset),r.far=t.far,r.near=t.near,r.fogFar=t.fogFar,r.fogNear=t.fogNear,_n.copy(n.viewport,t.viewport),W.copy(n.view,t.view),W.copy(n.projection,t.projection),an.copySnapshot(n.state,t.state),an.copyViewOffset(n.viewOffset,t.viewOffset),n.far=t.far,n.near=t.near,n.fogFar=t.fogFar,n.fogNear=t.fogNear;let o=Math.floor(t.viewport.width/2),i=o/t.viewport.height;r.viewport.width=o,n.viewport.x+=o,n.viewport.width-=o;let a=e.eyeSeparation/2,s=a*t.near/e.focus,l=t.near*Math.tan(t.state.fov*.5),c,u;mK[12]=-a,pK[12]=a,c=-l*i+s,u=l*i+s,r.projection[0]=2*t.near/(u-c),r.projection[8]=(u+c)/(u-c),W.mul(r.view,r.view,mK),W.mul(r.projectionView,r.projection,r.view),W.invert(r.inverseProjectionView,r.projectionView),c=-l*i-s,u=l*i-s,n.projection[0]=2*t.near/(u-c),n.projection[8]=(u+c)/(u-c),W.mul(n.view,n.view,pK),W.mul(n.projectionView,n.projection,n.view),W.invert(n.inverseProjectionView,n.projectionView)}var rL=Math.pow(2,24)-2,i_=class{constructor(e,r,n){this.webgl=e,this.drawPass=r,this.pickScale=n;let o=n/e.pixelRatio;this.pickWidth=Math.ceil(r.colorTarget.getWidth()*o),this.pickHeight=Math.ceil(r.colorTarget.getHeight()*o);let{resources:i,extensions:{drawBuffers:a},gl:s}=e;a?(this.objectPickTexture=i.texture("image-uint8","rgba","ubyte","nearest"),this.objectPickTexture.define(this.pickWidth,this.pickHeight),this.instancePickTexture=i.texture("image-uint8","rgba","ubyte","nearest"),this.instancePickTexture.define(this.pickWidth,this.pickHeight),this.groupPickTexture=i.texture("image-uint8","rgba","ubyte","nearest"),this.groupPickTexture.define(this.pickWidth,this.pickHeight),this.depthPickTexture=i.texture("image-uint8","rgba","ubyte","nearest"),this.depthPickTexture.define(this.pickWidth,this.pickHeight),this.framebuffer=i.framebuffer(),this.objectPickFramebuffer=i.framebuffer(),this.instancePickFramebuffer=i.framebuffer(),this.groupPickFramebuffer=i.framebuffer(),this.depthPickFramebuffer=i.framebuffer(),this.framebuffer.bind(),a.drawBuffers([a.COLOR_ATTACHMENT0,a.COLOR_ATTACHMENT1,a.COLOR_ATTACHMENT2,a.COLOR_ATTACHMENT3]),this.objectPickTexture.attachFramebuffer(this.framebuffer,"color0"),this.instancePickTexture.attachFramebuffer(this.framebuffer,"color1"),this.groupPickTexture.attachFramebuffer(this.framebuffer,"color2"),this.depthPickTexture.attachFramebuffer(this.framebuffer,"color3"),this.depthRenderbuffer=ct(s)?i.renderbuffer("depth32f","depth",this.pickWidth,this.pickHeight):i.renderbuffer("depth16","depth",this.pickWidth,this.pickHeight),this.depthRenderbuffer.attachFramebuffer(this.framebuffer),this.objectPickTexture.attachFramebuffer(this.objectPickFramebuffer,"color0"),this.instancePickTexture.attachFramebuffer(this.instancePickFramebuffer,"color0"),this.groupPickTexture.attachFramebuffer(this.groupPickFramebuffer,"color0"),this.depthPickTexture.attachFramebuffer(this.depthPickFramebuffer,"color0")):(this.objectPickTarget=e.createRenderTarget(this.pickWidth,this.pickHeight),this.instancePickTarget=e.createRenderTarget(this.pickWidth,this.pickHeight),this.groupPickTarget=e.createRenderTarget(this.pickWidth,this.pickHeight),this.depthPickTarget=e.createRenderTarget(this.pickWidth,this.pickHeight))}get pickRatio(){return this.pickScale/this.webgl.pixelRatio}setPickScale(e){this.pickScale=e,this.syncSize()}bindObject(){this.webgl.extensions.drawBuffers?this.objectPickFramebuffer.bind():this.objectPickTarget.bind()}bindInstance(){this.webgl.extensions.drawBuffers?this.instancePickFramebuffer.bind():this.instancePickTarget.bind()}bindGroup(){this.webgl.extensions.drawBuffers?this.groupPickFramebuffer.bind():this.groupPickTarget.bind()}bindDepth(){this.webgl.extensions.drawBuffers?this.depthPickFramebuffer.bind():this.depthPickTarget.bind()}get drawingBufferHeight(){return this.drawPass.colorTarget.getHeight()}syncSize(){let e=this.pickScale/this.webgl.pixelRatio,r=Math.ceil(this.drawPass.colorTarget.getWidth()*e),n=Math.ceil(this.drawPass.colorTarget.getHeight()*e);(r!==this.pickWidth||n!==this.pickHeight)&&(this.pickWidth=r,this.pickHeight=n,this.webgl.extensions.drawBuffers?(this.objectPickTexture.define(this.pickWidth,this.pickHeight),this.instancePickTexture.define(this.pickWidth,this.pickHeight),this.groupPickTexture.define(this.pickWidth,this.pickHeight),this.depthPickTexture.define(this.pickWidth,this.pickHeight),this.depthRenderbuffer.setSize(this.pickWidth,this.pickHeight)):(this.objectPickTarget.setSize(this.pickWidth,this.pickHeight),this.instancePickTarget.setSize(this.pickWidth,this.pickHeight),this.groupPickTarget.setSize(this.pickWidth,this.pickHeight),this.depthPickTarget.setSize(this.pickWidth,this.pickHeight)))}renderVariant(e,r,n,o,i,a){e.clear(!1),e.update(r,n),e.renderPick(n.primitives,r,i,null,a),o.handle.isEnabled&&e.renderPick(o.handle.scene,r,i,null,a),o.camera.isEnabled&&(o.camera.update(r),e.update(o.camera.camera,o.camera.scene),e.renderPick(o.camera.scene,o.camera.camera,i,null,a))}render(e,r,n,o){this.webgl.extensions.drawBuffers?(this.framebuffer.bind(),this.renderVariant(e,r,n,o,"pick",ah.None)):(this.objectPickTarget.bind(),this.renderVariant(e,r,n,o,"pick",ah.Object),this.instancePickTarget.bind(),this.renderVariant(e,r,n,o,"pick",ah.Instance),this.groupPickTarget.bind(),this.renderVariant(e,r,n,o,"pick",ah.Group),this.depthPickTarget.bind(),this.renderVariant(e,r,n,o,"depth",ah.None))}},a_=class{setupBuffers(){let e=this.pickWidth*this.pickHeight*4;(!this.objectBuffer||this.objectBuffer.length!==e)&&(this.objectBuffer=new Uint8Array(e),this.instanceBuffer=new Uint8Array(e),this.groupBuffer=new Uint8Array(e),this.depthBuffer=new Uint8Array(e))}setViewport(e,r,n,o){_n.set(this.viewport,e,r,n,o),this.pickRatio=this.pickPass.pickRatio,this.pickX=Math.ceil(e*this.pickRatio),this.pickY=Math.ceil(r*this.pickRatio);let i=Math.floor(n*this.pickRatio),a=Math.floor(o*this.pickRatio);(i!==this.pickWidth||a!==this.pickHeight)&&(this.pickWidth=i,this.pickHeight=a,this.halfPickWidth=Math.floor(this.pickWidth/2),this.setupBuffers()),this.spiral=bz(Math.round(this.pickRatio*this.pickPadding))}syncBuffers(){Ee&&this.webgl.timer.mark("PickHelper.syncBuffers");let{pickX:e,pickY:r,pickWidth:n,pickHeight:o}=this;this.pickPass.bindObject(),this.webgl.readPixels(e,r,n,o,this.objectBuffer),this.pickPass.bindInstance(),this.webgl.readPixels(e,r,n,o,this.instanceBuffer),this.pickPass.bindGroup(),this.webgl.readPixels(e,r,n,o,this.groupBuffer),this.pickPass.bindDepth(),this.webgl.readPixels(e,r,n,o,this.depthBuffer),Ee&&this.webgl.timer.markEnd("PickHelper.syncBuffers")}getBufferIdx(e,r){return(r*this.pickWidth+e)*4}getDepth(e,r){let n=this.getBufferIdx(e,r),o=this.depthBuffer;return Vj(o[n],o[n+1],o[n+2],o[n+3])}getId(e,r,n){let o=this.getBufferIdx(e,r);return Ig(n[o],n[o+1],n[o+2])}render(e){Ee&&this.webgl.timer.mark("PickHelper.render",!0);let{pickX:r,pickY:n,pickWidth:o,pickHeight:i,halfPickWidth:a}=this,{renderer:s,scene:l,helper:c}=this;s.setTransparentBackground(!1),s.setDrawingBufferSize(o,i),s.setPixelRatio(this.pickRatio),Dd.is(e)?(s.setViewport(r,n,a,i),this.pickPass.render(s,e.left,l,c),s.setViewport(r+a,n,o-a,i),this.pickPass.render(s,e.right,l,c)):(s.setViewport(r,n,o,i),this.pickPass.render(s,e,l,c)),this.dirty=!1,Ee&&this.webgl.timer.markEnd("PickHelper.render")}identifyInternal(e,r,n){let{webgl:o,pickRatio:i}=this;if(o.isContextLost)return;e*=o.pixelRatio,r*=o.pixelRatio,r=this.pickPass.drawingBufferHeight-r;let{viewport:a}=this;if(e<a.x||r<a.y||e>a.x+a.width||r>a.y+a.height)return;this.dirty&&(Ee&&this.webgl.timer.mark("PickHelper.identify"),this.render(n),this.syncBuffers(),Ee&&this.webgl.timer.markEnd("PickHelper.identify"));let s=e-a.x,l=r-a.y,c=Math.floor(s*i),u=Math.floor(l*i),d=this.getId(c,u,this.objectBuffer);if(d===-1||d===rL)return;let m=this.getId(c,u,this.instanceBuffer);if(m===-1||m===rL)return;let p=this.getId(c,u,this.groupBuffer);if(p===-1||p===rL)return;let h=this.getDepth(c,u),f=y.create(e,r,h);if(Dd.is(n)){let b=Math.floor(a.width/2);e>a.x+b?(f[0]=a.x+(s-b)*2,kv(f,f,a,n.right.inverseProjectionView)):(f[0]=a.x+s*2,kv(f,f,a,n.left.inverseProjectionView))}else kv(f,f,a,n.inverseProjectionView);return{id:{objectId:d,instanceId:m,groupId:p},position:f}}identify(e,r,n){for(let o of this.spiral){let i=this.identifyInternal(e+o[0],r+o[1],n);if(i)return i}}constructor(e,r,n,o,i,a,s=1){this.webgl=e,this.renderer=r,this.scene=n,this.helper=o,this.pickPass=i,this.pickPadding=s,this.dirty=!0,this.viewport=_n(),this.setViewport(a.x,a.y,a.width,a.height)}};var fK=`
precision highp float;

uniform sampler2D tWboitA;
uniform sampler2D tWboitB;
uniform vec2 uTexSize;

void main() {
    vec2 coords = gl_FragCoord.xy / uTexSize;

    vec4 accum = texture2D(tWboitA, coords);
    float r = 1.0 - accum.a;

    accum.a = texture2D(tWboitB, coords).r;
    // divisor needs to allow very small values for nice fading
    gl_FragColor = vec4(accum.rgb / clamp(accum.a, 0.00000001, 50000.0), r);
}
`;var cTe=U(w({},Er),{tWboitA:We("texture","rgba","float","nearest"),tWboitB:We("texture","rgba","float","nearest"),uTexSize:ee("v2")}),uTe=Qt("evaluate-wboit",zr,fK);function dTe(t,e,r){let n=U(w({},Ir),{tWboitA:C.create(e),tWboitB:C.create(r),uTexSize:C.create(ne.create(e.getWidth(),e.getHeight()))}),o=w({},cTe),i=dr(t,"triangles",uTe,o,n);return mr(i,n)}var s_=class t{get supported(){return this._supported}bind(){let{state:e,gl:r}=this.webgl;this.framebuffer.bind(),e.clearColor(0,0,0,1),r.clear(r.COLOR_BUFFER_BIT),e.disable(r.DEPTH_TEST),e.blendFuncSeparate(r.ONE,r.ONE,r.ZERO,r.ONE_MINUS_SRC_ALPHA),e.enable(r.BLEND)}render(){Ee&&this.webgl.timer.mark("WboitPass.render");let{state:e,gl:r}=this.webgl;e.blendFuncSeparate(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA,r.ONE,r.ONE_MINUS_SRC_ALPHA),e.enable(r.BLEND),this.renderable.update(),this.renderable.render(),Ee&&this.webgl.timer.markEnd("WboitPass.render")}setSize(e,r){let[n,o]=this.renderable.values.uTexSize.ref.value;(e!==n||r!==o)&&(this.textureA.define(e,r),this.textureB.define(e,r),this.depthRenderbuffer.setSize(e,r),C.update(this.renderable.values.uTexSize,ne.set(this.renderable.values.uTexSize.ref.value,e,r)))}reset(){this._supported&&this._init()}_init(){let{extensions:{drawBuffers:e}}=this.webgl;this.framebuffer.bind(),e.drawBuffers([e.COLOR_ATTACHMENT0,e.COLOR_ATTACHMENT1]),this.textureA.attachFramebuffer(this.framebuffer,"color0"),this.textureB.attachFramebuffer(this.framebuffer,"color1"),this.depthRenderbuffer.attachFramebuffer(this.framebuffer)}static isSupported(e){let{extensions:{drawBuffers:r,textureFloat:n,colorBufferFloat:o,depthTexture:i}}=e;if(!n||!o||!i||!r){if(ht){let a=[];n||a.push("textureFloat"),o||a.push("colorBufferFloat"),i||a.push("depthTexture"),r||a.push("drawBuffers"),console.log(`Missing "${a.join('", "')}" extensions required for "wboit"`)}return!1}else return!0}constructor(e,r,n){if(this.webgl=e,this._supported=!1,!t.isSupported(e))return;let{resources:o,gl:i}=e;this.textureA=o.texture("image-float32","rgba","float","nearest"),this.textureA.define(r,n),this.textureB=o.texture("image-float32","rgba","float","nearest"),this.textureB.define(r,n),this.depthRenderbuffer=ct(i)?o.renderbuffer("depth32f","depth",r,n):o.renderbuffer("depth16","depth",r,n),this.renderable=dTe(e,this.textureA,this.textureB),this.framebuffer=o.framebuffer(),this._supported=!0,this._init()}};var hK=`
precision highp float;

uniform sampler2D tDpoitFrontColor;
uniform vec2 uTexSize;

void main() {
    vec2 coords = gl_FragCoord.xy / uTexSize;
    gl_FragColor = texture2D(tDpoitFrontColor, coords);
}
`;var gK=`
    precision highp float;

    uniform sampler2D tDpoitBackColor;
    uniform vec2 uTexSize;

    void main() {
        vec2 coords = gl_FragCoord.xy / uTexSize;
        gl_FragColor = texture2D(tDpoitBackColor, coords);
        if (gl_FragColor.a == 0.0) {
            discard;
        }
    }
`;var mTe=U(w({},Er),{tDpoitBackColor:We("texture","rgba","float","nearest"),uTexSize:ee("v2")}),pTe=Qt("blend-back-dpoit",zr,gK);function fTe(t,e){let r=U(w({},Ir),{tDpoitBackColor:C.create(e),uTexSize:C.create(ne.create(e.getWidth(),e.getHeight()))}),n=w({},mTe),o=dr(t,"triangles",pTe,n,r);return mr(o,r)}var hTe=U(w({},Er),{tDpoitFrontColor:We("texture","rgba","float","nearest"),uTexSize:ee("v2")}),gTe=Qt("evaluate-dpoit",zr,hK);function yTe(t,e){let r=U(w({},Ir),{tDpoitFrontColor:C.create(e),uTexSize:C.create(ne.create(e.getWidth(),e.getHeight()))}),n=w({},hTe),o=dr(t,"triangles",gTe,n,r);return mr(o,r)}var l_=class t{get supported(){return this._supported}bind(){let{state:e,gl:r,extensions:{blendMinMax:n}}=this.webgl;return this.passCount=0,this.depthFramebuffers[0].bind(),e.clearColor(this.DEPTH_CLEAR_VALUE,this.DEPTH_CLEAR_VALUE,0,0),r.clear(r.COLOR_BUFFER_BIT),this.depthFramebuffers[1].bind(),e.clearColor(-this.MIN_DEPTH,this.MAX_DEPTH,0,0),r.clear(r.COLOR_BUFFER_BIT),this.colorFramebuffers[0].bind(),e.clearColor(0,0,0,0),r.clear(r.COLOR_BUFFER_BIT),this.colorFramebuffers[1].bind(),e.clearColor(0,0,0,0),r.clear(r.COLOR_BUFFER_BIT),this.depthFramebuffers[0].bind(),e.blendEquation(n.MAX),e.depthMask(!1),{depth:this.depthTextures[1],frontColor:this.colorFrontTextures[1],backColor:this.colorBackTextures[1]}}bindDualDepthPeeling(){let{state:e,gl:r,extensions:{blendMinMax:n}}=this.webgl;return this.readId=this.passCount%2,this.writeId=1-this.readId,this.passCount+=1,this.depthFramebuffers[this.writeId].bind(),e.clearColor(this.DEPTH_CLEAR_VALUE,this.DEPTH_CLEAR_VALUE,0,0),r.clear(r.COLOR_BUFFER_BIT),this.colorFramebuffers[this.writeId].bind(),e.clearColor(0,0,0,0),r.clear(r.COLOR_BUFFER_BIT),this.depthFramebuffers[this.writeId].bind(),e.blendEquation(n.MAX),e.depthMask(!1),{depth:this.depthTextures[this.readId],frontColor:this.colorFrontTextures[this.readId],backColor:this.colorBackTextures[this.readId]}}renderBlendBack(){Ee&&this.webgl.timer.mark("DpoitPass.renderBlendBack");let{state:e,gl:r}=this.webgl;e.blendEquation(r.FUNC_ADD),e.blendFuncSeparate(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA,r.ONE,r.ONE_MINUS_SRC_ALPHA),C.update(this.blendBackRenderable.values.tDpoitBackColor,this.colorBackTextures[this.writeId]),this.blendBackRenderable.update(),this.blendBackRenderable.render(),Ee&&this.webgl.timer.markEnd("DpoitPass.renderBlendBack")}render(){Ee&&this.webgl.timer.mark("DpoitPass.render");let{state:e,gl:r}=this.webgl;e.blendFunc(r.ONE,r.ONE_MINUS_SRC_ALPHA),C.update(this.renderable.values.tDpoitFrontColor,this.colorFrontTextures[this.writeId]),this.renderable.update(),this.renderable.render(),Ee&&this.webgl.timer.markEnd("DpoitPass.render")}setSize(e,r){let[n,o]=this.renderable.values.uTexSize.ref.value;if(e!==n||r!==o){for(let i=0;i<2;i++)this.depthTextures[i].define(e,r),this.colorFrontTextures[i].define(e,r),this.colorBackTextures[i].define(e,r);C.update(this.renderable.values.uTexSize,ne.set(this.renderable.values.uTexSize.ref.value,e,r)),C.update(this.blendBackRenderable.values.uTexSize,ne.set(this.blendBackRenderable.values.uTexSize.ref.value,e,r))}}reset(){this._supported&&this._init()}_init(){let{extensions:{drawBuffers:e}}=this.webgl;for(let r=0;r<2;r++)this.depthFramebuffers[r].bind(),e.drawBuffers([e.COLOR_ATTACHMENT0,e.COLOR_ATTACHMENT1,e.COLOR_ATTACHMENT2]),this.colorFrontTextures[r].attachFramebuffer(this.depthFramebuffers[r],"color0"),this.colorBackTextures[r].attachFramebuffer(this.depthFramebuffers[r],"color1"),this.depthTextures[r].attachFramebuffer(this.depthFramebuffers[r],"color2"),this.colorFramebuffers[r].bind(),e.drawBuffers([e.COLOR_ATTACHMENT0,e.COLOR_ATTACHMENT1]),this.colorFrontTextures[r].attachFramebuffer(this.colorFramebuffers[r],"color0"),this.colorBackTextures[r].attachFramebuffer(this.colorFramebuffers[r],"color1")}static isSupported(e){let{extensions:{drawBuffers:r,textureFloat:n,colorBufferFloat:o,depthTexture:i,blendMinMax:a}}=e;if(!n||!o||!i||!r||!a){if(ht){let s=[];n||s.push("textureFloat"),o||s.push("colorBufferFloat"),i||s.push("depthTexture"),r||s.push("drawBuffers"),a||s.push("blendMinMax"),console.log(`Missing "${s.join('", "')}" extensions required for "dpoit"`)}return!1}else return!0}constructor(e,r,n){if(this.webgl=e,this.DEPTH_CLEAR_VALUE=-99999,this.MAX_DEPTH=1,this.MIN_DEPTH=0,this.passCount=0,this._supported=!1,!t.isSupported(e))return;let{resources:o,extensions:{colorBufferHalfFloat:i,textureHalfFloat:a}}=e;ct(e.gl)?(this.depthTextures=[o.texture("image-float32","rg","float","nearest"),o.texture("image-float32","rg","float","nearest")],this.colorFrontTextures=i&&a?[o.texture("image-float16","rgba","fp16","nearest"),o.texture("image-float16","rgba","fp16","nearest")]:[o.texture("image-float32","rgba","float","nearest"),o.texture("image-float32","rgba","float","nearest")],this.colorBackTextures=i&&a?[o.texture("image-float16","rgba","fp16","nearest"),o.texture("image-float16","rgba","fp16","nearest")]:[o.texture("image-float32","rgba","float","nearest"),o.texture("image-float32","rgba","float","nearest")]):(this.depthTextures=[o.texture("image-float32","rgba","float","nearest"),o.texture("image-float32","rgba","float","nearest")],this.colorFrontTextures=[o.texture("image-float32","rgba","float","nearest"),o.texture("image-float32","rgba","float","nearest")],this.colorBackTextures=[o.texture("image-float32","rgba","float","nearest"),o.texture("image-float32","rgba","float","nearest")]),this.depthTextures[0].define(r,n),this.depthTextures[1].define(r,n),this.colorFrontTextures[0].define(r,n),this.colorFrontTextures[1].define(r,n),this.colorBackTextures[0].define(r,n),this.colorBackTextures[1].define(r,n),this.depthFramebuffers=[o.framebuffer(),o.framebuffer()],this.colorFramebuffers=[o.framebuffer(),o.framebuffer()],this.blendBackRenderable=fTe(e,this.colorBackTextures[0]),this.renderable=yTe(e,this.colorFrontTextures[0]),this._supported=!0,this._init()}};var yK=`
precision highp float;
precision highp sampler2D;

uniform vec2 uTexSizeInv;
uniform sampler2D tEdgeTexture;
uniform vec3 uHighlightEdgeColor;
uniform vec3 uSelectEdgeColor;
uniform float uHighlightEdgeStrength;
uniform float uSelectEdgeStrength;
uniform float uGhostEdgeStrength;
uniform float uInnerEdgeFactor;

void main() {
    vec2 coords = gl_FragCoord.xy * uTexSizeInv;
    vec4 edgeValue = texture2D(tEdgeTexture, coords);
    if (edgeValue.a > 0.0) {
        vec3 edgeColor = edgeValue.b == 1.0 ? uHighlightEdgeColor : uSelectEdgeColor;
        gl_FragColor.rgb = edgeValue.g > 0.0 ? edgeColor : edgeColor * uInnerEdgeFactor;
        gl_FragColor.a = (edgeValue.r == 1.0 ? uGhostEdgeStrength : 1.0) * edgeValue.a;
        float edgeStrength = edgeValue.b == 1.0 ? uHighlightEdgeStrength : uSelectEdgeStrength;
        gl_FragColor.a *= edgeStrength;
    } else {
        gl_FragColor = vec4(0.0);
    }
}
`;var vK=`
precision highp float;
precision highp sampler2D;

uniform sampler2D tMaskTexture;
uniform vec2 uTexSizeInv;

void main() {
    vec2 coords = gl_FragCoord.xy * uTexSizeInv;
    vec4 offset = vec4(float(dEdgeScale), 0.0, 0.0, float(dEdgeScale)) * vec4(uTexSizeInv, uTexSizeInv);
    vec4 c0 = texture2D(tMaskTexture, coords);
    vec4 c1 = texture2D(tMaskTexture, coords + offset.xy);
    vec4 c2 = texture2D(tMaskTexture, coords - offset.xy);
    vec4 c3 = texture2D(tMaskTexture, coords + offset.yw);
    vec4 c4 = texture2D(tMaskTexture, coords - offset.yw);
    float diff1 = (c1.r - c2.r) * 0.5;
    float diff2 = (c3.r - c4.r) * 0.5;
    float d = length(vec2(diff1, diff2));
    if (d <= 0.0)
        discard;
    float a1 = min(c1.g, c2.g);
    float a2 = min(c3.g, c4.g);
    float visibility = min(a1, a2) > 0.001 ? 1.0 : 0.0;
    float mask = c0.r;
    float marker = min(c1.b, min(c2.b, min(c3.b, c4.b)));
    float fogAlpha = min(c1.a, min(c2.a, min(c3.a, c4.a)));
    gl_FragColor = vec4(visibility, mask, marker, fogAlpha);
}
`;var c_={enabled:g.Boolean(!0),highlightEdgeColor:g.Color(ce.darken(ce.fromNormalizedRgb(1,.4,.6),1)),selectEdgeColor:g.Color(ce.darken(ce.fromNormalizedRgb(.2,1,.1),1)),edgeScale:g.Numeric(1,{min:1,max:3,step:1},{description:"Thickness of the edge."}),highlightEdgeStrength:g.Numeric(1,{min:0,max:1,step:.1}),selectEdgeStrength:g.Numeric(1,{min:0,max:1,step:.1}),ghostEdgeStrength:g.Numeric(.3,{min:0,max:1,step:.1},{description:"Opacity of the hidden edges that are covered by other geometry. When set to 1, one less geometry render pass is done."}),innerEdgeFactor:g.Numeric(1.5,{min:0,max:3,step:.1},{description:"Factor to multiply the inner edge color with - for added contrast."})},tS=class{static isEnabled(e){return e.enabled}constructor(e,r,n){this.webgl=e,this.depthTarget=e.createRenderTarget(r,n),this.maskTarget=e.createRenderTarget(r,n),this.edgesTarget=e.createRenderTarget(r,n),this.edge=xTe(e,this.maskTarget.texture),this.overlay=TTe(e,this.edgesTarget.texture)}setEdgeState(e){let{gl:r,state:n}=this.webgl;n.enable(r.SCISSOR_TEST),n.enable(r.BLEND),n.blendFunc(r.ONE,r.ONE),n.blendEquation(r.FUNC_ADD),n.disable(r.DEPTH_TEST),n.depthMask(!1);let{x:o,y:i,width:a,height:s}=e;n.viewport(o,i,a,s),n.scissor(o,i,a,s),n.clearColor(0,0,0,0),r.clear(r.COLOR_BUFFER_BIT)}setOverlayState(e){let{gl:r,state:n}=this.webgl;n.enable(r.SCISSOR_TEST),n.enable(r.BLEND),n.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA),n.blendEquation(r.FUNC_ADD),n.disable(r.DEPTH_TEST),n.depthMask(!1);let{x:o,y:i,width:a,height:s}=e;n.viewport(o,i,a,s),n.scissor(o,i,a,s)}setSize(e,r){let n=this.depthTarget.getWidth(),o=this.depthTarget.getHeight();(e!==n||r!==o)&&(this.depthTarget.setSize(e,r),this.maskTarget.setSize(e,r),this.edgesTarget.setSize(e,r),C.update(this.edge.values.uTexSizeInv,ne.set(this.edge.values.uTexSizeInv.ref.value,1/e,1/r)),C.update(this.overlay.values.uTexSizeInv,ne.set(this.overlay.values.uTexSizeInv.ref.value,1/e,1/r)))}update(e){let{highlightEdgeColor:r,selectEdgeColor:n,edgeScale:o,innerEdgeFactor:i,ghostEdgeStrength:a,highlightEdgeStrength:s,selectEdgeStrength:l}=e,{values:c}=this.edge,u=Math.max(1,Math.round(o*this.webgl.pixelRatio));c.dEdgeScale.ref.value!==u&&(C.update(c.dEdgeScale,u),this.edge.update());let{values:d}=this.overlay;C.update(d.uHighlightEdgeColor,ce.toVec3Normalized(d.uHighlightEdgeColor.ref.value,r)),C.update(d.uSelectEdgeColor,ce.toVec3Normalized(d.uSelectEdgeColor.ref.value,n)),C.updateIfChanged(d.uInnerEdgeFactor,i),C.updateIfChanged(d.uGhostEdgeStrength,a),C.updateIfChanged(d.uHighlightEdgeStrength,s),C.updateIfChanged(d.uSelectEdgeStrength,l)}render(e,r){Ee&&this.webgl.timer.mark("MarkingPass.render"),this.edgesTarget.bind(),this.setEdgeState(e),this.edge.render(),r?r.bind():this.webgl.unbindFramebuffer(),this.setOverlayState(e),this.overlay.render(),Ee&&this.webgl.timer.markEnd("MarkingPass.render")}},vTe=U(w({},Er),{tMaskTexture:We("texture","rgba","ubyte","linear"),uTexSizeInv:ee("v2"),dEdgeScale:Ye("number")}),bTe=Qt("edge",zr,vK);function xTe(t,e){let r=e.getWidth(),n=e.getHeight(),o=U(w({},Ir),{tMaskTexture:C.create(e),uTexSizeInv:C.create(ne.create(1/r,1/n)),dEdgeScale:C.create(1)}),i=w({},vTe),a=dr(t,"triangles",bTe,i,o);return mr(a,o)}var STe=U(w({},Er),{tEdgeTexture:We("texture","rgba","ubyte","linear"),uTexSizeInv:ee("v2"),uHighlightEdgeColor:ee("v3"),uSelectEdgeColor:ee("v3"),uHighlightEdgeStrength:ee("f"),uSelectEdgeStrength:ee("f"),uGhostEdgeStrength:ee("f"),uInnerEdgeFactor:ee("f")}),CTe=Qt("overlay",zr,yK);function TTe(t,e){let r=e.getWidth(),n=e.getHeight(),o=U(w({},Ir),{tEdgeTexture:C.create(e),uTexSizeInv:C.create(ne.create(1/r,1/n)),uHighlightEdgeColor:C.create(y()),uSelectEdgeColor:C.create(y()),uHighlightEdgeStrength:C.create(1),uSelectEdgeStrength:C.create(1),uGhostEdgeStrength:C.create(0),uInnerEdgeFactor:C.create(0)}),i=w({},STe),a=dr(t,"triangles",CTe,i,o);return mr(a,o)}var Bv=class{setTransparency(e){e==="wboit"?(this.transparencyMode=this.wboit.supported?"wboit":"blended",ht&&!this.wboit.supported&&console.log('Missing "wboit" support, falling back to "blended".')):e==="dpoit"?(this.transparencyMode=this.dpoit.supported?"dpoit":"blended",ht&&!this.dpoit.supported&&console.log('Missing "dpoit" support, falling back to "blended".')):this.transparencyMode="blended",this.depthTextureOpaque.detachFramebuffer(this.postprocessing.target.framebuffer,"depth")}get transparency(){return this.transparencyMode}constructor(e,r,n,o,i){this.webgl=e,this.transparencyMode="blended";let{extensions:a,resources:s,isWebGL2:l}=e;this.drawTarget=XG(e.gl),this.colorTarget=e.createRenderTarget(n,o,!0,"uint8","linear"),this.packedDepth=!a.depthTexture,this.depthTargetTransparent=e.createRenderTarget(n,o),this.depthTextureTransparent=this.depthTargetTransparent.texture,this.depthTargetOpaque=this.packedDepth?e.createRenderTarget(n,o):null,this.depthTextureOpaque=this.depthTargetOpaque?this.depthTargetOpaque.texture:s.texture("image-depth","depth",l?"float":"ushort","nearest"),this.packedDepth||this.depthTextureOpaque.define(n,o),this.wboit=new s_(e,n,o),this.dpoit=new l_(e,n,o),this.marking=new tS(e,n,o),this.postprocessing=new ls(e,r,this),this.antialiasing=new uh(e,n,o),this.bloom=new t_(e,n,o),this.dof=new Sm(e,n,o),this.copyFboTarget=dp(e,this.colorTarget.texture),this.copyFboPostprocessing=dp(e,this.postprocessing.target.texture),this.setTransparency(i)}reset(){this.wboit.reset(),this.dpoit.reset()}setSize(e,r){let n=this.colorTarget.getWidth(),o=this.colorTarget.getHeight();(e!==n||r!==o)&&(this.colorTarget.setSize(e,r),this.depthTargetTransparent.setSize(e,r),this.depthTargetOpaque?this.depthTargetOpaque.setSize(e,r):this.depthTextureOpaque.define(e,r),C.update(this.copyFboTarget.values.uTexSize,ne.set(this.copyFboTarget.values.uTexSize.ref.value,e,r)),C.update(this.copyFboPostprocessing.values.uTexSize,ne.set(this.copyFboPostprocessing.values.uTexSize.ref.value,e,r))),this.wboit.supported&&this.wboit.setSize(e,r),this.dpoit.supported&&this.dpoit.setSize(e,r),this.marking.setSize(e,r),this.postprocessing.setSize(e,r),this.antialiasing.setSize(e,r),this.dof.setSize(e,r),this.bloom.setSize(e,r)}_renderDpoit(e,r,n,o,i,a){if(!this.dpoit.supported)throw new Error("expected dpoit to be supported");if(this.depthTextureOpaque.attachFramebuffer(this.colorTarget.framebuffer,"depth"),e.clear(!0),n.hasOpaque&&e.renderDpoitOpaque(n.primitives,r,null),ls.isEnabled(a)&&((ls.isTransparentOutlineEnabled(a)||Sm.isEnabled(a))&&(this.depthTargetTransparent.bind(),e.clearDepth(!0),n.opacityAverage<1&&e.renderDepthTransparent(n.primitives,r,this.depthTextureOpaque)),this.postprocessing.render(r,!1,i,e.props.backgroundColor,a,e.light)),this.depthTextureOpaque.detachFramebuffer(this.colorTarget.framebuffer,"depth"),n.opacityAverage<1){let s=ls.isEnabled(a)?this.postprocessing.target:this.colorTarget,l=this.dpoit.bind();e.renderDpoitTransparent(n.primitives,r,this.depthTextureOpaque,l);for(let c=0;c<o;c++){Ee&&this.webgl.timer.mark("DpoitPass.layer");let u=this.dpoit.bindDualDepthPeeling();e.renderDpoitTransparent(n.primitives,r,this.depthTextureOpaque,u),s.bind(),this.dpoit.renderBlendBack(),Ee&&this.webgl.timer.markEnd("DpoitPass.layer")}s.bind(),this.dpoit.render()}n.volumes.renderables.length>0&&e.renderDpoitVolume(n.volumes,r,this.depthTextureOpaque)}_renderWboit(e,r,n,o,i){if(!this.wboit.supported)throw new Error("expected wboit to be supported");this.depthTextureOpaque.attachFramebuffer(this.colorTarget.framebuffer,"depth"),e.clear(!0),n.hasOpaque&&e.renderWboitOpaque(n.primitives,r,null),ls.isEnabled(i)&&((ls.isTransparentOutlineEnabled(i)||Sm.isEnabled(i))&&(this.depthTargetTransparent.bind(),e.clearDepth(!0),n.opacityAverage<1&&e.renderDepthTransparent(n.primitives,r,this.depthTextureOpaque)),this.postprocessing.render(r,!1,o,e.props.backgroundColor,i,e.light)),(n.opacityAverage<1||n.volumes.renderables.length>0)&&(this.wboit.bind(),n.opacityAverage<1&&e.renderWboitTransparent(n.primitives,r,this.depthTextureOpaque),n.volumes.renderables.length>0&&e.renderWboitTransparent(n.volumes,r,this.depthTextureOpaque),ls.isEnabled(i)?this.postprocessing.target.bind():this.colorTarget.bind(),this.wboit.render())}_renderBlended(e,r,n,o,i,a){var s,l,c,u;if(o?this.drawTarget.bind():this.packedDepth?this.colorTarget.bind():this.depthTextureOpaque.attachFramebuffer(this.colorTarget.framebuffer,"depth"),e.clear(!0),n.hasOpaque&&e.renderBlendedOpaque(n.primitives,r,null),!o&&(this.depthTargetOpaque&&(this.depthTargetOpaque.bind(),e.clearDepth(!0),e.renderDepthOpaque(n.primitives,r,null),this.colorTarget.bind()),ls.isEnabled(a)&&(this.packedDepth?(s=this.colorTarget.depthRenderbuffer)===null||s===void 0||s.detachFramebuffer(this.postprocessing.target.framebuffer):this.depthTextureOpaque.detachFramebuffer(this.postprocessing.target.framebuffer,"depth"),(ls.isTransparentOutlineEnabled(a)||Sm.isEnabled(a))&&(this.depthTargetTransparent.bind(),e.clearDepth(!0),n.opacityAverage<1&&e.renderDepthTransparent(n.primitives,r,this.depthTextureOpaque)),this.postprocessing.render(r,!1,i,e.props.backgroundColor,a,e.light),this.packedDepth?(l=this.colorTarget.depthRenderbuffer)===null||l===void 0||l.attachFramebuffer(this.postprocessing.target.framebuffer):this.depthTextureOpaque.attachFramebuffer(this.postprocessing.target.framebuffer,"depth")),n.volumes.renderables.length>0)){let d=ls.isEnabled(a)?this.postprocessing.target:this.colorTarget;this.packedDepth?(c=this.colorTarget.depthRenderbuffer)===null||c===void 0||c.detachFramebuffer(d.framebuffer):this.depthTextureOpaque.detachFramebuffer(d.framebuffer,"depth"),d.bind(),e.renderBlendedVolume(n.volumes,r,this.depthTextureOpaque),this.packedDepth?(u=this.colorTarget.depthRenderbuffer)===null||u===void 0||u.attachFramebuffer(d.framebuffer):this.depthTextureOpaque.attachFramebuffer(d.framebuffer,"depth"),d.bind()}n.opacityAverage<1&&e.renderBlendedTransparent(n.primitives,r,null)}_render(e,r,n,o,i,a,s){var l,c;let u=n.volumes.renderables.length>0,d=ls.isEnabled(s.postprocessing),m=uh.isEnabled(s.postprocessing),p=tS.isEnabled(s.marking),h=Sm.isEnabled(s.postprocessing),{x:f,y:b,width:v,height:x}=r.viewport;e.setViewport(f,b,v,x),e.update(r,n),a&&!m&&i&&(this.drawTarget.bind(),e.clear(!1));let S=!1;this.transparencyMode==="wboit"&&this.wboit.supported?(this._renderWboit(e,r,n,a,s.postprocessing),S=!0):this.transparencyMode==="dpoit"&&this.dpoit.supported?(this._renderDpoit(e,r,n,s.dpoitIterations,a,s.postprocessing),S=!0):this._renderBlended(e,r,n,!u&&!d&&!m&&i,a,s.postprocessing);let T=d?this.postprocessing.target:!i||u||S?this.colorTarget:this.drawTarget;if(p&&n.markerAverage>0){let _=s.marking.ghostEdgeStrength<1;_&&n.markerAverage!==1&&(this.marking.depthTarget.bind(),e.clear(!1,!0),e.renderMarkingDepth(n.primitives,r,null)),this.marking.maskTarget.bind(),e.clear(!1,!0),e.renderMarkingMask(n.primitives,r,_?this.marking.depthTarget.texture:null),this.marking.update(s.marking),this.marking.render(r.viewport,T)}else T.bind();o.debug.isEnabled&&(o.debug.syncVisibility(),e.renderBlended(o.debug.scene,r)),o.handle.isEnabled&&e.renderBlended(o.handle.scene,r),o.camera.isEnabled&&(o.camera.update(r),e.update(o.camera.camera,o.camera.scene),e.renderBlended(o.camera.scene,o.camera.camera));let E=!1;if(m){let _=ls.isEnabled(s.postprocessing)?this.postprocessing.target.texture:this.colorTarget.texture;this.antialiasing.render(r,_,i&&!h,s.postprocessing)}else i&&!Sm.isEnabled(s.postprocessing)&&(E=!0);if(s.postprocessing.dof.name==="on"){let _=uh.isEnabled(s.postprocessing)?this.antialiasing.target.texture:ls.isEnabled(s.postprocessing)?this.postprocessing.target.texture:this.colorTarget.texture;this.dof.update(r,_,((l=this.depthTargetOpaque)===null||l===void 0?void 0:l.texture)||this.depthTextureOpaque,this.depthTextureTransparent,s.postprocessing.dof.params,n.boundingSphereVisible),this.dof.render(r.viewport,i?void 0:this.getColorTarget(s.postprocessing))}else i&&!uh.isEnabled(s.postprocessing)&&(E=!0);if(E&&(this.drawTarget.bind(),this.webgl.state.disable(this.webgl.gl.DEPTH_TEST),d?this.copyFboPostprocessing.render():(u||S)&&this.copyFboTarget.render()),s.postprocessing.bloom.name==="on"){let _=s.postprocessing.bloom.params.mode==="emissive";_&&n.emissiveAverage>0&&(this.bloom.emissiveTarget.bind(),e.clear(!1,!0),e.update(r,n),e.renderEmissive(n.primitives,r,null)),(!_||n.emissiveAverage>0)&&(this.bloom.update(this.colorTarget.texture,this.bloom.emissiveTarget.texture,((c=this.depthTargetOpaque)===null||c===void 0?void 0:c.texture)||this.depthTextureOpaque,s.postprocessing.bloom.params),this.bloom.render(r.viewport,i?void 0:this.getColorTarget(s.postprocessing)))}this.webgl.gl.flush()}render(e,r,n){Ee&&this.webgl.timer.mark("DrawPass.render");let{renderer:o,camera:i,scene:a,helper:s}=e;this.postprocessing.setTransparentBackground(r.transparentBackground);let l=r.transparentBackground||this.postprocessing.background.isEnabled(r.postprocessing.background);o.setTransparentBackground(l),o.setDrawingBufferSize(this.colorTarget.getWidth(),this.colorTarget.getHeight()),o.setPixelRatio(this.webgl.pixelRatio),Dd.is(i)?(Ee&&this.webgl.timer.mark("StereoCamera.left"),this._render(o,i.left,a,s,n,l,r),Ee&&this.webgl.timer.markEnd("StereoCamera.left"),Ee&&this.webgl.timer.mark("StereoCamera.right"),this._render(o,i.right,a,s,n,l,r),Ee&&this.webgl.timer.markEnd("StereoCamera.right")):this._render(o,i,a,s,n,l,r),Ee&&this.webgl.timer.markEnd("DrawPass.render")}getColorTarget(e){return Sm.isEnabled(e)?this.dof.target:uh.isEnabled(e)?this.antialiasing.target:ls.isEnabled(e)?this.postprocessing.target:this.colorTarget}};var wTe={alpha:g.Numeric(.51,{min:0,max:1,step:.01},{isEssential:!0,label:"Opacity"}),colorX:g.Color(ut.red,{isEssential:!0}),colorY:g.Color(ut.green,{isEssential:!0}),colorZ:g.Color(ut.blue,{isEssential:!0}),scale:g.Numeric(.33,{min:.1,max:2,step:.1},{isEssential:!0}),location:g.Select("bottom-left",g.arrayToOptions(["bottom-left","bottom-right","top-left","top-right"])),locationOffsetX:g.Numeric(0),locationOffsetY:g.Numeric(0),originColor:g.Color(ut.grey),radiusScale:g.Numeric(.075,{min:.01,max:.3,step:.001}),showPlanes:g.Boolean(!0),planeColorXY:g.Color(ut.grey,{label:"Plane Color XY"}),planeColorXZ:g.Color(ut.grey,{label:"Plane Color XZ"}),planeColorYZ:g.Color(ut.grey,{label:"Plane Color YZ"}),showLabels:g.Boolean(!1),labelX:g.Text("X"),labelY:g.Text("Y"),labelZ:g.Text("Z"),labelColorX:g.Color(ut.grey),labelColorY:g.Color(ut.grey),labelColorZ:g.Color(ut.grey),labelOpacity:g.Numeric(1,{min:0,max:1,step:.01}),labelScale:g.Numeric(.25,{min:.1,max:1,step:.01})},dh={axes:g.MappedStatic("on",{on:g.Group(wTe),off:g.Group({})},{cycle:!0,description:"Show camera orientation axes"})},Ov=class{constructor(e,r={}){this.webgl=e,this.props={axes:{name:"off",params:{}}},this.pixelRatio=1,this.eachGroup=(n,o)=>{if(!u_(n))return!1;let i=!1;if(this.meshRenderObject){let a=this.meshRenderObject.values.uGroupCount.ref.value;for(let{groupId:s,instanceId:l}of n.elements){let c=l*a+s;o(Oe.ofSingleton(c))&&(i=!0)}}if(this.textRenderObject){let a=this.textRenderObject.values.uGroupCount.ref.value;for(let{groupId:s,instanceId:l}of n.elements){let c=l*a+s;o(Oe.ofSingleton(c))&&(i=!0)}}return i},this.scene=xm.create(e,"blended"),this.camera=new an,y.set(this.camera.up,0,1,0),y.set(this.camera.target,0,0,0),this.setProps(r)}setProps(e){this.props=ss(this.props,r=>{if(e.axes!==void 0&&(r.axes.name=e.axes.name,e.axes.name==="on")){this.scene.clear(),this.pixelRatio=this.webgl.pixelRatio;let n=U(w({},e.axes.params),{scale:e.axes.params.scale*this.pixelRatio,labelScale:e.axes.params.labelScale*this.pixelRatio});this.meshRenderObject=ATe(n),this.scene.add(this.meshRenderObject),e.axes.params.showLabels?(this.textRenderObject=RTe(n),this.scene.add(this.textRenderObject)):this.textRenderObject=void 0,this.scene.commit(),y.set(this.camera.position,0,0,n.scale*200),W.lookAt(this.camera.view,this.camera.position,this.camera.target,this.camera.up),r.axes.params=w({},e.axes.params)}})}get isEnabled(){return this.props.axes.name==="on"}getLoci(e){let{objectId:r,groupId:n,instanceId:o}=e;return(!this.meshRenderObject||r!==this.meshRenderObject.id)&&(!this.textRenderObject||r!==this.textRenderObject.id)||n===Yr.None?St:PTe(this,n,o)}mark(e,r){return!kn.is(kn.Highlighting,r)||!So(e)&&(!u_(e)||e.data!==this)?!1:Vt.mark(this.meshRenderObject,e,r,this.eachGroup)||Vt.mark(this.textRenderObject,e,r,this.eachGroup)}update(e){if(!this.meshRenderObject||this.props.axes.name==="off")return;this.pixelRatio!==this.webgl.pixelRatio&&this.setProps(this.props),ETe(this.camera,e.viewport,e.viewOffset),W.extractRotation(this.scene.view,e.view);let r=this.textRenderObject?this.textRenderObject.values.boundingSphere.ref.value.radius:this.meshRenderObject.values.boundingSphere.ref.value.radius,n=this.props.axes.params.location,o=this.props.axes.params.locationOffsetX*this.pixelRatio,i=this.props.axes.params.locationOffsetY*this.pixelRatio;n==="bottom-left"?W.setTranslation(this.scene.view,y.create(-e.viewport.width/2+r+o,-e.viewport.height/2+r+i,0)):n==="bottom-right"?W.setTranslation(this.scene.view,y.create(e.viewport.width/2-r-o,-e.viewport.height/2+r+i,0)):n==="top-left"?W.setTranslation(this.scene.view,y.create(-e.viewport.width/2+r+o,e.viewport.height/2-r-i,0)):n==="top-right"?W.setTranslation(this.scene.view,y.create(e.viewport.width/2-r-o,e.viewport.height/2-r-i,0)):ur(n)}},Yr=function(t){return t[t.None=0]="None",t[t.X=1]="X",t[t.Y=2]="Y",t[t.Z=3]="Z",t[t.XY=4]="XY",t[t.XZ=5]="XZ",t[t.YZ=6]="YZ",t[t.Origin=7]="Origin",t}(Yr||{});function _Te(t,e){let r=e.props.axes,n=r.name==="on"?r.params.labelX:"X",o=r.name==="on"?r.params.labelY:"Y",i=r.name==="on"?r.params.labelZ:"Z";switch(t){case Yr.X:return`${n} Axis`;case Yr.Y:return`${o} Axis`;case Yr.Z:return`${i} Axis`;case Yr.XY:return`${n}${o} Plane`;case Yr.XZ:return`${n}${i} Plane`;case Yr.YZ:return`${o}${i} Plane`;case Yr.Origin:return"Origin";default:return"Axes"}}function PTe(t,e,r){return Sf("camera-axes",t,[{groupId:e,instanceId:r}],void 0,()=>_Te(e,t))}function u_(t){return t.kind==="data-loci"&&t.tag==="camera-axes"}function ETe(t,e,r){let{near:n,far:o}=t,i=-e.width/2,a=e.width/2,s=e.height/2,l=-e.height/2,c=(a-i)/2,u=(s-l)/2,d=(a+i)/2,m=(s+l)/2,p=d-c,h=d+c,f=m+u,b=m-u;if(r.enabled){let v=(a-i)/r.width,x=(s-l)/r.height;p+=v*r.offsetX,h=p+v*r.width,f-=x*r.offsetY,b=f-x*r.height}W.ortho(t.projection,p,h,f,b,n,o)}function ITe(t,e){let r=Te.createState(512,256,e),n=100*t.scale,o=t.radiusScale*n,i=t.showLabels?100*t.labelScale/3:0,a=y.scale(y(),y.unitX,n-i),s=y.scale(y(),y.unitY,n-i),l=y.scale(y(),y.unitZ,n-i),c={radiusTop:o,radiusBottom:o,radialSegments:32};if(r.currentGroup=Yr.Origin,Jt(r,y.origin,o,2),r.currentGroup=Yr.X,Jt(r,a,o,2),nr(r,y.origin,a,1,c),r.currentGroup=Yr.Y,Jt(r,s,o,2),nr(r,y.origin,s,1,c),r.currentGroup=Yr.Z,Jt(r,l,o,2),nr(r,y.origin,l,1,c),t.showPlanes){y.scale(a,a,.5),y.scale(s,s,.5),y.scale(l,l,.5),r.currentGroup=Yr.XY,Te.addTriangle(r,y.origin,a,s),Te.addTriangle(r,y.origin,s,a);let u=y.add(y(),a,s);Te.addTriangle(r,u,a,s),Te.addTriangle(r,u,s,a),r.currentGroup=Yr.XZ,Te.addTriangle(r,y.origin,a,l),Te.addTriangle(r,y.origin,l,a);let d=y.add(y(),a,l);Te.addTriangle(r,d,a,l),Te.addTriangle(r,d,l,a),r.currentGroup=Yr.YZ,Te.addTriangle(r,y.origin,s,l),Te.addTriangle(r,y.origin,l,s);let m=y.add(y(),s,l);Te.addTriangle(r,m,s,l),Te.addTriangle(r,m,l,s)}return Te.getMesh(r)}function DTe(t,e){let r=100*t.scale,n=ITe(t,e?.geometry);n.setBoundingSphere(te.create(y.create(r/2,r/2,r/2),r+r/4));let o=i=>{switch(i){case Yr.X:return t.colorX;case Yr.Y:return t.colorY;case Yr.Z:return t.colorZ;case Yr.XY:return t.planeColorXY;case Yr.XZ:return t.planeColorXZ;case Yr.YZ:return t.planeColorYZ;case Yr.Origin:return t.originColor;default:return ut.grey}};return Yt.create("axes-mesh",{},n,o,()=>1,()=>"")}function ATe(t){let e=DTe(t);return Yt.createRenderObject(e,U(w(w({},g.getDefaultValues(Be.Params)),t),{ignoreLight:!0,cellSize:0}))}function kTe(t,e){let r=Is.create(t,8,8,e),n=100*t.scale,o=y.scale(y(),y.unitX,n),i=y.scale(y(),y.unitY,n),a=y.scale(y(),y.unitZ,n),s=100*t.labelScale;return r.add(t.labelX,o[0],o[1],o[2],0,s,Yr.X),r.add(t.labelY,i[0],i[1],i[2],0,s,Yr.Y),r.add(t.labelZ,a[0],a[1],a[2],0,s,Yr.Z),r.getText()}function MTe(t,e){let r=100*t.scale,n=kTe(t,e?.geometry);n.setBoundingSphere(te.create(y.create(r/2,r/2,r/2),r));let o=i=>{switch(i){case Yr.X:return t.labelColorX;case Yr.Y:return t.labelColorY;case Yr.Z:return t.labelColorZ;default:return ut.grey}};return Yt.create("axes-text",{},n,o,()=>1,()=>"")}function RTe(t){let e=MTe(t);return Yt.createRenderObject(e,U(w(w({},g.getDefaultValues(Bo.Params)),t),{alpha:t.labelOpacity,cellSize:0}))}var LTe={transparentBackground:g.Boolean(!1),dpoitIterations:g.Numeric(2,{min:1,max:10,step:1}),multiSample:g.Group(n_),postprocessing:g.Group(Rv),marking:g.Group(c_),cameraHelper:g.Group(dh)},d_=class{get colorTarget(){return this._colorTarget}get width(){return this._width}get height(){return this._height}constructor(e,r,n,o,i,a,s,l){this.webgl=e,this.renderer=n,this.scene=o,this.camera=i,this._width=0,this._height=0,this._camera=new an,this.props=w(w({},g.getDefaultValues(LTe)),l),this.drawPass=new Bv(e,r,128,128,s),this.multiSamplePass=new Ep(e,this.drawPass),this.multiSampleHelper=new Lv(this.multiSamplePass),this.helper={camera:new Ov(e,this.props.cameraHelper),debug:a.debug,handle:a.handle},this.setSize(1024,768)}updateBackground(){return new Promise(e=>{this.drawPass.postprocessing.background.update(this.camera,this.props.postprocessing.background,()=>{e()})})}setSize(e,r){e===this._width&&r===this._height||(this._width=e,this._height=r,this.drawPass.setSize(e,r),this.multiSamplePass.syncSize())}setProps(e={}){Object.assign(this.props,e),e.cameraHelper&&this.helper.camera.setProps(e.cameraHelper)}render(){an.copySnapshot(this._camera.state,this.camera.state),_n.set(this._camera.viewport,0,0,this._width,this._height),this._camera.update();let e={renderer:this.renderer,camera:this._camera,scene:this.scene,helper:this.helper};Ep.isEnabled(this.props.multiSample)?(this.multiSampleHelper.render(e,this.props,!1),this._colorTarget=this.multiSamplePass.colorTarget):(this.drawPass.render(e,this.props,!1),this._colorTarget=this.drawPass.getColorTarget(this.props.postprocessing))}getImageData(e,r,n){var o,i;this.setSize(e,r),this.render(),this.colorTarget.bind();let a=(o=n?.width)!==null&&o!==void 0?o:e,s=(i=n?.height)!==null&&i!==void 0?i:r,l=new Uint8Array(a*s*4);n?this.webgl.readPixels(n.x,r-n.y-n.height,a,s,l):this.webgl.readPixels(0,0,a,s,l);let c=ip.create(l,a,s);return ip.flipY(c),ip.divideByAlpha(c),new ImageData(new Uint8ClampedArray(l),a,s)}};var BTe=U(w({},Be.Params),{alpha:U(w({},Be.Params.alpha),{defaultValue:1}),ignoreLight:U(w({},Be.Params.ignoreLight),{defaultValue:!0}),colorX:g.Color(ut.red,{isEssential:!0}),colorY:g.Color(ut.green,{isEssential:!0}),colorZ:g.Color(ut.blue,{isEssential:!0}),scale:g.Numeric(.33,{min:.1,max:2,step:.1},{isEssential:!0})}),p_={handle:g.MappedStatic("off",{on:g.Group(BTe),off:g.Group({})},{cycle:!0,description:"Show handle tool"})},m_=class{getBoundingSphere(e,r){return this.renderObject&&(te.copy(e,this.renderObject.values.invariantBoundingSphere.ref.value),W.fromArray(this._transform,this.renderObject.values.aTransform.ref.value,r*16),te.transform(e,e,this._transform)),e}setProps(e){this.props=ss(this.props,r=>{if(e.handle!==void 0&&(r.handle.name=e.handle.name,e.handle.name==="on")){this.scene.clear(),this.pixelRatio=this.webgl.pixelRatio;let n=U(w({},e.handle.params),{scale:e.handle.params.scale*this.webgl.pixelRatio,cellSize:0});this.renderObject=VTe(n),this.scene.add(this.renderObject),this.scene.commit(),r.handle.params=w({},e.handle.params)}})}get isEnabled(){return this.props.handle.name==="on"}update(e,r,n){this.renderObject&&(this.pixelRatio!==this.webgl.pixelRatio&&this.setProps(this.props),W.setTranslation(this.renderObject.values.aTransform.ref.value,r),W.fromMat3(this.renderObject.values.aTransform.ref.value,n),C.update(this.renderObject.values.aTransform,this.renderObject.values.aTransform.ref.value),this.scene.update([this.renderObject],!0))}getLoci(e){let{objectId:r,groupId:n,instanceId:o}=e;return!this.renderObject||r!==this.renderObject.id?St:FTe(this,n,o)}mark(e,r){return!kn.is(kn.Highlighting,r)||!So(e)&&(!bK(e)||e.data!==this)?!1:Vt.mark(this.renderObject,e,r,this.eachGroup)}constructor(e,r={}){this.webgl=e,this.props={handle:{name:"off",params:{}}},this.pixelRatio=1,this._transform=W(),this.eachGroup=(n,o)=>{if(!this.renderObject||!bK(n))return!1;let i=!1,a=this.renderObject.values.uGroupCount.ref.value,{elements:s}=n;for(let{groupId:l,instanceId:c}of s){let u=c*a+l;o(Oe.ofSingleton(u))&&(i=!0)}return i},this.scene=xm.create(e,"blended"),this.setProps(r)}};function OTe(t,e){let r=Te.createState(512,256,e),n=.05*t,o=y.scale(y(),y.unitX,t),i=y.scale(y(),y.unitY,t),a=y.scale(y(),y.unitZ,t),s={radiusTop:n,radiusBottom:n,radialSegments:32};return r.currentGroup=iy.TranslateScreenXY,Jt(r,y.origin,n*3,2),r.currentGroup=iy.TranslateObjectX,Jt(r,o,n,2),nr(r,y.origin,o,1,s),r.currentGroup=iy.TranslateObjectY,Jt(r,i,n,2),nr(r,y.origin,i,1,s),r.currentGroup=iy.TranslateObjectZ,Jt(r,a,n,2),nr(r,y.origin,a,1,s),Te.getMesh(r)}var iy={None:0,TranslateScreenXY:1,TranslateObjectX:3,TranslateObjectY:4,TranslateObjectZ:5};function FTe(t,e,r){return Sf("handle",t,[{groupId:e,instanceId:r}],n=>t.getBoundingSphere(n,r),()=>`Handle Helper | Group Id ${e} | Instance Id ${r}`)}function bK(t){return t.kind==="data-loci"&&t.tag==="handle"}function NTe(t,e){let r=10*t.scale,n=OTe(r,e?.geometry);n.setBoundingSphere(te.create(y.create(r/2,r/2,r/2),r+r/4));let o=i=>{switch(i){case iy.TranslateObjectX:return t.colorX;case iy.TranslateObjectY:return t.colorY;case iy.TranslateObjectZ:return t.colorZ;default:return ut.grey}};return Yt.create("handle",{},n,o,()=>1,()=>"")}function VTe(t){let e=NTe(t);return Yt.createRenderObject(e,t)}var zTe={debug:g.Group(J1),camera:g.Group({helper:g.Group(dh)}),handle:g.Group(p_)},UTe=g.getDefaultValues(zTe),f_=class{constructor(e,r,n={}){let o=w(w({},UTe),n);this.debug=new Qw(e,r,o.debug),this.camera=new Ov(e,o.camera.helper),this.handle=new m_(e,o.handle)}};var h_=class{constructor(e,r,n={}){this.webgl=e;let{gl:o}=e;this.draw=new Bv(e,r,o.drawingBufferWidth,o.drawingBufferHeight,n.transparency||"blended"),this.pick=new i_(e,this.draw,n.pickScale||.25),this.multiSample=new Ep(e,this.draw)}setPickScale(e){this.pick.setPickScale(e)}setTransparency(e){this.draw.setTransparency(e)}updateSize(){let{gl:e}=this.webgl,r=Math.max(e.drawingBufferWidth,2),n=Math.max(e.drawingBufferHeight,2);this.draw.setSize(r,n),this.pick.syncSize(),this.multiSample.syncSize()}};var xK=`
precision highp float;
precision highp sampler2D;

uniform sampler2D tPreviousLevel;
uniform vec2 uInvSize;
uniform vec2 uOffset;

void main(void) {
    vec2 position = gl_FragCoord.xy * uInvSize + uOffset;

    float x = texture(tPreviousLevel, position).r;
    float y = textureOffset(tPreviousLevel, position, ivec2(-1, 0)).r;
    float z = textureOffset(tPreviousLevel, position, ivec2(-1, -1)).r;
    float w = textureOffset(tPreviousLevel, position, ivec2(0, -1)).r;

    gl_FragColor = vec4(max(max(x, y), max(z, w)));
}
`;var GTe=U(w({},Er),{tPreviousLevel:We("texture","alpha","float","nearest"),uInvSize:ee("v2"),uOffset:ee("v2")}),jTe=Qt("hi-z",zr,xK);function SK(t,e){let r=U(w({},Ir),{tPreviousLevel:C.create(e),uInvSize:C.create(ne()),uOffset:C.create(ne())}),n=w({},GTe),o=dr(t,"triangles",jTe,n,r);return mr(o,r)}var CK=new ArrayBuffer(4),x_t=new Int32Array(CK),S_t=new Float32Array(CK);var TK=new ArrayBuffer(4),HTe=new Int32Array(TK),qTe=new Float32Array(TK);function WTe(t){let e=t<-126?-126:t;return HTe[0]=(1<<23)*(e+126.94269504),qTe[0]}function wK(t){return WTe(1.44269504*t)}var _K=new ArrayBuffer(8),C_t=new Int32Array(_K),T_t=new Float32Array(_K);var PK=new ArrayBuffer(4),XTe=new Int32Array(PK),YTe=new Float32Array(PK);function EK(t){return YTe[0]=t,XTe[0]*11920928955078125e-23-126.94269504}var w_t=Math.PI/2,__t=2*Math.PI,P_t=1/(2*Math.PI),E_t=2/Math.PI,I_t=4/Math.PI,D_t=4/(Math.PI*Math.PI),A_t=Math.PI/2-2*Math.PI;var IK=new ArrayBuffer(16),k_t=new Int32Array(IK),M_t=new Float32Array(IK);var DK=new ArrayBuffer(8),R_t=new Int32Array(DK),L_t=new Float32Array(DK);var AK=new ArrayBuffer(4),B_t=new Int32Array(AK),O_t=new Float32Array(AK);var F_t=Math.PI/4;var QTe=y.transformMat4,kK=at.set,KTe=EK;function $Te(t,e,r){return e*r/((r-e)*t-r)}function ZTe(t,e,r){return t*(e-r)-e}function g_(t,e,r,n){return n[11]===-1?$Te(t,e,r):ZTe(t,e,r)}function JTe(t,e,r,n){let o=e[0]*r,i=e[1]*r,a=e[2]*r,s=e[2]*e[2]-r*r,l=Math.sqrt(e[0]*e[0]+s),c=(l*e[0]-a)/(l*e[2]+o)*n[0],u=(l*e[0]+a)/(l*e[2]-o)*n[0],d=Math.sqrt(e[1]*e[1]+s),m=(d*e[1]-a)/(d*e[2]+i)*n[5],p=(d*e[1]+a)/(d*e[2]-i)*n[5];return kK(t,u*-.5+.5,m*.5+.5,c*-.5+.5,p*.5+.5)}function e2e(t,e,r,n){let o=n[0],i=n[5],a=(e[0]+r)*o,s=(e[0]-r)*o,l=(e[1]+r)*i,c=(e[1]-r)*i;return kK(t,s*.5+.5,l*-.5+.5,a*.5+.5,c*-.5+.5)}function t2e(t,e,r,n){return n[11]===-1?JTe(t,e,r,n):e2e(t,e,r,n)}var nL={enabled:g.Boolean(!1,{description:"Hierarchical Z-buffer occlusion culling. Only available for WebGL2."}),maxFrameLag:g.Numeric(10,{min:1,max:30,step:1},{description:"Maximum number of frames to wait for Z-buffer data."}),minLevel:g.Numeric(3,{min:1,max:10,step:1})},y_=class{clear(){if(!this.supported)return;let{gl:e}=this.webgl;ct(e)&&(this.sync!==null&&(e.deleteSync(this.sync),this.sync=null),this.frameLag=0,this.ready=!1,this.debug&&(this.debug.rect.style.display="none",this.debug.container.style.display="none"))}render(e){if(!this.supported||!this.props.enabled)return;let{gl:r,state:n}=this.webgl;if(!ct(r)||this.sync!==null)return;this.nextNear=e.near,this.nextFar=e.far,W.copy(this.nextView,e.view),W.copy(this.nextProjection,e.projection),Ee&&this.webgl.timer.mark("hi-Z"),n.disable(r.CULL_FACE),n.disable(r.BLEND),n.disable(r.DEPTH_TEST),n.disable(r.SCISSOR_TEST),n.depthMask(!1),n.colorMask(!0,!0,!0,!0),n.clearColor(0,0,0,0);let o=this.renderable.values,i=Math.pow(2,Math.ceil(Math.log(Math.max(r.drawingBufferWidth,r.drawingBufferHeight))/Math.log(2))-1);for(let l=0,c=this.levelData.length;l<c;++l){let u=this.levelData[l];u.framebuffer.bind(),l>0?(C.update(o.uInvSize,u.invSize),C.update(o.uOffset,ne.set(o.uOffset.ref.value,0,0)),C.update(o.tPreviousLevel,this.levelData[l-1].texture)):(C.update(o.uInvSize,ne.set(o.uInvSize.ref.value,1/i,1/i)),C.update(o.uOffset,ne.set(o.uOffset.ref.value,this.viewport.x/r.drawingBufferWidth,this.viewport.y/r.drawingBufferHeight)),C.update(o.tPreviousLevel,this.drawPass.depthTextureOpaque)),n.currentRenderItemId=-1,n.viewport(0,0,u.size[0],u.size[1]),r.clear(r.COLOR_BUFFER_BIT),this.renderable.update(),this.renderable.render(),l>=this.props.minLevel&&(this.tex.bind(0),r.copyTexSubImage2D(r.TEXTURE_2D,0,u.offset,0,0,0,u.size[0],u.size[1]),this.tex.unbind(0))}this.tex.attachFramebuffer(this.fb,0);let a=this.tex.getWidth(),s=this.tex.getHeight();r.bindBuffer(r.PIXEL_PACK_BUFFER,this.buf),r.bufferData(r.PIXEL_PACK_BUFFER,this.buffer.byteLength,r.STREAM_READ),r.readPixels(0,0,a,s,r.RED,r.FLOAT,0),r.bindBuffer(r.PIXEL_PACK_BUFFER,null),this.sync=r.fenceSync(r.SYNC_GPU_COMMANDS_COMPLETE,0),r.flush(),Ee&&this.webgl.timer.markEnd("hi-Z")}tick(){if(!this.supported||!this.props.enabled||this.sync===null)return;let{gl:e}=this.webgl;if(!ct(e))return;let r=e.clientWaitSync(this.sync,0,0);r===e.WAIT_FAILED||this.frameLag>=this.props.maxFrameLag?(e.deleteSync(this.sync),this.sync=null,this.frameLag=0,this.ready=!1):r===e.TIMEOUT_EXPIRED?this.frameLag+=1:(e.bindBuffer(e.PIXEL_PACK_BUFFER,this.buf),e.getBufferSubData(e.PIXEL_PACK_BUFFER,0,this.buffer),e.bindBuffer(e.PIXEL_PACK_BUFFER,null),e.deleteSync(this.sync),this.sync=null,this.frameLag=0,this.ready=!0,this.near=this.nextNear,this.far=this.nextFar,W.copy(this.view,this.nextView),W.copy(this.projection,this.nextProjection))}transform(e){let{view:r,vp:n}=this;QTe(n,e.center,r);let o=e.radius*1.2+1.52;return{vp:n,r:o}}project(e,r){let{projection:n,aabb:o,viewport:i}=this;t2e(o,e,r,n);let a=o[2]-o[0],s=o[3]-o[1],l=Math.max(a*i.width,s*i.height),c=Math.ceil(KTe(l/2));return{aabb:o,w:a,h:s,pr:l,lod:c}}setViewport(e,r,n,o){if(!this.supported)return;n=Math.max(n,2),o=Math.max(o,2),_n.set(this.viewport,e,r,n,o);let i=Math.ceil(Math.log(Math.max(n,o))/Math.log(2));if(i===this.levelData.length)return;let{minLevel:a}=this.props;this.buffer=new Float32Array(Math.pow(2,i-a)*Math.pow(2,i-1-a)),this.tex.define(Math.pow(2,i-a),Math.pow(2,i-1-a));for(let l of this.levelData)l.framebuffer.destroy(),l.texture.destroy();this.levelData.length=0;for(let l=0;l<i;++l){let c=this.webgl.resources.framebuffer(),u=Math.pow(2,i-l-1),d=ne.create(u,u),m=ne.create(1/u,1/u),p=this.webgl.resources.texture("image-float32","alpha","float","nearest");p.define(u,u),p.attachFramebuffer(c,0),this.levelData.push({texture:p,framebuffer:c,size:d,invSize:m,offset:0})}let s=0;for(let l=0,c=i;l<c;++l){let u=this.levelData[l];l>=a&&(this.levelData[l].offset=s,s+=u.size[0])}this.clear()}setProps(e){if(this.supported)if(this.props.minLevel!==e.minLevel){Object.assign(this.props,e);let{x:r,y:n,width:o,height:i}=this.viewport;this.setViewport(r,n,o,i)}else Object.assign(this.props,e),this.props.enabled||this.clear()}initDebug(e){if(!e.parentElement)return;let r=document.createElement("div");Object.assign(r.style,{display:"block",position:"absolute",pointerEvents:"none"}),e.parentElement.appendChild(r);let n=document.createElement("canvas"),o=n.getContext("2d");if(!o)throw new Error("Could not create canvas 2d context");Object.assign(n.style,{width:"100%",height:"100%",imageRendering:"pixelated",position:"relative",pointerEvents:"none"}),r.appendChild(n);let i=document.createElement("div");Object.assign(i.style,{display:"none",position:"absolute",pointerEvents:"none"}),e.parentElement.appendChild(i),this.debug={container:r,canvas:n,ctx:o,rect:i}}canDebug(e){return this.supported&&this.props.enabled&&this.ready&&!!this.debug}showRect(e,r){if(!this.canDebug(this.debug))return;let{gl:{drawingBufferHeight:n},pixelRatio:o}=this.webgl,{viewport:{x:i,y:a,width:s,height:l}}=this,c=(e[0]*s+i)/o,u=(e[1]*l-a)/o,d=(e[2]*s+i)/o,m=(e[3]*l-a)/o,p=(n-l)/o;Object.assign(this.debug.rect.style,{border:r?"solid red":"solid green",display:"block",left:`${c}px`,top:`${u+p}px`,width:`${d-c}px`,height:`${m-u}px`})}showBuffer(e){if(!this.canDebug(this.debug))return;if(e>=this.levelData.length||e<this.props.minLevel){this.debug.container.style.display="none";return}let{offset:r,size:[n,o]}=this.levelData[e],i=this.tex.getWidth(),a=new Uint8ClampedArray(n*o*4);a.fill(255);for(let p=0;p<o;++p)for(let h=0;h<n;++h){let f=(o-p-1)*n+h,b=this.buffer[p*i+h+r]*255;a[f*4+0]=b,a[f*4+3]=255-b}let s=new ImageData(a,n,o);this.debug.canvas.width=s.width,this.debug.canvas.height=s.height,this.debug.ctx.putImageData(s,0,0);let{viewport:{x:l,y:c,width:u,height:d},webgl:{pixelRatio:m}}=this;Object.assign(this.debug.container.style,{display:"block",bottom:`${c/m}px`,left:`${l/m}px`,width:`${u/m}px`,height:`${d/m}px`})}debugOcclusion(e){if(!this.canDebug(this.debug))return;if(!e){this.debug.rect.style.display="none",this.debug.container.style.display="none";return}let r=this.isOccluded(e),{vp:n,r:o}=this.transform(e),{aabb:i,lod:a}=this.project(n,o);this.showRect(i,r),this.showBuffer(a)}dispose(){if(this.supported){this.clear(),this.fb.destroy(),this.tex.destroy(),this.webgl.gl.deleteBuffer(this.buf),this.renderable.dispose();for(let e of this.levelData)e.framebuffer.destroy(),e.texture.destroy()}}constructor(e,r,n,o){this.webgl=e,this.drawPass=r,this.viewport=_n(),this.near=0,this.far=0,this.view=W(),this.projection=W(),this.nextNear=0,this.nextFar=0,this.nextView=W(),this.nextProjection=W(),this.aabb=at(),this.vp=y(),this.levelData=[],this.sync=null,this.buffer=new Float32Array(0),this.frameLag=0,this.ready=!1,this.isOccluded=c=>{if(!this.supported||!this.props.enabled||!this.ready)return!1;let{vp:u,r:d}=this.transform(c),{near:m,far:p,projection:h}=this,f=u[2]+d;if(-f<m)return!1;let{aabb:b,w:v,h:x,lod:S}=this.project(u,d);if(S>=this.levelData.length||S<this.props.minLevel)return!1;let{offset:T,size:E}=this.levelData[S],_=b[0]+v/2,D=b[1]+x/2,P=E[0],A=_*P,I=D*P,k=Math.floor(A),M=Math.ceil(I),R=this.tex.getWidth();if(k+1>=P||M+1>=P)return!1;let B=(P-M-1)*R+k+T;if(f>g_(this.buffer[B],m,p,h)||f>g_(this.buffer[B+1],m,p,h))return!1;let F=(P-M+1-1)*R+k+T;return!(f>g_(this.buffer[F],m,p,h)||f>g_(this.buffer[F+1],m,p,h))};let{gl:i,extensions:a}=e;if(!ct(i)||!a.colorBufferFloat){ht&&console.log('Missing webgl2 and/or colorBufferFloat support required for "Hi-Z"'),this.supported=!1;return}this.fb=e.resources.framebuffer(),this.tex=e.resources.texture("image-float32","alpha","float","nearest"),this.tex.attachFramebuffer(this.fb,0);let s=i.getParameter(i.IMPLEMENTATION_COLOR_READ_FORMAT),l=i.getParameter(i.IMPLEMENTATION_COLOR_READ_TYPE);if(s!==i.RED||l!==i.FLOAT){ht&&console.log('Missing red/float reading support required for "Hi-Z"'),this.supported=!1;return}this.supported=!0,this.props=w(w({},g.getDefaultValues(nL)),o),this.buf=UT(i),this.renderable=SK(e,this.drawPass.depthTextureOpaque),ht&&n&&this.initDebug(n)}};var Fa={camera:g.Group({mode:g.Select("perspective",g.arrayToOptions(["perspective","orthographic"]),{label:"Camera"}),helper:g.Group(dh,{isFlat:!0}),stereo:g.MappedStatic("off",{on:g.Group(tL),off:g.Group({})},{cycle:!0,hideIf:t=>t?.mode!=="perspective"}),fov:g.Numeric(45,{min:10,max:130,step:1},{label:"Field of View"}),manualReset:g.Boolean(!1,{isHidden:!0})},{pivot:"mode"}),cameraFog:g.MappedStatic("on",{on:g.Group({intensity:g.Numeric(15,{min:1,max:100,step:1})}),off:g.Group({})},{cycle:!0,description:"Show fog in the distance"}),cameraClipping:g.Group({radius:g.Numeric(100,{min:0,max:99,step:1},{label:"Clipping",description:"How much of the scene to show."}),far:g.Boolean(!0,{description:"Hide scene in the distance"}),minNear:g.Numeric(5,{min:.1,max:100,step:.1},{description:"Note, may cause performance issues rendering impostors when set too small and cause issues with outline rendering when too close to 0."})},{pivot:"radius"}),viewport:g.MappedStatic("canvas",{canvas:g.Group({}),"static-frame":g.Group({x:g.Numeric(0),y:g.Numeric(0),width:g.Numeric(128),height:g.Numeric(128)}),"relative-frame":g.Group({x:g.Numeric(.33,{min:0,max:1,step:.01}),y:g.Numeric(.33,{min:0,max:1,step:.01}),width:g.Numeric(.5,{min:.01,max:1,step:.01}),height:g.Numeric(.5,{min:.01,max:1,step:.01})})}),cameraResetDurationMs:g.Numeric(250,{min:0,max:1e3,step:1},{description:"The time it takes to reset the camera."}),sceneRadiusFactor:g.Numeric(1,{min:1,max:10,step:.1}),transparentBackground:g.Boolean(!1),dpoitIterations:g.Numeric(2,{min:1,max:10,step:1}),pickPadding:g.Numeric(3,{min:0,max:10,step:1},{description:"extra pixels to around target to check in case target is empty"}),multiSample:g.Group(n_),postprocessing:g.Group(Rv),marking:g.Group(c_),hiZ:g.Group(nL),renderer:g.Group(jw),trackball:g.Group(YR),interaction:g.Group($R),debug:g.Group(J1),handle:g.Group(p_)},rS=g.getDefaultValues(Fa);var Ad;(function(t){t.DefaultAttribs={powerPreference:"high-performance",failIfMajorPerformanceCaveat:!1,antialias:!0,preserveDrawingBuffer:!0,preferWebGl1:!1,handleResize:()=>{}},t.Params={pixelScale:g.Numeric(1,{min:.1,max:2,step:.05}),pickScale:g.Numeric(.25,{min:.1,max:1,step:.05}),transparency:g.Select("wboit",[["blended","Blended"],["wboit","Weighted, Blended"],["dpoit","Depth Peeling"]])},t.DefaultProps=g.getDefaultValues(t.Params);function e(r,n,o={},i={}){let a=w(w({},t.DefaultAttribs),o),s=w(w({},t.DefaultProps),i),{powerPreference:l,failIfMajorPerformanceCaveat:c,antialias:u,preserveDrawingBuffer:d,preferWebGl1:m}=a,p=KG(r,{powerPreference:l,failIfMajorPerformanceCaveat:c,antialias:u,preserveDrawingBuffer:d,alpha:!0,depth:!0,premultipliedAlpha:!0,preferWebGl1:m});if(p===null)throw new Error("Could not create a WebGL rendering context");let{pixelScale:h,pickScale:f,transparency:b}=s,v=Uw.fromElement(r,{pixelScale:h,preventGestures:!0}),x=tj(p,{pixelScale:h}),S=new h_(x,n,{pickScale:f,transparency:b});if(ht){let P=p.getExtension("WEBGL_lose_context");P&&r.addEventListener("mousedown",A=>{x.isContextLost||!A.shiftKey||!A.ctrlKey||!A.altKey||(ht&&console.log("lose context"),P.loseContext(),setTimeout(()=>{x.isContextLost&&(ht&&console.log("restore context"),P.restoreContext())},1e3))},!1)}let T=new da(0),E=P=>{x.setContextLost(),P.preventDefault(),ht&&console.log("context lost"),T.next(ko())},_=()=>{x.isContextLost&&(x.handleContextRestored(()=>{S.draw.reset()}),ht&&console.log("context restored"))};r.addEventListener("webglcontextlost",E,!1),r.addEventListener("webglcontextrestored",_,!1);let D=new da(void 0);return{canvas:r,webgl:x,input:v,passes:S,attribs:a,get props(){return w({},s)},contextLost:T,contextRestored:x.contextRestored,assetManager:n,changed:D,setProps:P=>{if(!P)return;let A=!1;P.pixelScale!==void 0&&P.pixelScale!==s.pixelScale&&(s.pixelScale=P.pixelScale,v.setPixelScale(P.pixelScale),x.setPixelScale(P.pixelScale),a.handleResize(),A=!0),P.pickScale!==void 0&&P.pickScale!==s.pickScale&&(s.pickScale=P.pickScale,S.setPickScale(P.pickScale),A=!0),P.transparency!==void 0&&P.transparency!==s.transparency&&(s.transparency=P.transparency,S.setTransparency(P.transparency),A=!0),A&&D.next(void 0)},dispose:P=>{v.dispose(),r.removeEventListener("webglcontextlost",E,!1),r.removeEventListener("webglcontextrestored",_,!1),x.destroy(P)}}}t.fromCanvas=e})(Ad||(Ad={}));var r2e=typeof window<"u"?window.requestAnimationFrame:t=>setImmediate(()=>t(Date.now())),MK=typeof window<"u"?window.cancelAnimationFrame:t=>clearImmediate(t),v_;(function(t){function e(r,n={}){var o;let{webgl:i,input:a,passes:s,assetManager:l,canvas:c}=r,u=w(w({},$s(rS)),$s(n)),d=new Map,m=new Map,p=new da(0),h=ko(),f=new da(0),b=new da(0),v=new da(0),{gl:x,contextRestored:S}=i,T=0,E=0,_=128,D=128,P=!1,A=0;Ys();let I=xm.create(i,s.draw.transparency);function k(){return I.boundingSphere.radius*u.sceneRadiusFactor}let M=new an({position:y.create(0,0,100),mode:u.camera.mode,fog:u.cameraFog.name==="on"?u.cameraFog.params.intensity:0,clipFar:u.cameraClipping.far,minNear:u.cameraClipping.minNear,fov:or(u.camera.fov)},{x:T,y:E,width:_,height:D}),R=new Dd(M,u.camera.stereo.params),B=qw.create(a,M,I,u.trackball),F=new f_(i,I,u),G=new y_(i,s.draw,c,u.hiZ),V=Hw.create(i,u.renderer);V.setOcclusionTest(G.isOccluded);let H=new a_(i,V,I,F,s.pick,{x:T,y:E,width:_,height:D},u.pickPadding),Q=new Kw(Ke,ae,a,M,B,u.interaction),L=new Lv(s.multiSample);s.draw.postprocessing.background.update(M,u.postprocessing.background,He=>{He&&Nr()});let Y=!1,j,O,J=!1,$=!0;function ae(He){let _t=St,Gt=rt.Empty;if(He){let Xt=F.camera.getLoci(He);if(Xt!==St)return{loci:Xt,repr:Gt};_t=F.handle.getLoci(He),d.forEach((Vr,ho)=>{let mt=ho.getLoci(He);Wn(mt)||(Wn(_t)||console.warn("found another loci, this should not happen"),_t=mt,Gt=ho)})}return{loci:_t,repr:Gt}}let Z=[];function se(He,_t){Z.push([He,_t])}function Me(){let He=!1;for(let[_t,Gt]of Z)He=be(_t,Gt)||He;return Z=[],He&&(I.update(void 0,!0),F.handle.scene.update(void 0,!0),F.camera.scene.update(void 0,!0)),He}function be(He,_t){let{repr:Gt,loci:Xt}=He,Vr=!1;return Gt?Vr=Gt.mark(Xt,_t)||Vr:d.forEach((ho,mt)=>{Vr=mt.mark(Xt,_t)||Vr}),Vr=F.handle.mark(Xt,_t)||Vr,Vr=F.camera.mark(Xt,_t)||Vr,Vr}function _e(He){if(i.isContextLost)return!1;let _t=!1;if(J&&(bn(!1),J=!1,_t=!0),T>x.drawingBufferWidth||T+_<0||E>x.drawingBufferHeight||E+D<0)return!1;let Gt=Me()&&(V.props.colorMarker||u.marking.enabled),Xt=!1;B.update(A);let Vr=M.update(),ho=He||Vr||_t||P;P=!1;let mt=L.update(Gt||ho,u.multiSample);if(ho||mt||Gt){let On=M;u.camera.stereo.name==="on"&&(R.update(),On=R),Ee&&i.timer.mark("Canvas3D.render",!0);let $a={renderer:V,camera:On,scene:I,helper:F};if(Ep.isEnabled(u.multiSample)){let go=u.multiSample.reduceFlicker&&!Vr&&Gt&&!B.isAnimating;L.render($a,u,!0,go)}else s.draw.render($a,u,!0);G.render(M),Ee&&i.timer.markEnd("Canvas3D.render"),H.dirty=H.dirty||ho,Xt=!0}return Xt}let je=!1,gt=!1;function fr(He){gt||_e(!!He?.force)&&$&&f.next(ko()-h)}function Nr(){P=!0}let Zt=0;function oe(He,_t){A=He,Ve(_t?.isSynchronous),_t?.updateControls&&B.update(A),M.transition.tick(A),G.tick(),!_t?.manualDraw&&(fr(),!M.transition.inTransition&&!i.isContextLost&&Q.tick(A))}function De(){oe(ko()),Zt=r2e(De)}function Le(He){h=He,B.start(He)}function Qe(){gt=!1,B.start(ko()),Zt===0&&De()}function Ue(He=!1){gt=He,MK(Zt),Zt=0}function Ke(He,_t){let Gt=u.camera.stereo.name==="on"?R:M;return i.isContextLost?void 0:H.identify(He,_t,Gt)}function Ve(He=!1){ft(He)&&(It(),je&&(F.debug.isEnabled&&F.debug.update(),fr({force:!0}),je=!1),b.next(ko()))}function It(){if(!Y)return;let He=I.boundingSphereVisible,{center:_t,radius:Gt}=He,Xt=B.props.autoAdjustMinMaxDistance;if(Xt.name==="on"){let Vr=Xt.params.minDistanceFactor*Gt+Xt.params.minDistancePadding,ho=Math.max(Xt.params.maxDistanceFactor*Gt,Xt.params.maxDistanceMin);B.setProps({minDistance:Vr,maxDistance:ho})}if(Gt>0){let Vr=j===void 0?u.cameraResetDurationMs:j,ho=M.getFocus(_t,Gt),mt=typeof O=="function"?O(I,M):O,On=mt?w(w({},ho),mt):ho;M.setState(U(w({},On),{radiusMax:k()}),Vr)}j=void 0,O=void 0,Y=!1}let yt=te(),pe=te();function Ae(){if(M.state.radiusMax===0)return!0;if(M.transition.inTransition||O)return!1;let He=!0,_t=!0;te.set(pe,M.state.target,M.state.radius);for(let Gt of I.renderables){if(!Gt.state.visible)continue;let Xt=Gt.values.boundingSphere.ref.value;if(!Xt.radius)continue;_t=!1;let Vr=y.distance(pe.center,Xt.center);if((Vr>pe.radius||Vr>Xt.radius||Xt.radius>M.state.radiusMax)&&!te.includes(yt,Xt))return!0;te.overlaps(pe,Xt)&&(He=!1)}return He||!_t&&pe.radius<=.1}let $e=250;function ft(He){return I.needsCommit?(te.copy(yt,I.boundingSphereVisible),G.clear(),I.commit(He?void 0:$e)?(v.next(0),F.debug.isEnabled&&F.debug.update(),!u.camera.manualReset&&(p.value===0||Ae())&&(Y=!0),yt.radius===0&&(j=0),u.camera.manualReset||M.setState({radiusMax:k()},0),p.next(d.size),ht&&Pt(),!0):(v.next(I.commitQueueSize),!1)):!0}function Pt(){let He=I.renderables.map(Vr=>({drawCount:Vr.values.drawCount.ref.value,instanceCount:Vr.values.instanceCount.ref.value,materialId:Vr.materialId,renderItemId:Vr.id}));console.groupCollapsed(`${He.length} RenderItems`),He.length<50?console.table(He):console.log(He),console.log(JSON.stringify(i.stats,void 0,4));let{texture:_t,attribute:Gt,elements:Xt}=i.resources.getByteCounts();console.log(JSON.stringify({texture:`${(_t/1024/1024).toFixed(3)} MiB`,attribute:`${(Gt/1024/1024).toFixed(3)} MiB`,elements:`${(Xt/1024/1024).toFixed(3)} MiB`},void 0,4)),console.log(JSON.stringify(i.timer.formatedStats(),void 0,4)),console.groupEnd()}function yr(He){_r(He);let _t=d.get(He),Gt=new Set;He.renderObjects.forEach(Xt=>Gt.add(Xt)),_t?no.areEqual(Gt,_t)||(Gt.forEach(Xt=>{_t.has(Xt)||I.add(Xt)}),_t.forEach(Xt=>{Gt.has(Xt)||I.remove(Xt)})):He.renderObjects.forEach(Xt=>I.add(Xt)),d.set(He,Gt),I.update(He.renderObjects,!1),je=!0,ht&&Pt()}function Ze(He){qr(He);let _t=d.get(He);_t&&(_t.forEach(Gt=>I.remove(Gt)),d.delete(He),je=!0,ht&&Pt())}function _r(He){m.has(He)||m.set(He,He.updated.subscribe(_t=>{He.state.syncManually||yr(He)}))}function qr(He){let _t=m.get(He);_t&&(_t.unsubscribe(),m.delete(He))}function Ao(){let He=I.boundingSphere.radius>0?100-Math.round(M.transition.target.radius/k()*100):0;return{camera:{mode:M.state.mode,helper:w({},F.camera.props),stereo:w({},u.camera.stereo),fov:Math.round(Jd(M.state.fov)),manualReset:!!u.camera.manualReset},cameraFog:M.state.fog>0?{name:"on",params:{intensity:M.state.fog}}:{name:"off",params:{}},cameraClipping:{far:M.state.clipFar,radius:He,minNear:M.state.minNear},cameraResetDurationMs:u.cameraResetDurationMs,sceneRadiusFactor:u.sceneRadiusFactor,transparentBackground:u.transparentBackground,dpoitIterations:u.dpoitIterations,pickPadding:u.pickPadding,viewport:u.viewport,postprocessing:w({},u.postprocessing),marking:w({},u.marking),multiSample:w({},u.multiSample),hiZ:w({},G.props),renderer:w({},V.props),trackball:w({},B.props),interaction:w({},Q.props),debug:w({},F.debug.props),handle:w({},F.handle.props)}}let Bn=S.subscribe(()=>{H.dirty=!0,fr({force:!0}),fr({force:!0})}),co=new da(0);function bn(He=!0){s.updateSize(),Ys(),Sl(),He&&Nr(),co.next(+new Date)}Lz(Pt);let Ii=(o=r.changed)===null||o===void 0?void 0:o.subscribe(()=>{I.setTransparency(s.draw.transparency),Nr()});if(ht&&c){let He,_t=Gt=>{let Xt=Gt&&st.getBoundingSphere(st.normalize(Gt,"residue"));G.debugOcclusion(Xt)};a.click.subscribe(Gt=>{if(!Gt.modifiers.control||Gt.button!==2)return;let Xt=Ke(Gt.x,Gt.y);if(!Xt){He=void 0,_t(He);return}He=ae(Xt.id).loci,_t(He)}),f.subscribe(()=>{setTimeout(()=>{_t(He)},100)})}return{webgl:i,add:yr,remove:Ze,commit:Ve,update:(He,_t)=>{if(He){if(!d.has(He))return;I.update(He.renderObjects,!!_t)}else I.update(void 0,!!_t);je=!0},clear:()=>{m.forEach(He=>He.unsubscribe()),m.clear(),d.clear(),I.clear(),F.debug.clear(),Nr(),p.next(d.size)},syncVisibility:()=>{M.state.radiusMax===0&&(Y=!0,j=0),I.syncVisibility()&&F.debug.isEnabled&&F.debug.update(),Nr()},requestDraw:Nr,tick:oe,animate:Qe,resetTime:Le,pause:Ue,resume:()=>{gt=!1},identify:Ke,mark:se,getLoci:ae,handleResize:bn,requestResize:()=>{J=!0},requestCameraReset:He=>{j=He?.durationMs,O=He?.snapshot,Y=!0},camera:M,boundingSphere:I.boundingSphere,boundingSphereVisible:I.boundingSphereVisible,get notifyDidDraw(){return $},set notifyDidDraw(He){$=He},didDraw:f,commited:b,commitQueueSize:v,reprCount:p,resized:co,setProps:(He,_t=!1)=>{var Gt,Xt,Vr,ho;let mt=typeof He=="function"?ss(Ao(),He):He;mt.sceneRadiusFactor!==void 0&&(u.sceneRadiusFactor=mt.sceneRadiusFactor,M.setState({radiusMax:k()},0));let On=Object.create(null);mt.camera&&mt.camera.mode!==void 0&&mt.camera.mode!==M.state.mode&&(On.mode=mt.camera.mode);let $a=Math.round(Jd(M.state.fov));if(mt.camera&&mt.camera.fov!==void 0&&mt.camera.fov!==$a&&(On.fov=or(mt.camera.fov)),mt.cameraFog!==void 0&&mt.cameraFog.params){let go=mt.cameraFog.name==="on"?mt.cameraFog.params.intensity:0;go!==M.state.fog&&(On.fog=go)}if(mt.cameraClipping!==void 0&&(mt.cameraClipping.far!==void 0&&mt.cameraClipping.far!==M.state.clipFar&&(On.clipFar=mt.cameraClipping.far),mt.cameraClipping.minNear!==void 0&&mt.cameraClipping.minNear!==M.state.minNear&&(On.minNear=mt.cameraClipping.minNear),mt.cameraClipping.radius!==void 0)){let go=k()/100*(100-mt.cameraClipping.radius);go>0&&go!==On.radius&&(On.radius=Math.max(go,.01))}Object.keys(On).length>0&&M.setState(On),!((Gt=mt.camera)===null||Gt===void 0)&&Gt.helper&&F.camera.setProps(mt.camera.helper),((Xt=mt.camera)===null||Xt===void 0?void 0:Xt.manualReset)!==void 0&&(u.camera.manualReset=mt.camera.manualReset),((Vr=mt.camera)===null||Vr===void 0?void 0:Vr.stereo)!==void 0&&(Object.assign(u.camera.stereo,mt.camera.stereo),R.setProps(u.camera.stereo.params)),mt.cameraResetDurationMs!==void 0&&(u.cameraResetDurationMs=mt.cameraResetDurationMs),mt.transparentBackground!==void 0&&(u.transparentBackground=mt.transparentBackground),mt.dpoitIterations!==void 0&&(u.dpoitIterations=mt.dpoitIterations),mt.pickPadding!==void 0&&(u.pickPadding=mt.pickPadding),mt.viewport!==void 0&&(u.viewport===mt.viewport||u.viewport.name===mt.viewport.name&&ep(u.viewport.params,mt.viewport.params)||(u.viewport=mt.viewport,Ys(),Sl())),!((ho=mt.postprocessing)===null||ho===void 0)&&ho.background&&(Object.assign(u.postprocessing.background,mt.postprocessing.background),s.draw.postprocessing.background.update(M,u.postprocessing.background,go=>{go&&!_t&&Nr()})),mt.postprocessing&&Object.assign(u.postprocessing,mt.postprocessing),mt.marking&&Object.assign(u.marking,mt.marking),mt.multiSample&&Object.assign(u.multiSample,mt.multiSample),mt.hiZ&&G.setProps(mt.hiZ),mt.renderer&&V.setProps(mt.renderer),mt.trackball&&B.setProps(mt.trackball),mt.interaction&&Q.setProps(mt.interaction),mt.debug&&F.debug.setProps(mt.debug),mt.handle&&F.handle.setProps(mt.handle),On.mode==="orthographic"&&(u.camera.stereo.name="off"),_t||Nr()},getImagePass:(He={})=>new d_(i,l,V,I,M,F,s.draw.transparency,He),getRenderObjects(){let He=[];return I.forEach((_t,Gt)=>He.push(Gt)),He},get props(){return Ao()},get input(){return a},get stats(){return V.stats},get interaction(){return Q.events},dispose:()=>{Bn.unsubscribe(),Ii?.unsubscribe(),MK(Zt),Z=[],I.clear(),F.debug.clear(),B.dispose(),V.dispose(),Q.dispose(),G.dispose(),Bz(Pt)}};function Ys(){let He=T,_t=E,Gt=_,Xt=D;u.viewport.name==="canvas"?(T=0,E=0,_=x.drawingBufferWidth,D=x.drawingBufferHeight):u.viewport.name==="static-frame"?(T=u.viewport.params.x*i.pixelRatio,D=u.viewport.params.height*i.pixelRatio,E=x.drawingBufferHeight-D-u.viewport.params.y*i.pixelRatio,_=u.viewport.params.width*i.pixelRatio):u.viewport.name==="relative-frame"&&(T=Math.round(u.viewport.params.x*x.drawingBufferWidth),D=Math.round(u.viewport.params.height*x.drawingBufferHeight),E=Math.round(x.drawingBufferHeight-D-u.viewport.params.y*x.drawingBufferHeight),_=Math.round(u.viewport.params.width*x.drawingBufferWidth)),(He!==T||_t!==E||Gt!==_||Xt!==D)&&(P=!0)}function Sl(){H.setViewport(T,E,_,D),V.setViewport(T,E,_,D),_n.set(M.viewport,T,E,_,D),_n.set(B.viewport,T,E,_,D),G.setViewport(T,E,_,D)}}t.create=e})(v_||(v_={}));function n2e(t){RK(t)}function RK(t){Re.Canvas3D.ResetSettings.subscribe(t,()=>{var e;(e=t.canvas3d)===null||e===void 0||e.setProps(rS),t.events.canvas3d.settingsUpdated.next(void 0)}),Re.Canvas3D.SetSettings.subscribe(t,e=>{var r;t.canvas3d&&((r=t.canvas3d)===null||r===void 0||r.setProps(e.settings),t.events.canvas3d.settingsUpdated.next(void 0))})}var aL={};ua(aL,{DefaultFocusLociBindings:()=>BK,DefaultLociLabelProvider:()=>l2e,DefaultSelectLociBindings:()=>LK,FocusLoci:()=>ly,HighlightLoci:()=>a2e,SelectLoci:()=>iL});var ay=yn,mh=na,sy=Xe.Trigger,o2e={hoverHighlightOnly:Xe([sy(ay.Flag.None)],"Highlight","Hover element using ${triggers}"),hoverHighlightOnlyExtend:Xe([sy(ay.Flag.None,mh.create({shift:!0}))],"Extend highlight","From selected to hovered element along polymer using ${triggers}")},i2e={bindings:g.Value(o2e,{isHidden:!0}),ignore:g.Value([],{isHidden:!0}),preferAtoms:g.Boolean(!1,{description:"Always prefer atoms over bonds"}),mark:g.Boolean(!0)},a2e=rr.create({name:"representation-highlight-loci",category:"interaction",ctor:class extends rr.Handler{constructor(){super(...arguments),this.lociMarkProvider=(t,e)=>{!this.ctx.canvas3d||!this.params.mark||this.ctx.canvas3d.mark(t,e)}}getLoci(t){return this.params.preferAtoms&&ze.isLoci(t)&&t.bonds.length===2?ze.toFirstStructureElementLoci(t):t}register(){this.subscribeObservable(this.ctx.behaviors.interaction.hover,({current:t,buttons:e,modifiers:r})=>{if(!this.ctx.canvas3d||this.ctx.isBusy)return;let n=this.getLoci(t.loci);if(this.params.ignore.includes(n.kind)){this.ctx.managers.interactivity.lociHighlights.highlightOnly({repr:t.repr,loci:St});return}let o=!1;Xe.match(this.params.bindings.hoverHighlightOnly,e,r)&&(this.ctx.managers.interactivity.lociHighlights.highlightOnly({loci:n}),o=!0),Xe.match(this.params.bindings.hoverHighlightOnlyExtend,e,r)&&(this.ctx.managers.interactivity.lociHighlights.highlightOnlyExtend({loci:n}),o=!0),o||this.ctx.managers.interactivity.lociHighlights.highlightOnly({repr:t.repr,loci:St})}),this.ctx.managers.interactivity.lociHighlights.addProvider(this.lociMarkProvider)}unregister(){this.ctx.managers.interactivity.lociHighlights.removeProvider(this.lociMarkProvider)}},params:()=>i2e,display:{name:"Highlight Loci on Canvas"}}),LK={clickSelect:Xe.Empty,clickToggleExtend:Xe([sy(ay.Flag.Primary,mh.create({shift:!0}))],"Toggle extended selection","Click on element using ${triggers} to extend selection along polymer"),clickSelectOnly:Xe.Empty,clickToggle:Xe([sy(ay.Flag.Primary,mh.create())],"Toggle selection","Click on element using ${triggers}"),clickDeselect:Xe.Empty,clickDeselectAllOnEmpty:Xe([sy(ay.Flag.Primary,mh.create())],"Deselect all","Click on nothing using ${triggers}")},s2e={bindings:g.Value(LK,{isHidden:!0}),ignore:g.Value([],{isHidden:!0}),preferAtoms:g.Boolean(!1,{description:"Always prefer atoms over bonds"}),mark:g.Boolean(!0)},iL=rr.create({name:"representation-select-loci",category:"interaction",ctor:class extends rr.Handler{getLoci(t){return this.params.preferAtoms&&ze.isLoci(t)&&t.bonds.length===2?ze.toFirstStructureElementLoci(t):t}applySelectMark(t,e){let r=this.ctx.state.data.cells.get(t);if(r&&X.isRepresentation3D(r.obj)){this.spine.current=r;let n=this.spine.getRootOfType(X.Molecule.Structure);if(n){e&&this.lociMarkProvider({loci:ue.Loci(n.data)},tt.Deselect);let o=this.ctx.managers.structure.selection.getLoci(n.data);this.lociMarkProvider({loci:o},tt.Select)}}}register(){let t=n=>st.isEmpty(n),e=n=>!st.isEmpty(n),r=[["clickSelect",n=>this.ctx.managers.interactivity.lociSelects.select(n),e],["clickToggle",n=>this.ctx.managers.interactivity.lociSelects.toggle(n),e],["clickToggleExtend",n=>this.ctx.managers.interactivity.lociSelects.toggleExtend(n),e],["clickSelectOnly",n=>this.ctx.managers.interactivity.lociSelects.selectOnly(n),e],["clickDeselect",n=>this.ctx.managers.interactivity.lociSelects.deselect(n),e],["clickDeselectAllOnEmpty",()=>this.ctx.managers.interactivity.lociSelects.deselectAll(),t]];r.sort((n,o)=>{let i=this.params.bindings[n[0]],a=this.params.bindings[o[0]],s=i.triggers.length===0?0:Mi(i.triggers.map(c=>mh.size(c.modifiers)));return(a.triggers.length===0?0:Mi(a.triggers.map(c=>mh.size(c.modifiers))))-s}),this.subscribeObservable(this.ctx.behaviors.interaction.click,({current:n,button:o,modifiers:i})=>{if(!this.ctx.canvas3d||this.ctx.isBusy||!this.ctx.selectionMode)return;let a=this.getLoci(n.loci);if(!this.params.ignore.includes(a.kind)){for(let[s,l,c]of r)if(Xe.match(this.params.bindings[s],o,i)&&(!c||c(a))){l({repr:n.repr,loci:a});break}}}),this.ctx.managers.interactivity.lociSelects.addProvider(this.lociMarkProvider),this.subscribeObservable(this.ctx.state.events.object.created,({ref:n})=>this.applySelectMark(n)),this.subscribeObservable(this.ctx.state.events.object.updated,({ref:n,obj:o,oldObj:i,oldData:a,action:s})=>{let l=this.ctx.state.data.cells.get(n);if(l&&X.Molecule.Structure.is(l.obj)){let c=o.data,u=s==="recreate"?i?.data:s==="in-place"?a:void 0;if(u&&ue.areEquivalent(c,u)&&ue.areHierarchiesEqual(c,u))return;let d=this.ctx.state.data.select(lt.children(n).ofType(X.Molecule.Structure.Representation3D));for(let m of d)this.applySelectMark(m.transform.ref,!0)}})}unregister(){this.ctx.managers.interactivity.lociSelects.removeProvider(this.lociMarkProvider)}constructor(t,e){super(t,e),this.lociMarkProvider=(r,n)=>{!this.ctx.canvas3d||!this.params.mark||this.ctx.canvas3d.mark({loci:r.loci},n)},this.spine=new Af.Impl(t.state.data.cells)}},params:()=>s2e,display:{name:"Select Loci on Canvas"}}),l2e=rr.create({name:"default-loci-label-provider",category:"interaction",ctor:class{register(){this.ctx.managers.lociLabels.addProvider(this.f)}unregister(){this.ctx.managers.lociLabels.removeProvider(this.f)}constructor(t){this.ctx=t,this.f={label:e=>{let r=[];if(z.Loci.is(e)){let n=new Set;for(let{unit:o}of e.elements){let i=z.Location.create(e.structure,o,o.elements[0]),a=Ne.entity.pdbx_description(i).join(", ");n.add(a)}n.size===1&&n.forEach(o=>r.push(o))}return r.push(fu(e)),r.filter(n=>!!n).join("</br>")},group:e=>e.toString().replace(/Model [0-9]+/g,"Models"),priority:100}}},display:{name:"Provide Default Loci Label"}}),BK={clickFocus:Xe([sy(ay.Flag.Primary,mh.create())],"Representation Focus","Click element using ${triggers}"),clickFocusAdd:Xe([sy(ay.Flag.Primary,mh.create({shift:!0}))],"Representation Focus Add","Click element using ${triggers}"),clickFocusSelectMode:Xe([],"Representation Focus","Click element using ${triggers}"),clickFocusAddSelectMode:Xe([],"Representation Focus Add","Click element using ${triggers}")},c2e={bindings:g.Value(BK,{isHidden:!0})},ly=rr.create({name:"representation-focus-loci",category:"interaction",ctor:class extends rr.Handler{register(){this.subscribeObservable(this.ctx.behaviors.interaction.click,({current:t,button:e,modifiers:r})=>{var n,o,i,a,s;let{clickFocus:l,clickFocusAdd:c,clickFocusSelectMode:u,clickFocusAddSelectMode:d}=this.params.bindings,m=this.ctx.selectionMode?u:l,p=Xe.match(m,e,r),h=(a=(i=(o=(n=t.repr)===null||n===void 0?void 0:n.props)===null||o===void 0?void 0:o.snapshotKey)===null||i===void 0?void 0:i.trim())!==null&&a!==void 0?a:"";if(!this.ctx.selectionMode&&p&&h){this.ctx.managers.snapshot.applyKey(h);return}let{granularity:f}=this.ctx.managers.interactivity.props;if(f!=="residue"&&f!=="element")return;let b=this.ctx.selectionMode?d:c,v=Xe.match(b,e,r);if(!p&&!v)return;let x=st.normalize(t.loci,"residue"),S=this.ctx.managers.structure.focus.current;if(S&&st.areEqual(S.loci,x))this.ctx.managers.structure.focus.clear();else if(p)this.ctx.managers.structure.focus.setFromLoci(x);else{this.ctx.managers.structure.focus.addFromLoci(x);let T=(s=this.ctx.managers.structure.focus.current)===null||s===void 0?void 0:s.loci;T&&this.ctx.managers.camera.focusLoci(T)}})}},params:()=>c2e,display:{name:"Representation Focus Loci on Canvas"}});var cL={};ua(cL,{CameraAxisHelper:()=>m2e,CameraControls:()=>f2e,DefaultClickResetCameraOnEmpty:()=>sL,DefaultClickResetCameraOnEmptySelectMode:()=>lL,DefaultFocusLociBindings:()=>OK,FocusLoci:()=>d2e});var Cm=yn,kd=na,Tm=Xe.Trigger,b_=Xe.TriggerKey,sL=Xe([Tm(Cm.Flag.Primary,kd.create()),Tm(Cm.Flag.Secondary,kd.create()),Tm(Cm.Flag.Primary,kd.create({control:!0}))],"Reset camera focus","Click on nothing using ${triggers}"),lL=Xe([Tm(Cm.Flag.Secondary,kd.create()),Tm(Cm.Flag.Primary,kd.create({control:!0}))],"Reset camera focus","Click on nothing using ${triggers}"),OK={clickCenterFocus:Xe([Tm(Cm.Flag.Primary,kd.create()),Tm(Cm.Flag.Secondary,kd.create()),Tm(Cm.Flag.Primary,kd.create({control:!0}))],"Camera center and focus","Click element using ${triggers}"),clickCenterFocusSelectMode:Xe([Tm(Cm.Flag.Secondary,kd.create()),Tm(Cm.Flag.Primary,kd.create({control:!0}))],"Camera center and focus","Click element using ${triggers}"),clickResetCameraOnEmpty:sL,clickResetCameraOnEmptySelectMode:lL},u2e={minRadius:g.Numeric(8,{min:1,max:50,step:1}),extraRadius:g.Numeric(4,{min:1,max:50,step:1},{description:"Value added to the bounding-sphere radius of the Loci"}),durationMs:g.Numeric(250,{min:0,max:1e3,step:1},{description:"Camera transition duration"}),bindings:g.Value(OK,{isHidden:!0})},d2e=rr.create({name:"camera-focus-loci",category:"interaction",ctor:class extends rr.Handler{register(){this.subscribeObservable(this.ctx.behaviors.interaction.click,({current:t,button:e,modifiers:r})=>{var n,o;if(!this.ctx.canvas3d)return;let i=this.ctx.selectionMode?this.params.bindings.clickCenterFocusSelectMode:this.params.bindings.clickCenterFocus,a=this.ctx.selectionMode?(n=this.params.bindings.clickResetCameraOnEmptySelectMode)!==null&&n!==void 0?n:lL:(o=this.params.bindings.clickResetCameraOnEmpty)!==null&&o!==void 0?o:sL;if(st.isEmpty(t.loci)&&Xe.match(a,e,r)){Re.Camera.Reset(this.ctx,{});return}if(Xe.match(i,e,r)){let s=st.normalize(t.loci,this.ctx.managers.interactivity.props.granularity);this.ctx.managers.camera.focusLoci(s,this.params)}})}},params:()=>u2e,display:{name:"Camera Focus Loci on Canvas"}}),m2e=rr.create({name:"camera-axis-helper",category:"interaction",ctor:class extends rr.Handler{register(){let t=Yr.None,e=0;this.subscribeObservable(this.ctx.behaviors.interaction.click,({current:r})=>{if(!this.ctx.canvas3d||!u_(r.loci))return;let n=r.loci.elements[0].groupId;if(n===Yr.None){t=Yr.None,e=0;return}let{camera:o}=this.ctx.canvas3d,i,a;if(n>=Yr.X&&n<=Yr.Z){t=Yr.None,e=0;let s=y.sub(y(),o.target,o.position),l=y.cross(y(),s,o.up);a=y(),a[n-1]=1,i=y.cross(y(),a,l),y.magnitude(i)===0&&(i=s)}else t===n?e=(e+1)%2:(t=n,e=0),n===Yr.XY?(a=e?y.unitX:y.unitY,i=y.negUnitZ):n===Yr.XZ?(a=e?y.unitX:y.unitZ,i=y.negUnitY):(a=e?y.unitY:y.unitZ,i=y.negUnitX);this.ctx.canvas3d.requestCameraReset({snapshot:(s,l)=>l.getInvariantFocus(s.boundingSphereVisible.center,s.boundingSphereVisible.radius,a,i)})})}},params:()=>({}),display:{name:"Camera Axis Helper"}}),FK={keySpinAnimation:Xe([b_("I")],"Spin Animation","Press ${triggers}"),keyRockAnimation:Xe([b_("O")],"Rock Animation","Press ${triggers}"),keyToggleFlyMode:Xe([b_("Space",kd.create({shift:!0}))],"Toggle Fly Mode","Press ${triggers}"),keyResetView:Xe([b_("T")],"Reset View","Press ${triggers}")},p2e={bindings:g.Value(FK,{isHidden:!0})},f2e=rr.create({name:"camera-controls",category:"interaction",ctor:class extends rr.Handler{register(){this.subscribeObservable(this.ctx.behaviors.interaction.key,({code:t,key:e,modifiers:r})=>{var n;if(!this.ctx.canvas3d)return;let o=w(w({},FK),this.params.bindings),i=this.ctx.canvas3d.props.trackball;if(Xe.matchKey(o.keySpinAnimation,t,r,e)){let a=i.animate.name!=="spin"?"spin":"off";a==="off"?this.ctx.canvas3d.setProps({trackball:{animate:{name:a,params:{}}}}):this.ctx.canvas3d.setProps({trackball:{animate:{name:a,params:{speed:1}}}})}if(Xe.matchKey(o.keyRockAnimation,t,r,e)){let a=i.animate.name!=="rock"?"rock":"off";a==="off"?this.ctx.canvas3d.setProps({trackball:{animate:{name:a,params:{}}}}):this.ctx.canvas3d.setProps({trackball:{animate:{name:a,params:{speed:.3,angle:10}}}})}if(Xe.matchKey(o.keyToggleFlyMode,t,r,e)){let a=!i.flyMode;this.ctx.canvas3d.setProps({trackball:{flyMode:a}}),!((n=this.ctx.canvas3dContext)===null||n===void 0)&&n.canvas&&(this.ctx.canvas3dContext.canvas.style.cursor=a?"crosshair":"unset")}Xe.matchKey(o.keyResetView,t,r,e)&&Re.Camera.Reset(this.ctx,{})})}},params:()=>p2e,display:{name:"Camera Controls on Canvas"}});var XL={};ua(XL,{AccessibleSurfaceArea:()=>XK,BestDatabaseSequenceMapping:()=>kZ,CrossLinkRestraint:()=>VZ,Interactions:()=>PZ,SecondaryStructure:()=>EZ,StructureInfo:()=>NK,ValenceModel:()=>IZ});var NK=rr.create({name:"structure-info-prop",category:"custom-props",display:{name:"Structure Info"},ctor:class extends rr.Handler{get maxModelIndex(){var t,e;let r=-1,n=this.ctx.state.data.select(lt.Generators.rootsOfType(X.Molecule.Model));for(let o of n){let i=((t=o.obj)===null||t===void 0?void 0:t.data)&&Et.Index.get((e=o.obj)===null||e===void 0?void 0:e.data).value;i!==void 0&&i>r&&(r=i)}return r}get maxStructureIndex(){var t,e;let r=-1,n=this.ctx.state.data.select(lt.Generators.rootsOfType(X.Molecule.Structure));for(let o of n){let i=((t=o.obj)===null||t===void 0?void 0:t.data)&&ue.Index.get((e=o.obj)===null||e===void 0?void 0:e.data).value;i!==void 0&&i>r&&(r=i)}return r}get asymIdOffset(){var t;let e=0,r=0,n=this.ctx.state.data.select(lt.Generators.rootsOfType(X.Molecule.Model));for(let o of n){let i=(t=o.obj)===null||t===void 0?void 0:t.data;if(i){let a=Et.AsymIdCount.get(i),s=Et.AsymIdOffset.get(i).value;a!==void 0&&s!==void 0&&(e=Math.max(e,s.auth+a.auth),r=Math.max(r,s.label+a.label))}}return{auth:e,label:r}}setModelMaxIndex(){var t;let e=this.maxModelIndex,r=this.ctx.state.data.select(lt.Generators.rootsOfType(X.Molecule.Model));for(let n of r){let o=(t=n.obj)===null||t===void 0?void 0:t.data;o&&Et.MaxIndex.get(o).value!==e&&Et.MaxIndex.set(o,{value:e},e)}}setStructureMaxIndex(){var t;let e=this.maxModelIndex,r=this.ctx.state.data.select(lt.Generators.rootsOfType(X.Molecule.Structure));for(let n of r){let o=(t=n.obj)===null||t===void 0?void 0:t.data;o&&ue.MaxIndex.get(o).value!==e&&ue.MaxIndex.set(o,{value:e},e)}}handleModel(t,e){if(Et.Index.get(t).value===void 0){let r=e&&Et.Index.get(e).value,n=r??this.maxModelIndex+1;Et.Index.set(t,{value:n},n)}if(Et.AsymIdOffset.get(t).value===void 0){let r=e&&Et.AsymIdOffset.get(e).value,n=r??w({},this.asymIdOffset);Et.AsymIdOffset.set(t,{value:n},n)}}handleStructure(t,e){if(t.parent!==void 0||ue.Index.get(t).value!==void 0)return;let r=e&&ue.Index.get(e).value,n=r??this.maxStructureIndex+1;ue.Index.set(t,{value:n},n)}handle(t,e,r){X.Molecule.Structure.is(e)?!this.ctx.state.data.tree.transforms.get(t).transformer.definition.isDecorator&&e.data.parent===void 0&&this.handleStructure(e.data,r?.data):X.Molecule.Model.is(e)&&(this.ctx.state.data.tree.transforms.get(t).transformer.definition.isDecorator||this.handleModel(e.data,r?.data))}register(){this.ctx.customModelProperties.register(Et.AsymIdOffset,!0),this.ctx.customModelProperties.register(Et.Index,!0),this.ctx.customModelProperties.register(Et.MaxIndex,!0),this.ctx.customStructureProperties.register(ue.Index,!0),this.ctx.customStructureProperties.register(ue.MaxIndex,!0),this.subscribeObservable(this.ctx.state.data.events.object.created,t=>{this.handle(t.ref,t.obj),this.setModelMaxIndex(),this.setStructureMaxIndex()}),this.subscribeObservable(this.ctx.state.data.events.object.updated,t=>{this.handle(t.ref,t.obj,t.oldObj)})}unregister(){this.ctx.customModelProperties.unregister(Et.AsymIdOffset.descriptor.name),this.ctx.customModelProperties.unregister(Et.Index.descriptor.name),this.ctx.customModelProperties.unregister(Et.MaxIndex.descriptor.name),this.ctx.customStructureProperties.unregister(ue.Index.descriptor.name),this.ctx.customStructureProperties.unregister(ue.MaxIndex.descriptor.name)}}});var Md=[-1,1.76,1.87,1.65,1.5,1.4,1.85,1.8,1.6,1.4],x_={ALA:121,ARG:265,ASN:187,ASP:187,CYS:148,GLU:214,GLN:214,GLY:97,HIS:216,ILE:195,LEU:191,LYS:230,MET:203,PHE:228,PRO:154,SER:143,THR:163,TRP:264,TYR:255,VAL:165},VK=121;function zK(t){let{key:e}=Ne.residue,{type_symbol:r,label_atom_id:n,label_comp_id:o}=Ne.atom,{structure:i,atomRadiusType:a,serialResidueIndex:s}=t,l=z.Location.create(i),c=0,u=0,d=-1;l.structure=i;for(let m=0,p=0,h=i.units.length;m<h;++m){let f=i.units[m],{elements:b}=f;l.unit=f,c=-1;for(let v=0,x=b.length;v<x;++v){let S=b[v],T=p+v;l.element=S,u=e(l),c!==u&&++d,c=u;let E=r(l),_=MT(E);if(rU(_)){a[T]=0,s[T]=-1;continue}let D=n(l),P=w0(f,S);if(P===2||!t.nonPolymer&&!eU(P)){a[T]=0,s[T]=-1;continue}let A=o(l);if(t.traceOnly&&(D!=="CA"&&D!=="BB"||!x_[A])){a[T]=0,s[T]=d;continue}Yo(P)?a[T]=g2e(D,E,A):P===5?a[T]=h2e(D,E,A):a[T]=uL(E),s[T]=d}p+=b.length}}function h2e(t,e,r){switch(e){case"O":return 5;case"S":return 6;case"N":return t==="NZ"?4:3;case"C":switch(t){case"C":case"CE1":case"CE2":case"CE3":case"CH2":case"CZ":case"CZ2":case"CZ3":return 1;case"CA":case"CB":case"CE":case"CG1":case"CG2":return 2;default:switch(r){case"PHE":case"TRP":case"TYR":case"HIS":case"ASP":case"ASN":return 1;case"PRO":case"LYS":case"ARG":case"MET":case"ILE":case"LEU":return 2;case"GLU":case"GLN":return t==="CD"?1:2}}}return uL(e)}function g2e(t,e,r){switch(e){case"C":return 7;case"N":return 8;case"P":return 9;case"O":return 5}return uL(e)}function uL(t){let e=ff(t),r=Md.indexOf(e);return r===-1&&(r=Md.length,Md[r]=e),r}var UK=5e3;function GK(t,e){return N(this,null,function*(){let{atomRadiusType:r}=e;for(let n=0;n<r.length;n+=UK)t.shouldUpdate&&(yield t.update({message:"Computing per residue surface accessibility...",current:n,max:r.length})),y2e(e,n,Math.min(n+UK,r.length))})}function y2e(t,e,r){let{structure:n,atomRadiusType:o,serialResidueIndex:i,area:a,spherePoints:s,scalingConstant:l,maxLookupRadius:c,probeSize:u}=t,{lookup3d:d,serialMapping:m,unitIndexMap:p,units:h}=n,{cumulativeUnitElementCount:f,elementIndices:b,unitIndices:v}=m;for(let x=e;x<r;++x){let S=Md[o[x]];if(S===Md[0])continue;let T=h[v[x]],E=b[x],_=T.conformation.x(E),D=T.conformation.y(E),P=T.conformation.z(E),{count:A,units:I,indices:k,squaredDistances:M}=d.find(_,D,P,c),R=u+S,B=u+R,F=[];for(let V=0;V<A;++V){let H=I[V],Q=f[p.get(H.id)]+k[V],L=b[Q],Y=Md[o[Q]];if(T===H&&E===L||Y===Md[0])continue;let j=u+Y;if(M[V]<(B+Y)*(B+Y)){let O=b[Q];F[F.length]=[M[V],(M[V]+R*R-j*j)/(2*R),H.conformation.x(O)-_,H.conformation.y(O)-D,H.conformation.z(O)-P]}}F.sort((V,H)=>V[0]-H[0]);let G=0;e:for(let V=0;V<s.length;++V){let[H,Q,L]=s[V];for(let Y=0;Y<F.length;++Y){let[,j,O,J,$]=F[Y];if(H*O+Q*J+L*$>j)continue e}++G}a[i[x]]+=l*G*R*R}}var dL={numberOfSpherePoints:g.Numeric(92,{min:12,max:360,step:1},{description:"Number of sphere points to sample per atom: 92 (original paper), 960 (BioJava), 3000 (EPPIC) - see Shrake A, Rupley JA: Environment and exposure to solvent of protein atoms. Lysozyme and insulin. J Mol Biol 1973."}),probeSize:g.Numeric(1.4,{min:.1,max:4,step:.01},{description:"Corresponds to the size of a water molecule: 1.4 (original paper), 1.5 (occassionally used)"}),nonPolymer:g.Boolean(!1,{description:"Include non-polymer atoms as occluders."}),traceOnly:g.Boolean(!1,{description:"Compute only using alpha-carbons, if true increase probeSize accordingly (e.g., 4 A). Considers only canonical amino acids."})};var ph;(function(t){function e(c,u={}){let d=w(w({},g.getDefaultValues(dL)),u);return ie.create("Compute Accessible Surface Area",m=>N(this,null,function*(){return yield r(m,c,d)}))}t.compute=e;function r(c,u,d){return N(this,null,function*(){let m=n(u,d);zK(m),yield GK(c,m);let{area:p,serialResidueIndex:h}=m;return{area:p,serialResidueIndex:h}})}function n(c,u){let{elementCount:d,atomicResidueCount:m}=c,{probeSize:p,nonPolymer:h,traceOnly:f,numberOfSpherePoints:b}=u;return{structure:c,probeSize:p,nonPolymer:h,traceOnly:f,spherePoints:o(b),scalingConstant:4*Math.PI/b,maxLookupRadius:2*u.probeSize+2*Md[2],atomRadiusType:new Int8Array(d),serialResidueIndex:new Int32Array(d),area:new Float32Array(m)}}function o(c){let u=[],d=Math.PI*(3-Math.sqrt(5)),m=2/c;for(let p=0;p<c;++p){let h=p*m-1+m/2,f=Math.sqrt(1-h*h),b=p*d;u[u.length]=y.create(Math.cos(b)*f,h,Math.sin(b)*f)}return u}t.Flag={NA:0,Buried:1,Accessible:2};function i(c,u){let d=x_[c]||VK;return u/d}t.normalize=i;function a(c,u){let{area:d,serialResidueIndex:m}=u,p=m[tr.indexOf(tr.ofSortedArray(c.structure.root.serialMapping.elementIndices),c.element)];return p===-1?-1:d[p]}t.getValue=a;function s(c,u){let d=a(c,u);return d===-1?-1:i(Ne.atom.label_comp_id(c),d)}t.getNormalizedValue=s;function l(c,u){let d=s(c,u);return d===-1?0:d<.16?1:2}t.getFlag=l})(ph||(ph={}));var mL=w({},dL),S_={isBuried:Tf.Dynamic(EA("computed","accessible-surface-area.is-buried",cd.Bool),t=>{if(!Pe.isAtomic(t.element.unit))return!1;let e=zl.get(t.element.structure).value;return e?ph.getFlag(t.element,e)===1:!1}),isAccessible:Tf.Dynamic(EA("computed","accessible-surface-area.is-accessible",cd.Bool),t=>{if(!Pe.isAtomic(t.element.unit))return!1;let e=zl.get(t.element.structure).value;return e?ph.getFlag(t.element,e)===2:!1})},zl=gf.createProvider({label:"Accessible Surface Area",descriptor:Xc({name:"molstar_accessible_surface_area",symbols:S_}),type:"root",defaultParams:mL,getParams:t=>mL,isApplicable:t=>!0,obtain:(t,e,r)=>N(void 0,null,function*(){let n=w(w({},g.getDefaultValues(mL)),r);return{value:yield ph.compute(e,n).runInContext(t.runtime)}})});var pL=ce(16448250),v2e="Assigns a color based on the relative accessible surface area of a residue.",jK={list:g.ColorList("rainbow",{presetKind:"scale"})};function b2e(t){return jK}function HK(t,e){let r,n=ki.create({listOrName:e.list.colors,minLabel:"buried",maxLabel:"exposed",domain:[0,1]}),o=t.structure&&zl.get(t.structure),i=o?f0(o.id,o.version):-1;if(o?.value&&t.structure){let a=z.Location.create(t.structure),s=o.value,l=c=>{let u=ph.getNormalizedValue(c,s);return u===-1?pL:n.color(u)};r=c=>z.Location.is(c)&&Pe.isAtomic(c.unit)?l(c):ze.isLocation(c)?(a.unit=c.aUnit,a.element=c.aUnit.elements[c.aIndex],l(a)):pL}else r=()=>pL;return{factory:HK,granularity:"group",preferSmoothing:!0,color:r,props:e,contextHash:i,description:v2e,legend:n?n.legend:void 0}}var fL={name:"accessible-surface-area",label:"Accessible Surface Area",category:wo.Category.Residue,factory:HK,getParams:b2e,defaultValues:g.getDefaultValues(jK),isApplicable:t=>!!t.structure,ensureCustomProperties:{attach:(t,e)=>e.structure?zl.attach(t,e.structure,void 0,!0):Promise.resolve(),detach:t=>t.structure&&zl.ref(t.structure,!1)}};var XK=rr.create({name:"computed-accessible-surface-area-prop",category:"custom-props",display:{name:"Accessible Surface Area"},ctor:class extends rr.Handler{constructor(){super(...arguments),this.provider=zl,this.labelProvider={label:t=>{if(this.params.showTooltip)return x2e(t)}}}update(t){let e=this.params.autoAttach!==t.autoAttach||this.params.showTooltip!==t.showTooltip;return this.params.autoAttach=t.autoAttach,this.params.showTooltip=t.showTooltip,this.ctx.customStructureProperties.setDefaultAutoAttach(this.provider.descriptor.name,this.params.autoAttach),e}register(){N0.addCustomProp(this.provider.descriptor),this.ctx.customStructureProperties.register(this.provider,this.params.autoAttach),this.ctx.representation.structure.themes.colorThemeRegistry.add(fL),this.ctx.managers.lociLabels.addProvider(this.labelProvider),this.ctx.query.structure.registry.add(qK),this.ctx.query.structure.registry.add(WK)}unregister(){N0.removeCustomProp(this.provider.descriptor),this.ctx.customStructureProperties.unregister(this.provider.descriptor.name),this.ctx.representation.structure.themes.colorThemeRegistry.remove(fL),this.ctx.managers.lociLabels.removeProvider(this.labelProvider),this.ctx.query.structure.registry.remove(qK),this.ctx.query.structure.registry.remove(WK)}},params:()=>({autoAttach:g.Boolean(!1),showTooltip:g.Boolean(!0)})});function x2e(t){if(t.kind==="element-loci"){if(t.elements.length===0)return;let e=zl.get(t.structure).value;if(!e||t.structure.customPropertyDescriptors.hasReference(zl.descriptor))return;let{getSerialIndex:r}=t.structure.root.serialMapping,{area:n,serialResidueIndex:o}=e,i=new Set,a=0;for(let{indices:l,unit:c}of t.elements){let{elements:u}=c;we.forEach(l,d=>{let m=o[r(c,u[d])];m!==-1&&!i.has(m)&&(a+=n[m],i.add(m))})}return i.size===0?void 0:`Accessible Surface Area ${`<small>(${i.size} ${i.size>1?"Residues sum":"Residue"})</small>`}: ${a.toFixed(2)} \u212B<sup>2</sup>`}else if(t.kind==="structure-loci"){let e=zl.get(t.structure).value;return!e||t.structure.customPropertyDescriptors.hasReference(zl.descriptor)?void 0:`Accessible Surface Area <small>(Whole Structure)</small>: ${Rz(e.area).toFixed(2)} \u212B<sup>2</sup>`}}var qK=Lr("Buried Protein Residues",q.struct.modifier.union([q.struct.modifier.wholeResidues([q.struct.modifier.union([q.struct.generator.atomGroups({"chain-test":q.core.rel.eq([q.ammp("objectPrimitive"),"atomistic"]),"residue-test":S_.isBuried.symbol()})])])]),{description:"Select buried protein residues.",category:Ur.Residue,ensureCustomProperties:(t,e)=>zl.attach(t,e)}),WK=Lr("Accessible Protein Residues",q.struct.modifier.union([q.struct.modifier.wholeResidues([q.struct.modifier.union([q.struct.generator.atomGroups({"chain-test":q.core.rel.eq([q.ammp("objectPrimitive"),"atomistic"]),"residue-test":S_.isAccessible.symbol()})])])]),{description:"Select accessible protein residues.",category:Ur.Residue,ensureCustomProperties:(t,e)=>zl.attach(t,e)});function lr(t,e){return t.model.atomicHierarchy.atoms.type_symbol.value(t.elements[e])}function C_(t,e){return t.model.atomicHierarchy.atoms.pdbx_formal_charge.value(t.elements[e])}function fh(t,e){return t.model.atomicHierarchy.atoms.label_atom_id.value(t.elements[e])}function nS(t,e){return t.model.atomicHierarchy.atoms.label_alt_id.value(t.elements[e])}function oS(t,e){return t.model.atomicHierarchy.atoms.label_comp_id.value(t.elements[e])}function S2e(t,e,r){let n=0,o=t.interUnitBonds.getEdgeIndices(r,e.id);for(let i=0,a=o.length;i<a;++i){let s=t.interUnitBonds.edges[o[i]];Pr.isCovalent(s.props.flag)&&(n+=1)}return n}function C2e(t,e){let r=0,{offset:n,edgeProps:{flags:o}}=t.bonds;for(let i=n[e],a=n[e+1];i<a;++i)Pr.isCovalent(o[i])&&(r+=1);return r}function Ul(t,e,r){return S2e(t,e,r)+C2e(e,r)}function Na(t,e,r,n){let o=0;return Si(t,e,r,(i,a)=>{lr(i,a)===n&&(o+=1)}),o}function T2e(t,e,r){let{offset:n,b:o,edgeProps:{flags:i}}=t.bonds;Pr.is;for(let a=n[e],s=n[e+1];a<s;++a)if(o[a]===r&&Pr.isCovalent(i[a]))return!0;return!1}function w2e(t,e,r,n,o){let i=t.interUnitBonds.getEdge(r,e.id,o,n.id);return i&&Pr.isCovalent(i.props.flag)}function YK(t,e,r,n,o){return e===n?T2e(e,r,o):w2e(t,e,r,n,o)}function _2e(t,e,r,n){let o=t.interUnitBonds.getEdgeIndices(r,e.id);for(let i=0,a=o.length;i<a;++i){let s=t.interUnitBonds.edges[o[i]],l=t.unitMap.get(s.unitB);Pr.isCovalent(s.props.flag)&&n(l,s.indexB)}}function T_(t,e,r){let{offset:n,b:o,edgeProps:{flags:i}}=t.bonds;for(let a=n[e],s=n[e+1];a<s;++a)Pr.isCovalent(i[a])&&r(t,o[a])}function Si(t,e,r,n){_2e(t,e,r,n),T_(e,r,n)}var Un=function(t){return t[t.Spherical=0]="Spherical",t[t.Terminal=1]="Terminal",t[t.Linear=2]="Linear",t[t.Trigonal=3]="Trigonal",t[t.Tetrahedral=4]="Tetrahedral",t[t.TrigonalBiPyramidal=5]="TrigonalBiPyramidal",t[t.Octahedral=6]="Octahedral",t[t.SquarePlanar=7]="SquarePlanar",t[t.Unknown=8]="Unknown",t}(Un||{});function QK(t){switch(t){case Un.Spherical:return"Spherical";case Un.Terminal:return"Terminal";case Un.Linear:return"Linear";case Un.Trigonal:return"Trigonal";case Un.Tetrahedral:return"Tetrahedral";case Un.TrigonalBiPyramidal:return"Trigonal Bi-Pyramidal";case Un.Octahedral:return"Octahedral";case Un.SquarePlanar:return"Square Planar";case Un.Unknown:return"Unknown"}}function uy(t){switch(t){case 0:return Un.Spherical;case 1:return Un.Terminal;case 2:return Un.Linear;case 3:return Un.Trigonal;case 4:return Un.Tetrahedral;default:return Un.Unknown}}var hL=new Map([[Un.Linear,or(180)],[Un.Trigonal,or(120)],[Un.Tetrahedral,or(109.4721)],[Un.Octahedral,or(90)]]),w_=y(),__=y(),cy=y(),P_=y(),Fv=y();function Nv(t,e,r,n,o){let i=[];return e.conformation.position(e.elements[r],cy),n.conformation.position(n.elements[o],P_),y.sub(w_,P_,cy),Si(t,e,r,(a,s)=>{lr(a,s)!=="H"&&(a.conformation.position(a.elements[s],Fv),y.sub(__,Fv,cy),i.push(y.angle(w_,__)))}),i}function gL(t,e,r,n,o){e.conformation.position(e.elements[r],cy),n.conformation.position(n.elements[o],P_),y.sub(w_,P_,cy);let i=[y(),y()],a=0,s,l;if(Si(t,e,r,(c,u)=>{a>1||lr(c,u)!=="H"&&(s=c,l=u,c.conformation.position(c.elements[u],Fv),y.sub(i[a++],Fv,cy))}),a===1&&s&&l&&Si(t,s,l,(c,u)=>{a>1||c===e&&u===r||lr(c,u)!=="H"&&(c.conformation.position(c.elements[u],Fv),y.sub(i[a++],Fv,cy))}),a===2)return y.cross(__,i[0],i[1]),Math.abs(Math.PI/2-y.angle(__,w_))}var yL=new ze.ElementBondIterator,vL=new ze.ElementBondIterator;function P2e(t,e,r){let n=lr(e,r),o=n==="O"||n==="N";if(o&&Ul(t,e,r)===4)return!1;for(yL.setElement(t,e,r);yL.hasNext;){let i=yL.move();if(i.order>1)return!0;if(o){let a=lr(i.otherUnit,i.otherIndex);for(vL.setElement(t,i.otherUnit,i.otherIndex);vL.hasNext;){let s=vL.move();if(s.order>1){if((a==="P"||a==="S")&&lr(s.otherUnit,s.otherIndex)==="O")continue;return!0}}}}return!1}function E2e(t,e,r){let n=0,{offset:o,edgeProps:{flags:i,order:a}}=e.bonds;for(let s=o[r],l=o[r+1];s<l;++s)Pr.isCovalent(i[s])&&(n+=a[s]);return t.interUnitBonds.getEdgeIndices(r,e.id).forEach(s=>{let l=t.interUnitBonds.edges[s];Pr.isCovalent(l.props.flag)&&(n+=l.props.order)}),n}var Vv=new ze.ElementBondIterator,bL=new ze.ElementBondIterator;function I2e(t,e,r,n){let o=Na(t,e,r,"H"),i=lr(e,r),a=C_(e,r),s=n.assignCharge==="always"||n.assignCharge==="auto"&&a===0,l=n.assignH==="always"||n.assignH==="auto"&&o===0,c=Ul(t,e,r),u=E2e(t,e,r),d=P2e(t,e,r),m=u-c>0,p=0,h=Un.Unknown;switch(i){case"H":s&&(c===0?(a=1,h=Un.Spherical):c===1&&(a=0,h=Un.Terminal));break;case"C":s&&(a=0),l&&(p=Math.max(0,4-u-Math.abs(a))),h=uy(c+p+Math.max(0,-a));break;case"N":if(s)if(!l)a=u-3;else if(d&&u<4)c-o===1&&u-o===2?a=1:a=0;else for(Vv.setElement(t,e,r);Vv.hasNext;){let f=Vv.move(),b=lr(f.otherUnit,f.otherIndex);if(b==="S"||YX(b)){a=0;break}else a=1}l&&(p=Math.max(0,3-u+a)),d&&!m?h=uy(c+p-a):h=uy(c+p+1-a);break;case"O":if(s&&(l||(a=u-2),u===1)){Vv.setElement(t,e,r);e:for(;Vv.hasNext;){let f=Vv.move();for(bL.setElement(t,f.otherUnit,f.otherIndex);bL.hasNext;){let b=bL.move();if(!(b.otherUnit===e&&b.otherIndex===r)&&lr(b.otherUnit,b.otherIndex)==="O"&&b.order===2){a=-1;break e}}}}l&&(p=Math.max(0,2-u+a)),d&&!m?h=uy(c+p-a+1):h=uy(c+p-a+2);break;case"S":s&&(l||(u<=3&&Na(t,e,r,"O")===0?a=u-2:a=0)),l&&u<2&&(p=Math.max(0,2-u+a)),u<=3&&(h=uy(c+p-a+2));break;case"F":case"CL":case"BR":case"I":case"AT":s&&(a=u-1);break;case"LI":case"NA":case"K":case"RB":case"CS":case"FR":s&&(a=1-u);break;case"BE":case"MG":case"CA":case"SR":case"BA":case"RA":s&&(a=2-u);break;default:ht&&console.warn("Requested charge, protonation for an unhandled element",i)}return[a,p,p+o,h]}function D2e(t,e,r){let n=e.elements.length,o=new Int8Array(n),i=new Int8Array(n),a=new Int8Array(n),s=new Int8Array(n),l=!!t.parent,c;if(l){let u=t.root.unitMap.get(e.id);if(c=tr.indicesOf(u.elements,e.elements),c.length!==e.elements.length)throw new Error("expected to find an index for every element");e=u,t=t.root}for(let u=0;u<n;++u){let d=l?c[u]:u,[m,p,h,f]=I2e(t,e,d,r);o[u]=m,i[u]=p,a[u]=h,s[u]=f}return{charge:o,implicitH:i,totalH:a,idealGeometry:s}}var xL={assignCharge:g.Select("auto",[["always","always"],["auto","auto"],["never","never"]]),assignH:g.Select("auto",[["always","always"],["auto","auto"],["never","never"]])};function KK(t,e,r){return N(this,null,function*(){let n=w(w({},g.getDefaultValues(xL)),r),o=new Map;for(let i=0,a=e.units.length;i<a;++i){let s=e.units[i];if(Pe.isAtomic(s)){let l=D2e(e,s,n);o.set(s.id,l)}}return o})}var SL=w({},xL),wm=gf.createProvider({label:"Valence Model",descriptor:Xc({name:"molstar_computed_valence_model"}),type:"local",defaultParams:SL,getParams:t=>SL,isApplicable:t=>!0,obtain:(t,e,r)=>N(void 0,null,function*(){let n=w(w({},g.getDefaultValues(SL)),r);return{value:yield KK(t.runtime,e,n)}})});var tn;(function(t){function e(d,m,p,h){return y.set(d,h.x[p],h.y[p],h.z[p]),y.transformMat4(d,d,m.conformation.operator.matrix),d}t.setPosition=e;function r(d,m){let p=new Int32Array(m+1),h=new Int32Array(m),f=new Int32Array(m),{members:b,count:v,offsets:x}=d;for(let E=0,_=x[v];E<_;++E)++f[b[E]];let S=0;for(let E=0;E<m;E++)p[E]=S,S+=f[E];p[m]=S;let T=new Int32Array(S);for(let E=0;E<v;++E)for(let _=x[E],D=x[E+1];_<D;++_){let P=b[_],A=p[P]+h[P];T[A]=E,++h[P]}return{indices:T,offsets:p}}t.createElementsIndex=r;function n(d,m){let p,h;return U(w({},m),{get lookup3d(){if(!p){let f={x:m.x,y:m.y,z:m.z,indices:we.ofBounds(0,m.count)};p=pf(f,_0(f))}return p},get elementsIndex(){return h||(h=r(m,d))},subset:f=>o(m,f)})}t.create=n;function o(d,m){let p,{count:h,types:f}=d,b=[];for(let x=0;x<h;++x)m.has(f[x])&&b.push(x);let v=tr.ofSortedArray(b);return{indices:v,get lookup3d(){if(!p){let x={x:d.x,y:d.y,z:d.z,indices:v};p=pf(x,_0(x))}return p}}}t.createSubset=o;function i(d,m,p){let h=wm.get(d).value;if(!h||!h.has(m.id))throw new Error("valence model required");return{unit:m,types:p.types,feature:-1,x:p.x,y:p.y,z:p.z,members:p.members,offsets:p.offsets,idealGeometry:h.get(m.id).idealGeometry}}t.Info=i;function a(d,m){return y.set(d,m.x[m.feature],m.y[m.feature],m.z[m.feature]),y.transformMat4(d,d,m.unit.conformation.operator.matrix),d}t.position=a;let s=y(),l=y();function c(d,m){let p=d.members[d.offsets[d.feature]],h=m.members[m.offsets[m.feature]];return d.unit.conformation.position(d.unit.elements[p],s),m.unit.conformation.position(m.unit.elements[h],l),y.distance(s,l)}t.distance=c;function u(d,m){return{types:new Set(d),add:m}}t.Provider=u})(tn||(tn={}));var E_;(function(t){function e(r=2048,n=1024,o){let i=he.create(Float32Array,1,n,o?o.x:r),a=he.create(Float32Array,1,n,o?o.y:r),s=he.create(Float32Array,1,n,o?o.z:r),l=he.create(Uint8Array,1,n,o?o.types:r),c=he.create(Uint8Array,1,n,o?o.groups:r),u=he.create(Uint32Array,1,n,o?o.offsets:r),d=he.create(Uint32Array,1,n,o?o.members:r),m={x:0,y:0,z:0,offset:0,count:0};return{startState:()=>{m.x=0,m.y=0,m.z=0,m.offset=d.elementCount,m.count=0},pushMember:(p,h,f,b)=>{he.add(d,b),m.x+=p,m.y+=h,m.z+=f,m.count+=1},finishState:(p,h)=>{let{count:f}=m;f!==0&&(he.add(l,p),he.add(c,h),he.add(i,m.x/f),he.add(a,m.y/f),he.add(s,m.z/f),he.add(u,m.offset))},add:(p,h,f,b,v,x)=>{he.add(l,p),he.add(c,h),he.add(i,f),he.add(a,b),he.add(s,v),he.add(u,d.elementCount),he.add(d,x)},getFeatures:p=>{he.add(u,d.elementCount);let h=he.compact(i,!0),f=he.compact(a,!0),b=he.compact(s,!0),v=i.elementCount;return tn.create(p,{x:h,y:f,z:b,count:v,types:he.compact(l,!0),groups:he.compact(c,!0),offsets:he.compact(u,!0),members:he.compact(d,!0)})}}}t.create=e})(E_||(E_={}));var I_;(function(t){function e(r,n,o){let i=new Int32Array(o+1),a=new Int32Array(o),s=new Int32Array(o),{members:l,offsets:c}=n;for(let m=0,p=r.edgeCount*2;m<p;++m){let h=r.a[m],f=r.b[m];if(!(h>f)){for(let b=c[h],v=c[h+1];b<v;++b)++s[l[b]];for(let b=c[f],v=c[f+1];b<v;++b)++s[l[b]]}}let u=0;for(let m=0;m<o;m++)i[m]=u,u+=s[m];i[o]=u;let d=new Int32Array(u);for(let m=0,p=r.edgeCount*2;m<p;++m){let h=r.a[m],f=r.b[m];if(!(h>f)){for(let b=c[h],v=c[h+1];b<v;++b){let x=l[b],S=i[x]+a[x];d[S]=m,++a[x]}for(let b=c[f],v=c[f+1];b<v;++b){let x=l[b],S=i[x]+a[x];d[S]=m,++a[x]}}}return{indices:d,offsets:i}}t.createElementsIndex=e})(I_||(I_={}));var D_=class extends kT{getContactIndicesForElement(e,r){return this.elementKeyIndex.get(this.getElementKey(e,r.id))||[]}getElementKey(e,r){return`${e}|${r}`}constructor(e,r){super(e),this.elementKeyIndex=new Map;for(let n=0,o=this.edges.length;n<o;++n){let{unitA:i,indexA:a}=this.edges[n],{offsets:s,members:l}=r.get(i);for(let c=s[a],u=s[a+1];c<u;++c){let d=this.getElementKey(l[c],i),m=this.elementKeyIndex.get(d);m===void 0?this.elementKeyIndex.set(d,[n]):m.push(n)}}}},Gl=function(t){return t[t.None=0]="None",t[t.Filtered=1]="Filtered",t}(Gl||{}),$t=function(t){return t[t.Unknown=0]="Unknown",t[t.Ionic=1]="Ionic",t[t.CationPi=2]="CationPi",t[t.PiStacking=3]="PiStacking",t[t.HydrogenBond=4]="HydrogenBond",t[t.HalogenBond=5]="HalogenBond",t[t.Hydrophobic=6]="Hydrophobic",t[t.MetalCoordination=7]="MetalCoordination",t[t.WeakHydrogenBond=8]="WeakHydrogenBond",t}($t||{});function CL(t){switch(t){case $t.HydrogenBond:return"Hydrogen Bond";case $t.Hydrophobic:return"Hydrophobic Contact";case $t.HalogenBond:return"Halogen Bond";case $t.Ionic:return"Ionic Interaction";case $t.MetalCoordination:return"Metal Coordination";case $t.CationPi:return"Cation-Pi Interaction";case $t.PiStacking:return"Pi Stacking";case $t.WeakHydrogenBond:return"Weak Hydrogen Bond";case $t.Unknown:return"Unknown Interaction"}}function $K(t){switch(t){case 0:return"None";case 1:return"Positive Charge";case 2:return"Negative Charge";case 3:return"Aromatic Ring";case 4:return"Hydrogen Donor";case 5:return"Hydrogen Acceptor";case 6:return"Halogen Donor";case 7:return"Halogen Acceptor";case 8:return"HydrophobicAtom";case 9:return"Weak Hydrogen Donor";case 10:return"Ionic Type Partner";case 11:return"Dative Bond Partner";case 12:return"Transition Metal";case 13:return"Ionic Type Metal"}}var Br=function(t){return t[t.None=0]="None",t[t.QuaternaryAmine=1]="QuaternaryAmine",t[t.TertiaryAmine=2]="TertiaryAmine",t[t.Sulfonium=3]="Sulfonium",t[t.SulfonicAcid=4]="SulfonicAcid",t[t.Sulfate=5]="Sulfate",t[t.Phosphate=6]="Phosphate",t[t.Halocarbon=7]="Halocarbon",t[t.Guanidine=8]="Guanidine",t[t.Acetamidine=9]="Acetamidine",t[t.Carboxylate=10]="Carboxylate",t}(Br||{});function ZK(t){switch(t){case Br.None:return"None";case Br.QuaternaryAmine:return"Quaternary Amine";case Br.TertiaryAmine:return"Tertiary Amine";case Br.Sulfonium:return"Sulfonium";case Br.SulfonicAcid:return"Sulfonic Acid";case Br.Sulfate:return"Sulfate";case Br.Phosphate:return"Phosphate";case Br.Halocarbon:return"Halocarbon";case Br.Guanidine:return"Guanidine";case Br.Acetamidine:return"Acetamidine";case Br.Carboxylate:return"Carboxylate"}}var A_;(function(t){function e(r,n){let o=[],i=[],a=[];return{add(s,l,c){o[o.length]=s,i[i.length]=l,a[a.length]=c},getContacts(){let s=new _g.EdgeBuilder(r.count,o,i),l=new Int8Array(s.slotCount),c=new Int8Array(s.slotCount);for(let p=0,h=s.edgeCount;p<h;p++)s.addNextEdge(),s.assignProperty(l,a[p]);let u=s.createGraph({type:l,flag:c}),d;return Object.defineProperty(u,"elementsIndex",{get:()=>d||(d=I_.createElementsIndex(u,r,n))})}}}t.create=e})(A_||(A_={}));var k_;(function(t){function e(){let r=new kT.Builder;return{startUnitPair(n,o){r.startUnitPair(n.id,o.id)},finishUnitPair(){r.finishUnitPair()},add(n,o,i){r.add(n,o,{type:i,flag:Gl.None})},getContacts(n){return new D_(r.getMap(),n)}}}t.create=e})(k_||(k_={}));var t$={lineOfSightDistFactor:g.Numeric(1,{min:0,max:3,step:.1})},A2e=3;function r$(t,e,r){let n=e.members[e.offsets[e.feature]],o=r.members[r.offsets[r.feature]];if(n===o&&e.unit===r.unit)return!1;let i=nS(e.unit,n),a=nS(r.unit,o);return!(i&&a&&i!==a||e.unit===r.unit&&e.unit.model.atomicHierarchy.residueAtomSegments.count>1&&e.unit.residueIndex[e.unit.elements[n]]===r.unit.residueIndex[r.unit.elements[o]]||YK(t,e.unit,n,r.unit,o))}function JK(t,e,r,n){let o=nS(t,e),i=nS(r,n);return o&&i&&o!==i}function e$(t,e){let{feature:r,offsets:n,members:o}=e;for(let i=n[r],a=n[r+1];i<a;++i)if(o[i]===t)return!0;return!1}var hh=y(),TL=y(),wL=y(),k2e=cU();function n$(t,e,r,n){let o=e.feature,i=r.feature,a=e.members[e.offsets[o]],s=r.members[r.offsets[i]];tn.position(TL,e),tn.position(wL,r),y.scale(hh,y.add(hh,TL,wL),.5);let l=n*A2e,{count:c,indices:u,units:d,squaredDistances:m}=t.lookup3d.find(hh[0],hh[1],hh[2],l,k2e);if(c===0)return!0;for(let p=0;p<c;++p){let h=u[p],f=d[p];if(!Pe.isAtomic(f))continue;let b=lr(f,h);if(b==="H")continue;let v=ff(b);if(!(v*v*n*n<=m[p])&&!(JK(f,h,e.unit,a)||JK(f,h,r.unit,s))&&!(e.unit===f&&e$(h,e)||r.unit===f&&e$(h,r))&&(f.conformation.position(f.elements[h],hh),!(y.squaredDistance(hh,TL)<1||y.squaredDistance(hh,wL)<1)))return!1}return!0}function o$(t,e,r,n,o,i){for(let a of o)M2e(t,e,r,n,a,i)}function M2e(t,e,r,n,o,i){let{x:a,y:s,z:l}=r,{lookup3d:c,indices:u}=r.subset(o.requiredFeatures),d=tn.Info(t,e,r),m=w({},d),p=i.lineOfSightDistFactor;for(let h=0,f=we.size(u);h<f;++h){let b=we.getAt(u,h),{count:v,indices:x,squaredDistances:S}=c.find(a[b],s[b],l[b],o.maxDistance);if(v!==0){d.feature=b;for(let T=0;T<v;++T){let E=we.getAt(u,x[T]);if(E<=b||(m.feature=E,!r$(t,d,m)))continue;let _=o.getType(t,d,m,S[T]);_&&n$(t,d,m,p)&&n.add(b,E,_)}}}}var R2e=W();function i$(t,e,r,n,o,i,a,s){let{count:l,x:c,y:u,z:d}=r,{lookup3d:m}=o,p=W.mul(R2e,n.conformation.operator.inverse,e.conformation.operator.matrix),h=!W.isIdentity(p),f=y(),b=Math.max(...a.map(D=>D.maxDistance)),{center:v,radius:x}=m.boundary.sphere,S=(x+b)*(x+b),T=s.lineOfSightDistFactor,E=tn.Info(t,e,r),_=tn.Info(t,n,o);i.startUnitPair(e,n);for(let D=0;D<l;++D){if(y.set(f,c[D],u[D],d[D]),h&&y.transformMat4(f,f,p),y.squaredDistance(f,v)>S)continue;let{indices:P,count:A,squaredDistances:I}=m.find(f[0],f[1],f[2],b);if(A!==0){E.feature=D;for(let k=0;k<A;++k){let M=P[k];if(_.feature=M,!r$(t,E,_))continue;let R=I[k];for(let B of a)if(R<B.maxDistance*B.maxDistance){let F=B.getType(t,E,_,R);if(F&&n$(t,E,_,T)){i.add(D,M,F);break}}}}}i.finishUnitPair()}var L2e={distanceMax:g.Numeric(4,{min:1,max:5,step:.1}),angleMax:g.Numeric(30,{min:0,max:60,step:1})},B2e=["CL","BR","I","AT"];function O2e(t,e,r){let{elements:n}=e,{x:o,y:i,z:a}=e.model.atomicConformation;for(let s=0,l=n.length;s<l;++s){let c=lr(e,s);B2e.includes(c)&&r.add(6,Br.None,o[n[s]],i[n[s]],a[n[s]],s)}}var F2e=["N","O","S"],N2e=["C","N","P","S"];function V2e(t,e,r){let{elements:n}=e,{x:o,y:i,z:a}=e.model.atomicConformation;for(let s=0,l=n.length;s<l;++s){let c=lr(e,s);if(F2e.includes(c)){let u=!1;Si(t,e,s,(d,m)=>{N2e.includes(lr(d,m))&&(u=!0)}),u&&r.add(7,Br.None,o[n[s]],i[n[s]],a[n[s]],s)}}}function z2e(t,e){return t===7&&e===6||t===6&&e===7}var U2e=or(180),G2e=or(120);function j2e(t){return{angleMax:or(t.angleMax)}}function H2e(t,e,r,n){let o=e.types[e.feature],i=r.types[r.feature];if(!z2e(o,i))return;let[a,s]=o===6?[e,r]:[r,e],l=a.members[a.offsets[a.feature]],c=s.members[s.offsets[s.feature]],u=Nv(t,a.unit,l,s.unit,c);if(u.length!==1||U2e-u[0]>n.angleMax)return;let d=Nv(t,s.unit,c,a.unit,l);if(d.length!==0&&!d.some(m=>G2e-m>n.angleMax))return $t.HalogenBond}var a$=tn.Provider([6],O2e),s$=tn.Provider([7],V2e),l$={name:"halogen-bonds",params:L2e,createTester:t=>{let e=j2e(t);return{maxDistance:t.distanceMax,requiredFeatures:new Set([6,7]),getType:(r,n,o)=>H2e(r,n,o,e)}}};var m$={distanceMax:g.Numeric(3.5,{min:1,max:5,step:.1}),backbone:g.Boolean(!0,{description:"Include backbone-to-backbone hydrogen bonds"}),accAngleDevMax:g.Numeric(45,{min:0,max:180,step:1},{description:"Max deviation from ideal acceptor angle"}),donAngleDevMax:g.Numeric(45,{min:0,max:180,step:1},{description:"Max deviation from ideal donor angle"}),accOutOfPlaneAngleMax:g.Numeric(90,{min:0,max:180,step:1}),donOutOfPlaneAngleMax:g.Numeric(45,{min:0,max:180,step:1})},q2e=U(w({},m$),{water:g.Boolean(!1,{description:"Include water-to-water hydrogen bonds"}),sulfurDistanceMax:g.Numeric(4.1,{min:1,max:5,step:.1})}),W2e=w({},m$);function _L(t,e){let r=wm.get(t).value;if(!r)throw Error("expected valence model to be available");let n=r.get(e.id);if(!n)throw Error("expected valence model for unit to be available");return n}function X2e(t,e,r){let{totalH:n}=_L(t,e),{elements:o}=e,{x:i,y:a,z:s}=e.model.atomicConformation;for(let l=0,c=o.length;l<c;++l){let u=lr(e,l);(p$(e,l)||n[l]>0&&(u==="N"||u==="O"||u==="S"))&&r.add(4,Br.None,i[o[l]],a[o[l]],s[o[l]],l)}}function Y2e(t,e,r){let{totalH:n}=_L(t,e),{elements:o}=e,{x:i,y:a,z:s}=e.model.atomicConformation;for(let l=0,c=o.length;l<c;++l)lr(e,l)==="C"&&n[l]>0&&(Na(t,e,l,"N")>0||Na(t,e,l,"O")>0||Q2e(e,l))&&r.add(9,Br.None,i[o[l]],a[o[l]],s[o[l]],l)}function Q2e(t,e){let{elementAromaticRingIndices:r,all:n}=t.rings,o=r.get(e);if(o===void 0)return!1;for(let i=0,a=o.length;i<a;++i){let s=n[o[i]];for(let l=0,c=s.length;l<c;++l){let u=lr(t,s[l]);if(u==="N"||u==="O")return!0}}return!1}function K2e(t,e,r){let{charge:n,implicitH:o,idealGeometry:i}=_L(t,e),{elements:a}=e,{x:s,y:l,z:c}=e.model.atomicConformation,u=d=>{r.add(5,Br.None,s[a[d]],l[a[d]],c[a[d]],d)};for(let d=0,m=a.length;d<m;++d){let p=lr(e,d);if(p==="O")u(d);else if(p==="N"){if(p$(e,d))u(d);else if(n[d]<1){let h=Ul(t,e,d)+o[d],f=i[d];(f===Un.Tetrahedral&&h<4||f===Un.Trigonal&&h<3||f===Un.Linear&&h<2)&&u(d)}}else if(p==="S"){let h=oS(e,d);(h==="CYS"||h==="MET"||C_(e,d)===-1)&&u(d)}}}function c$(t,e){return t.model.atomicHierarchy.derived.residue.moleculeType[t.residueIndex[t.elements[e]]]===2}function u$(t,e){return ac.has(fh(t,e))}function $2e(t,e){return t.rings.elementRingIndices.has(e)}function p$(t,e){return oS(t,e)==="HIS"&&lr(t,e)==="N"&&$2e(t,e)}function Z2e(t,e,r,n){return u$(t,e)&&u$(r,n)}function J2e(t,e,r,n){return c$(t,e)&&c$(r,n)}function ewe(t,e){return t===5&&e===4||t===4&&e===5}function twe(t,e){return t===9&&e===5||t===5&&e===9}function f$(t){return{includeBackbone:t.backbone,maxAccAngleDev:or(t.accAngleDevMax),maxDonAngleDev:or(t.donAngleDevMax),maxAccOutOfPlaneAngle:or(t.accOutOfPlaneAngleMax),maxDonOutOfPlaneAngle:or(t.donOutOfPlaneAngleMax)}}function rwe(t){return U(w({},f$(t)),{includeWater:t.water,maxSulfurDistSq:t.sulfurDistanceMax*t.sulfurDistanceMax,maxDistSq:t.distanceMax*t.distanceMax})}var d$=or(120);function h$(t,e,r,n){let o=e.members[e.offsets[e.feature]],i=r.members[r.offsets[r.feature]];if(!n.includeBackbone&&Z2e(e.unit,o,r.unit,i))return;let a=Nv(t,e.unit,o,r.unit,i),s=hL.get(e.idealGeometry[o])||d$;if(a.some(u=>Math.abs(s-u)>n.maxDonAngleDev))return;if(e.idealGeometry[o]===Un.Trigonal){let u=gL(t,e.unit,o,r.unit,i);if(u!==void 0&&u>n.maxDonOutOfPlaneAngle)return}let l=Nv(t,r.unit,i,e.unit,o),c=hL.get(r.idealGeometry[i])||d$;if(!l.some(u=>c-u>n.maxAccAngleDev)){if(r.idealGeometry[i]===Un.Trigonal){let u=gL(t,r.unit,i,e.unit,o);if(u!==void 0&&u>n.maxAccOutOfPlaneAngle)return}return!0}}function nwe(t,e,r,n,o){let i=e.types[e.feature],a=r.types[r.feature];if(!ewe(i,a))return;let[s,l]=a===5?[e,r]:[r,e],c=s.members[s.offsets[s.feature]],u=l.members[l.offsets[l.feature]],d=lr(s.unit,c)==="S"||lr(l.unit,u)==="S"?o.maxSulfurDistSq:o.maxDistSq;if(!(n>d)&&!(!o.includeWater&&J2e(s.unit,c,l.unit,u))&&h$(t,s,l,o))return $t.HydrogenBond}function owe(t,e,r,n,o){let i=e.types[e.feature],a=r.types[r.feature];if(!twe(i,a))return;let[s,l]=a===5?[e,r]:[r,e];if(h$(t,s,l,o))return $t.WeakHydrogenBond}var g$=tn.Provider([4],X2e),y$=tn.Provider([9],Y2e),v$=tn.Provider([5],K2e),b$={name:"hydrogen-bonds",params:q2e,createTester:t=>{let e=Math.max(t.distanceMax,t.sulfurDistanceMax),r=rwe(t);return{maxDistance:e,requiredFeatures:new Set([4,5]),getType:(n,o,i,a)=>nwe(n,o,i,a,r)}}},x$={name:"weak-hydrogen-bonds",params:W2e,createTester:t=>{let e=f$(t);return{maxDistance:t.distanceMax,requiredFeatures:new Set([9,5]),getType:(r,n,o,i)=>owe(r,n,o,i,e)}}};function S$(t,e,r){return lr(e,r)==="S"&&Na(t,e,r,"O")===3}function C$(t,e,r){return lr(e,r)==="S"&&Na(t,e,r,"O")===4}function PL(t,e,r){return lr(e,r)==="P"&&Na(t,e,r,"O")===Ul(t,e,r)}function T$(t,e,r){let n=0;return lr(e,r)==="C"&&Na(t,e,r,"O")===2&&Na(t,e,r,"C")===1&&Si(t,e,r,(o,i)=>{lr(o,i)==="O"&&Ul(t,o,i)-Na(t,o,i,"H")===1&&(n+=1)}),n===2}function w$(t,e,r){let n=0;return lr(e,r)==="C"&&Ul(t,e,r)===3&&Na(t,e,r,"N")===3&&Si(t,e,r,(o,i)=>{Ul(t,o,i)-Na(t,o,i,"H")===1&&(n+=1)}),n===2}function _$(t,e,r){let n=0;return lr(e,r)==="C"&&Ul(t,e,r)===3&&Na(t,e,r,"N")===2&&Na(t,e,r,"C")===1&&Si(t,e,r,(o,i)=>{Ul(t,o,i)-Na(t,o,i,"H")===1&&(n+=1)}),n===2}var iwe=new Set(["N","O","S","F","CL","BR","I"]);function awe(t){return iwe.has(t)}function P$(t,e,r){let n=!1;return Si(t,e,r,(o,i)=>{awe(lr(o,i))&&(n=!0)}),n}var swe={distanceMax:g.Numeric(5,{min:0,max:8,step:.1})},lwe={distanceMax:g.Numeric(5.5,{min:1,max:8,step:.1}),offsetMax:g.Numeric(2,{min:0,max:4,step:.1}),angleDevMax:g.Numeric(30,{min:0,max:180,step:1})},cwe={distanceMax:g.Numeric(6,{min:1,max:8,step:.1}),offsetMax:g.Numeric(2,{min:0,max:4,step:.1})},uwe=["ARG","HIS","LYS"],dwe=["GLU","ASP"];function A$(t,e){let r=wm.get(t).value;if(!r)throw Error("expected valence model to be available");let n=r.get(e.id);if(!n)throw Error("expected valence model for unit to be available");return n}function mwe(t,e,r){let{charge:n}=A$(t,e),{elements:o}=e,{x:i,y:a,z:s}=e.model.atomicConformation,l=new Set,{label_comp_id:c}=e.model.atomicHierarchy.atoms,u=$r.transientSegments(e.model.atomicHierarchy.residueAtomSegments,o);for(;u.hasNext;){let{index:d,start:m,end:p}=u.move(),h=c.value(e.model.atomicHierarchy.residueAtomSegments.offsets[d]);if(uwe.includes(h)){r.startState();for(let f=m;f<p;++f)lr(e,f)==="N"&&!ac.has(fh(e,f))&&r.pushMember(i[o[f]],a[o[f]],s[o[f]],f);r.finishState(1,Br.None)}else if(!Vx.has(h)){l.clear();for(let f=m;f<p;++f){let b=Br.None;w$(t,e,f)?b=Br.Guanidine:_$(t,e,f)&&(b=Br.Acetamidine),b&&(r.startState(),Si(t,e,f,(v,x)=>{lr(e,x)==="N"&&(l.add(x),r.pushMember(i[o[x]],a[o[x]],s[o[x]],x))}),r.finishState(1,b))}for(let f=m;f<p;++f)n[f]>0&&!l.has(f)&&r.add(1,Br.None,i[o[f]],a[o[f]],s[o[f]],f)}}}function pwe(t,e,r){let{charge:n}=A$(t,e),{elements:o}=e,{x:i,y:a,z:s}=e.model.atomicConformation,l=new Set,{label_comp_id:c}=e.model.atomicHierarchy.atoms,u=$r.transientSegments(e.model.atomicHierarchy.residueAtomSegments,o);for(;u.hasNext;){let{index:d,start:m,end:p}=u.move(),h=c.value(e.model.atomicHierarchy.residueAtomSegments.offsets[d]);if(dwe.includes(h)){r.startState();for(let f=m;f<p;++f)lr(e,f)==="O"&&!ac.has(fh(e,f))&&r.pushMember(i[o[f]],a[o[f]],s[o[f]],f);r.finishState(2,Br.None)}else if(DT.has(h))for(let f=m;f<p;++f)PL(t,e,f)&&(r.startState(),Si(t,e,f,(b,v)=>{lr(e,v)==="O"&&r.pushMember(i[o[v]],a[o[v]],s[o[v]],v)}),r.finishState(2,Br.Phosphate));else if(!Vx.has(h)){for(let f=m;f<p;++f){r.startState(),lr(e,f)==="N"&&!ac.has(fh(e,f))&&r.pushMember(i[o[f]],a[o[f]],s[o[f]],f),r.finishState(2,Br.None);let b=Br.None;S$(t,e,f)?b=Br.SulfonicAcid:PL(t,e,f)?b=Br.Phosphate:C$(t,e,f)?b=Br.Sulfate:T$(t,e,f)&&(b=Br.Carboxylate),b&&(r.startState(),Si(t,e,f,(v,x)=>{lr(e,x)==="O"&&(l.add(x),r.pushMember(i[o[x]],a[o[x]],s[o[x]],x))}),r.finishState(2,b))}for(let f=m;f<p;++f)n[f]<0&&!l.has(f)&&r.add(2,Br.None,i[o[f]],a[o[f]],s[o[f]],f)}}}function fwe(t,e,r){let{elements:n}=e,{x:o,y:i,z:a}=e.model.atomicConformation;for(let s of e.rings.aromaticRings){let l=e.rings.all[s];r.startState();for(let c=0,u=l.length;c<u;++c){let d=l[c];r.pushMember(o[n[d]],i[n[d]],a[n[d]],d)}r.finishState(3,Br.None)}}function hwe(t,e){return t===2&&e===1||t===1&&e===2}function gwe(t,e){return t===3&&e===3}function ywe(t,e){return t===3&&e===1||t===1&&e===3}var E$=y(),I$=y();function vwe(t,e,r){let{feature:n,offsets:o,members:i}=t,{feature:a,offsets:s,members:l}=e;for(let c=o[n],u=o[n+1];c<u;++c){let d=i[c];t.unit.conformation.position(t.unit.elements[d],E$);for(let m=s[a],p=s[a+1];m<p;++m){let h=l[m];if(e.unit.conformation.position(e.unit.elements[h],I$),y.squaredDistance(E$,I$)<r)return!0}}return!1}var R_=y(),zv=y(),L_=y(),M_=y();function IL(t,e){let{unit:r,feature:n,offsets:o,members:i}=e,{elements:a}=r,s=o[n];return e.unit.conformation.position(a[i[s]],R_),e.unit.conformation.position(a[i[s+1]],zv),e.unit.conformation.position(a[i[s+2]],L_),y.triangleNormal(t,R_,zv,L_)}var DL=function(t,e,r){return tn.position(R_,t),tn.position(zv,e),y.sub(L_,R_,zv),y.projectOnPlane(M_,L_,r),y.add(M_,M_,zv),y.distance(M_,zv)};function bwe(t){return{distanceMaxSq:t.distanceMax*t.distanceMax}}function xwe(t){return{offsetMax:t.offsetMax,angleDevMax:or(t.angleDevMax)}}function Swe(t){return{offsetMax:t.offsetMax}}var Cwe=or(180),D$=or(90),iS=y(),EL=y();function Twe(t,e,r,n,o){let i=e.types[e.feature],a=r.types[r.feature];if(hwe(i,a)&&vwe(e,r,o.distanceMaxSq))return $t.Ionic}function wwe(t,e,r,n,o){let i=e.types[e.feature],a=r.types[r.feature];if(gwe(i,a)){IL(iS,e),IL(EL,r);let s=y.angle(iS,EL);if(Math.min(DL(e,r,EL),DL(r,e,iS))<=o.offsetMax){if(s<=o.angleDevMax||s>=Cwe-o.angleDevMax)return $t.PiStacking;if(s<=o.angleDevMax+D$&&s>=D$-o.angleDevMax)return $t.PiStacking}}}function _we(t,e,r,n,o){let i=e.types[e.feature],a=r.types[r.feature];if(ywe(i,a)){let[s,l]=i===3?[e,r]:[r,e];if(IL(iS,s),DL(l,s,iS)<=o.offsetMax)return $t.CationPi}}var k$=tn.Provider([2],pwe),M$=tn.Provider([1],mwe),R$=tn.Provider([3],fwe),L$={name:"ionic",params:swe,createTester:t=>{let e=bwe(t);return{maxDistance:t.distanceMax,requiredFeatures:new Set([2,1]),getType:(r,n,o,i)=>Twe(r,n,o,i,e)}}},B$={name:"pi-stacking",params:lwe,createTester:t=>{let e=xwe(t);return{maxDistance:t.distanceMax,requiredFeatures:new Set([3]),getType:(r,n,o,i)=>wwe(r,n,o,i,e)}}},O$={name:"cation-pi",params:cwe,createTester:t=>{let e=Swe(t);return{maxDistance:t.distanceMax,requiredFeatures:new Set([3,1]),getType:(r,n,o,i)=>_we(r,n,o,i,e)}}};var Pwe={distanceMax:g.Numeric(4,{min:1,max:5,step:.1})};function Ewe(t,e,r){let{elements:n}=e,{x:o,y:i,z:a}=e.model.atomicConformation;for(let s=0,l=n.length;s<l;++s){let c=lr(e,s),u=!1;c==="C"?(u=!0,Si(t,e,s,(d,m)=>{let p=lr(d,m);p!=="C"&&p!=="H"&&(u=!1)})):c==="F"&&(u=!0),u&&r.add(8,Br.None,o[n[s]],i[n[s]],a[n[s]],s)}}function Iwe(t,e){return t===8&&e===8}function Dwe(t,e,r,n){let o=e.types[e.feature],i=r.types[r.feature];if(!Iwe(o,i))return;let a=e.members[e.offsets[e.feature]],s=r.members[r.offsets[r.feature]];if(!(lr(e.unit,a)==="F"&&lr(r.unit,s)==="F"))return $t.Hydrophobic}var F$=tn.Provider([8],Ewe),N$={name:"hydrophobic",params:Pwe,createTester:t=>({maxDistance:t.distanceMax,requiredFeatures:new Set([8]),getType:(e,r,n,o)=>Dwe(e,r,n,o)})};var Awe={distanceMax:g.Numeric(3,{min:1,max:5,step:.1})},kwe=["LI","NA","K","RB","CS","MG","CA","SR","BA","AL","GA","IN","TL","SC","SN","PB","BI","SB","HG"];function Mwe(t,e,r){let{elements:n}=e,{x:o,y:i,z:a}=e.model.atomicConformation;for(let s=0,l=n.length;s<l;++s){let c=lr(e,s),u=0;kwe.includes(c)?u=13:(pR(c)||c==="ZN"||c==="CD")&&(u=12),u&&r.add(u,Br.None,o[n[s]],i[n[s]],a[n[s]],s)}}function V$(t){return!ac.has(t)}function Rwe(t){return ac.has(t)}function Lwe(t){return T0.has(t)}function Bwe(t,e,r){let{elements:n}=e,{x:o,y:i,z:a}=e.model.atomicConformation;for(let s=0,l=n.length;s<l;++s){let c=lr(e,s),u=oS(e,s),d=fh(e,s),m=!1,p=!1,h=Yz.has(u),f=DT.has(u);!h&&!f?mR(c)||c==="O"||c==="S"?(m=!0,p=!0):c==="N"&&(m=!0):h?c==="O"?(["ASP","GLU","SER","THR","TYR","ASN","GLN"].includes(u)&&V$(d)||Rwe(d))&&(m=!0,p=!0):c==="S"&&(u==="CYS"||u==="MET")?(m=!0,p=!0):c==="N"&&u==="HIS"&&V$(d)&&(m=!0):f&&(c==="O"&&Lwe(d)?(m=!0,p=!0):["N3","N4","N7"].includes(d)?m=!0:["O2","O4","O6"].includes(d)&&(m=!0,p=!0)),m&&r.add(11,Br.None,o[n[s]],i[n[s]],a[n[s]],s),p&&r.add(10,Br.None,o[n[s]],i[n[s]],a[n[s]],s)}}function z$(t,e){if(t===12)return e===11||e===12;if(t===13)return e===10}function Owe(t,e,r,n){let o=e.types[e.feature],i=r.types[r.feature];if(!(!z$(o,i)&&!z$(i,o)))return $t.MetalCoordination}var U$=tn.Provider([13,12],Mwe),G$=tn.Provider([10,11],Bwe),j$={name:"metal-coordination",params:Awe,createTester:t=>({maxDistance:t.distanceMax,requiredFeatures:new Set([13,12,10,11]),getType:(e,r,n,o)=>Owe(e,r,n,o)})};function H$(t,e){let{contacts:r,unitsContacts:n,unitsFeatures:o}=e,i=[Fwe(t,e),Nwe(t,e),Vwe(t,e),zwe(t,e),Uwe(t,e)];for(let s=0,l=r.edgeCount;s<l;++s){let c=r.edges[s],u=t.unitMap.get(c.unitA),d=t.unitMap.get(c.unitB),m=tn.Info(t,u,o.get(c.unitA));m.feature=c.indexA;let p=tn.Info(t,d,o.get(c.unitB));p.feature=c.indexB;for(let h of i)h.isApplicable(c.props.type)&&h.handleInterContact(s,m,p)}let a=n.keys();for(;;){let{done:s,value:l}=a.next();if(s)break;let c=n.get(l),u=o.get(l),d=t.unitMap.get(l);if(!Pe.isAtomic(d))continue;let m=tn.Info(t,d,u),p=tn.Info(t,d,u);for(let h of i)h.startUnit(d,c,u);for(let h=0,f=c.edgeCount*2;h<f;++h){m.feature=c.a[h],p.feature=c.b[h];for(let b of i)b.isApplicable(c.edgeProps.type[h])&&b.handleIntraContact(h,m,p)}}}function Fwe(t,e){let{contacts:r}=e,n=function(c,u,d,m,p){let[h,f]=m.get(d)||[1/0,-1];c<h?(f!==-1&&p(f),m.set(d,[c,u])):p(u)};function o(c,u,d,m,p){let h=u.members[u.offsets[u.feature]],f=d.members[d.offsets[d.feature]],b=u.unit.getResidueIndex(h),v=d.unit.getResidueIndex(f),x=`${h}|${u.unit.id}|${v}|${d.unit.id}|A`,S=`${f}|${d.unit.id}|${b}|${u.unit.id}|B`,T=tn.distance(u,d);n(T,c,x,m,p),n(T,c,S,m,p)}let i=new Map,a=c=>r.edges[c].props.flag=Gl.Filtered,s,l;return{isApplicable:c=>c===$t.Hydrophobic,handleInterContact:(c,u,d)=>{o(c,u,d,i,a)},startUnit:(c,u,d)=>{s=new Map,l=m=>u.edgeProps.flag[m]=Gl.Filtered},handleIntraContact:(c,u,d)=>{o(c,u,d,s,l)}}}function Nwe(t,e){let{contacts:r}=e,n=(o,i)=>{let a=o.types[o.feature]===9?i:o,s=a.members[a.offsets[a.feature]],{edgeProps:{type:l},elementsIndex:{offsets:c,indices:u}}=e.unitsContacts.get(a.unit.id);for(let m=c[s],p=c[s+1];m<p;++m)if(l[u[m]]===$t.HydrogenBond)return!0;let d=r.getEdgeIndices(a.feature,a.unit.id);for(let m=0,p=d.length;m<p;++m)if(r.edges[d[m]].props.type===$t.HydrogenBond)return!0;return!1};return{isApplicable:o=>o===$t.WeakHydrogenBond,handleInterContact:(o,i,a)=>{n(i,a)&&(r.edges[o].props.flag=Gl.Filtered)},startUnit:()=>{},handleIntraContact:(o,i,a)=>{if(n(i,a)){let{flag:s}=e.unitsContacts.get(i.unit.id).edgeProps;s[o]=Gl.Filtered}}}}function AL(t,e,r,n,o){let{offsets:i,feature:a}=r,{offsets:s,feature:l}=n;for(let c=i[a],u=i[a+1];c<u;++c){let d=r.members[c],m=o.getContactIndicesForElement(d,r.unit);for(let p=0,h=m.length;p<h;++p){let f=m[p];if(t.includes(o.edges[f].props.type))for(let b=s[l],v=s[l+1];b<v;++b){let x=n.members[b];if(o.getContactIndicesForElement(x,n.unit).includes(f)){o.edges[e].props.flag=Gl.Filtered;return}}}}}function kL(t,e,r,n,o){let{edgeProps:{type:i,flag:a},elementsIndex:{offsets:s,indices:l}}=o,{offsets:c,feature:u}=r,{offsets:d,feature:m}=n;for(let p=c[u],h=c[u+1];p<h;++p){let f=r.members[p];for(let b=s[f],v=s[f+1];b<v;++b){let x=l[b];if(t.includes(i[x]))for(let S=d[m],T=d[m+1];S<T;++S){let E=n.members[S];for(let _=s[E],D=s[E+1];_<D;++_)if(x===l[_]){a[e]=Gl.Filtered;return}}}}}function Vwe(t,e){let{contacts:r}=e;return{isApplicable:n=>n===$t.Ionic,handleInterContact:(n,o,i)=>{AL([$t.HydrogenBond,$t.WeakHydrogenBond],n,o,i,r)},startUnit:()=>{},handleIntraContact:(n,o,i)=>{kL([$t.HydrogenBond,$t.WeakHydrogenBond],n,o,i,e.unitsContacts.get(o.unit.id))}}}function zwe(t,e){let{contacts:r}=e;return{isApplicable:n=>n===$t.Hydrophobic||n===$t.CationPi,handleInterContact:(n,o,i)=>{AL([$t.PiStacking],n,o,i,r)},startUnit:()=>{},handleIntraContact:(n,o,i)=>{kL([$t.PiStacking],n,o,i,e.unitsContacts.get(o.unit.id))}}}function Uwe(t,e){let{contacts:r}=e;return{isApplicable:n=>n===$t.Ionic,handleInterContact:(n,o,i)=>{AL([$t.MetalCoordination],n,o,i,r)},startUnit:()=>{},handleIntraContact:(n,o,i)=>{kL([$t.MetalCoordination],n,o,i,e.unitsContacts.get(o.unit.id))}}}var Cu;(function(t){function e(u,d,m,p,h,f){return NT("interactions",{structure:d,interactions:u},{unitA:m,indexA:p,unitB:h,indexB:f})}t.Location=e;function r(u){return!!u&&u.kind==="data-location"&&u.tag==="interactions"}t.isLocation=r;function n(u,d){return u.data.structure===d.data.structure&&u.data.interactions===d.data.interactions&&u.element.indexA===d.element.indexA&&u.element.indexB===d.element.indexB&&u.element.unitA===d.element.unitA&&u.element.unitB===d.element.unitB}t.areLocationsEqual=n;function o(u,d){let{unitA:m,indexA:p,unitB:h,indexB:f}=d,{contacts:b,unitsContacts:v}=u;if(m===h){let x=v.get(m.id),S=x.getDirectedEdgeIndex(p,f);return CL(x.edgeProps.type[S])}else{let x=b.getEdgeIndex(p,m.id,f,h.id);return CL(b.edges[x].props.type)}}function i(u){return o(u.data.interactions,u.element)}t.locationLabel=i;function a(u,d,m){return Sf("interactions",{structure:u,interactions:d},m,p=>l(d,m,p),()=>c(u,d,m))}t.Loci=a;function s(u){return!!u&&u.kind==="data-loci"&&u.tag==="interactions"}t.isLoci=s;function l(u,d,m){let{unitsFeatures:p}=u;return np.fromPairProvider(d.length,(h,f,b)=>{let v=d[h];tn.setPosition(f,v.unitA,v.indexA,p.get(v.unitA.id)),tn.setPosition(b,v.unitB,v.indexB,p.get(v.unitB.id))},m)}t.getBoundingSphere=l;function c(u,d,m){let p=m[0];if(p===void 0)return"";let{unitA:h,indexA:f,unitB:b,indexB:v}=p,{unitsFeatures:x}=d,{members:S,offsets:T}=x.get(h.id),{members:E,offsets:_}=x.get(b.id),D={granularity:"element"};return(T[f+1]-T[f]>1||_[v+1]-_[v]>1)&&(D.granularity="residue"),[o(d,p),F1(ze.Location(u,h,S[T[f]],u,b,E[_[v]]),D)].join("</br>")}t.getLabel=c})(Cu||(Cu={}));var Gwe=[g$,y$,v$,k$,M$,R$,a$,s$,F$,U$,G$],B_={ionic:L$,"pi-stacking":B$,"cation-pi":O$,"halogen-bonds":l$,"hydrogen-bonds":b$,"weak-hydrogen-bonds":x$,hydrophobic:N$,"metal-coordination":j$};function jwe(t=[]){let e=Object.create(null);return Object.keys(B_).forEach(r=>{e[r]=g.MappedStatic(t.includes(r)?"on":"off",{on:g.Group(B_[r].params),off:g.Group({})},{cycle:!0})}),e}var Hwe=jwe(["cation-pi","pi-stacking","hydrogen-bonds","halogen-bonds","metal-coordination"]),ML={providers:g.Group(Hwe,{isFlat:!0}),contacts:g.Group(t$,{label:"Advanced Options"})};function q$(t,e,r){return N(this,null,function*(){let n=w(w({},g.getDefaultValues(ML)),r);yield wm.attach(t,e);let o=[];Tg(B_).forEach(d=>{let{name:m,params:p}=n.providers[d];m==="on"&&o.push(B_[d].createTester(p))});let i=new Set;o.forEach(d=>no.add(i,d.requiredFeatures));let a=Gwe.filter(d=>no.areIntersecting(i,d.types)),s=h0.Mutable(),l=h0.Mutable();for(let d=0,m=e.unitSymmetryGroups.length;d<m;++d){let p=e.unitSymmetryGroups[d];t.runtime.shouldUpdate&&(yield t.runtime.update({message:"computing interactions",current:d,max:m}));let h=qwe(e,p.units[0],a),f=Wwe(e,p.units[0],h,o,n.contacts);for(let b=0,v=p.units.length;b<v;++b){let x=p.units[b];s.set(x.id,h),l.set(x.id,f)}}let c=Xwe(e,s,o,n.contacts),u={unitsFeatures:s,unitsContacts:l,contacts:c};return H$(e,u),u})}function qwe(t,e,r){let n=e.elements.length,o=E_.create(n,n/2);if(Pe.isAtomic(e))for(let i of r)i.add(t,e,o);return o.getFeatures(n)}function Wwe(t,e,r,n,o){let i=A_.create(r,e.elements.length);return Pe.isAtomic(e)&&o$(t,e,r,i,n,o),i.getContacts()}function Xwe(t,e,r,n){let o=k_.create();return ue.eachUnitPair(t,(i,a)=>{let s=e.get(i.id),l=e.get(a.id);i$(t,i,s,a,l,o,r,n)},{maxRadius:Math.max(...r.map(i=>i.maxDistance)),validUnit:i=>Pe.isAtomic(i),validUnitPair:(i,a)=>ue.validUnitPair(t,i,a)}),o.getContacts(e)}var RL=w({},ML),Mn=gf.createProvider({label:"Interactions",descriptor:Xc({name:"molstar_computed_interactions"}),type:"local",defaultParams:RL,getParams:t=>RL,isApplicable:t=>!t.isCoarseGrained,obtain:(t,e,r)=>N(void 0,null,function*(){let n=w(w({},g.getDefaultValues(RL)),r);return{value:yield q$(t,e,n)}})});var LL=ce(13421772),Ywe="Assigns colors according the interaction type of a link.",ks={HydrogenBond:2851770,Hydrophobic:8421504,HalogenBond:4259775,Ionic:15779860,MetalCoordination:9191577,CationPi:16744448,PiStacking:9220966,WeakHydrogenBond:12967404},Qwe=[["Hydrogen Bond",ks.HydrogenBond],["Hydrophobic",ks.Hydrophobic],["Halogen Bond",ks.HalogenBond],["Ionic",ks.Ionic],["Metal Coordination",ks.MetalCoordination],["Cation Pi",ks.CationPi],["Pi Stacking",ks.PiStacking],["Weak HydrogenBond",ks.WeakHydrogenBond]];function W$(t){switch(t){case $t.HydrogenBond:return ks.HydrogenBond;case $t.Hydrophobic:return ks.Hydrophobic;case $t.HalogenBond:return ks.HalogenBond;case $t.Ionic:return ks.Ionic;case $t.MetalCoordination:return ks.MetalCoordination;case $t.CationPi:return ks.CationPi;case $t.PiStacking:return ks.PiStacking;case $t.WeakHydrogenBond:return ks.WeakHydrogenBond;case $t.Unknown:return LL}}var X$={};function Kwe(t){return X$}function Y$(t,e){let r,n=t.structure?Mn.get(t.structure):void 0,o=n?f0(n.id,n.version):-1;return n&&n.value?r=i=>{if(Cu.isLocation(i)){let{unitsContacts:a,contacts:s}=i.data.interactions,{unitA:l,unitB:c,indexA:u,indexB:d}=i.element;if(l===c){let m=a.get(l.id),p=m.getDirectedEdgeIndex(u,d);return W$(m.edgeProps.type[p])}else{let m=s.getEdgeIndex(u,l.id,d,c.id);return W$(s.edges[m].props.type)}}return LL}:r=()=>LL,{factory:Y$,granularity:"group",color:r,props:e,contextHash:o,description:Ywe,legend:vs(Qwe)}}var aS={name:"interaction-type",label:"Interaction Type",category:wo.Category.Misc,factory:Y$,getParams:Kwe,defaultValues:g.getDefaultValues(X$),isApplicable:t=>!!t.structure,ensureCustomProperties:{attach:(t,e)=>e.structure?Mn.attach(t,e.structure,void 0,!0):Promise.resolve(),detach:t=>t.structure&&Mn.ref(t.structure,!1)}};function _o(t,e,r,n){let o=0,{webgl:i}=e,a=new ln,s=new rt.GeometryState,l=rl(),c=[],u=Qr.create(),d,m,p,h,f=An.createEmpty();function b(P={},A){return A&&A!==m&&(p=r(e,A),m=A,h||(h=g.getDefaultValues(p))),h=Object.assign({},h,P),ie.create("Creating or updating ComplexRepresentation",I=>N(this,null,function*(){var k;let M=!1;d?!((k=d.mustRecreate)===null||k===void 0)&&k.call(d,m,h,i)&&(d.destroy(),d=n(l,m,h,i),M=!0):(d=n(l,m,h,i),M=!0);let R=d.createOrUpdate({webgl:i,runtime:I},f,h,A);R&&(yield R),M&&E(u),c.length=0,d&&d.renderObject&&(c.push(d.renderObject),s.add(d.renderObject.id,d.geometryVersion)),s.snapshot(),o+=1,a.next(o)}))}function v(P){return d?d.getLoci(P):St}function x(){var P;return[ue.Loci((P=m.child)!==null&&P!==void 0?P:m)]}function S(P){d?.eachLocation(P)}function T(P,A){if(!m||!kn.is(u.markerActions,A))return!1;if(ue.isLoci(P)||z.Loci.is(P)||ze.isLoci(P)){if(!ue.areRootsEquivalent(P.structure,m))return!1;P=st.remap(P,m),(ue.isLoci(P)||z.Loci.is(P)&&z.Loci.isWholeStructure(P))&&(P=xf)}else if(!So(P)&&!Ag(P))return!1;return st.isEmpty(P)?!1:d?d.mark(P,A):!1}function E(P){if(Qr.update(u,P),P.visible!==void 0&&d&&d.setVisibility(P.visible&&(u.unitTransforms===null||u.unitTransforms.isIdentity)),P.alphaFactor!==void 0&&d&&d.setAlphaFactor(P.alphaFactor),P.pickable!==void 0&&d&&d.setPickable(P.pickable),P.overpaint!==void 0&&d){let A=io.remap(P.overpaint,m);d.setOverpaint(A,i)}if(P.transparency!==void 0&&d){let A=Jo.remap(P.transparency,m);d.setTransparency(A,i)}if(P.emissive!==void 0&&d){let A=ti.remap(P.emissive,m);d.setEmissive(A,i)}if(P.substance!==void 0&&d){let A=ei.remap(P.substance,m);d.setSubstance(A,i)}if(P.clipping!==void 0&&d){let A=Xr.remap(P.clipping,m);d.setClipping(A)}P.themeStrength!==void 0&&d&&d.setThemeStrength(P.themeStrength),P.transform!==void 0&&d&&d.setTransform(P.transform),P.unitTransforms!==void 0&&d&&d.setVisibility(u.visible&&(P.unitTransforms===null||P.unitTransforms.isIdentity))}function _(P){f=P}function D(){d&&d.destroy()}return{label:t,get groupCount(){return d?d.groupCount:0},get props(){return h},get params(){return p},get state(){return u},get theme(){return f},get geometryVersion(){return s.version},renderObjects:c,updated:a,createOrUpdate:b,setState:E,setTheme:_,getLoci:v,getAllLoci:x,eachLocation:S,mark:T,destroy:D}}var $we=W.toArray;function O_(t,e,r){let{elements:n,model:o}=e;if(we.indexOf(n,r)!==-1){let{index:i,offsets:a}=o.atomicHierarchy.residueAtomSegments,s=i[r],l=[];for(let u=a[s],d=a[s+1];u<d;++u){let m=we.indexOf(n,u);m!==-1&&l.push(m)}let c=we.ofSortedArray(tr.ofSortedArray(l));return z.Loci(t,[{unit:e,indices:c}])}return St}function Q$(t,e,r){let{elements:n,model:o}=e,{label_alt_id:i}=o.atomicHierarchy.atoms,a=i.value(r);if(we.indexOf(n,r)!==-1){let{index:s}=o.atomicHierarchy.residueAtomSegments,l=s[r];return gh(t,e,l,a)}return z.Loci(t,[])}function gh(t,e,r,n){let{elements:o,model:i}=e,{label_alt_id:a}=i.atomicHierarchy.atoms,{offsets:s}=i.atomicHierarchy.residueAtomSegments,l=[];for(let u=s[r],d=s[r+1];u<d;++u){let m=we.indexOf(o,u);if(m!==-1){let p=a.value(u);(n===p||p==="")&&l.push(m)}}let c=we.ofSortedArray(tr.ofSortedArray(l));return z.Loci(t,[{unit:e,indices:c}])}function BL(t,e,r,n,o,i){let{child:a}=t.structure,s=e&&a?t.group.units.filter(d=>a.unitMap.has(d.id)):t.group.units,l=s.length,c=l*16,u=i&&i.aTransform.ref.value.length>=c?i.aTransform.ref.value:new Float32Array(c);for(let d=0;d<l;d++)$we(s[d].conformation.operator.matrix,u,d*16);return Xx(u,l,r,n,o,i)}var Zwe={atomic:{},spheres:{},gaussians:{}},K$=g.objectToOptions(Zwe);function $$(t,e){for(let r=0,n=t.length;r<n;++r)if(Pe.isAtomic(e)&&t[r]==="atomic"||Pe.isSpheres(e)&&t[r]==="spheres"||Pe.isGaussians(e)&&t[r]==="gaussians")return!0;return!1}var Z$=5e8;function OL(t,e,r=Z$){let n=qe.size(y(),t);y.ceil(n,n),n.sort((s,l)=>l-s);let o=Math.floor(Math.cbrt(r)*Math.cbrt(r)),i=n[0]*n[1],a=Math.ceil(i/(e*e));return{area:i,areaCells:a,maxAreaCells:o}}function _m(t,e,r=Z$){let{area:n,areaCells:o,maxAreaCells:i}=OL(t,e.resolution,r),a=o>i?Math.sqrt(n/i):e.resolution;return U(w({},e),{resolution:a})}function Jwe(t){switch(t.kind){case 0:return t.model.atomicConformation;case 1:return t.model.coarseConformation.spheres;case 2:return t.model.coarseConformation.gaussians}}var dy={ignoreHydrogens:g.Boolean(!1,{description:"Whether or not to include hydrogen atoms in the surface calculation."}),ignoreHydrogensVariant:g.Select("all",g.arrayToOptions(["all","non-polar"])),traceOnly:g.Boolean(!1,{description:"Whether or not to only use trace atoms in the surface calculation."}),includeParent:g.Boolean(!1,{description:"Include elements of the parent structure in surface calculation to get a surface patch of the current structure."})},ukt=g.getDefaultValues(dy),e_e=y();function J$(t,e,r,n){return y.squaredDistance(y.set(e_e,t,e,r),n)}function t_e(t,e,r){let n=0,o=e.length;for(let i=0,a=r.length;i<a;++i){let s=tr.indexOfInRange(e,r[i],n,o);s===-1?t[i]=-2:(t[i]=s,n=s)}}function Uv(t,e,r,n){let{ignoreHydrogens:o,ignoreHydrogensVariant:i,traceOnly:a,includeParent:s}=n,l=s?t.root.unitMap.get(e.id):e,c=s&&l!==e,{x:u,y:d,z:m}=Jwe(l),{elements:p}=l,{center:h,radius:f}=e.boundary.sphere,b=(4+1.5)*2,v=(f+b)*(f+b),x,S;if(o||a||c){let P=[],A=[];for(let I=0,k=p.length;I<k;++I){let M=p[I];o&&sl(t,l,M,i)||a&&!F_(l,M)||c&&J$(u[M],d[M],m[M],h)>v||(P.push(M),A.push(I))}x=tr.ofSortedArray(P),S=A}else x=p,S=Ri(new Int32Array(x.length));s&&l!==e&&t_e(S,e.elements,x);let T={indices:x,x:u,y:d,z:m,id:S},E=c?_0(T):e.boundary,_=z.Location.create(t,l);return{position:T,boundary:E,radius:P=>(_.element=P,r.size(_))}}function Gv(t,e,r){let{ignoreHydrogens:n,ignoreHydrogensVariant:o,traceOnly:i,includeParent:a}=r,s=a&&!!t.parent,l=z.Location.create(t.root),{center:c,radius:u}=t.boundary.sphere,d=(4+1.5)*2,m=(u+d)*(u+d),p,h,f,b,v,x;if(n||i||s){let{getSerialIndex:_}=t.serialMapping,D=s?t.root.units:t.units,P=[],A=[],I=[],k=[],M=[];for(let R=0,B=D.length;R<B;++R){let F=D[R],{elements:G,conformation:V}=F,H=t.unitMap.get(F.id);l.unit=F;for(let Q=0,L=G.length;Q<L;++Q){let Y=G[Q];if(n&&sl(t,F,Y,o)||i&&!F_(F,Y))continue;let j=V.x(Y),O=V.y(Y),J=V.z(Y);s&&J$(j,O,J,c)>m||(P.push(j),A.push(O),I.push(J),l.element=Y,k.push(e.size(l)),s?(H?tr.indexOf(H.elements,Y):-1)===-1?M.push(-2):M.push(_(H,Y)):M.push(_(F,Y)))}}p=P,h=A,f=I,b=k,v=M,x=we.ofRange(0,v.length)}else{let{elementCount:_}=t,D=new Float32Array(_),P=new Float32Array(_),A=new Float32Array(_),I=new Float32Array(_);for(let k=0,M=0,R=t.units.length;k<R;++k){let B=t.units[k],{elements:F,conformation:G}=B;l.unit=B;for(let V=0,H=F.length;V<H;++V){let Q=F[V],L=M+V;D[L]=G.x(Q),P[L]=G.y(Q),A[L]=G.z(Q),l.element=Q,I[L]=e.size(l)}M+=F.length}p=D,h=P,f=A,b=I,v=Ri(new Uint32Array(_)),x=we.ofRange(0,v.length)}let S={indices:x,x:p,y:h,z:f,id:v},T=s?_0(S):t.boundary;return{position:S,boundary:T,radius:_=>b[_]}}var eZ=xU.H;function sl(t,e,r,n){if(Pe.isCoarse(e)||e.model.atomicHierarchy.derived.atom.atomicNumber[r]!==eZ)return!1;if(n==="all")return!0;let o=P$(t,e,tr.indexOf(e.elements,r));return!!(o&&n==="polar"||!o&&n==="non-polar")}function tZ(t,e){return t[e]===eZ}function F_(t,e){if(Pe.isCoarse(t))return!0;let r=t.model.atomicHierarchy.atoms.label_atom_id.value(e);return r==="CA"||r==="BB"||r==="P"}function Ip(t){return g.MultiSelect(t,K$,{description:"For which kinds of units/chains to show the representation visuals."})}var cs={unitKinds:Ip(["atomic","spheres"]),includeParent:g.Boolean(!1,{isHidden:!0})},N_=w({},Be.Params),V_=w({},Ni.Params),z_=w({},xo.Params),rZ=w({},Il.Params),U_=w({},Sr.Params),G_=w({},Bo.Params),j_=w({},ta.Params),H_=w({},Ko.Params);function r_e(t,e,r,n,o,i){let{createValues:a,createRenderableState:s}=eo.getUtils(e),l=I0(),c=a(e,l,r,n,o),u=s(o);return tu(e.kind,c,u,i)}function yh(t,e){let{defaultProps:r,createGeometry:n,createLocationIterator:o,getLoci:i,eachLocation:a,setUpdateState:s,mustRecreate:l,processValues:c,dispose:u}=t,{updateValues:d,updateBoundingSphere:m,updateRenderableState:p,createPositionIterator:h}=t.geometryUtils,f=Bl.create(),b={loci:St,action:tt.None,status:-1},v,x,S,T,E=Object.assign({},r),_=An.createEmpty(),D,P,A=-1,I,k;function M(H,Q,L){if(!L&&!D)throw new Error("missing structure");if(x=Object.assign({},E,Q),S=H,T=L,Bl.reset(f),!v||!D){f.createNew=!0,f.createGeometry=!0;return}s(f,x,E,S,_,T,D),ue.areEquivalent(T,D)||(f.createGeometry=!0),ue.areHierarchiesEqual(T,D)||(f.updateTransform=!0,f.createGeometry=!0),wo.areEqual(H.color,_.color)||(f.updateColor=!0),ys(x.unitKinds,E.unitKinds)||(f.createGeometry=!0),D.child!==T.child&&(f.createGeometry=!0),x.instanceGranularity!==E.instanceGranularity&&(f.updateTransform=!0),f.updateSize&&!("uSize"in v.values)&&(f.createGeometry=!0),f.createGeometry&&(f.updateColor=!0,f.updateSize=!0)}function R(H){if(f.createNew)if(I=o(T,x),H)v=r_e(T,H,I,S,x,e),k=h(H,v.values);else throw new Error("expected geometry to be given");else{if(!v)throw new Error("expected renderObject to be available");if(f.updateTransform){I=o(T,x);let{instanceCount:Q,groupCount:L}=I;x.instanceGranularity?jr(Q,"instance",v.values):jr(Q*L,"groupInstance",v.values)}if(f.createGeometry)if(H)C.updateIfChanged(v.values.drawCount,eo.getDrawCount(H)),C.updateIfChanged(v.values.uVertexCount,eo.getVertexCount(H)),C.updateIfChanged(v.values.uGroupCount,eo.getGroupCount(H));else throw new Error("expected geometry to be given");(f.updateTransform||f.createGeometry)&&(m(v.values,H||P),k=h(P,v.values)),f.updateSize&&"uSize"in v.values&&Sa(I,S.size,v.values),f.updateColor&&uo(I,k,S.color,v.values),d(v.values,x),p(v.state,x)}E=x,_=S,D=T,H&&(P=H,A+=1)}function B(H){return!!(So(H)||ue.isLoci(H)&&ue.areRootsEquivalent(H.structure,D)||z.Loci.is(H)&&ue.areRootsEquivalent(H.structure,D)&&z.Loci.isWholeStructure(H))}function F(H,Q,L){let Y=!1;return!z.Loci.is(H)&&!ze.isLoci(H)||!ue.areEquivalent(H.structure,Q)?!1:(L(Oe.ofSingleton(0))&&(Y=!0),Y)}function G(H,Q,L){return B(H)?E.instanceGranularity?Q(Oe.ofBounds(0,I.instanceCount)):Q(Oe.ofBounds(0,I.groupCount*I.instanceCount)):E.instanceGranularity?F(H,D,Q):a(H,D,Q,L)}function V(H){v&&c?.(v.values,P,E,_,H.webgl)}return{get groupCount(){return I?I.count:0},get renderObject(){return I&&I.count?v:void 0},get geometryVersion(){return A},createOrUpdate(H,Q,L={},Y){if(M(Q,L,Y||D),f.createGeometry){let j=n(H,T,S,x,P);if(af(j))return j.then(O=>{R(O),V(H)});R(j)}else R();V(H)},getLoci(H){return v?i(H,D,v.id):St},eachLocation(H){for(I.reset();I.hasNext;){let{location:Q,isSecondary:L}=I.move();H(Q,L)}},mark(H,Q){return Vt.mark(v,H,Q,G,b)},setVisibility(H){Vt.setVisibility(v,H)},setAlphaFactor(H){Vt.setAlphaFactor(v,H)},setPickable(H){Vt.setPickable(v,H)},setColorOnly(H){Vt.setColorOnly(v,H)},setTransform(H,Q){Vt.setTransform(v,H,Q)},setOverpaint(H,Q){let L={geometry:P,props:E,webgl:Q};Vt.setOverpaint(v,H,G,!0,L)},setTransparency(H,Q){let L={geometry:P,props:E,webgl:Q};Vt.setTransparency(v,H,G,!0,L)},setEmissive(H,Q){let L={geometry:P,props:E,webgl:Q};Vt.setEmissive(v,H,G,!0,L)},setSubstance(H,Q){let L={geometry:P,props:E,webgl:Q};Vt.setSubstance(v,H,G,!0,L)},setClipping(H){Vt.setClipping(v,H,G,!0)},setThemeStrength(H){Vt.setThemeStrength(v,H)},destroy(){u?.(P),v&&(v.state.disposed=!0,v=void 0)},mustRecreate:l}}var Tu=w(w({},N_),cs);function Va(t,e){return yh(U(w({},t),{setUpdateState:(r,n,o,i,a,s,l)=>{t.setUpdateState(r,n,o,i,a,s,l),so.areEqual(i.size,a.size)||(r.createGeometry=!0)},geometryUtils:Be.Utils}),e)}var nZ=w(w({},V_),cs);function oZ(t,e){return yh(U(w({},t),{setUpdateState:(r,n,o,i,a,s,l)=>{t.setUpdateState(r,n,o,i,a,s,l),so.areEqual(i.size,a.size)||(r.updateSize=!0)},geometryUtils:Ni.Utils}),e)}var iZ=w(w({},z_),cs);function aZ(t,e){return yh(U(w({},t),{setUpdateState:(r,n,o,i,a,s,l)=>{t.setUpdateState(r,n,o,i,a,s,l),so.areEqual(i.size,a.size)||(r.updateSize=!0)},geometryUtils:xo.Utils}),e)}var sZ=w(w({},U_),cs);function lZ(t,e){return yh(U(w({},t),{setUpdateState:(r,n,o,i,a,s,l)=>{t.setUpdateState(r,n,o,i,a,s,l),so.areEqual(i.size,a.size)||(r.updateSize=!0)},geometryUtils:Sr.Utils}),e)}var cZ=w(w({},G_),cs);function uZ(t,e){return yh(U(w({},t),{setUpdateState:(r,n,o,i,a,s,l)=>{t.setUpdateState(r,n,o,i,a,s,l),so.areEqual(i.size,a.size)||(r.updateSize=!0),n.background!==o.background&&(r.createGeometry=!0),n.backgroundMargin!==o.backgroundMargin&&(r.createGeometry=!0),n.tether!==o.tether&&(r.createGeometry=!0),n.tetherLength!==o.tetherLength&&(r.createGeometry=!0),n.tetherBaseWidth!==o.tetherBaseWidth&&(r.createGeometry=!0),n.attachment!==o.attachment&&(r.createGeometry=!0),n.fontFamily!==o.fontFamily&&(r.createGeometry=!0),n.fontQuality!==o.fontQuality&&(r.createGeometry=!0),n.fontStyle!==o.fontStyle&&(r.createGeometry=!0),n.fontVariant!==o.fontVariant&&(r.createGeometry=!0),n.fontWeight!==o.fontWeight&&(r.createGeometry=!0)},geometryUtils:Bo.Utils}),e)}var dZ=w(w({},j_),cs);function mZ(t,e){return yh(U(w({},t),{setUpdateState:(r,n,o,i,a,s,l)=>{t.setUpdateState(r,n,o,i,a,s,l),so.areEqual(i.size,a.size)||(r.createGeometry=!0)},geometryUtils:ta.Utils}),e)}var pZ=w(w({},H_),cs);function fZ(t,e){return yh(U(w({},t),{setUpdateState:(r,n,o,i,a,s,l)=>{t.setUpdateState(r,n,o,i,a,s,l),so.areEqual(i.size,a.size)||(r.createGeometry=!0)},geometryUtils:Ko.Utils}),e)}function Dr(t,e,r,n){let o=0,{webgl:i}=e,a=new ln,s=rl(),l=[],c=new rt.GeometryState,u=Qr.create(),d=new Map,m,p,h,f,b=An.createEmpty();function v(I={},k){return k&&k!==m&&(h=r(e,k),f||(f=g.getDefaultValues(h))),f=Object.assign({},f,I),ie.create("Creating or updating UnitsRepresentation",M=>N(this,null,function*(){var R,B,F;if(!m&&!k)throw new Error("missing structure");if(k&&!m){p=k.unitSymmetryGroups;for(let G=0;G<p.length;G++){let V=p[G],H=n(s,k,f,i),Q=H.createOrUpdate({webgl:i,runtime:M},b,f,{group:V,structure:k});Q&&(yield Q),_(H,V,u),d.set(V.hashCode,{visual:H,group:V}),M.shouldUpdate&&(yield M.update({message:"Creating or updating UnitsVisual",current:G,max:p.length}))}}else if(k&&(!ue.areUnitIdsAndIndicesEqual(k,m)||k.child!==m.child)){p=k.unitSymmetryGroups;let G=d;d=new Map;for(let V=0;V<p.length;V++){let H=p[V],Q=G.get(H.hashCode);if(Q){let{visual:L}=Q;if(!((R=L.mustRecreate)===null||R===void 0)&&R.call(L,{group:H,structure:k},f,i)){L.destroy(),L=n(s,k,f,i);let Y=L.createOrUpdate({webgl:i,runtime:M},b,f,{group:H,structure:k});Y&&(yield Y),_(L,H,u)}else{let Y=L.createOrUpdate({webgl:i,runtime:M},b,f,{group:H,structure:k});Y&&(yield Y)}if(d.set(H.hashCode,{visual:L,group:H}),G.delete(H.hashCode),L.renderObject){let Y=L.renderObject.values.tMarker.ref.value.array;ka(Y,Oe.ofBounds(0,Y.length),tt.RemoveHighlight)}}else{let L=n(s,k,f,i),Y=L.createOrUpdate({webgl:i,runtime:M},b,f,{group:H,structure:k});Y&&(yield Y),_(L,H,u),d.set(H.hashCode,{visual:L,group:H})}M.shouldUpdate&&(yield M.update({message:"Creating or updating UnitsVisual",current:V,max:p.length}))}G.forEach(({visual:V})=>{V.destroy()})}else if(k&&k!==m&&ue.areUnitIdsAndIndicesEqual(k,m)){p=k.unitSymmetryGroups;for(let G=0;G<p.length;G++){let V=p[G],H=d.get(V.hashCode);if(H){let{visual:Q}=H;if(!((B=Q.mustRecreate)===null||B===void 0)&&B.call(Q,{group:V,structure:k},f,e.webgl)){Q.destroy(),Q=n(s,k,f,e.webgl),H.visual=Q;let L=Q.createOrUpdate({webgl:i,runtime:M},b,f,{group:V,structure:k});L&&(yield L),_(Q,V,u)}else{let L=Q.createOrUpdate({webgl:i,runtime:M},b,f,{group:V,structure:k});L&&(yield L)}H.group=V}else throw new Error(`expected to find visual for hashCode ${V.hashCode}`);M.shouldUpdate&&(yield M.update({message:"Creating or updating UnitsVisual",current:G,max:p.length}))}}else{let G=[];d.forEach(V=>G.push(V));for(let V=0,H=G.length;V<H;++V){let{visual:Q,group:L}=G[V];if(!((F=Q.mustRecreate)===null||F===void 0)&&F.call(Q,{group:L,structure:m},f,e.webgl)){Q.destroy(),Q=n(s,m,f,i),G[V].visual=Q;let Y=Q.createOrUpdate({webgl:i,runtime:M},b,f,{group:L,structure:m});Y&&(yield Y),_(Q,L,u)}else{let Y=Q.createOrUpdate({webgl:i,runtime:M},b,f);Y&&(yield Y)}M.shouldUpdate&&(yield M.update({message:"Creating or updating UnitsVisual",current:V,max:H}))}}l.length=0,d.forEach(({visual:G})=>{G.renderObject&&(l.push(G.renderObject),c.add(G.renderObject.id,G.geometryVersion))}),c.snapshot(),k&&(m=k),a.next(o++)}))}function x(I){let k=St;return d.forEach(({visual:M})=>{let R=M.getLoci(I);Wn(R)||(k=R)}),k}function S(I){d.forEach(({visual:k})=>{k.eachLocation(I)})}function T(){var I;return[ue.Loci((I=m.child)!==null&&I!==void 0?I:m)]}function E(I,k){if(!m||!kn.is(u.markerActions,k))return!1;if(ue.isLoci(I)||z.Loci.is(I)||ze.isLoci(I)){if(!ue.areRootsEquivalent(I.structure,m))return!1;I=st.remap(I,m),(ue.isLoci(I)||z.Loci.is(I)&&z.Loci.isWholeStructure(I))&&(I=xf)}else if(!So(I)&&!Ag(I))return!1;if(st.isEmpty(I))return!1;let M=!1;return d.forEach(({visual:R})=>{M=R.mark(I,k)||M}),M}function _(I,k,M){let{visible:R,alphaFactor:B,pickable:F,overpaint:G,transparency:V,emissive:H,substance:Q,clipping:L,themeStrength:Y,transform:j,unitTransforms:O}=M;R!==void 0&&I.setVisibility(R),B!==void 0&&I.setAlphaFactor(B),F!==void 0&&I.setPickable(F),G!==void 0&&I.setOverpaint(G,i),V!==void 0&&I.setTransparency(V,i),H!==void 0&&I.setEmissive(H,i),Q!==void 0&&I.setSubstance(Q,i),L!==void 0&&I.setClipping(L),Y!==void 0&&I.setThemeStrength(Y),j!==void 0&&(j!==u.transform||!W.areEqual(j,u.transform,1e-6))&&I.setTransform(j),O!==void 0&&(O?I.setTransform(void 0,O.getSymmetryGroupTransforms(k)):O!==u.unitTransforms&&I.setTransform(void 0,null))}function D(I){let{visible:k,alphaFactor:M,pickable:R,overpaint:B,transparency:F,emissive:G,substance:V,clipping:H,themeStrength:Q,transform:L,unitTransforms:Y,syncManually:j,markerActions:O}=I,J={};k!==void 0&&(J.visible=k),M!==void 0&&(J.alphaFactor=M),R!==void 0&&(J.pickable=R),B!==void 0&&m&&(J.overpaint=io.remap(B,m)),F!==void 0&&m&&(J.transparency=Jo.remap(F,m)),G!==void 0&&m&&(J.emissive=ti.remap(G,m)),V!==void 0&&m&&(J.substance=ei.remap(V,m)),H!==void 0&&m&&(J.clipping=Xr.remap(H,m)),Q!==void 0&&(J.themeStrength=Q),L!==void 0&&!W.areEqual(L,u.transform,1e-6)&&(J.transform=L),(Y!==u.unitTransforms||Y?.version!==u.unitTransformsVersion)&&(J.unitTransforms=Y,u.unitTransformsVersion=Y?Y?.version:-1),j!==void 0&&(J.syncManually=j),O!==void 0&&(J.markerActions=O),d.forEach(({visual:$,group:ae})=>_($,ae,J)),Qr.update(u,J)}function P(I){b=I}function A(){d.forEach(({visual:I})=>I.destroy()),d.clear()}return{label:t,get groupCount(){let I=0;return d.forEach(({visual:k})=>{k.renderObject&&(I+=k.groupCount)}),I},get geometryVersion(){return c.version},get props(){return f},get params(){return h},get state(){return u},get theme(){return b},renderObjects:l,updated:a,createOrUpdate:v,setState:D,setTheme:P,getLoci:x,getAllLoci:T,eachLocation:S,mark:E,destroy:A}}function n_e(t,e,r,n,o,i){let{createValues:a,createRenderableState:s}=eo.getUtils(e),l=BL(t,o.includeParent,e.boundingSphere,o.cellSize,o.batchSize),c=a(e,l,r,n,o),u=s(o);return tu(e.kind,c,u,i)}function vh(t,e){let{defaultProps:r,createGeometry:n,createLocationIterator:o,getLoci:i,eachLocation:a,setUpdateState:s,mustRecreate:l,processValues:c,dispose:u}=t,{createEmpty:d,updateValues:m,updateBoundingSphere:p,updateRenderableState:h,createPositionIterator:f}=t.geometryUtils,b=Bl.create(),v={loci:St,action:tt.None,status:-1},x,S=Object.assign({},r),T=An.createEmpty(),E,_,D,P,A,I=-1,k,M;function R(L,Y,j){if(!j&&!P)throw new Error("missing structureGroup");if(S=Y,T=L,E=j,Bl.reset(b),!x||!P){b.createNew=!0,b.createGeometry=!0;return}s(b,S,_,T,D,E,P),ue.areHierarchiesEqual(P.structure,E.structure)||(b.updateTransform=!0,b.updateColor=!0,b.updateSize=!0),wo.areEqual(T.color,D.color)||(b.updateColor=!0),P.structure.child!==E.structure.child&&(b.createGeometry=!0),(S.instanceGranularity!==_.instanceGranularity||S.cellSize!==_.cellSize||S.batchSize!==_.batchSize)&&(b.updateTransform=!0),ys(S.unitKinds,_.unitKinds)||(b.createGeometry=!0),E.group.transformHash!==P.group.transformHash&&(E.group.units.length!==P.group.units.length||b.updateColor?b.updateTransform=!0:b.updateMatrix=!0);let O=E.group.units[0],J=P.group.units[0];Pe.areOperatorsEqual(O,J)||(b.updateTransform=!0),Pe.areConformationsEqual(O,J)||(b.createGeometry=!0),b.updateTransform&&(b.updateMatrix=!0),b.updateSize&&!("uSize"in x.values)&&(b.createGeometry=!0),(b.createGeometry||b.updateTransform)&&(P.structure.hashCode!==E.structure.hashCode&&(b.updateColor=!0,b.updateSize=!0),(T.color.granularity.startsWith("vertex")||x.values.dColorType.ref.value.startsWith("vertex")||T.color.granularity.startsWith("volume")||x.values.dColorType.ref.value.startsWith("volume"))&&(b.updateColor=!0))}function B(L){if(b.createNew)if(k=o(E,S),L)x=n_e(E,L,k,T,S,e),M=f(L,x.values);else throw new Error("expected geometry to be given");else{if(!x)throw new Error("expected renderObject to be available");if(b.updateTransform){k=o(E,S);let{instanceCount:Y,groupCount:j}=k;S.instanceGranularity?jr(Y,"instance",x.values):jr(Y*j,"groupInstance",x.values)}if(b.updateMatrix&&(BL(E,S.includeParent,x.values.invariantBoundingSphere.ref.value,S.cellSize,S.batchSize,x.values),"lodLevels"in x.values&&C.update(x.values.lodLevels,x.values.lodLevels.ref.value)),b.createGeometry)if(L)C.updateIfChanged(x.values.drawCount,eo.getDrawCount(L)),C.updateIfChanged(x.values.uVertexCount,eo.getVertexCount(L)),C.updateIfChanged(x.values.uGroupCount,eo.getGroupCount(L));else throw new Error("expected geometry to be given");(b.updateTransform||b.createGeometry)&&(p(x.values,L||A),M=f(L||A,x.values)),b.updateSize&&"uSize"in x.values&&Sa(k,T.size,x.values),b.updateColor&&uo(k,M,T.color,x.values),m(x.values,S),h(x.state,S)}_=S,D=T,P=E,L&&(A=L,I+=1)}function F(L,Y,j,O,J,$){return $$(J.unitKinds,Y)?n(L,Y,j,O,J,$):d($)}function G(L){return!!(So(L)||ue.isLoci(L)&&ue.areRootsEquivalent(L.structure,P.structure)||z.Loci.is(L)&&ue.areRootsEquivalent(L.structure,P.structure)&&z.Loci.isWholeStructure(L))}function V(L,Y,j){let O=!1;if(ze.isLoci(L)){let{structure:J,group:$}=Y;if(!ue.areEquivalent(L.structure,J))return!1;for(let ae of L.bonds){if(ae.aUnit!==ae.bUnit)continue;let Z=$.unitIndexMap.get(ae.aUnit.id);Z!==void 0&&j(Oe.ofSingleton(Z))&&(O=!0)}}else if(z.Loci.is(L)){let{structure:J,group:$}=Y;if(!ue.areEquivalent(L.structure,J))return!1;for(let ae of L.elements){let Z=$.unitIndexMap.get(ae.unit.id);Z!==void 0&&j(Oe.ofSingleton(Z))&&(O=!0)}}return O}function H(L,Y,j){return G(L)?_.instanceGranularity?Y(Oe.ofBounds(0,k.instanceCount)):Y(Oe.ofBounds(0,k.groupCount*k.instanceCount)):_.instanceGranularity?V(L,P,Y):a(L,P,Y,j)}function Q(L){x&&c?.(x.values,A,_,D,L.webgl)}return{get groupCount(){return k?k.count:0},get renderObject(){return k&&k.count?x:void 0},get geometryVersion(){return I},createOrUpdate(L,Y,j,O){if(R(Y,j,O||P),b.createGeometry){let J=F(L,E.group.units[0],E.structure,T,S,A);if(af(J))return J.then($=>{B($),Q(L)});B(J)}else B();Q(L)},getLoci(L){return x?i(L,P,x.id):St},eachLocation(L){for(k.reset();k.hasNext;){let{location:Y,isSecondary:j}=k.move();L(Y,j)}},mark(L,Y){let j=!0;if(z.Loci.is(L)){j=!1;let{invariantId:O}=P.group.units[0];for(let J of L.elements)if(J.unit.invariantId===O){j=!0;break}}return j?Vt.mark(x,L,Y,H,v):!1},setVisibility(L){Vt.setVisibility(x,L)},setAlphaFactor(L){Vt.setAlphaFactor(x,L)},setPickable(L){Vt.setPickable(x,L)},setColorOnly(L){Vt.setColorOnly(x,L)},setTransform(L,Y){Vt.setTransform(x,L,Y)},setOverpaint(L,Y){let j={geometry:A,props:_,webgl:Y};Vt.setOverpaint(x,L,H,!0,j)},setTransparency(L,Y){let j={geometry:A,props:_,webgl:Y};Vt.setTransparency(x,L,H,!0,j)},setEmissive(L,Y){let j={geometry:A,props:_,webgl:Y};Vt.setEmissive(x,L,H,!0,j)},setSubstance(L,Y){let j={geometry:A,props:_,webgl:Y};Vt.setSubstance(x,L,H,!0,j)},setClipping(L){Vt.setClipping(x,L,H,!0)},setThemeStrength(L){Vt.setThemeStrength(x,L)},destroy(){u?.(A),x&&(x.state.disposed=!0,x=void 0)},mustRecreate:l}}var Gr=w(w({},N_),cs);function rn(t,e){return vh(U(w({},t),{setUpdateState:(r,n,o,i,a,s,l)=>{t.setUpdateState(r,n,o,i,a,s,l),so.areEqual(i.size,a.size)||(r.createGeometry=!0)},geometryUtils:Be.Utils}),e)}var jv=w(w({},V_),cs);function Hv(t,e){return vh(U(w({},t),{setUpdateState:(r,n,o,i,a,s,l)=>{t.setUpdateState(r,n,o,i,a,s,l),so.areEqual(i.size,a.size)||(r.updateSize=!0)},geometryUtils:Ni.Utils}),e)}var qv=w(w({},z_),cs);function Wv(t,e){return vh(U(w({},t),{setUpdateState:(r,n,o,i,a,s,l)=>{t.setUpdateState(r,n,o,i,a,s,l),so.areEqual(i.size,a.size)||(r.updateSize=!0)},geometryUtils:xo.Utils}),e)}var hZ=w(w({},rZ),cs);function gZ(t,e){return vh(U(w({},t),{setUpdateState:(r,n,o,i,a,s,l)=>{t.setUpdateState(r,n,o,i,a,s,l),so.areEqual(i.size,a.size)||(r.updateSize=!0)},geometryUtils:Il.Utils}),e)}var bh=w(w({},U_),cs);function xh(t,e){return vh(U(w({},t),{setUpdateState:(r,n,o,i,a,s,l)=>{t.setUpdateState(r,n,o,i,a,s,l),so.areEqual(i.size,a.size)||(r.updateSize=!0)},geometryUtils:Sr.Utils}),e)}var jMt=w(w({},G_),cs);var yZ=w(w({},j_),cs);function vZ(t,e){return vh(U(w({},t),{setUpdateState:(r,n,o,i,a,s,l)=>{t.setUpdateState(r,n,o,i,a,s,l),so.areEqual(i.size,a.size)||(r.createGeometry=!0)},geometryUtils:ta.Utils}),e)}var bZ=w(w({},H_),cs);function xZ(t,e){return vh(U(w({},t),{setUpdateState:(r,n,o,i,a,s,l)=>{t.setUpdateState(r,n,o,i,a,s,l),so.areEqual(i.size,a.size)||(r.createGeometry=!0)},geometryUtils:Ko.Utils}),e)}var Qr={create:()=>U(w({},rt.createState()),{unitTransforms:null,unitTransformsVersion:-1}),update:(t,e)=>{rt.updateState(t,e),e.unitTransforms!==void 0&&(t.unitTransforms=e.unitTransforms)}};var Dp=y(),Xv=y(),sS=y(),q_=he.add,SZ=he.add3,Sh;(function(t){function e(r=2048,n=1024,o){let i=he.create(Float32Array,1,n,o?o.groupBuffer.ref.value:r),a=he.create(Float32Array,3,n,o?o.startBuffer.ref.value:r),s=he.create(Float32Array,3,n,o?o.endBuffer.ref.value:r),l=he.create(Float32Array,1,n,o?o.scaleBuffer.ref.value:r),c=he.create(Float32Array,1,n,o?o.capBuffer.ref.value:r),u=he.create(Float32Array,1,n,o?o.colorModeBuffer.ref.value:r),d=(p,h,f,b,v,x,S,T,E,_,D)=>{for(let P=0;P<6;++P)SZ(a,p,h,f),SZ(s,b,v,x),q_(i,D),q_(l,S),q_(c,(T?1:0)+(E?2:0)),q_(u,_)},m=(p,h,f,b,v,x,S,T,E)=>{let _=y.distance(p,h),D=f%2!==0,P=Math.floor((f+1)/2),A=_/(f+.5),I=2;y.setMagnitude(sS,y.sub(sS,h,p),A),y.copy(Dp,p);for(let k=0;k<P;++k)y.add(Dp,Dp,sS),D&&k===P-1?(y.copy(Xv,h),S||(x=!1)):y.add(Xv,Dp,sS),T&&(I=y.distance(p,Xv)/(_*2)),d(Dp[0],Dp[1],Dp[2],Xv[0],Xv[1],Xv[2],b,v,x,I,E),y.add(Dp,Dp,sS)};return{add:d,addFixedCountDashes:m,addFixedLengthDashes:(p,h,f,b,v,x,S,T)=>{let E=y.distance(p,h);m(p,h,E/f,b,v,x,!0,S,T)},getCylinders:()=>{let p=i.elementCount/6,h=he.compact(i,!0),f=he.compact(a,!0),b=he.compact(s,!0),v=he.compact(l,!0),x=he.compact(c,!0),S=he.compact(u,!0),T=o&&p<=o.cylinderCount?o.mappingBuffer.ref.value:new Float32Array(p*18),E=o&&p<=o.cylinderCount?o.indexBuffer.ref.value:new Uint32Array(p*12);return(!o||p>o.cylinderCount)&&o_e(p,T,E),xo.create(T,E,h,f,b,v,x,S,p,o)}}}t.create=e})(Sh||(Sh={}));function o_e(t,e,r){for(let n=0;n<t;++n){let o=n*18;e[o]=-1,e[o+1]=1,e[o+2]=-1,e[o+3]=-1,e[o+4]=-1,e[o+5]=-1,e[o+6]=1,e[o+7]=1,e[o+8]=-1,e[o+9]=1,e[o+10]=1,e[o+11]=1,e[o+12]=1,e[o+13]=-1,e[o+14]=-1,e[o+15]=1,e[o+16]=-1,e[o+17]=1}for(let n=0;n<t;++n){let o=n*6,i=n*12;r[i]=o,r[i+1]=o+1,r[i+2]=o+2,r[i+3]=o+1,r[i+4]=o+4,r[i+5]=o+2,r[i+6]=o+2,r[i+7]=o+4,r[i+8]=o+3,r[i+9]=o+4,r[i+10]=o+5,r[i+11]=o+3}}var wc={linkScale:g.Numeric(.45,{min:0,max:1,step:.01}),linkSpacing:g.Numeric(1,{min:0,max:2,step:.01}),linkCap:g.Boolean(!1),aromaticScale:g.Numeric(.3,{min:0,max:1,step:.01}),aromaticSpacing:g.Numeric(1.5,{min:0,max:3,step:.01}),aromaticDashCount:g.Numeric(2,{min:1,max:6,step:1}),dashCount:g.Numeric(4,{min:0,max:10,step:1}),dashScale:g.Numeric(.8,{min:0,max:2,step:.1}),dashCap:g.Boolean(!0),stubCap:g.Boolean(!0),radialSegments:g.Numeric(16,{min:2,max:56,step:2},ge.CustomQualityParamInfo),colorMode:g.Select("default",g.arrayToOptions(["default","interpolate"]),ge.ShadingCategory)},f3t=g.getDefaultValues(wc),FL={linkScale:g.Numeric(.5,{min:0,max:1,step:.1}),linkSpacing:g.Numeric(.1,{min:0,max:2,step:.01}),aromaticDashCount:g.Numeric(2,{min:1,max:6,step:1}),dashCount:g.Numeric(4,{min:0,max:10,step:1})},h3t=g.getDefaultValues(FL),dn=y(),Ch=y(),wu=y(),i_e=y.create(0,1,0);function NL(t,e,r,n){y.normalize(Ch,y.sub(Ch,e,r)),n!==null?y.sub(wu,e,n):y.copy(wu,e),y.normalize(wu,wu);let o=y.dot(Ch,wu);return 1-Math.abs(o)<1e-5&&(y.set(wu,1,0,0),o=y.dot(Ch,wu),1-Math.abs(o)<1e-5&&(y.set(wu,0,1,0),o=y.dot(Ch,wu))),y.setMagnitude(Ch,Ch,o),y.sub(wu,wu,Ch),y.normalize(t,wu)}var Rd=y.scale,lo=y.add,ri=y.sub,za=y.setMagnitude,a_e=y.dot;function jl(t,e,r,n){let{linkCount:o,referencePosition:i,position:a,style:s,radius:l,ignore:c,stub:u}=e;if(!o)return{mesh:Be.createEmpty(n)};let{linkScale:d,linkSpacing:m,radialSegments:p,linkCap:h,aromaticScale:f,aromaticSpacing:b,aromaticDashCount:v,dashCount:x,dashScale:S,dashCap:T,stubCap:E}=r,_=p*2*o*2,D=Te.createState(_,_/4,n),P=y(),A=y(),I=y(),k=y(),M=0,R={radiusTop:1,radiusBottom:1,radialSegments:p,topCap:h,bottomCap:h};for(let G=0,V=o;G<V;++G){if(c&&c(G))continue;a(P,A,G),lo(k,k,P),lo(k,k,A),M+=2,ri(dn,A,P);let H=a_e(dn,i_e)>0,Q=l(G),L=s?s(G):0,Y=E&&(u?u(G):!1),[j,O]=H?[Y,h]:[h,Y];if(D.currentGroup=G,L===0)R.radiusTop=R.radiusBottom=Q,R.topCap=j,R.bottomCap=O,nr(D,P,A,.5,R);else if(L===1)R.radiusTop=R.radiusBottom=Q*S,R.topCap=R.bottomCap=T,Xg(D,P,A,.5,x,Y,R);else if(L===2||L===3||L===4||L===5||L===7||L===8){let J=L===2||L===3?2:L===4||L===5?3:1.5,$=Q*(d/(.5*J)),ae=(Q-$)*m;if(NL(I,P,A,i?i(G):null),R.topCap=j,R.bottomCap=O,L===7||L===8){R.radiusTop=R.radiusBottom=Q,nr(D,P,A,.5,R);let Z=Q+f*Q+f*Q*b;za(dn,ri(dn,A,P),Q*.5),lo(P,P,dn),ri(A,A,dn),R.radiusTop=R.radiusBottom=Q*f,R.topCap=R.bottomCap=T,za(I,I,Z),ri(P,P,I),ri(A,A,I),Xg(D,P,A,.5,v,Y,R),L===8&&(za(I,I,Z*2),lo(P,P,I),lo(A,A,I),Xg(D,P,A,.5,v,Y,R))}else if(L===3||L===5){let Z=Q+$+d*Q*m;za(I,I,Z),R.radiusTop=R.radiusBottom=Q,nr(D,P,A,.5,R),Rd(dn,dn,m*d*.2),lo(P,P,dn),ri(A,A,dn),R.radiusTop=R.radiusBottom=$,R.topCap=H?Y:T,R.bottomCap=H?T:Y,za(I,I,Z),ri(P,P,I),ri(A,A,I),nr(D,P,A,.5,R),J===3&&(za(I,I,Z*2),lo(P,P,I),lo(A,A,I),nr(D,P,A,.5,R))}else za(I,I,ae),R.radiusTop=R.radiusBottom=$,J===3&&nr(D,P,A,.5,R),k7(D,P,A,.5,I,R)}else L===6&&(Rd(dn,dn,.475),lo(P,P,dn),ri(A,A,dn),R.radiusTop=R.radiusBottom=Q,R.topCap=j,R.bottomCap=O,nr(D,P,A,.5,R))}let B=n?te.clone(n.boundingSphere):void 0,F=Te.getMesh(D);return M===0?{mesh:F}:(y.scale(k,k,1/M),B&&y.distance(k,B.center)/B.radius<.1?{mesh:F,boundingSphere:B}:{mesh:F})}function W_(t,e,r,n){let{linkCount:o,referencePosition:i,position:a,style:s,radius:l,ignore:c,stub:u}=e;if(!o)return{cylinders:xo.createEmpty(n)};let{linkScale:d,linkSpacing:m,linkCap:p,aromaticScale:h,aromaticSpacing:f,aromaticDashCount:b,dashCount:v,dashScale:x,dashCap:S,stubCap:T,colorMode:E}=r,_=E==="interpolate",D=_===!0?3:2,P=o*2,A=Sh.create(P,P/4,n),I=y(),k=y(),M=y(),R=y(),B=y(),F=0;for(let H=0,Q=o;H<Q;++H){if(c&&c(H))continue;a(I,k,H),lo(B,B,I),lo(B,B,k),F+=2;let L=l(H),Y=s?s(H):0,j=T&&(u?u(H):!1);if(Y===0)Rd(M,lo(M,I,k),.5),A.add(I[0],I[1],I[2],M[0],M[1],M[2],1,p,j,D,H);else if(Y===1)Rd(M,lo(M,I,k),.5),A.addFixedCountDashes(I,M,v,x,S,S,j,_,H);else if(Y===2||Y===3||Y===4||Y===5||Y===7||Y===8){let O=Y===2||Y===3?2:Y===4||Y===5?3:1.5,J=d/(.5*O),$=(L-J*L)*m;if(Rd(M,lo(M,I,k),.5),NL(R,I,k,i?i(H):null),Y===7||Y===8){A.add(I[0],I[1],I[2],M[0],M[1],M[2],1,p,j,D,H);let ae=L+h*L+h*L*f;za(dn,ri(dn,k,I),L*.5),lo(I,I,dn),za(R,R,ae),ri(I,I,R),ri(M,M,R),A.addFixedCountDashes(I,M,b,h,S,S,j,_,H),Y===8&&(za(R,R,ae*2),lo(I,I,R),lo(M,M,R),A.addFixedCountDashes(I,M,b,h,S,S,j,_,H))}else if(Y===3||Y===5){let ae=L+J*L+d*L*m;za(R,R,ae),A.add(I[0],I[1],I[2],M[0],M[1],M[2],1,p,j,D,H),za(dn,ri(dn,I,M),L/1.5),ri(I,I,dn),O===3&&A.add(I[0]+R[0],I[1]+R[1],I[2]+R[2],M[0]+R[0],M[1]+R[1],M[2]+R[2],J,p,j,D,H),A.add(I[0]-R[0],I[1]-R[1],I[2]-R[2],M[0]-R[0],M[1]-R[1],M[2]-R[2],J,S,j,D,H)}else za(R,R,$),O===3&&A.add(I[0],I[1],I[2],M[0],M[1],M[2],J,p,j,D,H),A.add(I[0]+R[0],I[1]+R[1],I[2]+R[2],M[0]+R[0],M[1]+R[1],M[2]+R[2],J,p,j,D,H),A.add(I[0]-R[0],I[1]-R[1],I[2]-R[2],M[0]-R[0],M[1]-R[1],M[2]-R[2],J,p,j,D,H)}else Y===6&&(Rd(dn,ri(dn,M,I),.475),lo(I,I,dn),ri(M,M,dn),A.add(I[0],I[1],I[2],M[0],M[1],M[2],1,p,j,D,H))}let G=n?te.clone(n.boundingSphere):void 0,V=A.getCylinders();return F===0?{cylinders:V}:(y.scale(B,B,1/F),G&&y.distance(B,G.center)/G.radius<.1?{cylinders:V,boundingSphere:G}:{cylinders:V})}function X_(t,e,r,n){let{linkCount:o,referencePosition:i,position:a,style:s,ignore:l}=e;if(!o)return{lines:Sr.createEmpty(n)};let{linkScale:c,linkSpacing:u,aromaticDashCount:d,dashCount:m}=r,p=o*2,h=vi.create(p,p/4,n),f=y(),b=y(),v=y(),x=y(),S=y(),T=0,E=4.5,_=3;for(let A=0,I=o;A<I;++A){if(l&&l(A))continue;a(f,b,A),lo(S,S,f),lo(S,S,b),T+=2;let k=s?s(A):0;if(k===0)Rd(v,lo(v,f,b),.5),h.add(f[0],f[1],f[2],v[0],v[1],v[2],A);else if(k===1)Rd(v,lo(v,f,b),.5),h.addFixedCountDashes(f,v,m,A);else if(k===2||k===3||k===4||k===5||k===7||k===8){let M=k===2||k===3?2:k===4||k===5?3:1.5,B=(1-1*(c/(.5*M)))*u;if(Rd(v,lo(v,f,b),.5),NL(x,f,b,i?i(A):null),k===7||k===8){h.add(f[0],f[1],f[2],v[0],v[1],v[2],A);let F=B*E;za(dn,ri(dn,b,f),F*.5),lo(f,f,dn),za(x,x,F),ri(f,f,x),ri(v,v,x),h.addFixedCountDashes(f,v,d,A),k===8&&(za(x,x,F*2),lo(f,f,x),lo(v,v,x),h.addFixedCountDashes(f,v,d,A))}else k===3||k===5?(za(x,x,B*_),h.add(f[0],f[1],f[2],v[0],v[1],v[2],A),Rd(dn,ri(dn,f,v),u*c),ri(f,f,dn),M===3&&h.add(f[0]+x[0],f[1]+x[1],f[2]+x[2],v[0]+x[0],v[1]+x[1],v[2]+x[2],A),h.add(f[0]-x[0],f[1]-x[1],f[2]-x[2],v[0]-x[0],v[1]-x[1],v[2]-x[2],A)):(za(x,x,B*1.5),M===3&&h.add(f[0],f[1],f[2],v[0],v[1],v[2],A),h.add(f[0]+x[0],f[1]+x[1],f[2]+x[2],v[0]+x[0],v[1]+x[1],v[2]+x[2],A),h.add(f[0]-x[0],f[1]-x[1],f[2]-x[2],v[0]-x[0],v[1]-x[1],v[2]-x[2],A))}else k===6&&(Rd(dn,ri(dn,v,f),.475),lo(f,f,dn),ri(v,v,dn),h.add(f[0],f[1],f[2],v[0],v[1],v[2],A))}let D=n?te.clone(n.boundingSphere):void 0,P=h.getLines();return T===0?{lines:P}:(y.scale(S,S,1/T),D&&y.distance(S,D.center)/D.radius<.1?{lines:P,boundingSphere:D}:{lines:P})}var Y_={sizeFactor:g.Numeric(.3,{min:0,max:10,step:.01}),dashCount:g.Numeric(6,{min:1,max:10,step:1}),dashScale:g.Numeric(.4,{min:0,max:2,step:.1}),ignoreHydrogens:g.Boolean(!1),ignoreHydrogensVariant:g.Select("all",g.arrayToOptions(["all","non-polar"])),includeParent:g.Boolean(!1),parentDisplay:g.Select("stub",g.arrayToOptions(["stub","full","between"]),{description:'Only has an effect when "includeParent" is enabled. "Stub" shows just the child side of interactions to the parent. "Full" shows both sides of interactions to the parent. "Between" shows only interactions to the parent.'})};function s_e(t,e,r,n,o,i){return N(this,null,function*(){if(!Pe.isAtomic(e))return Be.createEmpty(i);let{child:a}=r,s=a?.unitMap.get(e.id);if(a&&!s)return Be.createEmpty(i);let l=z.Location.create(r,e),c=Mn.get(r).value,u=c.unitsFeatures.get(e.id),d=c.unitsContacts.get(e.id),{x:m,y:p,z:h,members:f,offsets:b}=u,{edgeCount:v,a:x,b:S,edgeProps:{flag:T,type:E}}=d,{sizeFactor:_,ignoreHydrogens:D,ignoreHydrogensVariant:P,parentDisplay:A}=o;if(!v)return Be.createEmpty(i);let{elements:I,conformation:k}=e,M=y(),R=y(),B=y(),F={linkCount:v*2,position:(H,Q,L)=>{let Y=E[L];if((!D||P!=="all")&&(Y===$t.HydrogenBond||Y===$t.WeakHydrogenBond)){let j=f[b[x[L]]],O=f[b[S[L]]];k.invariantPosition(I[j],R),k.invariantPosition(I[O],B);let J=y.distance(R,B),$=J;y.copy(H,R),y.copy(Q,B),T_(e,j,(ae,Z)=>{if(sl(r,e,I[Z],"polar")){k.invariantPosition(I[Z],M);let se=y.distance(M,B);se<J&&(J=se,y.copy(H,M))}}),T_(e,O,(ae,Z)=>{if(sl(r,e,I[Z],"polar")){k.invariantPosition(I[Z],M);let se=y.distance(M,R);se<$&&($=se,y.copy(Q,M))}})}else y.set(H,m[x[L]],p[x[L]],h[x[L]]),y.set(Q,m[S[L]],p[S[L]],h[S[L]])},style:H=>1,radius:H=>{l.element=I[f[b[x[H]]]];let Q=n.size.size(l);l.element=I[f[b[S[H]]]];let L=n.size.size(l);return Math.min(Q,L)*_},ignore:H=>{if(T[H]===Gl.Filtered)return!0;if(s)if(A==="stub"){let Q=x[H];for(let L=b[Q],Y=b[Q+1];L<Y;++L){let j=I[f[b[L]]];if(!tr.has(s.elements,j))return!0}}else if(A==="full"||A==="between"){let Q=!1,L=!1,Y=x[H];for(let O=b[Y],J=b[Y+1];O<J;++O){let $=I[f[b[O]]];tr.has(s.elements,$)||(Q=!0)}let j=S[H];for(let O=b[j],J=b[j+1];O<J;++O){let $=I[f[b[O]]];tr.has(s.elements,$)||(L=!0)}return A==="full"?Q&&L:Q===L}else ur(A);return!1}},{mesh:G,boundingSphere:V}=jl(t,F,o,i);if(V)G.setBoundingSphere(V);else if(G.triangleCount>0){let H=te.expand(te(),(s??e).boundary.sphere,1*_);G.setBoundingSphere(H)}return G})}var zL=w(w(w({},Gr),wc),Y_);function CZ(t){return rn({defaultProps:g.getDefaultValues(zL),createGeometry:s_e,createLocationIterator:u_e,getLoci:l_e,eachLocation:c_e,setUpdateState:(e,r,n,o,i,a,s)=>{e.createGeometry=r.sizeFactor!==n.sizeFactor||r.dashCount!==n.dashCount||r.dashScale!==n.dashScale||r.dashCap!==n.dashCap||r.radialSegments!==n.radialSegments||r.ignoreHydrogens!==n.ignoreHydrogens||r.ignoreHydrogensVariant!==n.ignoreHydrogensVariant||r.parentDisplay!==n.parentDisplay;let l=Mn.get(a.structure).version;e.info.interactionsHash!==l&&(e.createGeometry=!0,e.updateTransform=!0,e.updateColor=!0,e.info.interactionsHash=l)}},t)}function l_e(t,e,r){let{objectId:n,instanceId:o,groupId:i}=t;if(r===n){let{structure:a,group:s}=e,l=a.unitMap.get(s.units[o].id),c=Mn.get(a).value,{a:u,b:d}=c.unitsContacts.get(l.id);return Cu.Loci(a,c,[{unitA:l,indexA:u[i],unitB:l,indexB:d[i]},{unitA:l,indexA:d[i],unitB:l,indexB:u[i]}])}return St}var VL=new Set;function c_e(t,e,r,n){let o=!1;if(Cu.isLoci(t)){let{structure:i,group:a}=e;if(!ue.areEquivalent(t.data.structure,i))return!1;let s=Mn.get(i).value;if(t.data.interactions!==s)return!1;let l=a.units[0],c=s.unitsContacts.get(l.id),u=c.edgeCount*2;for(let d of t.elements){if(d.unitA!==d.unitB)continue;let m=a.unitIndexMap.get(d.unitA.id);if(m!==void 0){let p=c.getDirectedEdgeIndex(d.indexA,d.indexB);p!==-1&&r(Oe.ofSingleton(m*u+p))&&(o=!0)}}}else if(z.Loci.is(t)){let{structure:i,group:a}=e;if(!ue.areEquivalent(t.structure,i))return!1;let s=Mn.get(i).value;if(!s)return!1;let l=a.units[0],c=s.unitsContacts.get(l.id),u=s.unitsFeatures.get(l.id),d=c.edgeCount*2,{offset:m}=c,{offsets:p,indices:h}=u.elementsIndex,{members:f,offsets:b}=u;for(let v of t.elements){let x=a.unitIndexMap.get(v.unit.id);x!==void 0&&(we.forEach(v.indices,S=>{for(let T=p[S],E=p[S+1];T<E;++T){let _=h[T];for(let D=m[_],P=m[_+1];D<P;++D)VL.add(D)}}),VL.forEach(S=>{if(n){let T=c.a[S];for(let _=b[T],D=b[T+1];_<D;++_)if(!we.has(v.indices,f[_]))return;let E=c.b[S];for(let _=b[E],D=b[E+1];_<D;++_)if(!we.has(v.indices,f[_]))return}r(Oe.ofSingleton(x*d+S))&&(o=!0)}),VL.clear())}}return o}function u_e(t){let{structure:e,group:r}=t,n=r.units[0],o=Mn.get(e).value,i=o.unitsContacts.get(n.id),a=i.edgeCount*2,s=r.units.length,l=Cu.Location(o,e),{element:c}=l;return jt(a,s,1,(d,m)=>{let p=r.units[m];return c.unitA=p,c.indexA=i.a[d],c.unitB=p,c.indexB=i.b[d],l})}function d_e(t,e,r,n,o){if(!e.hasAtomic)return Be.createEmpty(o);let i=z.Location.create(e),a=Mn.get(e).value,{contacts:s,unitsFeatures:l}=a,{edgeCount:c,edges:u}=s,{sizeFactor:d,ignoreHydrogens:m,ignoreHydrogensVariant:p,parentDisplay:h}=n;if(!c)return Be.createEmpty(o);let{child:f}=e,b=y(),v=y(),x=y(),S={linkCount:c,position:(_,D,P)=>{let{unitA:A,indexA:I,unitB:k,indexB:M,props:{type:R}}=u[P],B=l.get(A),F=l.get(k),G=e.unitMap.get(A),V=e.unitMap.get(k);if((!m||p!=="all")&&(R===$t.HydrogenBond||R===$t.WeakHydrogenBond)){let H=B.members[B.offsets[I]],Q=F.members[F.offsets[M]];G.conformation.position(G.elements[H],v),V.conformation.position(V.elements[Q],x);let L=y.distance(v,x),Y=L;y.copy(_,v),y.copy(D,x),Si(e,G,H,(j,O)=>{let J=j.elements[O];if(sl(e,j,J,"polar")){j.conformation.position(J,b);let $=y.distance(b,x);$<L&&(L=$,y.copy(_,b))}}),Si(e,V,Q,(j,O)=>{let J=j.elements[O];if(sl(e,j,J,"polar")){j.conformation.position(J,b);let $=y.distance(b,v);$<Y&&(Y=$,y.copy(D,b))}})}else y.set(_,B.x[I],B.y[I],B.z[I]),y.transformMat4(_,_,G.conformation.operator.matrix),y.set(D,F.x[M],F.y[M],F.z[M]),y.transformMat4(D,D,V.conformation.operator.matrix)},style:_=>1,radius:_=>{let D=u[_],P=l.get(D.unitA);i.unit=e.unitMap.get(D.unitA),i.element=i.unit.elements[P.members[P.offsets[D.indexA]]];let A=r.size.size(i),I=l.get(D.unitB);i.unit=e.unitMap.get(D.unitB),i.element=i.unit.elements[I.members[I.offsets[D.indexB]]];let k=r.size.size(i);return Math.min(A,k)*d},ignore:_=>{if(u[_].props.flag===Gl.Filtered)return!0;if(f){let D=u[_];if(h==="stub"){let P=f.unitMap.get(D.unitA);if(!P)return!0;let A=e.unitMap.get(D.unitA),{offsets:I,members:k}=l.get(D.unitA);for(let M=I[D.indexA],R=I[D.indexA+1];M<R;++M){let B=A.elements[k[M]];if(!tr.has(P.elements,B))return!0}}else if(h==="full"||h==="between"){let P=!1,A=!1,I=f.unitMap.get(D.unitA);if(!I)P=!0;else{let M=e.unitMap.get(D.unitA),{offsets:R,members:B}=l.get(D.unitA);for(let F=R[D.indexA],G=R[D.indexA+1];F<G;++F){let V=M.elements[B[F]];tr.has(I.elements,V)||(P=!0)}}let k=f.unitMap.get(D.unitB);if(!k)A=!0;else{let M=e.unitMap.get(D.unitB),{offsets:R,members:B}=l.get(D.unitB);for(let F=R[D.indexB],G=R[D.indexB+1];F<G;++F){let V=M.elements[B[F]];tr.has(k.elements,V)||(A=!0)}}return h==="full"?P&&A:P===A}else ur(h)}return!1}},{mesh:T,boundingSphere:E}=jl(t,S,n,o);if(E)T.setBoundingSphere(E);else if(T.triangleCount>0){let{child:_}=e,D=te.expand(te(),(_??e).boundary.sphere,1*d);T.setBoundingSphere(D)}return T}var GL=w(w(w({},Tu),wc),Y_);function TZ(t){return Va({defaultProps:g.getDefaultValues(GL),createGeometry:d_e,createLocationIterator:f_e,getLoci:m_e,eachLocation:p_e,setUpdateState:(e,r,n,o,i,a,s)=>{e.createGeometry=r.sizeFactor!==n.sizeFactor||r.dashCount!==n.dashCount||r.dashScale!==n.dashScale||r.dashCap!==n.dashCap||r.radialSegments!==n.radialSegments||r.ignoreHydrogens!==n.ignoreHydrogens||r.ignoreHydrogensVariant!==n.ignoreHydrogensVariant||r.parentDisplay!==n.parentDisplay;let l=Mn.get(a).version;e.info.interactionsHash!==l&&(e.createGeometry=!0,e.updateTransform=!0,e.updateColor=!0,e.info.interactionsHash=l)}},t)}function m_e(t,e,r){let{objectId:n,groupId:o}=t;if(r===n){let i=Mn.get(e).value,a=i.contacts.edges[o],s=e.unitMap.get(a.unitA),l=e.unitMap.get(a.unitB);return Cu.Loci(e,i,[{unitA:s,indexA:a.indexA,unitB:l,indexB:a.indexB},{unitA:l,indexA:a.indexB,unitB:s,indexB:a.indexA}])}return St}var Q_=new Map,UL=new Set;function p_e(t,e,r,n){let o=!1;if(Cu.isLoci(t)){if(!ue.areEquivalent(t.data.structure,e))return!1;let i=Mn.get(e).value;if(t.data.interactions!==i)return!1;let{contacts:a}=i;for(let s of t.elements){let l=a.getEdgeIndex(s.indexA,s.unitA.id,s.indexB,s.unitB.id);l!==-1&&r(Oe.ofSingleton(l))&&(o=!0)}}else if(z.Loci.is(t)){if(!ue.areEquivalent(t.structure,e)||n&&t.elements.length===1)return!1;let i=Mn.get(e).value;if(!i)return!1;let{contacts:a,unitsFeatures:s}=i;for(let l of t.elements)Q_.set(l.unit.id,l.indices);for(let l of t.elements){let{unit:c}=l;Pe.isAtomic(c)&&we.forEach(l.indices,u=>{for(let d of a.getContactIndicesForElement(u,c))UL.add(d)})}UL.forEach(l=>{if(n){let{indexA:c,unitA:u,indexB:d,unitB:m}=a.edges[l],p=Q_.get(u),h=Q_.get(m);if(!p||!h)return;let{offsets:f,members:b}=s.get(u);for(let S=f[c],T=f[c+1];S<T;++S)if(!we.has(p,b[S]))return;let{offsets:v,members:x}=s.get(m);for(let S=v[d],T=v[d+1];S<T;++S)if(!we.has(h,x[S]))return}r(Oe.ofSingleton(l))&&(o=!0)}),Q_.clear(),UL.clear()}return o}function f_e(t){let e=Mn.get(t).value,{contacts:r}=e,n=r.edgeCount,o=1,i=Cu.Location(e,t),{element:a}=i;return jt(n,o,1,l=>{let c=r.edges[l];return a.unitA=t.unitMap.get(c.unitA),a.indexA=c.indexA,a.unitB=t.unitMap.get(c.unitB),a.indexB=c.indexB,i},!0)}var wZ={"intra-unit":(t,e)=>Dr("Intra-unit interactions cylinder",t,e,CZ),"inter-unit":(t,e)=>_o("Inter-unit interactions cylinder",t,e,TZ)},_Z=U(w(w({},zL),GL),{unitKinds:Ip(["atomic"]),sizeFactor:g.Numeric(.2,{min:.01,max:1,step:.01}),visuals:g.MultiSelect(["intra-unit","inter-unit"],g.objectToOptions(wZ))});function h_e(t,e){return g.clone(_Z)}function g_e(t,e){return rt.createMulti("Interactions",t,e,Qr,wZ)}var Yv={name:"interactions",label:"Non-covalent Interactions",description:"Displays non-covalent interactions as dashed cylinders.",factory:g_e,getParams:h_e,defaultValues:g.getDefaultValues(_Z),defaultColorTheme:{name:"interaction-type"},defaultSizeTheme:{name:"uniform"},isApplicable:t=>t.elementCount>0&&Mn.isApplicable(t),ensureCustomProperties:{attach:(t,e)=>Mn.attach(t,e,void 0,!0),detach:t=>Mn.ref(t,!1)},getData:(t,e)=>e.includeParent?t.asParent():t,mustRecreate:(t,e)=>t.includeParent!==e.includeParent};var PZ=rr.create({name:"computed-interactions-prop",category:"custom-props",display:{name:"Interactions"},ctor:class extends rr.Handler{constructor(){super(...arguments),this.provider=Mn,this.labelProvider={label:t=>{if(this.params.showTooltip)switch(t.kind){case"element-loci":if(t.elements.length===0)return;let e=[],r=this.getStructures(t.structure);for(let n of r){let o=this.provider.get(n).value;if(!o)continue;let i=z.Loci.remap(t,n);if(i.elements.length!==1)continue;let a=i.elements[0];if(we.size(a.indices)!==1)continue;let s=o.unitsFeatures.get(a.unit.id);if(!s)continue;let l=[],c=[],u=[],d=we.start(a.indices),{types:m,groups:p,elementsIndex:{indices:h,offsets:f}}=s;for(let b=f[d],v=f[d+1];b<v;++b){let x=h[b],S=m[x],T=p[x];S&&l.push($K(S)),T&&c.push(ZK(T))}l.length&&u.push(`<small>Types</small> ${l.join(", ")}`),c.length&&u.push(`<small>Groups</small> ${c.join(", ")}`),u.length&&e.push(`Interaction Feature: ${u.join(" | ")}`)}return e.length?e.join("<br/>"):void 0;default:return}}}}getStructures(t){let e=[],r=this.ctx.helpers.substructureParent.get(t);if(r){let o=this.ctx.state.data.select(lt.Generators.ofType(X.Molecule.Structure,r.transform.ref));for(let i of o)i.obj&&Mo(e,i.obj.data)}return e}update(t){let e=this.params.autoAttach!==t.autoAttach||this.params.showTooltip!==t.showTooltip;return this.params.autoAttach=t.autoAttach,this.params.showTooltip=t.showTooltip,this.ctx.customStructureProperties.setDefaultAutoAttach(this.provider.descriptor.name,this.params.autoAttach),e}register(){this.ctx.customStructureProperties.register(this.provider,this.params.autoAttach),this.ctx.representation.structure.themes.colorThemeRegistry.add(aS),this.ctx.managers.lociLabels.addProvider(this.labelProvider),this.ctx.representation.structure.registry.add(Yv)}unregister(){this.ctx.customStructureProperties.unregister(this.provider.descriptor.name),this.ctx.representation.structure.themes.colorThemeRegistry.remove(aS),this.ctx.managers.lociLabels.removeProvider(this.labelProvider),this.ctx.representation.structure.registry.remove(Yv)}},params:()=>({autoAttach:g.Boolean(!1),showTooltip:g.Boolean(!0)})});var EZ=rr.create({name:"computed-secondary-structure-prop",category:"custom-props",display:{name:"Secondary Structure"},ctor:class extends rr.Handler{constructor(){super(...arguments),this.provider=xs}update(t){let e=this.params.autoAttach!==t.autoAttach;return this.params.autoAttach=t.autoAttach,this.ctx.customStructureProperties.setDefaultAutoAttach(this.provider.descriptor.name,this.params.autoAttach),e}register(){this.ctx.customStructureProperties.register(this.provider,this.params.autoAttach)}unregister(){this.ctx.customStructureProperties.unregister(this.provider.descriptor.name)}},params:()=>({autoAttach:g.Boolean(!1)})});var IZ=rr.create({name:"computed-valence-model-prop",category:"custom-props",display:{name:"Valence Model"},ctor:class extends rr.Handler{constructor(){super(...arguments),this.provider=wm,this.labelProvider={label:t=>{if(this.params.showTooltip)switch(t.kind){case"element-loci":if(t.elements.length===0)return;let e=[],r=this.getStructures(t.structure);for(let n of r){let o=this.provider.get(n).value;if(!o)continue;let i=z.Loci.remap(t,n);if(i.elements.length!==1)continue;let a=i.elements[0];if(we.size(a.indices)!==1)continue;let s=o.get(a.unit.id);if(!s)continue;let l=we.start(a.indices),c=s.charge[l],u=s.idealGeometry[l],d=s.implicitH[l],m=s.totalH[l];e.push(`Valence Model: <small>Charge</small> ${c} | <small>Ideal Geometry</small> ${QK(u)} | <small>Implicit H</small> ${d} | <small>Total H</small> ${m}`)}return e.length?e.join("<br/>"):void 0;default:return}}}}getStructures(t){let e=[],r=this.ctx.helpers.substructureParent.get(t);if(r){let o=this.ctx.state.data.select(lt.Generators.ofType(X.Molecule.Structure,r.transform.ref));for(let i of o)i.obj&&Mo(e,i.obj.data)}return e}update(t){let e=this.params.autoAttach!==t.autoAttach||this.params.showTooltip!==t.showTooltip;return this.params.autoAttach=t.autoAttach,this.params.showTooltip=t.showTooltip,this.ctx.customStructureProperties.setDefaultAutoAttach(this.provider.descriptor.name,this.params.autoAttach),e}register(){this.ctx.customStructureProperties.register(this.provider,this.params.autoAttach),this.ctx.managers.lociLabels.addProvider(this.labelProvider)}unregister(){this.ctx.customStructureProperties.unregister(this.provider.descriptor.name),this.ctx.managers.lociLabels.removeProvider(this.labelProvider)}},params:()=>({autoAttach:g.Boolean(!1),showTooltip:g.Boolean(!0)})});var jL=ce(16448250),y_e="Assigns a color based on SIFTS mapping.",lS=new Map,DZ=w({},Dn({type:"colors",colorList:"set-1"}));function v_e(t){return DZ}function AZ(t,e){let r;if(t.structure){for(let s of t.structure.models){let l=cc.Provider.get(s).value;if(l)for(let c of l.accession)!c||lS.has(c)||lS.set(c,lS.size)}let n=z.Location.create(t.structure),o=zn(lS.size+1,e,{valueLabel:s=>`${s}`}),i=new Map,a=s=>{let l=cc.getKey(s);if(!l)return jL;if(i.has(l))return i.get(l);let c=o.color(lS.get(l));return i.set(l,c),c};r=s=>z.Location.is(s)&&Pe.isAtomic(s.unit)?a(s):ze.isLocation(s)?(n.unit=s.aUnit,n.element=s.aUnit.elements[s.aIndex],a(n)):jL}else r=()=>jL;return{factory:AZ,granularity:"group",preferSmoothing:!0,color:r,props:e,description:y_e}}var HL={name:"sifts-mapping",label:"SIFTS Mapping",category:wo.Category.Residue,factory:AZ,getParams:v_e,defaultValues:g.getDefaultValues(DZ),isApplicable:t=>{var e;return!!(!((e=t.structure)===null||e===void 0)&&e.models.some(r=>cc.Provider.isApplicable(r)))},ensureCustomProperties:{attach:(t,e)=>N(void 0,null,function*(){if(e.structure)for(let r of e.structure.models)yield cc.Provider.attach(t,r,void 0,!0)}),detach:t=>{if(t.structure)for(let e of t.structure.models)cc.Provider.ref(e,!1)}}};var kZ=rr.create({name:"sifts-mapping-prop",category:"custom-props",display:{name:"SIFTS Mapping"},ctor:class extends rr.Handler{constructor(){super(...arguments),this.provider=cc.Provider,this.labelProvider={label:t=>{if(this.params.showTooltip)return b_e(t)}}}update(t){let e=this.params.autoAttach!==t.autoAttach||this.params.showTooltip!==t.showTooltip;return this.params.autoAttach=t.autoAttach,this.params.showTooltip=t.showTooltip,this.ctx.customStructureProperties.setDefaultAutoAttach(this.provider.descriptor.name,this.params.autoAttach),e}register(){this.ctx.customModelProperties.register(this.provider,this.params.autoAttach),this.ctx.representation.structure.themes.colorThemeRegistry.add(HL),this.ctx.managers.lociLabels.addProvider(this.labelProvider)}unregister(){this.ctx.customModelProperties.unregister(this.provider.descriptor.name),this.ctx.representation.structure.themes.colorThemeRegistry.remove(HL),this.ctx.managers.lociLabels.removeProvider(this.labelProvider)}},params:()=>({autoAttach:g.Boolean(!0),showTooltip:g.Boolean(!0)})});function b_e(t){if(t.kind==="element-loci"){if(t.elements.length===0)return;let e=t.elements[0],r=e.unit,n=z.Location.create(t.structure,r,r.elements[we.getAt(e.indices,0)]);return cc.getLabel(n)}}var Ld;(function(t){t.Descriptor={name:"ihm_cross_link_restraint"},t.Provider=PT.create(t.Descriptor);function e(r,n){let o={entity_id:r.entity_id_1,asym_id:r.asym_id_1,seq_id:r.seq_id_1,atom_id:r.atom_id_1},i={entity_id:r.entity_id_2,asym_id:r.asym_id_2,seq_id:r.seq_id_2,atom_id:r.atom_id_2};function a(p,h,f){let b=p.get(h);b?b.push(f):p.set(h,[f])}function s(p,h){let f=h.entity_id.value(p),b=h.asym_id.value(p),v=h.seq_id.value(p);if(r.model_granularity.value(p)==="by-atom"){let x=n.atomicHierarchy.index.findAtom({auth_seq_id:v,label_asym_id:b,label_atom_id:h.atom_id.value(p),label_entity_id:f});x>=0&&a(c,x,p)}else if(n.coarseHierarchy.isDefined){let x=n.coarseHierarchy.spheres.findSequenceKey(f,b,v);if(x>=0)a(u,x,p);else{let S=n.coarseHierarchy.gaussians.findSequenceKey(f,b,v);S>=0&&a(d,S,p)}}}function l(p){switch(p){case 0:return c;case 1:return u;case 2:return d}}let c=new Map,u=new Map,d=new Map,m=[];for(let p=0;p<r._rowCount;++p)s(p,o),s(p,i);return{getIndicesByElement:(p,h)=>{let b=l(h).get(p);return b!==void 0?b:m},data:r}}t.fromTable=e})(Ld||(Ld={}));var x_e=[];function MZ(t,e,r,n){return`${t}|${e.id}|${r}|${n.id}`}var cS=class{getPairIndices(e,r,n,o){let i=MZ(e,r,n,o);return this.pairKeyIndices.get(i)||x_e}getPairs(e,r,n,o){return this.getPairIndices(e,r,n,o).map(a=>this.pairs[a])}constructor(e){this.pairs=e;let r=new Map;this.pairs.forEach((n,o)=>{let i=MZ(n.indexA,n.unitA,n.indexB,n.unitB),a=r.get(i);a?a.push(o):r.set(i,[o])}),this.count=e.length,this.pairKeyIndices=r}};var Bd=gf.createProvider({label:"Cross Link Restraint",descriptor:Xc({name:"integrative-cross-link-restraint"}),type:"local",defaultParams:{},getParams:t=>({}),isApplicable:t=>t.models.some(e=>!!Ld.Provider.get(e)),obtain:(t,e,r)=>N(void 0,null,function*(){return{value:T_e(e)}})});var _c;(function(t){let e;(function(f){f.CrossLinkRestraint="cross-link-restraint"})(e=t.Tag||(t.Tag={}));function r(f){return f.models.some(b=>!!Ld.Provider.get(b))}t.isApplicable=r;let n=y(),o=y();function i(f){return f.unitA.conformation.position(f.unitA.elements[f.indexA],n),f.unitB.conformation.position(f.unitB.elements[f.indexB],o),y.distance(n,o)}t.distance=i;function a(f,b,v){return NT("cross-link-restraints",{structure:b,crossLinkRestraints:f},v)}t.Location=a;function s(f){return!!f&&f.kind==="data-location"&&f.tag==="cross-link-restraints"}t.isLocation=s;function l(f,b){return f.data.structure===b.data.structure&&f.data.crossLinkRestraints===b.data.crossLinkRestraints&&f.element===b.element}t.areLocationsEqual=l;function c(f,b){let v=f.pairs[b];return`Cross Link Restraint | Type: ${v.restraintType} | Threshold: ${v.distanceThreshold} \u212B | Psi: ${v.psi} | Sigma 1: ${v.sigma1} | Sigma 2: ${v.sigma2} | Distance: ${i(v).toFixed(2)} \u212B`}function u(f){return c(f.data.crossLinkRestraints,f.element)}t.locationLabel=u;function d(f,b,v){return Sf("cross-link-restraints",{structure:f,crossLinkRestraints:b},v,x=>p(b,v,x),()=>h(f,b,v))}t.Loci=d;function m(f){return!!f&&f.kind==="data-loci"&&f.tag==="interactions"}t.isLoci=m;function p(f,b,v){return np.fromPairProvider(b.length,(x,S,T)=>{let E=f.pairs[b[x]];E.unitA.conformation.position(E.unitA.elements[E.indexA],S),E.unitB.conformation.position(E.unitB.elements[E.indexB],T)},v)}t.getBoundingSphere=p;function h(f,b,v){let x=v[0];if(x===void 0)return"";let S=b.pairs[x];return[c(b,x),F1(ze.Location(f,S.unitA,S.indexA,f,S.unitB,S.indexB))].join("</br>")}t.getLabel=h})(_c||(_c={}));function RZ(t,e,r){let{elements:n}=e,o=n.length,i=e.kind;for(let a=0;a<o;a++){let s=n[a];r.getIndicesByElement(s,i).forEach(l=>t.set(l,a))}}function S_e(t,e,r){if(e.model!==r.model||e.model.sourceData.kind!=="mmCIF")return;let n=Ld.Provider.get(e.model);if(!n)return;let o=new Map,i=new Map;RZ(o,e,n),RZ(i,r,n),o.forEach((a,s)=>{let l=i.get(s);l!==void 0&&t.push(K_(e,a,r,l,n,s),K_(r,l,e,a,n,s))})}function C_e(t,e){if(e.model.sourceData.kind!=="mmCIF")return;let r=Ld.Provider.get(e.model);if(!r)return;let{elements:n}=e,o=n.length,i=e.kind,a=new Map;for(let s=0;s<o;s++){let l=n[s];r.getIndicesByElement(l,i).forEach(c=>{let u=a.get(c);u?u.push(s):a.set(c,[s])})}a.forEach((s,l)=>{if(s.length<2)return;let[c,u]=s;t.push(K_(e,c,e,u,r,l),K_(e,u,e,c,r,l))})}function K_(t,e,r,n,o,i){return{unitA:t,indexA:e,unitB:r,indexB:n,restraintType:o.data.restraint_type.value(i),distanceThreshold:o.data.distance_threshold.value(i),psi:o.data.psi.value(i),sigma1:o.data.sigma_1.value(i),sigma2:o.data.sigma_2.value(i)}}function T_e(t){let e=[];if(!t.models.some(n=>Ld.Provider.get(n)))return new cS(e);let r=t.units.length;for(let n=0;n<r;++n){let o=t.units[n];C_e(e,o);for(let i=n+1;i<r;++i){let a=t.units[i];o.model===a.model&&S_e(e,o,a)}}return new cS(e)}function w_e(t,e,r,n,o){let i=Bd.get(e).value;if(!i.count)return Be.createEmpty(o);let{sizeFactor:a}=n,s=z.Location.create(e),l={linkCount:i.count,position:(d,m,p)=>{let h=i.pairs[p],f=h.unitA,b=h.unitB;f.conformation.position(f.elements[h.indexA],d),b.conformation.position(b.elements[h.indexB],m)},radius:d=>{let m=i.pairs[d];return s.unit=m.unitA,s.element=m.unitA.elements[m.indexA],r.size.size(s)*a}},{mesh:c,boundingSphere:u}=jl(t,l,n,o);if(u)c.setBoundingSphere(u);else if(c.triangleCount>0){let d=te.expand(te(),e.boundary.sphere,1*a);c.setBoundingSphere(d)}return c}var LZ=U(w(w({},Tu),wc),{sizeFactor:g.Numeric(.5,{min:0,max:10,step:.1})});function __e(t){return Va({defaultProps:g.getDefaultValues(LZ),createGeometry:w_e,createLocationIterator:P_e,getLoci:E_e,eachLocation:I_e,setUpdateState:(e,r,n)=>{e.createGeometry=r.sizeFactor!==n.sizeFactor||r.radialSegments!==n.radialSegments||r.linkCap!==n.linkCap}},t)}function P_e(t){let e=Bd.get(t).value,{pairs:r}=e,n=r.length,o=1,i=_c.Location(e,t);return jt(n,o,1,s=>(i.element=s,i),!0)}function E_e(t,e,r){let{objectId:n,groupId:o}=t;if(r===n){let i=Bd.get(e).value;if(i.pairs[o])return _c.Loci(e,i,[o])}return St}function I_e(t,e,r){let n=!1;if(_c.isLoci(t)){if(!ue.areEquivalent(t.data.structure,e))return!1;let o=Bd.get(e).value;if(t.data.crossLinkRestraints!==o)return!1;for(let i of t.elements)r(Oe.ofSingleton(i))&&(n=!0)}return n}var D_e={"cross-link-restraint":(t,e)=>_o("Cross-link restraint",t,e,__e)},BZ=w({},LZ);function A_e(t,e){return g.clone(BZ)}function k_e(t,e){return rt.createMulti("CrossLinkRestraint",t,e,Qr,D_e)}var qL={name:_c.Tag.CrossLinkRestraint,label:"Cross Link Restraint",description:"Displays cross-link restraints.",factory:k_e,getParams:A_e,defaultValues:g.getDefaultValues(BZ),defaultColorTheme:{name:_c.Tag.CrossLinkRestraint},defaultSizeTheme:{name:"uniform"},isApplicable:t=>_c.isApplicable(t),ensureCustomProperties:{attach:(t,e)=>Bd.attach(t,e,void 0,!0),detach:t=>Bd.ref(t,!1)}};var OZ=ce(13421772),M_e="Colors cross-links by the deviation of the observed distance versus the modeled distance (e.g. modeled / `ihm_cross_link_restraint.distance_threshold`).",FZ={domain:g.Interval([.5,1.5],{step:.01}),list:g.ColorList("red-grey",{presetKind:"scale"})};function R_e(t){return FZ}function NZ(t,e){let r,n,o=t.structure&&Bd.get(t.structure).value;if(o){n=ki.create({domain:e.domain,listOrName:e.list.colors});let i=n.color;r=a=>{if(_c.isLocation(a)){let s=o.pairs[a.element];if(s)return i(_c.distance(s)/s.distanceThreshold)}return OZ}}else r=()=>OZ;return{factory:NZ,granularity:"group",color:r,props:e,description:M_e,legend:n?n.legend:void 0}}var WL={name:"cross-link",label:"Cross Link",category:wo.Category.Misc,factory:NZ,getParams:R_e,defaultValues:g.getDefaultValues(FZ),isApplicable:t=>!!t.structure&&_c.isApplicable(t.structure),ensureCustomProperties:{attach:(t,e)=>e.structure?Bd.attach(t,e.structure,void 0,!0):Promise.resolve(),detach:t=>t.structure&&Bd.ref(t.structure,!1)}};var VZ=rr.create({name:"integrative-cross-link-restraint",category:"custom-props",display:{name:"Cross Link Restraint"},ctor:class extends rr.Handler{constructor(){super(...arguments),this.provider=Ld.Provider}register(){this.provider.formatRegistry.add("mmCIF",L_e),this.ctx.representation.structure.themes.colorThemeRegistry.add(WL),this.ctx.representation.structure.registry.add(qL)}unregister(){this.provider.formatRegistry.remove("mmCIF"),this.ctx.representation.structure.themes.colorThemeRegistry.remove(WL),this.ctx.representation.structure.registry.remove(qL)}}});function L_e(t){if(!op.is(t.sourceData))return;let{ihm_cross_link_restraint:e}=t.sourceData.data.db;if(e._rowCount!==0)return Ld.fromTable(e,t)}var uS={State:GR,Representation:HR,Camera:qR,Misc:oL},cl={Representation:aL,Camera:cL,CustomProps:XL};function Qv(t,e,r={}){let n=r;return typeof n.type=="string"||typeof n.color=="string"||typeof n.size=="string"?B_e(t,e||ue.Empty,r):UZ(t,e||ue.Empty,r)}function zZ(t,e){let{themes:r}=t.representation.structure;return e?r.colorThemeRegistry.getApplicableTypes({structure:e}):r.colorThemeRegistry.types}function dS(t,e,r,n,o){let{registry:i,themes:a}=t.representation.structure,s=i.get(r||i.default.name),l=a.colorThemeRegistry.get(n||s.defaultColorTheme.name),c=g.getDefaultValues(l.getParams({structure:e||ue.Empty}));return l.name===s.defaultColorTheme.name&&Object.assign(c,s.defaultColorTheme.props),{name:l.name,params:Object.assign(c,o)}}function YL(t,e,r,n,o){let{registry:i,themes:a}=t.representation.structure,s=i.get(r||i.default.name),l=a.sizeThemeRegistry.get(n||s.defaultSizeTheme.name),c=g.getDefaultValues(l.getParams({structure:e||ue.Empty}));return l.name===s.defaultSizeTheme.name&&Object.assign(c,s.defaultSizeTheme.props),{name:l.name,params:Object.assign(c,o)}}function B_e(t,e,r){let n=r.type&&t.representation.structure.registry.get(r.type)||t.representation.structure.registry.default.provider,o=r.color&&t.representation.structure.themes.colorThemeRegistry.get(r.color)||t.representation.structure.themes.colorThemeRegistry.get(n.defaultColorTheme.name),i=r.size&&t.representation.structure.themes.sizeThemeRegistry.get(r.size)||t.representation.structure.themes.sizeThemeRegistry.get(n.defaultSizeTheme.name);return UZ(t,e,{type:n,typeParams:r.typeParams,color:o,colorParams:r.colorParams,size:i,sizeParams:r.sizeParams})}function UZ(t,e,r={}){let{themes:n}=t.representation.structure,o={structure:e},i=r.type||t.representation.structure.registry.default.provider,a=g.getDefaultValues(i.getParams(n,e)),s=Object.assign(a,r.typeParams),l=r.color||n.colorThemeRegistry.get(i.defaultColorTheme.name),c=g.getDefaultValues(l.getParams(o));l.name===i.defaultColorTheme.name&&Object.assign(c,i.defaultColorTheme.props);let u=Object.assign(c,r.colorParams),d=r.size||n.sizeThemeRegistry.get(i.defaultSizeTheme.name),m=g.getDefaultValues(d.getParams(o));d.name===i.defaultSizeTheme.name&&Object.assign(m,i.defaultSizeTheme.props);let p=Object.assign(m,r.sizeParams);return{type:{name:i.name,params:s},colorTheme:{name:l.name,params:u},sizeTheme:{name:d.name,params:p}}}var O_e=t=>{let e=de.Representation.StructureRepresentation3D.definition.params(void 0,t);return{expandRadius:g.Numeric(5,{min:1,max:10,step:1}),targetParams:g.Group(e,{label:"Target",customDefault:Qv(t,void 0,{type:"ball-and-stick",size:"physical",typeParams:{sizeFactor:.22,sizeAspectRatio:.73,adjustCylinderLength:!0,xrayShaded:!0,aromaticBonds:!1,multipleBonds:"off",excludeTypes:["hydrogen-bond","metal-coordination"]}})}),surroundingsParams:g.Group(e,{label:"Surroundings",customDefault:Qv(t,void 0,{type:"ball-and-stick",size:"physical",typeParams:{sizeFactor:.16,excludeTypes:["hydrogen-bond","metal-coordination"]}})}),nciParams:g.Group(e,{label:"Non-covalent Int.",customDefault:Qv(t,void 0,{type:Yv,color:aS,size:so.BuiltIn.uniform})}),components:g.MultiSelect(GZ,g.arrayToOptions(GZ)),excludeTargetFromSurroundings:g.Boolean(!1,{label:"Exclude Target",description:'Exclude the focus "target" from the surroudings component.'}),ignoreHydrogens:g.Boolean(!1),ignoreHydrogensVariant:g.Select("all",g.arrayToOptions(["all","non-polar"])),ignoreLight:g.Boolean(!1),material:Qo.getParam(),clip:g.Group(dd.Params)}},GZ=["target","surroundings","interactions"],Rn=function(t){return t.TargetSel="structure-focus-target-sel",t.TargetRepr="structure-focus-target-repr",t.SurrSel="structure-focus-surr-sel",t.SurrRepr="structure-focus-surr-repr",t.SurrNciRepr="structure-focus-surr-nci-repr",t}(Rn||{}),F_e=new Set([Rn.TargetSel,Rn.TargetRepr,Rn.SurrSel,Rn.SurrRepr,Rn.SurrNciRepr]),QL=class extends rr.WithSubscribers{constructor(){super(...arguments),this.currentSource=void 0}get surrLabel(){return`[Focus] Surroundings (${this.params.expandRadius} \xC5)`}getReprParams(e){return U(w({},e),{type:{name:e.type.name,params:U(w({},e.type.params),{ignoreHydrogens:this.params.ignoreHydrogens,ignoreHydrogensVariant:this.params.ignoreHydrogensVariant,ignoreLight:this.params.ignoreLight,material:this.params.material,clip:this.params.clip})}})}ensureShape(e){var r;let n=this.plugin.state.data,o=n.tree,i=n.build(),a=lt.findUniqueTagsInSubtree(o,e.transform.ref,F_e);a[Rn.TargetSel]||(a[Rn.TargetSel]=i.to(e).apply(de.Model.StructureSelectionFromBundle,{bundle:z.Bundle.Empty,label:"[Focus] Target"},{tags:Rn.TargetSel}).ref),a[Rn.SurrSel]||(a[Rn.SurrSel]=i.to(e).apply(de.Model.StructureSelectionFromExpression,{expression:q.struct.generator.empty(),label:this.surrLabel},{tags:Rn.SurrSel}).ref);let s=this.params.components;return s.indexOf("target")>=0&&!a[Rn.TargetRepr]&&(a[Rn.TargetRepr]=i.to(a[Rn.TargetSel]).apply(de.Representation.StructureRepresentation3D,this.getReprParams(this.params.targetParams),{tags:Rn.TargetRepr}).ref),s.indexOf("surroundings")>=0&&!a[Rn.SurrRepr]&&(a[Rn.SurrRepr]=i.to(a[Rn.SurrSel]).apply(de.Representation.StructureRepresentation3D,this.getReprParams(this.params.surroundingsParams),{tags:Rn.SurrRepr}).ref),s.indexOf("interactions")>=0&&!a[Rn.SurrNciRepr]&&e.obj&&Yv.isApplicable((r=e.obj)===null||r===void 0?void 0:r.data)&&(a[Rn.SurrNciRepr]=i.to(a[Rn.SurrSel]).apply(de.Representation.StructureRepresentation3D,this.getReprParams(this.params.nciParams),{tags:Rn.SurrNciRepr}).ref),{state:n,builder:i,refs:a}}clear(e){let r=this.plugin.state.data;this.currentSource=void 0;let n=r.select(lt.Generators.byRef(e).subtree().withTag(Rn.TargetSel)),o=r.select(lt.Generators.byRef(e).subtree().withTag(Rn.SurrSel));if(n.length===0&&o.length===0)return;let i=r.build(),a=z.Bundle.Empty;for(let l of n)i.to(l).update(de.Model.StructureSelectionFromBundle,c=>U(w({},c),{bundle:a}));let s=q.struct.generator.empty();for(let l of o)i.to(l).update(de.Model.StructureSelectionFromExpression,c=>U(w({},c),{expression:s}));return Re.State.Update(this.plugin,{state:r,tree:i,options:{doNotLogTiming:!0,doNotUpdateCurrent:!0}})}focus(e){return N(this,null,function*(){let r=this.plugin.helpers.substructureParent.get(e.structure);if(!r||!r.obj)return;this.currentSource=e;let n=z.Loci.remap(e,r.obj.data),o=z.Loci.extendToWholeResidues(n),i=z.Bundle.fromLoci(o),a=z.Bundle.toExpression(i),s=q.struct.modifier.includeSurroundings({0:a,radius:this.params.expandRadius,"as-whole-residues":!0});this.params.excludeTargetFromSurroundings&&(s=q.struct.modifier.exceptBy({0:s,by:a}));let{state:l,builder:c,refs:u}=this.ensureShape(r);c.to(u[Rn.TargetSel]).update(de.Model.StructureSelectionFromBundle,d=>U(w({},d),{bundle:i})),c.to(u[Rn.SurrSel]).update(de.Model.StructureSelectionFromExpression,d=>U(w({},d),{expression:s,label:this.surrLabel})),yield Re.State.Update(this.plugin,{state:l,tree:c,options:{doNotLogTiming:!0,doNotUpdateCurrent:!0}})})}register(e){this.subscribeObservable(this.plugin.managers.structure.focus.behaviors.current,r=>{r?this.focus(r.loci):this.clear(kt.RootRef)})}update(e){return N(this,null,function*(){let r=this.params;if(this.params=e,r.excludeTargetFromSurroundings!==e.excludeTargetFromSurroundings)return this.currentSource&&this.focus(this.currentSource),!0;let n=this.plugin.state.data,o=n.build(),i=lt.Generators.root.subtree(),a=this.params.components,s=a.indexOf("target")>=0;for(let l of n.select(i.withTag(Rn.TargetRepr)))s?o.to(l).update(this.getReprParams(this.params.targetParams)):o.delete(l.transform.ref);s=a.indexOf("surroundings")>=0;for(let l of n.select(i.withTag(Rn.SurrRepr)))s?o.to(l).update(this.getReprParams(this.params.surroundingsParams)):o.delete(l.transform.ref);s=a.indexOf("interactions")>=0;for(let l of n.select(i.withTag(Rn.SurrNciRepr)))s?o.to(l).update(this.getReprParams(this.params.nciParams)):o.delete(l.transform.ref);return yield Re.State.Update(this.plugin,{state:n,tree:o,options:{doNotLogTiming:!0,doNotUpdateCurrent:!0}}),e.expandRadius!==r.expandRadius&&this.currentSource&&this.focus(this.currentSource),!0})}},my=rr.create({name:"create-structure-focus-representation",display:{name:"Structure Focus Representation"},category:"interaction",ctor:QL,params:(t,e)=>O_e(e)});var $L={};ua($L,{AddTrajectory:()=>pPe,DownloadStructure:()=>sPe,EnableModelCustomProps:()=>dPe,EnableStructureCustomProps:()=>mPe,LoadTrajectory:()=>fPe,PdbDownloadProvider:()=>KZ,UpdateTrajectory:()=>pS});function oa(t){return t}(function(t){t.CommonParams={ignoreHydrogens:g.Optional(g.Boolean(!1)),ignoreHydrogensVariant:g.Optional(g.Select("all",g.arrayToOptions(["all","non-polar"]))),ignoreLight:g.Optional(g.Boolean(!1)),quality:g.Optional(g.Select("auto",Qx)),theme:g.Optional(g.Group({globalName:g.Optional(g.Text("")),globalColorParams:g.Optional(g.Value({},{isHidden:!0})),carbonColor:g.Optional(g.Select("chain-id",g.arrayToOptions(["chain-id","operator-name","element-symbol"]))),symmetryColor:g.Optional(g.Text("")),symmetryColorParams:g.Optional(g.Value({},{isHidden:!0})),focus:g.Optional(g.Group({name:g.Optional(g.Text("")),params:g.Optional(g.Value({}))}))}))};function e(i){return i==="chain-id"?{name:i,params:W2.defaultValues}:i==="operator-name"?{name:i,params:av.defaultValues}:{name:i,params:{}}}function r(i){return i.units.some(a=>!a.conformation.operator.assembly&&a.conformation.operator.spgrOp>=0)}function n(i,a,s){var l,c,u,d,m,p,h,f,b,v,x,S,T,E;let _=i.state.data.build(),D=i.builders.structure.representation,P=i.managers.structure.component.state.options.hydrogens,A={quality:i.managers.structure.component.state.options.visualQuality,ignoreHydrogens:P!=="all",ignoreHydrogensVariant:P==="only-polar"?"non-polar":"all",ignoreLight:i.managers.structure.component.state.options.ignoreLight};a.quality&&a.quality!=="auto"&&(A.quality=a.quality),a.ignoreHydrogens!==void 0&&(A.ignoreHydrogens=!!a.ignoreHydrogens),a.ignoreHydrogensVariant!==void 0&&(A.ignoreHydrogensVariant=a.ignoreHydrogensVariant),a.ignoreLight!==void 0&&(A.ignoreLight=!!a.ignoreLight);let I=!((l=a.theme)===null||l===void 0)&&l.globalName?(c=a.theme)===null||c===void 0?void 0:c.globalName:void 0,k=((u=a.theme)===null||u===void 0?void 0:u.carbonColor)!==void 0?w({carbonColor:e((d=a.theme)===null||d===void 0?void 0:d.carbonColor)},(m=a.theme)===null||m===void 0?void 0:m.globalColorParams):w({},(p=a.theme)===null||p===void 0?void 0:p.globalColorParams),M=s&&(!((h=a.theme)===null||h===void 0)&&h.symmetryColor)&&r(s)?(f=a.theme)===null||f===void 0?void 0:f.symmetryColor:I,R=!((b=a.theme)===null||b===void 0)&&b.symmetryColorParams?w(w({},(v=a.theme)===null||v===void 0?void 0:v.globalColorParams),(x=a.theme)===null||x===void 0?void 0:x.symmetryColorParams):w({},(S=a.theme)===null||S===void 0?void 0:S.globalColorParams),B=!((T=a.theme)===null||T===void 0)&&T.globalColorParams?w({},(E=a.theme)===null||E===void 0?void 0:E.globalColorParams):void 0;return{update:_,builder:D,color:I,symmetryColor:M,symmetryColorParams:R,globalColorParams:B,typeParams:A,ballAndStickColor:k}}t.reprBuilder=n;function o(i,a,s,l){if(i.state.hasBehavior(my))return i.state.updateBehavior(my,c=>{let u=dS(i,a,"ball-and-stick",s||"element-symbol",l);c.surroundingsParams.colorTheme=u,c.targetParams.colorTheme=u})}t.updateFocusRepr=o})(oa||(oa={}));var Th=oa.CommonParams,py=oa.reprBuilder,fy=oa.updateFocusRepr,N_e=oa({id:"preset-structure-representation-auto",display:{name:"Automatic",description:"Show representations based on the size of the structure. Smaller structures are shown with more detail than larger ones, ranging from atomistic display to coarse surfaces."},params:()=>Th,apply(t,e,r){var n,o;let i=(o=(n=Fn.resolveAndCheck(r.state.data,t))===null||n===void 0?void 0:n.obj)===null||o===void 0?void 0:o.data;if(!i)return{};let a=r.config.get(Wt.Structure.SizeThresholds)||ue.DefaultSizeThresholds,s=ue.getSize(i,a),l=i.polymerResidueCount/i.polymerGapCount;switch(s){case ue.Size.Gigantic:case ue.Size.Huge:return qZ.apply(t,e,r);case ue.Size.Large:return WZ.apply(t,e,r);case ue.Size.Medium:if(l>3)return HZ.apply(t,e,r);case ue.Size.Small:return XZ.apply(t,U(w({},e),{showCarbohydrateSymbol:!0}),r);default:ur(s)}}}),V_e=oa({id:"preset-structure-representation-empty",display:{name:"Empty",description:"Removes all existing representations."},apply(t,e,r){return N(this,null,function*(){return{}})}}),mS="Basic",HZ=oa({id:"preset-structure-representation-polymer-and-ligand",display:{name:"Polymer & Ligand",group:mS,description:"Shows polymers as Cartoon, ligands as Ball & Stick, carbohydrates as 3D-SNFG and water molecules semi-transparent."},params:()=>Th,apply(t,e,r){return N(this,null,function*(){var n,o,i,a,s,l,c,u,d,m;let p=Fn.resolveAndCheck(r.state.data,t);if(!p)return{};let h={polymer:yield ul(r,p,"polymer"),ligand:yield ul(r,p,"ligand"),nonStandard:yield ul(r,p,"non-standard"),branched:yield ul(r,p,"branched",{label:"Carbohydrate"}),water:yield ul(r,p,"water"),ion:yield ul(r,p,"ion"),lipid:yield ul(r,p,"lipid"),coarse:yield ul(r,p,"coarse")},f=p.obj.data,b={sizeFactor:f.isCoarseGrained?.8:.2},v=(((i=(o=(n=h.water)===null||n===void 0?void 0:n.obj)===null||o===void 0?void 0:o.data)===null||i===void 0?void 0:i.elementCount)||0)>5e4?"line":"ball-and-stick",x=(((l=(s=(a=h.lipid)===null||a===void 0?void 0:a.obj)===null||s===void 0?void 0:s.data)===null||l===void 0?void 0:l.elementCount)||0)>2e4?"line":"ball-and-stick",{update:S,builder:T,typeParams:E,color:_,symmetryColor:D,symmetryColorParams:P,globalColorParams:A,ballAndStickColor:I}=py(r,e,f),k={polymer:T.buildRepresentation(S,h.polymer,{type:"cartoon",typeParams:w(w({},E),b),color:D,colorParams:P},{tag:"polymer"}),ligand:T.buildRepresentation(S,h.ligand,{type:"ball-and-stick",typeParams:E,color:_,colorParams:I},{tag:"ligand"}),nonStandard:T.buildRepresentation(S,h.nonStandard,{type:"ball-and-stick",typeParams:E,color:_,colorParams:I},{tag:"non-standard"}),branchedBallAndStick:T.buildRepresentation(S,h.branched,{type:"ball-and-stick",typeParams:U(w({},E),{alpha:.3}),color:_,colorParams:I},{tag:"branched-ball-and-stick"}),branchedSnfg3d:T.buildRepresentation(S,h.branched,{type:"carbohydrate",typeParams:E,color:_,colorParams:A},{tag:"branched-snfg-3d"}),water:T.buildRepresentation(S,h.water,{type:v,typeParams:U(w({},E),{alpha:.6,visuals:v==="line"?["intra-bond","element-point"]:void 0}),color:_,colorParams:w({carbonColor:{name:"element-symbol",params:{}}},A)},{tag:"water"}),ion:T.buildRepresentation(S,h.ion,{type:"ball-and-stick",typeParams:E,color:_,colorParams:w({carbonColor:{name:"element-symbol",params:{}}},A)},{tag:"ion"}),lipid:T.buildRepresentation(S,h.lipid,{type:x,typeParams:U(w({},E),{alpha:.6,visuals:x==="line"?["intra-bond"]:void 0}),color:_,colorParams:w({carbonColor:{name:"element-symbol",params:{}}},A)},{tag:"lipid"}),coarse:T.buildRepresentation(S,h.coarse,{type:"spacefill",typeParams:E,color:_||"chain-id",colorParams:A},{tag:"coarse"})};return yield S.commit({revertOnError:!1}),yield fy(r,f,(u=(c=e.theme)===null||c===void 0?void 0:c.focus)===null||u===void 0?void 0:u.name,(m=(d=e.theme)===null||d===void 0?void 0:d.focus)===null||m===void 0?void 0:m.params),{components:h,representations:k}})}}),z_e=oa({id:"preset-structure-representation-protein-and-nucleic",display:{name:"Protein & Nucleic",group:mS,description:"Shows proteins as Cartoon and RNA/DNA as Gaussian Surface."},params:()=>Th,apply(t,e,r){return N(this,null,function*(){var n,o,i,a;let s=Fn.resolveAndCheck(r.state.data,t);if(!s)return{};let l={protein:yield jZ(r,s,"protein"),nucleic:yield jZ(r,s,"nucleic")},c=s.obj.data,u={sizeFactor:c.isCoarseGrained?.8:.2},d={radiusOffset:c.isCoarseGrained?2:0,smoothness:c.isCoarseGrained?1:1.5},{update:m,builder:p,typeParams:h,symmetryColor:f,symmetryColorParams:b}=py(r,e,c),v={protein:p.buildRepresentation(m,l.protein,{type:"cartoon",typeParams:w(w({},h),u),color:f,colorParams:b},{tag:"protein"}),nucleic:p.buildRepresentation(m,l.nucleic,{type:"gaussian-surface",typeParams:w(w({},h),d),color:f,colorParams:b},{tag:"nucleic"})};return yield m.commit({revertOnError:!0}),yield fy(r,c,(o=(n=e.theme)===null||n===void 0?void 0:n.focus)===null||o===void 0?void 0:o.name,(a=(i=e.theme)===null||i===void 0?void 0:i.focus)===null||a===void 0?void 0:a.params),{components:l,representations:v}})}}),qZ=oa({id:"preset-structure-representation-coarse-surface",display:{name:"Coarse Surface",group:mS,description:"Shows polymers and lipids as coarse Gaussian Surface."},params:()=>Th,apply(t,e,r){return N(this,null,function*(){var n,o,i,a;let s=Fn.resolveAndCheck(r.state.data,t);if(!s)return{};let l={polymer:yield ul(r,s,"polymer"),lipid:yield ul(r,s,"lipid")},c=s.obj.data,u=r.config.get(Wt.Structure.SizeThresholds)||ue.DefaultSizeThresholds,d=ue.getSize(c,u),m=Object.create(null);d===ue.Size.Gigantic?Object.assign(m,{traceOnly:!c.isCoarseGrained,radiusOffset:2,smoothness:1,visuals:["structure-gaussian-surface-mesh"]}):d===ue.Size.Huge?Object.assign(m,{radiusOffset:c.isCoarseGrained?2:0,smoothness:1}):c.isCoarseGrained&&Object.assign(m,{radiusOffset:2,smoothness:1});let{update:p,builder:h,typeParams:f,symmetryColor:b,symmetryColorParams:v}=py(r,e,c),x={polymer:h.buildRepresentation(p,l.polymer,{type:"gaussian-surface",typeParams:w(w({},f),m),color:b,colorParams:v},{tag:"polymer"}),lipid:h.buildRepresentation(p,l.lipid,{type:"gaussian-surface",typeParams:w(w({},f),m),color:b,colorParams:v},{tag:"lipid"})};return yield p.commit({revertOnError:!0}),yield fy(r,c,(o=(n=e.theme)===null||n===void 0?void 0:n.focus)===null||o===void 0?void 0:o.name,(a=(i=e.theme)===null||i===void 0?void 0:i.focus)===null||a===void 0?void 0:a.params),{components:l,representations:x}})}}),WZ=oa({id:"preset-structure-representation-polymer-cartoon",display:{name:"Polymer Cartoon",group:mS,description:"Shows polymers as Cartoon."},params:()=>Th,apply(t,e,r){return N(this,null,function*(){var n,o,i,a;let s=Fn.resolveAndCheck(r.state.data,t);if(!s)return{};let l={polymer:yield ul(r,s,"polymer")},c=s.obj.data,u={sizeFactor:c.isCoarseGrained?.8:.2},{update:d,builder:m,typeParams:p,symmetryColor:h,symmetryColorParams:f}=py(r,e,c),b={polymer:m.buildRepresentation(d,l.polymer,{type:"cartoon",typeParams:w(w({},p),u),color:h,colorParams:f},{tag:"polymer"})};return yield d.commit({revertOnError:!0}),yield fy(r,c,(o=(n=e.theme)===null||n===void 0?void 0:n.focus)===null||o===void 0?void 0:o.name,(a=(i=e.theme)===null||i===void 0?void 0:i.focus)===null||a===void 0?void 0:a.params),{components:l,representations:b}})}}),XZ=oa({id:"preset-structure-representation-atomic-detail",display:{name:"Atomic Detail",group:mS,description:"Shows everything in atomic detail with Ball & Stick."},params:()=>U(w({},Th),{showCarbohydrateSymbol:g.Boolean(!1)}),apply(t,e,r){return N(this,null,function*(){var n,o,i,a,s,l;let c=Fn.resolveAndCheck(r.state.data,t);if(!c)return{};let u={all:yield ul(r,c,"all"),branched:void 0},d=c.obj.data,m=d.elementCount>1e5,p=d.atomicResidueCount&&d.elementCount>1e3&&d.atomicResidueCount/d.elementCount<3,h=d.models[0],f=!!ld.Provider.get(h)||sU.isExhaustive(h),b="ball-and-stick";d.isCoarseGrained?b=d.elementCount>1e6?"point":"spacefill":p&&!f?b="spacefill":m&&(b="line");let v=e.showCarbohydrateSymbol&&!m&&!p;v&&Object.assign(u,{branched:yield ul(r,c,"branched",{label:"Carbohydrate"})});let{update:x,builder:S,typeParams:T,color:E,ballAndStickColor:_,globalColorParams:D}=py(r,e,d),P=p&&!f?w({carbonColor:{name:"element-symbol",params:{}}},D):_,A={all:S.buildRepresentation(x,u.all,{type:b,typeParams:T,color:E,colorParams:P},{tag:"all"})};return v&&Object.assign(A,{snfg3d:S.buildRepresentation(x,u.branched,{type:"carbohydrate",typeParams:U(w({},T),{alpha:.4,visuals:["carbohydrate-symbol"]}),color:E,colorParams:D},{tag:"snfg-3d"})}),yield x.commit({revertOnError:!0}),yield fy(r,d,(i=(o=(n=e.theme)===null||n===void 0?void 0:n.focus)===null||o===void 0?void 0:o.name)!==null&&i!==void 0?i:E,(l=(s=(a=e.theme)===null||a===void 0?void 0:a.focus)===null||s===void 0?void 0:s.params)!==null&&l!==void 0?l:P),{components:u,representations:A}})}}),U_e=oa({id:"preset-structure-representation-illustrative",display:{name:"Illustrative",group:"Miscellaneous",description:"..."},params:()=>U(w({},Th),{showCarbohydrateSymbol:g.Boolean(!1)}),apply(t,e,r){return N(this,null,function*(){var n,o,i,a,s;let l=Fn.resolveAndCheck(r.state.data,t);if(!l)return{};let c={all:yield ul(r,l,"all"),branched:void 0},u=l.obj.data,{update:d,builder:m,typeParams:p,color:h}=py(r,e,u),f={all:m.buildRepresentation(d,c.all,{type:"spacefill",typeParams:U(w({},p),{ignoreLight:!0}),color:"illustrative"},{tag:"all"})};return yield d.commit({revertOnError:!0}),yield fy(r,u,(i=(o=(n=e.theme)===null||n===void 0?void 0:n.focus)===null||o===void 0?void 0:o.name)!==null&&i!==void 0?i:h,(s=(a=e.theme)===null||a===void 0?void 0:a.focus)===null||s===void 0?void 0:s.params),{components:c,representations:f}})}}),G_e=oa({id:"preset-structure-representation-auto-lod",display:{name:"Automatic Detail",group:"Miscellaneous",description:"Shows more (or less) detailed representations automatically based on camera distance."},params:()=>Th,apply(t,e,r){return N(this,null,function*(){var n,o,i,a;let s=Fn.resolveAndCheck(r.state.data,t);if(!s)return{};let l={all:yield ul(r,s,"all")},c=s.obj.data,u={sizeFactor:c.isCoarseGrained?.8:.2},{update:d,builder:m,typeParams:p,color:h,symmetryColor:f,symmetryColorParams:b,ballAndStickColor:v}=py(r,e,c),x={gaussianSurface:m.buildRepresentation(d,l.all,{type:"gaussian-surface",typeParams:U(w({},p),{lod:y.create(30,1e7,100)}),color:f,colorParams:b},{tag:"gaussian-surface"}),cartoon:m.buildRepresentation(d,l.all,{type:"cartoon",typeParams:U(w(w({},p),u),{lod:y.create(-20,300,100)}),color:f,colorParams:b},{tag:"cartoon"}),ballAndStick:m.buildRepresentation(d,l.all,{type:"ball-and-stick",typeParams:U(w({},p),{lod:y.create(-20,40,20)}),color:h,colorParams:v},{tag:"ball-and-stick"})};return yield d.commit({revertOnError:!1}),yield fy(r,c,(o=(n=e.theme)===null||n===void 0?void 0:n.focus)===null||o===void 0?void 0:o.name,(a=(i=e.theme)===null||i===void 0?void 0:i.focus)===null||a===void 0?void 0:a.params),{components:l,representations:x}})}});function ul(t,e,r,n){return t.builders.structure.tryCreateComponentStatic(e,r,n)}function jZ(t,e,r,n){return t.builders.structure.tryCreateComponentFromSelection(e,Qn[r],`selection-${r}`,n)}var Ms={empty:V_e,auto:N_e,"atomic-detail":XZ,"polymer-cartoon":WZ,"polymer-and-ligand":HZ,"protein-and-nucleic":z_e,"coarse-surface":qZ,illustrative:U_e,"auto-lod":G_e};function Kv(t,e){if(t.ext==="bcif")try{let{encoder:r}=bU(e);if(r.startsWith("VolumeServer"))return"dscif";if(r.startsWith("volseg-volume-server"))return"segcif"}catch(r){console.error(r)}else if(t.ext==="cif"){let r=e;if(r.startsWith(`data_SERVER
#
_density_server_result`))return"dscif";if(r.startsWith(`data_SERVER
#
data_SEGMENTATION_DATA`))return"segcif";if(r.includes("atom_site_fract_x")||r.includes("atom_site.fract_x"))return"coreCif"}return-1}var _u="Trajectory";function Ap(t,e){return t.builders.structure.hierarchy.applyPreset(e.trajectory,"default")}var j_e={label:"mmCIF",description:"mmCIF",category:_u,stringExtensions:["cif","mmcif","mcif"],binaryExtensions:["bcif"],isApplicable:(t,e)=>t.ext==="mmcif"||t.ext==="mcif"?!0:t.ext==="cif"||t.ext==="bcif"?Kv(t,e)===-1:!1,parse:(t,e,r)=>N(void 0,null,function*(){var n,o;let a=t.state.data.build().to(e).apply(de.Data.ParseCif,void 0,{state:{isGhost:!0}}),s=yield a.apply(de.Model.TrajectoryFromMmCif,void 0,{tags:r?.trajectoryTags}).commit({revertOnError:!0});return(((o=(n=a.selector.cell)===null||n===void 0?void 0:n.obj)===null||o===void 0?void 0:o.data.blocks.length)||0)>1&&t.state.data.updateCellState(a.ref,{isGhost:!1}),{trajectory:s}}),visuals:Ap},H_e={label:"cifCore",description:"CIF Core",category:_u,stringExtensions:["cif"],isApplicable:(t,e)=>t.ext==="cif"?Kv(t,e)==="coreCif":!1,parse:(t,e,r)=>N(void 0,null,function*(){var n,o;let a=t.state.data.build().to(e).apply(de.Data.ParseCif,void 0,{state:{isGhost:!0}}),s=yield a.apply(de.Model.TrajectoryFromCifCore,void 0,{tags:r?.trajectoryTags}).commit({revertOnError:!0});return(((o=(n=a.selector.cell)===null||n===void 0?void 0:n.obj)===null||o===void 0?void 0:o.data.blocks.length)||0)>1&&t.state.data.updateCellState(a.ref,{isGhost:!1}),{trajectory:s}}),visuals:Ap};function hy(t,e){return(r,n,o)=>N(this,null,function*(){return{trajectory:yield r.state.data.build().to(n).apply(t,e,{tags:o?.trajectoryTags}).commit({revertOnError:!0})}})}var q_e={label:"PDB",description:"PDB",category:_u,stringExtensions:["pdb","ent"],parse:hy(de.Model.TrajectoryFromPDB),visuals:Ap},W_e={label:"PDBQT",description:"PDBQT",category:_u,stringExtensions:["pdbqt"],parse:hy(de.Model.TrajectoryFromPDB,{isPdbqt:!0}),visuals:Ap},X_e={label:"XYZ",description:"XYZ",category:_u,stringExtensions:["xyz"],parse:hy(de.Model.TrajectoryFromXYZ),visuals:Ap},Y_e={label:"GRO",description:"GRO",category:_u,stringExtensions:["gro"],binaryExtensions:[],parse:hy(de.Model.TrajectoryFromGRO),visuals:Ap},Q_e={label:"MOL",description:"MOL",category:_u,stringExtensions:["mol"],parse:hy(de.Model.TrajectoryFromMOL),visuals:Ap},K_e={label:"SDF",description:"SDF",category:_u,stringExtensions:["sdf","sd"],parse:hy(de.Model.TrajectoryFromSDF),visuals:Ap},$_e={label:"MOL2",description:"MOL2",category:_u,stringExtensions:["mol2"],parse:hy(de.Model.TrajectoryFromMOL2),visuals:Ap},$_=[["mmcif",j_e],["cifCore",H_e],["pdb",q_e],["pdbqt",W_e],["gro",Y_e],["xyz",X_e],["mol",Q_e],["sdf",K_e],["mol2",$_e]];var Z_e=["gz","zip"];function kp(t){let e=t,r="",n=e.lastIndexOf("?"),o=n!==-1?e.substring(n):"";e=e.substring(0,n===-1?e.length:n);let i=e.replace(/^.*[\\/]/,""),a=i.substring(0,i.lastIndexOf(".")),s=i.split("."),l=s.length>1?(s.pop()||"").toLowerCase():"",c=e.match(/^(.+):\/\/(.+)$/);c&&(r=c[1].toLowerCase(),e=c[2]||"");let u=e.substring(0,e.lastIndexOf("/")+1);if(Z_e.includes(l)){let d=e.length-l.length-1;l=(e.substr(0,d).split(".").pop()||"").toLowerCase();let m=a.length-l.length-1;a=a.substr(0,m)}return{path:e,name:i,ext:l,base:a,dir:u,protocol:r,query:o}}var $v="Topology";var J_e={label:"PSF",description:"PSF",category:$v,stringExtensions:["psf"],parse:(t,e)=>N(void 0,null,function*(){let r=t.state.data.build().to(e).apply(de.Data.ParsePsf,{},{state:{isGhost:!0}}),n=r.apply(de.Model.TopologyFromPsf);return yield r.commit(),{format:r.selector,topology:n.selector}})};var ePe={label:"PRMTOP",description:"PRMTOP",category:$v,stringExtensions:["prmtop","parm7"],parse:(t,e)=>N(void 0,null,function*(){let r=t.state.data.build().to(e).apply(de.Data.ParsePrmtop,{},{state:{isGhost:!0}}),n=r.apply(de.Model.TopologyFromPrmtop);return yield r.commit(),{format:r.selector,topology:n.selector}})};var tPe={label:"TOP",description:"TOP",category:$v,stringExtensions:["top"],parse:(t,e)=>N(void 0,null,function*(){let r=t.state.data.build().to(e).apply(de.Data.ParseTop,{},{state:{isGhost:!0}}),n=r.apply(de.Model.TopologyFromTop);return yield r.commit(),{format:r.selector,topology:n.selector}})},YZ=[["psf",J_e],["prmtop",ePe],["top",tPe]];var gy="Coordinates";var rPe={label:"DCD",description:"DCD",category:gy,binaryExtensions:["dcd"],parse:(t,e)=>t.state.data.build().to(e).apply(de.Model.CoordinatesFromDcd).commit()};var nPe={label:"XTC",description:"XTC",category:gy,binaryExtensions:["xtc"],parse:(t,e)=>t.state.data.build().to(e).apply(de.Model.CoordinatesFromXtc).commit()};var oPe={label:"TRR",description:"TRR",category:gy,binaryExtensions:["trr"],parse:(t,e)=>t.state.data.build().to(e).apply(de.Model.CoordinatesFromTrr).commit()};var iPe={label:"NCTRAJ",description:"NCTRAJ",category:gy,binaryExtensions:["nc","nctraj"],parse:(t,e)=>t.state.data.build().to(e).apply(de.Model.CoordinatesFromNctraj).commit()},QZ=[["dcd",rPe],["xtc",nPe],["trr",oPe],["nctraj",iPe]];var aPe=t=>{let e=t.config.get(Wt.Structure.DefaultRepresentationPreset)||Ms.auto.id;return g.Group({type:vm.getParams(void 0,"auto").type,representation:g.Select(e,t.builders.structure.representation.getPresets().map(r=>[r.id,r.display.name,r.display.group]),{description:"Which representation preset to use."}),representationParams:g.Group(oa.CommonParams,{isHidden:!0}),asTrajectory:g.Optional(g.Boolean(!1,{description:"Load all entries into a single trajectory."}))},{isExpanded:!1})},KZ={rcsb:g.Group({encoding:g.Select("bcif",g.arrayToOptions(["cif","bcif"]))},{label:"RCSB PDB",isFlat:!0}),pdbe:g.Group({variant:g.Select("updated-bcif",[["updated-bcif","Updated (bcif)"],["updated","Updated"],["archival","Archival"]])},{label:"PDBe",isFlat:!0}),pdbj:g.EmptyGroup({label:"PDBj"})};var sPe=Gi.build({from:X.Root,display:{name:"Download Structure",description:"Load a structure from the provided source and create its representation."},params:(t,e)=>{let r=aPe(e),n=e.config.get(Wt.Download.DefaultPdbProvider)||"pdbe";return{source:g.MappedStatic("pdb",{pdb:g.Group({provider:g.Group({id:g.Text("1tqn",{label:"PDB Id(s)",description:"One or more comma/space separated PDB ids."}),server:g.MappedStatic(n,KZ)},{pivot:"id"}),options:r},{isFlat:!0,label:"PDB"}),"pdb-dev":g.Group({provider:g.Group({id:g.Text("PDBDEV_00000001",{label:"PDB-Dev Id(s)",description:"One or more comma/space separated ids."}),encoding:g.Select("bcif",g.arrayToOptions(["cif","bcif"]))},{pivot:"id"}),options:r},{isFlat:!0,label:"PDB-Dev"}),swissmodel:g.Group({id:g.Text("Q9Y2I8",{label:"UniProtKB AC(s)",description:"One or more comma/space separated ACs."}),options:r},{isFlat:!0,label:"SWISS-MODEL",description:"Loads the best homology model or experimental structure"}),alphafolddb:g.Group({id:g.Text("Q8W3K0",{label:"UniProtKB AC(s)",description:"One or more comma/space separated ACs."}),options:r},{isFlat:!0,label:"AlphaFold DB",description:"Loads the predicted model if available"}),modelarchive:g.Group({id:g.Text("ma-bak-cepc-0003",{label:"Accession Code(s)",description:"One or more comma/space separated ACs."}),options:r},{isFlat:!0,label:"Model Archive"}),pubchem:g.Group({id:g.Text("2244,2245",{label:"PubChem ID",description:"One or more comma/space separated IDs."}),options:r},{isFlat:!0,label:"PubChem",description:"Loads 3D conformer from PubChem."}),url:g.Group({url:g.Url(""),format:g.Select("mmcif",g.arrayToOptions($_.map(o=>o[0]),o=>o)),isBinary:g.Boolean(!1),label:g.Optional(g.Text("")),options:r},{isFlat:!0,label:"URL"})})}}})(({params:t,state:e},r)=>ie.create("Download Structure",n=>N(void 0,null,function*(){r.behaviors.layout.leftPanelTabName.next("data");let o=t.source,i,a=!1,s="mmcif";switch(o.name){case"url":i=[{url:o.params.url,isBinary:o.params.isBinary,label:o.params.label||void 0}],s=o.params.format;break;case"pdb":i=yield o.params.provider.server.name==="pdbe"?lPe(o):o.params.provider.server.name==="pdbj"?cPe(o):o.params.provider.server.name==="rcsb"?uPe(o):ur(o),a=!!o.params.options.asTrajectory;break;case"pdb-dev":i=yield Od(o.params.provider.id,d=>{let m=d.toUpperCase().startsWith("PDBDEV_")?d:`PDBDEV_${d.padStart(8,"0")}`;return o.params.provider.encoding==="bcif"?`https://pdb-dev.wwpdb.org/bcif/${m.toUpperCase()}.bcif`:`https://pdb-dev.wwpdb.org/cif/${m.toUpperCase()}.cif`},d=>d.toUpperCase().startsWith("PDBDEV_")?d:`PDBDEV_${d.padStart(8,"0")}`,o.params.provider.encoding==="bcif"),a=!!o.params.options.asTrajectory;break;case"swissmodel":i=yield Od(o.params.id,d=>`https://swissmodel.expasy.org/repository/uniprot/${d.toUpperCase()}.pdb`,d=>`SWISS-MODEL: ${d}`,!1),a=!!o.params.options.asTrajectory,s="pdb";break;case"alphafolddb":i=yield Od(o.params.id,d=>N(void 0,null,function*(){let m=`https://www.alphafold.ebi.ac.uk/api/prediction/${d.toUpperCase()}`,p=yield r.runTask(r.fetch({url:m,type:"json"}));if(Array.isArray(p)&&p.length>0)return p[0].cifUrl;throw new Error(`No AlphaFold DB entry for '${d}'`)}),d=>`AlphaFold DB: ${d}`,!1),a=!!o.params.options.asTrajectory,s="mmcif";break;case"modelarchive":i=yield Od(o.params.id,d=>`https://www.modelarchive.org/doi/10.5452/${d.toLowerCase()}.cif`,d=>`Model Archive: ${d}`,!1),a=!!o.params.options.asTrajectory,s="mmcif";break;case"pubchem":i=yield Od(o.params.id,d=>`https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/CID/${d.trim()}/record/SDF/?record_type=3d`,d=>`PubChem: ${d}`,!1),a=!!o.params.options.asTrajectory,s="mol";break;default:ur(o)}let l=t.source.params.options.representation||r.config.get(Wt.Structure.DefaultRepresentationPreset)||Ms.auto.id,c=l!==Ms.empty.id,u=o.params.options.type.name==="auto"?void 0:o.params.options.type;yield e.transaction(()=>N(void 0,null,function*(){if(i.length>0&&a){let d=yield r.builders.data.downloadBlob({sources:i.map((p,h)=>({id:""+h,url:p.url,isBinary:p.isBinary})),maxConcurrency:6},{state:{isGhost:!0}}),m=yield r.builders.structure.parseTrajectory(d,{formats:i.map((p,h)=>({id:""+h,format:"cif"}))});yield r.builders.structure.hierarchy.applyPreset(m,"default",{structure:u,showUnitcell:c,representationPreset:l,representationPresetParams:t.source.params.options.representationParams})}else for(let d of i){let m=yield r.builders.data.download(d,{state:{isGhost:!0}}),p=r.dataFormats.get(s);if(!p)throw new Error("unknown file format");let h=yield r.builders.structure.parseTrajectory(m,p);yield r.builders.structure.hierarchy.applyPreset(h,"default",{structure:u,showUnitcell:c,representationPreset:l,representationPresetParams:t.source.params.options.representationParams})}})).runInContext(n)})));function Od(t,e,r,n){return N(this,null,function*(){let o=t.split(/[,\s]/).map(a=>a.trim()).filter(a=>!!a&&(a.length>=4||/^[1-9][0-9]*$/.test(a))),i=[];for(let a of o)i.push({url:Wr.Url(yield e(a)),isBinary:n,label:r(a)});return i})}function lPe(t){return N(this,null,function*(){if(t.name!=="pdb"||t.params.provider.server.name!=="pdbe")throw new Error("expected pdbe");return t.params.provider.server.params.variant==="updated"?Od(t.params.provider.id,e=>`https://www.ebi.ac.uk/pdbe/static/entry/${e.toLowerCase()}_updated.cif`,e=>`PDBe: ${e} (updated cif)`,!1):t.params.provider.server.params.variant==="updated-bcif"?Od(t.params.provider.id,e=>`https://www.ebi.ac.uk/pdbe/entry-files/download/${e.toLowerCase()}.bcif`,e=>`PDBe: ${e} (updated cif)`,!0):Od(t.params.provider.id,e=>`https://www.ebi.ac.uk/pdbe/static/entry/${e.toLowerCase()}.cif`,e=>`PDBe: ${e} (cif)`,!1)})}function cPe(t){return N(this,null,function*(){if(t.name!=="pdb"||t.params.provider.server.name!=="pdbj")throw new Error("expected pdbj");return Od(t.params.provider.id,e=>`https://data.pdbjbk1.pdbj.org/pub/pdb/data/structures/divided/mmCIF/${e.toLowerCase().substring(1,3)}/${e.toLowerCase()}.cif`,e=>`PDBj: ${e} (cif)`,!1)})}function uPe(t){return N(this,null,function*(){if(t.name!=="pdb"||t.params.provider.server.name!=="rcsb")throw new Error("expected rcsb");return t.params.provider.server.params.encoding==="cif"?Od(t.params.provider.id,e=>`https://files.rcsb.org/download/${e.toUpperCase()}.cif`,e=>`RCSB PDB: ${e} (cif)`,!1):Od(t.params.provider.id,e=>`https://models.rcsb.org/${e.toUpperCase()}.bcif`,e=>`RCSB PDB: ${e} (bcif)`,!0)})}var pS=Gi.build({display:{name:"Update Trajectory"},params:{action:g.Select("advance",g.arrayToOptions(["advance","reset"])),by:g.Optional(g.Numeric(1,{min:-1,max:1,step:1}))}})(({params:t,state:e})=>{let r=e.selectQ(o=>o.ofTransformer(de.Model.ModelFromTrajectory)),n=e.build();if(t.action==="reset")for(let o of r)n.to(o).update({modelIndex:0});else for(let o of r){let i=lt.findAncestorOfType(e.tree,e.cells,o.transform.ref,X.Molecule.Trajectory);if(!i||!i.obj)continue;let a=i.obj;n.to(o).update(s=>{let l=(s.modelIndex+t.by)%a.data.frameCount;return l<0&&(l+=a.data.frameCount),{modelIndex:l}})}return e.updateTree(n)}),dPe=Gi.build({display:{name:"Custom Model Properties",description:"Enable parameters for custom properties of the model."},from:X.Molecule.Model,params(t,e){return e.customModelProperties.getParams(t?.data)},isApplicable(t,e,r){return e.transformer!==LR}})(({ref:t,params:e},r)=>r.builders.structure.insertModelProperties(t,e)),mPe=Gi.build({display:{name:"Custom Structure Properties",description:"Enable parameters for custom properties of the structure."},from:X.Molecule.Structure,params(t,e){return e.customStructureProperties.getParams(t?.data)},isApplicable(t,e,r){return e.transformer!==BR}})(({ref:t,params:e},r)=>r.builders.structure.insertStructureProperties(t,e)),pPe=Gi.build({display:{name:"Add Trajectory",description:"Add trajectory from existing model/topology and coordinates."},from:X.Root,params(t,e){let r=e.state.data,o=[...r.selectQ(s=>s.rootsOfType(X.Molecule.Model)),...r.selectQ(s=>s.rootsOfType(X.Molecule.Topology))].map(s=>[s.transform.ref,s.obj.label]),a=r.selectQ(s=>s.rootsOfType(X.Molecule.Coordinates)).map(s=>[s.transform.ref,s.obj.label]);return{model:g.Select(o.length?o[0][0]:"",o),coordinates:g.Select(a.length?a[0][0]:"",a)}}})(({params:t,state:e},r)=>ie.create("Add Trajectory",n=>e.transaction(()=>N(void 0,null,function*(){let o=[t.model,t.coordinates],i=e.build().toRoot().apply(Nw,{modelRef:t.model,coordinatesRef:t.coordinates},{dependsOn:o}).apply(de.Model.ModelFromTrajectory,{modelIndex:0});yield e.updateTree(i).runInContext(n);let a=yield r.builders.structure.createStructure(i.selector);yield r.builders.structure.representation.applyPreset(a,"auto")})).runInContext(n))),fPe=Gi.build({display:{name:"Load Trajectory",description:"Load trajectory of model/topology and coordinates from URL or file."},from:X.Root,params(t,e){let{options:r}=e.dataFormats,n=r.filter(s=>s[2]===_u||s[2]===$v),o=r.filter(s=>s[2]===gy),i=[],a=[];for(let{provider:s}of e.dataFormats.list)s.category===_u||s.category===$v?(s.binaryExtensions&&i.push(...s.binaryExtensions),s.stringExtensions&&i.push(...s.stringExtensions)):s.category===gy&&(s.binaryExtensions&&a.push(...s.binaryExtensions),s.stringExtensions&&a.push(...s.stringExtensions));return{source:g.MappedStatic("file",{url:g.Group({model:g.Group({url:g.Url(""),format:g.Select(n[0][0],n),isBinary:g.Boolean(!1)},{isExpanded:!0}),coordinates:g.Group({url:g.Url(""),format:g.Select(o[0][0],o)},{isExpanded:!0})},{isFlat:!0}),file:g.Group({model:g.File({accept:i.map(s=>`.${s}`).join(","),label:"Model"}),coordinates:g.File({accept:a.map(s=>`.${s}`).join(","),label:"Coordinates"})},{isFlat:!0})},{options:[["url","URL"],["file","File"]]})}}})(({params:t,state:e},r)=>ie.create("Load Trajectory",n=>e.transaction(()=>N(void 0,null,function*(){let o=t.source;if(o.name==="file"&&(o.params.model===null||o.params.coordinates===null)){r.log.error("No file(s) selected");return}if(o.name==="url"&&(!o.params.model||!o.params.coordinates)){r.log.error("No URL(s) given");return}let i=(s,l,c)=>N(void 0,null,function*(){let u=yield r.builders.data.download({url:s,isBinary:c}),d=r.dataFormats.get(l);if(!d){r.log.warn(`LoadTrajectory: could not find data provider for '${l}'`);return}return d.parse(r,u)}),a=s=>N(void 0,null,function*(){var l,c,u;if(!s)throw new Error("No file selected");let d=kp((c=(l=s.file)===null||l===void 0?void 0:l.name)!==null&&c!==void 0?c:""),m=r.dataFormats.binaryExtensions.has(d.ext),{data:p}=yield r.builders.data.readFile({file:s,isBinary:m}),h=r.dataFormats.auto(d,(u=p.cell)===null||u===void 0?void 0:u.obj);if(!h){r.log.warn(`LoadTrajectory: could not find data provider for '${d.ext}'`),yield r.state.data.build().delete(p).commit();return}return h.parse(r,p)});try{let s=o.name==="url"?yield i(o.params.model.url,o.params.model.format,o.params.model.isBinary):yield a(o.params.model),l;"trajectory"in s?l=yield e.build().to(s.trajectory).apply(RR,{modelIndex:0}).commit():l=s.topology;let c=o.name==="url"?yield i(o.params.coordinates.url,o.params.coordinates.format,!0):yield a(o.params.coordinates),u=[l.ref,c.ref],d=e.build().toRoot().apply(Nw,{modelRef:l.ref,coordinatesRef:c.ref},{dependsOn:u}).apply(de.Model.ModelFromTrajectory,{modelIndex:0});yield e.updateTree(d).runInContext(n);let m=yield r.builders.structure.createStructure(d.selector);yield r.builders.structure.representation.applyPreset(m,"auto")}catch(s){console.error(s),r.log.error("Error loading trajectory")}})).runInContext(n)));var JL={};ua(JL,{AssignColorVolume:()=>ZL,DownloadDensity:()=>hPe});var hPe=Gi.build({from:X.Root,display:{name:"Download Density",description:"Load a density from the provided source and create its default visual."},params:(t,e)=>{let{options:r}=e.dataFormats;return{source:g.MappedStatic("pdb-xray",{"pdb-xray":g.Group({provider:g.Group({id:g.Text("1tqn",{label:"Id"}),server:g.Select("rcsb",[["pdbe","PDBe"],["rcsb","RCSB PDB"]])},{pivot:"id"}),type:g.Select("2fofc",[["2fofc","2Fo-Fc"],["fofc","Fo-Fc"]])},{isFlat:!0}),"pdb-xray-ds":g.Group({provider:g.Group({id:g.Text("1tqn",{label:"Id"}),server:g.Select("pdbe",[["pdbe","PDBe"],["rcsb","RCSB PDB"]])},{pivot:"id"}),detail:g.Numeric(3,{min:0,max:6,step:1},{label:"Detail"})},{isFlat:!0}),"pdb-emd-ds":g.Group({provider:g.Group({id:g.Text("emd-8004",{label:"Id"}),server:g.Select("pdbe",[["pdbe","PDBe"],["rcsb","RCSB PDB"]])},{pivot:"id"}),detail:g.Numeric(3,{min:0,max:6,step:1},{label:"Detail"})},{isFlat:!0}),url:g.Group({url:g.Url(""),isBinary:g.Boolean(!1),format:g.Select("auto",r)},{isFlat:!0})},{options:[["pdb-xray","PDB X-ray maps"],["pdb-emd-ds","PDB EMD Density Server"],["pdb-xray-ds","PDB X-ray Density Server"],["url","URL"]]})}}})(({params:t},e)=>ie.create("Download Density",r=>N(void 0,null,function*(){var n,o;let i=t.source,a,s;switch(i.name){case"url":a=i.params;break;case"pdb-xray":a=i.params.provider.server==="pdbe"?{url:Wr.Url(i.params.type==="2fofc"?`https://www.ebi.ac.uk/pdbe/coordinates/files/${i.params.provider.id.toLowerCase()}.ccp4`:`https://www.ebi.ac.uk/pdbe/coordinates/files/${i.params.provider.id.toLowerCase()}_diff.ccp4`),isBinary:!0,label:`PDBe X-ray map: ${i.params.provider.id}`}:{url:Wr.Url(i.params.type==="2fofc"?`https://edmaps.rcsb.org/maps/${i.params.provider.id.toLowerCase()}_2fofc.dsn6`:`https://edmaps.rcsb.org/maps/${i.params.provider.id.toLowerCase()}_fofc.dsn6`),isBinary:!0,label:`RCSB X-ray map: ${i.params.provider.id}`};break;case"pdb-emd-ds":a=i.params.provider.server==="pdbe"?{url:Wr.Url(`https://www.ebi.ac.uk/pdbe/densities/emd/${i.params.provider.id.toLowerCase()}/cell?detail=${i.params.detail}`),isBinary:!0,label:`PDBe EMD Density Server: ${i.params.provider.id}`}:{url:Wr.Url(`https://maps.rcsb.org/em/${i.params.provider.id.toLowerCase()}/cell?detail=${i.params.detail}`),isBinary:!0,label:`RCSB PDB EMD Density Server: ${i.params.provider.id}`};break;case"pdb-xray-ds":a=i.params.provider.server==="pdbe"?{url:Wr.Url(`https://www.ebi.ac.uk/pdbe/densities/x-ray/${i.params.provider.id.toLowerCase()}/cell?detail=${i.params.detail}`),isBinary:!0,label:`PDBe X-ray Density Server: ${i.params.provider.id}`}:{url:Wr.Url(`https://maps.rcsb.org/x-ray/${i.params.provider.id.toLowerCase()}/cell?detail=${i.params.detail}`),isBinary:!0,label:`RCSB PDB X-ray Density Server: ${i.params.provider.id}`};break;default:ur(i)}let l=yield e.builders.data.download(a),c;switch(i.name){case"url":a=i.params,s=i.params.format==="auto"?e.dataFormats.auto(kp(Wr.getUrl(a.url)),(n=l.cell)===null||n===void 0?void 0:n.obj):e.dataFormats.get(i.params.format);break;case"pdb-xray":c=i.params.provider.id,s=i.params.provider.server==="pdbe"?e.dataFormats.get("ccp4"):e.dataFormats.get("dsn6");break;case"pdb-emd-ds":case"pdb-xray-ds":c=i.params.provider.id,s=e.dataFormats.get("dscif");break;default:ur(i)}if(!s){e.log.warn("DownloadDensity: Format provider not found.");return}let u=yield s.parse(e,l,{entryId:c});yield(o=s.visuals)===null||o===void 0?void 0:o.call(s,e,u)}))),ZL=Gi.build({display:{name:"Assign Volume Colors",description:"Assigns another volume to be available for coloring."},from:X.Volume.Data,isApplicable(t){return!t.data.colorVolume},params(t,e){let r=e.state.data.select(lt.Generators.root.subtree().ofType(X.Volume.Data).filter(n=>{var o;return!!n.obj&&!(!((o=n.obj)===null||o===void 0)&&o.data.colorVolume)&&n.obj!==t}));return r.length===0?{ref:g.Text("",{isHidden:!0,label:"Volume"})}:{ref:g.Select(r[0].transform.ref,r.map(n=>[n.transform.ref,n.obj.label]),{label:"Volume"})}}})(({ref:t,params:e,state:r},n)=>n.build().to(t).apply(de.Volume.AssignColorVolume,{ref:e.ref},{dependsOn:[e.ref]}).commit());var eB={};ua(eB,{DownloadFile:()=>gPe,OpenFiles:()=>fS});function Z_(t,e,r,n){return N(this,null,function*(){var o,i,a,s;let l=kp((i=(o=t.file)===null||o===void 0?void 0:o.name)!==null&&i!==void 0?i:""),c=e.dataFormats.binaryExtensions.has(l.ext),{data:u}=yield e.builders.data.readFile({file:t,isBinary:c}),d=r==="auto"?e.dataFormats.auto(l,(a=u.cell)===null||a===void 0?void 0:a.obj):e.dataFormats.get(r);if(!d){e.log.warn(`OpenFiles: could not find data provider for '${l.ext}'`),yield e.state.data.build().delete(u).commit();return}let m=yield d.parse(e,u);n&&(yield(s=d.visuals)===null||s===void 0?void 0:s.call(d,e,m))})}var fS=Gi.build({display:{name:"Open Files",description:"Load one or more files and optionally create default visuals"},from:X.Root,params:(t,e)=>{let{extensions:r,options:n}=e.dataFormats;return{files:g.FileList({accept:Array.from(r.values()).map(o=>`.${o}`).join(",")+",.gz,.zip",multiple:!0}),format:g.MappedStatic("auto",{auto:g.EmptyGroup(),specific:g.Select(n[0][0],n)}),visuals:g.Boolean(!0,{description:"Add default visuals"})}}})(({params:t,state:e},r)=>ie.create("Open Files",n=>N(void 0,null,function*(){r.behaviors.layout.leftPanelTabName.next("data"),yield e.transaction(()=>N(void 0,null,function*(){if(t.files===null){r.log.error("No file(s) selected");return}for(let o of t.files)try{if(o.file&&o.name.toLowerCase().endsWith(".zip")){let i=yield AA(n,yield o.file.arrayBuffer());for(let[a,s]of Object.entries(i)){if(!(s instanceof Uint8Array)||s.length===0)continue;let l=Wr.File(new File([s],a));yield Z_(l,r,"auto",t.visuals)}}else{let i=t.format.name==="auto"?"auto":t.format.params;yield Z_(o,r,i,t.visuals)}}catch(i){console.error(i),r.log.error(`Error opening file '${o.name}'`)}})).runInContext(n)}))),gPe=Gi.build({display:{name:"Download File",description:"Load one or more file from an URL"},from:X.Root,params:(t,e)=>{let r=[...e.dataFormats.options,["zip","Zip"],["gzip","Gzip"]];return{url:g.Url(""),format:g.Select(r[0][0],r),isBinary:g.Boolean(!1),visuals:g.Boolean(!0,{description:"Add default visuals"})}}})(({params:t,state:e},r)=>ie.create("Open Files",n=>N(void 0,null,function*(){r.behaviors.layout.leftPanelTabName.next("data"),yield e.transaction(()=>N(void 0,null,function*(){var o,i,a;try{if(t.format==="zip"||t.format==="gzip"){let s=yield r.builders.data.download({url:t.url,isBinary:!0});if(t.format==="zip"){let l=yield AA(n,((o=s.obj)===null||o===void 0?void 0:o.data).buffer);for(let[c,u]of Object.entries(l)){if(!(u instanceof Uint8Array)||u.length===0)continue;let d=Wr.File(new File([u],c));yield Z_(d,r,"auto",t.visuals)}}else{let l=Wr.getUrl(t.url),c=kp(l).name;yield Z_(Wr.File(new File([(i=s.obj)===null||i===void 0?void 0:i.data],c)),r,"auto",t.visuals)}}else{let s=r.dataFormats.get(t.format);if(!s){r.log.warn(`DownloadFile: could not find data provider for '${t.format}'`);return}let l=yield r.builders.data.download({url:t.url,isBinary:t.isBinary}),c=yield s.parse(r,l);t.visuals&&(yield(a=s.visuals)===null||a===void 0?void 0:a.call(s,r,c))}}catch(s){console.error(s),r.log.error(`Error downloading '${typeof t.url=="string"?t.url:t.url.url}'`)}})).runInContext(n)})));var wh={Structure:$L,Volume:JL,DataFormat:eB};var $Z=As.create({name:"built-in.animate-state-interpolation",display:{name:"Animate State (experimental)"},params:()=>({transtionDurationInMs:g.Numeric(2e3,{min:100,max:3e4,step:10})}),canApply(t){return{canApply:t.managers.snapshot.state.entries.size>1}},initialState:()=>({}),apply(t,e,r){return N(this,null,function*(){let n=r.plugin.managers.snapshot.state.entries;if(n.size<2)return{kind:"finished"};let o=e.current%r.params.transtionDurationInMs/r.params.transtionDurationInMs,i=Math.floor(e.current/r.params.transtionDurationInMs)%n.size,a=Math.ceil(e.current/r.params.transtionDurationInMs);a===i&&a++,a=a%n.size;let s=n.get(i).snapshot,l=n.get(a).snapshot;if(!s.data||!l.data)return{kind:"skip"};let c=s.data.tree.transforms,u=l.data.tree.transforms,d=r.plugin.state.data,m=d.build();for(let p of c)for(let h of u){if(h.ref!==p.ref||h.version===p.version)continue;let f=kt.fromJSON(p),b=kt.fromJSON(h),v=d.cells.get(p.ref);if(!v)continue;let x;f.transformer.definition.interpolate?x=f.transformer.definition.interpolate(f.params,b.params,o,r.plugin):x=o<=.5?f.params:b.params,ep(v,x)||m.to(p.ref).update(x)}return yield Re.State.Update(r.plugin,{state:d,tree:m,options:{doNotLogTiming:!0}}),{kind:"next",state:{}}})}});var ZZ=As.create({name:"built-in.animate-structure-spin",display:{name:"Spin Structure"},isExportable:!0,params:()=>({durationInMs:g.Numeric(3e3,{min:100,max:1e4,step:100})}),initialState:()=>({t:0}),getDuration:t=>({kind:"fixed",durationMs:t.durationInMs}),setup(t,e,r){return N(this,null,function*(){let n=r.state.data,o=n.select(lt.Generators.ofType(X.Molecule.Structure.Representation3D)),i=n.build(),a=!1;for(let s of o)n.select(lt.Generators.ofTransformer(de.Representation.SpinStructureRepresentation3D,s.transform.ref)).length>0||(a=!0,i.to(s.transform.ref).apply(de.Representation.SpinStructureRepresentation3D,{t:0},{tags:"animate-structure-spin"}));if(a)return i.commit({doNotUpdateCurrent:!0})})},teardown(t,e,r){let n=r.state.data,o=n.select(lt.Generators.ofType(X.Molecule.Structure.Representation3DState).withTag("animate-structure-spin"));if(o.length===0)return;let i=n.build();for(let a of o)i.delete(a.transform.ref);return i.commit()},apply(t,e,r){return N(this,null,function*(){var n;let o=r.plugin.state.data,i=o.select(lt.Generators.ofTransformer(de.Representation.SpinStructureRepresentation3D));if(i.length===0)return{kind:"finished"};let a=o.build(),s=(e.current-e.lastApplied)/r.params.durationInMs,l=(t.t+s)%1;for(let c of i)a.to(c).update(U(w({},(n=c.params)===null||n===void 0?void 0:n.values),{t:l}));return yield Re.State.Update(r.plugin,{state:o,tree:a,options:{doNotLogTiming:!0}}),{kind:"next",state:{t:l}}})}});var J_=y(),JZ=y(),eJ=xn(),tJ=As.create({name:"built-in.animate-camera-rock",display:{name:"Camera Rock",description:"Rock the 3D scene around the x-axis in view space"},isExportable:!0,params:()=>({durationInMs:g.Numeric(4e3,{min:100,max:2e4,step:100}),speed:g.Numeric(1,{min:1,max:10,step:1},{description:"How many times to rock from side to side."}),angle:g.Numeric(10,{min:0,max:180,step:1},{description:"How many degrees to rotate in each direction."})}),initialState:(t,e)=>({snapshot:e.canvas3d.camera.getSnapshot()}),getDuration:t=>({kind:"fixed",durationMs:t.durationInMs}),teardown:(t,e,r)=>{var n;(n=r.canvas3d)===null||n===void 0||n.requestCameraReset({snapshot:e.snapshot,durationMs:0})},apply(t,e,r){return N(this,null,function*(){var n,o;if(e.current===0)return{kind:"next",state:t};let i=t.snapshot;if(i.radiusMax<1e-4)return{kind:"finished"};let a=e.animation?((n=e.animation)===null||n===void 0?void 0:n.currentFrame)/(e.animation.frameCount+1):Wo(e.current/r.params.durationInMs,0,1),s=Math.sin(a*r.params.speed*Math.PI*2)*or(r.params.angle);y.sub(J_,i.position,i.target),y.normalize(JZ,i.up),xn.setAxisAngle(eJ,JZ,s),y.transformQuat(J_,J_,eJ);let l=y.add(y(),i.target,J_);return(o=r.plugin.canvas3d)===null||o===void 0||o.requestCameraReset({snapshot:U(w({},i),{position:l}),durationMs:0}),a>=.99999?{kind:"finished"}:{kind:"next",state:t}})}});var Ht;(function(t){function e(n,o){return{action:n,customControl:o&&o.customControl,autoUpdate:o&&o.autoUpdate}}t.Action=e;function r(n,o={}){return{transformer:n,defaultParams:o}}t.Behavior=r})(Ht||(Ht={}));var rJ=()=>({actions:[Ht.Action(wh.Structure.DownloadStructure),Ht.Action(wh.Volume.DownloadDensity),Ht.Action(wh.DataFormat.DownloadFile),Ht.Action(wh.DataFormat.OpenFiles),Ht.Action(wh.Structure.LoadTrajectory),Ht.Action(wh.Structure.EnableModelCustomProps),Ht.Action(wh.Structure.EnableStructureCustomProps),Ht.Action(q1),Ht.Action(KW),Ht.Action(W1),Ht.Action(de.Data.Download),Ht.Action(de.Data.ParseCif),Ht.Action(de.Data.ParseCcp4),Ht.Action(de.Data.ParseDsn6),Ht.Action(de.Model.TrajectoryFromMmCif),Ht.Action(de.Model.TrajectoryFromCifCore),Ht.Action(de.Model.TrajectoryFromPDB),Ht.Action(de.Model.TransformStructureConformation),Ht.Action(de.Model.StructureFromModel),Ht.Action(de.Model.StructureFromTrajectory),Ht.Action(de.Model.ModelFromTrajectory),Ht.Action(de.Model.StructureSelectionFromScript),Ht.Action(de.Representation.StructureRepresentation3D),Ht.Action(de.Representation.StructureSelectionsDistance3D),Ht.Action(de.Representation.StructureSelectionsAngle3D),Ht.Action(de.Representation.StructureSelectionsDihedral3D),Ht.Action(de.Representation.StructureSelectionsLabel3D),Ht.Action(de.Representation.StructureSelectionsOrientation3D),Ht.Action(de.Representation.ModelUnitcell3D),Ht.Action(de.Representation.StructureBoundingBox3D),Ht.Action(de.Representation.ExplodeStructureRepresentation3D),Ht.Action(de.Representation.SpinStructureRepresentation3D),Ht.Action(de.Representation.UnwindStructureAssemblyRepresentation3D),Ht.Action(de.Representation.OverpaintStructureRepresentation3DFromScript),Ht.Action(de.Representation.TransparencyStructureRepresentation3DFromScript),Ht.Action(de.Representation.ClippingStructureRepresentation3DFromScript),Ht.Action(de.Representation.SubstanceStructureRepresentation3DFromScript),Ht.Action(de.Representation.ThemeStrengthRepresentation3D),Ht.Action(ZL),Ht.Action(de.Volume.VolumeFromCcp4),Ht.Action(de.Volume.VolumeFromDsn6),Ht.Action(de.Volume.VolumeFromCube),Ht.Action(de.Volume.VolumeFromDx),Ht.Action(de.Representation.VolumeRepresentation3D)],behaviors:[Ht.Behavior(cl.Representation.HighlightLoci),Ht.Behavior(cl.Representation.SelectLoci),Ht.Behavior(cl.Representation.DefaultLociLabelProvider),Ht.Behavior(cl.Representation.FocusLoci),Ht.Behavior(cl.Camera.FocusLoci),Ht.Behavior(cl.Camera.CameraAxisHelper),Ht.Behavior(cl.Camera.CameraControls),Ht.Behavior(my),Ht.Behavior(cl.CustomProps.StructureInfo),Ht.Behavior(cl.CustomProps.AccessibleSurfaceArea),Ht.Behavior(cl.CustomProps.BestDatabaseSequenceMapping),Ht.Behavior(cl.CustomProps.Interactions),Ht.Behavior(cl.CustomProps.SecondaryStructure),Ht.Behavior(cl.CustomProps.ValenceModel),Ht.Behavior(cl.CustomProps.CrossLinkRestraint)],animations:[$Y,KY,tJ,JY,XY,ZZ,$Z]});var Os=Ot(Or());var vy=Ot(Or()),Jv=Ot(Po());var Kr=Ot(Or()),Rp=Ot(Po());var ye=Ot(Or());function pr(t){return t.svg?(0,ye.jsx)("span",{className:`msp-icon msp-material-icon${t.inline?" msp-icon-inline":""}`,title:t.title,style:t.style,children:(0,ye.jsx)(t.svg,{})}):null}var oP=(0,ye.jsx)("circle",{r:"6px",id:"circle-left",cy:"12px",cx:"8px",strokeWidth:"1px"}),iP=(0,ye.jsx)("circle",{r:"6px",id:"circle-right",cy:"12px",cx:"16px",strokeWidth:"1px"}),NPe=(0,ye.jsxs)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:[(0,ye.jsxs)("defs",{children:[oP,iP]}),(0,ye.jsxs)("g",{children:[(0,ye.jsx)("use",{href:"#circle-left",className:"msp-shape-filled"}),(0,ye.jsx)("use",{href:"#circle-right",className:"msp-shape-filled"}),(0,ye.jsx)("use",{href:"#circle-left",className:"msp-shape-empty"})]})]});function gS(){return NPe}var VPe=(0,ye.jsxs)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:[(0,ye.jsxs)("defs",{children:[oP,iP,(0,ye.jsxs)("mask",{id:"mask-left",children:[(0,ye.jsx)("use",{href:"#circle-left",fill:"white",stroke:"white"}),(0,ye.jsx)("use",{href:"#circle-right",fill:"black",strokeWidth:"0px",stroke:"white"})]})]}),(0,ye.jsxs)("g",{children:[(0,ye.jsx)("use",{href:"#circle-left",className:"msp-shape-filled",mask:"url(#mask-left)"}),(0,ye.jsx)("use",{href:"#circle-right",className:"msp-shape-empty"})]})]});function yS(){return VPe}var zPe=(0,ye.jsxs)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:[(0,ye.jsxs)("defs",{children:[oP,iP,(0,ye.jsx)("clipPath",{id:"clip-left",children:(0,ye.jsx)("use",{href:"#circle-right"})})]}),(0,ye.jsxs)("g",{children:[(0,ye.jsx)("use",{href:"#circle-left",className:"msp-shape-filled",clipPath:"url(#clip-left)"}),(0,ye.jsx)("use",{href:"#circle-left",className:"msp-shape-empty"}),(0,ye.jsx)("use",{href:"#circle-right",className:"msp-shape-empty"})]})]});function vS(){return zPe}var UPe=(0,ye.jsxs)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:[(0,ye.jsxs)("defs",{children:[oP,iP]}),(0,ye.jsxs)("g",{children:[(0,ye.jsx)("use",{href:"#circle-left",className:"msp-shape-empty"}),(0,ye.jsx)("use",{href:"#circle-right",className:"msp-shape-filled"})]})]});function yy(){return UPe}var GPe=(0,ye.jsx)("svg",{width:"17px",height:"17px",viewBox:"0 0 299.463 299.463",strokeWidth:"6px",children:(0,ye.jsx)("g",{children:(0,ye.jsx)("path",{d:"M256.851,173.832v-48.201c22.916-4.918,34.151-30.668,22.556-50.771c-11.547-20.004-39.486-23.251-55.242-5.844 l-41.746-24.106C189.618,22.603,172.861,0,149.734,0c-23.132,0-39.881,22.609-32.685,44.911L75.305,69.016 C59.522,51.586,31.597,54.88,20.061,74.863c-11.63,20.163-0.298,45.862,22.557,50.769v48.2 c-22.821,4.898-34.195,30.591-22.556,50.771c11.529,19.972,39.454,23.285,55.242,5.845l41.746,24.106 c-7.199,22.308,9.559,44.911,32.685,44.911c23.132,0,39.88-22.609,32.685-44.911l41.745-24.106 c15.817,17.469,43.73,14.099,55.242-5.844c0,0,0-0.001,0.001-0.002c4.587-7.953,5.805-17.213,3.431-26.076 C279.392,185.657,269.129,176.461,256.851,173.832z M249.62,72.088c20.568,0,27.428,27.191,10.008,37.239 c-0.003,0.002-0.006,0.003-0.009,0.005c-10.04,5.81-22.85,1.762-27.877-8.475C225.206,87.548,234.938,72.088,249.62,72.088z M149.734,14.4c11.005,0,19.958,8.954,19.958,19.959c0,11.127-9.077,19.958-19.958,19.958c-10.95,0-19.958-8.9-19.958-19.958 C129.776,23.354,138.729,14.4,149.734,14.4z M39.84,109.328c-17.451-10.067-10.534-37.24,10.01-37.24 c15.311,0,24.922,16.653,17.251,29.942C61.681,111.397,49.517,114.925,39.84,109.328z M59.802,224.702 c-9.535,5.503-21.768,2.229-27.268-7.298c-7.639-13.242,1.887-29.945,17.236-29.945c0.013,0,0.027,0,0.04,0 C70.07,187.48,77.49,214.469,59.802,224.702z M149.734,285.062c-11.005,0-19.958-8.954-19.958-19.958 c0-11.127,9.077-19.958,19.958-19.958c10.954,0,19.958,8.903,19.958,19.958C169.693,276.109,160.74,285.062,149.734,285.062z M216.953,217.982l-41.727,24.095c-13.778-15.22-37.459-14.94-50.983,0l-41.728-24.096c6.196-19.289-5.541-39.835-25.498-44.149 V125.63c19.752-4.268,31.762-24.65,25.498-44.149l41.727-24.095c13.629,15.055,37.32,15.093,50.983,0l41.728,24.096 c-6.196,19.29,5.534,39.835,25.498,44.149v48.202C222.61,178.123,210.721,198.581,216.953,217.982z M266.935,217.404 c-5.501,9.528-17.732,12.802-27.261,7.302c-17.682-10.23-10.301-37.247,10.032-37.247 C264.984,187.459,274.602,204.112,266.935,217.404z"})})});function bJ(){return GPe}var jPe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",strokeWidth:"0.1px",children:(0,ye.jsx)("path",{d:"M21,16.5C21,16.88 20.79,17.21 20.47,17.38L12.57,21.82C12.41,21.94 12.21,22 12,22C11.79,22 11.59,21.94 11.43,21.82L3.53,17.38C3.21,17.21 3,16.88 3,16.5V7.5C3,7.12 3.21,6.79 3.53,6.62L11.43,2.18C11.59,2.06 11.79,2 12,2C12.21,2 12.41,2.06 12.57,2.18L20.47,6.62C20.79,6.79 21,7.12 21,7.5V16.5M12,4.15L6.04,7.5L12,10.85L17.96,7.5L12,4.15M5,15.91L11,19.29V12.58L5,9.21V15.91M19,15.91V9.21L13,12.58V19.29L19,15.91Z"})});function bS(){return jPe}var gFt=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",strokeWidth:"0.1px",children:(0,ye.jsx)("path",{d:"M17,22V20H20V17H22V20.5C22,20.89 21.84,21.24 21.54,21.54C21.24,21.84 20.89,22 20.5,22H17M7,22H3.5C3.11,22 2.76,21.84 2.46,21.54C2.16,21.24 2,20.89 2,20.5V17H4V20H7V22M17,2H20.5C20.89,2 21.24,2.16 21.54,2.46C21.84,2.76 22,3.11 22,3.5V7H20V4H17V2M7,2V4H4V7H2V3.5C2,3.11 2.16,2.76 2.46,2.46C2.76,2.16 3.11,2 3.5,2H7M13,17.25L17,14.95V10.36L13,12.66V17.25M12,10.92L16,8.63L12,6.28L8,8.63L12,10.92M7,14.95L11,17.25V12.66L7,10.36V14.95M18.23,7.59C18.73,7.91 19,8.34 19,8.91V15.23C19,15.8 18.73,16.23 18.23,16.55L12.75,19.73C12.25,20.05 11.75,20.05 11.25,19.73L5.77,16.55C5.27,16.23 5,15.8 5,15.23V8.91C5,8.34 5.27,7.91 5.77,7.59L11.25,4.41C11.5,4.28 11.75,4.22 12,4.22C12.25,4.22 12.5,4.28 12.75,4.41L18.23,7.59Z"})});var yFt=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",strokeWidth:"0.1px",children:(0,ye.jsx)("path",{d:"M16,4L9,8.04V15.96L16,20L23,15.96V8.04M16,6.31L19.8,8.5L16,10.69L12.21,8.5M0,7V9H7V7M11,10.11L15,12.42V17.11L11,14.81M21,10.11V14.81L17,17.11V12.42M2,11V13H7V11M4,15V17H7V15"})});var HPe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M10.07,14.27C10.57,14.03 11.16,14.25 11.4,14.75L13.7,19.74L15.5,18.89L13.19,13.91C12.95,13.41 13.17,12.81 13.67,12.58L13.95,12.5L16.25,12.05L8,5.12V15.9L9.82,14.43L10.07,14.27M13.64,21.97C13.14,22.21 12.54,22 12.31,21.5L10.13,16.76L7.62,18.78C7.45,18.92 7.24,19 7,19A1,1 0 0,1 6,18V3A1,1 0 0,1 7,2C7.24,2 7.47,2.09 7.64,2.23L7.65,2.22L19.14,11.86C19.57,12.22 19.62,12.85 19.27,13.27C19.12,13.45 18.91,13.57 18.7,13.61L15.54,14.23L17.74,18.96C18,19.46 17.76,20.05 17.26,20.28L13.64,21.97Z"})});function qPe(){return HPe}var vFt=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",strokeWidth:"0.1px",children:(0,ye.jsx)("path",{fill:"currentColor",d:"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"})});var bFt=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",strokeWidth:"0.1px",children:(0,ye.jsx)("path",{fill:"currentColor",d:"M20,11H23V13H20V11M1,11H4V13H1V11M13,1V4H11V1H13M4.92,3.5L7.05,5.64L5.63,7.05L3.5,4.93L4.92,3.5M16.95,5.63L19.07,3.5L20.5,4.93L18.37,7.05L16.95,5.63M12,6A6,6 0 0,1 18,12C18,14.22 16.79,16.16 15,17.2V19A1,1 0 0,1 14,20H10A1,1 0 0,1 9,19V17.2C7.21,16.16 6,14.22 6,12A6,6 0 0,1 12,6M14,21V22A1,1 0 0,1 13,23H11A1,1 0 0,1 10,22V21H14M11,18H13V15.87C14.73,15.43 16,13.86 16,12A4,4 0 0,0 12,8A4,4 0 0,0 8,12C8,13.86 9.27,15.43 11,15.87V18Z"})});var WPe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{fill:"currentColor",d:"M7.5,5.6L5,7L6.4,4.5L5,2L7.5,3.4L10,2L8.6,4.5L10,7L7.5,5.6M19.5,15.4L22,14L20.6,16.5L22,19L19.5,17.6L17,19L18.4,16.5L17,14L19.5,15.4M22,2L20.6,4.5L22,7L19.5,5.6L17,7L18.4,4.5L17,2L19.5,3.4L22,2M13.34,12.78L15.78,10.34L13.66,8.22L11.22,10.66L13.34,12.78M14.37,7.29L16.71,9.63C17.1,10 17.1,10.65 16.71,11.04L5.04,22.71C4.65,23.1 4,23.1 3.63,22.71L1.29,20.37C0.9,20 0.9,19.35 1.29,18.96L12.96,7.29C13.35,6.9 14,6.9 14.37,7.29Z"})});function xJ(){return WPe}var XPe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",strokeWidth:"0.1px",children:(0,ye.jsx)("path",{d:"M3 17.25V21H6.75L17.81 9.93L14.06 6.18L3 17.25M22.61 18.36L18.36 22.61L13.16 17.41L14.93 15.64L15.93 16.64L18.4 14.16L19.82 15.58L18.36 17L19.42 18L20.84 16.6L22.61 18.36M6.61 10.83L1.39 5.64L5.64 1.39L7.4 3.16L4.93 5.64L6 6.7L8.46 4.22L9.88 5.64L8.46 7.05L9.46 8.05L6.61 10.83M20.71 7C21.1 6.61 21.1 6 20.71 5.59L18.37 3.29C18 2.9 17.35 2.9 16.96 3.29L15.12 5.12L18.87 8.87L20.71 7Z"})});function SJ(){return XPe}var YPe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M22 11V3h-7v3H9V3H2v8h7V8h2v10h4v3h7v-8h-7v3h-2V8h2v3h7zM7 9H4V5h3v4zm10 6h3v4h-3v-4zm0-10h3v4h-3V5z"})});function aB(){return YPe}var QPe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"})});function Fd(){return QPe}var KPe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M20 12l-1.41-1.41L13 16.17V4h-2v12.17l-5.58-5.59L4 12l8 8 8-8z"})});function _h(){return KPe}var $Pe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M7 10l5 5 5-5z"})});function Rs(){return $Pe}var ZPe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M10 17l5-5-5-5v10z"})});function Ls(){return ZPe}var JPe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M4 12l1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z"})});function Ph(){return JPe}var eEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M12 6v3l4-4-4-4v3c-4.42 0-8 3.58-8 8 0 1.57.46 3.03 1.24 4.26L6.7 14.8c-.45-.83-.7-1.79-.7-2.8 0-3.31 2.69-6 6-6zm6.76 1.74L17.3 9.2c.44.84.7 1.79.7 2.8 0 3.31-2.69 6-6 6v-3l-4 4 4 4v-3c4.42 0 8-3.58 8-8 0-1.57-.46-3.03-1.24-4.26z"})});function CJ(){return eEe}var tEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M6 13c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm0 4c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm0-8c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm-3 .5c-.28 0-.5.22-.5.5s.22.5.5.5.5-.22.5-.5-.22-.5-.5-.5zM6 5c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm15 5.5c.28 0 .5-.22.5-.5s-.22-.5-.5-.5-.5.22-.5.5.22.5.5.5zM14 7c.55 0 1-.45 1-1s-.45-1-1-1-1 .45-1 1 .45 1 1 1zm0-3.5c.28 0 .5-.22.5-.5s-.22-.5-.5-.5-.5.22-.5.5.22.5.5.5zm-11 10c-.28 0-.5.22-.5.5s.22.5.5.5.5-.22.5-.5-.22-.5-.5-.5zm7 7c-.28 0-.5.22-.5.5s.22.5.5.5.5-.22.5-.5-.22-.5-.5-.5zm0-17c.28 0 .5-.22.5-.5s-.22-.5-.5-.5-.5.22-.5.5.22.5.5.5zM10 7c.55 0 1-.45 1-1s-.45-1-1-1-1 .45-1 1 .45 1 1 1zm0 5.5c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5zm8 .5c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm0 4c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm0-8c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm0-4c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm3 8.5c-.28 0-.5.22-.5.5s.22.5.5.5.5-.22.5-.5-.22-.5-.5-.5zM14 17c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm0 3.5c-.28 0-.5.22-.5.5s.22.5.5.5.5-.22.5-.5-.22-.5-.5-.5zm-4-12c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5zm0 8.5c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm4-4.5c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5zm0-4c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5z"})});function sB(){return tEe}var rEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M15 7v12.97l-4.21-1.81-.79-.34-.79.34L5 19.97V7h10m4-6H8.99C7.89 1 7 1.9 7 3h10c1.1 0 2 .9 2 2v13l2 1V3c0-1.1-.9-2-2-2zm-4 4H5c-1.1 0-2 .9-2 2v16l7-3 7 3V7c0-1.1-.9-2-2-2z"})});function Mp(){return rEe}var nEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M7 14c-1.66 0-3 1.34-3 3 0 1.31-1.16 2-2 2 .92 1.22 2.49 2 4 2 2.21 0 4-1.79 4-4 0-1.66-1.34-3-3-3zm13.71-9.37l-1.34-1.34a.9959.9959 0 00-1.41 0L9 12.25 11.75 15l8.96-8.96c.39-.39.39-1.02 0-1.41z"})});function aP(){return nEe}var oEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M22.61 18.99l-9.08-9.08c.93-2.34.45-5.1-1.44-7C9.79.61 6.21.4 3.66 2.26L7.5 6.11 6.08 7.52 2.25 3.69C.39 6.23.6 9.82 2.9 12.11c1.86 1.86 4.57 2.35 6.89 1.48l9.11 9.11c.39.39 1.02.39 1.41 0l2.3-2.3c.4-.38.4-1.01 0-1.41zm-3 1.6l-9.46-9.46c-.61.45-1.29.72-2 .82-1.36.2-2.79-.21-3.83-1.25C3.37 9.76 2.93 8.5 3 7.26l3.09 3.09 4.24-4.24-3.09-3.09c1.24-.07 2.49.37 3.44 1.31 1.08 1.08 1.49 2.57 1.24 3.96-.12.71-.42 1.37-.88 1.96l9.45 9.45-.88.89z"})});function TJ(){return oEe}var iEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"})});function wJ(){return iEe}var aEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M14.25 2.26l-.08-.04-.01.02C13.46 2.09 12.74 2 12 2 6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10c0-4.75-3.31-8.72-7.75-9.74zM19.41 9h-7.99l2.71-4.7c2.4.66 4.35 2.42 5.28 4.7zM13.1 4.08L10.27 9l-1.15 2L6.4 6.3C7.84 4.88 9.82 4 12 4c.37 0 .74.03 1.1.08zM5.7 7.09L8.54 12l1.15 2H4.26C4.1 13.36 4 12.69 4 12c0-1.85.64-3.55 1.7-4.91zM4.59 15h7.98l-2.71 4.7c-2.4-.67-4.34-2.42-5.27-4.7zm6.31 4.91L14.89 13l2.72 4.7C16.16 19.12 14.18 20 12 20c-.38 0-.74-.04-1.1-.09zm7.4-3l-4-6.91h5.43c.17.64.27 1.31.27 2 0 1.85-.64 3.55-1.7 4.91z"})});function _J(){return aEe}var sEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M9.4 10.5l4.77-8.26C13.47 2.09 12.75 2 12 2c-2.4 0-4.6.85-6.32 2.25l3.66 6.35.06-.1zM21.54 9c-.92-2.92-3.15-5.26-6-6.34L11.88 9h9.66zm.26 1h-7.49l.29.5 4.76 8.25C21 16.97 22 14.61 22 12c0-.69-.07-1.35-.2-2zM8.54 12l-3.9-6.75C3.01 7.03 2 9.39 2 12c0 .69.07 1.35.2 2h7.49l-1.15-2zm-6.08 3c.92 2.92 3.15 5.26 6 6.34L12.12 15H2.46zm11.27 0l-3.9 6.76c.7.15 1.42.24 2.17.24 2.4 0 4.6-.85 6.32-2.25l-3.66-6.35-.93 1.6z"})});function PJ(){return sEe}var lEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm3.59-13L12 10.59 8.41 7 7 8.41 10.59 12 7 15.59 8.41 17 12 13.41 15.59 17 17 15.59 13.41 12 17 8.41z"})});function xS(){return lEe}var cEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z"})});function sP(){return cEe}var uEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm-7 7H3v4c0 1.1.9 2 2 2h4v-2H5v-4zM5 5h4V3H5c-1.1 0-2 .9-2 2v4h2V5zm14-2h-4v2h4v4h2V5c0-1.1-.9-2-2-2zm0 16h-4v2h4c1.1 0 2-.9 2-2v-4h-2v4z"})});function EJ(){return uEe}var dEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"})});function Pc(){return dEe}var mEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"})});function lB(){return mEe}var pEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"})});function ml(){return pEe}var fEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"})});function IJ(){return fEe}var hEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"})});function DJ(){return hEe}var gEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm-1 4H8c-1.1 0-1.99.9-1.99 2L6 21c0 1.1.89 2 1.99 2H19c1.1 0 2-.9 2-2V11l-6-6zM8 21V7h6v5h5v9H8z"})});function AJ(){return gEe}var yEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M17 15h2V7c0-1.1-.9-2-2-2H9v2h8v8zM7 17V1H5v4H1v2h4v10c0 1.1.9 2 2 2h10v4h2v-4h4v-2H7z"})});function kJ(){return yEe}var vEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M3 5v4h2V5h4V3H5c-1.1 0-2 .9-2 2zm2 10H3v4c0 1.1.9 2 2 2h4v-2H5v-4zm14 4h-4v2h4c1.1 0 2-.9 2-2v-4h-2v4zm0-16h-4v2h4v4h2V5c0-1.1-.9-2-2-2z"})});function MJ(){return vEe}var bEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zm-5.04-6.71l-2.75 3.54-1.96-2.36L6.5 17h11l-3.54-4.71z"})});function RJ(){return bEe}var xEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M16 9v10H8V9h8m-1.5-6h-5l-1 1H5v2h14V4h-3.5l-1-1zM18 7H6v12c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7z"})});function Hi(){return xEe}var xFt=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"})});var SEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"})});function cB(){return SEe}var SFt=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M20.5 11H19V7c0-1.1-.9-2-2-2h-4V3.5C13 2.12 11.88 1 10.5 1S8 2.12 8 3.5V5H4c-1.1 0-1.99.9-1.99 2v3.8H3.5c1.49 0 2.7 1.21 2.7 2.7s-1.21 2.7-2.7 2.7H2V20c0 1.1.9 2 2 2h3.8v-1.5c0-1.49 1.21-2.7 2.7-2.7 1.49 0 2.7 1.21 2.7 2.7V22H17c1.1 0 2-.9 2-2v-4h1.5c1.38 0 2.5-1.12 2.5-2.5S21.88 11 20.5 11z"})});var CEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",strokeWidth:"0.1px",children:(0,ye.jsx)("path",{d:"M3 13h2v-2H3v2zm0 4h2v-2H3v2zm2 4v-2H3c0 1.1.89 2 2 2zM3 9h2V7H3v2zm12 12h2v-2h-2v2zm4-18H9c-1.11 0-2 .9-2 2v10c0 1.1.89 2 2 2h10c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 12H9V5h10v10zm-8 6h2v-2h-2v2zm-4 0h2v-2H7v2z"})});function TEe(){return CEe}var wEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"})});function LJ(){return wEe}var _Ee=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"})});function SS(){return _Ee}var PEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z"})});function Bs(){return PEe}var EEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M12 5.69l5 4.5V18h-2v-6H9v6H7v-7.81l5-4.5M12 3L2 12h3v8h6v-6h2v6h6v-8h3L12 3z"})});function CS(){return EEe}var CFt=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"})});var IEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M19.5 9.5c-1.03 0-1.9.62-2.29 1.5h-2.92c-.39-.88-1.26-1.5-2.29-1.5s-1.9.62-2.29 1.5H6.79c-.39-.88-1.26-1.5-2.29-1.5C3.12 9.5 2 10.62 2 12s1.12 2.5 2.5 2.5c1.03 0 1.9-.62 2.29-1.5h2.92c.39.88 1.26 1.5 2.29 1.5s1.9-.62 2.29-1.5h2.92c.39.88 1.26 1.5 2.29 1.5 1.38 0 2.5-1.12 2.5-2.5s-1.12-2.5-2.5-2.5z"})});function DEe(){return IEe}var AEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M6 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-6 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"})});function Pu(){return AEe}var kEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"})});function uB(){return kEe}var MEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"})});function dB(){return MEe}var REe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M19 4H5c-1.11 0-2 .9-2 2v12c0 1.1.89 2 2 2h4v-2H5V8h14v10h-4v2h4c1.1 0 2-.9 2-2V6c0-1.1-.89-2-2-2zm-7 6l-4 4h3v6h2v-6h3l-4-4z"})});function BJ(){return REe}var LEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M8 5v14l11-7z"})});function lP(){return LEe}var BEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"})});function TS(){return BEe}var OEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M19 13H5v-2h14v2z"})});function wS(){return OEe}var FEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"})});function _S(){return FEe}var NEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",strokeWidth:"0.1px",children:(0,ye.jsx)("path",{d:"M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm2 16H5V5h11.17L19 7.83V19zm-7-7c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3zM6 6h9v4H6z"})});function cP(){return NEe}var VEe=(0,ye.jsxs)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:[(0,ye.jsx)("circle",{cx:"7",cy:"14",r:"3"}),(0,ye.jsx)("circle",{cx:"11",cy:"6",r:"3"}),(0,ye.jsx)("circle",{cx:"16.6",cy:"17.6",r:"3"})]});function zEe(){return VEe}var TFt=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"})});var UEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M6 6h2v12H6zm3.5 6l8.5 6V6z"})});function OJ(){return UEe}var GEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M6 6h12v12H6z"})});function mB(){return GEe}var jEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M4 6h16v2H4zm2-4h12v2H6zm14 8H4c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2v-8c0-1.1-.9-2-2-2zm0 10H4v-8h16v8zm-10-7.27v6.53L16 16z"})});function FJ(){return jEe}var HEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M6.99 11L3 15l3.99 4v-3H14v-2H6.99v-3zM21 9l-3.99-4v3H10v2h7.01v3L21 9z"})});function NJ(){return HEe}var qEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M3 17v2h6v-2H3zM3 5v2h10V5H3zm10 16v-2h8v-2h-8v-2h-2v6h2zM7 9v2H3v2h4v2h2V9H7zm14 4v-2H11v2h10zm-6-4h2V7h4V5h-4V3h-2v6z"})});function pl(){return qEe}var WEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M12 6c3.79 0 7.17 2.13 8.82 5.5-.59 1.22-1.42 2.27-2.41 3.12l1.41 1.41c1.39-1.23 2.49-2.77 3.18-4.53C21.27 7.11 17 4 12 4c-1.27 0-2.49.2-3.64.57l1.65 1.65C10.66 6.09 11.32 6 12 6zm-1.07 1.14L13 9.21c.57.25 1.03.71 1.28 1.28l2.07 2.07c.08-.34.14-.7.14-1.07C16.5 9.01 14.48 7 12 7c-.37 0-.72.05-1.07.14zM2.01 3.87l2.68 2.68C3.06 7.83 1.77 9.53 1 11.5 2.73 15.89 7 19 12 19c1.52 0 2.98-.29 4.32-.82l3.42 3.42 1.41-1.41L3.42 2.45 2.01 3.87zm7.5 7.5l2.61 2.61c-.04.01-.08.02-.12.02-1.38 0-2.5-1.12-2.5-2.5 0-.05.01-.08.01-.13zm-3.4-3.4l1.75 1.75c-.23.55-.36 1.15-.36 1.78 0 2.48 2.02 4.5 4.5 4.5.63 0 1.23-.13 1.77-.36l.98.98c-.88.24-1.8.38-2.75.38-3.79 0-7.17-2.13-8.82-5.5.7-1.43 1.72-2.61 2.93-3.53z"})});function Ec(){return WEe}var XEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M12 6c3.79 0 7.17 2.13 8.82 5.5C19.17 14.87 15.79 17 12 17s-7.17-2.13-8.82-5.5C4.83 8.13 8.21 6 12 6m0-2C7 4 2.73 7.11 1 11.5 2.73 15.89 7 19 12 19s9.27-3.11 11-7.5C21.27 7.11 17 4 12 4zm0 5c1.38 0 2.5 1.12 2.5 2.5S13.38 14 12 14s-2.5-1.12-2.5-2.5S10.62 9 12 9m0-2c-2.48 0-4.5 2.02-4.5 4.5S9.52 16 12 16s4.5-2.02 4.5-4.5S14.48 7 12 7z"})});function Ic(){return XEe}var YEe=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"})});function uP(){return YEe}var wFt=(0,ye.jsx)("svg",{width:"24px",height:"24px",viewBox:"0 0 24 24",children:(0,ye.jsx)("path",{d:"M 9.64 7.64 c 0.23 -0.5 0.36 -1.05 0.36 -1.64 c 0 -2.21 -1.79 -4 -4 -4 S 2 3.79 2 6 s 1.79 4 4 4 c 0.59 0 1.14 -0.13 1.64 -0.36 L 10 12 l -2.36 2.36 C 7.14 14.13 6.59 14 6 14 c -2.21 0 -4 1.79 -4 4 s 1.79 4 4 4 s 4 -1.79 4 -4 c 0 -0.59 -0.13 -1.14 -0.36 -1.64 L 12 14 l 7 7 h 3 v -1 L 9.64 7.64 Z M 6 8 c -1.1 0 -2 -0.89 -2 -2 s 0.9 -2 2 -2 s 2 0.89 2 2 s -0.9 2 -2 2 Z m 0 12 c -1.1 0 -2 -0.89 -2 -2 s 0.9 -2 2 -2 s 2 0.89 2 2 s -0.9 2 -2 2 Z m 6 -7.5 c -0.28 0 -0.5 -0.22 -0.5 -0.5 s 0.22 -0.5 0.5 -0.5 s 0.5 0.22 0.5 0.5 s -0.22 0.5 -0.5 0.5 Z M 19 3 l -6 6 l 2 2 l 7 -7 V 3 Z"})});var VJ=qPe,zJ=zEe,pB=DEe,UJ=TEe;var Ua=class extends Rp.Component{constructor(){super(...arguments),this.state={isExpanded:!!this.props.initialExpanded},this.headerClicked=()=>{this.props.onHeaderClick?this.props.onHeaderClick():this.setState({isExpanded:!this.state.isExpanded})}}render(){let e=this.props.hideOffset?"msp-control-group-children":"msp-control-group-children msp-control-offset";return this.props.childrenClassName&&(e+=" "+this.props.childrenClassName),(0,Kr.jsxs)("div",{className:"msp-control-group-wrapper",style:{position:"relative",marginTop:this.props.noTopMargin?0:void 0},children:[(0,Kr.jsx)("div",{className:"msp-control-group-header",style:{marginLeft:this.props.headerLeftMargin},title:this.props.title,children:(0,Kr.jsxs)(vt,{onClick:this.headerClicked,children:[!this.props.hideExpander&&(0,Kr.jsx)(pr,{svg:this.state.isExpanded?Ls:Rs}),this.props.topRightIcon&&(0,Kr.jsx)(pr,{svg:this.props.topRightIcon,style:{position:"absolute",right:"2px",top:0}}),(0,Kr.jsx)("b",{children:this.props.header})]})}),this.state.isExpanded&&(0,Kr.jsx)("div",{className:e,style:{display:this.state.isExpanded?"block":"none",maxHeight:this.props.maxHeight,overflow:"hidden",overflowY:"auto"},children:this.props.children})]})}};function GJ(t){return t}var fl=class extends Rp.PureComponent{constructor(){super(...arguments),this.input=Rp.createRef(),this.delayHandle=void 0,this.pendingValue=void 0,this.state={originalValue:"",value:""},this.onBlur=()=>{this.setState({value:""+this.state.originalValue}),this.props.onBlur&&this.props.onBlur()},this.raiseOnChange=()=>{this.pendingValue!==void 0&&(this.props.onChange(this.pendingValue),this.pendingValue=void 0)},this.onChange=e=>{let r=e.target.value;if(this.props.isValid&&!this.props.isValid(r)||this.props.numeric&&Number.isNaN(+r)){this.clearTimeout(),this.setState({value:r});return}if(this.props.numeric)this.setState({value:r},()=>this.triggerChanged(r,+r));else{let o=(this.props.toValue||GJ)(r),i=(this.props.fromValue||GJ)(o);this.setState({value:i},()=>this.triggerChanged(i,o))}},this.onKeyUp=e=>{(e.charCode===27||e.keyCode===27||e.key==="Escape")&&this.props.blurOnEscape&&this.input.current&&this.input.current.blur()},this.onKeyPress=e=>{(e.keyCode===13||e.charCode===13||e.key==="Enter")&&(this.isPending&&(this.clearTimeout(),this.raiseOnChange()),this.props.blurOnEnter&&this.input.current&&this.input.current.blur(),this.props.onEnter&&this.props.onEnter()),e.stopPropagation()}}get isPending(){return typeof this.delayHandle<"u"}clearTimeout(){this.isPending&&(clearTimeout(this.delayHandle),this.delayHandle=void 0)}triggerChanged(e,r){this.clearTimeout(),e!==this.state.originalValue&&(this.props.delayMs?(this.pendingValue=r,this.delayHandle=setTimeout(this.raiseOnChange,this.props.delayMs)):this.props.onChange(r))}static getDerivedStateFromProps(e,r){let n=e.fromValue?e.fromValue(e.value):e.value;return n===r.originalValue?null:{originalValue:n,value:n}}render(){return(0,Kr.jsx)("input",{type:"text",className:this.props.className,style:this.props.style,ref:this.input,onBlur:this.onBlur,value:this.state.value,placeholder:this.props.placeholder,onChange:this.onChange,onKeyPress:this.props.onEnter||this.props.blurOnEnter||this.props.blurOnEscape?this.onKeyPress:void 0,onKeyDown:this.props.blurOnEscape?this.onKeyUp:void 0,disabled:!!this.props.isDisabled})}},dP=class extends Rp.Component{constructor(){super(...arguments),this.state={isExpanded:!1},this.toggleExpanded=()=>this.setState({isExpanded:!this.state.isExpanded})}render(){let{label:e,pivot:r,controls:n}=this.props;return(0,Kr.jsxs)(Kr.Fragment,{children:[(0,Kr.jsx)(Ga,{label:(0,Kr.jsxs)(Kr.Fragment,{children:[e,(0,Kr.jsx)("button",{className:"msp-btn-link msp-btn-icon msp-control-group-expander",onClick:this.toggleExpanded,title:`${this.state.isExpanded?"Less":"More"} options`,style:{background:"transparent",textAlign:"left",padding:"0"},children:(0,Kr.jsx)(pr,{svg:this.state.isExpanded?wS:Fd,style:{display:"inline-block"}})})]}),control:r,children:this.props.colorStripe&&(0,Kr.jsx)("div",{className:"msp-expandable-group-color-stripe",style:{backgroundColor:ce.toStyle(this.props.colorStripe)}})}),this.state.isExpanded&&(0,Kr.jsx)("div",{className:"msp-control-offset",children:n})]})}};function Nd(t){return(0,Kr.jsxs)("div",{className:`msp-section-header${t.accent?" msp-transform-header-brand-"+t.accent:""}`,children:[t.icon&&(0,Kr.jsx)(pr,{svg:t.icon}),t.title," ",(0,Kr.jsx)("small",{children:t.desc})]})}function vt(t){let e="msp-btn";t.inline||(e+=" msp-btn-block"),t.noOverflow&&(e+=" msp-no-overflow"),t.flex&&(e+=" msp-flex-item"),(t.commit==="on"||t.commit)&&(e+=" msp-btn-commit msp-btn-commit-on"),t.commit==="off"&&(e+=" msp-btn-commit msp-btn-commit-off"),t.children||(e+=" msp-btn-childless"),t.className&&(e+=" "+t.className);let r;return t.flex&&(typeof t.flex=="number"?r={flex:`0 0 ${t.flex}px`,padding:0,maxWidth:`${t.flex}px`}:typeof t.flex=="string"&&(r={flex:`0 0 ${t.flex}`,padding:0,maxWidth:t.flex})),t.style&&(r?Object.assign(r,t.style):r=t.style),(0,Kr.jsxs)("button",{onClick:t.onClick,title:t.title,disabled:t.disabled,style:r,className:e,"data-id":t["data-id"],"data-color":t["data-color"],onContextMenu:t.onContextMenu,onMouseEnter:t.onMouseEnter,onMouseLeave:t.onMouseLeave,children:[t.icon&&(0,Kr.jsx)(pr,{svg:t.icon}),t.children]})}function pt(t){let e=`msp-btn msp-btn-icon${t.small?"-small":""}${t.className?" "+t.className:""}`;typeof t.toggleState<"u"&&(e+=` msp-btn-link-toggle-${t.toggleState?"on":"off"}`),t.transparent&&(e+=" msp-transparent-bg");let r;return t.flex&&(typeof t.flex=="boolean"?r={flex:"0 0 32px",padding:0}:typeof t.flex=="number"?r={flex:`0 0 ${t.flex}px`,padding:0,maxWidth:`${t.flex}px`}:r={flex:`0 0 ${t.flex}`,padding:0,maxWidth:t.flex}),t.style&&(r?Object.assign(r,t.style):r=t.style),(0,Kr.jsxs)("button",{className:e,onClick:t.onClick,title:t.title,disabled:t.disabled,"data-id":t["data-id"],style:r,children:[t.svg&&(0,Kr.jsx)(pr,{svg:t.svg}),t.extraContent]})}var Gn=class extends Rp.PureComponent{constructor(){super(...arguments),this.onClick=e=>{e.currentTarget.blur(),this.props.toggle()}}render(){let e=this.props,r=e.label,n=e.isSelected?`${e.className||""} msp-control-current`:e.className;return(0,Kr.jsx)(vt,{icon:this.props.icon,onClick:this.onClick,title:this.props.title,inline:this.props.inline,disabled:e.disabled,style:e.style,className:n,children:r&&this.props.isSelected?(0,Kr.jsx)("b",{children:r}):r})}},Ci=class extends Rp.PureComponent{constructor(){super(...arguments),this.state={isExpanded:!!this.props.initiallyExpanded},this.toggleExpanded=()=>this.setState({isExpanded:!this.state.isExpanded})}render(){return(0,Kr.jsxs)(Kr.Fragment,{children:[(0,Kr.jsx)("div",{className:"msp-control-group-header",style:{marginTop:this.props.marginTop!==void 0?this.props.marginTop:"1px",marginLeft:this.props.headerLeftMargin},children:(0,Kr.jsxs)("button",{className:"msp-btn msp-form-control msp-btn-block",onClick:this.toggleExpanded,style:this.props.headerStyle,children:[(0,Kr.jsx)(pr,{svg:this.state.isExpanded?Rs:Ls}),this.props.header]})}),this.state.isExpanded&&(this.props.noOffset?this.props.children:(0,Kr.jsx)("div",{className:this.props.accent?"msp-accent-offset":"msp-control-offset",children:this.props.children}))]})}};function Ga(t){let e="msp-control-row";return t.className&&(e+=" "+t.className),(0,Kr.jsxs)("div",{className:e,children:[(0,Kr.jsx)("span",{className:"msp-control-row-label",title:t.title,children:t.label}),(0,Kr.jsx)("div",{className:"msp-control-row-ctrl",children:t.control}),t.children]})}var Hl=Jv.createContext(void 0),Mt=(()=>{class t extends Jv.Component{subscribe(r,n){typeof this.subs>"u"&&(this.subs=[]),this.subs.push(r.subscribe(n))}componentWillUnmount(){if(this.subs){for(let r of this.subs)r.unsubscribe();this.subs=void 0}}constructor(r,n){super(r),this.subs=void 0,this.plugin=n,this.init&&this.init()}}return t.contextType=Hl,t})(),Kn=(()=>{class t extends Jv.PureComponent{subscribe(r,n){typeof this.subs>"u"&&(this.subs=[]),this.subs.push(r.subscribe(n))}componentWillUnmount(){if(this.subs){for(let r of this.subs)r.unsubscribe();this.subs=void 0}}constructor(r,n){super(r,n),this.subs=void 0,this.plugin=n,this.init&&this.init()}}return t.contextType=Hl,t})(),hl=class extends Mt{componentDidUpdate(e){this.props.initiallyCollapsed!==void 0&&e.initiallyCollapsed!==this.props.initiallyCollapsed&&this.setState({isCollapsed:this.props.initiallyCollapsed})}render(){var e;if(this.state.isHidden)return null;let r=this.state.isCollapsed?"msp-transform-wrapper msp-transform-wrapper-collapsed":"msp-transform-wrapper";return(0,vy.jsxs)("div",{className:r,children:[(0,vy.jsx)("div",{className:"msp-transform-header",children:(0,vy.jsxs)(vt,{icon:this.state.brand?void 0:this.state.isCollapsed?Ls:Rs,noOverflow:!0,onClick:this.toggleCollapsed,className:this.state.brand?`msp-transform-header-brand msp-transform-header-brand-${this.state.brand.accent}`:void 0,title:`Click to ${this.state.isCollapsed?"expand":"collapse"}`,children:[(0,vy.jsx)(pr,{svg:(e=this.state.brand)===null||e===void 0?void 0:e.svg,inline:!0}),this.state.header,(0,vy.jsx)("small",{style:{margin:"0 6px"},children:this.state.isCollapsed?"":this.state.description})]})}),!this.state.isCollapsed&&this.renderControls()]})}constructor(e,r){super(e,r),this.toggleCollapsed=()=>{this.setState({isCollapsed:!this.state.isCollapsed})};let n=this.defaultState();e.initiallyCollapsed!==void 0&&(n.isCollapsed=e.initiallyCollapsed),e.header!==void 0&&(n.header=e.header),this.state=n}};var ve=Ot(Or()),$n=Ot(Po());var mi=Ot(Or()),yB=Ot(Po());var wt=class extends yB.PureComponent{constructor(){super(...arguments),this.hide=()=>this.props.onSelect(void 0)}render(){let e=this.props,r=(0,mi.jsx)(hB,{items:e.items,onSelect:e.onSelect,current:e.current,multiselect:this.props.multiselect,noOffset:this.props.noOffset,noAccent:this.props.noAccent});return(0,mi.jsxs)("div",{className:`msp-action-menu-options${e.header?"":" msp-action-menu-options-no-header"}`,children:[e.header&&(0,mi.jsx)(Ua,{header:e.header,title:e.title,initialExpanded:!0,hideExpander:!0,hideOffset:!0,onHeaderClick:this.hide,topRightIcon:ml,children:r}),!e.header&&r]})}};(function(t){function e(c,u){return u?w({kind:"header",label:c},u):{kind:"header",label:c}}t.Header=e;function r(c,u,d){return w({kind:"item",label:c,value:u},d)}t.Item=r;function n(c,u){let{label:d,value:m,category:p,selected:h,icon:f,addOn:b,description:v}=u||{},x,S=[];for(let T=0;T<c.length;T++){let E=c[T];if(u?.filter&&!u.filter(E))continue;let _=p?.(E),D=d?d(E):""+E,P=m?m(E):E,A=v?v(E):typeof E=="string"?E:void 0,I;_?(x||(x=new Map),I=x.get(_),I||(I=[t.Header(_,{description:_})],x.set(_,I),S.push(I))):I=S;let k=b?.(E);I.push({kind:"item",label:D,value:P,icon:f?f(E):void 0,selected:h?h(E):void 0,addOn:k,description:A})}return S}t.createItems=n;let o={value:c=>c[0],label:c=>c[1],category:c=>c[2]};function i(c,u){return n(c,u?w(w({},o),u):o)}t.createItemsFromSelectOptions=i;function a(c){if(Lp(c))return!1;if(eb(c))return!!c.selected;for(let u of c)if(a(u))return!0;return!1}t.hasSelectedItem=a;function s(c,u){if(!Lp(c)){if(eb(c))return c.value===u?c:void 0;for(let d of c){let m=s(d,u);if(m)return m}}}t.findItem=s;function l(c){if(!Lp(c)){if(eb(c))return c;for(let u of c){let d=l(u);if(d)return d}}}t.getFirstItem=l})(wt||(wt={}));var hB=class t extends yB.PureComponent{constructor(){super(...arguments),this.state=t.createState(this.props),this.toggleExpanded=e=>{this.setState({isExpanded:!this.state.isExpanded}),e.currentTarget.blur()},this.selectAll=()=>{let e=gB(this.props.items,[]).filter(r=>!r.selected);this.props.onSelect(e)},this.selectNone=()=>{let e=gB(this.props.items,[]).filter(r=>!!r.selected);this.props.onSelect(e)}}static createState(e,r){let n=fB(e.items)&&Lp(e.items[0])?e.items[0]:void 0,o=n?.isIndependent?!1:e.multiselect?wt.hasSelectedItem(e.items):!!e.current&&!!wt.findItem(e.items,e.current.value)||wt.hasSelectedItem(e.items);return{header:n,hasCurrent:o,isExpanded:o||(r??!!n?.initiallyExpanded)}}componentDidUpdate(e){if(this.props.items!==e.items||this.props.current!==e.current){let r=fB(this.props.items)&&fB(e.items)&&Lp(this.props.items[0])&&Lp(e.items[0])&&this.props.items[0].label===e.items[0].label?this.state.isExpanded:void 0;this.setState(t.createState(this.props,r))}}get multiselectHeader(){let{header:e,hasCurrent:r}=this.state;return(0,mi.jsxs)("div",{className:"msp-flex-row msp-control-group-header",children:[(0,mi.jsx)(vt,{icon:this.state.isExpanded?Rs:Ls,flex:!0,noOverflow:!0,onClick:this.toggleExpanded,title:`Click to ${this.state.isExpanded?"collapse":"expand"}.${e?.description?` ${e?.description}`:""}`,children:r?(0,mi.jsx)("b",{children:e?.label}):e?.label}),(0,mi.jsx)(vt,{icon:Pc,flex:!0,onClick:this.selectAll,style:{flex:"0 0 50px",textAlign:"right"},children:"All"}),(0,mi.jsx)(vt,{icon:ml,flex:!0,onClick:this.selectNone,style:{flex:"0 0 50px",textAlign:"right"},children:"None"})]})}get basicHeader(){let{header:e,hasCurrent:r}=this.state;return(0,mi.jsx)("div",{className:"msp-control-group-header",style:{marginTop:"1px"},children:(0,mi.jsx)(vt,{noOverflow:!0,icon:this.state.isExpanded?Rs:Ls,onClick:this.toggleExpanded,title:`Click to ${this.state.isExpanded?"collapse":"expand"}. ${e?.description?e?.description:""}`,children:r?(0,mi.jsx)("b",{children:e?.label}):e?.label})})}render(){let{items:e,onSelect:r,current:n}=this.props;if(Lp(e))return null;if(eb(e))return(0,mi.jsx)(jJ,{item:e,onSelect:r,current:n,multiselect:this.props.multiselect});let{header:o}=this.state;return(0,mi.jsxs)(mi.Fragment,{children:[o&&(this.props.multiselect&&this.state.isExpanded?this.multiselectHeader:this.basicHeader),(0,mi.jsx)("div",{className:this.props.noOffset?void 0:this.props.noAccent?"msp-control-offset":"msp-accent-offset",children:(!o||this.state.isExpanded)&&e.map((i,a)=>Lp(i)?null:eb(i)?(0,mi.jsx)(jJ,{item:i,onSelect:r,current:n,multiselect:this.props.multiselect},a):(0,mi.jsx)(t,{items:i,onSelect:r,current:n,multiselect:this.props.multiselect,noAccent:!0},a))})]})}},jJ=({item:t,onSelect:e,current:r,multiselect:n})=>{let o=r===t,i=t.addOn?{position:"relative"}:void 0;return(0,mi.jsxs)(vt,{icon:t.icon,noOverflow:!0,className:"msp-action-menu-button",onClick:a=>e(n?[t]:t,a),disabled:t.disabled,style:i,title:t.description,children:[o||t.selected?(0,mi.jsx)("b",{children:t.label}):t.label,t.addOn]})};function fB(t){return!!t&&Array.isArray(t)}function eb(t){let e=t;return e&&e.kind==="item"}function Lp(t){let e=t;return e&&e.kind==="header"}function gB(t,e){if(Lp(t))return e;if(eb(t))return e.push(t),e;for(let r of t)gB(r,e);return e}var Ti=Ot(Or());var HJ=Ot(Po());var vB=[["black",0],["gray",8421504],["white",16777215],["red",13840661],["orange",14840576],["yellow",16565248],["green",6863872],["cyan",1484197],["blue",40160],["purple",8086783],["magenta",16394495],["violet",8200583]];var tb=class extends HJ.PureComponent{constructor(){super(...arguments),this.state={isExpanded:!!this.props.param.isExpanded||!!this.props.hideNameRow,lightness:0},this.toggleExpanded=e=>{this.setState({isExpanded:!this.state.isExpanded}),e.currentTarget.blur()},this.onClickSwatch=e=>{let r=ce.fromHexString(e.currentTarget.getAttribute("data-color")||"0");r!==this.props.value&&(this.props.param.isExpanded||this.setState({isExpanded:!1}),this.update(r))},this.onR=e=>{let[,r,n]=ce.toRgb(this.props.value),o=ce.fromRgb(e,r,n);o!==this.props.value&&this.update(o)},this.onG=e=>{let[r,,n]=ce.toRgb(this.props.value),o=ce.fromRgb(r,e,n);o!==this.props.value&&this.update(o)},this.onB=e=>{let[r,n]=ce.toRgb(this.props.value),o=ce.fromRgb(r,n,e);o!==this.props.value&&this.update(o)},this.onRGB=e=>{let r=ce.fromHexStyle(e.currentTarget.value||"0");r!==this.props.value&&this.update(r)},this.onLighten=()=>{this.update(ce.lighten(this.props.value,.1))},this.onDarken=()=>{this.update(ce.darken(this.props.value,.1))}}update(e){this.props.onChange({param:this.props.param,name:this.props.name,value:e})}swatch(){return(0,Ti.jsx)("div",{className:"msp-combined-color-swatch",children:vB.map(e=>(0,Ti.jsx)(vt,{inline:!0,"data-color":e[1],onClick:this.onClickSwatch,style:{background:ce.toStyle(e[1])}},e[1]))})}render(){let e=this.props.param.label||Di(this.props.name),[r,n,o]=ce.toRgb(this.props.value),i=(0,Ti.jsxs)(Ti.Fragment,{children:[this.swatch(),(0,Ti.jsx)(Ga,{label:"RGB",className:"msp-control-label-short",control:(0,Ti.jsxs)("div",{style:{display:"flex",textAlignLast:"center",left:"80px"},children:[(0,Ti.jsx)(fl,{onChange:this.onR,numeric:!0,value:r,delayMs:250,style:{order:1,flex:"1 1 auto",minWidth:0},className:"msp-form-control",onEnter:this.props.onEnter,blurOnEnter:!0,blurOnEscape:!0}),(0,Ti.jsx)(fl,{onChange:this.onG,numeric:!0,value:n,delayMs:250,style:{order:2,flex:"1 1 auto",minWidth:0},className:"msp-form-control",onEnter:this.props.onEnter,blurOnEnter:!0,blurOnEscape:!0}),(0,Ti.jsx)(fl,{onChange:this.onB,numeric:!0,value:o,delayMs:250,style:{order:3,flex:"1 1 auto",minWidth:0},className:"msp-form-control",onEnter:this.props.onEnter,blurOnEnter:!0,blurOnEscape:!0}),(0,Ti.jsx)("input",{onInput:this.onRGB,type:"color",value:ce.toHexStyle(this.props.value),style:{order:4,flex:"1 1 auto",minWidth:"32px",width:"32px",height:"32px",padding:"0 2px 0 2px",background:"none",border:"none",cursor:"pointer"}})]})}),(0,Ti.jsxs)("div",{style:{display:"flex",textAlignLast:"center"},children:[(0,Ti.jsx)(vt,{onClick:this.onLighten,style:{order:1,flex:"1 1 auto",minWidth:0},className:"msp-form-control",children:"Lighten"}),(0,Ti.jsx)(vt,{onClick:this.onDarken,style:{order:1,flex:"1 1 auto",minWidth:0},className:"msp-form-control",children:"Darken"})]})]});return this.props.hideNameRow?i:(0,Ti.jsxs)(Ti.Fragment,{children:[(0,Ti.jsx)(Ga,{title:this.props.param.description,label:e,control:(0,Ti.jsx)(vt,{onClick:this.toggleExpanded,inline:!0,className:"msp-combined-color-button",style:{background:ce.toStyle(this.props.value)}})}),this.state.isExpanded&&(0,Ti.jsx)("div",{className:"msp-control-offset",children:i})]})}};var jFt=function(){let t=new Map;for(let e of vB)t.set(e[1],e[0]);return t}();var Pm=Ot(Or());var SB=Ot(Po());function qJ(t){switch(t.kind){case"scale-legend":return bB;case"table-legend":return xB;default:console.warn(`${t} has no associated UI component`);return}}var bB=class extends SB.PureComponent{render(){let{legend:e}=this.props,r=e.colors.map(n=>Array.isArray(n)?`${ce.toStyle(n[0])} ${100*n[1]}%`:ce.toStyle(n)).join(", ");return(0,Pm.jsx)("div",{className:"msp-scale-legend",children:(0,Pm.jsxs)("div",{style:{background:`linear-gradient(to right, ${r})`},children:[(0,Pm.jsx)("span",{style:{float:"left"},children:e.minLabel}),(0,Pm.jsx)("span",{style:{float:"right"},children:e.maxLabel})]})})}},xB=class extends SB.PureComponent{render(){let{legend:e}=this.props;return(0,Pm.jsx)("div",{className:"msp-table-legend",children:e.table.map((r,n)=>{let[o,i]=r;return(0,Pm.jsxs)("div",{children:[(0,Pm.jsx)("div",{className:"msp-table-legend-color",style:{backgroundColor:ce.toStyle(i)}}),(0,Pm.jsx)("div",{className:"msp-table-legend-text",children:o})]},n)})})}};var Em=Ot(Or());var WJ=Ot(Or()),XJ=Ot(Po());var mP=class extends XJ.Component{constructor(e){super(e),this.state={show:!1},this.handleHover=this.handleHover.bind(this),this.handleHoverOff=this.handleHoverOff.bind(this),this.deletePoint=this.deletePoint.bind(this)}handleHover(){this.setState({show:!0});let e=ne.create(this.props.nX,this.props.nY);this.props.onmouseover(e)}handleHoverOff(){this.setState({show:!1}),this.props.onmouseover(void 0)}deletePoint(){this.props.delete(this.props.id)}render(){return[(0,WJ.jsx)("circle",{r:"10",id:`${this.props.id}`,cx:this.props.x,cy:this.props.y,onClick:this.props.onclick,onDoubleClick:this.props.delete(this.props.id),onMouseEnter:this.handleHover,onMouseLeave:this.handleHoverOff,onMouseDown:this.props.onmousedown,fill:"black"},`${this.props.id}circle`)]}};var fP=Ot(Po());var pP=class extends fP.Component{constructor(e){super(e),this.handleKeyDown=r=>{},this.handleKeyUp=r=>{},this.handleClick=r=>n=>{},this.handleMouseDown=r=>n=>{if(r===0||r===this.state.points.length-1||this.state.canSelectMultiple)return;let o=this.normalizePoint(ne.create(this.state.points[r][0],this.state.points[r][1]));this.ghostPoints.push(document.createElementNS(this.namespace,"circle")),this.ghostPoints[0].setAttribute("r","10"),this.ghostPoints[0].setAttribute("fill","orange"),this.ghostPoints[0].setAttribute("cx",`${o[0]}`),this.ghostPoints[0].setAttribute("cy",`${o[1]}`),this.ghostPoints[0].setAttribute("style","display: none"),this.gElement.appendChild(this.ghostPoints[0]),this.updatedX=o[0],this.updatedY=o[1],this.selected=[r]},this.deletePoint=r=>n=>{if(r===0||r===this.state.points.length-1)return;let o=this.state.points.filter((i,a)=>a!==r);o.sort((i,a)=>i[0]===a[0]?i[0]===0?i[1]-a[1]:i[1]===1?a[1]-i[1]:i[1]-a[1]:i[0]-a[0]),this.setState({points:o}),this.change(o),n.stopPropagation()},this.myRef=fP.createRef(),this.state={points:[ne.create(0,0),ne.create(1,0)],copyPoint:void 0,canSelectMultiple:!1},this.height=400,this.width=600,this.padding=70,this.selected=void 0,this.ghostPoints=[],this.namespace="http://www.w3.org/2000/svg";for(let r of this.props.data)this.state.points.push(r);this.state.points.sort((r,n)=>r[0]===n[0]?r[0]===0?r[1]-n[1]:r[1]===1?n[1]-r[1]:r[1]-n[1]:r[0]-n[0]),this.handleDrag=this.handleDrag.bind(this),this.handleMultipleDrag=this.handleMultipleDrag.bind(this),this.handleDoubleClick=this.handleDoubleClick.bind(this),this.refCallBack=this.refCallBack.bind(this),this.handlePointUpdate=this.handlePointUpdate.bind(this),this.change=this.change.bind(this),this.handleKeyUp=this.handleKeyUp.bind(this),this.handleLeave=this.handleLeave.bind(this),this.handleEnter=this.handleEnter.bind(this)}render(){let e=this.renderPoints(),r=this.renderLines(),n=this.renderHistogram();return[(0,Em.jsx)("div",{children:(0,Em.jsxs)("svg",{className:"msp-canvas",ref:this.refCallBack,viewBox:`0 0 ${this.width+this.padding} ${this.height+this.padding}`,onMouseMove:this.handleDrag,onMouseUp:this.handlePointUpdate,onMouseLeave:this.handleLeave,onMouseEnter:this.handleEnter,tabIndex:0,onKeyDown:this.handleKeyDown,onKeyUp:this.handleKeyUp,onDoubleClick:this.handleDoubleClick,children:[(0,Em.jsxs)("g",{stroke:"black",fill:"black",children:[n,r,e]}),(0,Em.jsx)("g",{className:"ghost-points",stroke:"black",fill:"black"})]})},"LineGraph"),(0,Em.jsx)("div",{id:"modal-root"},"modal")]}componentDidMount(){this.gElement=document.getElementsByClassName("ghost-points")[0]}change(e){let r=e.slice();r.shift(),r.pop(),this.props.onChange(r)}handleDrag(e){if(this.selected===void 0)return;let r=this.myRef.createSVGPoint(),n,o=this.padding/2;r.x=e.clientX,r.y=e.clientY;let i=r.matrixTransform(this.myRef.getScreenCTM().inverse());n=ne.create(i.x,i.y),(i.x<o||i.x>this.width+o)&&(i.y>this.height+o||i.y<o)?n=ne.create(this.updatedX,this.updatedY):i.x<o?n=ne.create(o,i.y):i.x>this.width+o?n=ne.create(this.width+o,i.y):i.y>this.height+o?n=ne.create(i.x,this.height+o):i.y<o?n=ne.create(i.x,o):n=ne.create(i.x,i.y),this.updatedX=n[0],this.updatedY=n[1];let a=this.unNormalizePoint(n);this.ghostPoints[0].setAttribute("style","display: visible"),this.ghostPoints[0].setAttribute("cx",`${n[0]}`),this.ghostPoints[0].setAttribute("cy",`${n[1]}`),this.props.onDrag(a)}handleMultipleDrag(){}handlePointUpdate(e){let r=this.selected;if(this.state.canSelectMultiple)return;if(r===void 0||r[0]===0||r[0]===this.state.points.length-1){this.setState({copyPoint:void 0});return}this.selected=void 0;let n=this.unNormalizePoint(ne.create(this.updatedX,this.updatedY)),o=this.state.points.filter((i,a)=>a!==r[0]);o.push(n),o.sort((i,a)=>i[0]===a[0]?i[0]===0?i[1]-a[1]:i[1]===1?a[1]-i[1]:i[1]-a[1]:i[0]-a[0]),this.setState({points:o}),this.change(o),this.gElement.innerHTML="",this.ghostPoints=[],document.removeEventListener("mousemove",this.handleDrag,!0),document.removeEventListener("mouseup",this.handlePointUpdate,!0)}handleDoubleClick(e){let r=this.myRef.createSVGPoint();r.x=e.clientX,r.y=e.clientY;let n=r.matrixTransform(this.myRef.getScreenCTM().inverse()),o=this.state.points,i=this.padding/2;if(n.x<i||n.x>this.width+i||n.y>this.height+i||n.y<this.padding/2)return;let a=this.unNormalizePoint(ne.create(n.x,n.y));o.push(a),o.sort((s,l)=>s[0]===l[0]?s[0]===0?s[1]-l[1]:s[1]===1?l[1]-s[1]:s[1]-l[1]:s[0]-l[0]),this.setState({points:o}),this.change(o)}handleLeave(){this.selected!==void 0&&(document.addEventListener("mousemove",this.handleDrag,!0),document.addEventListener("mouseup",this.handlePointUpdate,!0))}handleEnter(){document.removeEventListener("mousemove",this.handleDrag,!0),document.removeEventListener("mouseup",this.handlePointUpdate,!0)}normalizePoint(e){let r=this.padding/2,n=this.width+r,o=this.height+r,i=e[0]*(n-r)+r,a=e[1]*(o-r)+r,s=this.height+this.padding-a;return ne.create(i,s)}unNormalizePoint(e){let r=this.padding/2,n=this.width+r,o=this.height+r,i=(e[0]-r)/(n-r),a=(this.height+this.padding-e[1]-r)/(o-r);return ne.create(i,a)}refCallBack(e){e&&(this.myRef=e)}renderHistogram(){if(!this.props.volume)return null;let e=Sn.getHistogram(this.props.volume.grid,40),r=[],n=e.counts.length,o=this.width/n,i=this.padding/2,a=Mi(e.counts)||1;for(let s=0;s<n;s++){let l=this.width*s/(n-1)+i,c=this.height+i,u=this.height*(1-e.counts[s]/a)+i;r.push((0,Em.jsx)("line",{x1:l,x2:l,y1:c,y2:u,stroke:"#ded9ca",strokeWidth:o},`histogram${s}`))}return r}renderPoints(){let e=[],r;for(let n=0;n<this.state.points.length;n++)n!==0&&n!==this.state.points.length-1&&(r=this.normalizePoint(this.state.points[n]),e.push((0,Em.jsx)(mP,{id:n,x:r[0],y:r[1],nX:this.state.points[n][0],nY:this.state.points[n][1],selected:!1,delete:this.deletePoint,onmouseover:this.props.onHover,onmousedown:this.handleMouseDown(n),onclick:this.handleClick(n)},n)));return e}renderLines(){let e=[],r=[],n,o,i,a,s,l=this.padding/2;for(let d of this.state.points)n=this.width+l,o=this.height+this.padding,i=d[0]*(n-l)+l,a=d[1]*(o-l)+l,s=this.height+this.padding-a,e.push(ne.create(i,s));let c=e,u=c.length;for(let d=0;d<u-1;d++){let m=c[d][0],p=c[d][1],h=c[d+1][0],f=c[d+1][1];r.push((0,Em.jsx)("line",{x1:m,x2:h,y1:p,y2:f,stroke:"#cec9ba",strokeWidth:"5"},`lineOf${d}`))}return r}};var ja=Ot(Or()),Im=Ot(Po());var rb=class extends Im.Component{constructor(){super(...arguments),this.state={isChanging:!1,current:0},this.begin=()=>{this.setState({isChanging:!0})},this.end=e=>{this.setState({isChanging:!1}),this.props.onChange(e)},this.updateCurrent=e=>{var r,n;this.setState({current:e}),(n=(r=this.props).onChangeImmediate)===null||n===void 0||n.call(r,e)},this.updateManually=e=>{this.setState({isChanging:!0});let r=e;this.props.step===1&&(r=Math.round(r)),r<this.props.min&&(r=this.props.min),r>this.props.max&&(r=this.props.max),this.setState({current:r,isChanging:!0})},this.onManualBlur=()=>{this.setState({isChanging:!1}),this.props.onChange(this.state.current)}}static getDerivedStateFromProps(e,r){return r.isChanging||e.value===r.current?null:{current:e.value}}render(){let e=this.props.step;return e===void 0&&(e=1),(0,ja.jsxs)("div",{className:"msp-slider",children:[(0,ja.jsx)("div",{children:(0,ja.jsx)(PS,{min:this.props.min,max:this.props.max,step:e,value:this.state.current,disabled:this.props.disabled,onBeforeChange:this.begin,onChange:this.updateCurrent,onAfterChange:this.end})}),(0,ja.jsx)("div",{children:(0,ja.jsx)(fl,{numeric:!0,delayMs:50,value:this.state.current,blurOnEnter:!0,onBlur:this.onManualBlur,isDisabled:this.props.disabled,onChange:this.updateManually})})]})}},hP=class extends Im.Component{constructor(){super(...arguments),this.state={isChanging:!1,current:[0,1]},this.begin=()=>{this.setState({isChanging:!0})},this.end=e=>{this.setState({isChanging:!1}),this.props.onChange(e)},this.updateCurrent=e=>{this.setState({current:e})},this.updateMax=e=>{let r=e;this.props.step===1&&(r=Math.round(r)),r<this.state.current[0]?r=this.state.current[0]:r<this.props.min&&(r=this.props.min),r>this.props.max&&(r=this.props.max),this.props.onChange([this.state.current[0],r])},this.updateMin=e=>{let r=e;this.props.step===1&&(r=Math.round(r)),r<this.props.min&&(r=this.props.min),r>this.state.current[1]?r=this.state.current[1]:r>this.props.max&&(r=this.props.max),this.props.onChange([r,this.state.current[1]])}}static getDerivedStateFromProps(e,r){return r.isChanging||e.value[0]===r.current[0]&&e.value[1]===r.current[1]?null:{current:e.value}}render(){let e=this.props.step;return e===void 0&&(e=1),(0,ja.jsxs)("div",{className:"msp-slider2",children:[(0,ja.jsx)("div",{children:(0,ja.jsx)(fl,{numeric:!0,delayMs:50,value:this.state.current[0],onEnter:this.props.onEnter,blurOnEnter:!0,isDisabled:this.props.disabled,onChange:this.updateMin})}),(0,ja.jsx)("div",{children:(0,ja.jsx)(PS,{min:this.props.min,max:this.props.max,step:e,value:this.state.current,disabled:this.props.disabled,onBeforeChange:this.begin,onChange:this.updateCurrent,onAfterChange:this.end,range:!0,allowCross:!0})}),(0,ja.jsx)("div",{children:(0,ja.jsx)(fl,{numeric:!0,delayMs:50,value:this.state.current[1],onEnter:this.props.onEnter,blurOnEnter:!0,isDisabled:this.props.disabled,onChange:this.updateMax})})]})}};function TB(t){let e=[],r={}.hasOwnProperty;for(let n=0;n<arguments.length;n++){let o=arguments[n];if(!o)continue;let i=typeof o;if(i==="string"||i==="number")e.push(o);else if(Array.isArray(o))e.push(TB.apply(null,o));else if(i==="object")for(let a in o)r.call(o,a)&&o[a]&&e.push(a)}return e.join(" ")}function YJ(t){return t.touches.length>1||t.type.toLowerCase()==="touchend"&&t.touches.length>0}function QJ(t,e){return t?e.touches[0].clientY:e.touches[0].pageX}function KJ(t,e){return t?e.clientY:e.pageX}function $J(t,e){let r=e.getBoundingClientRect();return t?r.top+r.height*.5:r.left+r.width*.5}function CB(t){t.stopPropagation(),t.preventDefault()}var wB=class extends Im.Component{render(){let{className:e,tipFormatter:r,vertical:n,offset:o,value:i,index:a}=this.props,s=n?{bottom:`${o}%`}:{left:`${o}%`};return(0,ja.jsx)("div",{className:e,style:s,title:r(i,a)})}},PS=class extends Im.Component{constructor(e){super(e),this.sliderElement=Im.createRef(),this.handleElements=[],this.dragOffset=0,this.startPosition=0,this.startValue=0,this._getPointsCache=void 0,this.onMouseDown=u=>{if(u.button!==0)return;let d=KJ(this.props.vertical,u);if(!this.isEventFromHandle(u))this.dragOffset=0;else{let m=$J(this.props.vertical,u.target);this.dragOffset=d-m,d=m}this.onStart(d),this.addDocumentEvents("mouse"),CB(u)},this.onTouchMove=u=>{if(YJ(u)){this.end("touch");return}let d=QJ(this.props.vertical,u);this.onMove(u,d-this.dragOffset)},this.onTouchStart=u=>{if(YJ(u))return;let d=QJ(this.props.vertical,u);if(!this.isEventFromHandle(u))this.dragOffset=0;else{let m=$J(this.props.vertical,u.target);this.dragOffset=d-m,d=m}this.onStart(d),this.addDocumentEvents("touch"),CB(u)},this.eventHandlers={touchmove:u=>this.onTouchMove(u),touchend:u=>this.end("touch"),mousemove:u=>this.onMouseMove(u),mouseup:u=>this.end("mouse")},this.calcOffset=u=>{let{min:d,max:m}=this.props;return(u-d)/(m-d)*100};let{range:r,min:n,max:o}=e,i=r?Array.apply(null,Array(+r+1)).map(()=>n):n,a="defaultValue"in e?e.defaultValue:i,s=e.value!==void 0?e.value:a,l=(r?s:[n,s]).map(u=>this.trimAlignValue(u)),c;r&&l[0]===l[l.length-1]&&l[0]===o?c=0:c=l.length-1,this.state={handle:null,recent:c,bounds:l}}componentDidUpdate(e){if(!("value"in this.props||"min"in this.props||"max"in this.props))return;let{bounds:r}=this.state;if(e.range){let o=(this.props.value||r).map(i=>this.trimAlignValue(i,this.props));if(o.every((i,a)=>i===r[a]))return;this.setState({bounds:o}),r.some(i=>this.isValueOutOfBounds(i,this.props))&&this.props.onChange(o)}else{let n=this.props.value!==void 0?this.props.value:r[1],o=this.trimAlignValue(n,this.props);if(o===r[1]&&r[0]===e.min)return;this.setState({bounds:[e.min,o]}),this.isValueOutOfBounds(r[1],this.props)&&this.props.onChange(o)}}onChange(e){let r=this.props;!("value"in r)?this.setState(e):e.handle!==void 0&&this.setState({handle:e.handle});let o=w(w({},this.state),e),i=r.range?o.bounds:o.bounds[1];r.onChange(i)}onMouseMove(e){let r=KJ(this.props.vertical,e);this.onMove(e,r-this.dragOffset)}onMove(e,r){CB(e);let n=this.props,o=this.state,i=r-this.startPosition;i=this.props.vertical?-i:i;let a=i/this.getSliderLength()*(n.max-n.min),s=this.trimAlignValue(this.startValue+a),l=o.bounds[o.handle];if(s===l)return;let c=[...o.bounds];c[o.handle]=s;let u=o.handle;if(n.pushable){let d=o.bounds[u];this.pushSurroundingHandles(c,u,d)}else n.allowCross&&(c.sort((d,m)=>d-m),u=c.indexOf(s));this.onChange({handle:u,bounds:c})}onStart(e){this.props.onBeforeChange(this.getValue());let n=this.calcValueByPos(e);this.startValue=n,this.startPosition=e;let o=this.state,{bounds:i}=o,a=1;if(this.props.range){let c=0;for(let d=1;d<i.length-1;++d)n>i[d]&&(c=d);Math.abs(i[c+1]-n)<Math.abs(i[c]-n)&&(c=c+1),a=c;let u=i[c+1]===i[c];u&&(a=o.recent),u&&n!==i[c+1]&&(a=n<i[c+1]?c:c+1)}this.setState({handle:a,recent:a});let s=o.bounds[a];if(n===s)return;let l=[...o.bounds];l[a]=n,this.onChange({bounds:l})}getPoints(){let{marks:e,step:r,min:n,max:o}=this.props,i=this._getPointsCache;if(!i||i.marks!==e||i.step!==r){let a=w({},e);if(r!==null)for(let l=n;l<=o;l+=r)a[l]=l;let s=Object.keys(a).map(parseFloat);s.sort((l,c)=>l-c),this._getPointsCache={marks:e,step:r,points:s}}return this._getPointsCache.points}getPrecision(e){let r=e.toString(),n=0;return r.indexOf(".")>=0&&(n=r.length-r.indexOf(".")-1),n}getSliderLength(){let e=this.sliderElement.current;return e?this.props.vertical?e.clientHeight:e.clientWidth:0}getSliderStart(){let r=this.sliderElement.current.getBoundingClientRect();return this.props.vertical?r.top:r.left}getValue(){let{bounds:e}=this.state;return this.props.range?e:e[1]}addDocumentEvents(e){e==="touch"?(document.addEventListener("touchmove",this.eventHandlers.touchmove),document.addEventListener("touchend",this.eventHandlers.touchend)):e==="mouse"&&(document.addEventListener("mousemove",this.eventHandlers.mousemove),document.addEventListener("mouseup",this.eventHandlers.mouseup))}calcValue(e){let{vertical:r,min:n,max:o}=this.props,i=Math.abs(e/this.getSliderLength());return r?(1-i)*(o-n)+n:i*(o-n)+n}calcValueByPos(e){let r=e-this.getSliderStart();return this.trimAlignValue(this.calcValue(r))}end(e){this.removeEvents(e),this.props.onAfterChange(this.getValue()),this.setState({handle:null})}isEventFromHandle(e){for(let r of this.handleElements)if(r.current===e.target)return!0;return!1}isValueOutOfBounds(e,r){return e<r.min||e>r.max}pushHandle(e,r,n,o){let i=e[r],a=e[r];for(;n*(a-i)<o;){if(!this.pushHandleOnePoint(e,r,n))return e[r]=i,!1;a=e[r]}return!0}pushHandleOnePoint(e,r,n){let o=this.getPoints(),a=o.indexOf(e[r])+n;if(a>=o.length||a<0)return!1;let s=r+n,l=o[a],{pushable:c}=this.props,u=n*(e[s]-l);return this.pushHandle(e,s,n,+c-u)?(e[r]=l,!0):!1}pushSurroundingHandles(e,r,n){let{pushable:o}=this.props,i=e[r],a=0;if(e[r+1]-i<+o?a=1:i-e[r-1]<+o&&(a=-1),a===0)return;let s=r+a,l=a*(e[s]-i);this.pushHandle(e,s,a,+o-l)||(e[r]=n)}removeEvents(e){e==="touch"?(document.removeEventListener("touchmove",this.eventHandlers.touchmove),document.removeEventListener("touchend",this.eventHandlers.touchend)):e==="mouse"&&(document.removeEventListener("mousemove",this.eventHandlers.mousemove),document.removeEventListener("mouseup",this.eventHandlers.mouseup))}trimAlignValue(e,r){let{handle:n,bounds:o}=this.state||{},{marks:i,step:a,min:s,max:l,allowCross:c}=w(w({},this.props),r||{}),u=e;u<=s&&(u=s),u>=l&&(u=l),!c&&n!=null&&n>0&&u<=o[n-1]&&(u=o[n-1]),!c&&n!=null&&n<o.length-1&&u>=o[n+1]&&(u=o[n+1]);let d=Object.keys(i).map(parseFloat);if(a!==null){let h=Math.round((u-s)/a)*a+s;d.push(h)}let m=d.map(h=>Math.abs(u-h)),p=d[m.indexOf(Math.min.apply(Math,m))];return a!==null?parseFloat(p.toFixed(this.getPrecision(a))):p}render(){let{handle:e,bounds:r}=this.state,{className:n,prefixCls:o,disabled:i,vertical:a,range:s,step:l,marks:c,tipFormatter:u}=this.props,d=this.props.handle,m=r.map(this.calcOffset),p=`${o}-handle`,h=r.map((S,T)=>TB({[p]:!0,[`${p}-${T+1}`]:!0,[`${p}-lower`]:T===0,[`${p}-upper`]:T===r.length-1})),b={prefixCls:o,noTip:l===null||u===null,tipFormatter:u,vertical:a};if(this.handleElements.length!==r.length){this.handleElements=[];for(let S=0;S<r.length;S++)this.handleElements.push(Im.createRef())}let v=r.map((S,T)=>Im.cloneElement(d,U(w({},b),{className:h[T],value:S,offset:m[T],dragging:e===T,index:T,key:T,ref:this.handleElements[T]})));s||v.shift();let x=TB({[o]:!0,[`${o}-with-marks`]:Object.keys(c).length,[`${o}-disabled`]:i,[`${o}-vertical`]:this.props.vertical,[n]:!!n});return(0,ja.jsxs)("div",{ref:this.sliderElement,className:x,onTouchStart:i?hs:this.onTouchStart,onMouseDown:i?hs:this.onMouseDown,children:[(0,ja.jsx)("div",{className:`${o}-rail`}),v]})}};PS.defaultProps={prefixCls:"msp-slider-base",className:"",min:0,max:100,step:1,marks:{},handle:(0,ja.jsx)(wB,{className:"",vertical:!1,offset:0,tipFormatter:t=>t,value:0,index:0}),onBeforeChange:hs,onChange:hs,onAfterChange:hs,tipFormatter:(t,e)=>t,disabled:!1,range:!1,vertical:!1,allowCross:!0,pushable:!1};var Hr=class extends $n.PureComponent{constructor(){super(...arguments),this.onChange=e=>{var r,n;if((n=(r=this.props).onChange)===null||n===void 0||n.call(r,e,this.props.values),this.props.onChangeValues){let o=U(w({},this.props.values),{[e.name]:e.value});this.props.onChangeValues(o,this.props.values)}},this.paramGroups=Js(e=>QEe(e))}renderGroup(e){var r;if(e.length===0)return null;let n=this.props.values,o=null,i;for(let[a,s,l]of e)!((r=s.hideIf)===null||r===void 0)&&r.call(s,n)||(o||(o=[]),i=s.category,o.push((0,ve.jsx)(l,{param:s,onChange:this.onChange,onEnter:this.props.onEnter,isDisabled:this.props.isDisabled,name:a,value:n[a]},a)));return o?i?[(0,ve.jsx)(Ci,{header:i,children:o},i)]:o:null}renderPart(e){let r=null;for(let n of e){let o=this.renderGroup(n);if(o){r||(r=[]);for(let i of o)r.push(i)}}return r}render(){let e=this.paramGroups(this.props.params),r=this.renderPart(e.essentials),n=this.renderPart(e.advanced);return r&&n?(0,ve.jsxs)(ve.Fragment,{children:[r,(0,ve.jsx)(Ci,{header:"Advanced Options",children:n})]}):r||n}},yP=class extends Mt{constructor(){super(...arguments),this.state={isDisabled:!1},this.setSettings=(e,r)=>{let n=U(w({},r),{[e.name]:e.value}),o=this.props.mapping.update(n,this.plugin);this.props.mapping.apply(o,this.plugin)}}componentDidMount(){this.subscribe(this.plugin.state.data.behaviors.isUpdating,e=>{this.setState({isDisabled:e})})}render(){let e=this.props.mapping.getTarget(this.plugin),r=this.props.mapping.getValues(e,this.plugin),n=this.props.mapping.params(this.plugin);return(0,ve.jsx)(Hr,{params:n,values:r,onChange:this.setSettings,isDisabled:this.state.isDisabled})}};function QEe(t){function e(a,s,l){let c=kS(s);if(c)if(!s.category)l.params[0].push([a,s,c]);else{l.map||(l.map=new Map);let u=l.map.get(s.category);u||(u=[],l.map.set(s.category,u),l.params.push(u)),u.push([a,s,c])}}function r(a,s){let l=a[0],c=s[0];return!l||!l[1].category?-1:!c||!c[1].category?1:l[1].category<c[1].category?-1:1}let n=Object.keys(t),o={params:[[]],map:void 0},i={params:[[]],map:void 0};for(let a of n){let s=t[a];s.isHidden||(s.isEssential?e(a,s,o):e(a,s,i))}return o.params.sort(r),i.params.sort(r),{essentials:o.params,advanced:i.params}}function kS(t){switch(t.type){case"value":return;case"boolean":return DS;case"number":return typeof t.min<"u"&&typeof t.max<"u"?EB:PB;case"converted":return UB;case"conditioned":return zB;case"multi-select":return FB;case"color":return tb;case"color-list":return t.offsets?kB:AB;case"vec3":return MB;case"mat4":return RB;case"url":return LB;case"file":return BB;case"file-list":return OB;case"select":return nb;case"value-ref":return $Ee;case"data-ref":return;case"text":return vP;case"interval":return typeof t.min<"u"&&typeof t.max<"u"?DB:IB;case"group":return bP;case"mapped":return NB;case"line-graph":return _B;case"script":return GB;case"object-list":return AS;default:console.warn(`${t} has no associated UI component`);return}}var IS=class extends $n.PureComponent{render(){let{legend:e,description:r}=this.props,n=e&&qJ(e);return(0,ve.jsx)("div",{className:"msp-help-text",children:(0,ve.jsxs)("div",{children:[(0,ve.jsxs)("div",{className:"msp-help-description",children:[(0,ve.jsx)(pr,{svg:Bs,inline:!0}),r]}),n&&(0,ve.jsx)("div",{className:"msp-help-legend",children:(0,ve.jsx)(n,{legend:e})})]})})}};function xy(t){let{props:e,state:r,control:n,toggleHelp:o,addOn:i}=t,a=[];e.param.shortLabel&&a.push("msp-control-label-short"),e.param.twoColumns&&a.push("msp-control-col-2"),e.param.multiline&&a.push("msp-control-twoline");let s=a.join(" "),l=e.param.label||Di(e.name),c=e.param.help?e.param.help(e.value):{description:e.param.description,legend:e.param.legend},u=c.description||c.legend,d=l+(u?". Click for help.":"");return(0,ve.jsxs)(ve.Fragment,{children:[(0,ve.jsx)(Ga,{className:s,title:d,label:(0,ve.jsxs)(ve.Fragment,{children:[l,u&&(0,ve.jsx)(jB,{show:r.showHelp,toggle:o,title:d})]}),control:n}),u&&r.showHelp&&(0,ve.jsx)("div",{className:"msp-control-offset",children:(0,ve.jsx)(IS,{legend:c.legend,description:c.description})}),i]})}function jB({show:t,toggle:e,title:r}){return(0,ve.jsx)("button",{className:"msp-help msp-btn-link msp-btn-icon msp-control-group-expander",onClick:e,title:r||`${t?"Hide":"Show"} help`,style:{background:"transparent",textAlign:"left",padding:"0"},children:(0,ve.jsx)(pr,{svg:Bs})})}var by=class extends $n.PureComponent{constructor(){super(...arguments),this.state={showHelp:!1},this.toggleHelp=()=>this.setState({showHelp:!this.state.showHelp})}update(e){this.props.onChange({param:this.props.param,name:this.props.name,value:e})}renderAddOn(){return null}render(){return xy({props:this.props,state:this.state,control:this.renderControl(),toggleHelp:this.toggleHelp,addOn:this.renderAddOn()})}},DS=class extends by{constructor(){super(...arguments),this.onClick=e=>{this.update(!this.props.value),e.currentTarget.blur()}}renderControl(){return(0,ve.jsxs)("button",{onClick:this.onClick,disabled:this.props.isDisabled,children:[(0,ve.jsx)(pr,{svg:this.props.value?Pc:lB}),this.props.value?"On":"Off"]})}},_B=class extends $n.PureComponent{constructor(){super(...arguments),this.state={isExpanded:!1,isOverPoint:!1,message:`${this.props.param.defaultValue.length} points`},this.onHover=e=>{this.setState({isOverPoint:!this.state.isOverPoint}),e?this.setState({message:this.pointToLabel(e)}):this.setState({message:`${this.props.value.length} points`})},this.onDrag=e=>{this.setState({message:this.pointToLabel(e)})},this.onChange=e=>{this.props.onChange({name:this.props.name,param:this.props.param,value:e})},this.toggleExpanded=e=>{this.setState({isExpanded:!this.state.isExpanded}),e.currentTarget.blur()}}pointToLabel(e){var r,n;if(!e)return"";let o=(n=(r=this.props.param).getVolume)===null||n===void 0?void 0:n.call(r);if(o){let{min:i,max:a,mean:s,sigma:l}=o.grid.stats,c=i+(a-i)*e[0],u=(c-s)/l;return`(${c.toFixed(2)} | ${u.toFixed(2)}\u03C3, ${e[1].toFixed(2)})`}else return`(${e[0].toFixed(2)}, ${e[1].toFixed(2)})`}render(){var e,r;let n=this.props.param.label||Di(this.props.name);return(0,ve.jsxs)(ve.Fragment,{children:[(0,ve.jsx)(Ga,{label:n,control:(0,ve.jsx)("button",{onClick:this.toggleExpanded,disabled:this.props.isDisabled,children:`${this.state.message}`})}),(0,ve.jsx)("div",{className:"msp-control-offset",style:{display:this.state.isExpanded?"block":"none",marginTop:1},children:(0,ve.jsx)(pP,{data:this.props.value,volume:(r=(e=this.props.param).getVolume)===null||r===void 0?void 0:r.call(e),onChange:this.onChange,onHover:this.onHover,onDrag:this.onDrag})})]})}},PB=class extends $n.PureComponent{constructor(){super(...arguments),this.state={value:"0"},this.update=e=>{let r=zx(this.props.param.step||.01);e=parseFloat(e.toFixed(r)),this.props.onChange({param:this.props.param,name:this.props.name,value:e})}}render(){let e=this.props.param.label||Di(this.props.name),r=this.props.param.label||Di(this.props.name),n=zx(this.props.param.step||.01);return(0,ve.jsx)(Ga,{title:this.props.param.description,label:r,control:(0,ve.jsx)(fl,{numeric:!0,value:parseFloat(this.props.value.toFixed(n)),onEnter:this.props.onEnter,placeholder:e,isDisabled:this.props.isDisabled,onChange:this.update})})}},EB=class extends by{constructor(){super(...arguments),this.onChange=e=>{this.update(e)}}renderControl(){let e=typeof this.props.value>"u"?this.props.param.defaultValue:this.props.value;return(0,ve.jsx)(rb,{value:e,min:this.props.param.min,max:this.props.param.max,step:this.props.param.step,onChange:this.onChange,onChangeImmediate:this.props.param.immediateUpdate?this.onChange:void 0,disabled:this.props.isDisabled,onEnter:this.props.onEnter})}},vP=class extends by{constructor(){super(...arguments),this.updateValue=e=>{e!==this.props.value&&this.update(e)}}renderControl(){let e=this.props.param.placeholder||this.props.param.label||Di(this.props.name);return(0,ve.jsx)(KEe,{props:this.props,placeholder:e,update:this.updateValue})}};function KEe({props:t,placeholder:e,update:r}){let[n,o]=$n.useState(t.value);return $n.useEffect(()=>o(t.value),[t.value]),t.param.multiline?(0,ve.jsx)("div",{className:"msp-control-text-area-wrapper",children:(0,ve.jsx)("textarea",{value:t.param.disableInteractiveUpdates?n||"":t.value,placeholder:e,onChange:i=>{t.param.disableInteractiveUpdates?o(i.target.value):r(i.target.value)},onBlur:i=>{t.param.disableInteractiveUpdates&&r(i.target.value)},onKeyDown:i=>{i.key==="Enter"&&(i.shiftKey||i.ctrlKey||i.metaKey)&&i.currentTarget.blur()},disabled:t.isDisabled})}):(0,ve.jsx)("input",{type:"text",value:t.param.disableInteractiveUpdates?n||"":t.value,placeholder:e,onChange:i=>{t.param.disableInteractiveUpdates?o(i.target.value):r(i.target.value)},onBlur:i=>{t.param.disableInteractiveUpdates&&r(i.target.value)},disabled:t.isDisabled,onKeyDown:i=>{i.key==="Enter"&&(t.onEnter?(i.stopPropagation(),t.onEnter()):i.key==="Enter"&&(i.shiftKey||i.ctrlKey||i.metaKey)?i.currentTarget.blur():t.param.disableInteractiveUpdates&&r(n))}})}var Dm=class extends $n.PureComponent{constructor(){super(...arguments),this.onChange=e=>{typeof this.props.param.defaultValue=="number"?this.update(parseInt(e.target.value,10)):this.update(e.target.value)}}update(e){this.props.onChange({param:this.props.param,name:this.props.name,value:e})}render(){let e=this.props.value!==void 0&&!this.props.param.options.some(r=>r[0]===this.props.value);return(0,ve.jsxs)("select",{className:"msp-form-control",title:this.props.title,value:this.props.value!==void 0?this.props.value:this.props.param.defaultValue,onChange:this.onChange,disabled:this.props.isDisabled,children:[e&&(0,ve.jsx)("option",{value:this.props.value,children:`[Invalid] ${this.props.value}`},this.props.value),this.props.param.options.map(([r,n])=>(0,ve.jsx)("option",{value:r,children:n},r))]})}},nb=class extends $n.PureComponent{constructor(){super(...arguments),this.state={showHelp:!1,showOptions:!1},this.onSelect=e=>{!e||e.value===this.props.value?this.setState({showOptions:!1}):this.setState({showOptions:!1},()=>{this.props.onChange({param:this.props.param,name:this.props.name,value:e.value})})},this.toggle=()=>this.setState({showOptions:!this.state.showOptions}),this.cycle=()=>{let{options:e}=this.props.param,r=e.findIndex(o=>o[0]===this.props.value),n=r===e.length-1?0:r+1;this.props.onChange({param:this.props.param,name:this.props.name,value:e[n][0]})},this.items=Js(e=>wt.createItemsFromSelectOptions(e.options)),this.toggleHelp=()=>this.setState({showHelp:!this.state.showHelp})}renderControl(){var e;let r=this.items(this.props.param),n=this.props.value!==void 0?wt.findItem(r,this.props.value):void 0,o=n?n.label:typeof this.props.value>"u"?`${((e=wt.getFirstItem(r))===null||e===void 0?void 0:e.label)||""} [Default]`:`[Invalid] ${this.props.value}`,i=this.props.param.cycle?this.cycle:this.toggle,a=this.props.param.cycle?"center":"left",s=this.props.param.cycle?this.props.value==="on"?Pc:this.props.value==="off"?lB:void 0:void 0;return(0,ve.jsx)(Gn,{disabled:this.props.isDisabled,style:{textAlign:a,overflow:"hidden",textOverflow:"ellipsis"},label:o,title:o,icon:s,toggle:i,isSelected:this.state.showOptions})}renderAddOn(){if(!this.state.showOptions)return null;let e=this.items(this.props.param),r=wt.findItem(e,this.props.value);return(0,ve.jsx)(wt,{items:e,current:r,onSelect:this.onSelect})}render(){return xy({props:this.props,state:this.state,control:this.renderControl(),toggleHelp:this.toggleHelp,addOn:this.renderAddOn()})}},$Ee=(()=>{class t extends $n.PureComponent{constructor(){super(...arguments),this.state={showHelp:!1,showOptions:!1},this.onSelect=r=>{!r||r.value===this.props.value?this.setState({showOptions:!1}):this.setState({showOptions:!1},()=>{this.props.onChange({param:this.props.param,name:this.props.name,value:{ref:r.value}})})},this.toggle=()=>this.setState({showOptions:!this.state.showOptions}),this.toggleHelp=()=>this.setState({showHelp:!this.state.showHelp})}get items(){return wt.createItemsFromSelectOptions(this.props.param.getOptions(this.context))}renderControl(){var r;let n=this.items,o=this.props.value.ref?wt.findItem(n,this.props.value.ref):void 0,i=o?o.label:`[Ref] ${(r=this.props.value.ref)!==null&&r!==void 0?r:""}`;return(0,ve.jsx)(Gn,{disabled:this.props.isDisabled,style:{textAlign:"left",overflow:"hidden",textOverflow:"ellipsis"},label:i,title:i,toggle:this.toggle,isSelected:this.state.showOptions})}renderAddOn(){if(!this.state.showOptions)return null;let r=this.items,n=wt.findItem(r,this.props.value.ref);return(0,ve.jsx)(wt,{items:r,current:n,onSelect:this.onSelect})}render(){return xy({props:this.props,state:this.state,control:this.renderControl(),toggleHelp:this.toggleHelp,addOn:this.renderAddOn()})}}return t.contextType=Hl,t})(),IB=class extends $n.PureComponent{constructor(){super(...arguments),this.state={isExpanded:!1},this.components={0:g.Numeric(0,{step:this.props.param.step},{label:"Min"}),1:g.Numeric(0,{step:this.props.param.step},{label:"Max"})},this.componentChange=({name:e,value:r})=>{let n=[...this.props.value];n[+e]=r,this.change(n)},this.toggleExpanded=e=>{this.setState({isExpanded:!this.state.isExpanded}),e.currentTarget.blur()}}change(e){this.props.onChange({name:this.props.name,param:this.props.param,value:e})}render(){let e=this.props.value,r=this.props.param.label||Di(this.props.name),n=zx(this.props.param.step||.01),o=`[${e[0].toFixed(n)}, ${e[1].toFixed(n)}]`;return(0,ve.jsxs)(ve.Fragment,{children:[(0,ve.jsx)(Ga,{label:r,control:(0,ve.jsx)("button",{onClick:this.toggleExpanded,disabled:this.props.isDisabled,children:o})}),this.state.isExpanded&&(0,ve.jsx)("div",{className:"msp-control-offset",children:(0,ve.jsx)(Hr,{params:this.components,values:e,onChange:this.componentChange,onEnter:this.props.onEnter})})]})}},DB=class extends by{constructor(){super(...arguments),this.onChange=e=>{this.update(e)}}renderControl(){return(0,ve.jsx)(hP,{value:this.props.value,min:this.props.param.min,max:this.props.param.max,step:this.props.param.step,onChange:this.onChange,disabled:this.props.isDisabled,onEnter:this.props.onEnter})}};function ES(t,e=!1){return Array.isArray(t)?e?`${ce.toStyle(t[0])} ${(100*t[1]).toFixed(2)}%`:ce.toStyle(t[0]):ce.toStyle(t)}var ZEe=Pg(t=>`linear-gradient(to right, ${t.map(r=>ES(r,!0)).join(", ")})`),JEe=Pg(t=>{let e=t.length,r=[`${ES(t[0])} ${100*(1/e)}%`];for(let n=1,o=e-1;n<o;++n)r.push(`${ES(t[n])} ${100*(n/e)}%`,`${ES(t[n])} ${100*((n+1)/e)}%`);return r.push(`${ES(t[e-1])} ${100*((e-1)/e)}%`),`linear-gradient(to right, ${r.join(", ")})`});function HB(t,e="0"){return{background:eIe(t.colors,t.kind==="set"),position:"absolute",bottom:"0",height:"4px",right:e,left:"0"}}function eIe(t,e){return e?JEe(t):ZEe(t)}function tIe(){let t=e=>{let r=Za(e[0]);return(0,ve.jsx)("div",{style:HB({kind:r.type!=="qualitative"?"interpolate":"set",colors:r.list})})};return{ColorPresets:{all:wt.createItemsFromSelectOptions(Tz,{addOn:t}),scale:wt.createItemsFromSelectOptions(wz,{addOn:t}),set:wt.createItemsFromSelectOptions(_z,{addOn:t})},ColorsParam:g.ObjectList({color:g.Color(0)},({color:e})=>ce.toHexString(e).toUpperCase()),OffsetColorsParam:g.ObjectList({color:g.Color(0),offset:g.Numeric(0,{min:0,max:1,step:.01})},({color:e,offset:r})=>`${ce.toHexString(e).toUpperCase()} [${r.toFixed(2)}]`),IsInterpolatedParam:g.Boolean(!1,{label:"Interpolated"})}}var gP;function ZJ(){return gP||(gP=tIe(),gP)}var AB=class extends $n.PureComponent{constructor(){super(...arguments),this.state={showHelp:!1,show:void 0},this.toggleEdit=()=>this.setState({show:this.state.show==="edit"?void 0:"edit"}),this.togglePresets=()=>this.setState({show:this.state.show==="presets"?void 0:"presets"}),this.selectPreset=e=>{if(!e)return;this.setState({show:void 0});let r=Za(e.value);this.update({kind:r.type!=="qualitative"?"interpolate":"set",colors:r.list})},this.colorsChanged=({value:e})=>{this.update({kind:this.props.value.kind,colors:e.map(r=>r.color)})},this.isInterpolatedChanged=({value:e})=>{this.update({kind:e?"interpolate":"set",colors:this.props.value.colors})},this.toggleHelp=()=>this.setState({showHelp:!this.state.showHelp})}update(e){this.props.onChange({param:this.props.param,name:this.props.name,value:e})}renderControl(){let{value:e}=this.props;return(0,ve.jsxs)(ve.Fragment,{children:[(0,ve.jsxs)("button",{onClick:this.toggleEdit,style:{position:"relative",paddingRight:"33px"},children:[e.colors.length===1?"1 color":`${e.colors.length} colors`,(0,ve.jsx)("div",{style:HB(e,"33px")})]}),(0,ve.jsx)(pt,{svg:Mp,onClick:this.togglePresets,toggleState:this.state.show==="presets",title:"Color Presets",style:{padding:0,position:"absolute",right:0,top:0,width:"32px"}})]})}renderColors(){if(!this.state.show)return null;let{ColorPresets:e,ColorsParam:r,IsInterpolatedParam:n}=ZJ(),o=e[this.props.param.presetKind];if(this.state.show==="presets")return(0,ve.jsx)(wt,{items:o,onSelect:this.selectPreset});let i=this.props.value.colors.map(a=>({color:a}));return(0,ve.jsxs)("div",{className:"msp-control-offset",children:[(0,ve.jsx)(AS,{name:"colors",param:r,value:i,onChange:this.colorsChanged,isDisabled:this.props.isDisabled,onEnter:this.props.onEnter}),(0,ve.jsx)(DS,{name:"isInterpolated",param:n,value:this.props.value.kind==="interpolate",onChange:this.isInterpolatedChanged,isDisabled:this.props.isDisabled,onEnter:this.props.onEnter})]})}render(){return xy({props:this.props,state:this.state,control:this.renderControl(),toggleHelp:this.toggleHelp,addOn:this.renderColors()})}},kB=class extends $n.PureComponent{constructor(){super(...arguments),this.state={showHelp:!1,show:void 0},this.toggleEdit=()=>this.setState({show:this.state.show==="edit"?void 0:"edit"}),this.togglePresets=()=>this.setState({show:this.state.show==="presets"?void 0:"presets"}),this.selectPreset=e=>{if(!e)return;this.setState({show:void 0});let r=Za(e.value);this.update({kind:r.type!=="qualitative"?"interpolate":"set",colors:r.list})},this.colorsChanged=({value:e})=>{let r=e.map(n=>[n.color,n.offset]);r.sort((n,o)=>n[1]-o[1]),this.update({kind:this.props.value.kind,colors:r})},this.isInterpolatedChanged=({value:e})=>{this.update({kind:e?"interpolate":"set",colors:this.props.value.colors})},this.toggleHelp=()=>this.setState({showHelp:!this.state.showHelp})}update(e){this.props.onChange({param:this.props.param,name:this.props.name,value:e})}renderControl(){let{value:e}=this.props;return(0,ve.jsxs)(ve.Fragment,{children:[(0,ve.jsxs)("button",{onClick:this.toggleEdit,style:{position:"relative",paddingRight:"33px"},children:[e.colors.length===1?"1 color":`${e.colors.length} colors`,(0,ve.jsx)("div",{style:HB(e,"33px")})]}),(0,ve.jsx)(pt,{svg:Mp,onClick:this.togglePresets,toggleState:this.state.show==="presets",title:"Color Presets",style:{padding:0,position:"absolute",right:0,top:0,width:"32px"}})]})}renderColors(){if(!this.state.show)return null;let{ColorPresets:e,OffsetColorsParam:r,IsInterpolatedParam:n}=ZJ(),o=e[this.props.param.presetKind];if(this.state.show==="presets")return(0,ve.jsx)(wt,{items:o,onSelect:this.selectPreset});let i=this.props.value.colors,a=i.map((s,l)=>Array.isArray(s)?{color:s[0],offset:s[1]}:{color:s,offset:l/i.length});return a.sort((s,l)=>s.offset-l.offset),(0,ve.jsxs)("div",{className:"msp-control-offset",children:[(0,ve.jsx)(AS,{name:"colors",param:r,value:a,onChange:this.colorsChanged,isDisabled:this.props.isDisabled,onEnter:this.props.onEnter}),(0,ve.jsx)(DS,{name:"isInterpolated",param:n,value:this.props.value.kind==="interpolate",onChange:this.isInterpolatedChanged,isDisabled:this.props.isDisabled,onEnter:this.props.onEnter})]})}render(){return xy({props:this.props,state:this.state,control:this.renderControl(),toggleHelp:this.toggleHelp,addOn:this.renderColors()})}},MB=class extends $n.PureComponent{constructor(){super(...arguments),this.state={isExpanded:!1},this.components={0:g.Numeric(0,{step:this.props.param.step},{label:this.props.param.fieldLabels&&this.props.param.fieldLabels.x||"X"}),1:g.Numeric(0,{step:this.props.param.step},{label:this.props.param.fieldLabels&&this.props.param.fieldLabels.y||"Y"}),2:g.Numeric(0,{step:this.props.param.step},{label:this.props.param.fieldLabels&&this.props.param.fieldLabels.z||"Z"})},this.componentChange=({name:e,value:r})=>{let n=y.copy(y.zero(),this.props.value);n[+e]=r,this.change(n)},this.toggleExpanded=e=>{this.setState({isExpanded:!this.state.isExpanded}),e.currentTarget.blur()}}change(e){this.props.onChange({name:this.props.name,param:this.props.param,value:e})}render(){let e=this.props.value,r=this.props.param.label||Di(this.props.name),n=zx(this.props.param.step||.01),o=`[${e[0].toFixed(n)}, ${e[1].toFixed(n)}, ${e[2].toFixed(n)}]`;return(0,ve.jsxs)(ve.Fragment,{children:[(0,ve.jsx)(Ga,{label:r,control:(0,ve.jsx)("button",{onClick:this.toggleExpanded,disabled:this.props.isDisabled,children:o})}),this.state.isExpanded&&(0,ve.jsx)("div",{className:"msp-control-offset",children:(0,ve.jsx)(Hr,{params:this.components,values:e,onChange:this.componentChange,onEnter:this.props.onEnter})})]})}},RB=class extends $n.PureComponent{constructor(){super(...arguments),this.state={isExpanded:!1},this.components={json:g.Text(JSON.stringify(W()),{description:"JSON array with 4x4 matrix in a column major (j * 4 + i indexing) format"})},this.componentChange=({name:e,value:r})=>{let n=W.copy(W(),this.props.value);e==="json"?W.copy(n,JSON.parse(r)):n[+e]=r,this.change(n)},this.toggleExpanded=e=>{this.setState({isExpanded:!this.state.isExpanded}),e.currentTarget.blur()}}change(e){this.props.onChange({name:this.props.name,param:this.props.param,value:e})}changeValue(e){return r=>{let n=W.copy(W(),this.props.value);n[e]=r,this.change(n)}}get grid(){let e=this.props.value,r=[];for(let n=0;n<4;n++){let o=[];for(let i=0;i<4;i++)o.push((0,ve.jsx)(fl,{numeric:!0,delayMs:50,value:W.getValue(e,n,i),onChange:this.changeValue(4*i+n),className:"msp-form-control",blurOnEnter:!0,isDisabled:this.props.isDisabled},i));r.push((0,ve.jsx)("div",{className:"msp-flex-row",children:o},n))}return(0,ve.jsx)("div",{className:"msp-parameter-matrix",children:r})}render(){let e={json:JSON.stringify(this.props.value)},r=this.props.param.label||Di(this.props.name);return(0,ve.jsxs)(ve.Fragment,{children:[(0,ve.jsx)(Ga,{label:r,control:(0,ve.jsx)("button",{onClick:this.toggleExpanded,disabled:this.props.isDisabled,children:"4\xD74 Matrix"})}),this.state.isExpanded&&(0,ve.jsxs)("div",{className:"msp-control-offset",children:[this.grid,(0,ve.jsx)(Hr,{params:this.components,values:e,onChange:this.componentChange,onEnter:this.props.onEnter})]})]})}},LB=class extends by{constructor(){super(...arguments),this.onChange=e=>{let r=e.target.value;r!==Wr.getUrl(this.props.value||"")&&this.update(Wr.Url(r))},this.onKeyPress=e=>{(e.keyCode===13||e.charCode===13||e.key==="Enter")&&this.props.onEnter&&this.props.onEnter(),e.stopPropagation()}}renderControl(){let e=this.props.param.label||Di(this.props.name);return(0,ve.jsx)("input",{type:"text",value:Wr.getUrl(this.props.value||""),placeholder:e,onChange:this.onChange,onKeyPress:this.props.onEnter?this.onKeyPress:void 0,disabled:this.props.isDisabled})}},BB=class extends $n.PureComponent{constructor(){super(...arguments),this.state={showHelp:!1},this.onChangeFile=e=>{this.change(e.target.files[0])},this.toggleHelp=()=>this.setState({showHelp:!this.state.showHelp})}change(e){this.props.onChange({name:this.props.name,param:this.props.param,value:Wr.File(e)})}renderControl(){let e=this.props.value;return(0,ve.jsxs)("div",{className:"msp-btn msp-btn-block msp-btn-action msp-loader-msp-btn-file",style:{marginTop:"1px"},children:[e?e.name:"Select a file..."," ",(0,ve.jsx)("input",{disabled:this.props.isDisabled,onChange:this.onChangeFile,type:"file",multiple:!1,accept:this.props.param.accept})]})}render(){return this.props.param.label?xy({props:this.props,state:this.state,control:this.renderControl(),toggleHelp:this.toggleHelp,addOn:null}):this.renderControl()}},OB=class extends $n.PureComponent{constructor(){super(...arguments),this.state={showHelp:!1},this.onChangeFileList=e=>{this.change(e.target.files)},this.toggleHelp=()=>this.setState({showHelp:!this.state.showHelp})}change(e){let r=[];if(e)for(let n=0,o=e.length;n<o;++n)r.push(Wr.File(e[n]));this.props.onChange({name:this.props.name,param:this.props.param,value:r})}renderControl(){let e=this.props.value,r=[];if(e)for(let o of e)r.push(o.name);let n=r.length===0?"Select files...":r.length===1?r[0]:`${r.length} files selected`;return(0,ve.jsxs)("div",{className:"msp-btn msp-btn-block msp-btn-action msp-loader-msp-btn-file",style:{marginTop:"1px"},children:[n," ",(0,ve.jsx)("input",{disabled:this.props.isDisabled,onChange:this.onChangeFileList,type:"file",multiple:!0,accept:this.props.param.accept})]})}render(){return this.props.param.label?xy({props:this.props,state:this.state,control:this.renderControl(),toggleHelp:this.toggleHelp,addOn:null}):this.renderControl()}},FB=class extends $n.PureComponent{constructor(){super(...arguments),this.state={isExpanded:!1},this.toggleExpanded=e=>{this.setState({isExpanded:!this.state.isExpanded}),e.currentTarget.blur()}}change(e){this.props.onChange({name:this.props.name,param:this.props.param,value:e})}toggle(e){return r=>{this.props.value.indexOf(e)<0?this.change(this.props.value.concat(e)):this.change(this.props.value.filter(n=>n!==e)),r.currentTarget.blur()}}render(){let e=this.props.value,r=this.props.param.emptyValue,n=this.props.param.label||Di(this.props.name);return(0,ve.jsxs)(ve.Fragment,{children:[(0,ve.jsx)(Ga,{label:n,control:(0,ve.jsx)("button",{onClick:this.toggleExpanded,disabled:this.props.isDisabled,children:e.length===0&&r?r:`${e.length} of ${this.props.param.options.length}`})}),this.state.isExpanded&&(0,ve.jsx)("div",{className:"msp-control-offset",children:this.props.param.options.map(([o,i])=>{let a=e.indexOf(o)>=0;return(0,ve.jsx)(vt,{onClick:this.toggle(o),disabled:this.props.isDisabled,style:{marginTop:"1px"},children:(0,ve.jsx)("span",{style:{float:a?"left":"right"},children:a?`\u2713 ${i}`:`${i} \u2717`})},o)})})]})}},bP=class extends $n.PureComponent{constructor(){super(...arguments),this.state={isExpanded:!!this.props.param.isExpanded,showPresets:!1,showHelp:!1},this.onChangeParam=e=>{this.change(U(w({},this.props.value),{[e.name]:e.value}))},this.toggleExpanded=()=>this.setState({isExpanded:!this.state.isExpanded}),this.toggleShowPresets=()=>this.setState({showPresets:!this.state.showPresets}),this.presetItems=Js(e=>{var r;return wt.createItemsFromSelectOptions((r=e.presets)!==null&&r!==void 0?r:[])}),this.onSelectPreset=e=>{this.setState({showPresets:!1}),this.change(e?.value)}}change(e){this.props.onChange({name:this.props.name,param:this.props.param,value:e})}pivotedPresets(){if(!this.props.param.presets)return null;let e=this.props.param.label||Di(this.props.name);return(0,ve.jsxs)("div",{className:"msp-control-group-wrapper",children:[(0,ve.jsx)("div",{className:"msp-control-group-header",children:(0,ve.jsxs)("button",{className:"msp-btn msp-form-control msp-btn-block",onClick:this.toggleShowPresets,children:[(0,ve.jsx)(pr,{svg:Mp}),e," Presets"]})}),this.state.showPresets&&(0,ve.jsx)(wt,{items:this.presetItems(this.props.param),onSelect:this.onSelectPreset})]})}presets(){return this.props.param.presets?(0,ve.jsxs)(ve.Fragment,{children:[(0,ve.jsx)("div",{className:"msp-control-group-presets-wrapper",children:(0,ve.jsx)("div",{className:"msp-control-group-header",children:(0,ve.jsxs)("button",{className:"msp-btn msp-form-control msp-btn-block",onClick:this.toggleShowPresets,children:[(0,ve.jsx)(pr,{svg:Mp}),"Presets"]})})}),this.state.showPresets&&(0,ve.jsx)(wt,{items:this.presetItems(this.props.param),onSelect:this.onSelectPreset})]}):null}pivoted(){let e=this.props.param.pivot,r=this.props.param.params,n=r[e],o=kS(n),i=(0,ve.jsx)(o,{name:e,param:n,value:this.props.value[e],onChange:this.onChangeParam,onEnter:this.props.onEnter,isDisabled:this.props.isDisabled});if(!this.state.isExpanded)return(0,ve.jsxs)("div",{className:"msp-mapped-parameter-group",children:[i,(0,ve.jsx)(pt,{svg:Pu,onClick:this.toggleExpanded,toggleState:this.state.isExpanded,title:"More Options"})]});let a=Object.create(null);for(let s of Object.keys(r))s!==e&&(a[s]=r[s]);return(0,ve.jsxs)("div",{className:"msp-mapped-parameter-group",children:[i,(0,ve.jsx)(pt,{svg:Pu,onClick:this.toggleExpanded,toggleState:this.state.isExpanded,title:"More Options"}),(0,ve.jsxs)("div",{className:"msp-control-offset",children:[this.pivotedPresets(),(0,ve.jsx)(Hr,{params:a,onEnter:this.props.onEnter,values:this.props.value,onChange:this.onChangeParam,isDisabled:this.props.isDisabled})]})]})}render(){let e=this.props.param.params;if(Object.keys(e).length===0)return null;if(this.props.param.pivot)return this.pivoted();let r=this.props.param.label||Di(this.props.name),n=(0,ve.jsx)(Hr,{params:e,onChange:this.onChangeParam,values:this.props.value,onEnter:this.props.onEnter,isDisabled:this.props.isDisabled});return this.props.inMapped?(0,ve.jsx)("div",{className:"msp-control-offset",children:n}):this.props.param.isFlat?n:(0,ve.jsxs)("div",{className:"msp-control-group-wrapper",style:{position:"relative"},children:[(0,ve.jsx)("div",{className:"msp-control-group-header",children:(0,ve.jsxs)("button",{className:"msp-btn msp-form-control msp-btn-block",onClick:this.toggleExpanded,children:[(0,ve.jsx)(pr,{svg:this.state.isExpanded?Rs:Ls}),r]})}),this.presets(),this.state.isExpanded&&(0,ve.jsx)("div",{className:"msp-control-offset",children:n})]})}},NB=class extends $n.PureComponent{constructor(){super(...arguments),this.state={isExpanded:!1},this.valuesCache={},this.onChangeName=e=>{this.change({name:e.value,params:this.getValues(e.value)})},this.onChangeParam=e=>{this.setValues(this.props.value.name,e.value),this.change({name:this.props.value.name,params:e.value})},this.toggleExpanded=()=>this.setState({isExpanded:!this.state.isExpanded})}setValues(e,r){this.valuesCache[e]=r}getValues(e){return e in this.valuesCache?this.valuesCache[e]:this.props.param.map(e).defaultValue}change(e){this.props.onChange({name:this.props.name,param:this.props.param,value:e})}areParamsEmpty(e){for(let r of Object.keys(e))if(!e[r].isHidden)return!1;return!0}render(){let e=this.props.value||this.props.param.defaultValue,r=this.props.param.map(e.name),n=this.props.param.label||Di(this.props.name),o=kS(r),i=this.props.param.help,a=i?U(w({},this.props.param.select),{help:l=>i({name:l,params:this.getValues(l)})}):this.props.param.select,s=(0,ve.jsx)(nb,{param:a,isDisabled:this.props.isDisabled,onChange:this.onChangeName,onEnter:this.props.onEnter,name:n,value:e.name});return o?r.type==="group"&&!r.isFlat?this.areParamsEmpty(r.params)?s:(0,ve.jsxs)("div",{className:"msp-mapped-parameter-group",children:[s,(0,ve.jsx)(pt,{svg:Pu,onClick:this.toggleExpanded,toggleState:this.state.isExpanded,title:`${n} Properties`}),this.state.isExpanded&&(0,ve.jsx)(bP,{inMapped:!0,param:r,value:e.params,name:e.name,onChange:this.onChangeParam,onEnter:this.props.onEnter,isDisabled:this.props.isDisabled})]}):(0,ve.jsxs)(ve.Fragment,{children:[s,(0,ve.jsx)(o,{param:r,value:e.params,name:e.name,onChange:this.onChangeParam,onEnter:this.props.onEnter,isDisabled:this.props.isDisabled})]}):s}},xP=class extends $n.PureComponent{constructor(){super(...arguments),this.state={current:this.props.value},this.onChangeParam=e=>{this.setState({current:U(w({},this.state.current),{[e.name]:e.value})})},this.apply=()=>{this.props.apply(this.state.current)}}componentDidUpdate(e){(this.props.params!==e.params||this.props.value!==e.value)&&this.setState({current:this.props.value})}render(){return(0,ve.jsxs)(ve.Fragment,{children:[(0,ve.jsx)(Hr,{params:this.props.params,onChange:this.onChangeParam,values:this.state.current,onEnter:this.apply,isDisabled:this.props.isDisabled}),(0,ve.jsx)("button",{className:"msp-btn msp-btn-block msp-form-control msp-control-top-offset",onClick:this.apply,disabled:this.props.isDisabled,children:this.props.isUpdate?"Update":"Add"})]})}},VB=class extends $n.PureComponent{constructor(){super(...arguments),this.state={isExpanded:!1},this.update=e=>{this.props.actions.update(e,this.props.index)},this.moveUp=()=>{this.props.actions.move(this.props.index,-1)},this.moveDown=()=>{this.props.actions.move(this.props.index,1)},this.remove=()=>{this.setState({isExpanded:!1}),this.props.actions.remove(this.props.index)},this.toggleExpanded=e=>{this.setState({isExpanded:!this.state.isExpanded}),e.currentTarget.blur()}}render(){return(0,ve.jsxs)(ve.Fragment,{children:[(0,ve.jsxs)("div",{className:"msp-param-object-list-item",children:[(0,ve.jsxs)("button",{className:"msp-btn msp-btn-block msp-form-control",onClick:this.toggleExpanded,children:[(0,ve.jsx)("span",{children:`${this.props.index+1}: `}),this.props.param.getLabel(this.props.value)]}),(0,ve.jsxs)("div",{children:[(0,ve.jsx)(pt,{svg:_h,title:"Move Up",onClick:this.moveUp,small:!0}),(0,ve.jsx)(pt,{svg:Ph,title:"Move Down",onClick:this.moveDown,small:!0}),(0,ve.jsx)(pt,{svg:Hi,title:"Remove",onClick:this.remove,small:!0})]})]}),this.state.isExpanded&&(0,ve.jsx)("div",{className:"msp-control-offset",children:(0,ve.jsx)(xP,{params:this.props.param.element,apply:this.update,value:this.props.value,isUpdate:!0,isDisabled:this.props.isDisabled})})]})}},AS=class extends $n.PureComponent{constructor(){super(...arguments),this.state={isExpanded:!1},this.add=e=>{this.change([...this.props.value,e])},this.actions={update:(e,r)=>{let n=this.props.value.slice(0);n[r]=e,this.change(n)},move:(e,r)=>{let n=this.props.value;if(n.length===1)return;let o=(e+r)%n.length;o<0&&(o+=n.length),n=n.slice(0);let i=n[e];n[e]=n[o],n[o]=i,this.change(n)},remove:e=>{let r=this.props.value,n=[];for(let o=0;o<r.length;o++)e!==o&&n.push(r[o]);this.change(n)}},this.toggleExpanded=e=>{this.setState({isExpanded:!this.state.isExpanded}),e.currentTarget.blur()}}change(e){this.props.onChange({name:this.props.name,param:this.props.param,value:e})}render(){let e=this.props.value,r=this.props.param.label||Di(this.props.name),n=`${e.length} item${e.length!==1?"s":""}`;return(0,ve.jsxs)(ve.Fragment,{children:[(0,ve.jsx)(Ga,{label:r,control:(0,ve.jsx)("button",{onClick:this.toggleExpanded,disabled:this.props.isDisabled,children:n})}),this.state.isExpanded&&(0,ve.jsxs)("div",{className:"msp-control-offset",children:[this.props.value.map((o,i)=>(0,ve.jsx)(VB,{param:this.props.param,value:o,index:i,actions:this.actions,isDisabled:this.props.isDisabled},i)),(0,ve.jsx)(Ua,{header:"New Item",children:(0,ve.jsx)(xP,{params:this.props.param.element,apply:this.add,value:this.props.param.ctor(),isDisabled:this.props.isDisabled})})]})]})}},zB=class extends $n.PureComponent{constructor(){super(...arguments),this.onChangeCondition=e=>{this.change(this.props.param.conditionedValue(this.props.value,e.value))},this.onChangeParam=e=>{this.change(e.value)}}change(e){this.props.onChange({name:this.props.name,param:this.props.param,value:e})}render(){let e=this.props.value,r=this.props.param.conditionForValue(e),n=this.props.param.conditionParams[r],o=this.props.param.label||Di(this.props.name),i=kS(n),a=(0,ve.jsx)(nb,{param:this.props.param.select,isDisabled:this.props.isDisabled,onChange:this.onChangeCondition,onEnter:this.props.onEnter,name:`${o} Kind`,value:r});return i?(0,ve.jsxs)(ve.Fragment,{children:[a,(0,ve.jsx)(i,{param:n,value:e,name:o,onChange:this.onChangeParam,onEnter:this.props.onEnter,isDisabled:this.props.isDisabled})]}):a}},UB=class extends $n.PureComponent{constructor(){super(...arguments),this.onChange=e=>{this.props.onChange({name:this.props.name,param:this.props.param,value:this.props.param.toValue(e.value)})}}render(){let e=this.props.param.fromValue(this.props.value),r=kS(this.props.param.converted);return r?(0,ve.jsx)(r,{param:this.props.param.converted,value:e,name:this.props.name,onChange:this.onChange,onEnter:this.props.onEnter,isDisabled:this.props.isDisabled}):null}},GB=class extends $n.PureComponent{constructor(){super(...arguments),this.onChange=({name:e,value:r})=>{let n=e;r!==this.props.value[n]&&this.props.onChange({param:this.props.param,name:this.props.name,value:U(w({},this.props.value),{[n]:r})})}}render(){let e={defaultValue:this.props.value.language,options:g.objectToOptions(Jr.Info),type:"select"},r=(0,ve.jsx)(nb,{param:e,isDisabled:this.props.isDisabled,onChange:this.onChange,onEnter:this.props.onEnter,name:"language",value:this.props.value.language}),n={defaultValue:this.props.value.language,type:"text"},o=(0,ve.jsx)(vP,{param:n,isDisabled:this.props.isDisabled,onChange:this.onChange,name:"expression",value:this.props.value.expression});return(0,ve.jsxs)(ve.Fragment,{children:[r,this.props.value.language!=="mol-script"&&(0,ve.jsxs)("div",{className:"msp-help-text",style:{padding:"10px"},children:[(0,ve.jsx)(pr,{svg:uP})," Support for PyMOL, VMD, and Jmol selections is an experimental feature and may not always work as intended."]}),o]})}};var rIe={color:g.Color(ut.black,{description:"Display color of the volume."}),wireframe:g.Boolean(!1,{description:"Control display of the volume as a wireframe."}),opacity:g.Numeric(.3,{min:0,max:1,step:.01},{description:"Opacity of the volume."})},nIe=new Map([["em",[-5,5]],["2fo-fc",[0,3]],["fo-fc(+ve)",[1,5]],["fo-fc(-ve)",[-5,-1]]]),ob=class extends Mt{constructor(){super(...arguments),this.ref=lt.findTagInSubtree(this.plugin.state.data.tree,this.props.bCell.transform.ref,this.props.name),this.getVisible=()=>{let e=this.plugin.state.data,r=this.ref;return r?!e.cells.get(r).state.isHidden:!1},this.toggleVisible=()=>{let e=this.plugin.state.data,r=this.ref;r&&Id(e,r,!e.cells.get(r).state.isHidden)}}componentDidUpdate(){this.ref=lt.findTagInSubtree(this.plugin.state.data.tree,this.props.bCell.transform.ref,this.props.name)}componentDidMount(){this.subscribe(this.plugin.state.data.events.cell.stateUpdated,e=>{this.ref===e.ref&&this.forceUpdate()})}render(){let e=this.props,{isRelative:r,stats:n}=e,o=e.channels[e.name],{min:i,max:a,mean:s,sigma:l}=n,c=Math.round(100*(o.isoValue.kind==="relative"?o.isoValue.relativeValue:o.isoValue.absoluteValue))/100,u=(i-s)/l,d=(a-s)/l;if(!this.props.isUnbounded){let v=nIe.get(this.props.name);this.props.name==="em"?(u=Math.max(v[0],u),d=Math.min(v[1],d)):(u=v[0],d=v[1])}let m=s+l*u,p=s+l*d,h=Ux(r?Math.round((p-m)/l)/100:l/100,2),f=r?u:m,b=r?d:p;return(0,Os.jsx)(dP,{label:e.label+(e.isRelative?" \u03C3":""),colorStripe:o.color,pivot:(0,Os.jsxs)("div",{className:"msp-volume-channel-inline-controls",children:[(0,Os.jsx)(rb,{value:c,min:f,max:b,step:h,onChange:v=>e.changeIso(e.name,v,r),onChangeImmediate:v=>e.changeIso(e.name,v,r),disabled:e.params.isDisabled,onEnter:e.params.events.onEnter}),(0,Os.jsx)(pt,{svg:this.getVisible()?Ic:Ec,onClick:this.toggleVisible,toggleState:!1,disabled:e.params.isDisabled})]}),controls:(0,Os.jsx)(Hr,{onChange:({name:v,value:x})=>e.changeParams(e.name,v,x),params:rIe,values:o,onEnter:e.params.events.onEnter,isDisabled:e.params.isDisabled})})}},SP=class extends Mt{constructor(){super(...arguments),this.changeIso=(e,r,n)=>{let o=this.props.params;this.newParams(U(w({},o),{entry:{name:o.entry.name,params:U(w({},o.entry.params),{channels:U(w({},o.entry.params.channels),{[e]:U(w({},o.entry.params.channels[e]),{isoValue:n?xe.IsoValue.relative(r):xe.IsoValue.absolute(r)})})})}}))},this.changeParams=(e,r,n)=>{let o=this.props.params;this.newParams(U(w({},o),{entry:{name:o.entry.name,params:U(w({},o.entry.params),{channels:U(w({},o.entry.params.channels),{[e]:U(w({},o.entry.params.channels[e]),{[r]:n})})})}}))},this.changeOption=({name:e,value:r})=>{let n=this.props.params;if(e==="entry")this.newParams(U(w({},n),{entry:{name:r,params:n.entry.params}}));else{let o=this.props.b.data,i=o.info.kind==="em",a=r.params.isRelative,s=o.info.header.sampling[0],l=n.entry.params.channels,c=n.entry.params.view.name===r.name?n.entry.params.view.params:this.props.info.params.entry.map(n.entry.name).params.view.map(r.name).defaultValue,u=w({},c);r.name==="selection-box"?u.radius=r.params.radius:r.name==="camera-target"?(u.radius=r.params.radius,u.dynamicDetailLevel=r.params.dynamicDetailLevel):r.name==="box"?(u.bottomLeft=r.params.bottomLeft,u.topRight=r.params.topRight):r.name==="auto"&&(u.radius=r.params.radius,u.selectionDetailLevel=r.params.selectionDetailLevel),u.isUnbounded=!!r.params.isUnbounded,this.newParams(U(w({},n),{entry:{name:n.entry.name,params:U(w({},n.entry.params),{view:{name:r.name,params:u},detailLevel:r.params.detailLevel,channels:i?{em:this.convert(l.em,s.valuesInfo[0],a)}:{"2fo-fc":this.convert(l["2fo-fc"],s.valuesInfo[0],a),"fo-fc(+ve)":this.convert(l["fo-fc(+ve)"],s.valuesInfo[1],a),"fo-fc(-ve)":this.convert(l["fo-fc(-ve)"],s.valuesInfo[1],a)}})}}))}}}areInitial(e){return g.areEqual(this.props.info.params,e,this.props.info.initialValues)}newParams(e){this.props.events.onChange(e,this.areInitial(e))}convert(e,r,n){return U(w({},e),{isoValue:n?xe.IsoValue.toRelative(e.isoValue,r):xe.IsoValue.toAbsolute(e.isoValue,r)})}render(){if(!this.props.b)return null;let e=this.props.b.data,r=e.info.kind==="em",n=r?"em":"2fo-fc",o=this.props.params,i=this.props.info.params.entry.map(o.entry.name),a=i.params.detailLevel,s=U(w({},a),{label:"Dynamic Detail",defaultValue:i.params.view.map("camera-target").params.dynamicDetailLevel.defaultValue}),l=U(w({},a),{label:"Selection Detail",defaultValue:i.params.view.map("auto").params.selectionDetailLevel.defaultValue}),c=e.info.header.sampling[0],u=o.entry.params.channels[n].isoValue.kind==="relative",d=g.Boolean(u,{description:"Use normalized or absolute isocontour scale.",label:"Normalized"}),m=!!o.entry.params.view.params.isUnbounded,p=g.Boolean(m,{description:"Show full/limited range of iso-values for more fine-grained control.",label:"Unbounded"}),h=o.entry.params.view.name==="off",f={entry:g.Select(o.entry.name,e.data.entries.map(v=>[v.dataId,v.dataId]),{isHidden:h,description:"Which entry with volume data to display."}),view:g.MappedStatic(o.entry.params.view.name,{off:g.Group({isRelative:g.Boolean(u,{isHidden:!0}),isUnbounded:g.Boolean(m,{isHidden:!0})},{description:"Display off."}),box:g.Group({bottomLeft:g.Vec3(y.zero()),topRight:g.Vec3(y.zero()),detailLevel:a,isRelative:d,isUnbounded:p},{description:"Static box defined by cartesian coords."}),"selection-box":g.Group({radius:g.Numeric(5,{min:0,max:50,step:.5},{description:"Radius in \u212B within which the volume is shown."}),detailLevel:a,isRelative:d,isUnbounded:p},{description:"Box around focused element."}),"camera-target":g.Group({radius:g.Numeric(.5,{min:0,max:1,step:.05},{description:"Radius within which the volume is shown (relative to the field of view)."}),detailLevel:U(w({},a),{isHidden:!0}),dynamicDetailLevel:s,isRelative:d,isUnbounded:p},{description:"Box around camera target."}),cell:g.Group({detailLevel:a,isRelative:d,isUnbounded:p},{description:"Box around the structure's bounding box."}),auto:g.Group({radius:g.Numeric(5,{min:0,max:50,step:.5},{description:"Radius in \u212B within which the volume is shown."}),detailLevel:a,selectionDetailLevel:l,isRelative:d,isUnbounded:p},{description:"Box around focused element."})},{options:di.ViewTypeOptions,description:'Controls what of the volume is displayed. "Off" hides the volume alltogether. "Bounded box" shows the volume inside the given box. "Around Focus" shows the volume around the element/atom last interacted with. "Around Camera" shows the volume around the point the camera is targeting. "Whole Structure" shows the volume for the whole structure.'})},b={entry:o.entry.name,view:{name:o.entry.params.view.name,params:{detailLevel:o.entry.params.detailLevel,radius:o.entry.params.view.params.radius,bottomLeft:o.entry.params.view.params.bottomLeft,topRight:o.entry.params.view.params.topRight,selectionDetailLevel:o.entry.params.view.params.selectionDetailLevel,dynamicDetailLevel:o.entry.params.view.params.dynamicDetailLevel,isRelative:u,isUnbounded:m}}};return h?(0,Os.jsx)(Hr,{onChange:this.changeOption,params:f,values:b,onEnter:this.props.events.onEnter,isDisabled:this.props.isDisabled}):(0,Os.jsxs)(Os.Fragment,{children:[!r&&(0,Os.jsx)(ob,{label:"2Fo-Fc",name:"2fo-fc",bCell:this.props.bCell,channels:o.entry.params.channels,changeIso:this.changeIso,changeParams:this.changeParams,isRelative:u,params:this.props,stats:c.valuesInfo[0],isUnbounded:m}),!r&&(0,Os.jsx)(ob,{label:"Fo-Fc(+ve)",name:"fo-fc(+ve)",bCell:this.props.bCell,channels:o.entry.params.channels,changeIso:this.changeIso,changeParams:this.changeParams,isRelative:u,params:this.props,stats:c.valuesInfo[1],isUnbounded:m}),!r&&(0,Os.jsx)(ob,{label:"Fo-Fc(-ve)",name:"fo-fc(-ve)",bCell:this.props.bCell,channels:o.entry.params.channels,changeIso:this.changeIso,changeParams:this.changeParams,isRelative:u,params:this.props,stats:c.valuesInfo[1],isUnbounded:m}),r&&(0,Os.jsx)(ob,{label:"EM",name:"em",bCell:this.props.bCell,channels:o.entry.params.channels,changeIso:this.changeIso,changeParams:this.changeParams,isRelative:u,params:this.props,stats:c.valuesInfo[0],isUnbounded:m}),(0,Os.jsx)(Hr,{onChange:this.changeOption,params:f,values:b,onEnter:this.props.events.onEnter,isDisabled:this.props.isDisabled})]})}};var qB=()=>U(w({},rJ()),{customParamEditors:[[W1,SP]]});var MS;(function(t){class e{constructor(){this.providers=Ui().asMutable(),this.defaultAutoAttachValues=new Map}getParams(n){let o={},i=[],a=[];if(n){let s=this.providers.values();for(;;){let l=s.next();if(l.done)break;let c=l.value;c.isApplicable(n)&&(c.isHidden||(i.push([c.descriptor.name,c.label]),this.defaultAutoAttachValues.get(c.descriptor.name)&&a.push(c.descriptor.name)),o[c.descriptor.name]=g.Group(w({},c.getParams(n)),{label:c.label,isHidden:c.isHidden}))}}return{autoAttach:g.MultiSelect(a,i),properties:g.Group(o,{isFlat:!0})}}setDefaultAutoAttach(n,o){this.defaultAutoAttachValues.set(n,o)}get(n){if(!this.providers.get(n))throw new Error(`Custom property '${n}' is not registered.`);return this.providers.get(n)}register(n,o){this.providers.set(n.descriptor.name,n),this.defaultAutoAttachValues.set(n.descriptor.name,o)}unregister(n){this.providers.delete(n),this.defaultAutoAttachValues.delete(n)}}t.Registry=e})(MS||(MS={}));var CP=class{get dataState(){return this.plugin.state.data}rawData(e,r){return this.dataState.build().toRoot().apply(nR,e,r).commit({revertOnError:!0})}download(e,r){return this.dataState.build().toRoot().apply(tR,e,r).commit({revertOnError:!0})}downloadBlob(e,r){return this.dataState.build().toRoot().apply(rR,e,r).commit({revertOnError:!0})}readFile(e,r){return N(this,null,function*(){var n,o,i;let a=yield this.dataState.build().toRoot().apply(oR,e,r).commit({revertOnError:!0}),s=kp((i=(o=(n=e.file)===null||n===void 0?void 0:n.file)===null||o===void 0?void 0:o.name)!==null&&i!==void 0?i:"");return{data:a,fileInfo:s}})}constructor(e){this.plugin=e}};var TP=class{get dataState(){return this.plugin.state.data}resolveProvider(e){var r;return typeof e=="string"?(r=Ms[e])!==null&&r!==void 0?r:_T(this._providers,n=>n.id===e):e}hasPreset(e){for(let r of this._providers)if(!r.isApplicable||r.isApplicable(e,this.plugin))return!0;return!1}get providers(){return this._providers}getPresets(e){if(!e)return this.providers;let r=[];for(let n of this._providers)n.isApplicable&&!n.isApplicable(e,this.plugin)||r.push(n);return r}getPresetSelect(e){let r=[];for(let n of this._providers)e&&n.isApplicable&&!n.isApplicable(e,this.plugin)||r.push([n.id,n.display.name,n.display.group]);return g.Select("auto",r)}getPresetsWithOptions(e){let r=[],n=Object.create(null);for(let o of this._providers)o.isApplicable&&!o.isApplicable(e,this.plugin)||(r.push([o.id,o.display.name]),n[o.id]=o.params?g.Group(o.params(e,this.plugin)):g.EmptyGroup());return r.length===0?g.MappedStatic("",{"":g.EmptyGroup()}):g.MappedStatic(r[0][0],n,{options:r})}registerPreset(e){if(this.providerMap.has(e.id))throw new Error(`Representation provider with id '${e.id}' already registered.`);this._providers.push(e),this.providerMap.set(e.id,e)}unregisterPreset(e){this.providerMap.delete(e.id),rp(this._providers,e)}applyPreset(e,r,n){var o;let i=this.resolveProvider(r);if(!i)return;let a=this.plugin.state.data,s=Fn.resolveAndCheck(a,e);if(!s){x0||console.warn("Applying structure repr. provider to bad cell.");return}let l=((o=i.params)===null||o===void 0?void 0:o.call(i,s.obj,this.plugin))||{},c=n||(i.params?g.getDefaultValues(l):{}),u=this.plugin.config.get(Wt.Structure.DefaultRepresentationPresetParams);c=g.merge(l,u,c);let d=ie.create(`${i.display.name}`,()=>i.apply(s,c,this.plugin));return this.plugin.runTask(d)}addRepresentation(e,r,n){return N(this,null,function*(){let o=this.dataState.build(),i=this.buildRepresentation(o,e,r,n);if(i)return yield o.commit(),i})}buildRepresentation(e,r,n,o){var i,a;if(!r)return;let s=(a=(i=Fn.resolveAndCheck(this.dataState,r))===null||i===void 0?void 0:i.obj)===null||a===void 0?void 0:a.data;if(!s)return;let l=Qv(this.plugin,s,n);return o?.tag?e.to(r).applyOrUpdateTagged(o.tag,Tv,l,{state:o?.initialState}).selector:e.to(r).apply(Tv,l,{state:o?.initialState}).selector}constructor(e){this.plugin=e,this._providers=[],this.providerMap=new Map,this.defaultProvider=Ms.auto,ro(Ms,r=>this.registerPreset(r))}};function Eh(t){return t}(function(t){t.CommonParams=(e,r)=>({modelProperties:g.Optional(g.Group(Se.getParamDefinition(de.Model.CustomModelProperties,void 0,r))),structureProperties:g.Optional(g.Group(Se.getParamDefinition(de.Model.CustomStructureProperties,void 0,r))),representationPreset:g.Optional(g.Text("auto"))})})(Eh||(Eh={}));var wP=Eh.CommonParams,oIe=(t,e)=>w({model:g.Optional(g.Group(Se.getParamDefinition(de.Model.ModelFromTrajectory,t,e))),showUnitcell:g.Optional(g.Boolean(!1)),structure:g.Optional(vm.getParams(void 0,"assembly").type),representationPresetParams:g.Optional(g.Group(oa.CommonParams))},wP(t,e)),JJ=Eh({id:"preset-trajectory-default",display:{name:"Default (Assembly)",group:"Preset",description:"Shows the first assembly or, if that is unavailable, the first model."},isApplicable:t=>!0,params:oIe,apply(t,e,r){return N(this,null,function*(){let n=r.builders.structure,o=yield n.createModel(t,e.model),i=yield n.insertModelProperties(o,e.modelProperties),a=yield n.createStructure(i||o,e.structure),s=yield n.insertStructureProperties(a,e.structureProperties),l=e.showUnitcell===void 0||e.showUnitcell?yield n.tryCreateUnitcell(i,void 0,{isHidden:!0}):void 0,c=e.representationPreset||r.config.get(Wt.Structure.DefaultRepresentationPreset)||Ms.auto.id,u=yield r.builders.structure.representation.applyPreset(s,c,e.representationPresetParams);return{model:o,modelProperties:i,unitcell:l,structure:a,structureProperties:s,representation:u}})}}),iIe=(t,e)=>w({useDefaultIfSingleModel:g.Optional(g.Boolean(!1)),representationPresetParams:g.Optional(g.Group(oa.CommonParams))},wP(t,e)),aIe=Eh({id:"preset-trajectory-all-models",display:{name:"All Models",group:"Preset",description:"Shows all models; colored by trajectory-index."},isApplicable:t=>t.data.frameCount>1,params:iIe,apply(t,e,r){return N(this,null,function*(){var n,o;let i=(o=(n=Fn.resolveAndCheck(r.state.data,t))===null||n===void 0?void 0:n.obj)===null||o===void 0?void 0:o.data;if(!i)return{};if(i.frameCount===1&&e.useDefaultIfSingleModel)return JJ.apply(t,e,r);let a=r.builders.structure,s=[],l=[];for(let c=0;c<i.frameCount;c++){let u=yield a.createModel(t,{modelIndex:c}),d=yield a.insertModelProperties(u,e.modelProperties,{isCollapsed:!0}),m=yield a.createStructure(d||u,{name:"model",params:{}}),p=yield a.insertStructureProperties(m,e.structureProperties);s.push(u),l.push(m);let h=m.obj?t3(m.obj.data,{elementCountFactor:i.frameCount}):"medium",f=e.representationPreset||r.config.get(Wt.Structure.DefaultRepresentationPreset)||Ms.auto.id;yield a.representation.applyPreset(p,f,{theme:{globalName:"trajectory-index"},quality:h})}return{models:s,structures:l}})}}),eee=(t,e)=>w({model:g.Optional(g.Group(Se.getParamDefinition(de.Model.ModelFromTrajectory,t,e)))},wP(t,e));function tee(t,e,r,n){return N(this,null,function*(){let o=n.builders.structure,i=yield o.createModel(e,r.model),a=yield o.insertModelProperties(i,r.modelProperties),s=yield o.createStructure(a||i,{name:"symmetry",params:t}),l=yield o.insertStructureProperties(s,r.structureProperties),c=yield o.tryCreateUnitcell(a,void 0,{isHidden:!1}),u=r.representationPreset||n.config.get(Wt.Structure.DefaultRepresentationPreset)||Ms.auto.id,d=yield n.builders.structure.representation.applyPreset(l,u,{theme:{globalName:t.theme}});return{model:i,modelProperties:a,unitcell:c,structure:s,structureProperties:l,representation:d}})}var sIe=Eh({id:"preset-trajectory-unitcell",display:{name:"Unit Cell",group:"Preset",description:"Shows the fully populated unit cell."},isApplicable:t=>Et.hasCrystalSymmetry(t.data.representative),params:eee,apply(t,e,r){return N(this,null,function*(){return yield tee({ijkMin:y.create(0,0,0),ijkMax:y.create(0,0,0)},t,e,r)})}}),lIe=Eh({id:"preset-trajectory-supercell",display:{name:"Super Cell",group:"Preset",description:"Shows the super cell, i.e. the central unit cell and all adjacent unit cells."},isApplicable:t=>Et.hasCrystalSymmetry(t.data.representative),params:eee,apply(t,e,r){return N(this,null,function*(){return yield tee({ijkMin:y.create(-1,-1,-1),ijkMax:y.create(1,1,1),theme:"operator-hkl"},t,e,r)})}}),cIe=(t,e)=>w({model:g.Optional(g.Group(Se.getParamDefinition(de.Model.ModelFromTrajectory,t,e)))},wP(t,e)),uIe=Eh({id:"preset-trajectory-crystal-contacts",display:{name:"Crystal Contacts",group:"Preset",description:"Showsasymetric unit and chains from neighbours within 5 \u212B, i.e., symmetry mates."},isApplicable:t=>Et.hasCrystalSymmetry(t.data.representative),params:cIe,apply(t,e,r){return N(this,null,function*(){let n=r.builders.structure,o=yield n.createModel(t,e.model),i=yield n.insertModelProperties(o,e.modelProperties),a=yield n.createStructure(i||o,{name:"symmetry-mates",params:{radius:5}}),s=yield n.insertStructureProperties(a,e.structureProperties),l=yield n.tryCreateUnitcell(i,void 0,{isHidden:!0}),c=e.representationPreset||r.config.get(Wt.Structure.DefaultRepresentationPreset)||Ms.auto.id,u=yield r.builders.structure.representation.applyPreset(s,c,{theme:{globalName:"operator-name",carbonColor:"operator-name",focus:{name:"element-symbol",params:{carbonColor:{name:"operator-name",params:av.defaultValues}}}}});return{model:o,modelProperties:i,unitcell:l,structure:a,structureProperties:s,representation:u}})}}),_P={default:JJ,"all-models":aIe,unitcell:sIe,supercell:lIe,crystalContacts:uIe};var PP=class{resolveProvider(e){var r;return typeof e=="string"?(r=_P[e])!==null&&r!==void 0?r:_T(this._providers,n=>n.id===e):e}hasPreset(e){for(let r of this._providers)if(!r.isApplicable||r.isApplicable(e,this.plugin))return!0;return!1}get providers(){return this._providers}getPresets(e){if(!e)return this.providers;let r=[];for(let n of this._providers)n.isApplicable&&!n.isApplicable(e,this.plugin)||r.push(n);return r}getPresetSelect(e){let r=[];for(let n of this._providers)e&&n.isApplicable&&!n.isApplicable(e,this.plugin)||r.push([n.id,n.display.name]);return g.Select("auto",r)}getPresetsWithOptions(e){let r=[],n=Object.create(null);for(let o of this._providers)o.isApplicable&&!o.isApplicable(e,this.plugin)||(r.push([o.id,o.display.name]),n[o.id]=o.params?g.Group(o.params(e,this.plugin)):g.EmptyGroup());return r.length===0?g.MappedStatic("",{"":g.EmptyGroup()}):g.MappedStatic(r[0][0],n,{options:r})}registerPreset(e){if(this.providerMap.has(e.id))throw new Error(`Hierarchy provider with id '${e.id}' already registered.`);this._providers.push(e),this.providerMap.set(e.id,e)}unregisterPreset(e){this.providerMap.delete(e.id),rp(this._providers,e)}applyPreset(e,r,n){let o=this.resolveProvider(r);if(!o)return;let i=this.plugin.state.data,a=Fn.resolveAndCheck(i,e);if(!a){x0||console.warn("Applying hierarchy preset provider to bad cell.");return}let s=n||(o.params?g.getDefaultValues(o.params(a.obj,this.plugin)):{}),l=ie.create(`${o.display.name}`,()=>o.apply(a,s,this.plugin));return this.plugin.runTask(l)}constructor(e){this.plugin=e,this._providers=[],this.providerMap=new Map,this.defaultProvider=_P.default,ro(_P,r=>this.registerPreset(r))}};var EP=class{get dataState(){return this.plugin.state.data}parseTrajectoryData(e,r){return N(this,null,function*(){let n=typeof r=="string"?this.plugin.dataFormats.get(r):r;if(!n)throw new Error(`'${r}' is not a supported data format.`);let{trajectory:o}=yield n.parse(this.plugin,e);return o})}parseTrajectoryBlob(e,r){return this.dataState.build().to(e).apply(de.Data.ParseBlob,r,{state:{isGhost:!0}}).apply(de.Model.TrajectoryFromBlob,void 0).commit({revertOnError:!0})}parseTrajectory(e,r){let n=Fn.resolveAndCheck(this.dataState,e);if(!n)throw new Error("Invalid data cell.");return X.Data.Blob.is(n.obj)?this.parseTrajectoryBlob(e,r):this.parseTrajectoryData(e,r)}createModel(e,r,n){return this.dataState.build().to(e).apply(de.Model.ModelFromTrajectory,r||{modelIndex:0},{state:n}).commit({revertOnError:!0})}insertModelProperties(e,r,n){return this.dataState.build().to(e).apply(de.Model.CustomModelProperties,r,{state:n}).commit({revertOnError:!0})}tryCreateUnitcell(e,r,n){var o,i,a;let s=this.dataState,l=(i=(o=Fn.resolveAndCheck(s,e))===null||o===void 0?void 0:o.obj)===null||i===void 0?void 0:i.data;if(!l)return;let c=(a=rs.Provider.get(l))===null||a===void 0?void 0:a.spacegroup.cell;return pa.isZero(c)?void 0:s.build().to(e).apply(de.Representation.ModelUnitcell3D,r,{state:n}).commit({revertOnError:!0})}createStructure(e,r,n,o){var i;let a=this.dataState;if(!r){let l=Fn.resolveAndCheck(a,e);if(l){let c=rs.Provider.get((i=l.obj)===null||i===void 0?void 0:i.data);(!c||c?.assemblies.length===0)&&(r={name:"model",params:{}})}}return a.build().to(e).apply(de.Model.StructureFromModel,{type:r||{name:"assembly",params:{}}},{state:n,tags:o}).commit({revertOnError:!0})}insertStructureProperties(e,r){return this.dataState.build().to(e).apply(de.Model.CustomStructureProperties,r).commit({revertOnError:!0})}isComponentTransform(e){return e.transform.transformer===de.Model.StructureComponent}tryCreateComponent(e,r,n,o){return N(this,null,function*(){var i,a;let s=this.dataState,l=s.build().to(e),c=`structure-component-${n}`,u=l.applyOrUpdateTagged(c,de.Model.StructureComponent,r,{tags:o?[...o,c]:[c]});yield u.commit();let d=u.selector;if(!d.isOk||((a=(i=d.cell)===null||i===void 0?void 0:i.obj)===null||a===void 0?void 0:a.data.elementCount)===0){yield s.build().delete(d.ref).commit();return}return d})}tryCreateComponentFromExpression(e,r,n,o){return this.tryCreateComponent(e,{type:{name:"expression",params:r},nullIfEmpty:!0,label:(o?.label||"").trim()},n,o?.tags)}tryCreateComponentStatic(e,r,n){return this.tryCreateComponent(e,{type:{name:"static",params:r},nullIfEmpty:!0,label:(n?.label||"").trim()},`static-${r}`,n?.tags)}tryCreateComponentFromSelection(e,r,n,o){return this.plugin.runTask(ie.create("Query Component",i=>N(this,null,function*(){var a,s;let{label:l,tags:c}=o||{};l=(l||"").trim();let u=(s=(a=Fn.resolveAndCheck(this.dataState,e))===null||a===void 0?void 0:a.obj)===null||s===void 0?void 0:s.data;if(!u)return;let d=r.referencesCurrent?{type:{name:"bundle",params:z.Bundle.fromSelection(yield r.getSelection(this.plugin,i,u))},nullIfEmpty:!0,label:l||r.label}:{type:{name:"expression",params:r.expression},nullIfEmpty:!0,label:l||r.label};return r.ensureCustomProperties&&(yield r.ensureCustomProperties({runtime:i,assetManager:this.plugin.managers.asset},u)),this.tryCreateComponent(e,d,n,c)})))}constructor(e){this.plugin=e,this.hierarchy=new PP(this.plugin),this.representation=new TP(this.plugin)}};function Bp(t,e,r={}){let n=r;return typeof n.type=="string"||typeof n.color=="string"||typeof n.size=="string"?dIe(t,e||xe.One,r):ree(t,e||xe.One,r)}function dIe(t,e,r){let n=r.type&&t.representation.volume.registry.get(r.type)||t.representation.volume.registry.default.provider,o=r.color&&t.representation.volume.themes.colorThemeRegistry.get(r.color)||t.representation.volume.themes.colorThemeRegistry.get(n.defaultColorTheme.name),i=r.size&&t.representation.volume.themes.sizeThemeRegistry.get(r.size)||t.representation.volume.themes.sizeThemeRegistry.get(n.defaultSizeTheme.name);return ree(t,e,{type:n,typeParams:r.typeParams,color:o,colorParams:r.colorParams,size:i,sizeParams:r.sizeParams})}function ree(t,e,r={}){let{themes:n}=t.representation.volume,o={volume:e},i=r.type||t.representation.volume.registry.default.provider,a=g.getDefaultValues(i.getParams(n,e)),s=Object.assign(a,r.typeParams),l=r.color||n.colorThemeRegistry.get(i.defaultColorTheme.name),c=g.getDefaultValues(l.getParams(o));l.name===i.defaultColorTheme.name&&Object.assign(c,i.defaultColorTheme.props);let u=Object.assign(c,r.colorParams),d=r.size||n.sizeThemeRegistry.get(i.defaultSizeTheme.name),m=g.getDefaultValues(d.getParams(o));d.name===i.defaultSizeTheme.name&&Object.assign(m,i.defaultSizeTheme.props);let p=Object.assign(m,r.sizeParams);return{type:{name:i.name,params:s},colorTheme:{name:l.name,params:u},sizeTheme:{name:d.name,params:p}}}var WB;(function(t){function e(r){let{name:n}=r;return{descriptor:r,get(o){return o._propertyData[n]},set(o,i){o.customProperties.add(r),o._propertyData[n]=i}}}t.create=e})(WB||(WB={}));var RS;(function(t){t.Descriptor={name:"recommended_iso_value"},t.Provider=WB.create(t.Descriptor)})(RS||(RS={}));var ib="Volume";function LS(t,e){return N(this,null,function*(){if(!e)return;let{entryId:r}=e;if(!(!r||!r.toLowerCase().startsWith("emd")))return t.runTask(ie.create("Try Set Recommended IsoValue",n=>N(this,null,function*(){try{let o=yield VM(t,n,r);RS.Provider.set(e,xe.IsoValue.absolute(o))}catch(o){console.warn(o)}})))})}function nee(t){let e=RS.Provider.get(t);if(e)return e.kind==="relative"?e:xe.adjustedIsoValue(t,e.absoluteValue,"absolute")}function XB(t,e){return N(this,null,function*(){let r={},n=e.volume.data&&nee(e.volume.data);return n&&(r.isoValue=n),[yield t.build().to(e.volume).apply(de.Representation.VolumeRepresentation3D,Bp(t,e.volume.data,{type:"isosurface",typeParams:r})).commit()]})}var mIe={label:"CCP4/MRC/MAP",description:"CCP4/MRC/MAP",category:ib,binaryExtensions:["ccp4","mrc","map"],parse:(t,e,r)=>N(void 0,null,function*(){let n=t.build().to(e).apply(de.Data.ParseCcp4,{},{state:{isGhost:!0}}),o=n.apply(de.Volume.VolumeFromCcp4,{entryId:r?.entryId});return yield n.commit({revertOnError:!0}),yield LS(t,o.selector.data),{format:n.selector,volume:o.selector}}),visuals:XB},pIe={label:"DSN6/BRIX",description:"DSN6/BRIX",category:ib,binaryExtensions:["dsn6","brix"],parse:(t,e,r)=>N(void 0,null,function*(){let n=t.build().to(e).apply(de.Data.ParseDsn6,{},{state:{isGhost:!0}}),o=n.apply(de.Volume.VolumeFromDsn6,{entryId:r?.entryId});return yield n.commit({revertOnError:!0}),yield LS(t,o.selector.data),{format:n.selector,volume:o.selector}}),visuals:XB},fIe={label:"DX",description:"DX",category:ib,stringExtensions:["dx"],binaryExtensions:["dxbin"],parse:(t,e,r)=>N(void 0,null,function*(){let o=t.build().to(e).apply(de.Data.ParseDx,{},{state:{isGhost:!0}}).apply(de.Volume.VolumeFromDx,{entryId:r?.entryId});return yield o.commit({revertOnError:!0}),yield LS(t,o.selector.data),{volume:o.selector}}),visuals:XB},hIe={label:"Cube",description:"Cube",category:ib,stringExtensions:["cub","cube"],parse:(t,e,r)=>N(void 0,null,function*(){let n=t.build().to(e).apply(de.Data.ParseCube,{},{state:{isGhost:!0}}),o=n.apply(de.Volume.VolumeFromCube,{entryId:r?.entryId}),i=n.apply(de.Model.TrajectoryFromCube,void 0,{state:{isGhost:!0}}).apply(de.Model.ModelFromTrajectory).apply(de.Model.StructureFromModel);return yield n.commit({revertOnError:!0}),yield LS(t,o.selector.data),{format:n.selector,volume:o.selector,structure:i.selector}}),visuals:(t,e)=>N(void 0,null,function*(){var r,n;let o=t.build(),i=[],a=(n=(r=e.volume.cell)===null||r===void 0?void 0:r.obj)===null||n===void 0?void 0:n.data;if(a&&xe.isOrbitals(a)){let c=o.to(e.volume).apply(de.Representation.VolumeRepresentation3D,Bp(t,a,{type:"isosurface",typeParams:{isoValue:xe.IsoValue.relative(1),alpha:.4},color:"uniform",colorParams:{value:ut.blue}})),u=o.to(e.volume).apply(de.Representation.VolumeRepresentation3D,Bp(t,a,{type:"isosurface",typeParams:{isoValue:xe.IsoValue.relative(-1),alpha:.4},color:"uniform",colorParams:{value:ut.red}}));i.push(c.selector,u.selector)}else{let c=o.to(e.volume).apply(de.Representation.VolumeRepresentation3D,Bp(t,a,{type:"isosurface",typeParams:{isoValue:xe.IsoValue.relative(2),alpha:.4},color:"uniform",colorParams:{value:ut.grey}}));i.push(c.selector)}let s=yield t.builders.structure.representation.applyPreset(e.structure,"auto");yield o.commit();let l=[];return ro(s?.representations,c=>{c&&l.push(c)}),[...i,...l]})},gIe={label:"DensityServer CIF",description:"DensityServer CIF",category:ib,stringExtensions:["cif"],binaryExtensions:["bcif"],isApplicable:(t,e)=>Kv(t,e)==="dscif",parse:(t,e,r)=>N(void 0,null,function*(){var n;let o=yield t.build().to(e).apply(de.Data.ParseCif).commit(),i=t.build().to(o),a=o.obj.data.blocks;if(a.length===0)throw new Error("no data blocks");let s=[],l=0;for(let c of a){if(c.header.toUpperCase()==="SERVER")continue;let u=Array.isArray(r?.entryId)?r?.entryId[l]:r?.entryId;((n=c.categories.volume_data_3d_info)===null||n===void 0?void 0:n.rowCount)>0&&(s.push(i.apply(de.Volume.VolumeFromDensityServerCif,{blockHeader:c.header,entryId:u}).selector),l++)}yield i.commit();for(let c of s)yield LS(t,c.data);return{volumes:s}}),visuals:(t,e)=>N(void 0,null,function*(){let{volumes:r}=e,n=t.build(),o=[];if(r.length>0){let i=r[0].data&&nee(r[0].data)||xe.IsoValue.relative(1.5);o[0]=n.to(r[0]).apply(de.Representation.VolumeRepresentation3D,hu.getDefaultParamsStatic(t,"isosurface",{isoValue:i,alpha:1},"uniform",{value:ut.teal})).selector}if(r.length>1){let i=hu.getDefaultParamsStatic(t,"isosurface",{isoValue:xe.IsoValue.relative(3),alpha:.3},"uniform",{value:ut.green}),a=hu.getDefaultParamsStatic(t,"isosurface",{isoValue:xe.IsoValue.relative(-3),alpha:.3},"uniform",{value:ut.red});o[o.length]=n.to(r[1]).apply(de.Representation.VolumeRepresentation3D,i).selector,o[o.length]=n.to(r[1]).apply(de.Representation.VolumeRepresentation3D,a).selector}return yield n.commit(),o})},yIe={label:"Segmentation CIF",description:"Segmentation CIF",category:ib,stringExtensions:["cif"],binaryExtensions:["bcif"],isApplicable:(t,e)=>Kv(t,e)==="segcif",parse:(t,e)=>N(void 0,null,function*(){var r;let n=yield t.build().to(e).apply(de.Data.ParseCif).commit(),o=t.build().to(n),i=n.obj.data.blocks;if(i.length===0)throw new Error("no data blocks");let a=[];for(let s of i)s.header.toUpperCase()!=="SERVER"&&((r=s.categories.volume_data_3d_info)===null||r===void 0?void 0:r.rowCount)>0&&a.push(o.apply(de.Volume.VolumeFromSegmentationCif,{blockHeader:s.header}).selector);return yield o.commit(),{volumes:a}}),visuals:(t,e)=>N(void 0,null,function*(){let{volumes:r}=e,n=t.build(),o=[];return r.length>0&&xe.Segmentation.get(r[0].data)&&(o[o.length]=n.to(r[0]).apply(de.Representation.VolumeRepresentation3D,hu.getDefaultParams(t,"segment",r[0].data,{alpha:1,instanceGranularity:!0},"volume-segment",{})).selector),yield n.commit(),o})},oee=[["ccp4",mIe],["dsn6",pIe],["cube",hIe],["dx",fIe],["dscif",gIe],["segcif",yIe]];var vIe="Shape",bIe={label:"PLY",description:"PLY",category:vIe,stringExtensions:["ply"],parse:(t,e)=>N(void 0,null,function*(){let r=t.state.data.build().to(e).apply(de.Data.ParsePly,{},{state:{isGhost:!0}}),n=r.apply(de.Model.ShapeFromPly);return yield r.commit(),{format:r.selector,shape:n.selector}}),visuals(t,e){return t.state.data.build().to(e.shape).apply(de.Representation.ShapeRepresentation3D).commit()}},iee=[["ply",bIe]];var IP=class{get types(){return this._list.map(e=>[e.name,e.provider.label])}get extensions(){if(this._extensions)return this._extensions;let e=new Set;return this._list.forEach(({provider:r})=>{var n,o;(n=r.stringExtensions)===null||n===void 0||n.forEach(i=>e.add(i)),(o=r.binaryExtensions)===null||o===void 0||o.forEach(i=>e.add(i))}),this._extensions=e,e}get binaryExtensions(){if(this._binaryExtensions)return this._binaryExtensions;let e=new Set;return this._list.forEach(({provider:r})=>{var n;return(n=r.binaryExtensions)===null||n===void 0?void 0:n.forEach(o=>e.add(o))}),this._binaryExtensions=e,e}get options(){if(this._options)return this._options;let e=[];return this._list.forEach(({name:r,provider:n})=>e.push([r,n.label,n.category||""])),this._options=e,e}constructor(){this._list=[],this._map=new Map,this._extensions=void 0,this._binaryExtensions=void 0,this._options=void 0;for(let[e,r]of oee)this.add(e,r);for(let[e,r]of YZ)this.add(e,r);for(let[e,r]of QZ)this.add(e,r);for(let[e,r]of iee)this.add(e,r);for(let[e,r]of $_)this.add(e,r)}_clear(){this._extensions=void 0,this._binaryExtensions=void 0,this._options=void 0}add(e,r){this._clear(),this._list.push({name:e,provider:r}),this._map.set(e,r)}remove(e){this._clear(),this._list.splice(this._list.findIndex(r=>r.name===e),1),this._map.delete(e)}auto(e,r){var n,o;for(let i=0,a=this.list.length;i<a;++i){let s=this._list[i].provider,l=!1;if((!((n=s.binaryExtensions)===null||n===void 0)&&n.includes(e.ext)||!((o=s.stringExtensions)===null||o===void 0)&&o.includes(e.ext))&&(l=!0),l&&(!s.isApplicable||s.isApplicable(e,r.data)))return s}}get(e){if(this._map.has(e))return this._map.get(e);throw new Error(`unknown data format name '${e}'`)}get list(){return this._list}};var DP=class extends ji{get isEmpty(){return this._animations.length===0}get current(){return this._current}get animations(){return this._animations}triggerUpdate(){this.events.updated.next(void 0)}triggerApply(){this.events.applied.next(void 0)}getParams(){return this._params||(this._params={current:g.Select(this._animations[0]&&this._animations[0].name,this._animations.map(e=>[e.name,e.display.name]),{label:"Animation"})}),this._params}updateParams(e){if(this.isEmpty)return;this.updateState({params:w(w({},this.state.params),e)});let r=this.map.get(this.state.params.current),n=r.params(this.context);this._current={anim:r,params:n,paramValues:g.getDefaultValues(n),state:{},startedTime:-1,lastTime:0},this.triggerUpdate()}updateCurrentParams(e){this.isEmpty||(this._current.paramValues=w(w({},this._current.paramValues),e),this.triggerUpdate())}register(e){if(this.map.has(e.name)){this.context.log.error(`Animation '${e.name}' is already registered.`);return}this._params=void 0,this.map.set(e.name,e),this._animations.push(e),this._animations.length===1?this.updateParams({current:e.name}):this.triggerUpdate()}play(e,r){return N(this,null,function*(){yield this.stop(),this.map.has(e.name)||this.register(e),this.updateParams({current:e.name}),this.updateCurrentParams(r),yield this.start()})}tick(e,r,n){return N(this,null,function*(){this.currentTime=e,!this.isStopped&&(r||n?yield this.applyFrame(n):this.applyAsync())})}start(){return N(this,null,function*(){this.updateState({animationState:"playing"}),this.context.behaviors.state.isAnimating.value||this.context.behaviors.state.isAnimating.next(!0),this.triggerUpdate();let e=this._current.anim,r=this._current.anim.initialState(this._current.paramValues,this.context);if(e.setup){let n=yield e.setup(this._current.paramValues,r,this.context);n&&(r=n)}this._current.lastTime=0,this._current.startedTime=-1,this._current.state=r,this.isStopped=!1})}stop(){return N(this,null,function*(){if(this.isStopped=!0,this.state.animationState!=="stopped"){let e=this._current.anim;e.teardown&&(yield e.teardown(this._current.paramValues,this._current.state,this.context)),this.updateState({animationState:"stopped"}),this.triggerUpdate()}this.context.behaviors.state.isAnimating.value&&this.context.behaviors.state.isAnimating.next(!1)})}get isAnimating(){return this.state.animationState==="playing"}applyAsync(){return N(this,null,function*(){if(!this.isApplying){this.isApplying=!0;try{yield this.applyFrame()}finally{this.isApplying=!1}}})}applyFrame(e){return N(this,null,function*(){let r=this.currentTime;this._current.startedTime<0&&(this._current.startedTime=r);let n=yield this._current.anim.apply(this._current.state,{lastApplied:this._current.lastTime,current:r-this._current.startedTime,animation:e},{params:this._current.paramValues,plugin:this.context});n.kind==="finished"?this.stop():n.kind==="next"&&(this._current.state=n.state,this._current.lastTime=r-this._current.startedTime),this.triggerApply()})}getSnapshot(){return this.current?{state:this.state,current:{paramValues:this._current.paramValues,state:this._current.anim.stateSerialization?this._current.anim.stateSerialization.toJSON(this._current.state):this._current.state}}:{state:this.state}}setSnapshot(e){this.isEmpty||(this.updateState({animationState:e.state.animationState}),this.updateParams(e.state.params),e.current&&(this.current.paramValues=e.current.paramValues,this.current.state=this._current.anim.stateSerialization?this._current.anim.stateSerialization.fromJSON(e.current.state):e.current.state,this.triggerUpdate(),this.state.animationState==="playing"&&this.resume()))}resume(){return N(this,null,function*(){this._current.lastTime=0,this._current.startedTime=-1;let e=this._current.anim;this.context.behaviors.state.isAnimating.value||this.context.behaviors.state.isAnimating.next(!0),e.setup&&(yield e.setup(this._current.paramValues,this._current.state,this.context)),this.isStopped=!1})}constructor(e){super({params:{current:""},animationState:"stopped"}),this.context=e,this.map=new Map,this._animations=[],this.currentTime=0,this._params=void 0,this.events={updated:this.ev(),applied:this.ev()},this.isStopped=!0,this.isApplying=!1}};function aee(t,e,r){let n=r[0],o=r[1],i=r[2],a=-n*e[0]-o*e[1]-i*e[2],s=t[0],l=t[1],c=t[2];return(n*s+o*l+i*c+a)/Math.sqrt(n*n+o*o+i*i)}function xIe(t,e,r,n){let o=aee(t,e,n);return{aroundX:aee(t,e,r)<0,aroundY:o<0}}function see(t,e,r){if(!t.canvas3d)return;let{origin:n,dirA:o,dirB:i,dirC:a}=r.principalAxes.boxAxes,s=y.clone(o),l=y.clone(a);if(r.positionToFlip){let{aroundX:u,aroundY:d}=xIe(r.positionToFlip,n,s,i);u&&(y.negate(l,l),y.negate(s,s)),d&&y.negate(l,l)}let c=y.scale(y(),n,-100);return y.dot(c,s)<=0&&y.negate(l,l),y.dot(y.unitY,l)<=0&&y.negate(s,s),t.canvas3d.camera.getFocus(n,e,s,l,an.createDefaultSnapshot())}var SIe=3,Am={identity:Dt.create(1,0,0,0,1,0,0,0,1),rotX90:Dt.create(1,0,0,0,0,1,0,-1,0),rotY90:Dt.create(0,0,-1,0,1,0,1,0,0),rotZ90:Dt.create(0,1,0,-1,0,0,0,0,1),rotX270:Dt.create(1,0,0,0,0,-1,0,1,0),rotY270:Dt.create(0,0,1,0,1,0,-1,0,0),rotZ270:Dt.create(0,-1,0,1,0,0,0,0,1),rotX180:Dt.create(1,0,0,0,-1,0,0,0,-1),rotY180:Dt.create(-1,0,0,0,1,0,0,0,-1),rotZ180:Dt.create(-1,0,0,0,-1,0,0,0,1)};function lee(t,e){let r=TIe(t,SIe);return CIe(r,e)}function CIe(t,e){if(t.length===0)return console.warn("Skipping PCA, no atoms"),{rotation:Am.identity,origin:y.zero()};let r=ET.calculateMomentsAxes(t),n=ET.calculateNormalizedAxes(r),o=EIe(n.dirA,n.dirB,n.dirC);IIe(o);let i=e?wIe(o,e):_Ie(t,o,r.origin);return Dt.mul(o,i,o),{rotation:o,origin:n.origin}}function TIe(t,e){let r;return r=YB(t,{onlyTrace:!0}),r.length>=3*e||(r=YB(t,{skipHydrogens:!0,skipWater:!0}),r.length>=3*e)||(r=YB(t,{})),r}function YB(t,e){let{onlyTrace:r,skipHydrogens:n,skipWater:o}=e,{x:i,y:a,z:s,type_symbol:l,label_comp_id:c}=Ne.atom,u=[];for(let d of t){let m=z.Location.create(d);for(let p of d.units){m.unit=p;let h=r?p.polymerElements:p.elements;for(let f=0;f<h.length;f++)m.element=h[f],!(n&&l(m)==="H")&&(o&&c(m)==="HOH"||u.push(i(m),a(m),s(m)))}}return u}function wIe(t,e){let r=Am.identity,n=0,o=Dt();for(let i of[Am.identity,Am.rotX180,Am.rotY180,Am.rotZ180]){let a=Dt.innerProduct(Dt.mul(o,i,t),e);a>n&&(r=i,n=a)}return r}function _Ie(t,e,r){let n=y.create(Dt.getValue(e,0,0),Dt.getValue(e,0,1),Dt.getValue(e,0,2)),o=y.create(Dt.getValue(e,1,0),Dt.getValue(e,1,1),Dt.getValue(e,1,2)),i=y.create(Dt.getValue(e,2,0),Dt.getValue(e,2,1),Dt.getValue(e,2,2)),a=Math.floor(t.length/3),s=y(),l=0,c=0,u=0;for(let p=0;p<a;p++)y.fromArray(s,t,3*p),y.sub(s,s,r),l+=p*y.dot(s,n),c+=p*y.dot(s,o),u+=PIe(p,a)*y.dot(s,i);let d=u<0,m=d?l+c<0:l-c<0;return m&&d?Am.rotY180:d?Am.rotX180:m?Am.rotZ180:Am.identity}function PIe(t,e){let r=Math.floor(e/2);return t<r?e%2?r-t:r-t-1:t-r}function EIe(t,e,r){let n=Dt();return Dt.setValue(n,0,0,t[0]),Dt.setValue(n,0,1,t[1]),Dt.setValue(n,0,2,t[2]),Dt.setValue(n,1,0,e[0]),Dt.setValue(n,1,1,e[1]),Dt.setValue(n,1,2,e[2]),Dt.setValue(n,2,0,r[0]),Dt.setValue(n,2,1,r[1]),Dt.setValue(n,2,2,r[2]),n}function IIe(t){Dt.determinant(t)<0&&(Dt.setValue(t,2,0,-Dt.getValue(t,2,0)),Dt.setValue(t,2,1,-Dt.getValue(t,2,1)),Dt.setValue(t,2,2,-Dt.getValue(t,2,2)))}function QB(t,e){let r=Dt.invert(Dt(),e),n=y.distance(t.position,t.target),o=y.transformMat3(y(),y.create(0,0,n),r),i=y.transformMat3(y(),y.create(0,1,0),r),a=y.add(y(),t.target,o);return U(w({},t),{position:a,up:i})}var DIe={minRadius:5,extraRadius:4,durationMs:250},AP=class{transformedLoci(e){var r,n;if(z.Loci.is(e)){let o=(n=(r=this.plugin.helpers.substructureParent.get(e.structure))===null||r===void 0?void 0:r.obj)===null||n===void 0?void 0:n.data;o&&(e=z.Loci.remap(e,o))}return e}focusRenderObjects(e,r){if(!e)return;let n=[];for(let o of e){let i=o.values.boundingSphere.ref.value;i.radius!==0&&n.push(i)}this.focusSpheres(n,o=>o,r)}focusLoci(e,r){let n;if(Array.isArray(e)&&e.length>1){let o=[];for(let i of e){let a=st.getBoundingSphere(this.transformedLoci(i));a&&o.push(a)}if(o.length===0)return;this.boundaryHelper.reset();for(let i of o)this.boundaryHelper.includeSphere(i);this.boundaryHelper.finishedIncludeStep();for(let i of o)this.boundaryHelper.radiusSphere(i);n=this.boundaryHelper.getSphere()}else if(Array.isArray(e)){if(e.length===0)return;n=st.getBoundingSphere(this.transformedLoci(e[0]))}else n=st.getBoundingSphere(this.transformedLoci(e));n&&this.focusSphere(n,r)}focusSpheres(e,r,n){let o=[];for(let i of e){let a=r(i);a&&o.push(a)}if(o.length!==0){if(o.length===1)return this.focusSphere(o[0],n);this.boundaryHelper.reset();for(let i of o)this.boundaryHelper.includeSphere(i);this.boundaryHelper.finishedIncludeStep();for(let i of o)this.boundaryHelper.radiusSphere(i);this.focusSphere(this.boundaryHelper.getSphere(),n)}}focusSphere(e,r){var n;let{canvas3d:o}=this.plugin;if(!o)return;let{extraRadius:i,minRadius:a,durationMs:s}=w(w({},DIe),r),l=Math.max(e.radius+i,a);if(r?.principalAxes){let c=see(this.plugin,l,r);(n=this.plugin.canvas3d)===null||n===void 0||n.requestCameraReset({durationMs:s,snapshot:c})}else{let c=o.camera.getFocus(e.center,l);o.requestCameraReset({durationMs:s,snapshot:c})}}orientAxes(e,r){if(!this.plugin.canvas3d)return;e||(e=this.plugin.state.data.selectQ(s=>s.ofType(X.Molecule.Structure)).filter(s=>s.obj&&!s.transform.transformer.definition.isDecorator&&!s.obj.data.parent).map(s=>{var l;return(l=s.obj)===null||l===void 0?void 0:l.data}).filter(s=>!!s));let{rotation:n}=lee(e),o=QB(this.plugin.canvas3d.camera.getSnapshot(),n);this.setSnapshot(o,r)}resetAxes(e){if(!this.plugin.canvas3d)return;let r=QB(this.plugin.canvas3d.camera.getSnapshot(),Dt.Identity);this.setSnapshot(r,e)}setSnapshot(e,r){var n;(n=this.plugin.canvas3d)===null||n===void 0||n.requestCameraReset({snapshot:e,durationMs:r})}reset(e,r){var n;(n=this.plugin.canvas3d)===null||n===void 0||n.requestCameraReset({snapshot:e,durationMs:r})}constructor(e){this.plugin=e,this.boundaryHelper=new Zs("98")}};var Ih=class t extends ji{get props(){return w({},this.state.props)}setProps(e){let r=this.props,n=w(w({},this.state.props),e);lf(r,n)||(this.updateState({props:n}),this.lociSelects.setProps(n),this.lociHighlights.setProps(n),this.events.propsUpdated.next(void 0))}dispose(){super.dispose(),this.lociSelects.dispose(),this.lociHighlights.dispose()}constructor(e,r={}){super({props:w(w({},g.getDefaultValues(t.Params)),r)}),this.plugin=e,this._props=g.getDefaultValues(t.Params),this.events={propsUpdated:this.ev()},this.lociSelects=new t.LociSelectManager(e,this._props),this.lociHighlights=new t.LociHighlightManager(e,this._props)}};(function(t){t.Params={granularity:g.Select("residue",st.GranularityOptions,{label:"Picking Level",description:"Controls if selections are expanded upon picking to whole residues, chains, structures, instances, or left as atoms and coarse elements"})};class e{setProps(i){Object.assign(this.props,i)}addProvider(i){this.providers.push(i)}removeProvider(i){this.providers=this.providers.filter(a=>a!==i)}normalizedLoci(i,a,s=!1){let{loci:l,repr:c}=i,u=a?this.props.granularity:void 0;return{loci:st.normalize(l,u,s),repr:c}}mark(i,a,s=!1){if(!st.isEmpty(i.loci))for(let l of this.providers)l(i,a,s)}dispose(){this.providers.length=0,this.sel.dispose()}constructor(i,a={}){this.ctx=i,this.providers=[],this.props=g.getDefaultValues(t.Params),this.sel=i.managers.structure.selection,this.setProps(a)}}t.LociMarkManager=e;class r extends e{constructor(){super(...arguments),this.prev=[],this.clearHighlights=(i=!1)=>{for(let a of this.prev)this.mark(a,tt.RemoveHighlight,i);this.prev.length=0}}isHighlighted(i){for(let a of this.prev)if(rt.Loci.areEqual(a,i))return!0;return!1}addHighlight(i){this.mark(i,tt.Highlight),this.prev.push(i)}highlight(i,a=!0){let s=this.normalizedLoci(i,a);this.isHighlighted(s)||this.addHighlight(s)}highlightOnly(i,a=!0){let s=this.normalizedLoci(i,a);this.isHighlighted(s)||(st.isEmpty(s.loci)?this.clearHighlights():(this.clearHighlights(!0),this.addHighlight(s)))}highlightOnlyExtend(i,a=!0){let s=this.normalizedLoci(i,a);if(z.Loci.is(s.loci)){let l={loci:this.sel.tryGetRange(s.loci)||s.loci,repr:s.repr};this.isHighlighted(l)||(st.isEmpty(l.loci)?this.clearHighlights():(this.clearHighlights(!0),this.addHighlight(l)))}}dispose(){super.dispose(),this.prev.length=0}}t.LociHighlightManager=r;class n extends e{toggle(i,a=!0){if(st.isEmpty(i.loci))return;let s=this.normalizedLoci(i,a,!0);z.Loci.is(s.loci)?this.toggleSel(s):super.mark(s,tt.Toggle)}toggleExtend(i,a=!0){if(st.isEmpty(i.loci))return;let s=this.normalizedLoci(i,a,!0);if(z.Loci.is(s.loci)){let l=this.sel.tryGetRange(s.loci)||s.loci;this.toggleSel({loci:l,repr:s.repr})}}select(i,a=!0){let s=this.normalizedLoci(i,a,!0);z.Loci.is(s.loci)&&this.sel.modify("add",s.loci),this.mark(s,tt.Select)}selectJoin(i,a=!0){let s=this.normalizedLoci(i,a,!0);z.Loci.is(s.loci)&&this.sel.modify("intersect",s.loci),this.mark(s,tt.Select)}selectOnly(i,a=!0){let s=this.normalizedLoci(i,a,!0);z.Loci.is(s.loci)&&(this.mark({loci:ue.Loci(s.loci.structure),repr:s.repr},tt.Deselect),this.sel.modify("set",s.loci)),this.mark(s,tt.Select)}deselect(i,a=!0){let s=this.normalizedLoci(i,a,!0);z.Loci.is(s.loci)&&this.sel.modify("remove",s.loci),this.mark(s,tt.Deselect)}deselectAll(){this.sel.clear(),this.mark({loci:xf},tt.Deselect)}deselectAllOnEmpty(i){Wn(i.loci)&&this.deselectAll()}mark(i,a){let{loci:s}=i;if(!st.isEmpty(s))if(z.Loci.is(s)){let l=this.sel.getLoci(s.structure);super.mark({loci:ue.Loci(s.structure)},tt.Deselect,!st.isEmpty(l)),super.mark({loci:l},tt.Select)}else super.mark(i,a)}toggleSel(i){this.sel.has(i.loci)?(this.sel.modify("remove",i.loci),this.mark(i,tt.Deselect)):(this.sel.modify("add",i.loci),this.mark(i,tt.Select))}}t.LociSelectManager=n})(Ih||(Ih={}));var kP=class{clearProviders(){this.providers=[],this.isDirty=!0,this.showLabels()}addProvider(e){this.providers.push(e),this.providers.sort((r,n)=>(n.priority||0)-(r.priority||0)),this.isDirty=!0,this.showLabels()}removeProvider(e){this.providers=this.providers.filter(r=>r!==e),this.isDirty=!0,this.showLabels()}mark(e,r){let n=this.locis.findIndex(o=>rt.Loci.areEqual(e,o));n===-1&&r===tt.Highlight?(this.locis.push(e),this.isDirty=!0):n!==-1&&r===tt.RemoveHighlight&&(wg(this.locis,n),this.isDirty=!0)}showLabels(){this.ctx.behaviors.labels.highlight.next({labels:this.getLabels()})}getLabels(){if(this.isDirty){this.groupedLabels.clear(),this.labels.length=0;for(let e of this.providers)for(let r of this.locis){if(st.isEmpty(r.loci))continue;let n=e.label(r.loci,r.repr);if(n){let o=e.group?e.group(n):n.toString(),i=this.groupedLabels.get(o);i?i.push(n):this.groupedLabels.set(o,[n])}}this.labels.length=0,this.groupedLabels.forEach((e,r)=>{let n=e.length,o=n>1&&e[0]!==e[1]?r:e[0];this.labels.push(n===1?o:`${o} <small>|| \xD7 ${n}</small>`)}),this.isDirty=!1}return this.labels}constructor(e){this.ctx=e,this.providers=[],this.locis=[],this.isDirty=!1,this.labels=[],this.groupedLabels=new Map,e.managers.interactivity.lociHighlights.addProvider((r,n,o)=>{this.providers.length!==0&&(this.mark(r,n),o||this.showLabels())})}};var uee="overpaint-controls";function KB(t,e,r,n,o){return N(this,null,function*(){yield AIe(t,e,(i,a,s)=>N(this,null,function*(){if(o&&o.length>0&&!o.includes(a.params.values.type.name))return;let l=a.obj.data.sourceData,c=yield n(l.root);if(st.isEmpty(c)||Wn(c))return;let u={bundle:z.Bundle.fromLoci(c),color:r===-1?ce(0):r,clear:r===-1};if(s){let d=[...s.params.values.layers,u],m=cee(d,l);i.to(s).update(io.toBundle(m))}else{let d=cee([u],l);i.to(a.transform.ref).apply(de.Representation.OverpaintStructureRepresentation3DFromBundle,io.toBundle(d),{tags:uee})}}))})}function AIe(t,e,r){return N(this,null,function*(){let n=t.state.data,o=n.build();for(let i of e)for(let a of i.representations){let s=n.select(lt.Generators.ofTransformer(de.Representation.OverpaintStructureRepresentation3DFromBundle,a.cell.transform.ref).withTag(uee));yield r(o,a.cell,s[0])}return o.commit({doNotUpdateCurrent:!0})})}function cee(t,e){let r=io.ofBundle(t,e.root),n=io.merge(r);return io.filter(n,e)}var mee="clipping-controls";function pee(t,e,r,n,o){return N(this,null,function*(){yield kIe(t,e,(i,a,s)=>N(this,null,function*(){if(o&&o.length>0&&!o.includes(a.params.values.type.name))return;let l=a.obj.data.sourceData,c=yield n(l.root);if(st.isEmpty(c)||Wn(c))return;let u={bundle:z.Bundle.fromLoci(c),groups:r};if(s){let d=[...s.params.values.layers,u],m=dee(d,l);i.to(s).update(Xr.toBundle(m))}else{let d=dee([u],l);i.to(a.transform.ref).apply(de.Representation.ClippingStructureRepresentation3DFromBundle,Xr.toBundle(d),{tags:mee})}}))})}function kIe(t,e,r){return N(this,null,function*(){let n=t.state.data,o=n.build();for(let i of e)for(let a of i.representations){let s=n.select(lt.Generators.ofTransformer(de.Representation.ClippingStructureRepresentation3DFromBundle,a.cell.transform.ref).withTag(mee));yield r(o,a.cell,s[0])}return o.commit({doNotUpdateCurrent:!0})})}function dee(t,e){let r=Xr.ofBundle(t,e.root),n=Xr.merge(r);return Xr.filter(n,e)}var hee="transparency-controls";function gee(t,e,r,n,o){return N(this,null,function*(){yield MIe(t,e,(i,a,s)=>N(this,null,function*(){if(o&&o.length>0&&!o.includes(a.params.values.type.name))return;let l=a.obj.data.sourceData,c=yield n(l.root);if(st.isEmpty(c)||Wn(c))return;let u={bundle:z.Bundle.fromLoci(c),value:r};if(s){let d=[...s.params.values.layers,u],m=fee(d,l);i.to(s).update(Jo.toBundle(m))}else{let d=fee([u],l);i.to(a.transform.ref).apply(de.Representation.TransparencyStructureRepresentation3DFromBundle,Jo.toBundle(d),{tags:hee})}}))})}function MIe(t,e,r){return N(this,null,function*(){let n=t.state.data,o=n.build();for(let i of e)for(let a of i.representations){let s=n.select(lt.Generators.ofTransformer(de.Representation.TransparencyStructureRepresentation3DFromBundle,a.cell.transform.ref).withTag(hee));yield r(o,a.cell,s[0])}return o.commit({doNotUpdateCurrent:!0})})}function fee(t,e){let r=Jo.ofBundle(t,e.root),n=Jo.merge(r);return Jo.filter(n,e)}var vee="substance-controls";function $B(t,e,r,n,o){return N(this,null,function*(){yield RIe(t,e,(i,a,s)=>N(this,null,function*(){if(o&&o.length>0&&!o.includes(a.params.values.type.name))return;let l=a.obj.data.sourceData,c=yield n(l.root);if(st.isEmpty(c)||Wn(c))return;let u={bundle:z.Bundle.fromLoci(c),material:r??Qo(),clear:!r};if(s){let d=[...s.params.values.layers,u],m=yee(d,l);i.to(s).update(ei.toBundle(m))}else{let d=yee([u],l);i.to(a.transform.ref).apply(de.Representation.SubstanceStructureRepresentation3DFromBundle,ei.toBundle(d),{tags:vee})}}))})}function RIe(t,e,r){return N(this,null,function*(){let n=t.state.data,o=n.build();for(let i of e)for(let a of i.representations){let s=n.select(lt.Generators.ofTransformer(de.Representation.SubstanceStructureRepresentation3DFromBundle,a.cell.transform.ref).withTag(vee));yield r(o,a.cell,s[0])}return o.commit({doNotUpdateCurrent:!0})})}function yee(t,e){let r=ei.ofBundle(t,e.root),n=ei.merge(r);return ei.filter(n,e)}var xee="emissive-controls";function See(t,e,r,n,o){return N(this,null,function*(){yield LIe(t,e,(i,a,s)=>N(this,null,function*(){if(o&&o.length>0&&!o.includes(a.params.values.type.name))return;let l=a.obj.data.sourceData,c=yield n(l.root);if(st.isEmpty(c)||Wn(c))return;let u={bundle:z.Bundle.fromLoci(c),value:r};if(s){let d=[...s.params.values.layers,u],m=bee(d,l);i.to(s).update(ti.toBundle(m))}else{let d=bee([u],l);i.to(a.transform.ref).apply(de.Representation.EmissiveStructureRepresentation3DFromBundle,ti.toBundle(d),{tags:xee})}}))})}function LIe(t,e,r){return N(this,null,function*(){let n=t.state.data,o=n.build();for(let i of e)for(let a of i.representations){let s=n.select(lt.Generators.ofTransformer(de.Representation.EmissiveStructureRepresentation3DFromBundle,a.cell.transform.ref).withTag(xee));yield r(o,a.cell,s[0])}return o.commit({doNotUpdateCurrent:!0})})}function bee(t,e){let r=ti.ofBundle(t,e.root),n=ti.merge(r);return ti.filter(n,e)}var ql=class t extends ji{get currentStructures(){return this.plugin.managers.structure.hierarchy.selection.structures}get pivotStructure(){return this.currentStructures[0]}_setSnapshotState(e){this.updateState({options:e}),this.events.optionsUpdated.next(void 0)}setOptions(e){return N(this,null,function*(){let r=e.interactions!==this.state.options.interactions;this.updateState({options:e}),this.events.optionsUpdated.next(void 0);let n=this.dataState.build();for(let o of this.currentStructures)for(let i of o.components)this.updateReprParams(n,i);return this.plugin.dataTransaction(()=>N(this,null,function*(){yield n.commit(),yield this.plugin.state.updateBehavior(my,o=>{o.ignoreHydrogens=e.hydrogens!=="all",o.ignoreHydrogensVariant=e.hydrogens==="only-polar"?"non-polar":"all",o.ignoreLight=e.ignoreLight,o.material=e.materialStyle,o.clip=e.clipObjects}),r&&(yield this.updateInterationProps())}))})}updateReprParams(e,r){let{hydrogens:n,visualQuality:o,ignoreLight:i,materialStyle:a,clipObjects:s}=this.state.options,l=n!=="all",c=n==="only-polar"?"non-polar":"all";for(let u of r.representations){if(u.cell.transform.transformer!==Tv)continue;let d=u.cell.transform.params;(!!d.type.params.ignoreHydrogens!==l||d.type.params.ignoreHydrogensVariant!==c||d.type.params.quality!==o||d.type.params.ignoreLight!==i||!ep(d.type.params.material,a)||!g.areEqual(dd.Params,d.type.params.clip,s))&&e.to(u.cell).update(m=>{m.type.params.ignoreHydrogens=l,m.type.params.ignoreHydrogensVariant=c,m.type.params.quality=o,m.type.params.ignoreLight=i,m.type.params.material=a,m.type.params.clip=s})}}updateInterationProps(){return N(this,null,function*(){var e,r,n;for(let o of this.currentStructures){let i=Mn.getParams((e=o.cell.obj)===null||e===void 0?void 0:e.data);if(o.properties){let a=(r=o.properties.cell.transform.params)===null||r===void 0?void 0:r.properties[Mn.descriptor.name];if(g.areEqual(i,a,this.state.options.interactions))continue;yield this.dataState.build().to(o.properties.cell).update(s=>{s.properties[Mn.descriptor.name]=this.state.options.interactions}).commit()}else{let a=this.plugin.customStructureProperties.getParams((n=o.cell.obj)===null||n===void 0?void 0:n.data),s=g.getDefaultValues(a);if(g.areEqual(i,s.properties[Mn.descriptor.name],this.state.options.interactions))continue;s.properties[Mn.descriptor.name]=this.state.options.interactions,yield this.plugin.builders.structure.insertStructureProperties(o.cell,s)}}})}applyPreset(e,r,n){return this.plugin.dataTransaction(()=>N(this,null,function*(){for(let o of e){let i=yield this.plugin.builders.structure.representation.applyPreset(o.cell,r,n);yield this.syncPreset(o,i)}}),{canUndo:"Preset"})}syncPreset(e,r){if(!r||!r.components)return this.clearComponents([e]);let n=new Set;if(ro(r.components,s=>{s&&n.add(s.ref)}),r.representations&&ro(r.representations,s=>{s&&n.add(s.ref)}),n.size===0)return this.clearComponents([e]);let o=!1,i=this.dataState.build(),a=s=>{n.has(s.cell.transform.ref)||(o=!0,i.delete(s.cell))};for(let s of e.components){a(s);for(let l of s.representations)a(l);if(s.genericRepresentations)for(let l of s.genericRepresentations)a(l)}if(e.genericRepresentations)for(let s of e.genericRepresentations)a(s);if(o)return i.commit()}clear(e){return this.clearComponents(e)}selectThis(e){var r;let n=this.plugin.managers.structure.selection;n.clear();for(let o of e){let i=ue.toSubStructureElementLoci(o.structure.cell.obj.data,(r=o.cell.obj)===null||r===void 0?void 0:r.data);n.fromLoci("set",i)}}canBeModified(e){return this.plugin.builders.structure.isComponentTransform(e.cell)}modifyByCurrentSelection(e,r){return this.plugin.runTask(ie.create("Modify Component",n=>N(this,null,function*(){let o=this.dataState.build();for(let i of e){if(!this.canBeModified(i))continue;let a=this.plugin.managers.structure.selection.getStructure(i.structure.cell.obj.data);!a||a.elementCount===0||this.modifyComponent(o,i,a,r)}yield this.dataState.updateTree(o,{canUndo:"Modify Selection"}).runInContext(n)})))}toggleVisibility(e,r){if(e.length!==0)if(r){let n=e[0].representations.indexOf(r),o=!r.cell.state.isHidden;for(let i of e){let a=i.representations[n];a&&Id(this.dataState,a.cell.transform.ref,o)}}else{let n=!e[0].cell.state.isHidden;for(let o of e)Id(this.dataState,o.cell.transform.ref,n)}}removeRepresentations(e,r){if(e.length===0)return;let n=[];if(r){let o=e[0].representations.indexOf(r);if(o<0)return;for(let i of e)i.representations[o]&&n.push(i.representations[o])}else for(let o of e)for(let i of o.representations)n.push(i);return this.plugin.managers.structure.hierarchy.remove(n,!0)}updateRepresentations(e,r,n){if(e.length===0)return Promise.resolve();let o=e[0].representations.indexOf(r);if(o<0)return Promise.resolve();let i=this.dataState.build();for(let a of e){let s=a.representations[o];s&&s.cell.transform.transformer===r.cell.transform.transformer&&i.to(s.cell).update(n)}return i.commit({canUndo:"Update Representation"})}updateRepresentationsTheme(e,r){var n,o,i,a;if(e.length===0)return;let s=this.dataState.build();for(let l of e)for(let c of l.representations){let u=c.cell.transform.params,d=typeof r=="function"?r(l,c):r,m=d.color==="default"?dS(this.plugin,(n=l.structure.cell.obj)===null||n===void 0?void 0:n.data,u?.type.name):d.color?dS(this.plugin,(o=l.structure.cell.obj)===null||o===void 0?void 0:o.data,u?.type.name,d.color,d.colorParams):void 0,p=d.size==="default"?YL(this.plugin,(i=l.structure.cell.obj)===null||i===void 0?void 0:i.data,u?.type.name):d.color?YL(this.plugin,(a=l.structure.cell.obj)===null||a===void 0?void 0:a.data,u?.type.name,d.size,d.sizeParams):void 0;(m||p)&&s.to(c.cell).update(h=>{m&&(h.colorTheme=m),p&&(h.sizeTheme=p)})}return s.commit({canUndo:"Update Theme"})}addRepresentation(e,r){if(e.length===0)return;let{hydrogens:n,visualQuality:o,ignoreLight:i,materialStyle:a,clipObjects:s}=this.state.options,u={ignoreHydrogens:n!=="all",ignoreHydrogensVariant:n==="only-polar"?"non-polar":"all",quality:o,ignoreLight:i,material:a,clip:s};return this.plugin.dataTransaction(()=>N(this,null,function*(){for(let d of e)yield this.plugin.builders.structure.representation.addRepresentation(d.cell,{type:this.plugin.representation.structure.registry.get(r),typeParams:u})}),{canUndo:"Add Representation"})}tryFindComponent(e,r){if(e.components.length!==0)return this.plugin.runTask(ie.create("Find Component",n=>N(this,null,function*(){var o,i;let a=(o=e.cell.obj)===null||o===void 0?void 0:o.data;if(!a)return;let s=hn.unionStructure(yield r.getSelection(this.plugin,n,a));for(let l of e.components){let c=(i=l.cell.obj)===null||i===void 0?void 0:i.data;if(!(!c||!l.cell.parent)&&dU(s,c))return l.cell}})))}add(e,r){return N(this,null,function*(){return this.plugin.dataTransaction(()=>N(this,null,function*(){let n=r||this.currentStructures;if(n.length===0)return;let{hydrogens:o,visualQuality:i,ignoreLight:a,materialStyle:s,clipObjects:l}=this.state.options,d={ignoreHydrogens:o!=="all",ignoreHydrogensVariant:o==="only-polar"?"non-polar":"all",quality:i,ignoreLight:a,material:s,clip:l},m=vo.create22();for(let p of n){let h;e.options.checkExisting&&(h=yield this.tryFindComponent(p,e.selection)),h||(h=yield this.plugin.builders.structure.tryCreateComponentFromSelection(p.cell,e.selection,m,{label:e.options.label||(e.selection===Qn.current?"Custom Selection":"")})),!(e.representation==="none"||!h)&&(yield this.plugin.builders.structure.representation.addRepresentation(h,{type:this.plugin.representation.structure.registry.get(e.representation),typeParams:d}))}}),{canUndo:"Add Selection"})})}applyTheme(e,r){return N(this,null,function*(){return this.plugin.dataTransaction(n=>N(this,null,function*(){let o=r||this.currentStructures;if(o.length===0)return;let i=a=>N(this,null,function*(){return hn.toLociWithSourceUnits(yield e.selection.getSelection(this.plugin,n,a))});for(let a of o)if(e.action.name==="color"){let s=e.action.params;yield KB(this.plugin,a.components,s.color,i,e.representations)}else if(e.action.name==="resetColor")yield KB(this.plugin,a.components,-1,i,e.representations);else if(e.action.name==="transparency"){let s=e.action.params;yield gee(this.plugin,a.components,s.value,i,e.representations)}else if(e.action.name==="emissive"){let s=e.action.params;yield See(this.plugin,a.components,s.value,i,e.representations)}else if(e.action.name==="material"){let s=e.action.params;yield $B(this.plugin,a.components,s.material,i,e.representations)}else if(e.action.name==="resetMaterial")yield $B(this.plugin,a.components,void 0,i,e.representations);else if(e.action.name==="clipping"){let s=e.action.params;yield pee(this.plugin,a.components,Xr.Groups.fromNames(s.excludeGroups),i,e.representations)}}),{canUndo:"Apply Theme"})})}modifyComponent(e,r,n,o){var i,a,s;let l=(i=r.cell.obj)===null||i===void 0?void 0:i.data;if(!l||(o==="subtract"||o==="intersect")&&!mU(l,n))return;let c=(a=r.structure.cell.obj)===null||a===void 0?void 0:a.data,u=o==="union"?uU(c,[l,n]):o==="intersect"?pU(l,n):fU(l,n);if(u.elementCount===0)e.delete(r.cell.transform.ref);else{let m={type:{name:"bundle",params:z.Bundle.fromSubStructure(c,u)},nullIfEmpty:!0,label:(s=r.cell.obj)===null||s===void 0?void 0:s.label};e.to(r.cell).update(m)}}updateLabel(e,r){var n,o;let i={type:(n=e.cell.params)===null||n===void 0?void 0:n.values.type,nullIfEmpty:(o=e.cell.params)===null||o===void 0?void 0:o.values.nullIfEmpty,label:r};this.dataState.build().to(e.cell).update(i).commit()}get dataState(){return this.plugin.state.data}clearComponents(e){let r=this.dataState.build();for(let n of e)for(let o of n.components)r.delete(o.cell.transform.ref);return r.commit({canUndo:"Clear Selections"})}constructor(e){super({options:g.getDefaultValues(t.OptionsParams)}),this.plugin=e,this.events={optionsUpdated:this.ev()}}};(function(t){t.OptionsParams={hydrogens:g.Select("all",[["all","Show All"],["hide-all","Hide All"],["only-polar","Only Polar"]],{description:"Determine display of hydrogen atoms in representations"}),visualQuality:g.Select("auto",Qx,{description:"Control the visual/rendering quality of representations"}),ignoreLight:g.Boolean(!1,{description:"Ignore light for stylized rendering of representations"}),materialStyle:Qo.getParam(),clipObjects:g.Group(dd.Params),interactions:g.Group(Mn.defaultParams,{label:"Non-covalent Interactions"})};function e(i,a){let{options:s}=i.query.structure.registry;return a=w({pivot:i.managers.structure.component.pivotStructure,allowNone:!0,hideSelection:!1,checkExisting:!1},a),{selection:g.Select(s[1][0],s,{isHidden:a?.hideSelection}),representation:o(i,a?.pivot,a?.allowNone?[["none","< Create Later >"]]:[]),options:g.Group({label:g.Text(""),checkExisting:g.Boolean(!!a?.checkExisting,{help:()=>({description:"Checks if a selection with the specifield elements already exists to avoid creating duplicate components."})})})}}t.getAddParams=e;function r(i,a){let{options:s}=i.query.structure.registry;return{selection:g.Select(s[1][0],s,{isHidden:!1}),action:g.MappedStatic("color",{color:g.Group({color:g.Color(ut.blue,{isExpanded:!0})},{isFlat:!0}),resetColor:g.EmptyGroup({label:"Reset Color"}),transparency:g.Group({value:g.Numeric(.5,{min:0,max:1,step:.01})},{isFlat:!0}),emissive:g.Group({value:g.Numeric(.5,{min:0,max:1,step:.01})},{isFlat:!0}),material:g.Group({material:Qo.getParam({isFlat:!0})},{isFlat:!0}),resetMaterial:g.EmptyGroup({label:"Reset Material"}),clipping:g.Group({excludeGroups:g.MultiSelect([],g.objectToOptions(Xr.Groups.Names))},{isFlat:!0})}),representations:g.MultiSelect([],n(i,a),{emptyValue:"All"})}}t.getThemeParams=r;function n(i,a){var s,l;return!((s=a?.cell.obj)===null||s===void 0)&&s.data?i.representation.structure.registry.getApplicableTypes((l=a.cell.obj)===null||l===void 0?void 0:l.data):i.representation.structure.registry.types}t.getRepresentationTypes=n;function o(i,a,s,l){let c=[...s,...n(i,a)];return g.Select(c[0][0],c,{label:l})}})(ql||(ql={}));var BIe=8,MP=class extends ji{get current(){return this.state.current}get history(){return this.state.history}tryAddHistory(e){if(z.Loci.isEmpty(e.loci))return;let r=0,n;for(let o of this.state.history){if(z.Loci.areEqual(o.loci,e.loci)){n=o;break}r++}if(n){wg(this.state.history,r),this.state.history.unshift(e),this.events.historyUpdated.next(void 0);return}this.state.history.unshift(e),this.state.history.length>BIe&&this.state.history.pop(),this.events.historyUpdated.next(void 0)}set(e){this.tryAddHistory(e),(!this.state.current||!z.Loci.areEqual(this.state.current.loci,e.loci))&&(this.state.current=e,this.behaviors.current.next(e))}setFromLoci(e){let r=st.normalize(e);if(!z.Loci.is(r)||z.Loci.isEmpty(r)){this.clear();return}this.set({loci:r,label:fu(r,{reverse:!0,hidePrefix:!0,htmlStyling:!1})})}addFromLoci(e){let r=this.state.current&&z.Loci.is(e)&&e.structure===this.state.current.loci.structure?z.Loci.union(e,this.state.current.loci):e;this.setFromLoci(r)}clear(){this.state.current&&(this.state.current=void 0,this.behaviors.current.next(void 0))}getSnapshot(){if(!this.current)return{};let e=this.plugin.helpers.substructureParent.get(this.current.loci.structure),r=e?.transform.ref;return r?{current:{label:this.current.label,ref:r,bundle:z.Bundle.fromLoci(this.current.loci),category:this.current.category}}:{}}setSnapshot(e){var r,n;if(!e.current){this.clear();return}let{label:o,ref:i,bundle:a,category:s}=e.current,l=(n=(r=this.plugin.state.data.select(lt.Generators.byRef(i))[0])===null||r===void 0?void 0:r.obj)===null||n===void 0?void 0:n.data;if(!l)return;let c=z.Bundle.toLoci(a,l);this.set({label:o,loci:c,category:s})}constructor(e){super({history:[]}),this.plugin=e,this.events={historyUpdated:this.ev()},this.behaviors={current:this.ev.behavior(void 0)},e.state.data.events.object.removed.subscribe(({obj:n})=>{var o;if(!X.Molecule.Structure.is(n))return;((o=this.current)===null||o===void 0?void 0:o.loci.structure)===n.data&&this.clear();let i=[];for(let a of this.history)a.loci.structure===n.data&&i.push(a);i.length!==this.history.length&&(this.history.length=0,this.history.push(...i),this.events.historyUpdated.next(void 0))});let r=te();e.state.data.events.object.updated.subscribe(({oldData:n,obj:o,action:i})=>{var a;if(X.Molecule.Structure.is(o)&&n!==o.data&&i==="in-place"){let s=this.state.current,l=o.data;if(s&&s.loci.structure===n){let c=z.Loci.remap(s.loci,l);this.state.current=U(w({},s),{loci:c}),this.behaviors.current.next(this.state.current),st.getBoundingSphere(c,r);let u=(a=this.plugin.canvas3d)===null||a===void 0?void 0:a.camera,d=u.getTargetDistance(r.radius+4);(y.distance(u.target,r.center)>r.radius||d>u.viewport.height/u.zoom)&&this.plugin.managers.camera.focusSphere(r,{durationMs:0})}}})}};function Pee(t,e){let r=WIe(t,e||LP());return KIe(t.tree,r),e&&e.refs.forEach(YIe,r),{hierarchy:r.hierarchy,added:r.added,changed:r.changed}}function LP(){return{trajectories:[],models:[],structures:[],refs:new Map}}function OIe(t){return{kind:"trajectory",cell:t,version:t.transform.version,models:[]}}function Cee(t,e){return{kind:"model",cell:t,version:t.transform.version,trajectory:e,structures:[]}}function FIe(t,e){return{kind:"model-properties",cell:t,version:t.transform.version,model:e}}function NIe(t,e){return{kind:"model-unitcell",cell:t,version:t.transform.version,model:e}}function Tee(t,e){return{kind:"structure",cell:t,version:t.transform.version,model:e,components:[]}}function VIe(t,e){return{kind:"structure-properties",cell:t,version:t.transform.version,structure:e}}function zIe(t,e){return{kind:"structure-transform",cell:t,version:t.transform.version,structure:e}}function UIe(t,e){return{kind:"structure-volume-streaming",cell:t,version:t.transform.version,structure:e}}function GIe(t){return t.transform.tags?[...t.transform.tags].sort().join():t.transform.ref}function jIe(t,e){return{kind:"structure-component",cell:t,version:t.transform.version,structure:e,key:GIe(t),representations:[]}}function HIe(t,e){return{kind:"structure-representation",cell:t,version:t.transform.version,component:e}}function qIe(t,e){return{kind:"generic-representation",cell:t,version:t.transform.version,parent:e}}function WIe(t,e){return{state:t,oldHierarchy:e,hierarchy:LP(),changed:!1,added:new Set}}function ab(t,e,r,n,...o){let i=n(...o);r.push(i),t.hierarchy.refs.set(e.transform.ref,i);let a=t.oldHierarchy.refs.get(e.transform.ref);return a?a.version!==e.transform.version&&(t.changed=!0):(t.added.add(i.cell.transform.ref),t.changed=!0),i}function Sy(t,e,r,...n){let o=r(...n);t.hierarchy.refs.set(e.transform.ref,o);let i=t.oldHierarchy.refs.get(e.transform.ref);return i?i.version!==e.transform.version&&(t.changed=!0):(t.added.add(o.cell.transform.ref),t.changed=!0),o}function wee(t){return e=>t.is(e.obj)}function _ee(t,e){return(r,n)=>!e(n)&&t.is(r.obj)}function RP(t){return e=>e.transform.transformer===t}function Cy(){}var XIe=[[wee(X.Molecule.Trajectory),(t,e)=>{t.currentTrajectory=ab(t,e,t.hierarchy.trajectories,OIe,e)},t=>t.currentTrajectory=void 0],[_ee(X.Molecule.Model,t=>t.currentModel),(t,e)=>{t.currentTrajectory?t.currentModel=ab(t,e,t.currentTrajectory.models,Cee,e,t.currentTrajectory):t.currentModel=Sy(t,e,Cee,e),t.hierarchy.models.push(t.currentModel)},t=>t.currentModel=void 0],[RP(de.Model.CustomModelProperties),(t,e)=>{if(!t.currentModel)return!1;t.currentModel.properties=Sy(t,e,FIe,e,t.currentModel)},Cy],[RP(de.Representation.ModelUnitcell3D),(t,e)=>{if(!t.currentModel)return!1;t.currentModel.unitcell=Sy(t,e,NIe,e,t.currentModel)},Cy],[_ee(X.Molecule.Structure,t=>t.currentStructure),(t,e)=>{t.currentModel?t.currentStructure=ab(t,e,t.currentModel.structures,Tee,e,t.currentModel):t.currentStructure=Sy(t,e,Tee,e),t.hierarchy.structures.push(t.currentStructure)},t=>t.currentStructure=void 0],[RP(de.Model.CustomStructureProperties),(t,e)=>{if(!t.currentStructure)return!1;t.currentStructure.properties=Sy(t,e,VIe,e,t.currentStructure)},Cy],[RP(de.Model.TransformStructureConformation),(t,e)=>{if(!t.currentStructure)return!1;t.currentStructure.transform=Sy(t,e,zIe,e,t.currentStructure)},Cy],[wee(di),(t,e)=>(t.currentStructure&&(t.currentStructure.volumeStreaming=Sy(t,e,UIe,e,t.currentStructure)),!1),Cy],[(t,e)=>e.currentComponent||!e.currentStructure||t.transform.transformer.definition.isDecorator?!1:X.Molecule.Structure.is(t.obj),(t,e)=>{t.currentStructure&&(t.currentComponent=ab(t,e,t.currentStructure.components,jIe,e,t.currentStructure))},t=>t.currentComponent=void 0],[(t,e)=>!t.state.isGhost&&!!e.currentComponent&&X.Molecule.Structure.Representation3D.is(t.obj),(t,e)=>(t.currentComponent&&ab(t,e,t.currentComponent.representations,HIe,e,t.currentComponent),!1),Cy],[t=>!t.state.isGhost&&X.isRepresentation3D(t.obj),(t,e)=>{let r=t.currentComponent||t.currentStructure||t.currentModel;r&&(r.genericRepresentations||(r.genericRepresentations=[]),ab(t,e,r.genericRepresentations,qIe,e,r))},Cy]];function Eee(t){if(!t||!t?.parent||!t.parent.cells.has(t.transform.ref))return!1;let{obj:e}=t;return!(!e||e===Rr.Null||t.status!=="ok"&&t.status!=="error")}function YIe(t){let{cell:e}=t;Eee(e)||(this.changed=!0)}function QIe(t){Iee(this,this.tree.transforms.get(t))}function Iee(t,e){let{state:r}=t,n=r.state.cells.get(e.ref);if(!Eee(n))return;let o,i=!1;for(let[s,l,c]of XIe)if(s(n,r)){if(l(r,n)===!1){i=!0;break}o=c;break}if(i)return;let a=t.tree.children.get(e.ref);a&&a.size&&a.forEach(QIe,t),o&&o(r)}function KIe(t,e){let r={tree:t,state:e};return Iee(r,t.root),r.state}var km=class t extends Ed{get dataState(){return this.plugin.state.data}get currentComponentGroups(){return this._currentComponentGroups?this._currentComponentGroups:(this._currentComponentGroups=t.getComponentGroups(this.selection.structures),this._currentComponentGroups)}get seletionSet(){if(this._currentSelectionSet)return this._currentSelectionSet;this._currentSelectionSet=new Set;for(let e of this.selection.trajectories)this._currentSelectionSet.add(e.cell.transform.ref);for(let e of this.selection.models)this._currentSelectionSet.add(e.cell.transform.ref);for(let e of this.selection.structures)this._currentSelectionSet.add(e.cell.transform.ref);return this._currentSelectionSet}get current(){return this.sync(!1),this.state.hierarchy}get selection(){return this.sync(!1),this.state.selection}getStructuresWithSelection(){let e=this.plugin.managers.structure.hierarchy.current.structures,r=[];for(let n of e)this.plugin.managers.structure.selection.structureHasSelection(n)&&r.push(n);return r}findStructure(e){if(!e)return;let r=this.plugin.helpers.substructureParent.get(e);if(!r)return;let n=this.plugin.state.data.selectQ(o=>o.byValue(r).rootOfType(X.Molecule.Structure))[0];if(n)return this.behaviors.selection.value.structures.find(o=>o.cell===n)}syncCurrent(e,r){let n=this.seletionSet,o=[];for(let i of e){let a=i.cell.transform.ref;(n.has(a)||r.has(a))&&o.push(i)}return o.length===0?e.length>0?[e[0]]:[]:o}sync(e){if(!e&&this.dataState.inUpdate)return;if(this.state.syncedTree===this.dataState.tree){e&&!this.state.notified&&(this.state.notified=!0,this.behaviors.selection.next(w({hierarchy:this.state.hierarchy},this.state.selection)));return}this.state.syncedTree=this.dataState.tree;let r=Pee(this.plugin.state.data,this.current);if(!r.changed)return;let{hierarchy:n}=r,o=this.syncCurrent(n.trajectories,r.added),i=this.syncCurrent(n.models,r.added),a=this.syncCurrent(n.structures,r.added);this._currentComponentGroups=void 0,this._currentSelectionSet=void 0,this.state.hierarchy=n,this.state.selection.trajectories=o,this.state.selection.models=i,this.state.selection.structures=a,e?(this.state.notified=!0,this.behaviors.selection.next({hierarchy:n,trajectories:o,models:i,structures:a})):this.state.notified=!1}updateCurrent(e,r){let n=this.current,o=r==="add"?no.union(this.seletionSet,new Set(e.map(l=>l.cell.transform.ref))):no.difference(this.seletionSet,new Set(e.map(l=>l.cell.transform.ref))),i=[],a=[],s=[];for(let l of n.trajectories)o.has(l.cell.transform.ref)&&i.push(l);for(let l of n.models)o.has(l.cell.transform.ref)&&a.push(l);for(let l of n.structures)o.has(l.cell.transform.ref)&&s.push(l);this._currentComponentGroups=void 0,this._currentSelectionSet=void 0,this.state.selection.trajectories=i,this.state.selection.models=a,this.state.selection.structures=s,this.behaviors.selection.next({hierarchy:n,trajectories:i,models:a,structures:s})}remove(e,r){if(e.length===0)return;let n=this.plugin.state.data.build();for(let o of e)n.delete(typeof o=="string"?o:o.cell.transform.ref);return n.commit({canUndo:r?"Remove":!1})}toggleVisibility(e,r){if(e.length===0)return;let n=r!==void 0?r!=="show":!e[0].cell.state.isHidden;for(let o of e)Id(this.dataState,o.cell.transform.ref,n)}applyPreset(e,r,n){return this.plugin.dataTransaction(()=>N(this,null,function*(){for(let o of e)o.models.length>0&&(yield this.clearTrajectory(o)),yield this.plugin.builders.structure.hierarchy.applyPreset(o.cell,r,n)}))}updateStructure(e,r){return N(this,null,function*(){yield this.plugin.dataTransaction(()=>N(this,null,function*(){let n=Nn.getDecoratorRoot(this.dataState.tree,e.cell.transform.ref),o=this.dataState.tree.children.get(n).toArray();yield this.remove(o,!1),yield this.plugin.state.updateTransform(this.plugin.state.data,e.cell.transform.ref,r,"Structure Type"),yield this.plugin.builders.structure.representation.applyPreset(e.cell.transform.ref,"auto")}),{canUndo:"Structure Type"}),Re.Camera.Reset(this.plugin)})}clearTrajectory(e){let r=this.dataState.build();for(let n of e.models)r.delete(n.cell);return r.commit()}constructor(e){super(),this.plugin=e,this.state={syncedTree:this.dataState.tree,notified:!1,hierarchy:LP(),selection:{trajectories:[],models:[],structures:[]}},this.behaviors={selection:this.ev.behavior({hierarchy:this.current,trajectories:this.selection.trajectories,models:this.selection.models,structures:this.selection.structures})},this._currentComponentGroups=void 0,this._currentSelectionSet=void 0,this.subscribe(e.state.data.events.changed,r=>{r.inTransaction||e.behaviors.state.isAnimating.value||this.sync(!0)}),this.subscribe(e.behaviors.state.isAnimating,r=>{!r&&!e.behaviors.state.isUpdating.value&&this.sync(!0)})}};(function(t){function e(n){if(!n.length)return[];if(n.length===1)return n[0].components.map(a=>[a]);let o=[],i=new Map;for(let a of n)for(let s of a.components){let l=s.key;if(!l)continue;let c=i.get(l);c||(c=[],i.set(l,c),o.push(c)),c.push(s)}return o}t.getComponentGroups=e;function r(n){var o,i,a,s,l,c,u,d,m;let{structures:p}=n.managers.structure.hierarchy.selection;if(p.length===0)return"";if(p.length===1){let v=p[0],x=(o=v.cell.obj)===null||o===void 0?void 0:o.data;if(!x)return((i=v.cell.obj)===null||i===void 0?void 0:i.label)||"Structure";let S=x.models[0]||x.representativeModel||x.masterModel;if(!S)return((a=v.cell.obj)===null||a===void 0?void 0:a.label)||"Structure";let T=S.entryId;return!((l=(s=v.model)===null||s===void 0?void 0:s.trajectory)===null||l===void 0)&&l.models&&v.model.trajectory.models.length===1?T:v.model?`${(c=v.model.cell.obj)===null||c===void 0?void 0:c.label} | ${T}`:T}let h=p[0],f=(u=h?.model)===null||u===void 0?void 0:u.trajectory,b=!0;for(let v of p)if(((d=v?.model)===null||d===void 0?void 0:d.trajectory)!==f){b=!1;break}return b&&f?`${(m=f.cell.obj)===null||m===void 0?void 0:m.label} | ${p.length} structures`:`${p.length} structures`}t.getSelectedStructuresDescription=r})(km||(km={}));var ZB="measurement-group",BP="measurement-order-label",JB={distanceUnitLabel:g.Text("\u212B",{isEssential:!0}),textColor:v3.textColor},$Ie=g.getDefaultValues(JB),OP=class extends ji{stateUpdated(){this.behaviors.state.next(this.state)}getGroup(){let e=this.plugin.state.data,r=lt.findTagInSubtree(e.tree,kt.RootRef,ZB),n=this.plugin.state.data.build();return r?n.to(r):n.toRoot().group(de.Misc.CreateGroup,{label:"Measurements"},{tags:ZB})}setOptions(e){return N(this,null,function*(){this.updateState({options:e})&&this.stateUpdated();let r=this.plugin.state.data.build();for(let n of this.state.distances)r.to(n).update(o=>{o.unitLabel=e.distanceUnitLabel,o.textColor=e.textColor});for(let n of this.state.labels)r.to(n).update(o=>{o.textColor=e.textColor});for(let n of this.state.angles)r.to(n).update(o=>{o.textColor=e.textColor});for(let n of this.state.dihedrals)r.to(n).update(o=>{o.textColor=e.textColor});r.editInfo.count!==0&&(yield Re.State.Update(this.plugin,{state:this.plugin.state.data,tree:r,options:{doNotLogTiming:!0}}))})}addDistance(e,r,n){return N(this,null,function*(){let o=this.plugin.helpers.substructureParent.get(e.structure),i=this.plugin.helpers.substructureParent.get(r.structure);if(!o||!i)return;let a=[o.transform.ref];Mo(a,i.transform.ref);let l=this.getGroup().apply(de.Model.MultiStructureSelectionFromExpression,{selections:[{key:"a",groupId:"a",ref:o.transform.ref,expression:z.Loci.toExpression(e)},{key:"b",groupId:"b",ref:i.transform.ref,expression:z.Loci.toExpression(r)}],isTransitive:!0,label:"Distance"},{dependsOn:a,tags:n?.selectionTags}),c=l.apply(de.Representation.StructureSelectionsDistance3D,w(w(w({customText:n?.customText||"",unitLabel:this.state.options.distanceUnitLabel,textColor:this.state.options.textColor},n?.lineParams),n?.labelParams),n?.visualParams),{tags:n?.reprTags}),u=this.plugin.state.data;return yield Re.State.Update(this.plugin,{state:u,tree:c,options:{doNotLogTiming:!0}}),{selection:l.selector,representation:c.selector}})}addAngle(e,r,n,o){return N(this,null,function*(){let i=this.plugin.helpers.substructureParent.get(e.structure),a=this.plugin.helpers.substructureParent.get(r.structure),s=this.plugin.helpers.substructureParent.get(n.structure);if(!i||!a||!s)return;let l=[i.transform.ref];Mo(l,a.transform.ref),Mo(l,s.transform.ref);let u=this.getGroup().apply(de.Model.MultiStructureSelectionFromExpression,{selections:[{key:"a",ref:i.transform.ref,expression:z.Loci.toExpression(e)},{key:"b",ref:a.transform.ref,expression:z.Loci.toExpression(r)},{key:"c",ref:s.transform.ref,expression:z.Loci.toExpression(n)}],isTransitive:!0,label:"Angle"},{dependsOn:l,tags:o?.selectionTags}),d=u.apply(de.Representation.StructureSelectionsAngle3D,w(w(w({customText:o?.customText||"",textColor:this.state.options.textColor},o?.lineParams),o?.labelParams),o?.visualParams),{tags:o?.reprTags}),m=this.plugin.state.data;return yield Re.State.Update(this.plugin,{state:m,tree:d,options:{doNotLogTiming:!0}}),{selection:u.selector,representation:d.selector}})}addDihedral(e,r,n,o,i){return N(this,null,function*(){let a=this.plugin.helpers.substructureParent.get(e.structure),s=this.plugin.helpers.substructureParent.get(r.structure),l=this.plugin.helpers.substructureParent.get(n.structure),c=this.plugin.helpers.substructureParent.get(o.structure);if(!a||!s||!l||!c)return;let u=[a.transform.ref];Mo(u,s.transform.ref),Mo(u,l.transform.ref),Mo(u,c.transform.ref);let m=this.getGroup().apply(de.Model.MultiStructureSelectionFromExpression,{selections:[{key:"a",ref:a.transform.ref,expression:z.Loci.toExpression(e)},{key:"b",ref:s.transform.ref,expression:z.Loci.toExpression(r)},{key:"c",ref:l.transform.ref,expression:z.Loci.toExpression(n)},{key:"d",ref:c.transform.ref,expression:z.Loci.toExpression(o)}],isTransitive:!0,label:"Dihedral"},{dependsOn:u,tags:i?.selectionTags}),p=m.apply(de.Representation.StructureSelectionsDihedral3D,w(w(w({customText:i?.customText||"",textColor:this.state.options.textColor},i?.lineParams),i?.labelParams),i?.visualParams),{tags:i?.reprTags}),h=this.plugin.state.data;return yield Re.State.Update(this.plugin,{state:h,tree:p,options:{doNotLogTiming:!0}}),{selection:m.selector,representation:p.selector}})}addLabel(e,r){return N(this,null,function*(){let n=this.plugin.helpers.substructureParent.get(e.structure);if(!n)return;let o=[n.transform.ref],a=this.getGroup().apply(de.Model.MultiStructureSelectionFromExpression,{selections:[{key:"a",ref:n.transform.ref,expression:z.Loci.toExpression(e)}],isTransitive:!0,label:"Label"},{dependsOn:o,tags:r?.selectionTags}),s=a.apply(de.Representation.StructureSelectionsLabel3D,w(w({textColor:this.state.options.textColor},r?.labelParams),r?.visualParams),{tags:r?.reprTags}),l=this.plugin.state.data;return yield Re.State.Update(this.plugin,{state:l,tree:s,options:{doNotLogTiming:!0}}),{selection:a.selector,representation:s.selector}})}addOrientation(e){return N(this,null,function*(){let r=[],n=[];for(let l=0,c=e.length;l<c;++l){let u=e[l],d=this.plugin.helpers.substructureParent.get(u.structure);d&&(Mo(n,d.transform.ref),r.push({key:`l${l}`,ref:d.transform.ref,expression:z.Loci.toExpression(u)}))}if(r.length===0)return;let i=this.getGroup().apply(de.Model.MultiStructureSelectionFromExpression,{selections:r,isTransitive:!0,label:"Orientation"},{dependsOn:n}),a=i.apply(de.Representation.StructureSelectionsOrientation3D),s=this.plugin.state.data;return yield Re.State.Update(this.plugin,{state:s,tree:a,options:{doNotLogTiming:!0}}),{selection:i.selector,representation:a.selector}})}addPlane(e){return N(this,null,function*(){let r=[],n=[];for(let l=0,c=e.length;l<c;++l){let u=e[l],d=this.plugin.helpers.substructureParent.get(u.structure);d&&(Mo(n,d.transform.ref),r.push({key:`l${l}`,ref:d.transform.ref,expression:z.Loci.toExpression(u)}))}if(r.length===0)return;let o=this.getGroup(),i=o.apply(de.Model.MultiStructureSelectionFromExpression,{selections:r,isTransitive:!0,label:"Plane"},{dependsOn:n}),a=i.apply(de.Representation.StructureSelectionsPlane3D),s=this.plugin.state.data;return yield Re.State.Update(this.plugin,{state:s,tree:o,options:{doNotLogTiming:!0}}),{selection:i.selector,representation:a.selector}})}addOrderLabels(e){return N(this,null,function*(){let r=this.getGroup(),n=this.plugin.state.data.select(lt.Generators.ofType(X.Molecule.Structure.Selections).withTag(BP));for(let a of n)r.delete(a);let o=1;for(let a of e){let s=this.plugin.helpers.substructureParent.get(a.structure);if(!s)continue;let l=[s.transform.ref];r.apply(de.Model.MultiStructureSelectionFromExpression,{selections:[{key:"a",ref:s.transform.ref,expression:z.Loci.toExpression(a)}],isTransitive:!0,label:"Order"},{dependsOn:l,tags:BP}).apply(de.Representation.StructureSelectionsLabel3D,{textColor:ce.fromRgb(255,255,255),borderColor:ce.fromRgb(0,0,0),textSize:.33,borderWidth:.3,offsetZ:.75,customText:`${o++}`},{tags:BP})}let i=this.plugin.state.data;return yield Re.State.Update(this.plugin,{state:i,tree:r,options:{doNotLogTiming:!0}}),{representation:r.selector}})}getTransforms(e){let r=this.plugin.state.data,n=lt.findTagInSubtree(r.tree,kt.RootRef,ZB),o=n?r.select(lt.Generators.ofTransformer(e,n)):this._empty;return o.length===0?this._empty:o}sync(){let e=[];for(let n of this.getTransforms(de.Representation.StructureSelectionsLabel3D)){let o=n.obj.tags;(!o||!o.includes(BP))&&e.push(n)}this.updateState({labels:e,distances:this.getTransforms(de.Representation.StructureSelectionsDistance3D),angles:this.getTransforms(de.Representation.StructureSelectionsAngle3D),dihedrals:this.getTransforms(de.Representation.StructureSelectionsDihedral3D),orientations:this.getTransforms(de.Representation.StructureSelectionsOrientation3D),planes:this.getTransforms(de.Representation.StructureSelectionsPlane3D)})&&this.stateUpdated()}constructor(e){super({labels:[],distances:[],angles:[],dihedrals:[],orientations:[],planes:[],options:$Ie}),this.plugin=e,this.behaviors={state:this.ev.behavior(this.state)},this._empty=[],e.state.data.events.changed.subscribe(r=>{r.inTransaction||e.behaviors.state.isAnimating.value||this.sync()}),e.behaviors.state.isAnimating.subscribe(r=>{!r&&!e.behaviors.state.isUpdating.value&&this.sync()})}};var BS=new Zs("98"),ZIe=24,FP=class extends ji{get entries(){return this.state.entries}get additionsHistory(){return this.state.additionsHistory}get stats(){return this.state.stats?this.state.stats:(this.state.stats=this.calcStats(),this.state.stats)}getEntry(e){let r=this.plugin.helpers.substructureParent.get(e,!0);if(!r)return;let n=r.transform.ref;if(!this.entries.has(n)){let o=new OS(z.Loci(e,[]));return this.entries.set(n,o),o}return this.entries.get(n)}calcStats(){let e=0,r=0,n=z.Stats.create();this.entries.forEach(i=>{let{elements:a}=i.selection;if(a.length){e+=1;for(let s=0,l=a.length;s<l;++s)r+=we.size(a[s].indices);z.Stats.add(n,n,z.Stats.ofLoci(i.selection))}});let o=Qg(n,{countsOnly:!0});return{structureCount:e,elementCount:r,label:o}}add(e){if(!z.Loci.is(e))return!1;let r=this.getEntry(e.structure);if(!r)return!1;let n=r.selection;return r.selection=z.Loci.union(r.selection,e),this.tryAddHistory(e),this.referenceLoci=e,this.events.loci.add.next(e),!z.Loci.areEqual(n,r.selection)}remove(e){if(!z.Loci.is(e))return!1;let r=this.getEntry(e.structure);if(!r)return!1;let n=r.selection;return r.selection=z.Loci.subtract(r.selection,e),this.referenceLoci=e,this.events.loci.remove.next(e),!z.Loci.areEqual(n,r.selection)}intersect(e){if(!z.Loci.is(e))return!1;let r=this.getEntry(e.structure);if(!r)return!1;let n=r.selection;return r.selection=z.Loci.intersect(r.selection,e),this.referenceLoci=e,!z.Loci.areEqual(n,r.selection)}set(e){if(!z.Loci.is(e))return!1;let r=this.getEntry(e.structure);if(!r)return!1;let n=r.selection;return r.selection=e,this.tryAddHistory(e),this.referenceLoci=void 0,!z.Loci.areEqual(n,r.selection)}modifyHistory(e,r,n,o=!1){let i=this.additionsHistory,a=i.indexOf(e);if(a<0)return;let s;switch(r){case"remove":wg(i,a);break;case"up":s=a-1;break;case"down":s=a+1;break}if(s!==void 0){let l=n?Math.min(i.length,n):i.length;for(;;)if(s=s%l,s<0&&(s+=l),!o||i[a].loci.structure===i[s].loci.structure){let c=i[a];i[a]=i[s],i[s]=c;break}else s+=r==="up"?-1:1}this.events.additionsHistoryUpdated.next(void 0)}tryAddHistory(e){if(st.isEmpty(e))return;let r=0,n;for(let a of this.additionsHistory){if(st.areEqual(a.loci,e)){n=a;break}r++}if(n){wg(this.additionsHistory,r),this.additionsHistory.unshift(n),this.events.additionsHistoryUpdated.next(void 0);return}let o=z.Stats.ofLoci(e),i=Qg(o,{reverse:!0});this.additionsHistory.unshift({id:vo.create22(),loci:e,label:i}),this.additionsHistory.length>ZIe&&this.additionsHistory.pop(),this.events.additionsHistoryUpdated.next(void 0)}clearHistory(){this.state.additionsHistory.length!==0&&(this.state.additionsHistory=[],this.events.additionsHistoryUpdated.next(void 0))}clearHistoryForStructure(e){let r=[];for(let n of this.state.additionsHistory)n.loci.structure.root===e.root&&r.push(n);for(let n of r)this.modifyHistory(n,"remove");r.length!==0&&this.events.additionsHistoryUpdated.next(void 0)}onRemove(e,r){var n;this.entries.has(e)&&(this.entries.delete(e),r?.data&&this.clearHistoryForStructure(r.data),((n=this.referenceLoci)===null||n===void 0?void 0:n.structure)===r?.data&&(this.referenceLoci=void 0),this.state.stats=void 0,this.events.changed.next(void 0))}onUpdate(e,r,n){var o,i,a,s;if(r===n||r?.data===n.data)return;let l=this.plugin.helpers.substructureParent.get(n.data,!0);if(!l||e!==l.transform.ref||!this.entries.has(e))return;let c=(i=(o=this.plugin.helpers.substructureParent.get(n.data))===null||o===void 0?void 0:o.obj)===null||i===void 0?void 0:i.data;if(c)if(!r?.data||ue.areUnitIdsAndIndicesEqual(r.data,n.data)){this.entries.set(e,eDe(this.entries.get(e),c)),((a=this.referenceLoci)===null||a===void 0?void 0:a.structure.root)===c.root&&(this.referenceLoci=z.Loci.remap(this.referenceLoci,c));let u=!1;for(let d of this.state.additionsHistory)d.loci.structure.root===c.root&&(d.loci=z.Loci.remap(d.loci,c),u=!0);u&&this.events.additionsHistoryUpdated.next(void 0)}else this.entries.set(e,new OS(z.Loci(c,[]))),((s=this.referenceLoci)===null||s===void 0?void 0:s.structure.root)===c.root&&(this.referenceLoci=void 0),this.clearHistoryForStructure(c),this.state.stats=void 0,this.events.changed.next(void 0)}clear(){let e=this.entries.keys(),r=[];for(;;){let n=e.next();if(n.done)break;let o=this.entries.get(n.value);z.Loci.isEmpty(o.selection)||r.push(o.selection),o.selection=z.Loci(o.selection.structure,[])}return this.referenceLoci=void 0,this.state.stats=void 0,this.events.changed.next(void 0),this.events.loci.clear.next(void 0),this.clearHistory(),r}getLoci(e){let r=this.getEntry(e);return r?r.selection:St}getStructure(e){let r=this.getEntry(e);if(r)return r.structure}structureHasSelection(e){var r,n;let o=(n=(r=e.cell)===null||r===void 0?void 0:r.obj)===null||n===void 0?void 0:n.data;if(!o)return!1;let i=this.getEntry(o);return!!i&&!z.Loci.isEmpty(i.selection)}has(e){if(z.Loci.is(e)){let r=this.getEntry(e.structure);if(r)return z.Loci.isSubset(r.selection,e)}return!1}tryGetRange(e){if(!z.Loci.is(e)||e.elements.length!==1||!this.getEntry(e.structure))return;let n=e.elements[0];if(!n)return;let o=this.referenceLoci;if(!o||!z.Loci.is(o)||o.structure!==e.structure)return;let i;for(let a of o.elements)if(n.unit===a.unit){i=a;break}if(i&&n.unit===i.unit)return tDe(e.structure,i,n)}elementCount(){let e=0;return this.entries.forEach(r=>{e+=z.Loci.size(r.selection)}),e}getBoundary(){let e=y.create(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),r=y.create(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);BS.reset();let n=[];this.entries.forEach(o=>{let i=o.selection;z.Loci.isEmpty(i)||n.push(z.Loci.getBoundary(i))});for(let o=0,i=n.length;o<i;++o){let{box:a,sphere:s}=n[o];y.min(e,e,a.min),y.max(r,r,a.max),BS.includePositionRadius(s.center,s.radius)}BS.finishedIncludeStep();for(let o=0,i=n.length;o<i;++o){let{sphere:a}=n[o];BS.radiusPositionRadius(a.center,a.radius)}return{box:{min:e,max:r},sphere:BS.getSphere()}}getPrincipalAxes(){let e=Az(this.entries.values());return z.Loci.getPrincipalAxesMany(e.map(r=>r.selection))}modify(e,r){let n=!1;switch(e){case"add":n=this.add(r);break;case"remove":n=this.remove(r);break;case"intersect":n=this.intersect(r);break;case"set":n=this.set(r);break}n&&(this.state.stats=void 0,this.events.changed.next(void 0))}get applicableStructures(){return this.plugin.managers.structure.hierarchy.selection.structures.filter(e=>!!e.cell.obj).map(e=>e.cell.obj.data)}triggerInteraction(e,r,n=!0){switch(e){case"add":this.plugin.managers.interactivity.lociSelects.select({loci:r},n);break;case"remove":this.plugin.managers.interactivity.lociSelects.deselect({loci:r},n);break;case"intersect":this.plugin.managers.interactivity.lociSelects.selectJoin({loci:r},n);break;case"set":this.plugin.managers.interactivity.lociSelects.selectOnly({loci:r},n);break}}fromLoci(e,r,n=!0){this.triggerInteraction(e,r,n)}fromCompiledQuery(e,r,n=!0){for(let o of this.applicableStructures){let i=r(new fa(o));this.triggerInteraction(e,hn.toLociWithSourceUnits(i),n)}}fromSelectionQuery(e,r,n=!0){this.plugin.runTask(ie.create("Structure Selection",o=>N(this,null,function*(){for(let i of this.applicableStructures){let a=yield r.getSelection(this.plugin,o,i);this.triggerInteraction(e,hn.toLociWithSourceUnits(a),n)}})))}fromSelections(e){var r;let n=Fn.resolveAndCheck(this.plugin.state.data,e);if(!(!n||!n.obj)){if(!X.Molecule.Structure.Selections.is(n.obj)){console.warn("fromSelections applied to wrong object type.",n.obj);return}this.clear();for(let o of(r=n.obj)===null||r===void 0?void 0:r.data)this.fromLoci("set",o.loci)}}getSnapshot(){let e=[];return this.entries.forEach((r,n)=>{e.push({ref:n,bundle:z.Bundle.fromLoci(r.selection)})}),{entries:e}}setSnapshot(e){var r,n;this.entries.clear();for(let{ref:o,bundle:i}of e.entries){let a=(n=(r=this.plugin.state.data.select(lt.Generators.byRef(o))[0])===null||r===void 0?void 0:r.obj)===null||n===void 0?void 0:n.data;if(!a)continue;let s=z.Bundle.toLoci(i,a);this.fromLoci("set",s,!1)}}constructor(e){super({entries:new Map,additionsHistory:[],stats:JIe()}),this.plugin=e,this.events={changed:this.ev(),additionsHistoryUpdated:this.ev(),loci:{add:this.ev(),remove:this.ev(),clear:this.ev()}},e.helpers.substructureParent.events.removed.subscribe(r=>this.onRemove(r.ref,r.obj)),e.helpers.substructureParent.events.updated.subscribe(r=>this.onUpdate(r.ref,r.oldObj,r.obj))}};function JIe(){return{structureCount:0,elementCount:0,label:"Nothing Selected"}}var OS=class{get selection(){return this._selection}set selection(e){this._selection=e,this._structure=void 0}get structure(){return this._structure?this._structure:(st.isEmpty(this._selection)?this._structure=void 0:this._structure=z.Loci.toStructure(this._selection),this._structure)}constructor(e){this._structure=void 0,this._selection=e}};function eDe(t,e){return new OS(z.Loci.remap(t.selection,e))}function tDe(t,e,r){let n=Math.min(we.min(e.indices),we.min(r.indices)),o=Math.max(we.max(e.indices),we.max(r.indices));return z.Loci(t,[{unit:e.unit,indices:we.ofRange(n,o)}])}function Aee(t,e){let r=iDe(t,e||NP());return uDe(t.tree,r),e&&e.refs.forEach(lDe,r),{hierarchy:r.hierarchy,added:r.added,changed:r.changed}}function NP(){return{volumes:[],lazyVolumes:[],refs:new Map}}function rDe(t){return{kind:"volume",cell:t,version:t.transform.version,representations:[]}}function nDe(t){return{kind:"lazy-volume",cell:t,version:t.transform.version}}function oDe(t,e){return{kind:"volume-representation",cell:t,version:t.transform.version,volume:e}}function iDe(t,e){return{state:t,oldHierarchy:e,hierarchy:NP(),changed:!1,added:new Set}}function eO(t,e,r,n,...o){let i=n(...o);r.push(i),t.hierarchy.refs.set(e.transform.ref,i);let a=t.oldHierarchy.refs.get(e.transform.ref);return a?a.version!==e.transform.version&&(t.changed=!0):(t.added.add(i.cell.transform.ref),t.changed=!0),i}function aDe(t,e){return(r,n)=>!e(n)&&t.is(r.obj)}function Dee(){}var sDe=[[aDe(X.Volume.Data,t=>t.currentVolume),(t,e)=>{t.currentVolume=eO(t,e,t.hierarchy.volumes,rDe,e)},t=>t.currentVolume=void 0],[t=>X.Volume.Lazy.is(t.obj),(t,e)=>{eO(t,e,t.hierarchy.lazyVolumes,nDe,e)},Dee],[(t,e)=>!t.state.isGhost&&!!e.currentVolume&&X.Volume.Representation3D.is(t.obj),(t,e)=>(t.currentVolume&&eO(t,e,t.currentVolume.representations,oDe,e,t.currentVolume),!1),Dee]];function kee(t){if(!t||!t?.parent||!t.parent.cells.has(t.transform.ref))return!1;let{obj:e}=t;return!(!e||e===Rr.Null||t.status!=="ok"&&t.status!=="error")}function lDe(t){let{cell:e}=t;kee(e)||(this.changed=!0)}function cDe(t){Mee(this,this.tree.transforms.get(t))}function Mee(t,e){let{state:r}=t,n=r.state.cells.get(e.ref);if(!kee(n))return;let o,i=!1;for(let[s,l,c]of sDe)if(s(n,r)){if(l(r,n)===!1){i=!0;break}o=c;break}if(i)return;let a=t.tree.children.get(e.ref);a&&a.size&&a.forEach(cDe,t),o&&o(r)}function uDe(t,e){let r={tree:t,state:e};return Mee(r,t.root),r.state}var Dh=class extends Ed{get dataState(){return this.plugin.state.data}get current(){return this.sync(!1),this.state.hierarchy}get selection(){return this.sync(!1),this.state.selection}sync(e){if(!e&&this.dataState.inUpdate)return;if(this.state.syncedTree===this.dataState.tree){e&&!this.state.notified&&(this.state.notified=!0,this.behaviors.selection.next({hierarchy:this.state.hierarchy,volume:this.state.selection}));return}this.state.syncedTree=this.dataState.tree;let r=Aee(this.plugin.state.data,this.current);if(!r.changed)return;let{hierarchy:n}=r;this.state.hierarchy=n,this.state.selection?this.state.selection=n.refs.has(this.state.selection.cell.transform.ref)?n.refs.get(this.state.selection.cell.transform.ref):n.volumes[0]:this.state.selection=n.volumes[0],e?(this.state.notified=!0,this.behaviors.selection.next({hierarchy:n,volume:this.state.selection})):this.state.notified=!1}setCurrent(e){this.state.selection=e||this.state.hierarchy.volumes[0],this.behaviors.selection.next({hierarchy:this.state.hierarchy,volume:e||this.state.hierarchy.volumes[0]})}remove(e,r){if(e.length===0)return;let n=this.plugin.state.data.build();for(let o of e)n.delete(typeof o=="string"?o:o.cell.transform.ref);return n.commit({canUndo:r?"Remove":!1})}toggleVisibility(e,r){if(e.length===0)return;let n=r!==void 0?r!=="show":!e[0].cell.state.isHidden;for(let o of e)Id(this.dataState,o.cell.transform.ref,n)}addRepresentation(e,r){var n;return this.dataState.build().to(e.cell).apply(de.Representation.VolumeRepresentation3D,Bp(this.plugin,(n=e.cell.obj)===null||n===void 0?void 0:n.data,{type:r})).commit({canUndo:"Add Representation"})}constructor(e){super(),this.plugin=e,this.state={syncedTree:this.dataState.tree,notified:!1,hierarchy:NP(),selection:void 0},this.behaviors={selection:this.ev.behavior({hierarchy:this.current,volume:this.selection})},this.subscribe(e.state.data.events.changed,r=>{r.inTransaction||e.behaviors.state.isAnimating.value||this.sync(!0)}),this.subscribe(e.behaviors.state.isAnimating,r=>{!r&&!e.behaviors.state.isUpdating.value&&this.sync(!0)})}};(function(t){function e(r,n){var o,i;return!((o=n?.cell.obj)===null||o===void 0)&&o.data?r.representation.volume.registry.getApplicableTypes((i=n.cell.obj)===null||i===void 0?void 0:i.data):r.representation.volume.registry.types}t.getRepresentationTypes=e})(Dh||(Dh={}));var dDe=[["full","Full"],["collapsed","Collapsed"],["hidden","Hidden"]],tO=[["full","Full"],["hidden","Hidden"]],mDe={isExpanded:g.Boolean(!1),showControls:g.Boolean(!0),regionState:g.Group({left:g.Select("full",dDe),top:g.Select("full",tO),right:g.Select("full",tO),bottom:g.Select("full",tO)}),controlsDisplay:g.Value("outside",{isHidden:!0})},VP=class extends ji{updateProps(e){let r=!!this.state.isExpanded;this.updateState(e),this.root&&typeof e.isExpanded=="boolean"&&e.isExpanded!==r&&this.handleExpand(),this.events.updated.next(void 0)}setProps(e){this.updateState(e)}setRoot(e){this.root=e,this.state.isExpanded&&this.handleExpand()}getScrollElement(){return document.scrollingElement?document.scrollingElement:document.documentElement?document.documentElement:document.body}handleExpand(){try{let e=document.getElementsByTagName("body")[0],r=document.getElementsByTagName("head")[0];if(!e||!r||!this.root)return;if(this.state.isExpanded){let n=r.children,o=[],i=!1;for(let u=0;u<n.length;u++)n[u]===this.expandedViewport?i=!0:(n[u].name||"").toLowerCase()==="viewport"&&o.push(n[u]);for(let u of o)r.removeChild(u);i||r.appendChild(this.expandedViewport);let a=e.style,s=this.getScrollElement(),l=s.scrollLeft,c=s.scrollTop;this.rootState={top:a.top,bottom:a.bottom,right:a.right,left:a.left,scrollTop:c,scrollLeft:l,position:a.position,overflow:a.overflow,viewports:o,zIndex:this.root.style.zIndex,width:a.width,height:a.height,maxWidth:a.maxWidth,maxHeight:a.maxHeight,margin:a.margin,marginLeft:a.marginLeft,marginRight:a.marginRight,marginTop:a.marginTop,marginBottom:a.marginBottom},a.overflow="hidden",a.position="fixed",a.top="0",a.bottom="0",a.right="0",a.left="0",a.width="100%",a.height="100%",a.maxWidth="100%",a.maxHeight="100%",a.margin="0",a.marginLeft="0",a.marginRight="0",a.marginTop="0",a.marginBottom="0"}else{let n=r.children;for(let o=0;o<n.length;o++)if(n[o]===this.expandedViewport){r.removeChild(this.expandedViewport);break}if(this.rootState){let o=this.rootState;for(let s of o.viewports)r.appendChild(s);let i=e.style;i.top=o.top,i.bottom=o.bottom,i.left=o.left,i.right=o.right,i.width=o.width,i.height=o.height,i.maxWidth=o.maxWidth,i.maxHeight=o.maxHeight,i.margin=o.margin,i.marginLeft=o.marginLeft,i.marginRight=o.marginRight,i.marginTop=o.marginTop,i.marginBottom=o.marginBottom,i.position=o.position,i.overflow=o.overflow||"";let a=this.getScrollElement();a.scrollTop=o.scrollTop,a.scrollLeft=o.scrollLeft,this.rootState=void 0,this.root.style.zIndex=o.zIndex}}}catch(e){let r="Layout change error, you might have to reload the page.";this.context.log.error(r),console.error(r,e)}}constructor(e){super(w(w({},g.getDefaultValues(mDe)),e.spec.layout&&e.spec.layout.initial)),this.context=e,this.events={updated:this.ev()},this.rootState=void 0,Re.Layout.Update.subscribe(e,r=>this.updateProps(r.state)),typeof document<"u"&&(this.expandedViewport=document.createElement("meta"),this.expandedViewport.name="viewport",this.expandedViewport.content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0")}};var nO={includeTypes:g.MultiSelect(Tg(Pr.Names),g.objectToOptions(Pr.Names)),excludeTypes:g.MultiSelect([],g.objectToOptions(Pr.Names)),ignoreHydrogens:g.Boolean(!1),ignoreHydrogensVariant:g.Select("all",g.arrayToOptions(["all","non-polar"])),aromaticBonds:g.Boolean(!0,{description:"Display aromatic bonds with dashes"}),multipleBonds:g.Select("symmetric",g.arrayToOptions(["off","symmetric","offset"]))},E5t=g.getDefaultValues(nO),FS=U(w(w({},wc),nO),{adjustCylinderLength:g.Boolean(!1,{description:"Shorten cylinders to reduce overlap with spheres. Useful for for transparent bonds. Not working well with aromatic bonds."})}),I5t=g.getDefaultValues(FS),NS=w(w({},FL),nO),D5t=g.getDefaultValues(NS);function sb(t,e,r){return!Pr.is(t,r)||Pr.is(e,r)}function zP(t,e,r){let n=e.elements,o=e.bonds,{a:i,b:a,edgeProps:s}=o,{flags:l}=s,{ignoreHydrogens:c,ignoreHydrogensVariant:u,includeTypes:d,excludeTypes:m}=r,p=Pr.fromNames(d),h=Pr.fromNames(m),f=Pr.isAll(p)&&h===0,{child:b}=t,v=b?.unitMap.get(e.id);if(b&&!v)throw new Error("expected childUnit to exist if child exists");if(!(f&&!c&&!b))return x=>{let S=i[x],T=a[x];return v&&!tr.has(v.elements,n[S])||!f&&sb(p,h,l[x])?!0:c?!!(sl(t,e,n[S],u)||sl(t,e,n[T],u)):!1}}function UP(t,e){let r=t.interUnitBonds,{edges:n}=r,{ignoreHydrogens:o,ignoreHydrogensVariant:i,includeTypes:a,excludeTypes:s}=e,l=Pr.fromNames(a),c=Pr.fromNames(s),u=Pr.isAll(l)&&c===0,{child:d}=t;if(!(u&&!o&&!d))return m=>{if(d){let p=n[m],h=d.unitMap.get(p.unitA);if(!h)return!0;let b=t.unitMap.get(p.unitA).elements[p.indexA];if(!tr.has(h.elements,b))return!0}if(o){let p=n[m],h=t.unitMap.get(p.unitA),f=t.unitMap.get(p.unitB);if(sl(t,h,h.elements[p.indexA],i)||sl(t,f,f.elements[p.indexB],i))return!0}return!!(!u&&sb(l,c,n[m].props.flag))}}var Eu;(function(t){function e(n,o){let{group:i,structure:a}=n,s=i.units[0],l=Pe.isAtomic(s)?s.bonds.edgeCount*2:0,c=i.units.length,u=ze.Location(a,void 0,void 0,a,void 0,void 0),d=(m,p)=>{let h=i.units[p];return u.aUnit=h,u.bUnit=h,u.aIndex=h.bonds.a[m],u.bIndex=h.bonds.b[m],u};if(o?.includeLocation2){let m=ze.Location(a,void 0,void 0,a,void 0,void 0);return jt(l,c,1,d,!1,()=>!1,(h,f)=>{let b=i.units[f];return m.aUnit=b,m.bUnit=b,m.aIndex=b.bonds.b[h],m.bIndex=b.bonds.a[h],m})}return jt(l,c,1,d)}t.fromGroup=e;function r(n,o){let i=n.interUnitBonds.edgeCount,a=1,s=ze.Location(n,void 0,void 0,n,void 0,void 0),l=c=>{let u=n.interUnitBonds.edges[c];return s.aUnit=n.unitMap.get(u.unitA),s.aIndex=u.indexA,s.bUnit=n.unitMap.get(u.unitB),s.bIndex=u.indexB,s};if(o?.includeLocation2){let c=ze.Location(n,void 0,void 0,n,void 0,void 0);return jt(i,a,1,l,!0,()=>!1,d=>{let m=n.interUnitBonds.edges[d];return c.aUnit=n.unitMap.get(m.unitB),c.aIndex=m.indexB,c.bUnit=n.unitMap.get(m.unitA),c.bIndex=m.indexA,c})}return jt(i,a,1,l,!0)}t.fromStructure=r})(Eu||(Eu={}));function VS(t,e,r){let{objectId:n,instanceId:o,groupId:i}=t;if(r===n){let{structure:a,group:s}=e,l=s.units[o];if(Pe.isAtomic(l)){let{target:c}=a,u=l.bonds.a[i],d=l.bonds.b[i];return ze.Loci(c,[ze.Location(c,l,u,c,l,d),ze.Location(c,l,d,c,l,u)])}}return St}function zS(t,e,r,n){let o=!1;if(ze.isLoci(t)){let{structure:i,group:a}=e;if(!ue.areEquivalent(t.structure,i))return!1;let s=a.units[0];if(!Pe.isAtomic(s))return!1;let l=s.bonds.edgeCount*2;for(let c of t.bonds){if(c.aUnit!==c.bUnit)continue;let u=a.unitIndexMap.get(c.aUnit.id);if(u!==void 0){let d=s.bonds.getDirectedEdgeIndex(c.aIndex,c.bIndex);d!==-1&&r(Oe.ofSingleton(u*l+d))&&(o=!0)}}}else if(z.Loci.is(t)){let{structure:i,group:a}=e;if(!ue.areEquivalent(t.structure,i))return!1;let s=a.units[0];if(!Pe.isAtomic(s))return!1;let l=s.bonds.edgeCount*2;for(let c of t.elements){let u=a.unitIndexMap.get(c.unit.id);if(u!==void 0){let{offset:d,b:m}=s.bonds;we.forEach(c.indices,p=>{for(let h=d[p],f=d[p+1];h<f;h++)(!n||we.has(c.indices,m[h]))&&r(Oe.ofSingleton(u*l+h))&&(o=!0)})}}}return o}function US(t,e,r){let{objectId:n,groupId:o}=t;if(r===n){let{target:i}=e,a=e.interUnitBonds.edges[o],s=e.unitMap.get(a.unitA),l=e.unitMap.get(a.unitB);return ze.Loci(i,[ze.Location(i,s,a.indexA,i,l,a.indexB),ze.Location(i,l,a.indexB,i,s,a.indexA)])}return St}var rO=new Map;function GS(t,e,r,n){let o=!1;if(ze.isLoci(t)){if(!ue.areEquivalent(t.structure,e))return!1;for(let i of t.bonds){let a=e.interUnitBonds.getBondIndexFromLocation(i);a!==-1&&r(Oe.ofSingleton(a))&&(o=!0)}}else if(z.Loci.is(t)){if(!ue.areEquivalent(t.structure,e)||n&&t.elements.length===1)return!1;for(let i of t.elements)rO.set(i.unit.id,i.indices);for(let i of t.elements){let{unit:a}=i;Pe.isAtomic(a)&&e.interUnitBonds.getConnectedUnits(a.id).forEach(s=>{let l=rO.get(s.unitB);(!n||l)&&we.forEach(i.indices,c=>{s.connectedIndices.includes(c)&&s.getEdges(c).forEach(u=>{if(!n||l&&we.has(l,u.indexB)){let d=e.interUnitBonds.getEdgeIndex(c,a.id,u.indexB,s.unitB);r(Oe.ofSingleton(d))&&(o=!0)}})})})}rO.clear()}return o}var oO=Pr.is;function Ree(t,e,r,n){let o=t.elements,i=t.bonds,{edgeCount:a,a:s,b:l,edgeProps:c,offset:u}=i,{order:d,flags:m}=c,{sizeFactor:p,sizeAspectRatio:h,adjustCylinderLength:f,aromaticBonds:b,includeTypes:v,excludeTypes:x,multipleBonds:S}=n,T=S==="off",E=S==="symmetric",_=Pr.fromNames(v),D=Pr.fromNames(x),P=sb(_,D,32),A=y(),I=y(),k=t.conformation,M,R=z.Location.create(e,t),B=ze.Location(e,t,void 0,e,t,void 0),{child:F}=e;if(n.includeParent&&F){let j=F.unitMap.get(t.id);if(!j)throw new Error("expected childUnit to exist");M=O=>{let J=o[s[O]],$=o[l[O]];return tr.has(j.elements,J)&&!tr.has(j.elements,$)}}let G=j=>(B.aIndex=s[j],B.bIndex=l[j],r.size.size(B)*p),V=j=>(R.element=o[s[j]],r.size.size(R)*p),H=j=>(R.element=o[l[j]],r.size.size(R)*p),{elementRingIndices:Q,elementAromaticRingIndices:L}=t.rings,Y=b?t.resonance.delocalizedTriplets:void 0;return{linkCount:a*2,referencePosition:j=>{let O=s[j],J=l[j],$=Y?.getThirdElement(O,J);if($!==void 0)return k.invariantPosition(o[$],A);O>J&&([O,J]=[J,O]),u[O+1]-u[O]===1&&([O,J]=[J,O]);let ae=L.get(O)||Q.get(O),Z=0;for(let se=u[O],Me=u[O+1];se<Me;++se){let be=l[se];if(be!==J&&be!==O)if(ae){let _e=L.get(be)||Q.get(be);if(!_e)continue;let je=y0(ae,_e);je>Z&&(Z=je,k.invariantPosition(o[be],A))}else return k.invariantPosition(o[be],A)}return Z>0?A:null},position:(j,O,J)=>{if(k.invariantPosition(o[s[J]],j),k.invariantPosition(o[l[J]],O),f){let $=V(J),ae=H(J),Z=Math.min($,ae)*h,se=Math.sqrt(Math.max(0,$*$-Z*Z))-.05,Me=Math.sqrt(Math.max(0,ae*ae-Z*Z))-.05;if(se<=.01&&Me<=.01)return;y.normalize(I,y.sub(I,O,j)),y.scaleAndAdd(j,j,I,se),y.scaleAndAdd(O,O,I,-Me)}},style:j=>{let O=d[j],J=m[j];if(oO(J,2)||oO(J,4))return 1;if(O===3)return T?0:E?4:5;if(b){let $=s[j],ae=l[j],Z=L.get($),se=L.get(ae),Me=Z&&se?y0(Z,se):0;if(oO(J,16)||Me&&!P)return Me===2?8:7}return O!==2||T?0:E?2:3},radius:j=>G(j)*h,ignore:zP(e,t,n),stub:M}}function pDe(t,e,r,n,o,i){if(!Pe.isAtomic(e))return xo.createEmpty(i);if(!e.bonds.edgeCount)return xo.createEmpty(i);let{child:a}=r,s=a?.unitMap.get(e.id);if(a&&!s)return xo.createEmpty(i);let l=Ree(e,r,n,o),{cylinders:c,boundingSphere:u}=W_(t,l,o,i);if(u)c.setBoundingSphere(u);else if(c.cylinderCount>0){let d=te.expand(te(),(s??e).boundary.sphere,1*o.sizeFactor);c.setBoundingSphere(d)}return c}function fDe(t,e,r,n,o,i){if(!Pe.isAtomic(e))return Be.createEmpty(i);if(!e.bonds.edgeCount)return Be.createEmpty(i);let{child:a}=r,s=a?.unitMap.get(e.id);if(a&&!s)return Be.createEmpty(i);let l=Ree(e,r,n,o),{mesh:c,boundingSphere:u}=jl(t,l,o,i);if(u)c.setBoundingSphere(u);else if(c.triangleCount>0){let d=te.expand(te(),(s??e).boundary.sphere,1*o.sizeFactor);c.setBoundingSphere(d)}return c}var lb=U(w(w(w({},Gr),qv),FS),{sizeFactor:g.Numeric(.3,{min:0,max:10,step:.01}),sizeAspectRatio:g.Numeric(2/3,{min:0,max:3,step:.01}),tryUseImpostor:g.Boolean(!0),includeParent:g.Boolean(!1)});function GP(t,e,r,n){return r.tryUseImpostor&&n&&n.extensions.fragDepth?hDe(t):gDe(t)}function hDe(t){return Wv({defaultProps:g.getDefaultValues(lb),createGeometry:pDe,createLocationIterator:(e,r)=>Eu.fromGroup(e,{includeLocation2:r.colorMode==="interpolate"}),getLoci:VS,eachLocation:zS,setUpdateState:(e,r,n,o,i,a,s)=>{e.createGeometry=r.sizeFactor!==n.sizeFactor||r.sizeAspectRatio!==n.sizeAspectRatio||r.linkScale!==n.linkScale||r.linkSpacing!==n.linkSpacing||r.ignoreHydrogens!==n.ignoreHydrogens||r.ignoreHydrogensVariant!==n.ignoreHydrogensVariant||r.linkCap!==n.linkCap||r.aromaticScale!==n.aromaticScale||r.aromaticSpacing!==n.aromaticSpacing||r.aromaticDashCount!==n.aromaticDashCount||r.dashCount!==n.dashCount||r.dashScale!==n.dashScale||r.dashCap!==n.dashCap||r.stubCap!==n.stubCap||!gs(r.includeTypes,n.includeTypes)||!gs(r.excludeTypes,n.excludeTypes)||r.adjustCylinderLength!==n.adjustCylinderLength||r.aromaticBonds!==n.aromaticBonds||r.multipleBonds!==n.multipleBonds,r.colorMode!==n.colorMode&&(e.createGeometry=!0,e.updateTransform=!0,e.updateColor=!0);let l=a.group.units[0],c=s.group.units[0];Pe.isAtomic(l)&&Pe.isAtomic(c)&&(_g.areEqual(l.bonds,c.bonds)||(e.createGeometry=!0,e.updateTransform=!0,e.updateColor=!0,e.updateSize=!0))},mustRecreate:(e,r,n)=>!r.tryUseImpostor||!n},t)}function gDe(t){return rn({defaultProps:g.getDefaultValues(lb),createGeometry:fDe,createLocationIterator:e=>Eu.fromGroup(e),getLoci:VS,eachLocation:zS,setUpdateState:(e,r,n,o,i,a,s)=>{e.createGeometry=r.sizeFactor!==n.sizeFactor||r.sizeAspectRatio!==n.sizeAspectRatio||r.radialSegments!==n.radialSegments||r.linkScale!==n.linkScale||r.linkSpacing!==n.linkSpacing||r.ignoreHydrogens!==n.ignoreHydrogens||r.ignoreHydrogensVariant!==n.ignoreHydrogensVariant||r.linkCap!==n.linkCap||r.aromaticScale!==n.aromaticScale||r.aromaticSpacing!==n.aromaticSpacing||r.aromaticDashCount!==n.aromaticDashCount||r.dashCount!==n.dashCount||r.dashScale!==n.dashScale||r.dashCap!==n.dashCap||r.stubCap!==n.stubCap||!gs(r.includeTypes,n.includeTypes)||!gs(r.excludeTypes,n.excludeTypes)||r.adjustCylinderLength!==n.adjustCylinderLength||r.aromaticBonds!==n.aromaticBonds||r.multipleBonds!==n.multipleBonds;let l=a.group.units[0],c=s.group.units[0];Pe.isAtomic(l)&&Pe.isAtomic(c)&&(_g.areEqual(l.bonds,c.bonds)||(e.createGeometry=!0,e.updateTransform=!0,e.updateColor=!0,e.updateSize=!0))},mustRecreate:(e,r,n)=>r.tryUseImpostor&&!!n},t)}var iO=new ze.ElementBondIterator;function Lee(t,e,r,n){for(iO.setElement(e,r,n);iO.hasNext;){let o=iO.move();return o.otherUnit.conformation.position(o.otherUnit.elements[o.otherIndex],t),t}return null}var Bee=y();function Oee(t,e,r){let n=z.Location.create(t),o=ze.Location(t,void 0,void 0,t,void 0,void 0),i=t.interUnitBonds,{edgeCount:a,edges:s}=i,{sizeFactor:l,sizeAspectRatio:c,adjustCylinderLength:u,aromaticBonds:d,multipleBonds:m}=r,p=m==="off",h=m==="symmetric",f=y(),b,{child:v}=t;r.includeParent&&v&&(b=E=>{let _=s[E],D=v.unitMap.get(_.unitA),P=v.unitMap.get(_.unitB),I=t.unitMap.get(_.unitA).elements[_.indexA],M=t.unitMap.get(_.unitB).elements[_.indexB];return D&&tr.has(D.elements,I)&&(!P||!tr.has(P.elements,M))});let x=E=>{let _=s[E];return o.aUnit=t.unitMap.get(_.unitA),o.aIndex=_.indexA,o.bUnit=t.unitMap.get(_.unitB),o.bIndex=_.indexB,e.size.size(o)*l},S=E=>{let _=s[E];return n.unit=t.unitMap.get(_.unitA),n.element=n.unit.elements[_.indexA],e.size.size(n)*l},T=E=>{let _=s[E];return n.unit=t.unitMap.get(_.unitB),n.element=n.unit.elements[_.indexB],e.size.size(n)*l};return{linkCount:a,referencePosition:E=>{let _=s[E],D,P,A,I;if(_.unitA<_.unitB)D=t.unitMap.get(_.unitA),P=t.unitMap.get(_.unitB),A=_.indexA,I=_.indexB;else if(_.unitA>_.unitB)D=t.unitMap.get(_.unitB),P=t.unitMap.get(_.unitA),A=_.indexB,I=_.indexA;else throw new Error("same units in createInterUnitBondCylinderMesh");return Lee(Bee,t,D,A)||Lee(Bee,t,P,I)},position:(E,_,D)=>{let P=s[D],A=t.unitMap.get(P.unitA),I=t.unitMap.get(P.unitB);if(A.conformation.position(A.elements[P.indexA],E),I.conformation.position(I.elements[P.indexB],_),u){let k=S(D),M=T(D),R=Math.min(k,M)*c,B=Math.sqrt(Math.max(0,k*k-R*R))-.05,F=Math.sqrt(Math.max(0,M*M-R*R))-.05;if(B<=.01&&F<=.01)return;y.normalize(f,y.sub(f,_,E)),y.scaleAndAdd(E,E,f,B),y.scaleAndAdd(_,_,f,-F)}},style:E=>{let _=s[E].props.order,D=Wc.create(s[E].props.flag);return Pr.is(D,2)||Pr.is(D,4)?1:_===3?p?0:h?4:5:d&&Pr.is(D,16)?7:_!==2||p?0:h?2:3},radius:E=>x(E)*c,ignore:UP(t,r),stub:b}}function yDe(t,e,r,n,o){if(!e.interUnitBonds.edgeCount)return xo.createEmpty(o);let i=Oee(e,r,n),{cylinders:a,boundingSphere:s}=W_(t,i,n,o);if(s)a.setBoundingSphere(s);else if(a.cylinderCount>0){let{child:l}=e,c=te.expand(te(),(l??e).boundary.sphere,1*n.sizeFactor);a.setBoundingSphere(c)}return a}function vDe(t,e,r,n,o){if(!e.interUnitBonds.edgeCount)return Be.createEmpty(o);let i=Oee(e,r,n),{mesh:a,boundingSphere:s}=jl(t,i,n,o);if(s)a.setBoundingSphere(s);else if(a.triangleCount>0){let{child:l}=e,c=te.expand(te(),(l??e).boundary.sphere,1*n.sizeFactor);a.setBoundingSphere(c)}return a}var cb=U(w(w(w({},Tu),iZ),FS),{sizeFactor:g.Numeric(.3,{min:0,max:10,step:.01}),sizeAspectRatio:g.Numeric(2/3,{min:0,max:3,step:.01}),tryUseImpostor:g.Boolean(!0),includeParent:g.Boolean(!1)});function jP(t,e,r,n){return r.tryUseImpostor&&n&&n.extensions.fragDepth?bDe(t):xDe(t)}function bDe(t){return aZ({defaultProps:g.getDefaultValues(cb),createGeometry:yDe,createLocationIterator:(e,r)=>Eu.fromStructure(e,{includeLocation2:r.colorMode==="interpolate"}),getLoci:US,eachLocation:GS,setUpdateState:(e,r,n,o,i,a,s)=>{e.createGeometry=r.sizeFactor!==n.sizeFactor||r.sizeAspectRatio!==n.sizeAspectRatio||r.linkScale!==n.linkScale||r.linkSpacing!==n.linkSpacing||r.ignoreHydrogens!==n.ignoreHydrogens||r.ignoreHydrogensVariant!==n.ignoreHydrogensVariant||r.linkCap!==n.linkCap||r.aromaticScale!==n.aromaticScale||r.aromaticSpacing!==n.aromaticSpacing||r.aromaticDashCount!==n.aromaticDashCount||r.dashCount!==n.dashCount||r.dashScale!==n.dashScale||r.dashCap!==n.dashCap||r.stubCap!==n.stubCap||!gs(r.includeTypes,n.includeTypes)||!gs(r.excludeTypes,n.excludeTypes)||r.adjustCylinderLength!==n.adjustCylinderLength||r.multipleBonds!==n.multipleBonds,r.colorMode!==n.colorMode&&(e.createGeometry=!0,e.updateTransform=!0,e.updateColor=!0),a.interUnitBonds!==s.interUnitBonds&&(e.createGeometry=!0,e.updateTransform=!0,e.updateColor=!0,e.updateSize=!0)},mustRecreate:(e,r,n)=>!r.tryUseImpostor||!n},t)}function xDe(t){return Va({defaultProps:g.getDefaultValues(cb),createGeometry:vDe,createLocationIterator:e=>Eu.fromStructure(e),getLoci:US,eachLocation:GS,setUpdateState:(e,r,n,o,i,a,s)=>{e.createGeometry=r.sizeFactor!==n.sizeFactor||r.sizeAspectRatio!==n.sizeAspectRatio||r.radialSegments!==n.radialSegments||r.linkScale!==n.linkScale||r.linkSpacing!==n.linkSpacing||r.ignoreHydrogens!==n.ignoreHydrogens||r.ignoreHydrogensVariant!==n.ignoreHydrogensVariant||r.linkCap!==n.linkCap||r.aromaticScale!==n.aromaticScale||r.aromaticSpacing!==n.aromaticSpacing||r.aromaticDashCount!==n.aromaticDashCount||r.dashCount!==n.dashCount||r.dashScale!==n.dashScale||r.dashCap!==n.dashCap||r.stubCap!==n.stubCap||!gs(r.includeTypes,n.includeTypes)||!gs(r.excludeTypes,n.excludeTypes)||r.adjustCylinderLength!==n.adjustCylinderLength||r.multipleBonds!==n.multipleBonds,a.interUnitBonds!==s.interUnitBonds&&(e.createGeometry=!0,e.updateTransform=!0,e.updateColor=!0,e.updateSize=!0)},mustRecreate:(e,r,n)=>r.tryUseImpostor&&!!n},t)}var SDe=he.add3,CDe=he.add,Op;(function(t){function e(r=2048,n=1024,o){let i=he.create(Float32Array,3,n,o?o.centerBuffer.ref.value:r),a=he.create(Float32Array,1,n,o?o.groupBuffer.ref.value:r);return{add:(s,l,c,u)=>{SDe(i,s,l,c),CDe(a,u)},getSpheres:()=>{let s=he.compact(i,!0),l=he.compact(a,!0);return Ni.create(s,l,i.elementCount,o)}}}t.create=e})(Op||(Op={}));var ub=y.add;function Mm(t,e,r){let{ignoreHydrogens:n,ignoreHydrogensVariant:o,traceOnly:i}=r,a=Pe.isCoarse(e),{child:s}=t,l=s?.unitMap.get(e.id);if(s&&!l)throw new Error("expected childUnit to exist if child exists");if(!(!s&&!n&&!i))return c=>!!l&&!tr.has(l.elements,c)||!a&&n&&sl(t,e,c,o)||i&&!F_(e,c)}function Fee(t,e,r,n,o,i){let{child:a}=r,s=a?.unitMap.get(e.id);if(a&&!s)return Be.createEmpty(i);let{detail:l,sizeFactor:c,stride:u}=o,{elements:d,conformation:m}=e,p=d.length,h=p*Sd(l),f=Te.createState(h,h/2,i),b=y(),v=Mm(r,e,o),x=z.Location.create(r,e),S=n.size.size,T=y(),E=0,_=0;for(let I=0;I<p;I++){if(u&&I%u!==0||v&&v(d[I]))continue;m.invariantPosition(d[I],b),ub(T,T,b),_+=1,x.element=d[I];let k=S(x);k>E&&(E=k),f.currentGroup=I,Jt(f,b,k*c,l)}let D=i?te.clone(i.boundingSphere):void 0,P=Te.getMesh(f);if(_===0)return P;let A;return y.scale(T,T,1/_),D&&y.distance(T,D.center)/D.radius<.1?A=D:A=te.expand(te(),(s??e).boundary.sphere,E*c+.05),P.setBoundingSphere(A),P}function Nee(t,e,r,n,o,i){let{child:a}=r,s=a?.unitMap.get(e.id);if(a&&!s)return Ni.createEmpty(i);let{sizeFactor:l,stride:c}=o,{elements:u,conformation:d}=e,m=u.length,p=Op.create(m,m/2,i),h=y(),f=Mm(r,e,o),b=z.Location.create(r,e),v=n.size.size,x=y(),S=0,T=0;if(c&&c>1||f||n.size.granularity!=="uniform")for(let P=0;P<m;P++){if(c&&P%c!==0||f&&f(u[P]))continue;d.invariantPosition(u[P],h),p.add(h[0],h[1],h[2],P),ub(x,x,h),T+=1,b.element=u[P];let A=v(b);A>S&&(S=A)}else{for(let P=0;P<m;P++)d.invariantPosition(u[P],h),p.add(h[0],h[1],h[2],P),ub(x,x,h);T=m,S=v(b)}let E=i?te.clone(i.boundingSphere):void 0,_=p.getSpheres();if(T===0)return _;let D;return y.scale(x,x,1/T),E&&y.distance(x,E.center)/E.radius<.1?D=E:D=te.expand(te(),(s??e).boundary.sphere,S*l+.05),_.setBoundingSphere(D),_}function qi(t,e,r){let n=!1;if(!z.Loci.is(t))return!1;let{structure:o,group:i}=e;if(!ue.areEquivalent(t.structure,o))return!1;let a=i.elements.length,{unitIndexMap:s}=i;for(let l of t.elements){let c=s.get(l.unit.id);if(c!==void 0){let u=c*a;if(Oe.is(l.indices)){let d=u+Oe.start(l.indices),m=u+Oe.end(l.indices);r(Oe.ofBounds(d,m))&&(n=!0)}else for(let d=0,m=l.indices.length;d<m;d++){let p=l.indices[d],h=d+1;for(;h<m&&l.indices[h]===p;)h++;d=h-1;let f=l.indices[d];n=r(Oe.ofRange(u+p,u+f))||n}}}return n}function Wi(t,e,r){let{objectId:n,instanceId:o,groupId:i}=t;if(r===n){let{structure:a,group:s}=e,l=s.units[o],c=we.ofSingleton(i);return z.Loci(a.target,[{unit:l,indices:c}])}return St}function Vee(t,e,r,n,o){let{child:i}=e,{detail:a,sizeFactor:s,stride:l}=n,{getSerialIndex:c}=e.serialMapping,d=e.elementCount*Sd(a),m=Te.createState(d,d/2,o),p=r.size.size,h=y(),f=0,b=0;for(let T of e.units){let E=i?.unitMap.get(T.id);if(i&&!E)continue;let{elements:_,conformation:D}=T,P=_.length,A=y(),I=Mm(e,T,n),k=z.Location.create(e,T);for(let M=0;M<P;M++){let R=_[M];if(l&&M%l!==0||I&&I(R))continue;D.position(R,A),ub(h,h,A),b+=1,k.element=R;let B=p(k);B>f&&(f=B),m.currentGroup=c(T,R),Jt(m,A,B*s,a)}}let v=o?te.clone(o.boundingSphere):void 0,x=Te.getMesh(m);if(b===0)return x;let S;return y.scale(h,h,1/b),v&&y.distance(h,v.center)/v.radius<1?S=v:S=te.expand(te(),(i??e).boundary.sphere,f*s+.05),x.setBoundingSphere(S),x}function zee(t,e,r,n,o){let{child:i}=e,{sizeFactor:a,stride:s}=n,{getSerialIndex:l}=e.serialMapping,c=e.elementCount,u=Op.create(c,c/2,o),d=r.size.size,m=y(),p=0,h=0;for(let x of e.units){let S=i?.unitMap.get(x.id);if(i&&!S)return Ni.createEmpty(o);let{elements:T,conformation:E}=x,_=T.length,D=y(),P=Mm(e,x,n),A=z.Location.create(e,x);if(s&&s>1||P||r.size.granularity!=="uniform")for(let I=0;I<_;I++){let k=T[I];if(s&&I%s!==0||P&&P(k))continue;E.position(k,D),u.add(D[0],D[1],D[2],l(x,k)),ub(m,m,D),h+=1,A.element=k;let M=d(A);M>p&&(p=M)}else{for(let I=0;I<_;I++){let k=T[I];E.position(k,D),u.add(D[0],D[1],D[2],l(x,k)),ub(m,m,D)}h+=_,p=d(A)}}let f=o?te.clone(o.boundingSphere):void 0,b=u.getSpheres();if(h===0)return b;let v;return y.scale(m,m,1/h),f&&y.distance(m,f.center)/f.radius<1?v=f:v=te.expand(te(),(i??e).boundary.sphere,p*a+.05),b.setBoundingSphere(v),b}function Iu(t,e,r){let n=!1;if(!z.Loci.is(t)||!ue.areEquivalent(t.structure,e))return!1;let{cumulativeUnitElementCount:o}=e.serialMapping;for(let i of t.elements){let a=e.unitIndexMap.get(i.unit.id);if(a!==void 0)if(Oe.is(i.indices)){let s=o[a]+Oe.start(i.indices),l=o[a]+Oe.end(i.indices);r(Oe.ofBounds(s,l))&&(n=!0)}else for(let s=0,l=i.indices.length;s<l;s++){let c=o[a]+i.indices[s];r(Oe.ofSingleton(c))&&(n=!0)}}return n}function Du(t,e,r){let{objectId:n,groupId:o}=t;if(r===n){let{unitIndices:i,cumulativeUnitElementCount:a}=e.serialMapping,s=i[o],l=e.units[s],c=o-a[s],u=we.ofSingleton(c);return z.Loci(e,[{unit:l,indices:u}])}return St}var jn;(function(t){function e(n){let{group:o,structure:i}=n,a=o.elements.length,s=o.units.length,l=z.Location.create(i);return jt(a,s,1,(u,d)=>{let m=o.units[d];return l.unit=m,l.element=m.elements[u],l})}t.fromGroup=e;function r(n){let{units:o,elementCount:i}=n,a=i,s=1,{unitIndices:l,elementIndices:c}=n.serialMapping,u=z.Location.create(n);return jt(a,s,1,m=>(u.unit=o[l[m]],u.element=c[m],u),!0)}t.fromStructure=r})(jn||(jn={}));var Uee={sizeFactor:g.Numeric(1,{min:0,max:10,step:.1}),detail:g.Numeric(0,{min:0,max:3,step:1},ge.CustomQualityParamInfo),ignoreHydrogens:g.Boolean(!1),ignoreHydrogensVariant:g.Select("all",g.arrayToOptions(["all","non-polar"])),traceOnly:g.Boolean(!1),tryUseImpostor:g.Boolean(!0),stride:g.Numeric(1,{min:1,max:100,step:1})},db=w(w(w({},Gr),jv),Uee);function HP(t,e,r,n){return r.tryUseImpostor&&n&&n.extensions.fragDepth&&n.extensions.textureFloat?TDe(t):wDe(t)}function TDe(t){return Hv({defaultProps:g.getDefaultValues(db),createGeometry:Nee,createLocationIterator:jn.fromGroup,getLoci:Wi,eachLocation:qi,setUpdateState:(e,r,n)=>{e.createGeometry=r.ignoreHydrogens!==n.ignoreHydrogens||r.ignoreHydrogensVariant!==n.ignoreHydrogensVariant||r.traceOnly!==n.traceOnly||r.stride!==n.stride},mustRecreate:(e,r,n)=>!r.tryUseImpostor||!n},t)}function wDe(t){return rn({defaultProps:g.getDefaultValues(db),createGeometry:Fee,createLocationIterator:jn.fromGroup,getLoci:Wi,eachLocation:qi,setUpdateState:(e,r,n)=>{e.createGeometry=r.sizeFactor!==n.sizeFactor||r.detail!==n.detail||r.ignoreHydrogens!==n.ignoreHydrogens||r.ignoreHydrogensVariant!==n.ignoreHydrogensVariant||r.traceOnly!==n.traceOnly||r.stride!==n.stride},mustRecreate:(e,r,n)=>r.tryUseImpostor&&!!n},t)}var Gee=w(w(w({},Tu),nZ),Uee);function jee(t,e,r,n){return r.tryUseImpostor&&n&&n.extensions.fragDepth&&n.extensions.textureFloat?_De(t):PDe(t)}function _De(t){return oZ({defaultProps:g.getDefaultValues(Gee),createGeometry:zee,createLocationIterator:jn.fromStructure,getLoci:Du,eachLocation:Iu,setUpdateState:(e,r,n)=>{e.createGeometry=r.ignoreHydrogens!==n.ignoreHydrogens||r.ignoreHydrogensVariant!==n.ignoreHydrogensVariant||r.traceOnly!==n.traceOnly||r.stride!==n.stride},mustRecreate:(e,r,n)=>!r.tryUseImpostor||!n},t)}function PDe(t){return Va({defaultProps:g.getDefaultValues(Gee),createGeometry:Vee,createLocationIterator:jn.fromStructure,getLoci:Du,eachLocation:Iu,setUpdateState:(e,r,n)=>{e.createGeometry=r.sizeFactor!==n.sizeFactor||r.detail!==n.detail||r.ignoreHydrogens!==n.ignoreHydrogens||r.ignoreHydrogensVariant!==n.ignoreHydrogensVariant||r.traceOnly!==n.traceOnly||r.stride!==n.stride},mustRecreate:(e,r,n)=>r.tryUseImpostor&&!!n},t)}var Hee={"element-sphere":(t,e)=>Dr("Element sphere",t,e,HP),"intra-bond":(t,e)=>Dr("Intra-unit bond cylinder",t,e,GP),"inter-bond":(t,e)=>_o("Inter-unit bond cylinder",t,e,jP)},aO=U(w(w(U(w({},db),{traceOnly:g.Boolean(!1,{isHidden:!0})}),lb),cb),{includeParent:g.Boolean(!1),unitKinds:Ip(["atomic"]),sizeFactor:g.Numeric(.15,{min:.01,max:10,step:.01}),sizeAspectRatio:g.Numeric(2/3,{min:.01,max:3,step:.01}),visuals:g.MultiSelect(["element-sphere","intra-bond","inter-bond"],g.objectToOptions(Hee)),bumpFrequency:g.Numeric(0,{min:0,max:10,step:.1},ge.ShadingCategory)});function EDe(t,e){if(ue.getSize(e)>=ue.Size.Huge){let n=g.clone(aO);return n.visuals.defaultValue=["element-sphere","intra-bond"],n}else return aO}function IDe(t,e){return rt.createMulti("Ball & Stick",t,e,Qr,Hee)}var qee={name:"ball-and-stick",label:"Ball & Stick",description:"Displays atoms as spheres and bonds as cylinders.",factory:IDe,getParams:EDe,defaultValues:g.getDefaultValues(aO),defaultColorTheme:{name:"element-symbol"},defaultSizeTheme:{name:"physical"},isApplicable:t=>t.elementCount>0,getData:(t,e)=>e.includeParent?t.asParent():t,mustRecreate:(t,e)=>t.includeParent!==e.includeParent};function DDe(t,e,r,n,o){let{links:i,elements:a}=e.carbohydrates,{linkSizeFactor:s}=n,l=z.Location.create(e),c={linkCount:i.length,position:(m,p,h)=>{let f=i[h];y.copy(m,a[f.carbohydrateIndexA].geometry.center),y.copy(p,a[f.carbohydrateIndexB].geometry.center)},radius:m=>{let p=i[m],h=a[p.carbohydrateIndexA],f=h.unit.rings.all[h.ringIndex];return l.unit=h.unit,l.element=h.unit.elements[f[0]],r.size.size(l)*s}},{mesh:u,boundingSphere:d}=jl(t,c,n,o);if(d)u.setBoundingSphere(d);else if(u.triangleCount>0){let m=te.expand(te(),e.boundary.sphere,1*s);u.setBoundingSphere(m)}return u}var lO=U(w(w({},Gr),wc),{linkSizeFactor:g.Numeric(.3,{min:0,max:3,step:.01})});function Wee(t){return Va({defaultProps:g.getDefaultValues(lO),createGeometry:DDe,createLocationIterator:ADe,getLoci:kDe,eachLocation:MDe,setUpdateState:(e,r,n)=>{e.createGeometry=r.linkSizeFactor!==n.linkSizeFactor||r.radialSegments!==n.radialSegments||r.linkCap!==n.linkCap}},t)}function ADe(t){let{elements:e,links:r}=t.carbohydrates,n=r.length,o=1,i=z.Location.create(t);return jt(n,o,1,s=>{let l=r[s],c=e[l.carbohydrateIndexA],u=c.unit.rings.all[c.ringIndex];return i.unit=c.unit,i.element=c.unit.elements[u[0]],i},!0)}function kDe(t,e,r){let{objectId:n,groupId:o}=t;if(r===n){let{links:i,elements:a}=e.carbohydrates,s=i[o],l=a[s.carbohydrateIndexA],c=a[s.carbohydrateIndexB];return z.Loci.union(gh(e,l.unit,l.residueIndex,l.altId),gh(e,c.unit,c.residueIndex,c.altId))}return St}var sO=new Set;function MDe(t,e,r){let n=!1;if(!z.Loci.is(t)||!ue.areEquivalent(t.structure,e))return!1;let{getLinkIndices:o}=e.carbohydrates;for(let{unit:i,indices:a}of t.elements)Pe.isAtomic(i)&&(sO.clear(),we.forEach(a,s=>{let l=o(i,i.elements[s]);for(let c=0,u=l.length;c<u;++c)sO.has(l[c])||(sO.add(l[c]),r(Oe.ofSingleton(l[c]))&&(n=!0))}));return n}var RDe=y.create(0,0,-.5),LDe=y.create(0,0,.5),Ah=y(),kh=y(),qP=y(),Xee=y();function BDe(t){let e=t.length/3,n=(e===3?1:e===4?2:e)+e,o=e===4?e*3+4:n*3,i=pd(n,o);for(let a=0;a<e;++a){let s=(a+1)%e;y.set(Ah,t[a*3],t[a*3+1],-.5),y.set(kh,t[s*3],t[s*3+1],-.5),i.add(Ah,kh,LDe)}if(e===3)y.set(Ah,t[0],t[1],-.5),y.set(kh,t[3],t[4],-.5),y.set(qP,t[6],t[7],-.5),i.add(qP,kh,Ah);else if(e===4)y.set(Ah,t[0],t[1],-.5),y.set(kh,t[3],t[4],-.5),y.set(qP,t[6],t[7],-.5),y.set(Xee,t[9],t[10],-.5),i.addQuad(Xee,qP,kh,Ah);else for(let a=0;a<e;++a){let s=(a+1)%e;y.set(Ah,t[a*3],t[a*3+1],-.5),y.set(kh,t[s*3],t[s*3+1],-.5),i.add(RDe,kh,Ah)}return i.getPrimitive()}var cO;function Yee(){return cO||(cO=BDe(tl(8,!0))),cO}var uO;function Qee(){if(!uO){let t=tl(8,!0),e=new Float32Array(8*3+6);for(let n=0;n<8;++n)e[n*3]=t[n*3],e[n*3+1]=t[n*3+1],e[n*3+2]=-.5;e[8*3]=0,e[8*3+1]=0,e[8*3+2]=-.5,e[8*3+3]=0,e[8*3+4]=0,e[8*3+5]=.5,uO=Dg(e,[0,1,8,1,2,8,4,5,8,5,6,8,2,3,9,3,4,9,6,7,9,7,0,9])}return uO}var ODe={pointCount:5,outerRadius:1,innerRadius:.5,thickness:.3},dO=y.zero(),mO=y.zero(),pO=y.zero(),jS=y.zero(),fO=y.zero();function Kee(t){let{outerRadius:e,innerRadius:r,thickness:n,pointCount:o}=w(w({},ODe),t),i=o*2*2,a=pd(i),s=new Float32Array(o*2),l=new Float32Array(o*2);for(let c=0;c<o;++c){let u=c*2,d=c*2+1,m=(u+1)/o*Math.PI,p=(d+1)/o*Math.PI;l[u]=Math.cos(m)*e,l[d]=Math.sin(m)*e,s[u]=Math.cos(p)*r,s[d]=Math.sin(p)*r}y.set(dO,0,0,n/2),y.set(mO,0,0,-n/2);for(let c=0;c<o;++c){let u=(c+1)%o;y.set(pO,l[c*2],l[c*2+1],0),y.set(jS,s[c*2],s[c*2+1],0),y.set(fO,l[u*2],l[u*2+1],0),a.add(dO,pO,jS),a.add(jS,pO,mO),a.add(dO,jS,fO),a.add(fO,jS,mO)}return a.getPrimitive()}var yO=[.5,0,0,-.5,0,0,0,.5,0,0,-.5,0,0,0,.5,0,0,-.5],FDe=[0,2,4,0,4,3,0,3,5,0,5,2,1,2,5,1,5,3,1,3,4,1,4,2],NDe=[0,2,4,0,4,3,1,2,5,1,5,3],VDe=[0,2,1,3,2,1,3,0,0,4,1,4,2,4,3,4,0,5,1,5,2,5,3,5],hO;function $ee(){return hO||(hO=Dg(yO,FDe)),hO}var gO;function Zee(){return gO||(gO=Dg(yO,NDe)),gO}var fjt=am(yO,VDe);var Ct=W.identity(),Fp=y(),Jee=y(),zDe=2*.806,ete=M0(),tte=Qj(),UDe=Yee(),rte=Qee(),GDe=Kee({outerRadius:1,innerRadius:.5,thickness:.5,pointCount:5}),jDe=$ee(),nte=Zee(),ote=S7(),HDe=C7(),qDe=T7(),WDe=w7(),XDe=_7();function YDe(t,e,r,n,o){let i=Te.createState(256,128,o),{detail:a,sizeFactor:s}=n,l=e.carbohydrates,c=l.elements.length,u=z.Location.create(e);for(let d=0;d<c;++d){let m=l.elements[d],p=m.unit.rings.all[m.ringIndex],h=Uz(m.component.type,p.length);u.unit=m.unit,u.element=m.unit.elements[p[0]];let f=r.size.size(u),b=f*s,v=f*s*zDe,{center:x,normal:S,direction:T}=m.geometry;switch(y.add(Jee,x,T),W.targetTo(Ct,x,Jee,S),W.setTranslation(Ct,x),i.currentGroup=d*2,h){case es.FilledSphere:Jt(i,x,b,a);break;case es.FilledCube:W.scaleUniformly(Ct,Ct,v),Te.addPrimitive(i,Ct,ete);break;case es.CrossedCube:W.scaleUniformly(Ct,Ct,v),Te.addPrimitive(i,Ct,tte),W.mul(Ct,Ct,W.rotZ90X180),i.currentGroup+=1,Te.addPrimitive(i,Ct,tte);break;case es.FilledCone:W.scaleUniformly(Ct,Ct,v*1.2),Te.addPrimitive(i,Ct,UDe);break;case es.DevidedCone:W.scaleUniformly(Ct,Ct,v*1.2),Te.addPrimitive(i,Ct,rte),W.mul(Ct,Ct,W.rotZ90),i.currentGroup+=1,Te.addPrimitive(i,Ct,rte);break;case es.FlatBox:W.mul(Ct,Ct,W.rotZY90),W.scale(Ct,Ct,y.set(Fp,v,v,v/2)),Te.addPrimitive(i,Ct,ete);break;case es.FilledStar:W.scaleUniformly(Ct,Ct,v),W.mul(Ct,Ct,W.rotZY90),Te.addPrimitive(i,Ct,GDe);break;case es.FilledDiamond:W.mul(Ct,Ct,W.rotZY90),W.scale(Ct,Ct,y.set(Fp,v*1.4,v*1.4,v*1.4)),Te.addPrimitive(i,Ct,jDe);break;case es.DividedDiamond:W.mul(Ct,Ct,W.rotZY90),W.scale(Ct,Ct,y.set(Fp,v*1.4,v*1.4,v*1.4)),Te.addPrimitive(i,Ct,nte),W.mul(Ct,Ct,W.rotY90),i.currentGroup+=1,Te.addPrimitive(i,Ct,nte);break;case es.FlatDiamond:W.mul(Ct,Ct,W.rotZY90),W.scale(Ct,Ct,y.set(Fp,v,v/2,v/2)),Te.addPrimitive(i,Ct,ote);break;case es.DiamondPrism:W.mul(Ct,Ct,W.rotZY90),W.scale(Ct,Ct,y.set(Fp,v,v,v/2)),Te.addPrimitive(i,Ct,ote);break;case es.PentagonalPrism:case es.Pentagon:W.mul(Ct,Ct,W.rotZY90),W.scale(Ct,Ct,y.set(Fp,v,v,v/2)),Te.addPrimitive(i,Ct,HDe);break;case es.HexagonalPrism:W.mul(Ct,Ct,W.rotZY90),W.scale(Ct,Ct,y.set(Fp,v,v,v/2)),Te.addPrimitive(i,Ct,qDe);break;case es.HeptagonalPrism:W.mul(Ct,Ct,W.rotZY90),W.scale(Ct,Ct,y.set(Fp,v,v,v/2)),Te.addPrimitive(i,Ct,XDe);break;case es.FlatHexagon:default:W.mul(Ct,Ct,W.rotZYZ90),W.scale(Ct,Ct,y.set(Fp,v/1.5,v,v/2)),Te.addPrimitive(i,Ct,WDe);break}}return Te.getMesh(i)}var bO=U(w({},Tu),{detail:g.Numeric(0,{min:0,max:3,step:1},ge.CustomQualityParamInfo),sizeFactor:g.Numeric(1.75,{min:0,max:10,step:.01})});function ite(t){return Va({defaultProps:g.getDefaultValues(bO),createGeometry:YDe,createLocationIterator:QDe,getLoci:KDe,eachLocation:$De,setUpdateState:(e,r,n)=>{e.createGeometry=r.sizeFactor!==n.sizeFactor||r.detail!==n.detail}},t)}function QDe(t){let e=t.carbohydrates.elements,r=e.length*2,n=1,o=z.Location.create(t);function i(s,l){let c=e[Math.floor(s/2)],u=c.unit.rings.all[c.ringIndex];return o.unit=c.unit,o.element=c.unit.elements[u[0]],o}function a(s,l){return s%2===1}return jt(r,n,1,i,!0,a)}function KDe(t,e,r){let{objectId:n,groupId:o}=t;if(r===n){let i=e.carbohydrates.elements[Math.floor(o/2)];return gh(e,i.unit,i.residueIndex,i.altId)}return St}var vO=new Set;function $De(t,e,r){let{getElementIndices:n}=e.carbohydrates,o=!1;if(!z.Loci.is(t)||!ue.areEquivalent(t.structure,e))return!1;for(let{unit:i,indices:a}of t.elements)Pe.isAtomic(i)&&(vO.clear(),we.forEach(a,s=>{let l=n(i,i.elements[s]);for(let c=0,u=l.length;c<u;++c)vO.has(l[c])||(vO.add(l[c]),r(Oe.ofSingleton(l[c]*2))&&(o=!0))}));return o}function ZDe(t,e,r,n,o){let{terminalLinks:i,elements:a}=e.carbohydrates,{terminalLinkSizeFactor:s}=n,l=z.Location.create(e),c={linkCount:i.length,position:(m,p,h)=>{let f=i[h];f.fromCarbohydrate?(y.copy(m,a[f.carbohydrateIndex].geometry.center),f.elementUnit.conformation.position(f.elementUnit.elements[f.elementIndex],p)):(f.elementUnit.conformation.position(f.elementUnit.elements[f.elementIndex],m),y.copy(p,a[f.carbohydrateIndex].geometry.center))},radius:m=>{let p=i[m];if(p.fromCarbohydrate){let h=a[p.carbohydrateIndex],f=h.unit.rings.all[h.ringIndex];l.unit=h.unit,l.element=h.unit.elements[f[0]]}else l.unit=p.elementUnit,l.element=p.elementUnit.elements[p.elementIndex];return r.size.size(l)*s},style:m=>{let p=i[m],h=p.elementUnit.elements[p.elementIndex],f=MT(p.elementUnit.model.atomicHierarchy.atoms.type_symbol.value(h));return tU.has(f)?1:0}},{mesh:u,boundingSphere:d}=jl(t,c,n,o);if(d)u.setBoundingSphere(d);else if(u.triangleCount>0){let m=te.expand(te(),e.boundary.sphere,1*s);u.setBoundingSphere(m)}return u}var SO=U(w(w({},Gr),wc),{terminalLinkSizeFactor:g.Numeric(.2,{min:0,max:3,step:.01})});function ate(t){return Va({defaultProps:g.getDefaultValues(SO),createGeometry:ZDe,createLocationIterator:JDe,getLoci:eAe,eachLocation:tAe,setUpdateState:(e,r,n)=>{e.createGeometry=r.terminalLinkSizeFactor!==n.terminalLinkSizeFactor||r.radialSegments!==n.radialSegments||r.linkCap!==n.linkCap}},t)}function JDe(t){let{elements:e,terminalLinks:r}=t.carbohydrates,n=r.length,o=1,i=z.Location.create(t);return jt(n,o,1,s=>{let l=r[s];if(l.fromCarbohydrate){let c=e[l.carbohydrateIndex],u=c.unit.rings.all[c.ringIndex];i.unit=c.unit,i.element=c.unit.elements[u[0]]}else i.unit=l.elementUnit,i.element=l.elementUnit.elements[l.elementIndex];return i},!0)}function eAe(t,e,r){let{objectId:n,groupId:o}=t;if(r===n){let{terminalLinks:i,elements:a}=e.carbohydrates,s=i[o],l=a[s.carbohydrateIndex];return z.Loci.union(gh(e,l.unit,l.residueIndex,l.altId),Q$(e,s.elementUnit,s.elementUnit.elements[s.elementIndex]))}return St}var xO=new Set;function tAe(t,e,r){let n=!1;if(!z.Loci.is(t)||!ue.areEquivalent(t.structure,e))return!1;let{getTerminalLinkIndices:o}=e.carbohydrates;for(let{unit:i,indices:a}of t.elements)Pe.isAtomic(i)&&(xO.clear(),we.forEach(a,s=>{let l=o(i,i.elements[s]);for(let c=0,u=l.length;c<u;++c)xO.has(l[c])||(xO.add(l[c]),r(Oe.ofSingleton(l[c]))&&(n=!0))}));return n}var ste={"carbohydrate-symbol":(t,e)=>_o("Carbohydrate symbol mesh",t,e,ite),"carbohydrate-link":(t,e)=>_o("Carbohydrate link cylinder",t,e,Wee),"carbohydrate-terminal-link":(t,e)=>_o("Carbohydrate terminal link cylinder",t,e,ate)},lte=U(w(w(w({},bO),lO),SO),{visuals:g.MultiSelect(["carbohydrate-symbol","carbohydrate-link","carbohydrate-terminal-link"],g.objectToOptions(ste)),bumpFrequency:g.Numeric(0,{min:0,max:10,step:.1},ge.ShadingCategory)});function rAe(t,e){return lte}function nAe(t,e){return rt.createMulti("Carbohydrate",t,e,Qr,ste)}var cte={name:"carbohydrate",label:"Carbohydrate",description:"Displays carbohydrate symbols (3D SNFG).",factory:nAe,getParams:rAe,defaultValues:g.getDefaultValues(lte),defaultColorTheme:{name:"carbohydrate-symbol"},defaultSizeTheme:{name:"uniform"},isApplicable:t=>t.models.some(e=>Et.hasCarbohydrate(e))};function CO(t,e){switch(t.kind){case 0:return oAe(t,e);case 1:case 2:return iAe(t,e)}}function oAe(t,e){let r=t.model.atomicRanges.cyclicPolymerMap,n=sc.transientSegments(Ty(t),t.elements),o=$r.transientSegments(t.model.atomicHierarchy.residueAtomSegments,t.elements),i=t.model.atomicHierarchy.derived.residue.traceElementIndex,{moleculeType:a}=t.model.atomicHierarchy.derived.residue,s=-1,l=-1,c=!0,u=-1,d=0;for(;n.hasNext;){for(c=!0,u=d,o.setSegment(n.move());o.hasNext;){if(c){let p=o.move().index;if(++d,!o.hasNext)continue;c=!1,l=p}let m=o.move().index;s=l,l=m,e(i[s],i[l],d-1,d,a[s]),++d}r.has(l)&&(s=l,l=r.get(s),e(i[s],i[l],d-1,u,a[s]))}}function iAe(t,e){let r=sc.transientSegments(Ty(t),t.elements),{elements:n}=t,o=!0,i=0;for(;r.hasNext;){o=!0;let a=r.move(),s=a.start,l=a.end;for(let c=s,u=l;c<u;++c){if(o){if(++c,++i,c>u)continue;o=!1}e(n[c-1],n[c],i-1,i,0),++i}}}function TO(t,e){switch(t.kind){case 0:return aAe(t,e);case 1:case 2:return sAe(t,e)}}function aAe(t,e){let r=sc.transientSegments(Ty(t),t.elements),n=$r.transientSegments(t.model.atomicHierarchy.residueAtomSegments,t.elements),o=t.model.atomicHierarchy.derived.residue.traceElementIndex,i=0;for(;r.hasNext;)for(n.setSegment(r.move());n.hasNext;){let a=n.move().index;e(o[a],i),++i}}function sAe(t,e){let r=sc.transientSegments(Ty(t),t.elements),{elements:n}=t,o=0;for(;r.hasNext;){let i=r.move(),a=i.start,s=i.end;for(let l=a,c=s;l<c;++l)e(n[l],o),++o}}function ute(t,e){switch(e.kind){case 0:return new wO(t,e);case 1:case 2:return new _O(t,e)}}function dte(t,e){return{centerA:z.Location.create(t,e),centerB:z.Location.create(t,e)}}var wO=class{move(){let{elements:e,residueIndex:r}=this.unit,n=this.gapIt.move();return this.value.centerA.element=this.traceElementIndex[r[e[n.start]]],this.value.centerB.element=this.traceElementIndex[r[e[n.end-1]]],this.hasNext=this.gapIt.hasNext,this.value}constructor(e,r){this.unit=r,this.hasNext=!1,this.traceElementIndex=r.model.atomicHierarchy.derived.residue.traceElementIndex,this.gapIt=sc.transientSegments(PO(r),r.elements),this.value=dte(e,r),this.hasNext=this.gapIt.hasNext}},_O=class{move(){let e=this.gapIt.move();return this.value.centerA.element=this.unit.elements[e.start],this.value.centerB.element=this.unit.elements[e.end-1],this.hasNext=this.gapIt.hasNext,this.value}constructor(e,r){this.unit=r,this.hasNext=!1,this.gapIt=sc.transientSegments(PO(r),r.elements),this.value=dte(e,r),this.hasNext=this.gapIt.hasNext}};function mte(t){let{x:e,y:r,z:n}=t.atomicConformation,{polymerType:o,traceElementIndex:i}=t.atomicHierarchy.derived.residue,a=o.length,s=we.ofBounds(0,t.atomicConformation.atomId.rowCount),l=sc.transientSegments(t.atomicRanges.polymerRanges,s),c=$r.transientSegments(t.atomicHierarchy.residueAtomSegments,s),u=new Float32Array(a*3),d=new Float32Array(a*3),m=0,p=-1,h=-1,f=y(),b=y(),v=y(),x=y(),S=y(),T=y(),E=y(),_=y(),D=y(),P=y(),A=y(),I=y(),k=y(),M=y();for(;l.hasNext;){let R=l.move();for(c.setSegment(R),m=-1,h=-1;c.hasNext;){m+=1;let{index:Q}=c.move();m===0&&(h=Q),p=Q-2;let L=p*3;y.copy(f,b),y.copy(b,v),y.copy(v,x);let Y=i[Q];if(y.set(x,e[Y],r[Y],n[Y]),m<3)continue;y.sub(S,b,f),y.sub(T,v,b),y.sub(E,x,v),y.sub(A,S,T),y.sub(I,T,E),y.cross(k,A,I),y.normalize(k,k),y.toArray(k,d,L);let j=Math.cos(y.angle(A,I)),O=y.magnitude(A),J=y.magnitude(I),$=Math.sqrt(J*O)/Math.max(2,2*(1-j));y.scale(_,A,$/O),y.sub(_,b,_),y.toArray(_,u,L),y.scale(D,I,$/J),y.sub(D,v,D),y.toArray(D,u,L+3),y.copy(M,k)}let B=h*3;y.fromArray(_,u,B+3),y.fromArray(D,u,B+6),y.normalize(k,y.sub(k,_,D));let F=i[h];y.set(f,e[F],r[F],n[F]),y.copy(P,f),y.projectPointOnVector(P,P,k,_),y.toArray(P,u,B);let G=p+2,V=G*3;y.fromArray(_,u,V-3),y.fromArray(D,u,V-6),y.normalize(k,y.sub(k,_,D));let H=i[G];y.set(f,e[H],r[H],n[H]),y.copy(P,f),y.projectPointOnVector(P,P,k,_),y.toArray(P,u,V)}return{centers:u}}var HS=IU.createProvider({label:"Helix Orientation",descriptor:Xc({name:"molstar_helix_orientation"}),type:"dynamic",defaultParams:{},getParams:()=>({}),isApplicable:t=>!0,obtain:(t,e)=>N(void 0,null,function*(){return{value:mte(e)}})});function Vd(t){return ts.is(t,2)}function lAe(t){return ts.is(t,4)}function mb(t,e,r={}){switch(t.kind){case 0:return new EO(t,e,r);case 1:case 2:return new IO(t,e)}}var YP=ts.create(536870912);function pte(t,e){return{center:z.Location.create(t,e),centerPrev:z.Location.create(t,e),centerNext:z.Location.create(t,e),first:!1,last:!1,initial:!1,final:!1,secStrucFirst:!1,secStrucLast:!1,secStrucType:YP,moleculeType:0,coarseBackboneFirst:!1,coarseBackboneLast:!1,isCoarseBackbone:!1,p0:y(),p1:y(),p2:y(),p3:y(),p4:y(),d12:y(),d23:y()}}var Ut=y(),WP=y(),XP=y(),EO=class{atomicPos(e,r){r!==-1&&(e[0]=this.atomicConformation.x[r],e[1]=this.atomicConformation.y[r],e[2]=this.atomicConformation.z[r])}pos(e,r,n){let o=this.traceElementIndex[r];this.helixOrientationCenters&&Vd(n)?y.fromArray(e,this.helixOrientationCenters,r*3):this.atomicPos(e,o)}updateResidueSegmentRange(e){let{index:r}=this.residueAtomSegments;this.residueSegmentMin=r[this.polymerRanges[e.index*2]],this.residueSegmentMax=r[this.polymerRanges[e.index*2+1]]}getResidueIndex(e){if(e<this.residueSegmentMin){let r=this.cyclicPolymerMap.get(this.residueSegmentMin);r!==void 0?e=r-(this.residueSegmentMin-e-1):e=this.residueSegmentMin}else if(e>this.residueSegmentMax){let r=this.cyclicPolymerMap.get(this.residueSegmentMax);r!==void 0?e=r+(e-this.residueSegmentMax-1):e=this.residueSegmentMax}return e}getSecStruc(e){if(this.secondaryStructure){let{type:r,getIndex:n}=this.secondaryStructure,o=r[n(e)];return Vd(o)?2:o}else return YP}setControlPoint(e,r,n,o,i){lAe(i)||this.helixOrientationCenters&&Vd(i)?y.scale(e,y.add(e,r,y.add(e,o,y.add(e,n,n))),1/4):y.copy(e,n)}setFromToVector(e,r,n){this.value.isCoarseBackbone||this.helixOrientationCenters&&Vd(n)?y.set(e,1,0,0):(this.atomicPos(WP,this.directionFromElementIndex[r]),this.atomicPos(XP,this.directionToElementIndex[r]),y.sub(e,XP,WP))}setDirection(e,r,n,o){y.matchDirection(WP,r,n),y.matchDirection(XP,o,n),y.scale(e,y.add(e,WP,y.add(e,XP,y.add(e,n,n))),1/4)}move(){let{residueIt:e,polymerIt:r,value:n}=this;if(this.state===0){for(;r.hasNext;)if(this.polymerSegment=r.move(),e.setSegment(this.polymerSegment),this.updateResidueSegmentRange(this.polymerSegment),e.hasNext){this.state=1;let o=this.residueAtomSegments.index[this.unit.elements[this.polymerSegment.start]],i=this.getResidueIndex(o-1);this.currSecStrucType=o===i?YP:this.getSecStruc(i),this.nextSecStrucType=this.getSecStruc(o),this.currCoarseBackbone=this.directionFromElementIndex[i]===-1||this.directionToElementIndex[i]===-1,this.nextCoarseBackbone=this.directionFromElementIndex[o]===-1||this.directionToElementIndex[o]===-1;break}}if(this.state===1){let{index:o}=e.move(),i=this.getResidueIndex(o-3),a=this.getResidueIndex(o-2),s=this.getResidueIndex(o-1),l=this.getResidueIndex(o+1),c=this.getResidueIndex(o+2),u=this.getResidueIndex(o+3);this.prevSecStrucType=this.getSecStruc(s),this.currSecStrucType=this.getSecStruc(o),this.nextSecStrucType=o===l?YP:this.getSecStruc(l),this.prevCoarseBackbone=this.currCoarseBackbone,this.currCoarseBackbone=this.nextCoarseBackbone,this.nextCoarseBackbone=this.directionFromElementIndex[l]===-1||this.directionToElementIndex[l]===-1,n.secStrucType=this.currSecStrucType,n.secStrucFirst=this.prevSecStrucType!==this.currSecStrucType,n.secStrucLast=this.currSecStrucType!==this.nextSecStrucType,n.isCoarseBackbone=this.currCoarseBackbone,n.coarseBackboneFirst=this.prevCoarseBackbone!==this.currCoarseBackbone,n.coarseBackboneLast=this.currCoarseBackbone!==this.nextCoarseBackbone,n.first=o===this.residueSegmentMin,n.last=o===this.residueSegmentMax,n.moleculeType=this.moleculeType[o],n.initial=o===s,n.final=o===l,n.centerPrev.element=this.traceElementIndex[s],n.center.element=this.traceElementIndex[o],n.centerNext.element=this.traceElementIndex[l];let d=this.getSecStruc(i),m=this.getSecStruc(a),p=this.getSecStruc(s),h=this.getSecStruc(o),f=this.getSecStruc(l),b=this.getSecStruc(c),v=this.getSecStruc(u);this.pos(this.p0,i,d),this.pos(this.p1,a,m),this.pos(this.p2,s,p),this.pos(this.p3,o,h),this.pos(this.p4,l,f),this.pos(this.p5,c,b),this.pos(this.p6,u,v);let x=Vd(d),S=Vd(m),T=Vd(p),E=Vd(h),_=Vd(f),D=Vd(b),P=Vd(v);this.helixOrientationCenters&&(E!==T?E?(y.copy(this.p0,this.p3),y.copy(this.p1,this.p3),y.copy(this.p2,this.p3)):T&&(y.scale(Ut,y.sub(Ut,this.p2,this.p3),2),y.add(this.p2,this.p3,Ut),y.add(this.p1,this.p2,Ut),y.add(this.p0,this.p1,Ut)):E!==S?E?(y.copy(this.p0,this.p2),y.copy(this.p1,this.p2)):S&&(y.scale(Ut,y.sub(Ut,this.p1,this.p2),2),y.add(this.p1,this.p2,Ut),y.add(this.p0,this.p1,Ut)):E!==x&&(E?y.copy(this.p0,this.p1):x&&(y.scale(Ut,y.sub(Ut,this.p0,this.p1),2),y.add(this.p0,this.p1,Ut))),E!==_?E?(y.copy(this.p4,this.p3),y.copy(this.p5,this.p3),y.copy(this.p6,this.p3)):_&&(y.scale(Ut,y.sub(Ut,this.p4,this.p3),2),y.add(this.p4,this.p3,Ut),y.add(this.p5,this.p4,Ut),y.add(this.p6,this.p5,Ut)):E!==D?E?(y.copy(this.p5,this.p4),y.copy(this.p6,this.p4)):D&&(y.scale(Ut,y.sub(Ut,this.p5,this.p4),2),y.add(this.p5,this.p4,Ut),y.add(this.p6,this.p5,Ut)):E!==P&&(E?y.copy(this.p6,this.p5):P&&(y.scale(Ut,y.sub(Ut,this.p6,this.p5),2),y.add(this.p6,this.p5,Ut)))),this.setFromToVector(this.d01,s,p),this.setFromToVector(this.d12,o,h),this.setFromToVector(this.d23,l,f),this.setFromToVector(this.d34,c,b);let A=E&&this.helixOrientationCenters,I=1.5;o===s||h!==p&&A?(y.setMagnitude(Ut,y.sub(Ut,this.p3,this.p4),I),y.add(this.p2,this.p3,Ut),y.add(this.p1,this.p2,Ut),y.add(this.p0,this.p1,Ut)):s===a||h!==m&&A?(y.setMagnitude(Ut,y.sub(Ut,this.p2,this.p3),I),y.add(this.p1,this.p2,Ut),y.add(this.p0,this.p1,Ut)):(a===i||h!==d&&A)&&(y.setMagnitude(Ut,y.sub(Ut,this.p1,this.p2),I),y.add(this.p0,this.p1,Ut)),o===l||h!==f&&A?(y.setMagnitude(Ut,y.sub(Ut,this.p3,this.p2),I),y.add(this.p4,this.p3,Ut),y.add(this.p5,this.p4,Ut),y.add(this.p6,this.p5,Ut)):l===c||h!==b&&A?(y.setMagnitude(Ut,y.sub(Ut,this.p4,this.p3),I),y.add(this.p5,this.p4,Ut),y.add(this.p6,this.p5,Ut)):(c===u||h!==v&&A)&&(y.setMagnitude(Ut,y.sub(Ut,this.p5,this.p4),I),y.add(this.p6,this.p5,Ut)),this.setControlPoint(n.p0,this.p0,this.p1,this.p2,m),this.setControlPoint(n.p1,this.p1,this.p2,this.p3,p),this.setControlPoint(n.p2,this.p2,this.p3,this.p4,h),this.setControlPoint(n.p3,this.p3,this.p4,this.p5,f),this.setControlPoint(n.p4,this.p4,this.p5,this.p6,b),this.setDirection(n.d12,this.d01,this.d12,this.d23),this.setDirection(n.d23,this.d12,this.d23,this.d34),e.hasNext||(this.state=0)}return this.hasNext=e.hasNext||r.hasNext,this.value}constructor(e,r,n={}){var o;if(this.unit=e,this.state=0,this.p0=y(),this.p1=y(),this.p2=y(),this.p3=y(),this.p4=y(),this.p5=y(),this.p6=y(),this.d01=y(),this.d12=y(),this.d23=y(),this.d34=y(),this.hasNext=!1,this.atomicConformation=e.model.atomicConformation,this.residueAtomSegments=e.model.atomicHierarchy.residueAtomSegments,this.polymerRanges=e.model.atomicRanges.polymerRanges,this.traceElementIndex=e.model.atomicHierarchy.derived.residue.traceElementIndex,this.directionFromElementIndex=e.model.atomicHierarchy.derived.residue.directionFromElementIndex,this.directionToElementIndex=e.model.atomicHierarchy.derived.residue.directionToElementIndex,this.moleculeType=e.model.atomicHierarchy.derived.residue.moleculeType,this.cyclicPolymerMap=e.model.atomicRanges.cyclicPolymerMap,this.polymerIt=sc.transientSegments(this.polymerRanges,e.elements),this.residueIt=$r.transientSegments(this.residueAtomSegments,e.elements),this.value=pte(r,e),this.hasNext=this.residueIt.hasNext&&this.polymerIt.hasNext,n.ignoreSecondaryStructure||(this.secondaryStructure=(o=xs.get(r).value)===null||o===void 0?void 0:o.get(e.invariantId)),n.useHelixOrientation){let i=HS.get(e.model).value;if(!i)throw new Error("missing helix-orientation");this.helixOrientationCenters=i.centers}}},IO=class{getElementIndex(e){return Math.min(Math.max(this.polymerSegment.start,e),this.polymerSegment.end-1)}pos(e,r){let n=this.unit.elements[r];e[0]=this.conformation.x[n],e[1]=this.conformation.y[n],e[2]=this.conformation.z[n]}move(){if(this.state===0){for(;this.polymerIt.hasNext;)if(this.polymerSegment=this.polymerIt.move(),this.elementIndex=this.polymerSegment.start,this.elementIndex<this.polymerSegment.end){this.state=1;break}}if(this.state===1){let e=this.getElementIndex(this.elementIndex-2),r=this.getElementIndex(this.elementIndex-1),n=this.getElementIndex(this.elementIndex+1),o=this.getElementIndex(this.elementIndex+2);this.value.centerPrev.element=this.value.center.unit.elements[r],this.value.center.element=this.value.center.unit.elements[this.elementIndex],this.value.centerNext.element=this.value.center.unit.elements[n],this.pos(this.value.p0,e),this.pos(this.value.p1,r),this.pos(this.value.p2,this.elementIndex),this.pos(this.value.p3,n),this.pos(this.value.p4,o);let i=.5;this.elementIndex===r?(y.scale(Ut,y.sub(Ut,this.value.p2,this.value.p3),i),y.add(this.value.p1,this.value.p2,Ut),y.add(this.value.p0,this.value.p1,Ut)):r===e&&(y.scale(Ut,y.sub(Ut,this.value.p1,this.value.p2),i),y.add(this.value.p0,this.value.p1,Ut)),this.elementIndex===n?(y.scale(Ut,y.sub(Ut,this.value.p2,this.value.p1),i),y.add(this.value.p3,this.value.p2,Ut),y.add(this.value.p4,this.value.p3,Ut)):n===o&&(y.scale(Ut,y.sub(Ut,this.value.p3,this.value.p2),i),y.add(this.value.p4,this.value.p3,Ut)),this.value.first=this.elementIndex===this.polymerSegment.start,this.value.last=this.elementIndex===this.polymerSegment.end-1,this.elementIndex+1>=this.polymerSegment.end&&(this.state=0)}return this.hasNext=this.elementIndex+1<this.polymerSegment.end||this.polymerIt.hasNext,this.elementIndex+=1,this.value}constructor(e,r){switch(this.unit=e,this.state=0,this.hasNext=!1,this.polymerIt=sc.transientSegments(Ty(e),e.elements),this.value=pte(r,e),y.set(this.value.d12,1,0,0),y.set(this.value.d23,1,0,0),e.kind){case 1:this.conformation=e.model.coarseConformation.spheres;break;case 2:this.conformation=e.model.coarseConformation.gaussians;break}this.hasNext=this.polymerIt.hasNext}};var wy=y.fromArray,hb=y.toArray,LO=y.normalize,cAe=y.sub,pb=y.spline,uAe=y.slerp,fte=y.copy,hte=y.cross,DO=y.orthogonalize,dAe=y.matchDirection,mAe=y.scale,gte=y.add;function gb(t){let e=t+1,r=e*3;return{curvePoints:new Float32Array(r),tangentVectors:new Float32Array(r),normalVectors:new Float32Array(r),binormalVectors:new Float32Array(r),widthValues:new Float32Array(e),heightValues:new Float32Array(e),linearSegments:t}}function yb(t,e,r,n){pAe(t,e,r,n),hAe(t,e)}var AO=y(),kO=y(),MO=y();function pAe(t,e,r,n){let{curvePoints:o,tangentVectors:i,linearSegments:a}=t,{p0:s,p1:l,p2:c,p3:u,p4:d,secStrucFirst:m,secStrucLast:p}=e,h=1-n,f=m?.5:r,b=p?.5:r;for(let v=0;v<=a;++v){let x=v*1/a;if(x<h){let S=fn(f,r,x);pb(MO,s,l,c,u,x+n,S),pb(AO,s,l,c,u,x+n+.01,f),pb(kO,s,l,c,u,x+n-.01,f)}else{let S=fn(r,b,x);pb(MO,l,c,u,d,x-h,S),pb(AO,l,c,u,d,x-h+.01,S),pb(kO,l,c,u,d,x-h-.01,S)}hb(MO,o,v*3),LO(Mh,cAe(Mh,AO,kO)),hb(Mh,i,v*3)}}var fAe=y(),Mh=y(),zd=y(),fb=y(),qS=y(),yte=y(),vte=y(),bte=y(),RO=y(),QP=y();function hAe(t,e){let{curvePoints:r,tangentVectors:n,normalVectors:o,binormalVectors:i}=t,{d12:a,d23:s}=e,l=r.length/3;wy(vte,n,0),wy(bte,n,(l-1)*3),DO(RO,vte,a),DO(QP,bte,s),dAe(QP,QP,RO),fte(qS,RO);let c=l-1;for(let u=0;u<l;++u){let d=CT(0,c,u)*c,m=u===0?0:1/(l-d);wy(Mh,n,u*3),DO(zd,Mh,uAe(fAe,qS,QP,m)),hb(zd,o,u*3),fte(qS,zd),LO(fb,hte(fb,Mh,zd)),hb(fb,i,u*3)}for(let u=1;u<c;++u)wy(qS,o,(u-1)*3),wy(zd,o,u*3),wy(yte,o,(u+1)*3),mAe(zd,gte(zd,qS,gte(zd,yte,zd)),1/3),hb(zd,o,u*3),wy(Mh,n,u*3),LO(fb,hte(fb,Mh,zd)),hb(fb,i,u*3)}function WS(t,e,r,n,o,i,a,s){let{widthValues:l,heightValues:c,linearSegments:u}=t,d=1-s;for(let m=0;m<=u;++m){let p=m*1/u;p<d?(l[m]=fn(e,r,p+s),c[m]=fn(o,i,p+s)):(l[m]=fn(r,n,p-d),c[m]=fn(i,a,p-d))}}var $P=.5,Ste=.9,_y=.5,Py=.3,vb=2;function Ty(t){switch(t.kind){case 0:return t.model.atomicRanges.polymerRanges;case 1:return t.model.coarseHierarchy.spheres.polymerRanges;case 2:return t.model.coarseHierarchy.gaussians.polymerRanges}}function PO(t){switch(t.kind){case 0:return t.model.atomicRanges.gapRanges;case 1:return t.model.coarseHierarchy.spheres.gapRanges;case 2:return t.model.coarseHierarchy.gaussians.gapRanges}}var Wl;(function(t){function e(r,n){let{group:o,structure:i}=r,a=o.units[0].polymerElements,s=a.length,l=o.units.length,c=z.Location.create(i),u=(p,h)=>{let f=o.units[h];return c.unit=f,c.element=a[p],c},d=!!n?.asSecondary;function m(p,h){return d}return jt(s,l,1,u,!1,m)}t.fromGroup=e})(Wl||(Wl={}));var KP;(function(t){function e(r){let{group:n,structure:o}=r,i=n.units[0].gapElements,a=i.length,s=n.units.length,l=z.Location.create(o);return jt(a,s,1,(u,d)=>{let m=n.units[d];return l.unit=m,l.element=i[u],l})}t.fromGroup=e})(KP||(KP={}));function Au(t,e,r){let{objectId:n,instanceId:o,groupId:i}=t;if(r===n){let{structure:a,group:s}=e,l=s.units[o];if(Pe.isAtomic(l))return O_(a,l,l.polymerElements[i]);{let{elements:c}=l,u=l.polymerElements[i],d=we.indexOf(c,u);if(d!==-1){let m=we.ofSingleton(d);return z.Loci(a,[{unit:l,indices:m}])}}}return St}function xte(t,e,r,n,o,i){let a=-1,s=-1;for(let c=o;c<=i;c++){let u=r[c];if(!(u<0)&&(a=we.indexOf(e,u),a>=0)){s=c;break}}if(a<0)return!1;let l=a;for(let c=i;c>s;c--){let u=r[c];if(u<0)continue;let d=we.indexOf(e,u);if(d>=0){l=d;break}}return n(Oe.ofRange(t+a,t+l))}function BO(t,e,r,n,o){let i=!1,{elements:a}=o.unit,{traceElementIndex:s}=o.unit.model.atomicHierarchy.derived.residue,{index:l}=o.unit.model.atomicHierarchy.residueAtomSegments,c=r(o.unit);if(Oe.is(o.indices))if(Oe.start(o.indices)===0&&Oe.end(o.indices)===o.unit.elements.length)i=n(Oe.ofBounds(t,t+e))||i;else{let u=l[a[Oe.min(o.indices)]],d=l[a[Oe.max(o.indices)]];i=xte(t,c,s,n,u,d)||i}else{let{indices:u}=o;for(let d=0,m=u.length;d<m;d++){let p=l[a[u[d]]],h=p,f=d+1;for(;f<m;){let b=l[a[u[f]]];if(b-h>1)break;h=b,f++}d=f-1,i=xte(t,c,s,n,p,h)||i}}return i}function gAe(t){return t.polymerElements}function ku(t,e,r){let n=!1;if(!z.Loci.is(t))return!1;let{structure:o,group:i}=e;if(!ue.areEquivalent(t.structure,o))return!1;let a=i.units[0].polymerElements.length;for(let s of t.elements){if(!i.unitIndexMap.has(s.unit.id))continue;let l=i.unitIndexMap.get(s.unit.id)*a;if(Pe.isAtomic(s.unit))n=BO(l,a,gAe,r,s)||n;else if(Oe.is(s.indices)){let c=l+Oe.start(s.indices),u=l+Oe.end(s.indices);n=r(Oe.ofBounds(c,u))||n}else for(let c=0,u=s.indices.length;c<u;c++){let d=s.indices[c],m=c+1;for(;m<u&&s.indices[m]===d;)m++;c=m-1;let p=s.indices[c];n=r(Oe.ofRange(l+d,l+p))||n}}return n}function Cte(t,e,r){let{objectId:n,instanceId:o,groupId:i}=t;if(r===n){let{structure:a,group:s}=e,l=s.units[o],c=we.indexOf(l.elements,l.gapElements[i]),u=we.indexOf(l.elements,l.gapElements[i%2?i-1:i+1]);if(c!==-1&&u!==-1)return ze.Loci(a,[ze.Location(a,l,c,a,l,u),ze.Location(a,l,u,a,l,c)])}return St}function Tte(t,e,r){let n=!1;if(ze.isLoci(t)){let{structure:o,group:i}=e;if(!ue.areRootsEquivalent(t.structure,o))return!1;t=ze.remapLoci(t,o);let a=i.units[0].gapElements.length;for(let s of t.bonds){let l=i.unitIndexMap.get(s.aUnit.id);if(l!==void 0){let c=we.indexOf(s.aUnit.gapElements,s.aUnit.elements[s.aIndex]),u=we.indexOf(s.bUnit.gapElements,s.bUnit.elements[s.bIndex]);c!==-1&&u!==-1&&r(Oe.ofSingleton(l*a+c))&&(n=!0)}}}else if(z.Loci.is(t)){let{structure:o,group:i}=e;if(!ue.areRootsEquivalent(t.structure,o))return!1;t=z.Loci.remap(t,o);let a=i.units[0].gapElements.length;for(let s of t.elements){let l=i.unitIndexMap.get(s.unit.id);l!==void 0&&we.forEach(s.indices,c=>{let u=we.indexOf(s.unit.gapElements,s.unit.elements[c]);u!==-1&&r(Oe.ofSingleton(l*a+u))&&(n=!0)})}}return n}var Xl;(function(t){function e(r){let{group:n,structure:o}=r,i=n.units[0],a=Pe.isAtomic(i)?i.nucleotideElements:[],s=a.length,l=n.units.length,c=z.Location.create(o);return jt(s,l,1,(d,m)=>{let p=n.units[m];return c.unit=p,c.element=a[d],c})}t.fromGroup=e})(Xl||(Xl={}));function Mu(t,e,r){let{objectId:n,instanceId:o,groupId:i}=t;if(r===n){let{structure:a,group:s}=e,l=s.units[o];if(Pe.isAtomic(l))return O_(a,l,l.nucleotideElements[i])}return St}function yAe(t){return t.nucleotideElements}function Ru(t,e,r){let n=!1;if(!z.Loci.is(t))return!1;let{structure:o,group:i}=e;if(!ue.areEquivalent(t.structure,o))return!1;let a=i.units[0];if(!Pe.isAtomic(a))return!1;let{nucleotideElements:s}=a,l=s.length;for(let c of t.elements){if(!Pe.isAtomic(c.unit)||!i.unitIndexMap.has(c.unit.id))continue;let u=i.unitIndexMap.get(c.unit.id)*l;Pe.isAtomic(c.unit)&&(n=BO(u,l,yAe,r,c)||n)}return n}var vAe=y(),bAe=y();function Lu(t,e){let{model:r,conformation:n}=t,{residueAtomSegments:o,atoms:i,index:a}=r.atomicHierarchy,{label_comp_id:s}=i,l=s.value(o.offsets[e]),c=Zz(l),u=Jz(l);if(!c&&!u){let d=a.findAtomOnResidue(e,"C4"),m=a.findAtomOnResidue(e,"N9");d!==-1&&m!==-1&&y.distance(n.invariantPosition(d,vAe),n.invariantPosition(m,bAe))<1.6?c=!0:u=!0}return{isPurine:c,isPyrimidine:u}}function Bu(){return{trace:-1,N1:-1,C2:-1,N3:-1,C4:-1,C5:-1,C6:-1,N7:-1,C8:-1,N9:-1,C1_1:-1,C2_1:-1,C3_1:-1,C4_1:-1,O4_1:-1}}function Ou(t,e,r){let n=e.model.atomicHierarchy.index,{traceElementIndex:o}=e.model.atomicHierarchy.derived.residue;return t.trace=o[r],t.N1=n.findAtomOnResidue(r,"N1"),t.C2=n.findAtomOnResidue(r,"C2"),t.N3=n.findAtomOnResidue(r,"N3"),t.C4=n.findAtomOnResidue(r,"C4"),t.C5=n.findAtomOnResidue(r,"C5"),t.C5===-1&&(t.C5=n.findAtomOnResidue(r,"N5")),t.C6=n.findAtomOnResidue(r,"C6"),t.N7=n.findAtomOnResidue(r,"N7"),t.N7===-1&&(t.N7=n.findAtomOnResidue(r,"C7")),t.C8=n.findAtomOnResidue(r,"C8"),t.N9=n.findAtomOnResidue(r,"N9"),t}function Rm(t){return t.trace!==-1&&t.N1!==-1&&t.C2!==-1&&t.N3!==-1&&t.C4!==-1&&t.C5!==-1&&t.C6!==-1&&t.N7!==-1&&t.C8!==-1&&t.N9!==-1}function Fu(t,e,r){let n=e.model.atomicHierarchy.index,{traceElementIndex:o}=e.model.atomicHierarchy.derived.residue;return t.trace=o[r],t.N1=n.findAtomOnResidue(r,"N1"),t.N1===-1&&(t.N1=n.findAtomOnResidue(r,"C1")),t.C2=n.findAtomOnResidue(r,"C2"),t.N3=n.findAtomOnResidue(r,"N3"),t.C4=n.findAtomOnResidue(r,"C4"),t.C5=n.findAtomOnResidue(r,"C5"),t.C6=n.findAtomOnResidue(r,"C6"),t}function Lm(t){return t.trace!==-1&&t.N1!==-1&&t.C2!==-1&&t.N3!==-1&&t.C4!==-1&&t.C5!==-1&&t.C6!==-1}function Rh(t,e,r){let n=e.model.atomicHierarchy.index,{traceElementIndex:o}=e.model.atomicHierarchy.derived.residue;return t.trace=o[r],t.C1_1=n.findAtomOnResidue(r,"C1'"),t.C2_1=n.findAtomOnResidue(r,"C2'"),t.C3_1=n.findAtomOnResidue(r,"C3'"),t.C4_1=n.findAtomOnResidue(r,"C4'"),t.O4_1=n.findAtomOnResidue(r,"O4'"),t}function Lh(t){return t.trace!==-1&&t.C1_1!==-1&&t.C2_1!==-1&&t.C3_1!==-1&&t.C4_1!==-1&&t.O4_1!==-1}var ZP=y(),OO=y(),wte=y(),_te=y(),Pte=y(),Ete=y(),JP=y(),FO=y(),NO=y(),Ite=y(),XS=W.identity(),xAe=y(),Dte=M0(),Ate={sizeFactor:g.Numeric(.2,{min:0,max:10,step:.01}),thicknessFactor:g.Numeric(1,{min:0,max:2,step:.01}),radialSegments:g.Numeric(16,{min:2,max:56,step:2},ge.CustomQualityParamInfo)},p6t=g.getDefaultValues(Ate);function SAe(t,e,r,n,o,i){if(!Pe.isAtomic(e))return Be.createEmpty(i);let a=e.nucleotideElements.length;if(!a)return Be.createEmpty(i);let{sizeFactor:s,thicknessFactor:l,radialSegments:c}=o,u=a*(Dte.vertices.length/3+c*2),d=Te.createState(u,u/4,i),{elements:m,model:p,conformation:h}=e,{chainAtomSegments:f,residueAtomSegments:b}=p.atomicHierarchy,{moleculeType:v}=p.atomicHierarchy.derived.residue,x=$r.transientSegments(f,m),S=$r.transientSegments(b,m),T=1*s,E=4.5,_=l*s*2,D={radiusTop:T,radiusBottom:T,radialSegments:c,bottomCap:!0},P=0;for(;x.hasNext;)for(S.setSegment(x.move());S.hasNext;){let{index:k}=S.move();if(Yo(v[k])){let M=Bu(),R=-1,B=-1,F=-1,G=-1,V=-1,H=4.5,{isPurine:Q,isPyrimidine:L}=Lu(e,k);Q?(H=4.5,Ou(M,e,k),R=M.N1,B=M.C4,F=M.C6,G=M.C2,V=M.N9):L&&(H=3,Fu(M,e,k),R=M.N3,B=M.C6,F=M.C4,G=M.C2,V=M.N1),V!==-1&&M.trace!==-1&&(h.invariantPosition(V,Pte),h.invariantPosition(M.trace,Ete),d.currentGroup=P,nr(d,Pte,Ete,1,D),R!==-1&&B!==-1&&F!==-1&&G!==-1&&(h.invariantPosition(R,ZP),h.invariantPosition(B,OO),h.invariantPosition(F,wte),h.invariantPosition(G,_te),y.normalize(JP,y.sub(JP,OO,ZP)),y.normalize(FO,y.sub(FO,_te,wte)),y.normalize(NO,y.cross(NO,JP,FO)),W.targetTo(XS,ZP,OO,NO),y.scaleAndAdd(Ite,ZP,JP,H/2-.2),W.scale(XS,XS,y.set(xAe,E,_,H)),W.setTranslation(XS,Ite),Te.addPrimitive(d,XS,Dte))),++P}}let A=Te.getMesh(d),I=te.expand(te(),e.boundary.sphere,T);return A.setBoundingSphere(I),A}var VO=w(w({},Gr),Ate);function kte(t){return rn({defaultProps:g.getDefaultValues(VO),createGeometry:SAe,createLocationIterator:Xl.fromGroup,getLoci:Mu,eachLocation:Ru,setUpdateState:(e,r,n)=>{e.createGeometry=r.sizeFactor!==n.sizeFactor||r.thicknessFactor!==n.thicknessFactor||r.radialSegments!==n.radialSegments}},t)}var eE=y(),Bh=y(),tE=y(),rE=y(),bb=y(),xb=y(),nE=y(),Mte=y(),Rte=y(),oE=y(),Oh=y(),Ote={sizeFactor:g.Numeric(.2,{min:0,max:10,step:.01}),thicknessFactor:g.Numeric(1,{min:0,max:2,step:.01}),radialSegments:g.Numeric(16,{min:2,max:56,step:2},ge.CustomQualityParamInfo),detail:g.Numeric(0,{min:0,max:3,step:1},ge.CustomQualityParamInfo)},D6t=g.getDefaultValues(Ote),iE=new Float32Array(2*9*3),CAe=new Uint32Array([0,1,2,3,4,5,6,7,16,17,14,15,12,13,8,9,10,11,0,1]),TAe=new Uint32Array([8,12,14,16,6,4,2,0,10]),wAe=new Uint32Array([9,11,1,3,5,7,17,15,13]),aE=new Float32Array(2*6*3),_Ae=new Uint32Array([0,1,2,3,4,5,6,7,8,9,10,11,0,1]),PAe=new Uint32Array([0,10,8,6,4,2]),EAe=new Uint32Array([1,3,5,7,9,11]),Lte=y();function Bte(t,e,...r){for(let n=0,o=r.length;n<o;++n){let i=r[n];y.toArray(y.add(Lte,i,e),t,n*2*3),y.toArray(y.sub(Lte,i,e),t,(n*2+1)*3)}}function IAe(t,e,r,n,o,i){if(!Pe.isAtomic(e))return Be.createEmpty(i);let a=e.nucleotideElements.length;if(!a)return Be.createEmpty(i);let{sizeFactor:s,thicknessFactor:l,radialSegments:c,detail:u}=o,d=a*(26+c*2),m=Te.createState(d,d/4,i),{elements:p,model:h,conformation:f}=e,{chainAtomSegments:b,residueAtomSegments:v}=h.atomicHierarchy,{moleculeType:x}=h.atomicHierarchy.derived.residue,S=$r.transientSegments(b,p),T=$r.transientSegments(v,p),E=1*s,_=l*s,D={radiusTop:E,radiusBottom:E,radialSegments:c},P=0;for(;S.hasNext;)for(T.setSegment(S.move());T.hasNext;){let{index:k}=T.move();if(Yo(x[k])){let M=Bu();m.currentGroup=P;let{isPurine:R,isPyrimidine:B}=Lu(e,k);R?(Ou(M,e,k),M.N9!==-1&&M.trace!==-1&&(f.invariantPosition(M.N9,oE),f.invariantPosition(M.trace,eE),m.currentGroup=P,nr(m,oE,eE,1,D),Jt(m,oE,E,u)),Rm(M)&&(f.invariantPosition(M.N1,Bh),f.invariantPosition(M.C2,tE),f.invariantPosition(M.N3,rE),f.invariantPosition(M.C4,bb),f.invariantPosition(M.C5,xb),f.invariantPosition(M.C6,nE),f.invariantPosition(M.N7,Mte),f.invariantPosition(M.C8,Rte),y.triangleNormal(Oh,Bh,bb,xb),y.scale(Oh,Oh,_),Bte(iE,Oh,Bh,tE,rE,bb,xb,nE,Mte,Rte,oE),Te.addTriangleStrip(m,iE,CAe),Te.addTriangleFan(m,iE,TAe),Te.addTriangleFan(m,iE,wAe))):B&&(Fu(M,e,k),M.N1!==-1&&M.trace!==-1&&(f.invariantPosition(M.N1,Bh),f.invariantPosition(M.trace,eE),m.currentGroup=P,nr(m,Bh,eE,1,D),Jt(m,Bh,E,u)),Lm(M)&&(f.invariantPosition(M.C2,tE),f.invariantPosition(M.N3,rE),f.invariantPosition(M.C4,bb),f.invariantPosition(M.C5,xb),f.invariantPosition(M.C6,nE),y.triangleNormal(Oh,Bh,bb,xb),y.scale(Oh,Oh,_),Bte(aE,Oh,Bh,tE,rE,bb,xb,nE),Te.addTriangleStrip(m,aE,_Ae),Te.addTriangleFan(m,aE,PAe),Te.addTriangleFan(m,aE,EAe))),++P}}let A=Te.getMesh(m),I=te.expand(te(),e.boundary.sphere,E);return A.setBoundingSphere(I),A}var zO=w(w({},Gr),Ote);function Fte(t){return rn({defaultProps:g.getDefaultValues(zO),createGeometry:IAe,createLocationIterator:Xl.fromGroup,getLoci:Mu,eachLocation:Ru,setUpdateState:(e,r,n)=>{e.createGeometry=r.sizeFactor!==n.sizeFactor||r.thicknessFactor!==n.thicknessFactor||r.radialSegments!==n.radialSegments}},t)}var Sb=y(),sE=y(),lE=y(),Cb=y(),Tb=y(),cE=y(),Nte=y(),Vte=y(),zte=y(),uE=y(),UO=y(),dE=y(),mE=y(),GO=y(),wb=y(),Ha=y(),_b=y(),Gte={sizeFactor:g.Numeric(.2,{min:0,max:10,step:.01}),thicknessFactor:g.Numeric(1,{min:0,max:2,step:.01})},G6t=g.getDefaultValues(Gte),pE=new Float32Array(2*9*3),DAe=new Uint32Array([0,1,2,3,4,5,6,7,16,17,14,15,12,13,8,9,10,11,0,1]),AAe=new Uint32Array([8,12,14,16,6,4,2,0,10]),kAe=new Uint32Array([9,11,1,3,5,7,17,15,13]),fE=new Float32Array(2*6*3),MAe=new Uint32Array([2,3,4,5,6,7,8,9,10,11,2,3]),RAe=new Uint32Array([0,10,8,6,4,2,10]),LAe=new Uint32Array([1,3,5,7,9,11,3]),hE=new Float32Array(2*6*3),BAe=new Uint32Array([0,1,2,3,4,5,6,7,8,9,10,11,0,1]),OAe=new Uint32Array([0,10,8,6,4,2]),FAe=new Uint32Array([1,3,5,7,9,11]),Ute=y();function jO(t,e,...r){for(let n=0,o=r.length;n<o;++n){let i=r[n];y.toArray(y.add(Ute,i,e),t,n*2*3),y.toArray(y.sub(Ute,i,e),t,(n*2+1)*3)}}function NAe(t,e,r,n,o,i){if(!Pe.isAtomic(e))return Be.createEmpty(i);let a=e.nucleotideElements.length;if(!a)return Be.createEmpty(i);let{sizeFactor:s,thicknessFactor:l}=o,c=a*25,u=Te.createState(c,c/4,i),{elements:d,model:m,conformation:p}=e,{chainAtomSegments:h,residueAtomSegments:f}=m.atomicHierarchy,{moleculeType:b}=m.atomicHierarchy.derived.residue,v=$r.transientSegments(h,d),x=$r.transientSegments(f,d),S=s*l,T=0;for(;v.hasNext;)for(x.setSegment(v.move());x.hasNext;){let{index:D}=x.move();if(Yo(b[D])){let P=Bu();u.currentGroup=T,Rh(P,e,D),Lh(P)&&(p.invariantPosition(P.C1_1,uE),p.invariantPosition(P.C2_1,UO),p.invariantPosition(P.C3_1,dE),p.invariantPosition(P.C4_1,mE),p.invariantPosition(P.O4_1,GO),y.triangleNormal(Ha,dE,mE,uE),y.scale(wb,y.add(wb,GO,y.add(wb,mE,y.add(wb,dE,y.add(wb,uE,UO)))),.2),y.scale(_b,Ha,S),jO(fE,_b,wb,dE,mE,GO,uE,UO),Te.addTriangleStrip(u,fE,MAe),Te.addTriangleFanWithNormal(u,fE,RAe,Ha),y.negate(Ha,Ha),Te.addTriangleFanWithNormal(u,fE,LAe,Ha));let{isPurine:A,isPyrimidine:I}=Lu(e,D);A?(Ou(P,e,D),Rm(P)&&(p.invariantPosition(P.N1,Sb),p.invariantPosition(P.C2,sE),p.invariantPosition(P.N3,lE),p.invariantPosition(P.C4,Cb),p.invariantPosition(P.C5,Tb),p.invariantPosition(P.C6,cE),p.invariantPosition(P.N7,Nte),p.invariantPosition(P.C8,Vte),p.invariantPosition(P.N9,zte),y.triangleNormal(Ha,Sb,Cb,Tb),y.scale(_b,Ha,S),jO(pE,_b,Sb,sE,lE,Cb,Tb,cE,Nte,Vte,zte),Te.addTriangleStrip(u,pE,DAe),Te.addTriangleFanWithNormal(u,pE,AAe,Ha),y.negate(Ha,Ha),Te.addTriangleFanWithNormal(u,pE,kAe,Ha))):I&&(Fu(P,e,D),Lm(P)&&(p.invariantPosition(P.N1,Sb),p.invariantPosition(P.C2,sE),p.invariantPosition(P.N3,lE),p.invariantPosition(P.C4,Cb),p.invariantPosition(P.C5,Tb),p.invariantPosition(P.C6,cE),y.triangleNormal(Ha,Sb,Cb,Tb),y.scale(_b,Ha,S),jO(hE,_b,Sb,sE,lE,Cb,Tb,cE),Te.addTriangleStrip(u,hE,BAe),Te.addTriangleFanWithNormal(u,hE,OAe,Ha),y.negate(Ha,Ha),Te.addTriangleFanWithNormal(u,hE,FAe,Ha))),++T}}let E=Te.getMesh(u),_=te.expand(te(),e.boundary.sphere,S);return E.setBoundingSphere(_),E}var HO=w(w({},Gr),Gte);function jte(t){return rn({defaultProps:g.getDefaultValues(HO),createGeometry:NAe,createLocationIterator:Xl.fromGroup,getLoci:Mu,eachLocation:Ru,setUpdateState:(e,r,n)=>{e.createGeometry=r.sizeFactor!==n.sizeFactor||r.thicknessFactor!==n.thicknessFactor}},t)}var qa=y(),Pn=y(),Xi=y(),Yi=y(),jo=y(),Ho=y(),Qi=y(),Bm=y(),Om=y(),pi=y(),fi=y(),Fm=y(),Yl=y(),Nm=y(),Vm=y(),gE=U(w(w({},Gr),qv),{sizeFactor:g.Numeric(.3,{min:0,max:10,step:.01}),radialSegments:g.Numeric(16,{min:2,max:56,step:2},ge.CustomQualityParamInfo),tryUseImpostor:g.Boolean(!0)});function Hte(t,e,r,n){return r.tryUseImpostor&&n&&n.extensions.fragDepth?zAe(t):GAe(t)}function VAe(t,e,r,n,o,i){if(!Pe.isAtomic(e))return xo.createEmpty(i);let a=e.nucleotideElements.length;if(!a)return xo.createEmpty(i);let s=a*15,l=Sh.create(s,s/4,i),{elements:c,model:u,conformation:d}=e,{chainAtomSegments:m,residueAtomSegments:p}=u.atomicHierarchy,{moleculeType:h}=u.atomicHierarchy.derived.residue,f=$r.transientSegments(m,c),b=$r.transientSegments(p,c),v=0,x=2;for(;f.hasNext;)for(b.setSegment(f.move());b.hasNext;){let{index:E}=b.move();if(Yo(h[E])){let _=Bu();Rh(_,e,E),Lh(_)&&(d.invariantPosition(_.C1_1,fi),d.invariantPosition(_.C2_1,Fm),d.invariantPosition(_.C3_1,Yl),d.invariantPosition(_.C4_1,Nm),d.invariantPosition(_.O4_1,Vm),d.invariantPosition(_.trace,qa),l.add(Yl[0],Yl[1],Yl[2],qa[0],qa[1],qa[2],1,!0,!0,x,v),l.add(Yl[0],Yl[1],Yl[2],Nm[0],Nm[1],Nm[2],1,!0,!0,x,v),l.add(Nm[0],Nm[1],Nm[2],Vm[0],Vm[1],Vm[2],1,!0,!0,x,v),l.add(Vm[0],Vm[1],Vm[2],fi[0],fi[1],fi[2],1,!0,!0,x,v),l.add(fi[0],fi[1],fi[2],Fm[0],Fm[1],Fm[2],1,!0,!0,x,v),l.add(Fm[0],Fm[1],Fm[2],Yl[0],Yl[1],Yl[2],1,!0,!0,x,v));let{isPurine:D,isPyrimidine:P}=Lu(e,E);D?(Ou(_,e,E),_.C1_1!==-1&&_.N9!==-1?(d.invariantPosition(_.C1_1,fi),d.invariantPosition(_.N9,pi),l.add(pi[0],pi[1],pi[2],fi[0],fi[1],fi[2],1,!0,!0,x,v)):_.N9!==-1&&_.trace!==-1&&(d.invariantPosition(_.N9,pi),d.invariantPosition(_.trace,qa),l.add(pi[0],pi[1],pi[2],qa[0],qa[1],qa[2],1,!0,!0,x,v)),Rm(_)&&(d.invariantPosition(_.N1,Pn),d.invariantPosition(_.C2,Xi),d.invariantPosition(_.N3,Yi),d.invariantPosition(_.C4,jo),d.invariantPosition(_.C5,Ho),d.invariantPosition(_.C6,Qi),d.invariantPosition(_.N7,Bm),d.invariantPosition(_.C8,Om),d.invariantPosition(_.N9,pi),l.add(pi[0],pi[1],pi[2],Om[0],Om[1],Om[2],1,!0,!0,x,v),l.add(Om[0],Om[1],Om[2],Bm[0],Bm[1],Bm[2],1,!0,!0,x,v),l.add(Bm[0],Bm[1],Bm[2],Ho[0],Ho[1],Ho[2],1,!0,!0,x,v),l.add(Ho[0],Ho[1],Ho[2],Qi[0],Qi[1],Qi[2],1,!0,!0,x,v),l.add(Qi[0],Qi[1],Qi[2],Pn[0],Pn[1],Pn[2],1,!0,!0,x,v),l.add(Pn[0],Pn[1],Pn[2],Xi[0],Xi[1],Xi[2],1,!0,!0,x,v),l.add(Xi[0],Xi[1],Xi[2],Yi[0],Yi[1],Yi[2],1,!0,!0,x,v),l.add(Yi[0],Yi[1],Yi[2],jo[0],jo[1],jo[2],1,!0,!0,x,v),l.add(jo[0],jo[1],jo[2],Ho[0],Ho[1],Ho[2],1,!0,!0,x,v),l.add(jo[0],jo[1],jo[2],pi[0],pi[1],pi[2],1,!0,!0,x,v))):P&&(Fu(_,e,E),_.C1_1!==-1&&_.N1!==-1?(d.invariantPosition(_.N1,Pn),d.invariantPosition(_.C1_1,fi),l.add(Pn[0],Pn[1],Pn[2],fi[0],fi[1],fi[2],1,!0,!0,x,v)):_.N1!==-1&&_.trace!==-1&&(d.invariantPosition(_.N1,Pn),d.invariantPosition(_.trace,qa),l.add(Pn[0],Pn[1],Pn[2],qa[0],qa[1],qa[2],1,!0,!0,x,v)),Lm(_)&&(d.invariantPosition(_.N1,Pn),d.invariantPosition(_.C2,Xi),d.invariantPosition(_.N3,Yi),d.invariantPosition(_.C4,jo),d.invariantPosition(_.C5,Ho),d.invariantPosition(_.C6,Qi),l.add(Pn[0],Pn[1],Pn[2],Qi[0],Qi[1],Qi[2],1,!0,!0,x,v),l.add(Qi[0],Qi[1],Qi[2],Ho[0],Ho[1],Ho[2],1,!0,!0,x,v),l.add(Ho[0],Ho[1],Ho[2],jo[0],jo[1],jo[2],1,!0,!0,x,v),l.add(jo[0],jo[1],jo[2],Yi[0],Yi[1],Yi[2],1,!0,!0,x,v),l.add(Yi[0],Yi[1],Yi[2],Xi[0],Xi[1],Xi[2],1,!0,!0,x,v),l.add(Xi[0],Xi[1],Xi[2],Pn[0],Pn[1],Pn[2],1,!0,!0,x,v))),++v}}let S=l.getCylinders(),T=te.expand(te(),e.boundary.sphere,1*o.sizeFactor);return S.setBoundingSphere(T),S}function zAe(t){return Wv({defaultProps:g.getDefaultValues(gE),createGeometry:VAe,createLocationIterator:Xl.fromGroup,getLoci:Mu,eachLocation:Ru,setUpdateState:(e,r,n)=>{e.createGeometry=r.sizeFactor!==n.sizeFactor},mustRecreate:(e,r,n)=>!r.tryUseImpostor||!n},t)}function UAe(t,e,r,n,o,i){if(!Pe.isAtomic(e))return Be.createEmpty(i);let a=e.nucleotideElements.length;if(!a)return Be.createEmpty(i);let{sizeFactor:s,radialSegments:l}=o,c=a*(l*15),u=Te.createState(c,c/4,i),{elements:d,model:m,conformation:p}=e,{chainAtomSegments:h,residueAtomSegments:f}=m.atomicHierarchy,{moleculeType:b}=m.atomicHierarchy.derived.residue,v=$r.transientSegments(h,d),x=$r.transientSegments(f,d),S={radiusTop:1*s,radiusBottom:1*s,radialSegments:l},T=0;for(;v.hasNext;)for(x.setSegment(v.move());x.hasNext;){let{index:D}=x.move();if(Yo(b[D])){let P=Bu();u.currentGroup=T,Rh(P,e,D),Lh(P)&&(p.invariantPosition(P.C1_1,fi),p.invariantPosition(P.C2_1,Fm),p.invariantPosition(P.C3_1,Yl),p.invariantPosition(P.C4_1,Nm),p.invariantPosition(P.O4_1,Vm),p.invariantPosition(P.trace,qa),nr(u,Yl,qa,1,S),nr(u,Yl,Nm,1,S),nr(u,Nm,Vm,1,S),nr(u,Vm,fi,1,S),nr(u,fi,Fm,1,S),nr(u,Fm,Yl,1,S));let{isPurine:A,isPyrimidine:I}=Lu(e,D);A?(Ou(P,e,D),P.C1_1!==-1&&P.N9!==-1?(p.invariantPosition(P.C1_1,fi),p.invariantPosition(P.N9,pi),nr(u,pi,fi,1,S)):P.N9!==-1&&P.trace!==-1&&(p.invariantPosition(P.N9,pi),p.invariantPosition(P.trace,qa),nr(u,pi,qa,1,S)),Rm(P)&&(p.invariantPosition(P.N1,Pn),p.invariantPosition(P.C2,Xi),p.invariantPosition(P.N3,Yi),p.invariantPosition(P.C4,jo),p.invariantPosition(P.C5,Ho),p.invariantPosition(P.C6,Qi),p.invariantPosition(P.N7,Bm),p.invariantPosition(P.C8,Om),p.invariantPosition(P.N9,pi),nr(u,pi,Om,1,S),nr(u,Om,Bm,1,S),nr(u,Bm,Ho,1,S),nr(u,Ho,Qi,1,S),nr(u,Qi,Pn,1,S),nr(u,Pn,Xi,1,S),nr(u,Xi,Yi,1,S),nr(u,Yi,jo,1,S),nr(u,jo,Ho,1,S),nr(u,jo,pi,1,S))):I&&(Fu(P,e,D),P.C1_1!==-1&&P.N1!==-1?(p.invariantPosition(P.N1,Pn),p.invariantPosition(P.C1_1,fi),nr(u,Pn,fi,1,S)):P.N1!==-1&&P.trace!==-1&&(p.invariantPosition(P.N1,Pn),p.invariantPosition(P.trace,qa),nr(u,Pn,qa,1,S)),Lm(P)&&(p.invariantPosition(P.N1,Pn),p.invariantPosition(P.C2,Xi),p.invariantPosition(P.N3,Yi),p.invariantPosition(P.C4,jo),p.invariantPosition(P.C5,Ho),p.invariantPosition(P.C6,Qi),nr(u,Pn,Qi,1,S),nr(u,Qi,Ho,1,S),nr(u,Ho,jo,1,S),nr(u,jo,Yi,1,S),nr(u,Yi,Xi,1,S),nr(u,Xi,Pn,1,S))),++T}}let E=Te.getMesh(u),_=te.expand(te(),e.boundary.sphere,1*o.sizeFactor);return E.setBoundingSphere(_),E}function GAe(t){return rn({defaultProps:g.getDefaultValues(gE),createGeometry:UAe,createLocationIterator:Xl.fromGroup,getLoci:Mu,eachLocation:Ru,setUpdateState:(e,r,n)=>{e.createGeometry=r.sizeFactor!==n.sizeFactor||r.radialSegments!==n.radialSegments},mustRecreate:(e,r,n)=>r.tryUseImpostor&&!!n},t)}var Pb=y(),Nu=y(),Vu=y(),zu=y(),Uu=y(),Dc=y(),Gu=y(),Eb=y(),Ib=y(),Db=y(),Ab=y(),kb=y(),Mb=y(),Rb=y(),Lb=y(),yE=U(w(w({},Gr),jv),{sizeFactor:g.Numeric(.3,{min:0,max:10,step:.01}),detail:g.Numeric(0,{min:0,max:3,step:1},ge.CustomQualityParamInfo),tryUseImpostor:g.Boolean(!0)});function qte(t,e,r,n){return r.tryUseImpostor&&n&&n.extensions.fragDepth?HAe(t):WAe(t)}function jAe(t,e,r,n,o,i){if(!Pe.isAtomic(e))return Ni.createEmpty(i);let a=e.nucleotideElements.length;if(!a)return Ni.createEmpty(i);let s=a*15,l=Op.create(s,s/4,i),{elements:c,model:u,conformation:d}=e,{chainAtomSegments:m,residueAtomSegments:p}=u.atomicHierarchy,{moleculeType:h}=u.atomicHierarchy.derived.residue,f=$r.transientSegments(m,c),b=$r.transientSegments(p,c),v=0;for(;f.hasNext;)for(b.setSegment(f.move());b.hasNext;){let{index:T}=b.move();if(Yo(h[T])){let E=Bu();Rh(E,e,T),Lh(E)&&(d.invariantPosition(E.C1_1,Ab),d.invariantPosition(E.C2_1,kb),d.invariantPosition(E.C3_1,Mb),d.invariantPosition(E.C4_1,Rb),d.invariantPosition(E.O4_1,Lb),d.invariantPosition(E.trace,Pb),l.add(Pb[0],Pb[1],Pb[2],v),l.add(Mb[0],Mb[1],Mb[2],v),l.add(Rb[0],Rb[1],Rb[2],v),l.add(Lb[0],Lb[1],Lb[2],v),l.add(Ab[0],Ab[1],Ab[2],v),l.add(kb[0],kb[1],kb[2],v));let{isPurine:_,isPyrimidine:D}=Lu(e,T);_?(Ou(E,e,T),Rm(E)&&(d.invariantPosition(E.N1,Nu),d.invariantPosition(E.C2,Vu),d.invariantPosition(E.N3,zu),d.invariantPosition(E.C4,Uu),d.invariantPosition(E.C5,Dc),d.invariantPosition(E.C6,Gu),d.invariantPosition(E.N7,Eb),d.invariantPosition(E.C8,Ib),d.invariantPosition(E.N9,Db),l.add(Db[0],Db[1],Db[2],v),l.add(Ib[0],Ib[1],Ib[2],v),l.add(Eb[0],Eb[1],Eb[2],v),l.add(Dc[0],Dc[1],Dc[2],v),l.add(Gu[0],Gu[1],Gu[2],v),l.add(Nu[0],Nu[1],Nu[2],v),l.add(Vu[0],Vu[1],Vu[2],v),l.add(zu[0],zu[1],zu[2],v),l.add(Uu[0],Uu[1],Uu[2],v))):D&&(Fu(E,e,T),Lm(E)&&(d.invariantPosition(E.N1,Nu),d.invariantPosition(E.C2,Vu),d.invariantPosition(E.N3,zu),d.invariantPosition(E.C4,Uu),d.invariantPosition(E.C5,Dc),d.invariantPosition(E.C6,Gu),l.add(Nu[0],Nu[1],Nu[2],v),l.add(Gu[0],Gu[1],Gu[2],v),l.add(Dc[0],Dc[1],Dc[2],v),l.add(Uu[0],Uu[1],Uu[2],v),l.add(zu[0],zu[1],zu[2],v),l.add(Vu[0],Vu[1],Vu[2],v))),++v}}let x=l.getSpheres(),S=te.expand(te(),e.boundary.sphere,1*o.sizeFactor);return x.setBoundingSphere(S),x}function HAe(t){return Hv({defaultProps:g.getDefaultValues(yE),createGeometry:jAe,createLocationIterator:Xl.fromGroup,getLoci:Mu,eachLocation:Ru,setUpdateState:(e,r,n)=>{e.createGeometry=r.sizeFactor!==n.sizeFactor},mustRecreate:(e,r,n)=>!r.tryUseImpostor||!n},t)}function qAe(t,e,r,n,o,i){if(!Pe.isAtomic(e))return Be.createEmpty(i);let a=e.nucleotideElements.length;if(!a)return Be.createEmpty(i);let{sizeFactor:s,detail:l}=o,c=a*Sd(l),u=Te.createState(c,c/2,i),{elements:d,model:m,conformation:p}=e,{chainAtomSegments:h,residueAtomSegments:f}=m.atomicHierarchy,{moleculeType:b}=m.atomicHierarchy.derived.residue,v=$r.transientSegments(h,d),x=$r.transientSegments(f,d),S=1*s,T=0;for(;v.hasNext;)for(x.setSegment(v.move());x.hasNext;){let{index:D}=x.move();if(Yo(b[D])){let P=Bu();u.currentGroup=T,Rh(P,e,D),Lh(P)&&(p.invariantPosition(P.C1_1,Ab),p.invariantPosition(P.C2_1,kb),p.invariantPosition(P.C3_1,Mb),p.invariantPosition(P.C4_1,Rb),p.invariantPosition(P.O4_1,Lb),p.invariantPosition(P.trace,Pb),Jt(u,Pb,S,l),Jt(u,Rb,S,l),Jt(u,Lb,S,l),Jt(u,Ab,S,l),Jt(u,kb,S,l),Jt(u,Mb,S,l));let{isPurine:A,isPyrimidine:I}=Lu(e,D);A?(Ou(P,e,D),Rm(P)&&(p.invariantPosition(P.N1,Nu),p.invariantPosition(P.C2,Vu),p.invariantPosition(P.N3,zu),p.invariantPosition(P.C4,Uu),p.invariantPosition(P.C5,Dc),p.invariantPosition(P.C6,Gu),p.invariantPosition(P.N7,Eb),p.invariantPosition(P.C8,Ib),p.invariantPosition(P.N9,Db),Jt(u,Ib,S,l),Jt(u,Eb,S,l),Jt(u,Dc,S,l),Jt(u,Gu,S,l),Jt(u,Nu,S,l),Jt(u,Vu,S,l),Jt(u,zu,S,l),Jt(u,Uu,S,l),Jt(u,Dc,S,l),Jt(u,Db,S,l))):I&&(Fu(P,e,D),Lm(P)&&(p.invariantPosition(P.N1,Nu),p.invariantPosition(P.C2,Vu),p.invariantPosition(P.N3,zu),p.invariantPosition(P.C4,Uu),p.invariantPosition(P.C5,Dc),p.invariantPosition(P.C6,Gu),Jt(u,Gu,S,l),Jt(u,Dc,S,l),Jt(u,Uu,S,l),Jt(u,zu,S,l),Jt(u,Vu,S,l),Jt(u,Nu,S,l))),++T}}let E=Te.getMesh(u),_=te.expand(te(),e.boundary.sphere,1*o.sizeFactor);return E.setBoundingSphere(_),E}function WAe(t){return rn({defaultProps:g.getDefaultValues(yE),createGeometry:qAe,createLocationIterator:Xl.fromGroup,getLoci:Mu,eachLocation:Ru,setUpdateState:(e,r,n)=>{e.createGeometry=r.sizeFactor!==n.sizeFactor||r.detail!==n.detail},mustRecreate:(e,r,n)=>r.tryUseImpostor&&!!n},t)}var Ey=y.zero(),Bb=y.zero(),Iy=y.zero(),Wte=y.zero(),Ki=tl(3,!1);function XAe(){let t=pd(8);for(let e=0;e<3;++e){let r=(e+1)%3;y.set(Ey,Ki[e*3],Ki[e*3+1],-.5),y.set(Bb,Ki[r*3],Ki[r*3+1],-.5),y.set(Iy,Ki[r*3],Ki[r*3+1],.5),y.set(Wte,Ki[e*3],Ki[e*3+1],.5),t.add(Ey,Bb,Iy),t.add(Iy,Wte,Ey)}return y.set(Ey,Ki[0],Ki[1],-.5),y.set(Bb,Ki[3],Ki[4],-.5),y.set(Iy,Ki[6],Ki[7],-.5),t.add(Iy,Bb,Ey),y.set(Ey,Ki[0],Ki[1],.5),y.set(Bb,Ki[3],Ki[4],.5),y.set(Iy,Ki[6],Ki[7],.5),t.add(Ey,Bb,Iy),t.getPrimitive()}var qO;function Xte(){return qO||(qO=XAe()),qO}var Dy=W.identity(),YAe=y.zero(),Yte=y.zero(),Qte=y.zero(),WO=y.zero(),QAe=4,KAe=4,$Ae=6,ZAe=Xte(),Kte={sizeFactor:g.Numeric(.2,{min:0,max:10,step:.01})},V8t=g.getDefaultValues(Kte);function JAe(t,e,r,n,o,i){let a=e.polymerElements.length;if(!a)return Be.createEmpty(i);let{sizeFactor:s}=o,l=a*24,c=Te.createState(l,l/10,i),d=gb(1),{normalVectors:m,binormalVectors:p}=d,h=0,f=mb(e,r);for(;f.hasNext;){let x=f.move();c.currentGroup=h;let S=Yo(x.moleculeType),T=ts.is(x.secStrucType,4);if(yb(d,x,S||T?.5:.9,S?.3:.5),T&&!x.secStrucLast||!T){let D=n.size.size(x.center)*s,P=QAe*D,A=KAe*D,I=$Ae*D,k=S?p:m;y.fromArray(Yte,k,0),y.fromArray(Qte,k,3),y.normalize(WO,y.add(WO,Yte,Qte)),W.targetTo(Dy,x.p3,x.p1,WO),W.mul(Dy,Dy,W.rotY90Z180),W.scale(Dy,Dy,y.set(YAe,I,A,P)),W.setTranslation(Dy,x.p2),Te.addPrimitive(c,Dy,ZAe)}++h}let b=Te.getMesh(c),v=te.expand(te(),e.boundary.sphere,1*o.sizeFactor);return b.setBoundingSphere(v),b}var XO=w(w({},Gr),Kte);function $te(t){return rn({defaultProps:g.getDefaultValues(XO),createGeometry:JAe,createLocationIterator:e=>Wl.fromGroup(e),getLoci:Au,eachLocation:ku,setUpdateState:(e,r,n)=>{e.createGeometry=r.sizeFactor!==n.sizeFactor}},t)}var YO=10,Zte={sizeFactor:g.Numeric(.2,{min:0,max:10,step:.01}),radialSegments:g.Numeric(16,{min:2,max:56,step:2},ge.CustomQualityParamInfo)},$8t=g.getDefaultValues(Zte);function eke(t,e,r,n,o,i){let a=e.gapElements.length;if(!a)return Be.createEmpty(i);let{sizeFactor:s,radialSegments:l}=o,c=YO*l*2*a*2,u=Te.createState(c,c/10,i),d=y(),m=y(),p={radiusTop:1,radiusBottom:1,topCap:!0,bottomCap:!0,radialSegments:l},h=0,f=ute(r,e);for(;f.hasNext;){let{centerA:x,centerB:S}=f.move();x.element===S.element||(e.conformation.invariantPosition(x.element,d),e.conformation.invariantPosition(S.element,m),p.radiusTop=p.radiusBottom=n.size.size(x)*s,u.currentGroup=h,Xg(u,d,m,.5,YO,!1,p),p.radiusTop=p.radiusBottom=n.size.size(S)*s,u.currentGroup=h+1,Xg(u,m,d,.5,YO,!1,p)),h+=2}let b=Te.getMesh(u),v=te.expand(te(),e.boundary.sphere,1*o.sizeFactor);return b.setBoundingSphere(v),b}var Ay=w(w({},Gr),Zte);function Ob(t){return rn({defaultProps:g.getDefaultValues(Ay),createGeometry:eke,createLocationIterator:KP.fromGroup,getLoci:Cte,eachLocation:Tte,setUpdateState:(e,r,n)=>{e.createGeometry=r.sizeFactor!==n.sizeFactor||r.radialSegments!==n.radialSegments}},t)}var kr=y(),nn=y(),tke=y(),Ac=y(),zm=y(),vE=y(),bE=y(),YS=y(),Ud=y(),Um=y(),QO=y(),Fh=y(),Nh=y(),Vh=y(),zh=y(),ju=y.fromArray,Fb=y.scale,Hu=y.add,Np=y.sub,rke=y.magnitude,Jte=y.negate,KO=y.copy,ere=y.cross,nke=y.set,mn=he.add3,oke=he.add;function xE(t,e,r,n,o,i,a,s,l){let{vertices:c,normals:u,indices:d}=e,m=c.elementCount;if(ju(kr,n,t),Fb(bE,kr,a),Fb(vE,kr,s),ju(nn,o,t),Fb(Ac,nn,i),ere(Um,nn,kr),ju(Ud,r,t),Hu(Fh,Hu(Fh,Ud,Ac),vE),Np(Nh,Hu(Nh,Ud,Ac),bE),Np(Vh,Np(Vh,Ud,Ac),bE),Hu(zh,Np(zh,Ud,Ac),vE),a<s?(mn(c,zh[0],zh[1],zh[2]),mn(c,Vh[0],Vh[1],Vh[2]),mn(c,Nh[0],Nh[1],Nh[2]),mn(c,Fh[0],Fh[1],Fh[2]),KO(zm,vE)):(mn(c,Fh[0],Fh[1],Fh[2]),mn(c,Nh[0],Nh[1],Nh[2]),mn(c,Vh[0],Vh[1],Vh[2]),mn(c,zh[0],zh[1],zh[2]),KO(zm,bE)),l){for(let p=0;p<4;++p)mn(u,-Um[0],-Um[1],-Um[2]);mn(d,m,m+1,m+2),mn(d,m+2,m+3,m)}else{for(let p=0;p<4;++p)mn(u,Um[0],Um[1],Um[2]);mn(d,m+2,m+1,m),mn(d,m,m+3,m+2)}}function Nb(t,e,r,n,o,i,a,s,l,c){let{currentGroup:u,vertices:d,normals:m,indices:p,groups:h}=t,f=d.elementCount,b=0;s>0?(ju(kr,e,0),ju(nn,e,o*3),b=s/rke(Np(tke,nn,kr))):nke(YS,0,0,0);for(let x=0;x<=o;++x){let S=i[x],T=a[x],E=s===0?T:s*(1-x/o),_=x*3;ju(zm,r,_),Fb(zm,zm,E),ju(Ac,n,_),Fb(Ac,Ac,S),s>0&&(ju(kr,r,_),ju(nn,n,_),Fb(YS,ere(YS,kr,nn),b)),ju(Ud,e,_),ju(Um,r,_),ju(QO,n,_),Hu(kr,Hu(kr,Ud,Ac),zm),Hu(nn,Um,YS),mn(d,kr[0],kr[1],kr[2]),mn(m,nn[0],nn[1],nn[2]),Hu(kr,Np(kr,Ud,Ac),zm),mn(d,kr[0],kr[1],kr[2]),mn(m,nn[0],nn[1],nn[2]),Jte(nn,QO),mn(d,kr[0],kr[1],kr[2]),mn(m,nn[0],nn[1],nn[2]),Np(kr,Np(kr,Ud,Ac),zm),mn(d,kr[0],kr[1],kr[2]),mn(m,nn[0],nn[1],nn[2]),Hu(nn,Jte(nn,Um),YS),mn(d,kr[0],kr[1],kr[2]),mn(m,nn[0],nn[1],nn[2]),Np(kr,Hu(kr,Ud,Ac),zm),mn(d,kr[0],kr[1],kr[2]),mn(m,nn[0],nn[1],nn[2]),KO(nn,QO),mn(d,kr[0],kr[1],kr[2]),mn(m,nn[0],nn[1],nn[2]),Hu(kr,Hu(kr,Ud,Ac),zm),mn(d,kr[0],kr[1],kr[2]),mn(m,nn[0],nn[1],nn[2])}for(let x=0;x<o;++x){for(let S=0;S<2;S++)mn(p,f+x*8+2*S,f+(x+1)*8+2*S+1,f+x*8+2*S+1),mn(p,f+x*8+2*S,f+(x+1)*8+2*S,f+(x+1)*8+2*S+1);for(let S=2;S<4;S++)mn(p,f+x*8+2*S,f+(x+1)*8+2*S,f+x*8+2*S+1),mn(p,f+(x+1)*8+2*S,f+(x+1)*8+2*S+1,f+x*8+2*S+1)}if(l){let x=i[0],S=a[0],T=s===0?S:s;xE(0,t,e,r,n,x,T,T,!1)}else if(s>0){let x=i[0],S=a[0];xE(0,t,e,r,n,x,s,-S,!1),xE(0,t,e,r,n,x,-s,S,!1)}if(c&&s===0){let x=i[o],S=a[o];xE(o*3,t,e,r,n,x,S,S,!0)}let v=(o+1)*8+(l?4:s>0?8:0)+(c&&s===0?4:0);for(let x=0,S=v;x<S;++x)oke(h,u)}var ni=y(),wi=y(),gl=y(),Wa=y(),Fs=y();function SE(t,e,r,n,o){t[0]=e[0]*n+r[0]*o,t[1]=e[1]*n+r[1]*o,t[2]=e[2]*n+r[2]*o}function Vb(t,e,r,n,o,i){t[0]=e[0]*o+r[0]*i+n[0],t[1]=e[1]*o+r[1]*i+n[1],t[2]=e[2]*o+r[2]*i+n[2]}var Vp=y.fromArray,ike=y.normalize,$O=y.scaleAndAdd,tre=y.cross,ake=y.dot,ske=y.unitX,Ns=he.add3,ZO=new Map;function lke(t,e){let r=e?1:0,n=rm(t,r);if(!ZO.has(n)){let o=[],i=[];for(let a=0;a<t;++a){let s=(a*2+r)/t*Math.PI;o[a]=Math.cos(s),i[a]=Math.sin(s)}ZO.set(n,{cos:o,sin:i})}return ZO.get(n)}function QS(t,e,r,n,o,i,a,s,l,c,u){let{currentGroup:d,vertices:m,normals:p,indices:h,groups:f}=t,b=m.elementCount,{cos:v,sin:x}=lke(i,u==="rounded"),S=Math.round(i/4),T=S*3;for(let D=0;D<=o;++D){let P=D*3;Vp(Wa,r,P),Vp(Fs,n,P),Vp(gl,e,P);let A=a[D],I=s[D],k=u==="rounded"&&I>A;for(let M=0;M<i;++M){if(k){Vb(wi,Wa,Fs,gl,A*v[M],A*x[M]);let R=ake(Fs,ske)<0?M<S||M>=T?I-A:-I+A:M>=S&&M<T?-I+A:I-A;$O(wi,wi,Wa,R),M===S||M===S-1?SE(ni,Wa,Fs,0,1):M===T||M===T-1?SE(ni,Wa,Fs,0,-1):SE(ni,Wa,Fs,v[M],x[M])}else Vb(wi,Wa,Fs,gl,I*v[M],A*x[M]),SE(ni,Wa,Fs,A*v[M],I*x[M]);ike(ni,ni),Ns(m,wi[0],wi[1],wi[2]),Ns(p,ni[0],ni[1],ni[2])}}let E=Math.round(i/2);for(let D=0;D<o;++D){for(let P=0;P<E;++P)Ns(h,b+D*i+(P+1)%i,b+(D+1)*i+(P+1)%i,b+D*i+P),Ns(h,b+(D+1)*i+(P+1)%i,b+(D+1)*i+P,b+D*i+P);for(let P=E;P<i;++P)Ns(h,b+D*i+(P+1)%i,b+(D+1)*i+P,b+D*i+P),Ns(h,b+(D+1)*i+(P+1)%i,b+(D+1)*i+P,b+D*i+(P+1)%i)}if(l){let P=m.elementCount;Vp(Wa,r,0),Vp(Fs,n,0),Vp(gl,e,0),tre(ni,Fs,Wa),Ns(m,gl[0],gl[1],gl[2]),Ns(p,ni[0],ni[1],ni[2]);let A=a[0],I=s[0],k=u==="rounded"&&I>A;k&&(I-=A),b=m.elementCount;for(let M=0;M<i;++M)k?(Vb(wi,Wa,Fs,gl,A*v[M],A*x[M]),$O(wi,wi,Wa,M<S||M>=T?I:-I)):Vb(wi,Wa,Fs,gl,I*v[M],A*x[M]),Ns(m,wi[0],wi[1],wi[2]),Ns(p,ni[0],ni[1],ni[2]),Ns(h,b+(M+1)%i,b+M,P)}if(c){let D=o*3,P=m.elementCount;Vp(Wa,r,D),Vp(Fs,n,D),Vp(gl,e,D),tre(ni,Wa,Fs),Ns(m,gl[0],gl[1],gl[2]),Ns(p,ni[0],ni[1],ni[2]);let A=a[o],I=s[o],k=u==="rounded"&&I>A;k&&(I-=A),b=m.elementCount;for(let M=0;M<i;++M)k?(Vb(wi,Wa,Fs,gl,A*v[M],A*x[M]),$O(wi,wi,Wa,M<S||M>=T?I:-I)):Vb(wi,Wa,Fs,gl,I*v[M],A*x[M]),Ns(m,wi[0],wi[1],wi[2]),Ns(p,ni[0],ni[1],ni[2]),Ns(h,b+M,b+(M+1)%i,P)}let _=(o+1)*i+(l?i+1:0)+(c?i+1:0);he.addRepeat(f,_,d)}var zp=y.fromArray,cke=y.magnitude,JO=y.sub,rre=y.add,eF=y.scale,uke=y.negate,dke=y.copy,mke=y.cross,qu=he.add3,pke=he.add,$i=y(),Xa=y(),fke=y(),tF=y(),ky=y(),nre=y(),KS=y(),hke=y(),rF=y();function zb(t,e,r,n,o,i,a,s){let{currentGroup:l,vertices:c,normals:u,indices:d,groups:m}=t,p=c.elementCount,h=0;s>0&&(zp($i,e,0),zp(Xa,e,o*3),h=s/cke(JO(fke,Xa,$i)));for(let b=0;b<=o;++b){let v=i[b],x=a[b],S=s===0?x:s*(1-b/o),T=b*3;zp(ky,r,T),eF(ky,ky,S),zp(tF,n,T),eF(tF,tF,v),s>0&&(zp($i,r,T),zp(Xa,n,T),eF(nre,mke(nre,$i,Xa),h)),zp(KS,e,T),zp(hke,r,T),zp(rF,n,T),rre($i,KS,ky),uke(Xa,rF),qu(c,$i[0],$i[1],$i[2]),qu(u,Xa[0],Xa[1],Xa[2]),JO($i,KS,ky),qu(c,$i[0],$i[1],$i[2]),qu(u,Xa[0],Xa[1],Xa[2]),rre($i,KS,ky),dke(Xa,rF),qu(c,$i[0],$i[1],$i[2]),qu(u,Xa[0],Xa[1],Xa[2]),JO($i,KS,ky),qu(c,$i[0],$i[1],$i[2]),qu(u,Xa[0],Xa[1],Xa[2])}for(let b=0;b<o;++b)qu(d,p+b*4,p+(b+1)*4+1,p+b*4+1),qu(d,p+b*4,p+(b+1)*4,p+(b+1)*4+1),qu(d,p+b*4+2+1,p+(b+1)*4+2+1,p+b*4+2),qu(d,p+b*4+2,p+(b+1)*4+2+1,p+(b+1)*4+2);let f=(o+1)*4;for(let b=0,v=f;b<v;++b)pke(m,l)}var ore={sizeFactor:g.Numeric(.2,{min:0,max:10,step:.01}),aspectRatio:g.Numeric(5,{min:.1,max:10,step:.1}),arrowFactor:g.Numeric(1.5,{min:0,max:3,step:.1},{description:"Size factor for sheet arrows"}),tubularHelices:g.Boolean(!1,{description:"Draw alpha helices as tubes"}),helixProfile:g.Select("elliptical",g.arrayToOptions(["elliptical","rounded","square"]),{description:"Protein helix trace profile"}),nucleicProfile:g.Select("square",g.arrayToOptions(["elliptical","rounded","square"]),{description:"Nucleic strand trace profile"}),detail:g.Numeric(0,{min:0,max:3,step:1},ge.CustomQualityParamInfo),linearSegments:g.Numeric(8,{min:1,max:48,step:1},ge.CustomQualityParamInfo),radialSegments:g.Numeric(16,{min:2,max:56,step:2},ge.CustomQualityParamInfo)},w9t=g.getDefaultValues(ore),Ql=y();function gke(t,e,r,n,o,i){let a=e.polymerElements.length;if(!a)return Be.createEmpty(i);let{sizeFactor:s,detail:l,linearSegments:c,radialSegments:u,aspectRatio:d,arrowFactor:m,tubularHelices:p,helixProfile:h,nucleicProfile:f}=o,b=c*u*a+(u+1)*a*2,v=Te.createState(b,b/10,i),x=Pe.isCoarse(e),S=gb(c),{curvePoints:T,normalVectors:E,binormalVectors:_,widthValues:D,heightValues:P}=S,A=0,I=mb(e,r,{ignoreSecondaryStructure:!1,useHelixOrientation:p});for(;I.hasNext;){let R=I.move();v.currentGroup=A;let B=Yo(R.moleculeType),F=ts.is(R.secStrucType,4),G=ts.is(R.secStrucType,2),V=G&&!p?Ste:$P,H=B?Py:_y;yb(S,R,V,H);let Q=n.size.size(R.centerPrev)*s,L=n.size.size(R.center)*s,Y=n.size.size(R.centerNext)*s;x&&(Q*=d/2,L*=d/2,Y*=d/2);let j=R.secStrucFirst||R.coarseBackboneFirst||R.first,O=R.secStrucLast||R.coarseBackboneLast||R.last,J=c;if(R.initial){J=Math.max(Math.round(c*H),1);let $=c-J;T.copyWithin(0,$*3),_.copyWithin(0,$*3),E.copyWithin(0,$*3),y.fromArray(Ql,T,3),y.normalize(Ql,y.sub(Ql,R.p2,Ql)),y.scaleAndAdd(Ql,R.p2,Ql,L*vb),y.toArray(Ql,T,0)}else R.final&&(J=Math.max(Math.round(c*(1-H)),1),y.fromArray(Ql,T,J*3-3),y.normalize(Ql,y.sub(Ql,R.p2,Ql)),y.scaleAndAdd(Ql,R.p2,Ql,L*vb),y.toArray(Ql,T,J*3));if(R.initial===!0&&R.final===!0)Jt(v,R.p2,L*2,l);else if(F){let $=Q*d,ae=L*d,Z=Y*d,se=R.secStrucLast?ae*m:0;WS(S,Q,L,Y,$,ae,Z,H),u===2?zb(v,T,E,_,J,D,P,se):Nb(v,T,E,_,J,D,P,se,j,O)}else{let $,ae,Z;G&&!R.isCoarseBackbone?p?(Q*=d*1.5,L*=d*1.5,Y*=d*1.5,$=Q,ae=L,Z=Y):($=Q*d,ae=L*d,Z=Y*d):B&&!R.isCoarseBackbone?($=Q*d,ae=L*d,Z=Y*d):($=Q,ae=L,Z=Y),WS(S,Q,L,Y,$,ae,Z,H);let[se,Me]=B&&!R.isCoarseBackbone?[_,E]:[E,_];if(B&&!R.isCoarseBackbone)for(let _e=0,je=se.length;_e<je;_e++)se[_e]*=-1;let be=B?f:h;u===2?B&&!R.isCoarseBackbone?zb(v,T,se,Me,J,P,D,0):zb(v,T,se,Me,J,D,P,0):u===4?Nb(v,T,se,Me,J,D,P,0,j,O):ae===L?QS(v,T,se,Me,J,u,D,P,j,O,"elliptical"):be==="square"?Nb(v,T,se,Me,J,D,P,0,j,O):QS(v,T,se,Me,J,u,D,P,j,O,be)}++A}let k=Te.getMesh(v),M=te.expand(te(),e.boundary.sphere,1*o.sizeFactor);return k.setBoundingSphere(M),k}var nF=w(w({},Gr),ore);function ire(t){return rn({defaultProps:g.getDefaultValues(nF),createGeometry:gke,createLocationIterator:e=>Wl.fromGroup(e,{asSecondary:!0}),getLoci:Au,eachLocation:ku,setUpdateState:(e,r,n,o,i,a,s)=>{e.createGeometry=r.sizeFactor!==n.sizeFactor||r.tubularHelices!==n.tubularHelices||r.detail!==n.detail||r.linearSegments!==n.linearSegments||r.radialSegments!==n.radialSegments||r.aspectRatio!==n.aspectRatio||r.arrowFactor!==n.arrowFactor||r.helixProfile!==n.helixProfile||r.nucleicProfile!==n.nucleicProfile;let l=xs.get(a.structure).version;e.info.secondaryStructureHash!==l&&(e.info.secondaryStructureHash!==void 0&&(e.createGeometry=!0),e.info.secondaryStructureHash=l)}},t)}var are={"polymer-trace":(t,e)=>Dr("Polymer trace mesh",t,e,ire),"polymer-gap":(t,e)=>Dr("Polymer gap cylinder",t,e,Ob),"nucleotide-block":(t,e)=>Dr("Nucleotide block mesh",t,e,kte),"nucleotide-ring":(t,e)=>Dr("Nucleotide ring mesh",t,e,Fte),"nucleotide-atomic-ring-fill":(t,e)=>Dr("Nucleotide atomic ring fill",t,e,jte),"nucleotide-atomic-bond":(t,e)=>Dr("Nucleotide atomic bond",t,e,Hte),"nucleotide-atomic-element":(t,e)=>Dr("Nucleotide atomic element",t,e,qte),"direction-wedge":(t,e)=>Dr("Polymer direction wedge",t,e,$te)},sre=U(w(w(w(w(w(w(w(w({},nF),Ay),VO),zO),gE),yE),HO),XO),{sizeFactor:g.Numeric(.2,{min:0,max:10,step:.01}),visuals:g.MultiSelect(["polymer-trace","polymer-gap","nucleotide-ring","nucleotide-atomic-ring-fill","nucleotide-atomic-bond","nucleotide-atomic-element"],g.objectToOptions(are)),bumpFrequency:g.Numeric(2,{min:0,max:10,step:.1},ge.ShadingCategory),colorMode:g.Select("default",g.arrayToOptions(["default","interpolate"]),U(w({},ge.ShadingCategory),{isHidden:!0}))});function yke(t,e){let r=g.clone(sre),n=!1,o=!1;return e.units.forEach(i=>{!n&&Pe.isAtomic(i)&&i.nucleotideElements.length&&(n=!0),!o&&i.gapElements.length&&(o=!0)}),r.visuals.defaultValue=["polymer-trace"],n&&r.visuals.defaultValue.push("nucleotide-ring"),o&&r.visuals.defaultValue.push("polymer-gap"),r}function vke(t,e){return rt.createMulti("Cartoon",t,e,Qr,are)}var lre={name:"cartoon",label:"Cartoon",description:"Displays ribbons, planks, tubes smoothly following the trace atoms of polymers.",factory:vke,getParams:yke,defaultValues:g.getDefaultValues(sre),defaultColorTheme:{name:"chain-id"},defaultSizeTheme:{name:"uniform"},isApplicable:t=>t.polymerResidueCount>0,ensureCustomProperties:{attach:(t,e)=>N(void 0,null,function*(){yield xs.attach(t,e,void 0,!0);for(let r of e.models)yield HS.attach(t,r,void 0,!0)}),detach:t=>{xs.ref(t,!1);for(let e of t.models)HS.ref(e,!1)}}};var oF=U(w({},Gr),{sizeFactor:g.Numeric(1,{min:0,max:10,step:.1}),detail:g.Numeric(0,{min:0,max:3,step:1},ge.CustomQualityParamInfo),ignoreHydrogens:g.Boolean(!1)});function cre(t){return rn({defaultProps:g.getDefaultValues(oF),createGeometry:bke,createLocationIterator:jn.fromGroup,getLoci:Wi,eachLocation:qi,setUpdateState:(e,r,n)=>{e.createGeometry=r.sizeFactor!==n.sizeFactor||r.detail!==n.detail||r.ignoreHydrogens!==n.ignoreHydrogens}},t)}function bke(t,e,r,n,o,i){let{child:a}=r,s=a?.unitMap.get(e.id);if(a&&!s)return Be.createEmpty(i);let{detail:l,sizeFactor:c,ignoreHydrogens:u}=o,{elements:d,model:m}=e,{atomicNumber:p}=e.model.atomicHierarchy.derived.atom,h=d.length,f=h*Sd(l),b=Te.createState(f,f/2,i),v=hf.Provider.get(m);if(!v)return Be.createEmpty(i);let x=y(),S=Dt(),T=y(),E=y(),_=y(),{elementToAnsiotrop:D,data:P}=v,{U:A}=P,I=P._schema.U.space,k=e.conformation,M=z.Location.create(r);M.unit=e;for(let F=0;F<h;F++){let G=d[F],V=D[G];if(V!==-1&&!(s&&!tr.has(s.elements,G)||u&&tZ(p,G))){M.element=G,k.invariantPosition(G,x),b.currentGroup=F,er.toMat3(S,I,A.value(V)),Dt.symmtricFromLower(S,S),Dt.symmetricEigenvalues(T,S),Dt.eigenvector(E,S,T[1]),Dt.eigenvector(_,S,T[2]);for(let H=0;H<3;++H)T[H]=c*1.5958*Math.sqrt(Math.abs(T[H]));bs(T[0],T[1],1e-6)&&bs(T[1],T[2],1e-6)?Jt(b,x,T[0],l):Cv(b,x,_,E,T,l)}}let R=Te.getMesh(b),B=te.expand(te(),(s||e).boundary.sphere,1*c);return R.setBoundingSphere(B),R}var ure={"ellipsoid-mesh":(t,e)=>Dr("Ellipsoid Mesh",t,e,cre),"intra-bond":(t,e)=>Dr("Intra-unit bond cylinder",t,e,GP),"inter-bond":(t,e)=>_o("Inter-unit bond cylinder",t,e,jP)},dre=U(w(w(w({},oF),lb),cb),{includeParent:g.Boolean(!1),adjustCylinderLength:g.Boolean(!1,{isHidden:!0}),unitKinds:Ip(["atomic"]),sizeFactor:g.Numeric(1,{min:.01,max:10,step:.01}),sizeAspectRatio:g.Numeric(.1,{min:.01,max:3,step:.01}),linkCap:g.Boolean(!0),visuals:g.MultiSelect(["ellipsoid-mesh","intra-bond","inter-bond"],g.objectToOptions(ure)),bumpFrequency:g.Numeric(0,{min:0,max:10,step:.1},ge.ShadingCategory)});function xke(t,e){return dre}function Ske(t,e){return rt.createMulti("Ellipsoid",t,e,Qr,ure)}var mre={name:"ellipsoid",label:"Ellipsoid",description:"Displays anisotropic displacement ellipsoids of atomic elements plus bonds as cylinders.",factory:Ske,getParams:xke,defaultValues:g.getDefaultValues(dre),defaultColorTheme:{name:"element-symbol"},defaultSizeTheme:{name:"uniform"},isApplicable:t=>t.elementCount>0&&t.models.some(e=>hf.Provider.isApplicable(e)),getData:(t,e)=>e.includeParent?t.asParent():t,mustRecreate:(t,e)=>t.includeParent!==e.includeParent};var pre=`
precision highp float;

attribute vec3 aPosition;
attribute float aRadius;

varying vec3 vPosition;
varying float vRadiusSqInv;

#if defined(dCalcType_groupId)
    attribute float aGroup;
    varying float vGroup;
#endif

uniform vec3 uBboxSize;
uniform vec3 uBboxMin;
uniform float uResolution;

void main() {
    vRadiusSqInv = 1.0 / (aRadius * aRadius);
    #if defined(dCalcType_groupId)
        vGroup = aGroup;
    #endif
    gl_PointSize = ceil(((aRadius * 3.0) / uResolution) + uResolution);
    vPosition = (aPosition - uBboxMin) / uResolution;
    gl_Position = vec4(((aPosition - uBboxMin) / uBboxSize) * 2.0 - 1.0, 1.0);
}
`;var fre=`
precision highp float;

varying vec3 vPosition;
varying float vRadiusSqInv;
#if defined(dCalcType_groupId)
    #if defined(dGridTexType_2d)
        precision highp sampler2D;
        uniform sampler2D tMinDistanceTex;
        uniform vec3 uGridTexDim;
    #elif defined(dGridTexType_3d)
        precision highp sampler3D;
        uniform sampler3D tMinDistanceTex;
    #endif
    varying float vGroup;
#endif

#include common

uniform vec3 uGridDim;
uniform vec2 uGridTexScale;
uniform float uCurrentSlice;
uniform float uCurrentX;
uniform float uCurrentY;
uniform float uAlpha;
uniform float uResolution;
uniform float uRadiusFactorInv;

void main() {
    vec2 v = gl_FragCoord.xy - vec2(uCurrentX, uCurrentY) - 0.5;
    vec3 fragPos = vec3(v.x, v.y, uCurrentSlice);
    float dist = distance(fragPos, vPosition) * uResolution;

    #if defined(dCalcType_density)
        float density = exp(-uAlpha * ((dist * dist) * vRadiusSqInv));
        gl_FragColor.a = density * uRadiusFactorInv;
    #elif defined(dCalcType_minDistance)
        gl_FragColor.a = 1.0 - dist * uRadiusFactorInv;
    #elif defined(dCalcType_groupId)
        #if defined(dGridTexType_2d)
            float minDistance = 1.0 - texture2D(tMinDistanceTex, (gl_FragCoord.xy) / (uGridTexDim.xy / uGridTexScale)).a;
        #elif defined(dGridTexType_3d)
            float minDistance = 1.0 - texelFetch(tMinDistanceTex, ivec3(gl_FragCoord.xy, uCurrentSlice), 0).a;
        #endif
        if (dist * uRadiusFactorInv > minDistance + uResolution * 0.05)
            discard;
        gl_FragColor.rgb = packIntToRGB(vGroup);
    #endif
}
`;var Cke={drawCount:Mr("number"),instanceCount:Mr("number"),aRadius:hr("float32",1,0),aPosition:hr("float32",3,0),aGroup:hr("float32",1,0),uCurrentSlice:ee("f"),uCurrentX:ee("f"),uCurrentY:ee("f"),uBboxMin:ee("v3","material"),uBboxSize:ee("v3","material"),uGridDim:ee("v3","material"),uGridTexDim:ee("v3","material"),uGridTexScale:ee("v2","material"),uAlpha:ee("f","material"),uResolution:ee("f","material"),uRadiusFactorInv:ee("f","material"),tMinDistanceTex:We("texture","rgba","float","nearest","material"),dGridTexType:Ye("string",["2d","3d"]),dCalcType:Ye("string",["density","minDistance","groupId"])},Gm="gaussian-density";function hre(t){return t.namedFramebuffers[Gm]||(t.namedFramebuffers[Gm]=t.resources.framebuffer()),t.namedFramebuffers[Gm]}function gre(t,e,r,n,o,i){let a=`${Gm}-${t}`;return e.namedTextures[a]||(e.namedTextures[a]=e.resources.texture(r,n,o,i)),e.namedTextures[a]}function iF(t,e,r,n,o,i){return t.isWebGL2?Tke(t,e,r,n,o,i):CE(t,e,r,n,!1,o,i)}function CE(t,e,r,n,o,i,a){Ee&&t.timer.mark("GaussianDensityTexture2d");let s=_ke(t,e,r,n,o,i,a);return Ee&&t.timer.markEnd("GaussianDensityTexture2d"),yre(s)}function Tke(t,e,r,n,o,i){Ee&&t.timer.mark("GaussianDensityTexture3d");let a=Pke(t,e,r,n,o,i);return Ee&&t.timer.markEnd("GaussianDensityTexture3d"),yre(a)}function yre({texture:t,scale:e,bbox:r,gridDim:n,gridTexDim:o,gridTexScale:i,radiusFactor:a,resolution:s,maxRadius:l}){return{transform:wke(e,r),texture:t,bbox:r,gridDim:n,gridTexDim:o,gridTexScale:i,radiusFactor:a,resolution:s,maxRadius:l}}function wke(t,e){let r=W.identity();return W.fromScaling(r,t),W.setTranslation(r,e.min),r}function _ke(t,e,r,n,o,i,a){let{gl:s,resources:l,state:c,extensions:{colorBufferFloat:u,textureFloat:d,colorBufferHalfFloat:m,textureHalfFloat:p,blendMinMax:h}}=t,{smoothness:f,resolution:b}=i,{drawCount:v,positions:x,radii:S,groups:T,scale:E,expandedBox:_,dim:D,maxRadius:P}=vre(e,r,n,i),[A,I,k]=D,{texDimX:M,texDimY:R,texCols:B,powerOfTwoSize:F}=Ike(D),G=y.create(M,R,0),V=ne.create(M/F,R/F),H=P*2,Q=o?F:M,L=o?F:R,Y=gre("min-dist-2d",t,"image-uint8","rgba","ubyte","nearest");Y.define(Q,L);let j=bre(t,v,x,S,T,Y,_,D,G,V,f,b,H),{uCurrentSlice:O,uCurrentX:J,uCurrentY:$}=j.values,ae=hre(t);ae.bind(),xre(t),a||(a=m&&p?l.texture("image-float16","rgba","fp16","linear"):u&&d?l.texture("image-float32","rgba","float","linear"):l.texture("image-uint8","rgba","ubyte","linear")),a.define(Q,L);function Z(se,Me){c.currentRenderItemId=-1,se.attachFramebuffer(ae,0),Me&&(c.viewport(0,0,Q,L),c.scissor(0,0,Q,L),s.clear(s.COLOR_BUFFER_BIT)),C.update($,0);let be=0,_e=0,je=0;for(let gt=0;gt<k;++gt)be>=B&&(be-=B,_e+=I,je=0,C.update($,_e)),C.update(J,je),C.update(O,gt),c.viewport(je,_e,A,I),c.scissor(je,_e,A,I),j.render(),++be,je+=A;s.flush()}return Cre(t,j),Z(a,!0),h&&(Sre(t,j),Z(Y,!0),Tre(t,j),Z(a,!1)),{texture:a,scale:E,bbox:_,gridDim:D,gridTexDim:G,gridTexScale:V,radiusFactor:H,resolution:b,maxRadius:P}}function Pke(t,e,r,n,o,i){let{gl:a,resources:s,state:l,extensions:{colorBufferFloat:c,textureFloat:u,colorBufferHalfFloat:d,textureHalfFloat:m}}=t,{smoothness:p,resolution:h}=o,{drawCount:f,positions:b,radii:v,groups:x,scale:S,expandedBox:T,dim:E,maxRadius:_}=vre(e,r,n,o),[D,P,A]=E,I=gre("min-dist-3d",t,"volume-uint8","rgba","ubyte","nearest");I.define(D,P,A);let k=ne.create(1,1),M=_*2,R=bre(t,f,b,v,x,I,T,E,E,k,p,h,M),{uCurrentSlice:B}=R.values,F=hre(t);F.bind(),xre(t),l.viewport(0,0,D,P),l.scissor(0,0,D,P),i||(i=d&&m?s.texture("volume-float16","rgba","fp16","linear"):c&&u?s.texture("volume-float32","rgba","float","linear"):s.texture("volume-uint8","rgba","ubyte","linear")),i.define(D,P,A);function G(V,H){l.currentRenderItemId=-1;for(let Q=0;Q<A;++Q)C.update(B,Q),V.attachFramebuffer(F,0,Q),H&&a.clear(a.COLOR_BUFFER_BIT),R.render();a.flush()}return Cre(t,R),G(i,!0),Sre(t,R),G(I,!0),Tre(t,R),G(i,!1),{texture:i,scale:S,bbox:T,gridDim:E,gridTexDim:E,gridTexScale:k,radiusFactor:M,resolution:h,maxRadius:_}}function vre(t,e,r,n){let{resolution:o,radiusOffset:i}=n,a=1/o,{indices:s,x:l,y:c,z:u,id:d}=t,m=we.size(s),p=new Float32Array(m*3),h=new Float32Array(m),f=new Float32Array(m),b=0;for(let _=0;_<m;++_){let D=we.getAt(s,_);p[_*3]=l[D],p[_*3+1]=c[D],p[_*3+2]=u[D];let P=r(D)+i;b<P&&(b=P),h[_]=P,f[_]=d?d[_]:_}let v=b*2+o*4,x=qe.expand(qe(),e,y.create(v,v,v)),S=qe.scale(qe(),x,a),T=qe.size(y(),S);y.ceil(T,T);let E=y.create(o,o,o);return{drawCount:m,positions:p,radii:h,groups:f,scale:E,expandedBox:x,dim:T,maxRadius:b}}function bre(t,e,r,n,o,i,a,s,l,c,u,d,m){if(t.namedComputeRenderables[Gm]){let p=y.sub(y(),a.max,a.min),h=t.namedComputeRenderables[Gm].values;C.updateIfChanged(h.drawCount,e),C.updateIfChanged(h.instanceCount,1),C.update(h.aRadius,n),C.update(h.aPosition,r),C.update(h.aGroup,o),C.updateIfChanged(h.uCurrentSlice,0),C.updateIfChanged(h.uCurrentX,0),C.updateIfChanged(h.uCurrentY,0),C.update(h.uBboxMin,a.min),C.update(h.uBboxSize,p),C.update(h.uGridDim,s),C.update(h.uGridTexDim,l),C.update(h.uGridTexScale,c),C.updateIfChanged(h.uAlpha,u),C.updateIfChanged(h.uResolution,d),C.updateIfChanged(h.uRadiusFactorInv,1/m),C.update(h.tMinDistanceTex,i),C.updateIfChanged(h.dGridTexType,i.getDepth()>0?"3d":"2d"),C.updateIfChanged(h.dCalcType,"density"),t.namedComputeRenderables[Gm].update()}else t.namedComputeRenderables[Gm]=Eke(t,e,r,n,o,i,a,s,l,c,u,d,m);return t.namedComputeRenderables[Gm]}function Eke(t,e,r,n,o,i,a,s,l,c,u,d,m){let p=y.sub(y(),a.max,a.min),h={drawCount:C.create(e),instanceCount:C.create(1),aRadius:C.create(n),aPosition:C.create(r),aGroup:C.create(o),uCurrentSlice:C.create(0),uCurrentX:C.create(0),uCurrentY:C.create(0),uBboxMin:C.create(a.min),uBboxSize:C.create(p),uGridDim:C.create(s),uGridTexDim:C.create(l),uGridTexScale:C.create(c),uAlpha:C.create(u),uResolution:C.create(d),uRadiusFactorInv:C.create(1/m),tMinDistanceTex:C.create(i),dGridTexType:C.create(i.getDepth()>0?"3d":"2d"),dCalcType:C.create("density")},f=w({},Cke),b=Qt(Gm,pre,fre),v=dr(t,"points",b,f,h);return mr(v,h)}function xre(t){let{gl:e,state:r}=t;r.disable(e.CULL_FACE),r.enable(e.BLEND),r.disable(e.DEPTH_TEST),r.enable(e.SCISSOR_TEST),r.depthMask(!1),r.clearColor(0,0,0,0)}function Sre(t,e){let{gl:r,state:n}=t;if(C.update(e.values.dCalcType,"minDistance"),e.update(),n.colorMask(!1,!1,!1,!0),n.blendFunc(r.ONE,r.ONE),!t.extensions.blendMinMax)throw new Error("GPU gaussian surface calculation requires EXT_blend_minmax");n.blendEquation(t.extensions.blendMinMax.MAX)}function Cre(t,e){let{gl:r,state:n}=t;C.update(e.values.dCalcType,"density"),e.update(),n.colorMask(!1,!1,!1,!0),n.blendFunc(r.ONE,r.ONE),n.blendEquation(r.FUNC_ADD)}function Tre(t,e){let{gl:r,state:n}=t;C.update(e.values.dCalcType,"groupId"),e.update(),n.colorMask(!0,!0,!0,!1),n.blendFunc(r.ONE,r.ZERO),n.blendEquation(r.FUNC_ADD)}function Ike(t){let e=t[0]*t[1]*t[2],r=Math.sqrt(e),n=Math.pow(2,Math.ceil(Math.log(r)/Math.log(2))),o=0,i=t[1],a=1,s=t[2];return n<t[0]*t[2]?(s=Math.floor(n/t[0]),a=Math.ceil(t[2]/s),o=s*t[0],i*=a):o=t[0]*t[2],{texDimX:o,texDimY:i,texRows:a,texCols:s,powerOfTwoSize:i<n?n:n*2}}function aF(t,e,r,n,o){return N(this,null,function*(){let{resolution:i,radiusOffset:a,smoothness:s}=o,l=1/i,{indices:c,x:u,y:d,z:m,id:p}=e,h=we.size(c),f=new Float32Array(h),b=0;for(let ae=0;ae<h;++ae){let Z=n(we.getAt(c,ae))+a;b<Z&&(b=Z),f[ae]=Z}let v=b*2+i,x=qe.expand(qe(),r,y.create(v,v,v)),S=x.min,T=qe.scale(qe(),x,l),E=qe.size(y(),T);y.ceil(E,E);let _=er.Space(E,[0,1,2],Float32Array),D=_.create(),P=er.create(_,D),A=_.create();A.fill(-1);let I=er.create(_,A),[k,M,R]=E,B=R,F=M,G=B*F,V=mf(E[0],S[0],i),H=mf(E[1],S[1],i),Q=mf(E[2],S[2],i),L=_.create(),Y=s,j=Math.ceil(1e5/(Math.pow(Math.pow(b,3),3)*l));function O(ae,Z){for(let se=ae;se<Z;++se){let Me=we.getAt(c,se),be=u[Me],_e=d[Me],je=m[Me],gt=f[se],Nr=1/(gt*gt),Zt=gt*2,oe=Zt*Zt,De=Math.ceil(Zt*l),Le=Math.floor(l*(be-S[0])),Qe=Math.floor(l*(_e-S[1])),Ue=Math.floor(l*(je-S[2])),Ke=Math.max(0,Le-De),Ve=Math.max(0,Qe-De),It=Math.max(0,Ue-De),yt=Math.min(k,Le+De+2),pe=Math.min(M,Qe+De+2),Ae=Math.min(R,Ue+De+2);for(let $e=Ke;$e<yt;++$e){let ft=V[$e]-be,Pt=$e*G;for(let yr=Ve;yr<pe;++yr){let Ze=H[yr]-_e,_r=ft*ft+Ze*Ze,qr=yr*B+Pt;for(let Ao=It;Ao<Ae;++Ao){let Bn=Q[Ao]-je,co=_r+Bn*Bn;if(co<=oe){let bn=wK(-Y*(co*Nr)),Ii=Ao+qr;D[Ii]+=bn,bn>L[Ii]&&(L[Ii]=bn,A[Ii]=p?p[se]:se)}}}}}}function J(){return N(this,null,function*(){for(let ae=0;ae<h;ae+=j)O(ae,Math.min(ae+j,h)),t.shouldUpdate&&(yield t.update({message:"filling density grid",current:ae,max:h}))})}yield J();let $=W.identity();return W.fromScaling($,y.create(i,i,i)),W.setTranslation($,x.min),{field:P,idField:I,transform:$,radiusFactor:1,resolution:i,maxRadius:b}})}var Uh=w({resolution:g.Numeric(1,{min:.1,max:20,step:.1},w({description:"Grid resolution/cell spacing."},ge.CustomQualityParamInfo)),radiusOffset:g.Numeric(0,{min:0,max:10,step:.1},{description:"Extra/offset radius added to the atoms/coarse elements for gaussian calculation. Useful to create coarse, low resolution surfaces."}),smoothness:g.Numeric(1.5,{min:.5,max:2.5,step:.1},{description:"Smoothness of the gausian surface, lower is smoother."})},dy),Yqt=g.getDefaultValues(Uh);function wre(t,e){let r=t.maxTextureSize/3;return r*r/Math.max(1,e?e.units.length/16:1)}function TE(t,e,r,n){let{position:o,boundary:i,radius:a}=Uv(t,e,r,n),s=_m(i.box,n);return ie.create("Gaussian Density",l=>N(this,null,function*(){return yield aF(l,o,i.box,a,s)}))}function _re(t,e,r,n,o,i){let{position:a,boundary:s,radius:l}=Uv(t,e,r,n),c=_m(s.box,n,wre(o,t));return ie.create("Gaussian Density",u=>N(this,null,function*(){return iF(o,a,s.box,l,c,i)}))}function Pre(t,e,r,n,o,i,a){let{position:s,boundary:l,radius:c}=Uv(t,e,r,o),u=_m(l.box,o,wre(i,t));return ie.create("Gaussian Density",d=>N(this,null,function*(){return CE(i,s,l.box,c,n,u,a)}))}function Ere(t,e,r){let{position:n,boundary:o,radius:i}=Gv(t,e,r),a=_m(o.box,r);return ie.create("Gaussian Density",s=>N(this,null,function*(){return yield aF(s,n,o.box,i,a)}))}function Ire(t,e,r,n,o){let{position:i,boundary:a,radius:s}=Gv(t,e,r),l=_m(a.box,r);return ie.create("Gaussian Density",c=>N(this,null,function*(){return iF(n,i,a.box,s,l,o)}))}function Dre(t,e,r,n,o,i){let{box:a}=t.lookup3d.boundary,{position:s,boundary:l,radius:c}=Gv(t,e,n),u=_m(l.box,n);return ie.create("Gaussian Density",d=>N(this,null,function*(){return CE(o,s,a,c,r,u,i)}))}var Are=U(w(w({},Uh),YT),{ignoreHydrogens:g.Boolean(!1),ignoreHydrogensVariant:g.Select("all",g.arrayToOptions(["all","non-polar"])),tryUseGpu:g.Boolean(!0),includeParent:g.Boolean(!1,{isHidden:!0})}),wE=w(w(w({},Gr),bZ),Are),kre=w(w(w({},Tu),pZ),Are);function Mre(t){return t.extensions.colorBufferFloat&&t.extensions.textureFloat&&t.extensions.textureFloatLinear&&t.extensions.blendMinMax&&t.extensions.drawBuffers}function Gb(t,e,r){if(e.resolution>1)return!1;let n=r.maxTextureSize/3,{areaCells:o,maxAreaCells:i}=OL(t.boundary.box,e.resolution,n*n);return o<i}function Rre(t,e,r,n){return r.tryUseGpu&&n&&Mre(n)&&Gb(e,r,n)?Lke(t):Ake(t)}function Lre(t,e,r,n){return r.tryUseGpu&&n&&Mre(n)&&Gb(e,r,n)?Oke(t):Mke(t)}function Dke(t,e,r,n,o,i){return N(this,null,function*(){let{smoothness:a}=o,{transform:s,field:l,idField:c,radiusFactor:u,resolution:d,maxRadius:m}=yield TE(r,e,n.size,o).runInContext(t.runtime),p={isoLevel:Math.exp(-a)/u,scalarField:l,idField:c},h=yield ym(p,i).runAsChild(t.runtime);h.meta.resolution=d,Be.transform(h,s),t.webgl&&!t.webgl.isWebGL2?(Be.uniformTriangleGroup(h),C.updateIfChanged(h.varyingGroup,!1)):C.updateIfChanged(h.varyingGroup,!0);let f=te.expand(te(),e.boundary.sphere,m);return h.setBoundingSphere(f),h})}function Ake(t){return rn({defaultProps:g.getDefaultValues(wE),createGeometry:Dke,createLocationIterator:jn.fromGroup,getLoci:Wi,eachLocation:qi,setUpdateState:(e,r,n)=>{r.resolution!==n.resolution&&(e.createGeometry=!0),r.radiusOffset!==n.radiusOffset&&(e.createGeometry=!0),r.smoothness!==n.smoothness&&(e.createGeometry=!0),r.ignoreHydrogens!==n.ignoreHydrogens&&(e.createGeometry=!0),r.ignoreHydrogensVariant!==n.ignoreHydrogensVariant&&(e.createGeometry=!0),r.traceOnly!==n.traceOnly&&(e.createGeometry=!0),r.includeParent!==n.includeParent&&(e.createGeometry=!0),r.smoothColors.name!==n.smoothColors.name?e.updateColor=!0:r.smoothColors.name==="on"&&n.smoothColors.name==="on"&&(r.smoothColors.params.resolutionFactor!==n.smoothColors.params.resolutionFactor&&(e.updateColor=!0),r.smoothColors.params.sampleStride!==n.smoothColors.params.sampleStride&&(e.updateColor=!0))},mustRecreate:(e,r,n)=>r.tryUseGpu&&!!n&&Gb(e.structure,r,n),processValues:(e,r,n,o,i)=>{let{resolution:a,colorTexture:s}=r.meta,l=os(n.smoothColors,o.color.preferSmoothing,a);l&&(dv(e,l.resolution,l.stride,i,s),r.meta.colorTexture=e.tColorGrid.ref.value)},dispose:e=>{var r;(r=e.meta.colorTexture)===null||r===void 0||r.destroy()}},t)}function kke(t,e,r,n,o){return N(this,null,function*(){let{smoothness:i}=n,{transform:a,field:s,idField:l,radiusFactor:c,resolution:u,maxRadius:d}=yield Ere(e,r.size,n).runInContext(t.runtime),m={isoLevel:Math.exp(-i)/c,scalarField:s,idField:l},p=yield ym(m,o).runAsChild(t.runtime);p.meta.resolution=u,Be.transform(p,a),t.webgl&&!t.webgl.isWebGL2?(Be.uniformTriangleGroup(p),C.updateIfChanged(p.varyingGroup,!1)):C.updateIfChanged(p.varyingGroup,!0);let h=te.expand(te(),e.boundary.sphere,d);return p.setBoundingSphere(h),p})}function Mke(t){return Va({defaultProps:g.getDefaultValues(kre),createGeometry:kke,createLocationIterator:jn.fromStructure,getLoci:Du,eachLocation:Iu,setUpdateState:(e,r,n)=>{r.resolution!==n.resolution&&(e.createGeometry=!0),r.radiusOffset!==n.radiusOffset&&(e.createGeometry=!0),r.smoothness!==n.smoothness&&(e.createGeometry=!0),r.ignoreHydrogens!==n.ignoreHydrogens&&(e.createGeometry=!0),r.ignoreHydrogensVariant!==n.ignoreHydrogensVariant&&(e.createGeometry=!0),r.traceOnly!==n.traceOnly&&(e.createGeometry=!0),r.smoothColors.name!==n.smoothColors.name?e.updateColor=!0:r.smoothColors.name==="on"&&n.smoothColors.name==="on"&&(r.smoothColors.params.resolutionFactor!==n.smoothColors.params.resolutionFactor&&(e.updateColor=!0),r.smoothColors.params.sampleStride!==n.smoothColors.params.sampleStride&&(e.updateColor=!0))},mustRecreate:(e,r,n)=>r.tryUseGpu&&!!n&&Gb(e,r,n),processValues:(e,r,n,o,i)=>{let{resolution:a,colorTexture:s}=r.meta,l=os(n.smoothColors,o.color.preferSmoothing,a);l&&(dv(e,l.resolution,l.stride,i,s),r.meta.colorTexture=e.tColorGrid.ref.value)},dispose:e=>{var r;(r=e.meta.colorTexture)===null||r===void 0||r.destroy()}},t)}var Ub="gaussian-surface";function Rke(t,e,r,n,o,i){return N(this,null,function*(){if(!t.webgl)throw new Error("webgl context required to create gaussian surface texture-mesh");Ee&&t.webgl.timer.mark("createGaussianSurfaceTextureMesh");let{namedTextures:a,resources:s,extensions:{colorBufferFloat:l,textureFloat:c,colorBufferHalfFloat:u,textureHalfFloat:d}}=t.webgl;a[Ub]||(a[Ub]=u&&d?s.texture("image-float16","rgba","fp16","linear"):l&&c?s.texture("image-float32","rgba","float","linear"):s.texture("image-uint8","rgba","ubyte","linear"));let m=yield Pre(r,e,n.size,!0,o,t.webgl,a[Ub]).runInContext(t.runtime),p=Math.exp(-o.smoothness)/m.radiusFactor,h=y.create(0,1,2),f=i?.doubleBuffer.get(),b=ey(t.webgl,m.texture,m.gridDim,m.gridTexDim,m.gridTexScale,m.transform,p,!1,!0,h,!0,f?.vertex,f?.group,f?.normal);Ee&&t.webgl.timer.markEnd("createGaussianSurfaceTextureMesh");let v=e.elements.length,x=te.expand(te(),e.boundary.sphere,m.maxRadius),S=Ko.create(b.vertexCount,v,b.vertexTexture,b.groupTexture,b.normalTexture,x,i);return S.meta.resolution=m.resolution,S.meta.webgl=t.webgl,S})}function Lke(t){return xZ({defaultProps:g.getDefaultValues(wE),createGeometry:Rke,createLocationIterator:jn.fromGroup,getLoci:Wi,eachLocation:qi,setUpdateState:(e,r,n)=>{r.resolution!==n.resolution&&(e.createGeometry=!0),r.radiusOffset!==n.radiusOffset&&(e.createGeometry=!0),r.smoothness!==n.smoothness&&(e.createGeometry=!0),r.ignoreHydrogens!==n.ignoreHydrogens&&(e.createGeometry=!0),r.ignoreHydrogensVariant!==n.ignoreHydrogensVariant&&(e.createGeometry=!0),r.traceOnly!==n.traceOnly&&(e.createGeometry=!0),r.includeParent!==n.includeParent&&(e.createGeometry=!0),r.smoothColors.name!==n.smoothColors.name?e.updateColor=!0:r.smoothColors.name==="on"&&n.smoothColors.name==="on"&&(r.smoothColors.params.resolutionFactor!==n.smoothColors.params.resolutionFactor&&(e.updateColor=!0),r.smoothColors.params.sampleStride!==n.smoothColors.params.sampleStride&&(e.updateColor=!0))},mustRecreate:(e,r,n)=>!r.tryUseGpu||!n||!Gb(e.structure,r,n),processValues:(e,r,n,o,i)=>{let{resolution:a,colorTexture:s}=r.meta,l=os(n.smoothColors,o.color.preferSmoothing,a);l&&i&&(n3(e,l.resolution,l.stride,i,s),r.meta.colorTexture=e.tColorGrid.ref.value)},dispose:e=>{var r;e.vertexTexture.ref.value.destroy(),e.groupTexture.ref.value.destroy(),e.normalTexture.ref.value.destroy(),e.doubleBuffer.destroy(),(r=e.meta.colorTexture)===null||r===void 0||r.destroy()}},t)}function Bke(t,e,r,n,o){return N(this,null,function*(){if(!t.webgl)throw new Error("webgl context required to create structure gaussian surface texture-mesh");Ee&&t.webgl.timer.mark("createStructureGaussianSurfaceTextureMesh");let{namedTextures:i,resources:a,extensions:{colorBufferFloat:s,textureFloat:l,colorBufferHalfFloat:c,textureHalfFloat:u}}=t.webgl;i[Ub]||(i[Ub]=c&&u?a.texture("image-float16","rgba","fp16","linear"):s&&l?a.texture("image-float32","rgba","float","linear"):a.texture("image-uint8","rgba","ubyte","linear"));let d=yield Dre(e,r.size,!0,n,t.webgl,i[Ub]).runInContext(t.runtime),m=Math.exp(-n.smoothness)/d.radiusFactor,p=y.create(0,1,2),h=o?.doubleBuffer.get(),f=ey(t.webgl,d.texture,d.gridDim,d.gridTexDim,d.gridTexScale,d.transform,m,!1,!0,p,!0,h?.vertex,h?.group,h?.normal);Ee&&t.webgl.timer.markEnd("createStructureGaussianSurfaceTextureMesh");let b=e.elementCount,v=te.expand(te(),e.boundary.sphere,d.maxRadius),x=Ko.create(f.vertexCount,b,f.vertexTexture,f.groupTexture,f.normalTexture,v,o);return x.meta.resolution=d.resolution,x.meta.webgl=t.webgl,x})}function Oke(t){return fZ({defaultProps:g.getDefaultValues(kre),createGeometry:Bke,createLocationIterator:jn.fromStructure,getLoci:Du,eachLocation:Iu,setUpdateState:(e,r,n)=>{r.resolution!==n.resolution&&(e.createGeometry=!0),r.radiusOffset!==n.radiusOffset&&(e.createGeometry=!0),r.smoothness!==n.smoothness&&(e.createGeometry=!0),r.ignoreHydrogens!==n.ignoreHydrogens&&(e.createGeometry=!0),r.ignoreHydrogensVariant!==n.ignoreHydrogensVariant&&(e.createGeometry=!0),r.traceOnly!==n.traceOnly&&(e.createGeometry=!0),r.includeParent!==n.includeParent&&(e.createGeometry=!0),r.smoothColors.name!==n.smoothColors.name?e.updateColor=!0:r.smoothColors.name==="on"&&n.smoothColors.name==="on"&&(r.smoothColors.params.resolutionFactor!==n.smoothColors.params.resolutionFactor&&(e.updateColor=!0),r.smoothColors.params.sampleStride!==n.smoothColors.params.sampleStride&&(e.updateColor=!0))},mustRecreate:(e,r,n)=>!r.tryUseGpu||!n||!Gb(e,r,n),processValues:(e,r,n,o,i)=>{let{resolution:a,colorTexture:s}=r.meta,l=os(n.smoothColors,o.color.preferSmoothing,a);l&&i&&(n3(e,l.resolution,l.stride,i,s),r.meta.colorTexture=e.tColorGrid.ref.value)},dispose:e=>{var r;e.vertexTexture.ref.value.destroy(),e.groupTexture.ref.value.destroy(),e.normalTexture.ref.value.destroy(),e.doubleBuffer.destroy(),(r=e.meta.colorTexture)===null||r===void 0||r.destroy()}},t)}function Fke(t,e,r,n,o,i){return N(this,null,function*(){let{smoothness:a}=o,{transform:s,field:l,idField:c,maxRadius:u}=yield TE(r,e,n.size,o).runInContext(t.runtime),d={isoLevel:Math.exp(-a),scalarField:l,idField:c},m=yield wv(d,i).runAsChild(t.runtime);Sr.transform(m,s);let p=te.expand(te(),e.boundary.sphere,u);return m.setBoundingSphere(p),m})}var sF=U(w(w({},bh),Uh),{sizeFactor:g.Numeric(3,{min:0,max:10,step:.1}),lineSizeAttenuation:g.Boolean(!1),ignoreHydrogens:g.Boolean(!1),ignoreHydrogensVariant:g.Select("all",g.arrayToOptions(["all","non-polar"])),includeParent:g.Boolean(!1,{isHidden:!0})});function Bre(t){return xh({defaultProps:g.getDefaultValues(sF),createGeometry:Fke,createLocationIterator:jn.fromGroup,getLoci:Wi,eachLocation:qi,setUpdateState:(e,r,n)=>{r.resolution!==n.resolution&&(e.createGeometry=!0),r.radiusOffset!==n.radiusOffset&&(e.createGeometry=!0),r.smoothness!==n.smoothness&&(e.createGeometry=!0),r.ignoreHydrogens!==n.ignoreHydrogens&&(e.createGeometry=!0),r.ignoreHydrogensVariant!==n.ignoreHydrogensVariant&&(e.createGeometry=!0),r.traceOnly!==n.traceOnly&&(e.createGeometry=!0),r.includeParent!==n.includeParent&&(e.createGeometry=!0)}},t)}var Ore={"gaussian-surface-mesh":(t,e)=>Dr("Gaussian surface mesh",t,e,Rre),"structure-gaussian-surface-mesh":(t,e)=>_o("Structure-Gaussian surface mesh",t,e,Lre),"gaussian-surface-wireframe":(t,e)=>Dr("Gaussian surface wireframe",t,e,Bre)},Fre=U(w(w({},wE),sF),{visuals:g.MultiSelect(["gaussian-surface-mesh"],g.objectToOptions(Ore)),bumpFrequency:g.Numeric(1,{min:0,max:10,step:.1},ge.ShadingCategory)});function Nke(t,e){return Fre}function Vke(t,e){return rt.createMulti("Gaussian Surface",t,e,Qr,Ore)}var Nre={name:"gaussian-surface",label:"Gaussian Surface",description:"Displays a gaussian molecular surface.",factory:Vke,getParams:Nke,defaultValues:g.getDefaultValues(Fre),defaultColorTheme:{name:"chain-id"},defaultSizeTheme:{name:"physical"},isApplicable:t=>t.elementCount>0};var lF=U(w({},cZ),{background:g.Boolean(!1),backgroundMargin:g.Numeric(0,{min:0,max:1,step:.01}),backgroundColor:g.Color(ut.black),backgroundOpacity:g.Numeric(.5,{min:0,max:1,step:.01}),borderWidth:g.Numeric(.25,{min:0,max:.5,step:.01}),level:g.Select("residue",[["chain","Chain"],["residue","Residue"],["element","Element"]],{isEssential:!0}),ignoreHydrogens:g.Boolean(!1),ignoreHydrogensVariant:g.Select("all",g.arrayToOptions(["all","non-polar"])),chainScale:g.Numeric(10,{min:0,max:20,step:.1}),residueScale:g.Numeric(1,{min:0,max:20,step:.1}),elementScale:g.Numeric(.5,{min:0,max:20,step:.1})});function Vre(t){return uZ({defaultProps:g.getDefaultValues(lF),createGeometry:zke,createLocationIterator:jn.fromStructure,getLoci:Du,eachLocation:Iu,setUpdateState:(e,r,n)=>{e.createGeometry=r.level!==n.level||r.level==="chain"&&r.chainScale!==n.chainScale||r.level==="residue"&&r.residueScale!==n.residueScale||r.level==="element"&&r.elementScale!==n.elementScale||r.ignoreHydrogens!==n.ignoreHydrogens||r.ignoreHydrogensVariant!==n.ignoreHydrogensVariant}},t)}function zke(t,e,r,n,o){switch(n.level){case"chain":return Uke(t,e,r,n,o);case"residue":return Gke(t,e,r,n,o);case"element":return jke(t,e,r,n,o)}}var Wu=y(),$S=new Zs("98");function Uke(t,e,r,n,o){let i=z.Location.create(e),{units:a,serialMapping:s}=e,{auth_asym_id:l,label_asym_id:c}=Ne.chain,{cumulativeUnitElementCount:u}=s,d=a.length,{chainScale:m}=n,p=Is.create(n,d,d/2,o);for(let h=0,f=a.length;h<f;++h){let b=a[h];i.unit=b,i.element=b.elements[0];let{center:v,radius:x}=b.lookup3d.boundary.sphere;y.transformMat4(Wu,v,b.conformation.operator.matrix);let S=l(i),T=c(i),E=S===T?T:`${T} [${S}]`;p.add(E,Wu[0],Wu[1],Wu[2],x,m,u[h])}return p.getText()}function Gke(t,e,r,n,o){let i=z.Location.create(e),{units:a,serialMapping:s}=e,{label_comp_id:l}=Ne.atom,{auth_seq_id:c}=Ne.residue,{cumulativeUnitElementCount:u}=s,d=e.polymerResidueCount*2,{residueScale:m}=n,p=Is.create(n,d,d/2,o);for(let h=0,f=a.length;h<f;++h){let b=a[h],v=b.conformation,{elements:x}=b;i.unit=b,i.element=b.elements[0];let S=b.model.atomicHierarchy.residueAtomSegments.index,T=u[h],E=0,_=x.length;for(;E<_;){let D=E,P=S[x[E]];for(E++;E<_&&S[x[E]]===P;)E++;$S.reset();for(let B=D;B<E;B++)v.position(x[B],Wu),$S.includePosition(Wu);$S.finishedIncludeStep();for(let B=D;B<E;B++)v.position(x[B],Wu),$S.radiusPosition(Wu);i.element=x[D];let{center:A,radius:I}=$S.getSphere(),k=c(i),R=`${l(i)} ${k}`;p.add(R,A[0],A[1],A[2],I,m,T+D)}}return p.getText()}function jke(t,e,r,n,o){let i=z.Location.create(e),{units:a,serialMapping:s}=e,{label_atom_id:l,label_alt_id:c}=Ne.atom,{cumulativeUnitElementCount:u}=s,d=r.size,m=e.elementCount,{elementScale:p}=n,h=Is.create(n,m,m/2,o);for(let f=0,b=a.length;f<b;++f){let v=a[f],x=v.conformation,{elements:S}=v;i.unit=v;let T=u[f],E=Mm(e,v,U(w({},n),{traceOnly:!1}));for(let _=0,D=S.length;_<D;_++){if(E&&E(S[_]))continue;i.element=S[_],x.position(i.element,Wu);let P=l(i),A=c(i),I=A?`${P}%${A}`:P;h.add(I,Wu[0],Wu[1],Wu[2],d.size(i),p,T+_)}}return h.getText()}var zre={"label-text":(t,e)=>_o("Label text",t,e,Vre)},Ure=U(w({},lF),{visuals:g.MultiSelect(["label-text"],g.objectToOptions(zre))});function Hke(t,e){return Ure}function qke(t,e){let r=rt.createMulti("Label",t,e,Qr,zre);return r.setState({pickable:!1,markerActions:tt.None}),r}var Gre={name:"label",label:"Label",description:"Displays labels.",factory:qke,getParams:Hke,defaultValues:g.getDefaultValues(Ure),defaultColorTheme:{name:"uniform"},defaultSizeTheme:{name:"physical"},isApplicable:t=>t.elementCount>0};function Wke(t,e){return t[0]=t[1]=t[2]=1,e[0]!==0?t[0]=(e[1]+e[2])/-e[0]:e[1]!==0?t[1]=(e[0]+e[2])/-e[1]:e[2]!==0&&(t[2]=(e[0]+e[1])/-e[2]),t}function Xke(t){let e=0,r=2*Math.PI/t,n=new Float32Array(t),o=new Float32Array(t);for(let i=0;i<t;i++)n[i]=Math.cos(e),o[i]=Math.sin(e),e+=r;return{cosTable:n,sinTable:o}}var ZS={probeRadius:g.Numeric(1.4,{min:0,max:10,step:.1},{description:"Radius of the probe tracing the molecular surface."}),resolution:g.Numeric(.5,{min:.01,max:20,step:.01},w({description:"Grid resolution/cell spacing."},ge.CustomQualityParamInfo)),probePositions:g.Numeric(36,{min:12,max:90,step:1},w({description:"Number of positions tested for probe target intersection."},ge.CustomQualityParamInfo))},oWt=g.getDefaultValues(ZS);function jre(t,e,r,n,o,i){return N(this,null,function*(){let a=-1;function s(Ke,Ve,It,yt,pe){if(a!==-1){let Ae=a;if(Ae!==yt&&Ae!==pe&&l(Ae,Ke,Ve,It))return Ae;a=-1}for(let Ae=0,$e=A.count;Ae<$e;++Ae){let ft=we.getAt(I,A.indices[Ae]);if(ft!==yt&&ft!==pe&&l(ft,Ke,Ve,It))return a=ft,ft}return-1}function l(Ke,Ve,It,yt){let pe=F[Ke],Ae=k[Ke]-Ve,$e=M[Ke]-It,ft=R[Ke]-yt;return Ae*Ae+$e*$e+ft*ft<pe*pe}function c(Ke,Ve){for(let It=Ke;It<Ve;++It){let yt=we.getAt(I,It),pe=k[yt],Ae=M[yt],$e=R[yt],ft=F[yt],Pt=ft*ft;P.find(pe,Ae,$e,ft);let yr=Math.ceil(ft*E),Ze=Math.floor(E*(pe-Q)),_r=Math.floor(E*(Ae-L)),qr=Math.floor(E*($e-Y)),Ao=Math.max(0,Ze-yr),Bn=Math.max(0,_r-yr),co=Math.max(0,qr-yr),bn=Math.min(J,Ze+yr+2),Ii=Math.min($,_r+yr+2),Ys=Math.min(ae,qr+yr+2);for(let Sl=Ao;Sl<bn;++Sl){let He=Nr[Sl]-pe,_t=Sl*Me;for(let Gt=Bn;Gt<Ii;++Gt){let Xt=Zt[Gt]-Ae,Vr=He*He+Xt*Xt,ho=Gt*Z+_t;for(let mt=co;mt<Ys;++mt){let On=oe[mt]-$e,$a=Vr+On*On;if($a<Pt){let go=mt+ho;gt[go]<0&&(gt[go]*=-1);let Gc=Math.sqrt($a),nd=ft/Gc,od=He*nd+pe,id=Xt*nd+Ae,oc=On*nd+$e;if(s(od,id,oc,yt,-1)===-1){let ea=ft-Gc;ea<gt[go]&&(gt[go]=ea,fr[go]=B[It])}}}}}}}function u(){return N(this,null,function*(){for(let Ke=0;Ke<G;Ke+=De)c(Ke,Math.min(Ke+De,G)),t.shouldUpdate&&(yield t.update({message:"projecting points",current:Ke,max:G}))})}let d=y(),m=y(),p=y(),h=y();function f(Ke,Ve){let It=F[Ke],yt=F[Ve],pe=d[0]=k[Ve]-k[Ke],Ae=d[1]=M[Ve]-M[Ke],$e=d[2]=R[Ve]-R[Ke],ft=pe*pe+Ae*Ae+$e*$e,Pt=Math.sqrt(ft),yr=(It*It+Pt*Pt-yt*yt)/(2*It*Pt),Ze=It*yr;y.normalize(d,d),Wke(p,d),y.normalize(p,p),y.cross(h,d,p),y.normalize(h,h);let _r=Math.sqrt(It*It-Ze*Ze);y.scale(p,p,_r),y.scale(h,h,_r),y.scale(d,d,Ze),m[0]=d[0]+k[Ke],m[1]=d[1]+M[Ke],m[2]=d[2]+R[Ke],a=-1;for(let qr=0;qr<T;++qr){let Ao=be[qr],Bn=_e[qr],co=m[0]+Ao*p[0]+Bn*h[0],bn=m[1]+Ao*p[1]+Bn*h[1],Ii=m[2]+Ao*p[2]+Bn*h[2];if(s(co,bn,Ii,Ke,Ve)===-1){let Ys=Math.floor(E*(co-Q)),Sl=Math.floor(E*(bn-L)),He=Math.floor(E*(Ii-Y)),_t=Math.max(0,Ys-_),Gt=Math.max(0,Sl-_),Xt=Math.max(0,He-_),Vr=Math.min(J,Ys+_+2),ho=Math.min($,Sl+_+2),mt=Math.min(ae,He+_+2);for(let On=_t;On<Vr;++On){let $a=co-Nr[On],go=On*Me;for(let Gc=Gt;Gc<ho;++Gc){let nd=bn-Zt[Gc],od=$a*$a+nd*nd,id=Gc*Z+go;for(let oc=Xt;oc<mt;++oc){let ea=Ii-oe[oc],vg=od+ea*ea,ef=oc+id,me=gt[ef];if(me>0&&vg<me*me){gt[ef]=Math.sqrt(vg);let Ft=$a*d[0]+nd*d[1]+ea*d[2];fr[ef]=B[we.indexOf(I,Ft<0?Ve:Ke)]}}}}}}}function b(Ke,Ve){for(let It=Ke;It<Ve;++It){let yt=we.getAt(I,It);P.find(k[yt],M[yt],R[yt],F[yt]);for(let pe=0,Ae=A.count;pe<Ae;++pe){let $e=we.getAt(I,A.indices[pe]);yt<$e&&f(yt,$e)}}}function v(){return N(this,null,function*(){for(let Ke=0;Ke<G;Ke+=De)b(Ke,Math.min(Ke+De,G)),t.shouldUpdate&&(yield t.update({message:"projecting torii",current:Ke,max:G}))})}let{resolution:x,probeRadius:S,probePositions:T}=i,E=1/x,_=Math.max(5,2+Math.floor(S*E)),D=y.create(n,n,n);y.scale(D,D,2);let P=pf(e,r,D),A=P.result;o===null&&(o=P.boundary.box);let{indices:I,x:k,y:M,z:R,id:B,radius:F}=e,G=we.size(I),V=n+x,H=qe.expand(qe(),o,y.create(V,V,V)),[Q,L,Y]=H.min,j=qe.scale(qe(),H,E),O=qe.size(y(),j);y.ceil(O,O);let[J,$,ae]=O,Z=ae,se=$,Me=Z*se,{cosTable:be,sinTable:_e}=Xke(T),je=er.Space(O,[0,1,2],Float32Array),gt=je.create(),fr=je.create();gt.fill(-1001),fr.fill(-1);let Nr=mf(J,Q,x),Zt=mf($,L,x),oe=mf(ae,Y,x),De=Math.ceil(1e5/(Math.pow(Math.pow(n,3),3)*E));yield u(),yield v();let Le=er.create(je,gt),Qe=er.create(je,fr),Ue=W.identity();return W.fromScaling(Ue,y.create(x,x,x)),W.setTranslation(Ue,H.min),{field:Le,idField:Qe,transform:Ue,resolution:x,maxRadius:n}})}function Yke(t,e,r,n){let{probeRadius:o}=n,{position:i,boundary:a,radius:s}=Uv(t,e,r,n),{indices:l}=i,c=we.size(l),u=new Float32Array(we.end(l)),d=0;for(let m=0;m<c;++m){let p=we.getAt(l,m),h=s(p);d<h&&(d=h),u[p]=h+o}return{position:U(w({},i),{radius:u}),boundary:a,maxRadius:d}}function _E(t,e,r,n){let{position:o,boundary:i,maxRadius:a}=Yke(t,e,r,n),s=_m(i.box,n);return ie.create("Molecular Surface",l=>N(this,null,function*(){return yield qre(l,o,i,a,i.box,s)}))}function Qke(t,e,r){let{probeRadius:n}=r,{position:o,boundary:i,radius:a}=Gv(t,e,r),{indices:s}=o,l=we.size(s),c=new Float32Array(we.end(s)),u=0;for(let d=0;d<l;++d){let m=we.getAt(s,d),p=a(m);u<p&&(u=p),c[m]=p+n}return{position:U(w({},o),{radius:c}),boundary:i,maxRadius:u}}function Hre(t,e,r){let{position:n,boundary:o,maxRadius:i}=Qke(t,e,r),a=_m(o.box,r);return ie.create("Molecular Surface",s=>N(this,null,function*(){return yield qre(s,n,o,i,o.box,a)}))}function qre(t,e,r,n,o,i){return N(this,null,function*(){return jre(t,e,r,n,o,i)})}var PE=w(w(w(w({},Gr),ZS),dy),YT);function Kke(t,e,r,n,o,i){return N(this,null,function*(){let{transform:a,field:s,idField:l,resolution:c,maxRadius:u}=yield _E(r,e,n.size,o).runInContext(t.runtime),d={isoLevel:o.probeRadius,scalarField:s,idField:l},m=yield ym(d,i).runAsChild(t.runtime);if(o.includeParent){let h=Math.ceil(2/o.resolution);Be.smoothEdges(m,{iterations:h,maxNewEdgeLength:Math.sqrt(2)})}Be.transform(m,a),t.webgl&&!t.webgl.isWebGL2?(Be.uniformTriangleGroup(m),C.updateIfChanged(m.varyingGroup,!1)):C.updateIfChanged(m.varyingGroup,!0);let p=te.expand(te(),e.boundary.sphere,u);return m.setBoundingSphere(p),m.meta.resolution=c,m})}function Wre(t){return rn({defaultProps:g.getDefaultValues(PE),createGeometry:Kke,createLocationIterator:jn.fromGroup,getLoci:Wi,eachLocation:qi,setUpdateState:(e,r,n)=>{r.resolution!==n.resolution&&(e.createGeometry=!0),r.probeRadius!==n.probeRadius&&(e.createGeometry=!0),r.probePositions!==n.probePositions&&(e.createGeometry=!0),r.ignoreHydrogens!==n.ignoreHydrogens&&(e.createGeometry=!0),r.ignoreHydrogensVariant!==n.ignoreHydrogensVariant&&(e.createGeometry=!0),r.traceOnly!==n.traceOnly&&(e.createGeometry=!0),r.includeParent!==n.includeParent&&(e.createGeometry=!0),r.smoothColors.name!==n.smoothColors.name?e.updateColor=!0:r.smoothColors.name==="on"&&n.smoothColors.name==="on"&&(r.smoothColors.params.resolutionFactor!==n.smoothColors.params.resolutionFactor&&(e.updateColor=!0),r.smoothColors.params.sampleStride!==n.smoothColors.params.sampleStride&&(e.updateColor=!0))},processValues:(e,r,n,o,i)=>{let{resolution:a,colorTexture:s}=r.meta,l=os(n.smoothColors,o.color.preferSmoothing,a);l&&(dv(e,l.resolution,l.stride,i,s),r.meta.colorTexture=e.tColorGrid.ref.value)},dispose:e=>{var r;(r=e.meta.colorTexture)===null||r===void 0||r.destroy()}},t)}function $ke(t,e,r,n,o){return N(this,null,function*(){let{transform:i,field:a,idField:s,resolution:l,maxRadius:c}=yield Hre(e,r.size,n).runInContext(t.runtime),u={isoLevel:n.probeRadius,scalarField:a,idField:s},d=yield ym(u,o).runAsChild(t.runtime);if(n.includeParent){let p=Math.ceil(2/n.resolution);Be.smoothEdges(d,{iterations:p,maxNewEdgeLength:Math.sqrt(2)})}Be.transform(d,i),t.webgl&&!t.webgl.isWebGL2?(Be.uniformTriangleGroup(d),C.updateIfChanged(d.varyingGroup,!1)):C.updateIfChanged(d.varyingGroup,!0);let m=te.expand(te(),e.boundary.sphere,c);return d.setBoundingSphere(m),d.meta.resolution=l,d})}function Xre(t){return Va({defaultProps:g.getDefaultValues(PE),createGeometry:$ke,createLocationIterator:jn.fromStructure,getLoci:Du,eachLocation:Iu,setUpdateState:(e,r,n)=>{r.resolution!==n.resolution&&(e.createGeometry=!0),r.probeRadius!==n.probeRadius&&(e.createGeometry=!0),r.probePositions!==n.probePositions&&(e.createGeometry=!0),r.ignoreHydrogens!==n.ignoreHydrogens&&(e.createGeometry=!0),r.ignoreHydrogensVariant!==n.ignoreHydrogensVariant&&(e.createGeometry=!0),r.traceOnly!==n.traceOnly&&(e.createGeometry=!0),r.includeParent!==n.includeParent&&(e.createGeometry=!0),r.smoothColors.name!==n.smoothColors.name?e.updateColor=!0:r.smoothColors.name==="on"&&n.smoothColors.name==="on"&&(r.smoothColors.params.resolutionFactor!==n.smoothColors.params.resolutionFactor&&(e.updateColor=!0),r.smoothColors.params.sampleStride!==n.smoothColors.params.sampleStride&&(e.updateColor=!0))},processValues:(e,r,n,o,i)=>{let{resolution:a,colorTexture:s}=r.meta,l=os(n.smoothColors,o.color.preferSmoothing,a);l&&(dv(e,l.resolution,l.stride,i,s),r.meta.colorTexture=e.tColorGrid.ref.value)},dispose:e=>{var r;(r=e.meta.colorTexture)===null||r===void 0||r.destroy()}},t)}var cF=U(w(w(w({},bh),ZS),dy),{sizeFactor:g.Numeric(1.5,{min:0,max:10,step:.1})});function Zke(t,e,r,n,o,i){return N(this,null,function*(){let{transform:a,field:s,idField:l,maxRadius:c}=yield _E(r,e,n.size,o).runInContext(t.runtime),u={isoLevel:o.probeRadius,scalarField:s,idField:l},d=yield wv(u,i).runAsChild(t.runtime);Sr.transform(d,a);let m=te.expand(te(),e.boundary.sphere,c);return d.setBoundingSphere(m),d})}function Yre(t){return xh({defaultProps:g.getDefaultValues(cF),createGeometry:Zke,createLocationIterator:jn.fromGroup,getLoci:Wi,eachLocation:qi,setUpdateState:(e,r,n)=>{r.resolution!==n.resolution&&(e.createGeometry=!0),r.probeRadius!==n.probeRadius&&(e.createGeometry=!0),r.probePositions!==n.probePositions&&(e.createGeometry=!0),r.ignoreHydrogens!==n.ignoreHydrogens&&(e.createGeometry=!0),r.ignoreHydrogensVariant!==n.ignoreHydrogensVariant&&(e.createGeometry=!0),r.includeParent!==n.includeParent&&(e.createGeometry=!0)}},t)}var Qre={"molecular-surface-mesh":(t,e)=>Dr("Molecular surface mesh",t,e,Wre),"structure-molecular-surface-mesh":(t,e)=>_o("Structure Molecular surface mesh",t,e,Xre),"molecular-surface-wireframe":(t,e)=>Dr("Molecular surface wireframe",t,e,Yre)},Kre=U(w(w({},PE),cF),{visuals:g.MultiSelect(["molecular-surface-mesh"],g.objectToOptions(Qre)),bumpFrequency:g.Numeric(1,{min:0,max:10,step:.1},ge.ShadingCategory)});function Jke(t,e){return Kre}function eMe(t,e){return rt.createMulti("Molecular Surface",t,e,Qr,Qre)}var $re={name:"molecular-surface",label:"Molecular Surface",description:"Displays a molecular surface.",factory:eMe,getParams:Jke,defaultValues:g.getDefaultValues(Kre),defaultColorTheme:{name:"chain-id"},defaultSizeTheme:{name:"physical"},isApplicable:t=>t.elementCount>0};var uF=U(w({},Gr),{sizeFactor:g.Numeric(1,{min:0,max:2,step:.1}),detail:g.Numeric(0,{min:0,max:3,step:1},ge.CustomQualityParamInfo)});function Zre(t){return rn({defaultProps:g.getDefaultValues(uF),createGeometry:rMe,createLocationIterator:nMe,getLoci:oMe,eachLocation:iMe,setUpdateState:(e,r,n)=>{e.createGeometry=r.sizeFactor!==n.sizeFactor||r.detail!==n.detail}},t)}function tMe(t){if(Pe.Traits.is(t.traits,Pe.Trait.MultiChain)||Pe.Traits.is(t.traits,Pe.Trait.Partitioned))return!1;if(Pe.isCoarse(t))return!0;if(t.elements.length===0)return!1;t.model.atomicHierarchy.derived.residue.moleculeType;let e=t.residueIndex[t.elements[0]],r=t.model.atomicHierarchy.derived.residue.moleculeType[e];return!(r===3||r===2)}function rMe(t,e,r,n,o,i){if(!tMe(e))return Be.createEmpty(i);let{detail:a,sizeFactor:s}=o,l=256,c=Te.createState(l,l/2,i),u=e.principalAxes.boxAxes,{origin:d,dirA:m,dirB:p}=u,h=Yc.size(y(),u);y.scale(h,h,s/2);let f=y.create(h[2],h[1],h[0]);c.currentGroup=0,Cv(c,d,m,p,f,a+1);let b=Te.getMesh(c),v=te.expand(te(),e.boundary.sphere,1*o.sizeFactor);return b.setBoundingSphere(v),b}function nMe(t){let{group:e,structure:r}=t,n=1,o=e.units.length,i=z.Location.create(r);return jt(n,o,1,(s,l)=>{let c=e.units[l];return i.unit=c,i.element=c.elements[s],i})}function oMe(t,e,r){let{objectId:n,instanceId:o}=t;if(r===n){let{structure:i,group:a}=e,s=a.units[o],l=we.ofBounds(0,s.elements.length);return z.Loci(i,[{unit:s,indices:l}])}return St}function iMe(t,e,r){let n=!1;if(!z.Loci.is(t))return!1;let{structure:o,group:i}=e;if(!ue.areEquivalent(t.structure,o))return!1;let a=i.elements.length;for(let s of t.elements){let l=i.unitIndexMap.get(s.unit.id);l!==void 0&&we.size(s.indices)===a&&r(Oe.ofSingleton(l))&&(n=!0)}return n}var Jre={"orientation-ellipsoid-mesh":(t,e)=>Dr("Orientation ellipsoid mesh",t,e,Zre)},ene=U(w({},uF),{visuals:g.MultiSelect(["orientation-ellipsoid-mesh"],g.objectToOptions(Jre)),bumpFrequency:g.Numeric(1,{min:0,max:10,step:.1},ge.ShadingCategory)});function aMe(t,e){return ene}function sMe(t,e){return rt.createMulti("Orientation",t,e,Qr,Jre)}var tne={name:"orientation",label:"Orientation",description:"Displays orientation ellipsoids for polymer chains.",factory:sMe,getParams:aMe,defaultValues:g.getDefaultValues(ene),defaultColorTheme:{name:"chain-id"},defaultSizeTheme:{name:"uniform"},isApplicable:t=>t.elementCount>0};var lMe=he.add3,cMe=he.add,EE;(function(t){function e(r=2048,n=1024,o){let i=he.create(Float32Array,3,n,o?o.centerBuffer.ref.value:r),a=he.create(Float32Array,1,n,o?o.groupBuffer.ref.value:r);return{add:(s,l,c,u)=>{lMe(i,s,l,c),cMe(a,u)},getPoints:()=>{let s=he.compact(i,!0),l=he.compact(a,!0);return Il.create(s,l,i.elementCount,o)}}}t.create=e})(EE||(EE={}));var rne=y.add,JS=U(w({},hZ),{pointSizeAttenuation:g.Boolean(!1),ignoreHydrogens:g.Boolean(!1),ignoreHydrogensVariant:g.Select("all",g.arrayToOptions(["all","non-polar"])),traceOnly:g.Boolean(!1),stride:g.Numeric(1,{min:1,max:100,step:1})});function uMe(t,e,r,n,o,i){let{child:a}=r;if(a&&!a.unitMap.get(e.id))return Il.createEmpty(i);let s=e.elements,l=s.length,c=EE.create(l,l/10,i),u=y(),d=e.conformation,m=Mm(r,e,o),p=y(),h=0;if(m)for(let x=0;x<l;++x)m(s[x])||(d.invariantPosition(s[x],u),rne(p,p,u),h+=1,c.add(u[0],u[1],u[2],x));else for(let x=0;x<l;++x)d.invariantPosition(s[x],u),rne(p,p,u),h+=1,c.add(u[0],u[1],u[2],x);let f=i?te.clone(i.boundingSphere):void 0,b=c.getPoints();if(h===0)return b;let v;return y.scale(p,p,1/h),f&&y.distance(p,f.center)/f.radius<.1?v=f:v=te.expand(te(),e.boundary.sphere,1*o.sizeFactor),b.setBoundingSphere(v),b}function IE(t){return gZ({defaultProps:g.getDefaultValues(JS),createGeometry:uMe,createLocationIterator:jn.fromGroup,getLoci:Wi,eachLocation:qi,setUpdateState:(e,r,n)=>{e.createGeometry=r.ignoreHydrogens!==n.ignoreHydrogens||r.ignoreHydrogensVariant!==n.ignoreHydrogensVariant||r.traceOnly!==n.traceOnly||r.stride!==n.stride}},t)}var dMe={"element-point":(t,e)=>Dr("Points",t,e,IE)},nne=w({},JS);function mMe(t,e){return nne}function pMe(t,e){return rt.createMulti("Point",t,e,Qr,dMe)}var one={name:"point",label:"Point",description:"Displays elements (atoms, coarse spheres) as points.",factory:pMe,getParams:mMe,defaultValues:g.getDefaultValues(nne),defaultColorTheme:{name:"element-symbol"},defaultSizeTheme:{name:"uniform"},isApplicable:t=>t.elementCount>0};var ine={sizeFactor:g.Numeric(.2,{min:0,max:10,step:.01}),detail:g.Numeric(0,{min:0,max:3,step:1},ge.CustomQualityParamInfo),linearSegments:g.Numeric(8,{min:1,max:48,step:1},ge.CustomQualityParamInfo),radialSegments:g.Numeric(16,{min:2,max:56,step:2},ge.CustomQualityParamInfo)},YXt=g.getDefaultValues(ine),Kl=y();function fMe(t,e,r,n,o,i){let a=e.polymerElements.length;if(!a)return Be.createEmpty(i);let{sizeFactor:s,detail:l,linearSegments:c,radialSegments:u}=o,d=c*u*a+(u+1)*a*2,m=Te.createState(d,d/10,i),p=gb(c),{curvePoints:h,normalVectors:f,binormalVectors:b,widthValues:v,heightValues:x}=p,S=0,T=mb(e,r,{ignoreSecondaryStructure:!0});for(;T.hasNext;){let D=T.move();m.currentGroup=S;let A=Yo(D.moleculeType)?Py:_y;yb(p,D,$P,A);let I=D.coarseBackboneFirst||D.first,k=D.coarseBackboneLast||D.last,M=n.size.size(D.centerPrev)*s,R=n.size.size(D.center)*s,B=n.size.size(D.centerNext)*s;WS(p,M,R,B,M,R,B,A);let F=c;if(D.initial){F=Math.max(Math.round(c*A),1);let G=c-F;h.copyWithin(0,G*3),b.copyWithin(0,G*3),f.copyWithin(0,G*3),v.copyWithin(0,G*3),x.copyWithin(0,G*3),y.fromArray(Kl,h,3),y.normalize(Kl,y.sub(Kl,D.p2,Kl)),y.scaleAndAdd(Kl,D.p2,Kl,R*vb),y.toArray(Kl,h,0)}else D.final&&(F=Math.max(Math.round(c*(1-A)),1),y.fromArray(Kl,h,F*3-3),y.normalize(Kl,y.sub(Kl,D.p2,Kl)),y.scaleAndAdd(Kl,D.p2,Kl,R*vb),y.toArray(Kl,h,F*3));D.initial===!0&&D.final===!0?Jt(m,D.p2,R*2,l):u===2?zb(m,h,f,b,F,v,x,0):u===4?Nb(m,h,f,b,F,v,x,0,I,k):QS(m,h,f,b,F,u,v,x,I,k,"elliptical"),++S}let E=Te.getMesh(m),_=te.expand(te(),e.boundary.sphere,1*o.sizeFactor);return E.setBoundingSphere(_),E}var dF=w(w({},Gr),ine);function ane(t){return rn({defaultProps:g.getDefaultValues(dF),createGeometry:fMe,createLocationIterator:e=>Wl.fromGroup(e,{asSecondary:!0}),getLoci:Au,eachLocation:ku,setUpdateState:(e,r,n)=>{e.createGeometry=r.sizeFactor!==n.sizeFactor||r.detail!==n.detail||r.linearSegments!==n.linearSegments||r.radialSegments!==n.radialSegments}},t)}var sne={"polymer-tube":(t,e)=>Dr("Polymer tube mesh",t,e,ane),"polymer-gap":(t,e)=>Dr("Polymer gap cylinder",t,e,Ob)},lne=U(w(w({},dF),Ay),{sizeFactor:g.Numeric(.2,{min:0,max:10,step:.01}),visuals:g.MultiSelect(["polymer-tube","polymer-gap"],g.objectToOptions(sne)),bumpFrequency:g.Numeric(2,{min:0,max:10,step:.1},ge.ShadingCategory)});function hMe(t,e){let r=g.clone(lne),n=!1,o=!1;return e.units.forEach(i=>{!n&&Pe.isAtomic(i)&&i.nucleotideElements.length&&(n=!0),!o&&i.gapElements.length&&(o=!0)}),r.visuals.defaultValue=["polymer-tube"],o&&r.visuals.defaultValue.push("polymer-gap"),r}function gMe(t,e){return rt.createMulti("Putty",t,e,Qr,sne)}var cne={name:"putty",label:"Putty",description:"Displays a tube smoothly following the trace atoms of polymers.",factory:gMe,getParams:hMe,defaultValues:g.getDefaultValues(lne),defaultColorTheme:{name:"chain-id"},defaultSizeTheme:{name:"uncertainty"},isApplicable:t=>t.polymerResidueCount>0};var une={"element-sphere":(t,e)=>Dr("Sphere mesh/impostor",t,e,HP),"structure-element-sphere":(t,e)=>_o("Structure sphere mesh/impostor",t,e,jee)},mF=U(w({},db),{bumpFrequency:g.Numeric(1,{min:0,max:10,step:.1},ge.ShadingCategory),visuals:g.MultiSelect(["element-sphere"],g.objectToOptions(une))}),DE;function yMe(t,e){return e.isCoarseGrained?(DE||(DE=g.clone(mF),DE.sizeFactor.defaultValue=2),DE):mF}function vMe(t,e){return rt.createMulti("Spacefill",t,e,Qr,une)}var dne={name:"spacefill",label:"Spacefill",description:"Displays atomic/coarse elements as spheres.",factory:vMe,getParams:yMe,defaultValues:g.getDefaultValues(mF),defaultColorTheme:{name:"element-symbol"},defaultSizeTheme:{name:"physical"},isApplicable:t=>t.elementCount>0};var pF=Pr.is;function bMe(t,e,r,n,o,i){if(!Pe.isAtomic(e))return Sr.createEmpty(i);let{child:a}=r,s=a?.unitMap.get(e.id);if(a&&!s)return Sr.createEmpty(i);let l=z.Location.create(r,e),c=e.elements,u=e.bonds,{edgeCount:d,a:m,b:p,edgeProps:h,offset:f}=u;if(!d)return Sr.createEmpty(i);let{order:b,flags:v}=h,{sizeFactor:x,aromaticBonds:S,includeTypes:T,excludeTypes:E,multipleBonds:_}=o,D=_==="off",P=_==="symmetric",A=Pr.fromNames(T),I=Pr.fromNames(E),k=sb(A,I,32),M=y(),R=e.conformation,{elementRingIndices:B,elementAromaticRingIndices:F}=e.rings,G=S?e.resonance.delocalizedTriplets:void 0,V={linkCount:d*2,referencePosition:L=>{let Y=m[L],j=p[L],O=G?.getThirdElement(Y,j);if(O!==void 0)return R.invariantPosition(c[O],M);Y>j&&([Y,j]=[j,Y]),f[Y+1]-f[Y]===1&&([Y,j]=[j,Y]);let J=F.get(Y)||B.get(Y),$=0;for(let ae=f[Y],Z=f[Y+1];ae<Z;++ae){let se=p[ae];if(se!==j&&se!==Y)if(J){let Me=F.get(se)||B.get(se);if(!Me)continue;let be=y0(J,Me);be>$&&($=be,R.invariantPosition(c[se],M))}else return R.invariantPosition(c[se],M)}return $>0?M:null},position:(L,Y,j)=>{R.invariantPosition(c[m[j]],L),R.invariantPosition(c[p[j]],Y)},style:L=>{let Y=b[L],j=v[L];if(pF(j,2)||pF(j,4))return 1;if(Y===3)return D?0:P?4:5;if(S){let O=m[L],J=p[L],$=F.get(O),ae=F.get(J),Z=$&&ae?y0($,ae):0;if(pF(j,16)||Z&&!k)return Z===2?8:7}return Y!==2||D?0:P?2:3},radius:L=>{l.element=c[m[L]];let Y=n.size.size(l);l.element=c[p[L]];let j=n.size.size(l);return Math.min(Y,j)*x},ignore:zP(r,e,o)},{lines:H,boundingSphere:Q}=X_(t,V,o,i);if(Q)H.setBoundingSphere(Q);else if(H.lineCount>0){let L=te.expand(te(),(s??e).boundary.sphere,1*x);H.setBoundingSphere(L)}return H}var fF=U(w(w({},bh),NS),{includeParent:g.Boolean(!1)});function mne(t){return xh({defaultProps:g.getDefaultValues(fF),createGeometry:bMe,createLocationIterator:e=>Eu.fromGroup(e),getLoci:VS,eachLocation:zS,setUpdateState:(e,r,n,o,i,a,s)=>{e.createGeometry=r.sizeFactor!==n.sizeFactor||r.linkScale!==n.linkScale||r.linkSpacing!==n.linkSpacing||r.aromaticDashCount!==n.aromaticDashCount||r.dashCount!==n.dashCount||r.ignoreHydrogens!==n.ignoreHydrogens||r.ignoreHydrogensVariant!==n.ignoreHydrogensVariant||!gs(r.includeTypes,n.includeTypes)||!gs(r.excludeTypes,n.excludeTypes)||r.aromaticBonds!==n.aromaticBonds||r.multipleBonds!==n.multipleBonds;let l=a.group.units[0],c=s.group.units[0];Pe.isAtomic(l)&&Pe.isAtomic(c)&&(_g.areEqual(l.bonds,c.bonds)||(e.createGeometry=!0,e.updateTransform=!0,e.updateColor=!0,e.updateSize=!0))}},t)}var hF=new ze.ElementBondIterator;function pne(t,e,r,n){for(hF.setElement(e,r,n);hF.hasNext;){let o=hF.move();return o.otherUnit.conformation.position(o.otherUnit.elements[o.otherIndex],t),t}return null}function xMe(t,e,r,n,o){let i=e.interUnitBonds,{edgeCount:a,edges:s}=i;if(!a)return Sr.createEmpty(o);let{sizeFactor:l,aromaticBonds:c,multipleBonds:u}=n,d=u==="off",m=u==="symmetric",p=y(),h=z.Location.create(),f={linkCount:a,referencePosition:x=>{let S=s[x],T,E,_,D;if(S.unitA<S.unitB)T=e.unitMap.get(S.unitA),E=e.unitMap.get(S.unitB),_=S.indexA,D=S.indexB;else if(S.unitA>S.unitB)T=e.unitMap.get(S.unitB),E=e.unitMap.get(S.unitA),_=S.indexB,D=S.indexA;else throw new Error("same units in createInterUnitBondLines");return pne(p,e,T,_)||pne(p,e,E,D)},position:(x,S,T)=>{let E=s[T],_=e.unitMap.get(E.unitA),D=e.unitMap.get(E.unitB);_.conformation.position(_.elements[E.indexA],x),D.conformation.position(D.elements[E.indexB],S)},style:x=>{let S=s[x].props.order,T=Wc.create(s[x].props.flag);return Pr.is(T,2)||Pr.is(T,4)?1:S===3?d?0:m?4:5:c&&Pr.is(T,16)?7:S!==2||d?0:m?2:3},radius:x=>{let S=s[x];h.structure=e,h.unit=e.unitMap.get(S.unitA),h.element=h.unit.elements[S.indexA];let T=r.size.size(h);h.unit=e.unitMap.get(S.unitB),h.element=h.unit.elements[S.indexB];let E=r.size.size(h);return Math.min(T,E)*l},ignore:UP(e,n)},{lines:b,boundingSphere:v}=X_(t,f,n,o);if(v)b.setBoundingSphere(v);else if(b.lineCount>0){let{child:x}=e,S=te.expand(te(),(x??e).boundary.sphere,1*l);b.setBoundingSphere(S)}return b}var gF=U(w(w({},sZ),NS),{includeParent:g.Boolean(!1)});function fne(t){return lZ({defaultProps:g.getDefaultValues(gF),createGeometry:xMe,createLocationIterator:e=>Eu.fromStructure(e),getLoci:US,eachLocation:GS,setUpdateState:(e,r,n,o,i,a,s)=>{e.createGeometry=r.sizeFactor!==n.sizeFactor||r.linkScale!==n.linkScale||r.linkSpacing!==n.linkSpacing||r.aromaticDashCount!==n.aromaticDashCount||r.dashCount!==n.dashCount||r.ignoreHydrogens!==n.ignoreHydrogens||r.ignoreHydrogensVariant!==n.ignoreHydrogensVariant||!gs(r.includeTypes,n.includeTypes)||!gs(r.excludeTypes,n.excludeTypes)||r.multipleBonds!==n.multipleBonds,a.interUnitBonds!==s.interUnitBonds&&(e.createGeometry=!0,e.updateTransform=!0,e.updateColor=!0,e.updateSize=!0)}},t)}var jb=y.scaleAndAdd,hne=y.unitX,gne=y.unitY,yne=y.unitZ,yF=U(w({},bh),{lineSizeAttenuation:g.Boolean(!1),ignoreHydrogens:g.Boolean(!1),ignoreHydrogensVariant:g.Select("all",g.arrayToOptions(["all","non-polar"])),traceOnly:g.Boolean(!1),crosses:g.Select("lone",g.arrayToOptions(["lone","all"])),crossSize:g.Numeric(.35,{min:0,max:2,step:.01})});function SMe(t,e,r,n,o,i){let{child:a}=r;if(a&&!a.unitMap.get(e.id))return Sr.createEmpty(i);let s=e.elements,l=s.length,c=vi.create(l,l/10,i),u=y(),d=y(),m=y(),p=e.conformation,h=Mm(r,e,o),f=o.crossSize/2,b=o.crosses==="lone";for(let S=0;S<l;++S)h&&h(s[S])||b&&Pe.isAtomic(e)&&Ul(r,e,S)!==0||(p.invariantPosition(s[S],u),jb(d,u,hne,f),jb(m,u,hne,-f),c.add(d[0],d[1],d[2],m[0],m[1],m[2],S),jb(d,u,gne,f),jb(m,u,gne,-f),c.add(d[0],d[1],d[2],m[0],m[1],m[2],S),jb(d,u,yne,f),jb(m,u,yne,-f),c.add(d[0],d[1],d[2],m[0],m[1],m[2],S));let v=c.getLines(),x=te.expand(te(),e.boundary.sphere,1*o.sizeFactor);return v.setBoundingSphere(x),v}function vne(t){return xh({defaultProps:g.getDefaultValues(yF),createGeometry:SMe,createLocationIterator:jn.fromGroup,getLoci:Wi,eachLocation:qi,setUpdateState:(e,r,n)=>{e.createGeometry=r.ignoreHydrogens!==n.ignoreHydrogens||r.ignoreHydrogensVariant!==n.ignoreHydrogensVariant||r.traceOnly!==n.traceOnly||r.crosses!==n.crosses||r.crossSize!==n.crossSize}},t)}var bne={"intra-bond":(t,e)=>Dr("Intra-unit bond line",t,e,mne),"inter-bond":(t,e)=>_o("Inter-unit bond line",t,e,fne),"element-point":(t,e)=>Dr("Points",t,e,IE),"element-cross":(t,e)=>Dr("Crosses",t,e,vne)},vF=U(w(w(w(w({},fF),gF),JS),yF),{pointStyle:g.Select("circle",g.objectToOptions(Il.StyleTypes)),multipleBonds:g.Select("offset",g.arrayToOptions(["off","symmetric","offset"])),includeParent:g.Boolean(!1),sizeFactor:g.Numeric(2,{min:.01,max:10,step:.01}),unitKinds:Ip(["atomic"]),visuals:g.MultiSelect(["intra-bond","inter-bond","element-point","element-cross"],g.objectToOptions(bne))});function CMe(t,e){if(ue.getSize(e)>=ue.Size.Huge){let n=g.clone(vF);return n.visuals.defaultValue=["intra-bond","element-point","element-cross"],n}else return vF}function TMe(t,e){return rt.createMulti("Line",t,e,Qr,bne)}var xne={name:"line",label:"Line",description:"Displays bonds as lines and atoms as points or croses.",factory:TMe,getParams:CMe,defaultValues:g.getDefaultValues(vF),defaultColorTheme:{name:"element-symbol"},defaultSizeTheme:{name:"uniform"},isApplicable:t=>t.elementCount>0,getData:(t,e)=>e.includeParent?t.asParent():t,mustRecreate:(t,e)=>t.includeParent!==e.includeParent};function wMe(t,e,r,n,o){return N(this,null,function*(){let{runtime:i,webgl:a}=t;if(!a||!a.extensions.blendMinMax)throw new Error("GaussianDensityVolume requires `webgl` and `blendMinMax` extension");let s=o?o.gridTexture.ref.value:void 0,l=yield Ire(e,r.size,n,a,s).runInContext(i),{transform:c,texture:u,bbox:d,gridDim:m}=l,p={min:0,max:1,mean:.04,sigma:.01},h=W.mul(W(),c,W.fromScaling(W(),m)),f=W.getScaling(y(),c),b=y.create(0,1,2),v=ta.create(d,m,c,h,f,u,p,!0,b,o),x=te.expand(te(),e.boundary.sphere,l.maxRadius);return v.setBoundingSphere(x),v})}var bF=U(w(w({},dZ),Uh),{ignoreHydrogens:g.Boolean(!1),ignoreHydrogensVariant:g.Select("all",g.arrayToOptions(["all","non-polar"])),includeParent:g.Boolean(!1,{isHidden:!0})});function Sne(t){return mZ({defaultProps:g.getDefaultValues(bF),createGeometry:wMe,createLocationIterator:jn.fromStructure,getLoci:Du,eachLocation:Iu,setUpdateState:(e,r,n)=>{r.resolution!==n.resolution&&(e.createGeometry=!0),r.radiusOffset!==n.radiusOffset&&(e.createGeometry=!0),r.smoothness!==n.smoothness&&(e.createGeometry=!0),r.ignoreHydrogens!==n.ignoreHydrogens&&(e.createGeometry=!0),r.ignoreHydrogensVariant!==n.ignoreHydrogensVariant&&(e.createGeometry=!0),r.traceOnly!==n.traceOnly&&(e.createGeometry=!0),r.includeParent!==n.includeParent&&(e.createGeometry=!0)},dispose:e=>{e.gridTexture.ref.value.destroy()}},t)}function _Me(t,e,r,n,o,i){return N(this,null,function*(){let{runtime:a,webgl:s}=t;if(!s)throw new Error("GaussianDensityVolume requires `webgl`");let l=i?i.gridTexture.ref.value:void 0,c=yield _re(r,e,n.size,o,s,l).runInContext(a),{transform:u,texture:d,bbox:m,gridDim:p}=c,h={min:0,max:1,mean:.04,sigma:.01},f=W.mul(W(),u,W.fromScaling(W(),p)),b=W.getScaling(y(),u),v=y.create(0,1,2),x=ta.create(m,p,u,f,b,d,h,!0,v,i),S=te.expand(te(),e.boundary.sphere,c.maxRadius);return x.setBoundingSphere(S),x})}var PMe=U(w(w({},yZ),Uh),{ignoreHydrogens:g.Boolean(!1),ignoreHydrogensVariant:g.Select("all",g.arrayToOptions(["all","non-polar"])),includeParent:g.Boolean(!1,{isHidden:!0})});function Cne(t){return vZ({defaultProps:g.getDefaultValues(PMe),createGeometry:_Me,createLocationIterator:jn.fromGroup,getLoci:Wi,eachLocation:qi,setUpdateState:(e,r,n)=>{r.resolution!==n.resolution&&(e.createGeometry=!0),r.radiusOffset!==n.radiusOffset&&(e.createGeometry=!0),r.smoothness!==n.smoothness&&(e.createGeometry=!0),r.ignoreHydrogens!==n.ignoreHydrogens&&(e.createGeometry=!0),r.ignoreHydrogensVariant!==n.ignoreHydrogensVariant&&(e.createGeometry=!0),r.traceOnly!==n.traceOnly&&(e.createGeometry=!0),r.includeParent!==n.includeParent&&(e.createGeometry=!0)},dispose:e=>{e.gridTexture.ref.value.destroy()}},t)}var Tne={"gaussian-volume":(t,e)=>_o("Gaussian volume",t,e,Sne),"units-gaussian-volume":(t,e)=>Dr("Units-Gaussian volume",t,e,Cne)},wne=U(w({},bF),{jumpLength:g.Numeric(4,{min:0,max:20,step:.1}),visuals:g.MultiSelect(["gaussian-volume"],g.objectToOptions(Tne))});function EMe(t,e){return wne}function IMe(t,e){return rt.createMulti("Gaussian Volume",t,e,Qr,Tne)}var _ne={name:"gaussian-volume",label:"Gaussian Volume",description:"Displays a gaussian molecular density using direct volume rendering.",factory:IMe,getParams:EMe,defaultValues:g.getDefaultValues(wne),defaultColorTheme:{name:"chain-id"},defaultSizeTheme:{name:"physical"},isApplicable:t=>t.elementCount>0};var DMe=y.scale,AMe=y.add,kMe=y.sub,AE=U(w(w({},Gr),qv),{sizeFactor:g.Numeric(.3,{min:0,max:10,step:.01}),radialSegments:g.Numeric(16,{min:2,max:56,step:2},ge.CustomQualityParamInfo),tryUseImpostor:g.Boolean(!0)});function Pne(t,e,r,n){return r.tryUseImpostor&&n&&n.extensions.fragDepth?RMe(t):BMe(t)}function MMe(t,e,r,n,o,i){let a=e.polymerElements.length;if(!a)return xo.createEmpty(i);let s=a*2,l=Sh.create(s,s/4,i),c=e.conformation,u=y(),d=y(),m=y();CO(e,function(b,v,x,S,T){c.invariantPosition(b,u),c.invariantPosition(v,d);let _=Yo(T)?Py:_y;AMe(m,u,DMe(m,kMe(m,d,u),_)),l.add(u[0],u[1],u[2],m[0],m[1],m[2],1,!1,!1,2,x),l.add(m[0],m[1],m[2],d[0],d[1],d[2],1,!1,!1,2,S)});let h=l.getCylinders(),f=te.expand(te(),e.boundary.sphere,1*o.sizeFactor);return h.setBoundingSphere(f),h}function RMe(t){return Wv({defaultProps:g.getDefaultValues(AE),createGeometry:MMe,createLocationIterator:e=>Wl.fromGroup(e),getLoci:Au,eachLocation:ku,setUpdateState:(e,r,n)=>{},mustRecreate:(e,r,n)=>!r.tryUseImpostor||!n},t)}function LMe(t,e,r,n,o,i){let a=e.polymerElements.length;if(!a)return Be.createEmpty(i);let{radialSegments:s,sizeFactor:l}=o,c=s*2*a*2,u=Te.createState(c,c/10,i),d=e.conformation,m=y(),p=y(),h={radiusTop:1,radiusBottom:1,radialSegments:s},f=z.Location.create(r,e),b=z.Location.create(r,e);CO(e,function(T,E,_,D,P){f.element=T,b.element=E,d.invariantPosition(f.element,m),d.invariantPosition(b.element,p);let I=Yo(P)?Py:_y;h.radiusTop=h.radiusBottom=n.size.size(f)*l,u.currentGroup=_,nr(u,m,p,I,h),h.radiusTop=h.radiusBottom=n.size.size(b)*l,u.currentGroup=D,nr(u,p,m,1-I,h)});let x=Te.getMesh(u),S=te.expand(te(),e.boundary.sphere,1*o.sizeFactor);return x.setBoundingSphere(S),x}function BMe(t){return rn({defaultProps:g.getDefaultValues(AE),createGeometry:LMe,createLocationIterator:e=>Wl.fromGroup(e),getLoci:Au,eachLocation:ku,setUpdateState:(e,r,n)=>{e.createGeometry=r.sizeFactor!==n.sizeFactor||r.radialSegments!==n.radialSegments},mustRecreate:(e,r,n)=>r.tryUseImpostor&&!!n},t)}var kE=U(w(w({},Gr),jv),{sizeFactor:g.Numeric(.3,{min:0,max:10,step:.01}),detail:g.Numeric(0,{min:0,max:3,step:1},ge.CustomQualityParamInfo),tryUseImpostor:g.Boolean(!0)});function Ene(t,e,r,n){return r.tryUseImpostor&&n&&n.extensions.fragDepth&&n.extensions.textureFloat?FMe(t):VMe(t)}function OMe(t,e,r,n,o,i){let a=e.polymerElements.length;if(!a)return Ni.createEmpty(i);let s=Op.create(a,a/2,i),l=e.conformation,c=y();TO(e,(p,h)=>{l.invariantPosition(p,c),s.add(c[0],c[1],c[2],h)});let d=s.getSpheres(),m=te.expand(te(),e.boundary.sphere,1*o.sizeFactor);return d.setBoundingSphere(m),d}function FMe(t){return Hv({defaultProps:g.getDefaultValues(kE),createGeometry:OMe,createLocationIterator:e=>Wl.fromGroup(e),getLoci:Au,eachLocation:ku,setUpdateState:(e,r,n)=>{},mustRecreate:(e,r,n)=>!r.tryUseImpostor||!n},t)}function NMe(t,e,r,n,o,i){let a=e.polymerElements.length;if(!a)return Be.createEmpty(i);let{detail:s,sizeFactor:l}=o,c=a*Sd(s),u=Te.createState(c,c/2,i),d=e.conformation,m=y(),p=z.Location.create(r,e);TO(e,(v,x)=>{p.element=v,d.invariantPosition(p.element,m),u.currentGroup=x,Jt(u,m,n.size.size(p)*l,s)});let f=Te.getMesh(u),b=te.expand(te(),e.boundary.sphere,1*o.sizeFactor);return f.setBoundingSphere(b),f}function VMe(t){return rn({defaultProps:g.getDefaultValues(kE),createGeometry:NMe,createLocationIterator:e=>Wl.fromGroup(e),getLoci:Au,eachLocation:ku,setUpdateState:(e,r,n)=>{e.createGeometry=r.sizeFactor!==n.sizeFactor||r.detail!==n.detail},mustRecreate:(e,r,n)=>r.tryUseImpostor&&!!n},t)}var Ine={"polymer-backbone-cylinder":(t,e)=>Dr("Polymer backbone cylinder",t,e,Pne),"polymer-backbone-sphere":(t,e)=>Dr("Polymer backbone sphere",t,e,Ene),"polymer-gap":(t,e)=>Dr("Polymer gap cylinder",t,e,Ob)},Dne=U(w(w(w({},kE),AE),Ay),{sizeAspectRatio:g.Numeric(1,{min:.1,max:3,step:.1}),visuals:g.MultiSelect(["polymer-backbone-cylinder","polymer-backbone-sphere","polymer-gap"],g.objectToOptions(Ine)),bumpFrequency:g.Numeric(0,{min:0,max:10,step:.1},ge.ShadingCategory),colorMode:g.Select("default",g.arrayToOptions(["default","interpolate"]),U(w({},ge.ShadingCategory),{isHidden:!0}))});function zMe(t,e){let r=g.clone(Dne),n=!1;return e.units.forEach(o=>{!n&&o.gapElements.length&&(n=!0)}),r.visuals.defaultValue=["polymer-backbone-cylinder","polymer-backbone-sphere"],n&&r.visuals.defaultValue.push("polymer-gap"),r}function UMe(t,e){return rt.createMulti("Backbone",t,e,Qr,Ine)}var Ane={name:"backbone",label:"Backbone",description:"Displays polymer backbone with cylinders and spheres.",factory:UMe,getParams:zMe,defaultValues:g.getDefaultValues(Dne),defaultColorTheme:{name:"chain-id"},defaultSizeTheme:{name:"uniform"},isApplicable:t=>t.polymerResidueCount>0};var Hb=class t extends fv{constructor(){super(),ro(t.BuiltIn,(e,r)=>{if(e.name!==r)throw new Error(`Fix BuiltInStructureRepresentations to have matching names. ${e.name} ${r}`);this.add(e)})}};(function(t){t.BuiltIn={cartoon:lre,backbone:Ane,"ball-and-stick":qee,carbohydrate:cte,ellipsoid:mre,"gaussian-surface":Nre,"gaussian-volume":_ne,label:Gre,line:xne,"molecular-surface":$re,orientation:tne,point:one,putty:cne,spacefill:dne}})(Hb||(Hb={}));var ME=class{get isAnimating(){return this._isAnimating}tick(e,r){return N(this,null,function*(){var n,o;if(yield this.plugin.managers.animation.tick(e,r?.isSynchronous,r?.animation),(n=this.plugin.canvas3d)===null||n===void 0||n.tick(e,r),Ee){let i=(o=this.plugin.canvas3d)===null||o===void 0?void 0:o.webgl.timer.resolve();if(i)for(let a of i)FA([a])}})}resetTime(e=ko()){var r;(r=this.plugin.canvas3d)===null||r===void 0||r.resetTime(e)}start(e){var r;(r=this.plugin.canvas3d)===null||r===void 0||r.resume(),this._isAnimating=!0,this.resetTime(),e?.immediate?this.frame():this.currentFrame=requestAnimationFrame(this.frame)}stop(e){var r;this._isAnimating=!1,this.currentFrame!==void 0&&(cancelAnimationFrame(this.currentFrame),this.currentFrame=void 0),e?.noDraw&&((r=this.plugin.canvas3d)===null||r===void 0||r.pause(e?.noDraw))}constructor(e){this.plugin=e,this.currentFrame=void 0,this._isAnimating=!1,this.frame=()=>{this.tick(ko()),this._isAnimating&&(this.currentFrame=requestAnimationFrame(this.frame))}}};var Gh=class t extends Ed{get animation(){return this.plugin.managers.animation}getSnapshot(e){var r,n,o;let i=w(w({},this.snapshotParams.value),e);return{id:vo.create22(),data:i.data?this.data.getSnapshot():void 0,behaviour:i.behavior?this.behaviors.getSnapshot():void 0,animation:i.animation?this.animation.getSnapshot():void 0,startAnimation:i.startAnimation?!!i.startAnimation:void 0,camera:i.camera?{current:this.plugin.canvas3d.camera.getSnapshot(),transitionStyle:i.cameraTransition.name,transitionDurationInMs:((r=i?.cameraTransition)===null||r===void 0?void 0:r.name)==="animate"?i.cameraTransition.params.durationInMs:void 0}:void 0,canvas3dContext:i.canvas3dContext?{props:(n=this.plugin.canvas3dContext)===null||n===void 0?void 0:n.props}:void 0,canvas3d:i.canvas3d?{props:(o=this.plugin.canvas3d)===null||o===void 0?void 0:o.props}:void 0,interactivity:i.interactivity?{props:this.plugin.managers.interactivity.props}:void 0,structureFocus:this.plugin.managers.structure.focus.getSnapshot(),structureSelection:i.structureSelection?this.plugin.managers.structure.selection.getSnapshot():void 0,structureComponentManager:i.componentManager?{options:this.plugin.managers.structure.component.state.options}:void 0,durationInMs:i?.durationInMs}}setSnapshot(e){return N(this,null,function*(){var r,n,o,i,a;if(yield this.animation.stop(),!((r=e.structureComponentManager)===null||r===void 0)&&r.options&&this.plugin.managers.structure.component._setSnapshotState((n=e.structureComponentManager)===null||n===void 0?void 0:n.options),e.behaviour&&(yield this.plugin.runTask(this.behaviors.setSnapshot(e.behaviour))),e.data&&(yield this.plugin.runTask(this.data.setSnapshot(e.data))),!((o=e.canvas3d)===null||o===void 0)&&o.props){let s=g.normalizeParams(Fa,e.canvas3d.props,"children");yield Re.Canvas3D.SetSettings(this.plugin,{settings:s})}if(!((i=e.canvas3dContext)===null||i===void 0)&&i.props){let s=g.normalizeParams(Ad.Params,e.canvas3dContext.props,"children");(a=this.plugin.canvas3dContext)===null||a===void 0||a.setProps(s)}e.interactivity&&e.interactivity.props&&this.plugin.managers.interactivity.setProps(e.interactivity.props),e.structureFocus&&this.plugin.managers.structure.focus.setSnapshot(e.structureFocus),e.structureSelection&&this.plugin.managers.structure.selection.setSnapshot(e.structureSelection),e.animation&&this.animation.setSnapshot(e.animation),e.camera&&Re.Camera.Reset(this.plugin,{snapshot:e.camera.current,durationMs:e.camera.transitionStyle==="animate"?e.camera.transitionDurationInMs:void 0}),e.startAnimation&&this.animation.start()})}updateTransform(e,r,n,o){let i=e.build().to(r).update(n);return Re.State.Update(this.plugin,{state:e,tree:i,options:{canUndo:o}})}hasBehavior(e){return this.behaviors.tree.transforms.has(e.id)}updateBehavior(e,r){let n=this.behaviors.build();if(this.behaviors.tree.transforms.has(e.id))n.to(e.id).update(r);else{let o=e.createDefaultParams(void 0,this.plugin);n.to(rr.getCategoryId(e)).apply(e,ss(o,r),{ref:e.id})}return this.plugin.runTask(this.behaviors.updateTree(n))}dispose(){this.behaviors.cells.forEach(e=>{var r,n,o,i;rr.Behavior.is(e.obj)&&((n=(r=e.obj.data).unregister)===null||n===void 0||n.call(r),(i=(o=e.obj.data).dispose)===null||i===void 0||i.call(o))}),super.dispose(),this.data.dispose(),this.behaviors.dispose(),this.animation.dispose()}constructor(e){super(),this.plugin=e,this.data=Ll.create(new X.Root({}),{runTask:this.plugin.runTask,globalContext:this.plugin,historyCapacity:this.plugin.config.get(Wt.State.HistoryCapacity)}),this.behaviors=Ll.create(new rr.Root({}),{runTask:this.plugin.runTask,globalContext:this.plugin,rootState:{isLocked:!0}}),this.events={cell:{stateUpdated:ad(this.data.events.cell.stateUpdated,this.behaviors.events.cell.stateUpdated),created:ad(this.data.events.cell.created,this.behaviors.events.cell.created),removed:ad(this.data.events.cell.removed,this.behaviors.events.cell.removed)},object:{created:ad(this.data.events.object.created,this.behaviors.events.object.created),removed:ad(this.data.events.object.removed,this.behaviors.events.object.removed),updated:ad(this.data.events.object.updated,this.behaviors.events.object.updated)}},this.snapshotParams=this.ev.behavior(t.DefaultSnapshotParams),this.setSnapshotParams=r=>{this.snapshotParams.next(w(w({},t.DefaultSnapshotParams),r))}}};(function(t){t.SnapshotParams={durationInMs:g.Numeric(1500,{min:100,max:15e3,step:100},{label:"Duration in ms"}),data:g.Boolean(!0),behavior:g.Boolean(!1),structureSelection:g.Boolean(!1),componentManager:g.Boolean(!0),animation:g.Boolean(!0),startAnimation:g.Boolean(!1),canvas3d:g.Boolean(!0),canvas3dContext:g.Boolean(!0),interactivity:g.Boolean(!0),camera:g.Boolean(!0),cameraTransition:g.MappedStatic("animate",{animate:g.Group({durationInMs:g.Numeric(250,{min:100,max:5e3,step:500},{label:"Duration in ms"})}),instant:g.Group({})},{options:[["animate","Animate"],["instant","Instant"]]}),image:g.Boolean(!1)},t.DefaultSnapshotParams=g.getDefaultValues(t.SnapshotParams)})(Gh||(Gh={}));var RE=class{getDecorator(e){let r=this.plugin.state.data.tree,n=r.children.get(e);if(n.size!==1)return e;let o=n.first();return r.transforms.get(o).transformer.definition.isDecorator?this.getDecorator(o):e}get(e,r=!1){let n=this.root.get(e);if(n)return r?this.plugin.state.data.cells.get(n.ref):this.plugin.state.data.cells.get(this.getDecorator(n.ref))}addMapping(e,r,n){if(!X.Molecule.Structure.is(n))return!1;if(this.tracked.set(r,n.data),this.root.has(n.data)){let o=this.root.get(n.data);o.count++}else{let o=e.select(lt.Generators.byRef(r).rootOfType([X.Molecule.Structure]))[0];o?this.root.set(n.data,{ref:o.transform.ref,count:1}):this.root.set(n.data,{ref:r,count:1})}return!0}removeMapping(e){if(!this.tracked.has(e))return!1;let r=this.tracked.get(e);this.tracked.delete(e);let n=this.root.get(r);return n.count>1?n.count--:this.root.delete(r),!0}updateMapping(e,r,n,o){return X.Molecule.Structure.is(o)?(this.removeMapping(r),this.addMapping(e,r,o),!0):!1}dispose(){this.ev.dispose()}constructor(e){this.plugin=e,this.ev=_s.create(),this.events={updated:this.ev(),removed:this.ev()},this.root=new Map,this.tracked=new Map,e.state.data.events.object.created.subscribe(r=>{this.addMapping(r.state,r.ref,r.obj)}),e.state.data.events.object.removed.subscribe(r=>{this.removeMapping(r.ref)&&this.events.removed.next({ref:r.ref,obj:r.obj})}),e.state.data.events.object.updated.subscribe(r=>{this.updateMapping(r.state,r.ref,r.oldObj,r.obj)&&this.events.updated.next({ref:r.ref,oldObj:r.oldObj,obj:r.obj})})}};var qb=class{constructor(){this.ev=_s.create(),this.id=0,this.runningTasks=new Set,this.abortRequests=new Map,this.options=new Map,this.currentContext=[],this.events={progress:this.ev(),finished:this.ev()}}tryGetAbortTaskId(e){if(this.abortRequests.has(e.progress.taskId))return e.progress.taskId;for(let r of e.children){let n=this.tryGetAbortTaskId(r);if(n!==void 0)return n}}track(e,r){return n=>{var o;if(n.canAbort&&n.requestAbort){let a=this.tryGetAbortTaskId(n.root);a!==void 0&&n.requestAbort(this.abortRequests.get(a))}let i=ko()-n.root.progress.startedTime;this.events.progress.next({id:e,useOverlay:(o=this.options.get(r))===null||o===void 0?void 0:o.useOverlay,level:i<250?"none":"background",progress:n})}}run(e,r){return N(this,null,function*(){let n=this.id++,o;r?.createNewContext||this.currentContext.length===0?o={ctx:Oz(e,this.track(n,e.id),100),refCount:1}:(o=this.currentContext[this.currentContext.length-1],o.refCount++);try{return this.options.set(e.id,{useOverlay:!!r?.useOverlay}),this.runningTasks.add(e.id),yield Fz(o.ctx,e)}finally{this.options.delete(e.id),this.runningTasks.delete(e.id),this.events.finished.next({id:n}),this.abortRequests.delete(e.id),o.refCount--,o.refCount===0&&rp(this.currentContext,o)}})}requestAbortAll(e){this.runningTasks.forEach(r=>this.abortRequests.set(r,e))}requestAbort(e,r){let n=typeof e=="number"?e:e.root.progress.taskId;this.abortRequests.set(n,r)}dispose(){this.ev.dispose()}};(function(t){function e(n){return new Promise(o=>setTimeout(o,n))}function r(n){return ie.create("Test",o=>N(this,null,function*(){let i=0;for(;i<n;)yield e(100+Math.random()*200),o.shouldUpdate&&(yield o.update({message:"Step "+i,current:i,max:n,isIndeterminate:!1})),i++}))}t.testTask=r})(qb||(qb={}));var LE=class extends ji{findByKey(e){return this.state.entries.find(r=>!!r&&r.key===e)}show(e){let r=this.state.entries,n,o=++this.serialId,i;e.key&&(n=this.findByKey(e.key))?(n.timeout!==void 0&&clearTimeout(n.timeout),i=n.serialNumber,r=r.remove(n.id)):i=++this.serialNumber,n={id:o,serialNumber:i,key:e.key,title:e.title,message:e.message,timeout:this.timeout(o,e.timeoutMs),hide:()=>this.hideId(o)},this.updateState({entries:r.set(o,n)})&&this.events.changed.next(void 0)}timeout(e,r){if(r!==void 0)return r<0&&(r=500),setTimeout(()=>{let n=this.state.entries.get(e);n.timeout=void 0,this.hide(n)},r)}hideId(e){this.hide(this.state.entries.get(e))}hide(e){e&&(e.timeout!==void 0&&clearTimeout(e.timeout),e.hide=void 0,this.updateState({entries:this.state.entries.delete(e.id)})&&this.events.changed.next(void 0))}constructor(e){super({entries:Ui()}),this.events={changed:this.ev()},this.serialNumber=0,this.serialId=0,Re.Toast.Show.subscribe(e,r=>this.show(r)),Re.Toast.Hide.subscribe(e,r=>this.hide(this.findByKey(r.key)))}};var BE=class extends Ed{createParams(){let e=Math.min(this.plugin.canvas3d?this.plugin.canvas3d.webgl.maxRenderbufferSize:4096,4096);return{resolution:g.MappedStatic("viewport",{viewport:g.Group({}),hd:g.Group({}),"full-hd":g.Group({}),"ultra-hd":g.Group({}),custom:g.Group({width:g.Numeric(1920,{min:128,max:e,step:1}),height:g.Numeric(1080,{min:128,max:e,step:1})},{isFlat:!0})},{options:[["viewport","Viewport"],["hd","HD (1280 x 720)"],["full-hd","Full HD (1920 x 1080)"],["ultra-hd","Ultra HD (3840 x 2160)"],["custom","Custom"]]}),transparent:g.Boolean(!1),axes:dh.axes}}get params(){return this._params?this._params:this._params=this.createParams()}get values(){return this.behaviors.values.value}get cropParams(){return this.behaviors.cropParams.value}get relativeCrop(){return this.behaviors.relativeCrop.value}getCanvasSize(){var e,r;return{width:((e=this.plugin.canvas3d)===null||e===void 0?void 0:e.webgl.gl.drawingBufferWidth)||0,height:((r=this.plugin.canvas3d)===null||r===void 0?void 0:r.webgl.gl.drawingBufferHeight)||0}}getSize(){let e=this.values;switch(e.resolution.name){case"viewport":return this.getCanvasSize();case"hd":return{width:1280,height:720};case"full-hd":return{width:1920,height:1080};case"ultra-hd":return{width:3840,height:2160};default:return{width:e.resolution.params.width,height:e.resolution.params.height}}}createPass(e){let r=this.plugin.canvas3d,{colorBufferFloat:n,textureFloat:o}=r.webgl.extensions,i=r.props.postprocessing.occlusion;return r.getImagePass({transparentBackground:this.values.transparent,cameraHelper:{axes:this.values.axes},multiSample:U(w({},r.props.multiSample),{mode:e?"on":"off",sampleLevel:n&&o?4:2}),postprocessing:U(w({},r.props.postprocessing),{occlusion:i.name==="on"?{name:"on",params:U(w({},i.params),{samples:128,resolutionScale:r.webgl.pixelRatio})}:i}),marking:w({},r.props.marking)})}get previewPass(){return this._previewPass||(this._previewPass=this.createPass(!1))}get imagePass(){if(this._imagePass){let e=this.plugin.canvas3d,r=e.props.postprocessing.occlusion;return this._imagePass.setProps({cameraHelper:{axes:this.values.axes},transparentBackground:this.values.transparent,postprocessing:U(w({},e.props.postprocessing),{occlusion:r.name==="on"?{name:"on",params:U(w({},r.params),{samples:128,resolutionScale:e.webgl.pixelRatio})}:r}),marking:w({},e.props.marking)}),this._imagePass}return this._imagePass=this.createPass(!0)}getFilename(e=".png"){let r=this.plugin.state.data.select(lt.Generators.rootsOfType(X.Molecule.Model)).map(i=>i.obj.data),n=new Set;return r.forEach(i=>n.add(i.entryId.toUpperCase())),`${no.toArray(n).join("-")||"molstar-image"}${e}`}resetCrop(){this.behaviors.relativeCrop.next({x:0,y:0,width:1,height:1})}toggleAutocrop(){this.cropParams.auto?(this.behaviors.cropParams.next(U(w({},this.cropParams),{auto:!1})),this.resetCrop()):this.behaviors.cropParams.next(U(w({},this.cropParams),{auto:!0}))}get isFullFrame(){let e=this.relativeCrop;return bs(e.x,0,1e-5)&&bs(e.y,0,1e-5)&&bs(e.width,1,1e-5)&&bs(e.height,1,1e-5)}autocrop(e=this.cropParams.relativePadding){let{data:r,width:n,height:o}=this.previewData.image,i=this.previewData.transparent,a=i?this.previewData.background:4278190080|this.previewData.background,s=n,l=0,c=o,u=0;for(let h=0;h<o;h++){let f=h*n;for(let b=0;b<n;b++){let v=4*(f+b);if(i){if(r[v+3]===0)continue}else if((r[v]<<16|r[v+1]<<8|r[v+2]|r[v+3]<<24)===a)continue;b<s&&(s=b),b>l&&(l=b),h<c&&(c=h),h>u&&(u=h)}}if(s>l){let h=s;s=l,l=h}if(c>u){let h=c;c=u,u=h}let d=l-s+1,m=u-c+1;s-=e*d,l+=e*d,c-=e*m,u+=e*m;let p={x:Math.max(0,s/n),y:Math.max(0,c/o),width:Math.min(1,(l-s+1)/n),height:Math.min(1,(u-c+1)/o)};this.behaviors.relativeCrop.next(p)}getPreview(e=320){let{width:r,height:n}=this.getSize();if(r<=0||n<=0)return;let o=r/n,i=0,a=0;o>1?(i=e,a=Math.round(e/o)):(a=e,i=Math.round(e*o));let s=this.plugin.canvas3d.props;this.previewPass.setProps({cameraHelper:{axes:this.values.axes},transparentBackground:this.values.transparent,postprocessing:s.postprocessing,marking:s.marking});let l=this.previewPass.getImageData(i,a),c=this.previewCanvas;c.width=l.width,c.height=l.height,this.previewData.image=l,this.previewData.background=s.renderer.backgroundColor,this.previewData.transparent=this.values.transparent;let u=c.getContext("2d");if(!u)throw new Error("Could not create canvas 2d context");return u.putImageData(l,0,0),this.cropParams.auto&&this.autocrop(),this.events.previewed.next(void 0),{canvas:c,width:i,height:a}}getSizeAndViewport(){let{width:e,height:r}=this.getSize(),n=this.relativeCrop,o={x:Math.floor(n.x*e),y:Math.floor(n.y*r),width:Math.ceil(n.width*e),height:Math.ceil(n.height*r)};return o.width+o.x>e&&(o.width=e-o.x),o.height+o.y>r&&(o.height=r-o.y),{width:e,height:r,viewport:o}}draw(e){return N(this,null,function*(){let{width:r,height:n,viewport:o}=this.getSizeAndViewport();if(r<=0||n<=0)return;yield e.update("Rendering image...");let i=this.imagePass;yield i.updateBackground();let a=i.getImageData(r,n,o);yield e.update("Encoding image...");let s=this.canvas;s.width=a.width,s.height=a.height;let l=s.getContext("2d");if(!l)throw new Error("Could not create canvas 2d context");l.putImageData(a,0,0)})}copyToClipboardTask(){let e=navigator.clipboard;if(!e?.write){this.plugin.log.error("clipboard.write not supported!");return}return ie.create("Copy Image",r=>N(this,null,function*(){yield this.draw(r),yield r.update("Converting image...");let n=yield Q1(this.canvas,"png"),o=new ClipboardItem({"image/png":n});yield e.write([o]),this.plugin.log.message("Image copied to clipboard.")}))}getImageDataUri(){return this.plugin.runTask(ie.create("Generate Image",e=>N(this,null,function*(){return yield this.draw(e),yield e.update("Converting image..."),this.canvas.toDataURL("png")})))}copyToClipboard(){let e=this.copyToClipboardTask();if(e)return this.plugin.runTask(e)}downloadTask(e){return ie.create("Download Image",r=>N(this,null,function*(){yield this.draw(r),yield r.update("Downloading image...");let n=yield Q1(this.canvas,"png");zw(n,e??this.getFilename())}))}download(e){this.plugin.runTask(this.downloadTask(e))}constructor(e){super(),this.plugin=e,this._params=void 0,this.behaviors={values:this.ev.behavior({transparent:this.params.transparent.defaultValue,axes:{name:"off",params:{}},resolution:this.params.resolution.defaultValue}),cropParams:this.ev.behavior({auto:!0,relativePadding:.1}),relativeCrop:this.ev.behavior({x:0,y:0,width:1,height:1})},this.events={previewed:this.ev()},this.canvas=function(){return document.createElement("canvas")}(),this.previewCanvas=function(){return document.createElement("canvas")}(),this.previewData={image:{data:new Uint8ClampedArray(1),width:1,height:0},background:ce(0),transparent:!1}}};var OE=class{addHandler(e,r){let n=this.handlers.findIndex(o=>o[0]===e);n<0?this.handlers.push([e,r]):this.handlers[n][1]=r}removeHandler(e){let r=this.handlers.findIndex(n=>n[0]===e);r>=0&&this.handlers.splice(r,1)}handle(e){return N(this,null,function*(){for(let r=this.handlers.length-1;r>=0;r--){let n=this.handlers[r][1];if(yield n(e,this.plugin))return}GMe(this.plugin,e)})}dispose(){this.handlers.length=0}constructor(e){this.plugin=e,this.handlers=[]}};function GMe(t,e){let r=e.filter(n=>{let o=n.name.toLowerCase();return o.endsWith(".molx")||o.endsWith(".molj")});r.length>0?Re.State.Snapshots.OpenFile(t,{file:r[0]}):t.runTask(t.state.data.applyAction(fS,{files:e.map(n=>Wr.File(n)),format:{name:"auto",params:{}},visuals:!0}))}var FE=class{get isInitialized(){return this._isInitialized}build(){return this.state.data.build()}initContainer(e){var r;if(this.canvasContainer)return!0;let n=document.createElement("div");Object.assign(n.style,{position:"absolute",left:0,top:0,right:0,bottom:0,"-webkit-user-select":"none","user-select":"none","-webkit-tap-highlight-color":"rgba(0,0,0,0)","-webkit-touch-callout":"none","touch-action":"manipulation"});let o=(r=e?.canvas3dContext)===null||r===void 0?void 0:r.canvas;return o||(o=document.createElement("canvas"),e?.checkeredCanvasBackground&&Object.assign(o.style,{"background-image":"linear-gradient(45deg, lightgrey 25%, transparent 25%, transparent 75%, lightgrey 75%, lightgrey), linear-gradient(45deg, lightgrey 25%, transparent 25%, transparent 75%, lightgrey 75%, lightgrey)","background-size":"60px 60px","background-position":"0 0, 30px 30px"}),n.appendChild(o)),this.initViewer(o,n,e?.canvas3dContext)?(this.canvasContainer=n,!0):!1}mount(e,r){var n;if(this.disposed)throw new Error("Cannot mount a disposed context");return this.initContainer(r)?(this.canvasContainer.parentElement!==e&&((n=this.canvasContainer.parentElement)===null||n===void 0||n.removeChild(this.canvasContainer)),e.appendChild(this.canvasContainer),this.handleResize(),!0):!1}unmount(){var e,r;(r=(e=this.canvasContainer)===null||e===void 0?void 0:e.parentElement)===null||r===void 0||r.removeChild(this.canvasContainer)}initViewer(e,r,n){var o,i,a,s,l,c;try{this.layout.setRoot(r),this.spec.layout&&this.spec.layout.initial&&this.layout.setProps(this.spec.layout.initial),n||(n=Ad.fromCanvas(e,this.managers.asset,{antialias:!((o=this.config.get(Wt.General.DisableAntialiasing))!==null&&o!==void 0&&o),preserveDrawingBuffer:!((i=this.config.get(Wt.General.DisablePreserveDrawingBuffer))!==null&&i!==void 0&&i),preferWebGl1:this.config.get(Wt.General.PreferWebGl1)||!1,failIfMajorPerformanceCaveat:!((a=this.config.get(Wt.General.AllowMajorPerformanceCaveat))!==null&&a!==void 0&&a),powerPreference:this.config.get(Wt.General.PowerPreference)||"high-performance",handleResize:this.handleResize},{pixelScale:this.config.get(Wt.General.PixelScale)||1,pickScale:this.config.get(Wt.General.PickScale)||.25,transparency:this.config.get(Wt.General.Transparency)||"wboit"})),this.canvas3dContext=n,this.canvas3d=v_.create(this.canvas3dContext),this.canvas3dInit.next(!0);let u=this.spec.canvas3d,d=ce(16579577);return u?(((l=u.renderer)===null||l===void 0?void 0:l.backgroundColor)===void 0&&(u=ss(u,m=>{m.renderer?m.renderer.backgroundColor=d:m.renderer={backgroundColor:d}})),(c=this.canvas3d)===null||c===void 0||c.setProps(u)):(s=this.canvas3d)===null||s===void 0||s.setProps({renderer:{backgroundColor:d}}),this.animationLoop.start(),this.helpers.viewportScreenshot=new BE(this),this.subs.push(this.canvas3d.interaction.click.subscribe(m=>this.behaviors.interaction.click.next(m))),this.subs.push(this.canvas3d.interaction.drag.subscribe(m=>this.behaviors.interaction.drag.next(m))),this.subs.push(this.canvas3d.interaction.hover.subscribe(m=>this.behaviors.interaction.hover.next(m))),this.subs.push(this.canvas3d.input.resize.pipe(bT(50),qc(100,void 0,{leading:!1,trailing:!0})).subscribe(()=>this.handleResize())),this.subs.push(this.canvas3d.input.keyDown.subscribe(m=>this.behaviors.interaction.key.next(m))),this.subs.push(this.canvas3d.input.keyUp.subscribe(m=>this.behaviors.interaction.keyReleased.next(m))),this.subs.push(this.layout.events.updated.subscribe(()=>requestAnimationFrame(()=>this.handleResize()))),this.handleResize(),b0.setImmediate(()=>this.initCanvas3dPromiseCallbacks[0]()),!0}catch(u){return this.log.error(""+u),console.error(u),b0.setImmediate(()=>this.initCanvas3dPromiseCallbacks[1](u)),!1}}get isBusy(){return this.behaviors.state.isAnimating.value||this.behaviors.state.isUpdating.value}get selectionMode(){return this.behaviors.interaction.selectionMode.value}set selectionMode(e){this.behaviors.interaction.selectionMode.next(e)}dataTransaction(e,r){return this.runTask(this.state.data.transaction(e,r))}clear(e=!1){var r;return e&&((r=this.canvas3d)===null||r===void 0||r.setProps(rS)),Re.State.RemoveObject(this,{state:this.state.data,ref:kt.RootRef})}dispose(e){var r,n;if(!this.disposed){for(let o of this.subs)o.unsubscribe();this.subs=[],this.animationLoop.stop(),this.commands.dispose(),(r=this.canvas3d)===null||r===void 0||r.dispose(),(n=this.canvas3dContext)===null||n===void 0||n.dispose(e),this.ev.dispose(),this.state.dispose(),this.helpers.substructureParent.dispose(),ro(this.managers,o=>{var i;return(i=o?.dispose)===null||i===void 0?void 0:i.call(o)}),ro(this.managers.structure,o=>{var i;return(i=o?.dispose)===null||i===void 0?void 0:i.call(o)}),ro(this.managers.volume,o=>{var i;return(i=o?.dispose)===null||i===void 0?void 0:i.call(o)}),this.unmount(),this.canvasContainer=void 0,this.customState={},this.disposed=!0}}initBehaviorEvents(){this.subs.push(ad(this.state.data.behaviors.isUpdating,this.state.behaviors.behaviors.isUpdating).subscribe(a=>{this.behaviors.state.isUpdating.value!==a&&this.behaviors.state.isUpdating.next(a)}));let e=this.config.get(Wt.General.IsBusyTimeoutMs)||750,r=this.behaviors.state.isBusy,n,o=()=>{r.value||r.next(!0)},i=()=>{n!==void 0&&clearTimeout(n),n=void 0};this.subs.push(ad(this.behaviors.state.isUpdating,this.behaviors.state.isAnimating).subscribe(a=>{let s=this.behaviors.state.isUpdating.value,l=this.behaviors.state.isAnimating.value;s||l?r.value||(i(),n=setTimeout(o,e)):(i(),r.next(!1))})),this.subs.push(this.behaviors.interaction.selectionMode.subscribe(a=>{var s;a||(s=this.managers.interactivity)===null||s===void 0||s.lociSelects.deselectAll()}))}initBuiltInBehavior(){uS.State.registerDefault(this),uS.Representation.registerDefault(this),uS.Camera.registerDefault(this),uS.Misc.registerDefault(this),this.subs.push(ad(this.state.data.events.log,this.state.behaviors.events.log).subscribe(e=>this.events.log.next(e)))}initBehaviors(){return N(this,null,function*(){let e=this.state.behaviors.build();for(let r of Object.keys(rr.Categories))e.toRoot().apply(rr.CreateCategory,{label:rr.Categories[r]},{ref:r,state:{isLocked:!0}});for(let r of this.spec.behaviors)rr.getCategoryId(r.transformer)==="custom-props"&&e.to(rr.getCategoryId(r.transformer)).apply(r.transformer,r.defaultParams,{ref:r.transformer.id});yield this.runTask(this.state.behaviors.updateTree(e,{doNotUpdateCurrent:!0,doNotLogTiming:!0})),e=this.state.behaviors.build();for(let r of this.spec.behaviors)rr.getCategoryId(r.transformer)!=="custom-props"&&e.to(rr.getCategoryId(r.transformer)).apply(r.transformer,r.defaultParams,{ref:r.transformer.id});yield this.runTask(this.state.behaviors.updateTree(e,{doNotUpdateCurrent:!0,doNotLogTiming:!0}))})}initCustomFormats(){if(this.spec.customFormats)for(let e of this.spec.customFormats)this.dataFormats.add(e[0],e[1])}initAnimations(){if(this.spec.animations)for(let e of this.spec.animations)this.managers.animation.register(e)}initDataActions(){if(this.spec.actions)for(let e of this.spec.actions)this.state.data.actions.add(e.action)}init(){return N(this,null,function*(){try{this.subs.push(this.events.log.subscribe(e=>this.log.entries=this.log.entries.push(e))),this.initCustomFormats(),this.initBehaviorEvents(),this.initBuiltInBehavior(),this.managers.interactivity=new Ih(this),this.managers.lociLabels=new kP(this),this.builders.structure=new EP(this),this.initAnimations(),this.initDataActions(),yield this.initBehaviors(),this.log.message(`Mol* Plugin ${Y1} [${eQ.toLocaleString()}]`),x0||this.log.message("Development mode enabled"),ht&&this.log.message("Debug mode enabled"),this._isInitialized=!0,this.initializedPromiseCallbacks[0]()}catch(e){throw this.initializedPromiseCallbacks[1](e),e}})}constructor(e){var r;this.spec=e,this.runTask=(n,o)=>this.managers.task.run(n,o),this.resolveTask=n=>{if(n)return ie.is(n)?this.runTask(n):n},this.subs=[],this.initCanvas3dPromiseCallbacks=[()=>{},()=>{}],this._isInitialized=!1,this.initializedPromiseCallbacks=[()=>{},()=>{}],this.disposed=!1,this.canvasContainer=void 0,this.ev=_s.create(),this.config=new G2(this.spec.config),this.state=new Gh(this),this.commands=new j2,this.canvas3dInit=this.ev.behavior(!1),this.behaviors={state:{isAnimating:this.ev.behavior(!1),isUpdating:this.ev.behavior(!1),isBusy:this.ev.behavior(!1)},interaction:{hover:this.ev.behavior({current:rt.Loci.Empty,modifiers:na.None,buttons:0,button:0}),click:this.ev.behavior({current:rt.Loci.Empty,modifiers:na.None,buttons:0,button:0}),drag:this.ev.behavior({current:rt.Loci.Empty,modifiers:na.None,buttons:0,button:0,pageStart:ne(),pageEnd:ne()}),key:this.ev.behavior(WR),keyReleased:this.ev.behavior(WR),selectionMode:this.ev.behavior(!1)},labels:{highlight:this.ev.behavior({labels:[]})},layout:{leftPanelTabName:this.ev.behavior("root")},canvas3d:{initialized:this.canvas3dInit.pipe(d0(n=>!!n),gz(1))}},this.canvas3dInitialized=new Promise((n,o)=>{this.initCanvas3dPromiseCallbacks=[n,o]}),this.initialized=new Promise((n,o)=>{this.initializedPromiseCallbacks=[n,o]}),this.layout=new VP(this),this.animationLoop=new ME(this),this.representation={structure:{registry:new Hb,themes:{colorThemeRegistry:wo.createRegistry(),sizeThemeRegistry:so.createRegistry()}},volume:{registry:new eh,themes:{colorThemeRegistry:wo.createRegistry(),sizeThemeRegistry:so.createRegistry()}}},this.query={structure:{registry:new Mw}},this.dataFormats=new IP,this.builders={data:new CP(this),structure:void 0},this.helpers={substructureParent:new RE(this),viewportScreenshot:void 0},this.managers={structure:{hierarchy:new km(this),component:new ql(this),measurement:new OP(this),selection:new FP(this),focus:new MP(this)},volume:{hierarchy:new Dh(this)},interactivity:void 0,camera:new AP(this),animation:new DP(this),snapshot:new oh(this),lociLabels:void 0,toast:new LE(this),asset:new EU,task:new qb,dragAndDrop:new OE(this)},this.events={log:this.ev(),task:this.managers.task.events,canvas3d:{settingsUpdated:this.ev()}},this.customModelProperties=new MS.Registry,this.customStructureProperties=new MS.Registry,this.customStructureControls=new Map,this.customImportControls=new Map,this.genericRepresentationControls=new Map,this.customState=Object.create(null),this.handleResize=()=>{var n,o;let i=(n=this.canvas3dContext)===null||n===void 0?void 0:n.canvas,a=this.layout.root;a&&i&&(tQ(i,a,this.canvas3dContext.props.pixelScale),(o=this.canvas3d)===null||o===void 0||o.requestResize())},this.log={entries:mm(),entry:n=>this.events.log.next(n),error:n=>this.events.log.next(cu.error(n)),message:n=>this.events.log.next(cu.message(n)),info:n=>this.events.log.next(cu.info(n)),warn:n=>this.events.log.next(cu.warning(n))},this.fetch=_U,w8(!1),jz((r=this.config.get(Wt.Structure.SaccharideCompIdMapType))!==null&&r!==void 0?r:"default")}};var eC=class extends FE{initCustomParamEditors(){if(this.spec.customParamEditors)for(let[e,r]of this.spec.customParamEditors)this.customParamEditors.set(e.id,r)}dispose(e){super.dispose(e),this.layout.dispose()}constructor(e){super(e),this.spec=e,this.customParamEditors=new Map,this.initCustomParamEditors()}};var Zae=Ot($ae());function qRe(t,e){(0,Zae.createRoot)(e).render(t)}var _ce=Ot(Po());var Fr=Ot(Or()),o0=Ot(Po());var br=Ot(Or()),t0=Ot(Po());function Jae(t,e){let r=e||{};return(t[t.length-1]===""?[...t,""]:t).join((r.padRight?" ":"")+","+(r.padLeft===!1?"":" ")).trim()}var WRe=/^[$_\p{ID_Start}][$_\u{200C}\u{200D}\p{ID_Continue}]*$/u,XRe=/^[$_\p{ID_Start}][-$_\u{200C}\u{200D}\p{ID_Continue}]*$/u,YRe={};function nD(t,e){return((e||YRe).jsx?XRe:WRe).test(t)}var QRe=/[ \t\n\f\r]/g;function L4(t){return typeof t=="object"?t.type==="text"?ese(t.value):!1:ese(t)}function ese(t){return t.replace(QRe,"")===""}var $p=class{constructor(e,r,n){this.property=e,this.normal=r,n&&(this.space=n)}};$p.prototype.property={};$p.prototype.normal={};$p.prototype.space=null;function B4(t,e){let r={},n={},o=-1;for(;++o<t.length;)Object.assign(r,t[o].property),Object.assign(n,t[o].normal);return new $p(r,n,e)}function WC(t){return t.toLowerCase()}var Hs=class{constructor(e,r){this.property=e,this.attribute=r}};Hs.prototype.space=null;Hs.prototype.boolean=!1;Hs.prototype.booleanish=!1;Hs.prototype.overloadedBoolean=!1;Hs.prototype.number=!1;Hs.prototype.commaSeparated=!1;Hs.prototype.spaceSeparated=!1;Hs.prototype.commaOrSpaceSeparated=!1;Hs.prototype.mustUseProperty=!1;Hs.prototype.defined=!1;var XC={};ua(XC,{boolean:()=>Tr,booleanish:()=>gi,commaOrSpaceSeparated:()=>rc,commaSeparated:()=>ug,number:()=>nt,overloadedBoolean:()=>O4,spaceSeparated:()=>Jn});var KRe=0,Tr=Xy(),gi=Xy(),O4=Xy(),nt=Xy(),Jn=Xy(),ug=Xy(),rc=Xy();function Xy(){return 2**++KRe}var F4=Object.keys(XC),Yy=class extends Hs{constructor(e,r,n,o){let i=-1;if(super(e,r),tse(this,"space",o),typeof n=="number")for(;++i<F4.length;){let a=F4[i];tse(this,F4[i],(n&XC[a])===XC[a])}}};Yy.prototype.defined=!0;function tse(t,e,r){r&&(t[e]=r)}var $Re={}.hasOwnProperty;function ed(t){let e={},r={},n;for(n in t.properties)if($Re.call(t.properties,n)){let o=t.properties[n],i=new Yy(n,t.transform(t.attributes||{},n),o,t.space);t.mustUseProperty&&t.mustUseProperty.includes(n)&&(i.mustUseProperty=!0),e[n]=i,r[WC(n)]=n,r[WC(i.attribute)]=n}return new $p(e,r,t.space)}var N4=ed({space:"xlink",transform(t,e){return"xlink:"+e.slice(5).toLowerCase()},properties:{xLinkActuate:null,xLinkArcRole:null,xLinkHref:null,xLinkRole:null,xLinkShow:null,xLinkTitle:null,xLinkType:null}});var V4=ed({space:"xml",transform(t,e){return"xml:"+e.slice(3).toLowerCase()},properties:{xmlLang:null,xmlBase:null,xmlSpace:null}});function oD(t,e){return e in t?t[e]:e}function iD(t,e){return oD(t,e.toLowerCase())}var z4=ed({space:"xmlns",attributes:{xmlnsxlink:"xmlns:xlink"},transform:iD,properties:{xmlns:null,xmlnsXLink:null}});var U4=ed({transform(t,e){return e==="role"?e:"aria-"+e.slice(4).toLowerCase()},properties:{ariaActiveDescendant:null,ariaAtomic:gi,ariaAutoComplete:null,ariaBusy:gi,ariaChecked:gi,ariaColCount:nt,ariaColIndex:nt,ariaColSpan:nt,ariaControls:Jn,ariaCurrent:null,ariaDescribedBy:Jn,ariaDetails:null,ariaDisabled:gi,ariaDropEffect:Jn,ariaErrorMessage:null,ariaExpanded:gi,ariaFlowTo:Jn,ariaGrabbed:gi,ariaHasPopup:null,ariaHidden:gi,ariaInvalid:null,ariaKeyShortcuts:null,ariaLabel:null,ariaLabelledBy:Jn,ariaLevel:nt,ariaLive:null,ariaModal:gi,ariaMultiLine:gi,ariaMultiSelectable:gi,ariaOrientation:null,ariaOwns:Jn,ariaPlaceholder:null,ariaPosInSet:nt,ariaPressed:gi,ariaReadOnly:gi,ariaRelevant:null,ariaRequired:gi,ariaRoleDescription:Jn,ariaRowCount:nt,ariaRowIndex:nt,ariaRowSpan:nt,ariaSelected:gi,ariaSetSize:nt,ariaSort:null,ariaValueMax:nt,ariaValueMin:nt,ariaValueNow:nt,ariaValueText:null,role:null}});var rse=ed({space:"html",attributes:{acceptcharset:"accept-charset",classname:"class",htmlfor:"for",httpequiv:"http-equiv"},transform:iD,mustUseProperty:["checked","multiple","muted","selected"],properties:{abbr:null,accept:ug,acceptCharset:Jn,accessKey:Jn,action:null,allow:null,allowFullScreen:Tr,allowPaymentRequest:Tr,allowUserMedia:Tr,alt:null,as:null,async:Tr,autoCapitalize:null,autoComplete:Jn,autoFocus:Tr,autoPlay:Tr,blocking:Jn,capture:null,charSet:null,checked:Tr,cite:null,className:Jn,cols:nt,colSpan:null,content:null,contentEditable:gi,controls:Tr,controlsList:Jn,coords:nt|ug,crossOrigin:null,data:null,dateTime:null,decoding:null,default:Tr,defer:Tr,dir:null,dirName:null,disabled:Tr,download:O4,draggable:gi,encType:null,enterKeyHint:null,fetchPriority:null,form:null,formAction:null,formEncType:null,formMethod:null,formNoValidate:Tr,formTarget:null,headers:Jn,height:nt,hidden:Tr,high:nt,href:null,hrefLang:null,htmlFor:Jn,httpEquiv:Jn,id:null,imageSizes:null,imageSrcSet:null,inert:Tr,inputMode:null,integrity:null,is:null,isMap:Tr,itemId:null,itemProp:Jn,itemRef:Jn,itemScope:Tr,itemType:Jn,kind:null,label:null,lang:null,language:null,list:null,loading:null,loop:Tr,low:nt,manifest:null,max:null,maxLength:nt,media:null,method:null,min:null,minLength:nt,multiple:Tr,muted:Tr,name:null,nonce:null,noModule:Tr,noValidate:Tr,onAbort:null,onAfterPrint:null,onAuxClick:null,onBeforeMatch:null,onBeforePrint:null,onBeforeToggle:null,onBeforeUnload:null,onBlur:null,onCancel:null,onCanPlay:null,onCanPlayThrough:null,onChange:null,onClick:null,onClose:null,onContextLost:null,onContextMenu:null,onContextRestored:null,onCopy:null,onCueChange:null,onCut:null,onDblClick:null,onDrag:null,onDragEnd:null,onDragEnter:null,onDragExit:null,onDragLeave:null,onDragOver:null,onDragStart:null,onDrop:null,onDurationChange:null,onEmptied:null,onEnded:null,onError:null,onFocus:null,onFormData:null,onHashChange:null,onInput:null,onInvalid:null,onKeyDown:null,onKeyPress:null,onKeyUp:null,onLanguageChange:null,onLoad:null,onLoadedData:null,onLoadedMetadata:null,onLoadEnd:null,onLoadStart:null,onMessage:null,onMessageError:null,onMouseDown:null,onMouseEnter:null,onMouseLeave:null,onMouseMove:null,onMouseOut:null,onMouseOver:null,onMouseUp:null,onOffline:null,onOnline:null,onPageHide:null,onPageShow:null,onPaste:null,onPause:null,onPlay:null,onPlaying:null,onPopState:null,onProgress:null,onRateChange:null,onRejectionHandled:null,onReset:null,onResize:null,onScroll:null,onScrollEnd:null,onSecurityPolicyViolation:null,onSeeked:null,onSeeking:null,onSelect:null,onSlotChange:null,onStalled:null,onStorage:null,onSubmit:null,onSuspend:null,onTimeUpdate:null,onToggle:null,onUnhandledRejection:null,onUnload:null,onVolumeChange:null,onWaiting:null,onWheel:null,open:Tr,optimum:nt,pattern:null,ping:Jn,placeholder:null,playsInline:Tr,popover:null,popoverTarget:null,popoverTargetAction:null,poster:null,preload:null,readOnly:Tr,referrerPolicy:null,rel:Jn,required:Tr,reversed:Tr,rows:nt,rowSpan:nt,sandbox:Jn,scope:null,scoped:Tr,seamless:Tr,selected:Tr,shadowRootClonable:Tr,shadowRootDelegatesFocus:Tr,shadowRootMode:null,shape:null,size:nt,sizes:null,slot:null,span:nt,spellCheck:gi,src:null,srcDoc:null,srcLang:null,srcSet:null,start:nt,step:null,style:null,tabIndex:nt,target:null,title:null,translate:null,type:null,typeMustMatch:Tr,useMap:null,value:gi,width:nt,wrap:null,writingSuggestions:null,align:null,aLink:null,archive:Jn,axis:null,background:null,bgColor:null,border:nt,borderColor:null,bottomMargin:nt,cellPadding:null,cellSpacing:null,char:null,charOff:null,classId:null,clear:null,code:null,codeBase:null,codeType:null,color:null,compact:Tr,declare:Tr,event:null,face:null,frame:null,frameBorder:null,hSpace:nt,leftMargin:nt,link:null,longDesc:null,lowSrc:null,marginHeight:nt,marginWidth:nt,noResize:Tr,noHref:Tr,noShade:Tr,noWrap:Tr,object:null,profile:null,prompt:null,rev:null,rightMargin:nt,rules:null,scheme:null,scrolling:gi,standby:null,summary:null,text:null,topMargin:nt,valueType:null,version:null,vAlign:null,vLink:null,vSpace:nt,allowTransparency:null,autoCorrect:null,autoSave:null,disablePictureInPicture:Tr,disableRemotePlayback:Tr,prefix:null,property:null,results:nt,security:null,unselectable:null}});var nse=ed({space:"svg",attributes:{accentHeight:"accent-height",alignmentBaseline:"alignment-baseline",arabicForm:"arabic-form",baselineShift:"baseline-shift",capHeight:"cap-height",className:"class",clipPath:"clip-path",clipRule:"clip-rule",colorInterpolation:"color-interpolation",colorInterpolationFilters:"color-interpolation-filters",colorProfile:"color-profile",colorRendering:"color-rendering",crossOrigin:"crossorigin",dataType:"datatype",dominantBaseline:"dominant-baseline",enableBackground:"enable-background",fillOpacity:"fill-opacity",fillRule:"fill-rule",floodColor:"flood-color",floodOpacity:"flood-opacity",fontFamily:"font-family",fontSize:"font-size",fontSizeAdjust:"font-size-adjust",fontStretch:"font-stretch",fontStyle:"font-style",fontVariant:"font-variant",fontWeight:"font-weight",glyphName:"glyph-name",glyphOrientationHorizontal:"glyph-orientation-horizontal",glyphOrientationVertical:"glyph-orientation-vertical",hrefLang:"hreflang",horizAdvX:"horiz-adv-x",horizOriginX:"horiz-origin-x",horizOriginY:"horiz-origin-y",imageRendering:"image-rendering",letterSpacing:"letter-spacing",lightingColor:"lighting-color",markerEnd:"marker-end",markerMid:"marker-mid",markerStart:"marker-start",navDown:"nav-down",navDownLeft:"nav-down-left",navDownRight:"nav-down-right",navLeft:"nav-left",navNext:"nav-next",navPrev:"nav-prev",navRight:"nav-right",navUp:"nav-up",navUpLeft:"nav-up-left",navUpRight:"nav-up-right",onAbort:"onabort",onActivate:"onactivate",onAfterPrint:"onafterprint",onBeforePrint:"onbeforeprint",onBegin:"onbegin",onCancel:"oncancel",onCanPlay:"oncanplay",onCanPlayThrough:"oncanplaythrough",onChange:"onchange",onClick:"onclick",onClose:"onclose",onCopy:"oncopy",onCueChange:"oncuechange",onCut:"oncut",onDblClick:"ondblclick",onDrag:"ondrag",onDragEnd:"ondragend",onDragEnter:"ondragenter",onDragExit:"ondragexit",onDragLeave:"ondragleave",onDragOver:"ondragover",onDragStart:"ondragstart",onDrop:"ondrop",onDurationChange:"ondurationchange",onEmptied:"onemptied",onEnd:"onend",onEnded:"onended",onError:"onerror",onFocus:"onfocus",onFocusIn:"onfocusin",onFocusOut:"onfocusout",onHashChange:"onhashchange",onInput:"oninput",onInvalid:"oninvalid",onKeyDown:"onkeydown",onKeyPress:"onkeypress",onKeyUp:"onkeyup",onLoad:"onload",onLoadedData:"onloadeddata",onLoadedMetadata:"onloadedmetadata",onLoadStart:"onloadstart",onMessage:"onmessage",onMouseDown:"onmousedown",onMouseEnter:"onmouseenter",onMouseLeave:"onmouseleave",onMouseMove:"onmousemove",onMouseOut:"onmouseout",onMouseOver:"onmouseover",onMouseUp:"onmouseup",onMouseWheel:"onmousewheel",onOffline:"onoffline",onOnline:"ononline",onPageHide:"onpagehide",onPageShow:"onpageshow",onPaste:"onpaste",onPause:"onpause",onPlay:"onplay",onPlaying:"onplaying",onPopState:"onpopstate",onProgress:"onprogress",onRateChange:"onratechange",onRepeat:"onrepeat",onReset:"onreset",onResize:"onresize",onScroll:"onscroll",onSeeked:"onseeked",onSeeking:"onseeking",onSelect:"onselect",onShow:"onshow",onStalled:"onstalled",onStorage:"onstorage",onSubmit:"onsubmit",onSuspend:"onsuspend",onTimeUpdate:"ontimeupdate",onToggle:"ontoggle",onUnload:"onunload",onVolumeChange:"onvolumechange",onWaiting:"onwaiting",onZoom:"onzoom",overlinePosition:"overline-position",overlineThickness:"overline-thickness",paintOrder:"paint-order",panose1:"panose-1",pointerEvents:"pointer-events",referrerPolicy:"referrerpolicy",renderingIntent:"rendering-intent",shapeRendering:"shape-rendering",stopColor:"stop-color",stopOpacity:"stop-opacity",strikethroughPosition:"strikethrough-position",strikethroughThickness:"strikethrough-thickness",strokeDashArray:"stroke-dasharray",strokeDashOffset:"stroke-dashoffset",strokeLineCap:"stroke-linecap",strokeLineJoin:"stroke-linejoin",strokeMiterLimit:"stroke-miterlimit",strokeOpacity:"stroke-opacity",strokeWidth:"stroke-width",tabIndex:"tabindex",textAnchor:"text-anchor",textDecoration:"text-decoration",textRendering:"text-rendering",transformOrigin:"transform-origin",typeOf:"typeof",underlinePosition:"underline-position",underlineThickness:"underline-thickness",unicodeBidi:"unicode-bidi",unicodeRange:"unicode-range",unitsPerEm:"units-per-em",vAlphabetic:"v-alphabetic",vHanging:"v-hanging",vIdeographic:"v-ideographic",vMathematical:"v-mathematical",vectorEffect:"vector-effect",vertAdvY:"vert-adv-y",vertOriginX:"vert-origin-x",vertOriginY:"vert-origin-y",wordSpacing:"word-spacing",writingMode:"writing-mode",xHeight:"x-height",playbackOrder:"playbackorder",timelineBegin:"timelinebegin"},transform:oD,properties:{about:rc,accentHeight:nt,accumulate:null,additive:null,alignmentBaseline:null,alphabetic:nt,amplitude:nt,arabicForm:null,ascent:nt,attributeName:null,attributeType:null,azimuth:nt,bandwidth:null,baselineShift:null,baseFrequency:null,baseProfile:null,bbox:null,begin:null,bias:nt,by:null,calcMode:null,capHeight:nt,className:Jn,clip:null,clipPath:null,clipPathUnits:null,clipRule:null,color:null,colorInterpolation:null,colorInterpolationFilters:null,colorProfile:null,colorRendering:null,content:null,contentScriptType:null,contentStyleType:null,crossOrigin:null,cursor:null,cx:null,cy:null,d:null,dataType:null,defaultAction:null,descent:nt,diffuseConstant:nt,direction:null,display:null,dur:null,divisor:nt,dominantBaseline:null,download:Tr,dx:null,dy:null,edgeMode:null,editable:null,elevation:nt,enableBackground:null,end:null,event:null,exponent:nt,externalResourcesRequired:null,fill:null,fillOpacity:nt,fillRule:null,filter:null,filterRes:null,filterUnits:null,floodColor:null,floodOpacity:null,focusable:null,focusHighlight:null,fontFamily:null,fontSize:null,fontSizeAdjust:null,fontStretch:null,fontStyle:null,fontVariant:null,fontWeight:null,format:null,fr:null,from:null,fx:null,fy:null,g1:ug,g2:ug,glyphName:ug,glyphOrientationHorizontal:null,glyphOrientationVertical:null,glyphRef:null,gradientTransform:null,gradientUnits:null,handler:null,hanging:nt,hatchContentUnits:null,hatchUnits:null,height:null,href:null,hrefLang:null,horizAdvX:nt,horizOriginX:nt,horizOriginY:nt,id:null,ideographic:nt,imageRendering:null,initialVisibility:null,in:null,in2:null,intercept:nt,k:nt,k1:nt,k2:nt,k3:nt,k4:nt,kernelMatrix:rc,kernelUnitLength:null,keyPoints:null,keySplines:null,keyTimes:null,kerning:null,lang:null,lengthAdjust:null,letterSpacing:null,lightingColor:null,limitingConeAngle:nt,local:null,markerEnd:null,markerMid:null,markerStart:null,markerHeight:null,markerUnits:null,markerWidth:null,mask:null,maskContentUnits:null,maskUnits:null,mathematical:null,max:null,media:null,mediaCharacterEncoding:null,mediaContentEncodings:null,mediaSize:nt,mediaTime:null,method:null,min:null,mode:null,name:null,navDown:null,navDownLeft:null,navDownRight:null,navLeft:null,navNext:null,navPrev:null,navRight:null,navUp:null,navUpLeft:null,navUpRight:null,numOctaves:null,observer:null,offset:null,onAbort:null,onActivate:null,onAfterPrint:null,onBeforePrint:null,onBegin:null,onCancel:null,onCanPlay:null,onCanPlayThrough:null,onChange:null,onClick:null,onClose:null,onCopy:null,onCueChange:null,onCut:null,onDblClick:null,onDrag:null,onDragEnd:null,onDragEnter:null,onDragExit:null,onDragLeave:null,onDragOver:null,onDragStart:null,onDrop:null,onDurationChange:null,onEmptied:null,onEnd:null,onEnded:null,onError:null,onFocus:null,onFocusIn:null,onFocusOut:null,onHashChange:null,onInput:null,onInvalid:null,onKeyDown:null,onKeyPress:null,onKeyUp:null,onLoad:null,onLoadedData:null,onLoadedMetadata:null,onLoadStart:null,onMessage:null,onMouseDown:null,onMouseEnter:null,onMouseLeave:null,onMouseMove:null,onMouseOut:null,onMouseOver:null,onMouseUp:null,onMouseWheel:null,onOffline:null,onOnline:null,onPageHide:null,onPageShow:null,onPaste:null,onPause:null,onPlay:null,onPlaying:null,onPopState:null,onProgress:null,onRateChange:null,onRepeat:null,onReset:null,onResize:null,onScroll:null,onSeeked:null,onSeeking:null,onSelect:null,onShow:null,onStalled:null,onStorage:null,onSubmit:null,onSuspend:null,onTimeUpdate:null,onToggle:null,onUnload:null,onVolumeChange:null,onWaiting:null,onZoom:null,opacity:null,operator:null,order:null,orient:null,orientation:null,origin:null,overflow:null,overlay:null,overlinePosition:nt,overlineThickness:nt,paintOrder:null,panose1:null,path:null,pathLength:nt,patternContentUnits:null,patternTransform:null,patternUnits:null,phase:null,ping:Jn,pitch:null,playbackOrder:null,pointerEvents:null,points:null,pointsAtX:nt,pointsAtY:nt,pointsAtZ:nt,preserveAlpha:null,preserveAspectRatio:null,primitiveUnits:null,propagate:null,property:rc,r:null,radius:null,referrerPolicy:null,refX:null,refY:null,rel:rc,rev:rc,renderingIntent:null,repeatCount:null,repeatDur:null,requiredExtensions:rc,requiredFeatures:rc,requiredFonts:rc,requiredFormats:rc,resource:null,restart:null,result:null,rotate:null,rx:null,ry:null,scale:null,seed:null,shapeRendering:null,side:null,slope:null,snapshotTime:null,specularConstant:nt,specularExponent:nt,spreadMethod:null,spacing:null,startOffset:null,stdDeviation:null,stemh:null,stemv:null,stitchTiles:null,stopColor:null,stopOpacity:null,strikethroughPosition:nt,strikethroughThickness:nt,string:null,stroke:null,strokeDashArray:rc,strokeDashOffset:null,strokeLineCap:null,strokeLineJoin:null,strokeMiterLimit:nt,strokeOpacity:nt,strokeWidth:null,style:null,surfaceScale:nt,syncBehavior:null,syncBehaviorDefault:null,syncMaster:null,syncTolerance:null,syncToleranceDefault:null,systemLanguage:rc,tabIndex:nt,tableValues:null,target:null,targetX:nt,targetY:nt,textAnchor:null,textDecoration:null,textRendering:null,textLength:null,timelineBegin:null,title:null,transformBehavior:null,type:null,typeOf:rc,to:null,transform:null,transformOrigin:null,u1:null,u2:null,underlinePosition:nt,underlineThickness:nt,unicode:null,unicodeBidi:null,unicodeRange:null,unitsPerEm:nt,values:null,vAlphabetic:nt,vMathematical:nt,vectorEffect:null,vHanging:nt,vIdeographic:nt,version:null,vertAdvY:nt,vertOriginX:nt,vertOriginY:nt,viewBox:null,viewTarget:null,visibility:null,width:null,widths:null,wordSpacing:null,writingMode:null,x:null,x1:null,x2:null,xChannelSelector:null,xHeight:nt,y:null,y1:null,y2:null,yChannelSelector:null,z:null,zoomAndPan:null}});var ZRe=/^data[-\w.:]+$/i,ose=/-[a-z]/g,JRe=/[A-Z]/g;function G4(t,e){let r=WC(e),n=e,o=Hs;if(r in t.normal)return t.property[t.normal[r]];if(r.length>4&&r.slice(0,4)==="data"&&ZRe.test(e)){if(e.charAt(4)==="-"){let i=e.slice(5).replace(ose,tLe);n="data"+i.charAt(0).toUpperCase()+i.slice(1)}else{let i=e.slice(4);if(!ose.test(i)){let a=i.replace(JRe,eLe);a.charAt(0)!=="-"&&(a="-"+a),e="data"+a}}o=Yy}return new o(n,e)}function eLe(t){return"-"+t.toLowerCase()}function tLe(t){return t.charAt(1).toUpperCase()}var j4={classId:"classID",dataType:"datatype",itemId:"itemID",strokeDashArray:"strokeDasharray",strokeDashOffset:"strokeDashoffset",strokeLineCap:"strokeLinecap",strokeLineJoin:"strokeLinejoin",strokeMiterLimit:"strokeMiterlimit",typeOf:"typeof",xLinkActuate:"xlinkActuate",xLinkArcRole:"xlinkArcrole",xLinkHref:"xlinkHref",xLinkRole:"xlinkRole",xLinkShow:"xlinkShow",xLinkTitle:"xlinkTitle",xLinkType:"xlinkType",xmlnsXLink:"xmlnsXlink"};var ise=B4([V4,N4,z4,U4,rse],"html"),aD=B4([V4,N4,z4,U4,nse],"svg");function ase(t){return t.join(" ").trim()}var H4=Ot(pse(),1),fse=H4.default.default||H4.default;var sD=hse("end"),Sx=hse("start");function hse(t){return e;function e(r){let n=r&&r.position&&r.position[t]||{};if(typeof n.line=="number"&&n.line>0&&typeof n.column=="number"&&n.column>0)return{line:n.line,column:n.column,offset:typeof n.offset=="number"&&n.offset>-1?n.offset:void 0}}}function q4(t){let e=Sx(t),r=sD(t);if(e&&r)return{start:e,end:r}}function dg(t){return!t||typeof t!="object"?"":"position"in t||"type"in t?gse(t.position):"start"in t||"end"in t?gse(t):"line"in t||"column"in t?W4(t):""}function W4(t){return yse(t&&t.line)+":"+yse(t&&t.column)}function gse(t){return W4(t&&t.start)+"-"+W4(t&&t.end)}function yse(t){return t&&typeof t=="number"?t:1}var Pi=class extends Error{constructor(e,r,n){super(),typeof r=="string"&&(n=r,r=void 0);let o="",i={},a=!1;if(r&&("line"in r&&"column"in r?i={place:r}:"start"in r&&"end"in r?i={place:r}:"type"in r?i={ancestors:[r],place:r.position}:i=w({},r)),typeof e=="string"?o=e:!i.cause&&e&&(a=!0,o=e.message,i.cause=e),!i.ruleId&&!i.source&&typeof n=="string"){let l=n.indexOf(":");l===-1?i.ruleId=n:(i.source=n.slice(0,l),i.ruleId=n.slice(l+1))}if(!i.place&&i.ancestors&&i.ancestors){let l=i.ancestors[i.ancestors.length-1];l&&(i.place=l.position)}let s=i.place&&"start"in i.place?i.place.start:i.place;this.ancestors=i.ancestors||void 0,this.cause=i.cause||void 0,this.column=s?s.column:void 0,this.fatal=void 0,this.file,this.message=o,this.line=s?s.line:void 0,this.name=dg(i.place)||"1:1",this.place=i.place||void 0,this.reason=this.message,this.ruleId=i.ruleId||void 0,this.source=i.source||void 0,this.stack=a&&i.cause&&typeof i.cause.stack=="string"?i.cause.stack:"",this.actual,this.expected,this.note,this.url}};Pi.prototype.file="";Pi.prototype.name="";Pi.prototype.reason="";Pi.prototype.message="";Pi.prototype.stack="";Pi.prototype.column=void 0;Pi.prototype.line=void 0;Pi.prototype.ancestors=void 0;Pi.prototype.cause=void 0;Pi.prototype.fatal=void 0;Pi.prototype.place=void 0;Pi.prototype.ruleId=void 0;Pi.prototype.source=void 0;var X4={}.hasOwnProperty,hLe=new Map,gLe=/[A-Z]/g,yLe=/-([a-z])/g,vLe=new Set(["table","tbody","thead","tfoot","tr"]),bLe=new Set(["td","th"]),vse="https://github.com/syntax-tree/hast-util-to-jsx-runtime";function Y4(t,e){if(!e||e.Fragment===void 0)throw new TypeError("Expected `Fragment` in options");let r=e.filePath||void 0,n;if(e.development){if(typeof e.jsxDEV!="function")throw new TypeError("Expected `jsxDEV` in options when `development: true`");n=ELe(r,e.jsxDEV)}else{if(typeof e.jsx!="function")throw new TypeError("Expected `jsx` in production options");if(typeof e.jsxs!="function")throw new TypeError("Expected `jsxs` in production options");n=PLe(r,e.jsx,e.jsxs)}let o={Fragment:e.Fragment,ancestors:[],components:e.components||{},create:n,elementAttributeNameCase:e.elementAttributeNameCase||"react",evaluater:e.createEvaluater?e.createEvaluater():void 0,filePath:r,ignoreInvalidStyle:e.ignoreInvalidStyle||!1,passKeys:e.passKeys!==!1,passNode:e.passNode||!1,schema:e.space==="svg"?aD:ise,stylePropertyNameCase:e.stylePropertyNameCase||"dom",tableCellAlignToStyle:e.tableCellAlignToStyle!==!1},i=bse(o,t,void 0);return i&&typeof i!="string"?i:o.create(t,o.Fragment,{children:i||void 0},void 0)}function bse(t,e,r){if(e.type==="element")return xLe(t,e,r);if(e.type==="mdxFlowExpression"||e.type==="mdxTextExpression")return SLe(t,e);if(e.type==="mdxJsxFlowElement"||e.type==="mdxJsxTextElement")return TLe(t,e,r);if(e.type==="mdxjsEsm")return CLe(t,e);if(e.type==="root")return wLe(t,e,r);if(e.type==="text")return _Le(t,e)}function xLe(t,e,r){let n=t.schema,o=n;e.tagName.toLowerCase()==="svg"&&n.space==="html"&&(o=aD,t.schema=o),t.ancestors.push(e);let i=Sse(t,e.tagName,!1),a=ILe(t,e),s=K4(t,e);return vLe.has(e.tagName)&&(s=s.filter(function(l){return typeof l=="string"?!L4(l):!0})),xse(t,a,i,e),Q4(a,s),t.ancestors.pop(),t.schema=n,t.create(e,i,a,r)}function SLe(t,e){if(e.data&&e.data.estree&&t.evaluater){let n=e.data.estree.body[0];return n.type,t.evaluater.evaluateExpression(n.expression)}QC(t,e.position)}function CLe(t,e){if(e.data&&e.data.estree&&t.evaluater)return t.evaluater.evaluateProgram(e.data.estree);QC(t,e.position)}function TLe(t,e,r){let n=t.schema,o=n;e.name==="svg"&&n.space==="html"&&(o=aD,t.schema=o),t.ancestors.push(e);let i=e.name===null?t.Fragment:Sse(t,e.name,!0),a=DLe(t,e),s=K4(t,e);return xse(t,a,i,e),Q4(a,s),t.ancestors.pop(),t.schema=n,t.create(e,i,a,r)}function wLe(t,e,r){let n={};return Q4(n,K4(t,e)),t.create(e,t.Fragment,n,r)}function _Le(t,e){return e.value}function xse(t,e,r,n){typeof r!="string"&&r!==t.Fragment&&t.passNode&&(e.node=n)}function Q4(t,e){if(e.length>0){let r=e.length>1?e:e[0];r&&(t.children=r)}}function PLe(t,e,r){return n;function n(o,i,a,s){let c=Array.isArray(a.children)?r:e;return s?c(i,a,s):c(i,a)}}function ELe(t,e){return r;function r(n,o,i,a){let s=Array.isArray(i.children),l=Sx(n);return e(o,i,a,s,{columnNumber:l?l.column-1:void 0,fileName:t,lineNumber:l?l.line:void 0},void 0)}}function ILe(t,e){let r={},n,o;for(o in e.properties)if(o!=="children"&&X4.call(e.properties,o)){let i=ALe(t,o,e.properties[o]);if(i){let[a,s]=i;t.tableCellAlignToStyle&&a==="align"&&typeof s=="string"&&bLe.has(e.tagName)?n=s:r[a]=s}}if(n){let i=r.style||(r.style={});i[t.stylePropertyNameCase==="css"?"text-align":"textAlign"]=n}return r}function DLe(t,e){let r={};for(let n of e.attributes)if(n.type==="mdxJsxExpressionAttribute")if(n.data&&n.data.estree&&t.evaluater){let i=n.data.estree.body[0];i.type;let a=i.expression;a.type;let s=a.properties[0];s.type,Object.assign(r,t.evaluater.evaluateExpression(s.argument))}else QC(t,e.position);else{let o=n.name,i;if(n.value&&typeof n.value=="object")if(n.value.data&&n.value.data.estree&&t.evaluater){let s=n.value.data.estree.body[0];s.type,i=t.evaluater.evaluateExpression(s.expression)}else QC(t,e.position);else i=n.value===null?!0:n.value;r[o]=i}return r}function K4(t,e){let r=[],n=-1,o=t.passKeys?new Map:hLe;for(;++n<e.children.length;){let i=e.children[n],a;if(t.passKeys){let l=i.type==="element"?i.tagName:i.type==="mdxJsxFlowElement"||i.type==="mdxJsxTextElement"?i.name:void 0;if(l){let c=o.get(l)||0;a=l+"-"+c,o.set(l,c+1)}}let s=bse(t,i,a);s!==void 0&&r.push(s)}return r}function ALe(t,e,r){let n=G4(t.schema,e);if(!(r==null||typeof r=="number"&&Number.isNaN(r))){if(Array.isArray(r)&&(r=n.commaSeparated?Jae(r):ase(r)),n.property==="style"){let o=typeof r=="object"?r:kLe(t,String(r));return t.stylePropertyNameCase==="css"&&(o=MLe(o)),["style",o]}return[t.elementAttributeNameCase==="react"&&n.space?j4[n.property]||n.property:n.attribute,r]}}function kLe(t,e){let r={};try{fse(e,n)}catch(o){if(!t.ignoreInvalidStyle){let i=o,a=new Pi("Cannot parse `style` attribute",{ancestors:t.ancestors,cause:i,ruleId:"style",source:"hast-util-to-jsx-runtime"});throw a.file=t.filePath||void 0,a.url=vse+"#cannot-parse-style-attribute",a}}return r;function n(o,i){let a=o;a.slice(0,2)!=="--"&&(a.slice(0,4)==="-ms-"&&(a="ms-"+a.slice(4)),a=a.replace(yLe,LLe)),r[a]=i}}function Sse(t,e,r){let n;if(!r)n={type:"Literal",value:e};else if(e.includes(".")){let o=e.split("."),i=-1,a;for(;++i<o.length;){let s=nD(o[i])?{type:"Identifier",name:o[i]}:{type:"Literal",value:o[i]};a=a?{type:"MemberExpression",object:a,property:s,computed:!!(i&&s.type==="Literal"),optional:!1}:s}n=a}else n=nD(e)&&!/^[a-z]/.test(e)?{type:"Identifier",name:e}:{type:"Literal",value:e};if(n.type==="Literal"){let o=n.value;return X4.call(t.components,o)?t.components[o]:o}if(t.evaluater)return t.evaluater.evaluateExpression(n);QC(t)}function QC(t,e){let r=new Pi("Cannot handle MDX estrees without `createEvaluater`",{ancestors:t.ancestors,place:e,ruleId:"mdx-estree",source:"hast-util-to-jsx-runtime"});throw r.file=t.filePath||void 0,r.url=vse+"#cannot-handle-mdx-estrees-without-createevaluater",r}function MLe(t){let e={},r;for(r in t)X4.call(t,r)&&(e[RLe(r)]=t[r]);return e}function RLe(t){let e=t.replace(gLe,BLe);return e.slice(0,3)==="ms-"&&(e="-"+e),e}function LLe(t,e){return e.toUpperCase()}function BLe(t){return"-"+t.toLowerCase()}var KC={action:["form"],cite:["blockquote","del","ins","q"],data:["object"],formAction:["button","input"],href:["a","area","base","link"],icon:["menuitem"],itemId:null,manifest:["html"],ping:["a","area"],poster:["video"],src:["audio","embed","iframe","img","input","script","source","track","video"]};var Ex=Ot(Or(),1);var OLe={};function $4(t,e){let r=e||OLe,n=typeof r.includeImageAlt=="boolean"?r.includeImageAlt:!0,o=typeof r.includeHtml=="boolean"?r.includeHtml:!0;return Tse(t,n,o)}function Tse(t,e,r){if(FLe(t)){if("value"in t)return t.type==="html"&&!r?"":t.value;if(e&&"alt"in t&&t.alt)return t.alt;if("children"in t)return Cse(t.children,e,r)}return Array.isArray(t)?Cse(t,e,r):""}function Cse(t,e,r){let n=[],o=-1;for(;++o<t.length;)n[o]=Tse(t[o],e,r);return n.join("")}function FLe(t){return!!(t&&typeof t=="object")}var wse=document.createElement("i");function Cx(t){let e="&"+t+";";wse.innerHTML=e;let r=wse.textContent;return r.charCodeAt(r.length-1)===59&&t!=="semi"||r===e?!1:r}function qs(t,e,r,n){let o=t.length,i=0,a;if(e<0?e=-e>o?0:o+e:e=e>o?o:e,r=r>0?r:0,n.length<1e4)a=Array.from(n),a.unshift(e,r),t.splice(...a);else for(r&&t.splice(e,r);i<n.length;)a=n.slice(i,i+1e4),a.unshift(e,0),t.splice(...a),i+=1e4,e+=1e4}function xl(t,e){return t.length>0?(qs(t,t.length,0,e),t):e}var _se={}.hasOwnProperty;function Pse(t){let e={},r=-1;for(;++r<t.length;)NLe(e,t[r]);return e}function NLe(t,e){let r;for(r in e){let o=(_se.call(t,r)?t[r]:void 0)||(t[r]={}),i=e[r],a;if(i)for(a in i){_se.call(o,a)||(o[a]=[]);let s=i[a];VLe(o[a],Array.isArray(s)?s:s?[s]:[])}}}function VLe(t,e){let r=-1,n=[];for(;++r<e.length;)(e[r].add==="after"?t:n).push(e[r]);qs(t,0,0,n)}function lD(t,e){let r=Number.parseInt(t,e);return r<9||r===11||r>13&&r<32||r>126&&r<160||r>55295&&r<57344||r>64975&&r<65008||(r&65535)===65535||(r&65535)===65534||r>1114111?"\uFFFD":String.fromCodePoint(r)}function Zp(t){return t.replace(/[\t\n\r ]+/g," ").replace(/^ | $/g,"").toLowerCase().toUpperCase()}var Fc=mg(/[A-Za-z]/),Ka=mg(/[\dA-Za-z]/),Ese=mg(/[#-'*+\--9=?A-Z^-~]/);function $C(t){return t!==null&&(t<32||t===127)}var ZC=mg(/\d/),Ise=mg(/[\dA-Fa-f]/),Dse=mg(/[!-/:-@[-`{-~]/);function Lt(t){return t!==null&&t<-2}function Ei(t){return t!==null&&(t<0||t===32)}function wr(t){return t===-2||t===-1||t===32}var Ase=mg(new RegExp("\\p{P}|\\p{S}","u")),kse=mg(/\s/);function mg(t){return e;function e(r){return r!==null&&r>-1&&t.test(String.fromCharCode(r))}}function td(t){let e=[],r=-1,n=0,o=0;for(;++r<t.length;){let i=t.charCodeAt(r),a="";if(i===37&&Ka(t.charCodeAt(r+1))&&Ka(t.charCodeAt(r+2)))o=2;else if(i<128)/[!#$&-;=?-Z_a-z~]/.test(String.fromCharCode(i))||(a=String.fromCharCode(i));else if(i>55295&&i<57344){let s=t.charCodeAt(r+1);i<56320&&s>56319&&s<57344?(a=String.fromCharCode(i,s),o=1):a="\uFFFD"}else a=String.fromCharCode(i);a&&(e.push(t.slice(n,r),encodeURIComponent(a)),n=r+o+1,a=""),o&&(r+=o,o=0)}return e.join("")+t.slice(n)}function Ar(t,e,r,n){let o=n?n-1:Number.POSITIVE_INFINITY,i=0;return a;function a(l){return wr(l)?(t.enter(r),s(l)):e(l)}function s(l){return wr(l)&&i++<o?(t.consume(l),s):(t.exit(r),e(l))}}var Mse={tokenize:zLe};function zLe(t){let e=t.attempt(this.parser.constructs.contentInitial,n,o),r;return e;function n(s){if(s===null){t.consume(s);return}return t.enter("lineEnding"),t.consume(s),t.exit("lineEnding"),Ar(t,e,"linePrefix")}function o(s){return t.enter("paragraph"),i(s)}function i(s){let l=t.enter("chunkText",{contentType:"text",previous:r});return r&&(r.next=l),r=l,a(s)}function a(s){if(s===null){t.exit("chunkText"),t.exit("paragraph"),t.consume(s);return}return Lt(s)?(t.consume(s),t.exit("chunkText"),i):(t.consume(s),a)}}var Lse={tokenize:ULe},Rse={tokenize:GLe};function ULe(t){let e=this,r=[],n=0,o,i,a;return s;function s(S){if(n<r.length){let T=r[n];return e.containerState=T[1],t.attempt(T[0].continuation,l,c)(S)}return c(S)}function l(S){if(n++,e.containerState._closeFlow){e.containerState._closeFlow=void 0,o&&x();let T=e.events.length,E=T,_;for(;E--;)if(e.events[E][0]==="exit"&&e.events[E][1].type==="chunkFlow"){_=e.events[E][1].end;break}v(n);let D=T;for(;D<e.events.length;)e.events[D][1].end=Object.assign({},_),D++;return qs(e.events,E+1,0,e.events.slice(T)),e.events.length=D,c(S)}return s(S)}function c(S){if(n===r.length){if(!o)return m(S);if(o.currentConstruct&&o.currentConstruct.concrete)return h(S);e.interrupt=!!(o.currentConstruct&&!o._gfmTableDynamicInterruptHack)}return e.containerState={},t.check(Rse,u,d)(S)}function u(S){return o&&x(),v(n),m(S)}function d(S){return e.parser.lazy[e.now().line]=n!==r.length,a=e.now().offset,h(S)}function m(S){return e.containerState={},t.attempt(Rse,p,h)(S)}function p(S){return n++,r.push([e.currentConstruct,e.containerState]),m(S)}function h(S){if(S===null){o&&x(),v(0),t.consume(S);return}return o=o||e.parser.flow(e.now()),t.enter("chunkFlow",{contentType:"flow",previous:i,_tokenizer:o}),f(S)}function f(S){if(S===null){b(t.exit("chunkFlow"),!0),v(0),t.consume(S);return}return Lt(S)?(t.consume(S),b(t.exit("chunkFlow")),n=0,e.interrupt=void 0,s):(t.consume(S),f)}function b(S,T){let E=e.sliceStream(S);if(T&&E.push(null),S.previous=i,i&&(i.next=S),i=S,o.defineSkip(S.start),o.write(E),e.parser.lazy[S.start.line]){let _=o.events.length;for(;_--;)if(o.events[_][1].start.offset<a&&(!o.events[_][1].end||o.events[_][1].end.offset>a))return;let D=e.events.length,P=D,A,I;for(;P--;)if(e.events[P][0]==="exit"&&e.events[P][1].type==="chunkFlow"){if(A){I=e.events[P][1].end;break}A=!0}for(v(n),_=D;_<e.events.length;)e.events[_][1].end=Object.assign({},I),_++;qs(e.events,P+1,0,e.events.slice(D)),e.events.length=_}}function v(S){let T=r.length;for(;T-- >S;){let E=r[T];e.containerState=E[1],E[0].exit.call(e,t)}r.length=S}function x(){o.write([null]),i=void 0,o=void 0,e.containerState._closeFlow=void 0}}function GLe(t,e,r){return Ar(t,t.attempt(this.parser.constructs.document,e,r),"linePrefix",this.parser.constructs.disable.null.includes("codeIndented")?void 0:4)}function Z4(t){if(t===null||Ei(t)||kse(t))return 1;if(Ase(t))return 2}function Tx(t,e,r){let n=[],o=-1;for(;++o<t.length;){let i=t[o].resolveAll;i&&!n.includes(i)&&(e=i(e,r),n.push(i))}return e}var JC={name:"attention",tokenize:HLe,resolveAll:jLe};function jLe(t,e){let r=-1,n,o,i,a,s,l,c,u;for(;++r<t.length;)if(t[r][0]==="enter"&&t[r][1].type==="attentionSequence"&&t[r][1]._close){for(n=r;n--;)if(t[n][0]==="exit"&&t[n][1].type==="attentionSequence"&&t[n][1]._open&&e.sliceSerialize(t[n][1]).charCodeAt(0)===e.sliceSerialize(t[r][1]).charCodeAt(0)){if((t[n][1]._close||t[r][1]._open)&&(t[r][1].end.offset-t[r][1].start.offset)%3&&!((t[n][1].end.offset-t[n][1].start.offset+t[r][1].end.offset-t[r][1].start.offset)%3))continue;l=t[n][1].end.offset-t[n][1].start.offset>1&&t[r][1].end.offset-t[r][1].start.offset>1?2:1;let d=Object.assign({},t[n][1].end),m=Object.assign({},t[r][1].start);Bse(d,-l),Bse(m,l),a={type:l>1?"strongSequence":"emphasisSequence",start:d,end:Object.assign({},t[n][1].end)},s={type:l>1?"strongSequence":"emphasisSequence",start:Object.assign({},t[r][1].start),end:m},i={type:l>1?"strongText":"emphasisText",start:Object.assign({},t[n][1].end),end:Object.assign({},t[r][1].start)},o={type:l>1?"strong":"emphasis",start:Object.assign({},a.start),end:Object.assign({},s.end)},t[n][1].end=Object.assign({},a.start),t[r][1].start=Object.assign({},s.end),c=[],t[n][1].end.offset-t[n][1].start.offset&&(c=xl(c,[["enter",t[n][1],e],["exit",t[n][1],e]])),c=xl(c,[["enter",o,e],["enter",a,e],["exit",a,e],["enter",i,e]]),c=xl(c,Tx(e.parser.constructs.insideSpan.null,t.slice(n+1,r),e)),c=xl(c,[["exit",i,e],["enter",s,e],["exit",s,e],["exit",o,e]]),t[r][1].end.offset-t[r][1].start.offset?(u=2,c=xl(c,[["enter",t[r][1],e],["exit",t[r][1],e]])):u=0,qs(t,n-1,r-n+3,c),r=n+c.length-u-2;break}}for(r=-1;++r<t.length;)t[r][1].type==="attentionSequence"&&(t[r][1].type="data");return t}function HLe(t,e){let r=this.parser.constructs.attentionMarkers.null,n=this.previous,o=Z4(n),i;return a;function a(l){return i=l,t.enter("attentionSequence"),s(l)}function s(l){if(l===i)return t.consume(l),s;let c=t.exit("attentionSequence"),u=Z4(l),d=!u||u===2&&o||r.includes(l),m=!o||o===2&&u||r.includes(n);return c._open=!!(i===42?d:d&&(o||!m)),c._close=!!(i===42?m:m&&(u||!d)),e(l)}}function Bse(t,e){t.column+=e,t.offset+=e,t._bufferIndex+=e}var J4={name:"autolink",tokenize:qLe};function qLe(t,e,r){let n=0;return o;function o(p){return t.enter("autolink"),t.enter("autolinkMarker"),t.consume(p),t.exit("autolinkMarker"),t.enter("autolinkProtocol"),i}function i(p){return Fc(p)?(t.consume(p),a):p===64?r(p):c(p)}function a(p){return p===43||p===45||p===46||Ka(p)?(n=1,s(p)):c(p)}function s(p){return p===58?(t.consume(p),n=0,l):(p===43||p===45||p===46||Ka(p))&&n++<32?(t.consume(p),s):(n=0,c(p))}function l(p){return p===62?(t.exit("autolinkProtocol"),t.enter("autolinkMarker"),t.consume(p),t.exit("autolinkMarker"),t.exit("autolink"),e):p===null||p===32||p===60||$C(p)?r(p):(t.consume(p),l)}function c(p){return p===64?(t.consume(p),u):Ese(p)?(t.consume(p),c):r(p)}function u(p){return Ka(p)?d(p):r(p)}function d(p){return p===46?(t.consume(p),n=0,u):p===62?(t.exit("autolinkProtocol").type="autolinkEmail",t.enter("autolinkMarker"),t.consume(p),t.exit("autolinkMarker"),t.exit("autolink"),e):m(p)}function m(p){if((p===45||Ka(p))&&n++<63){let h=p===45?m:d;return t.consume(p),h}return r(p)}}var pg={tokenize:WLe,partial:!0};function WLe(t,e,r){return n;function n(i){return wr(i)?Ar(t,o,"linePrefix")(i):o(i)}function o(i){return i===null||Lt(i)?e(i):r(i)}}var cD={name:"blockQuote",tokenize:XLe,continuation:{tokenize:YLe},exit:QLe};function XLe(t,e,r){let n=this;return o;function o(a){if(a===62){let s=n.containerState;return s.open||(t.enter("blockQuote",{_container:!0}),s.open=!0),t.enter("blockQuotePrefix"),t.enter("blockQuoteMarker"),t.consume(a),t.exit("blockQuoteMarker"),i}return r(a)}function i(a){return wr(a)?(t.enter("blockQuotePrefixWhitespace"),t.consume(a),t.exit("blockQuotePrefixWhitespace"),t.exit("blockQuotePrefix"),e):(t.exit("blockQuotePrefix"),e(a))}}function YLe(t,e,r){let n=this;return o;function o(a){return wr(a)?Ar(t,i,"linePrefix",n.parser.constructs.disable.null.includes("codeIndented")?void 0:4)(a):i(a)}function i(a){return t.attempt(cD,e,r)(a)}}function QLe(t){t.exit("blockQuote")}var uD={name:"characterEscape",tokenize:KLe};function KLe(t,e,r){return n;function n(i){return t.enter("characterEscape"),t.enter("escapeMarker"),t.consume(i),t.exit("escapeMarker"),o}function o(i){return Dse(i)?(t.enter("characterEscapeValue"),t.consume(i),t.exit("characterEscapeValue"),t.exit("characterEscape"),e):r(i)}}var dD={name:"characterReference",tokenize:$Le};function $Le(t,e,r){let n=this,o=0,i,a;return s;function s(d){return t.enter("characterReference"),t.enter("characterReferenceMarker"),t.consume(d),t.exit("characterReferenceMarker"),l}function l(d){return d===35?(t.enter("characterReferenceMarkerNumeric"),t.consume(d),t.exit("characterReferenceMarkerNumeric"),c):(t.enter("characterReferenceValue"),i=31,a=Ka,u(d))}function c(d){return d===88||d===120?(t.enter("characterReferenceMarkerHexadecimal"),t.consume(d),t.exit("characterReferenceMarkerHexadecimal"),t.enter("characterReferenceValue"),i=6,a=Ise,u):(t.enter("characterReferenceValue"),i=7,a=ZC,u(d))}function u(d){if(d===59&&o){let m=t.exit("characterReferenceValue");return a===Ka&&!Cx(n.sliceSerialize(m))?r(d):(t.enter("characterReferenceMarker"),t.consume(d),t.exit("characterReferenceMarker"),t.exit("characterReference"),e)}return a(d)&&o++<i?(t.consume(d),u):r(d)}}var Ose={tokenize:JLe,partial:!0},mD={name:"codeFenced",tokenize:ZLe,concrete:!0};function ZLe(t,e,r){let n=this,o={tokenize:E,partial:!0},i=0,a=0,s;return l;function l(_){return c(_)}function c(_){let D=n.events[n.events.length-1];return i=D&&D[1].type==="linePrefix"?D[2].sliceSerialize(D[1],!0).length:0,s=_,t.enter("codeFenced"),t.enter("codeFencedFence"),t.enter("codeFencedFenceSequence"),u(_)}function u(_){return _===s?(a++,t.consume(_),u):a<3?r(_):(t.exit("codeFencedFenceSequence"),wr(_)?Ar(t,d,"whitespace")(_):d(_))}function d(_){return _===null||Lt(_)?(t.exit("codeFencedFence"),n.interrupt?e(_):t.check(Ose,f,T)(_)):(t.enter("codeFencedFenceInfo"),t.enter("chunkString",{contentType:"string"}),m(_))}function m(_){return _===null||Lt(_)?(t.exit("chunkString"),t.exit("codeFencedFenceInfo"),d(_)):wr(_)?(t.exit("chunkString"),t.exit("codeFencedFenceInfo"),Ar(t,p,"whitespace")(_)):_===96&&_===s?r(_):(t.consume(_),m)}function p(_){return _===null||Lt(_)?d(_):(t.enter("codeFencedFenceMeta"),t.enter("chunkString",{contentType:"string"}),h(_))}function h(_){return _===null||Lt(_)?(t.exit("chunkString"),t.exit("codeFencedFenceMeta"),d(_)):_===96&&_===s?r(_):(t.consume(_),h)}function f(_){return t.attempt(o,T,b)(_)}function b(_){return t.enter("lineEnding"),t.consume(_),t.exit("lineEnding"),v}function v(_){return i>0&&wr(_)?Ar(t,x,"linePrefix",i+1)(_):x(_)}function x(_){return _===null||Lt(_)?t.check(Ose,f,T)(_):(t.enter("codeFlowValue"),S(_))}function S(_){return _===null||Lt(_)?(t.exit("codeFlowValue"),x(_)):(t.consume(_),S)}function T(_){return t.exit("codeFenced"),e(_)}function E(_,D,P){let A=0;return I;function I(F){return _.enter("lineEnding"),_.consume(F),_.exit("lineEnding"),k}function k(F){return _.enter("codeFencedFence"),wr(F)?Ar(_,M,"linePrefix",n.parser.constructs.disable.null.includes("codeIndented")?void 0:4)(F):M(F)}function M(F){return F===s?(_.enter("codeFencedFenceSequence"),R(F)):P(F)}function R(F){return F===s?(A++,_.consume(F),R):A>=a?(_.exit("codeFencedFenceSequence"),wr(F)?Ar(_,B,"whitespace")(F):B(F)):P(F)}function B(F){return F===null||Lt(F)?(_.exit("codeFencedFence"),D(F)):P(F)}}}function JLe(t,e,r){let n=this;return o;function o(a){return a===null?r(a):(t.enter("lineEnding"),t.consume(a),t.exit("lineEnding"),i)}function i(a){return n.parser.lazy[n.now().line]?r(a):e(a)}}var eT={name:"codeIndented",tokenize:tBe},eBe={tokenize:rBe,partial:!0};function tBe(t,e,r){let n=this;return o;function o(c){return t.enter("codeIndented"),Ar(t,i,"linePrefix",5)(c)}function i(c){let u=n.events[n.events.length-1];return u&&u[1].type==="linePrefix"&&u[2].sliceSerialize(u[1],!0).length>=4?a(c):r(c)}function a(c){return c===null?l(c):Lt(c)?t.attempt(eBe,a,l)(c):(t.enter("codeFlowValue"),s(c))}function s(c){return c===null||Lt(c)?(t.exit("codeFlowValue"),a(c)):(t.consume(c),s)}function l(c){return t.exit("codeIndented"),e(c)}}function rBe(t,e,r){let n=this;return o;function o(a){return n.parser.lazy[n.now().line]?r(a):Lt(a)?(t.enter("lineEnding"),t.consume(a),t.exit("lineEnding"),o):Ar(t,i,"linePrefix",5)(a)}function i(a){let s=n.events[n.events.length-1];return s&&s[1].type==="linePrefix"&&s[2].sliceSerialize(s[1],!0).length>=4?e(a):Lt(a)?o(a):r(a)}}var eV={name:"codeText",tokenize:iBe,resolve:nBe,previous:oBe};function nBe(t){let e=t.length-4,r=3,n,o;if((t[r][1].type==="lineEnding"||t[r][1].type==="space")&&(t[e][1].type==="lineEnding"||t[e][1].type==="space")){for(n=r;++n<e;)if(t[n][1].type==="codeTextData"){t[r][1].type="codeTextPadding",t[e][1].type="codeTextPadding",r+=2,e-=2;break}}for(n=r-1,e++;++n<=e;)o===void 0?n!==e&&t[n][1].type!=="lineEnding"&&(o=n):(n===e||t[n][1].type==="lineEnding")&&(t[o][1].type="codeTextData",n!==o+2&&(t[o][1].end=t[n-1][1].end,t.splice(o+2,n-o-2),e-=n-o-2,n=o+2),o=void 0);return t}function oBe(t){return t!==96||this.events[this.events.length-1][1].type==="characterEscape"}function iBe(t,e,r){let n=this,o=0,i,a;return s;function s(m){return t.enter("codeText"),t.enter("codeTextSequence"),l(m)}function l(m){return m===96?(t.consume(m),o++,l):(t.exit("codeTextSequence"),c(m))}function c(m){return m===null?r(m):m===32?(t.enter("space"),t.consume(m),t.exit("space"),c):m===96?(a=t.enter("codeTextSequence"),i=0,d(m)):Lt(m)?(t.enter("lineEnding"),t.consume(m),t.exit("lineEnding"),c):(t.enter("codeTextData"),u(m))}function u(m){return m===null||m===32||m===96||Lt(m)?(t.exit("codeTextData"),c(m)):(t.consume(m),u)}function d(m){return m===96?(t.consume(m),i++,d):i===o?(t.exit("codeTextSequence"),t.exit("codeText"),e(m)):(a.type="codeTextData",u(m))}}var pD=class{constructor(e){this.left=e?[...e]:[],this.right=[]}get(e){if(e<0||e>=this.left.length+this.right.length)throw new RangeError("Cannot access index `"+e+"` in a splice buffer of size `"+(this.left.length+this.right.length)+"`");return e<this.left.length?this.left[e]:this.right[this.right.length-e+this.left.length-1]}get length(){return this.left.length+this.right.length}shift(){return this.setCursor(0),this.right.pop()}slice(e,r){let n=r??Number.POSITIVE_INFINITY;return n<this.left.length?this.left.slice(e,n):e>this.left.length?this.right.slice(this.right.length-n+this.left.length,this.right.length-e+this.left.length).reverse():this.left.slice(e).concat(this.right.slice(this.right.length-n+this.left.length).reverse())}splice(e,r,n){let o=r||0;this.setCursor(Math.trunc(e));let i=this.right.splice(this.right.length-o,Number.POSITIVE_INFINITY);return n&&tT(this.left,n),i.reverse()}pop(){return this.setCursor(Number.POSITIVE_INFINITY),this.left.pop()}push(e){this.setCursor(Number.POSITIVE_INFINITY),this.left.push(e)}pushMany(e){this.setCursor(Number.POSITIVE_INFINITY),tT(this.left,e)}unshift(e){this.setCursor(0),this.right.push(e)}unshiftMany(e){this.setCursor(0),tT(this.right,e.reverse())}setCursor(e){if(!(e===this.left.length||e>this.left.length&&this.right.length===0||e<0&&this.left.length===0))if(e<this.left.length){let r=this.left.splice(e,Number.POSITIVE_INFINITY);tT(this.right,r.reverse())}else{let r=this.right.splice(this.left.length+this.right.length-e,Number.POSITIVE_INFINITY);tT(this.left,r.reverse())}}};function tT(t,e){let r=0;if(e.length<1e4)t.push(...e);else for(;r<e.length;)t.push(...e.slice(r,r+1e4)),r+=1e4}function fD(t){let e={},r=-1,n,o,i,a,s,l,c,u=new pD(t);for(;++r<u.length;){for(;r in e;)r=e[r];if(n=u.get(r),r&&n[1].type==="chunkFlow"&&u.get(r-1)[1].type==="listItemPrefix"&&(l=n[1]._tokenizer.events,i=0,i<l.length&&l[i][1].type==="lineEndingBlank"&&(i+=2),i<l.length&&l[i][1].type==="content"))for(;++i<l.length&&l[i][1].type!=="content";)l[i][1].type==="chunkText"&&(l[i][1]._isInFirstContentOfListItem=!0,i++);if(n[0]==="enter")n[1].contentType&&(Object.assign(e,aBe(u,r)),r=e[r],c=!0);else if(n[1]._container){for(i=r,o=void 0;i--&&(a=u.get(i),a[1].type==="lineEnding"||a[1].type==="lineEndingBlank");)a[0]==="enter"&&(o&&(u.get(o)[1].type="lineEndingBlank"),a[1].type="lineEnding",o=i);o&&(n[1].end=Object.assign({},u.get(o)[1].start),s=u.slice(o,r),s.unshift(n),u.splice(o,r-o+1,s))}}return qs(t,0,Number.POSITIVE_INFINITY,u.slice(0)),!c}function aBe(t,e){let r=t.get(e)[1],n=t.get(e)[2],o=e-1,i=[],a=r._tokenizer||n.parser[r.contentType](r.start),s=a.events,l=[],c={},u,d,m=-1,p=r,h=0,f=0,b=[f];for(;p;){for(;t.get(++o)[1]!==p;);i.push(o),p._tokenizer||(u=n.sliceStream(p),p.next||u.push(null),d&&a.defineSkip(p.start),p._isInFirstContentOfListItem&&(a._gfmTasklistFirstContentOfListItem=!0),a.write(u),p._isInFirstContentOfListItem&&(a._gfmTasklistFirstContentOfListItem=void 0)),d=p,p=p.next}for(p=r;++m<s.length;)s[m][0]==="exit"&&s[m-1][0]==="enter"&&s[m][1].type===s[m-1][1].type&&s[m][1].start.line!==s[m][1].end.line&&(f=m+1,b.push(f),p._tokenizer=void 0,p.previous=void 0,p=p.next);for(a.events=[],p?(p._tokenizer=void 0,p.previous=void 0):b.pop(),m=b.length;m--;){let v=s.slice(b[m],b[m+1]),x=i.pop();l.push([x,x+v.length-1]),t.splice(x,2,v)}for(l.reverse(),m=-1;++m<l.length;)c[h+l[m][0]]=h+l[m][1],h+=l[m][1]-l[m][0]-1;return c}var tV={tokenize:cBe,resolve:lBe},sBe={tokenize:uBe,partial:!0};function lBe(t){return fD(t),t}function cBe(t,e){let r;return n;function n(s){return t.enter("content"),r=t.enter("chunkContent",{contentType:"content"}),o(s)}function o(s){return s===null?i(s):Lt(s)?t.check(sBe,a,i)(s):(t.consume(s),o)}function i(s){return t.exit("chunkContent"),t.exit("content"),e(s)}function a(s){return t.consume(s),t.exit("chunkContent"),r.next=t.enter("chunkContent",{contentType:"content",previous:r}),r=r.next,o}}function uBe(t,e,r){let n=this;return o;function o(a){return t.exit("chunkContent"),t.enter("lineEnding"),t.consume(a),t.exit("lineEnding"),Ar(t,i,"linePrefix")}function i(a){if(a===null||Lt(a))return r(a);let s=n.events[n.events.length-1];return!n.parser.constructs.disable.null.includes("codeIndented")&&s&&s[1].type==="linePrefix"&&s[2].sliceSerialize(s[1],!0).length>=4?e(a):t.interrupt(n.parser.constructs.flow,r,e)(a)}}function hD(t,e,r,n,o,i,a,s,l){let c=l||Number.POSITIVE_INFINITY,u=0;return d;function d(v){return v===60?(t.enter(n),t.enter(o),t.enter(i),t.consume(v),t.exit(i),m):v===null||v===32||v===41||$C(v)?r(v):(t.enter(n),t.enter(a),t.enter(s),t.enter("chunkString",{contentType:"string"}),f(v))}function m(v){return v===62?(t.enter(i),t.consume(v),t.exit(i),t.exit(o),t.exit(n),e):(t.enter(s),t.enter("chunkString",{contentType:"string"}),p(v))}function p(v){return v===62?(t.exit("chunkString"),t.exit(s),m(v)):v===null||v===60||Lt(v)?r(v):(t.consume(v),v===92?h:p)}function h(v){return v===60||v===62||v===92?(t.consume(v),p):p(v)}function f(v){return!u&&(v===null||v===41||Ei(v))?(t.exit("chunkString"),t.exit(s),t.exit(a),t.exit(n),e(v)):u<c&&v===40?(t.consume(v),u++,f):v===41?(t.consume(v),u--,f):v===null||v===32||v===40||$C(v)?r(v):(t.consume(v),v===92?b:f)}function b(v){return v===40||v===41||v===92?(t.consume(v),f):f(v)}}function gD(t,e,r,n,o,i){let a=this,s=0,l;return c;function c(p){return t.enter(n),t.enter(o),t.consume(p),t.exit(o),t.enter(i),u}function u(p){return s>999||p===null||p===91||p===93&&!l||p===94&&!s&&"_hiddenFootnoteSupport"in a.parser.constructs?r(p):p===93?(t.exit(i),t.enter(o),t.consume(p),t.exit(o),t.exit(n),e):Lt(p)?(t.enter("lineEnding"),t.consume(p),t.exit("lineEnding"),u):(t.enter("chunkString",{contentType:"string"}),d(p))}function d(p){return p===null||p===91||p===93||Lt(p)||s++>999?(t.exit("chunkString"),u(p)):(t.consume(p),l||(l=!wr(p)),p===92?m:d)}function m(p){return p===91||p===92||p===93?(t.consume(p),s++,d):d(p)}}function yD(t,e,r,n,o,i){let a;return s;function s(m){return m===34||m===39||m===40?(t.enter(n),t.enter(o),t.consume(m),t.exit(o),a=m===40?41:m,l):r(m)}function l(m){return m===a?(t.enter(o),t.consume(m),t.exit(o),t.exit(n),e):(t.enter(i),c(m))}function c(m){return m===a?(t.exit(i),l(a)):m===null?r(m):Lt(m)?(t.enter("lineEnding"),t.consume(m),t.exit("lineEnding"),Ar(t,c,"linePrefix")):(t.enter("chunkString",{contentType:"string"}),u(m))}function u(m){return m===a||m===null||Lt(m)?(t.exit("chunkString"),c(m)):(t.consume(m),m===92?d:u)}function d(m){return m===a||m===92?(t.consume(m),u):u(m)}}function Ky(t,e){let r;return n;function n(o){return Lt(o)?(t.enter("lineEnding"),t.consume(o),t.exit("lineEnding"),r=!0,n):wr(o)?Ar(t,n,r?"linePrefix":"lineSuffix")(o):e(o)}}var rV={name:"definition",tokenize:mBe},dBe={tokenize:pBe,partial:!0};function mBe(t,e,r){let n=this,o;return i;function i(p){return t.enter("definition"),a(p)}function a(p){return gD.call(n,t,s,r,"definitionLabel","definitionLabelMarker","definitionLabelString")(p)}function s(p){return o=Zp(n.sliceSerialize(n.events[n.events.length-1][1]).slice(1,-1)),p===58?(t.enter("definitionMarker"),t.consume(p),t.exit("definitionMarker"),l):r(p)}function l(p){return Ei(p)?Ky(t,c)(p):c(p)}function c(p){return hD(t,u,r,"definitionDestination","definitionDestinationLiteral","definitionDestinationLiteralMarker","definitionDestinationRaw","definitionDestinationString")(p)}function u(p){return t.attempt(dBe,d,d)(p)}function d(p){return wr(p)?Ar(t,m,"whitespace")(p):m(p)}function m(p){return p===null||Lt(p)?(t.exit("definition"),n.parser.defined.push(o),e(p)):r(p)}}function pBe(t,e,r){return n;function n(s){return Ei(s)?Ky(t,o)(s):r(s)}function o(s){return yD(t,i,r,"definitionTitle","definitionTitleMarker","definitionTitleString")(s)}function i(s){return wr(s)?Ar(t,a,"whitespace")(s):a(s)}function a(s){return s===null||Lt(s)?e(s):r(s)}}var nV={name:"hardBreakEscape",tokenize:fBe};function fBe(t,e,r){return n;function n(i){return t.enter("hardBreakEscape"),t.consume(i),o}function o(i){return Lt(i)?(t.exit("hardBreakEscape"),e(i)):r(i)}}var oV={name:"headingAtx",tokenize:gBe,resolve:hBe};function hBe(t,e){let r=t.length-2,n=3,o,i;return t[n][1].type==="whitespace"&&(n+=2),r-2>n&&t[r][1].type==="whitespace"&&(r-=2),t[r][1].type==="atxHeadingSequence"&&(n===r-1||r-4>n&&t[r-2][1].type==="whitespace")&&(r-=n+1===r?2:4),r>n&&(o={type:"atxHeadingText",start:t[n][1].start,end:t[r][1].end},i={type:"chunkText",start:t[n][1].start,end:t[r][1].end,contentType:"text"},qs(t,n,r-n+1,[["enter",o,e],["enter",i,e],["exit",i,e],["exit",o,e]])),t}function gBe(t,e,r){let n=0;return o;function o(u){return t.enter("atxHeading"),i(u)}function i(u){return t.enter("atxHeadingSequence"),a(u)}function a(u){return u===35&&n++<6?(t.consume(u),a):u===null||Ei(u)?(t.exit("atxHeadingSequence"),s(u)):r(u)}function s(u){return u===35?(t.enter("atxHeadingSequence"),l(u)):u===null||Lt(u)?(t.exit("atxHeading"),e(u)):wr(u)?Ar(t,s,"whitespace")(u):(t.enter("atxHeadingText"),c(u))}function l(u){return u===35?(t.consume(u),l):(t.exit("atxHeadingSequence"),s(u))}function c(u){return u===null||u===35||Ei(u)?(t.exit("atxHeadingText"),s(u)):(t.consume(u),c)}}var Fse=["address","article","aside","base","basefont","blockquote","body","caption","center","col","colgroup","dd","details","dialog","dir","div","dl","dt","fieldset","figcaption","figure","footer","form","frame","frameset","h1","h2","h3","h4","h5","h6","head","header","hr","html","iframe","legend","li","link","main","menu","menuitem","nav","noframes","ol","optgroup","option","p","param","search","section","summary","table","tbody","td","tfoot","th","thead","title","tr","track","ul"],iV=["pre","script","style","textarea"];var aV={name:"htmlFlow",tokenize:xBe,resolveTo:bBe,concrete:!0},yBe={tokenize:CBe,partial:!0},vBe={tokenize:SBe,partial:!0};function bBe(t){let e=t.length;for(;e--&&!(t[e][0]==="enter"&&t[e][1].type==="htmlFlow"););return e>1&&t[e-2][1].type==="linePrefix"&&(t[e][1].start=t[e-2][1].start,t[e+1][1].start=t[e-2][1].start,t.splice(e-2,2)),t}function xBe(t,e,r){let n=this,o,i,a,s,l;return c;function c(O){return u(O)}function u(O){return t.enter("htmlFlow"),t.enter("htmlFlowData"),t.consume(O),d}function d(O){return O===33?(t.consume(O),m):O===47?(t.consume(O),i=!0,f):O===63?(t.consume(O),o=3,n.interrupt?e:L):Fc(O)?(t.consume(O),a=String.fromCharCode(O),b):r(O)}function m(O){return O===45?(t.consume(O),o=2,p):O===91?(t.consume(O),o=5,s=0,h):Fc(O)?(t.consume(O),o=4,n.interrupt?e:L):r(O)}function p(O){return O===45?(t.consume(O),n.interrupt?e:L):r(O)}function h(O){let J="CDATA[";return O===J.charCodeAt(s++)?(t.consume(O),s===J.length?n.interrupt?e:M:h):r(O)}function f(O){return Fc(O)?(t.consume(O),a=String.fromCharCode(O),b):r(O)}function b(O){if(O===null||O===47||O===62||Ei(O)){let J=O===47,$=a.toLowerCase();return!J&&!i&&iV.includes($)?(o=1,n.interrupt?e(O):M(O)):Fse.includes(a.toLowerCase())?(o=6,J?(t.consume(O),v):n.interrupt?e(O):M(O)):(o=7,n.interrupt&&!n.parser.lazy[n.now().line]?r(O):i?x(O):S(O))}return O===45||Ka(O)?(t.consume(O),a+=String.fromCharCode(O),b):r(O)}function v(O){return O===62?(t.consume(O),n.interrupt?e:M):r(O)}function x(O){return wr(O)?(t.consume(O),x):I(O)}function S(O){return O===47?(t.consume(O),I):O===58||O===95||Fc(O)?(t.consume(O),T):wr(O)?(t.consume(O),S):I(O)}function T(O){return O===45||O===46||O===58||O===95||Ka(O)?(t.consume(O),T):E(O)}function E(O){return O===61?(t.consume(O),_):wr(O)?(t.consume(O),E):S(O)}function _(O){return O===null||O===60||O===61||O===62||O===96?r(O):O===34||O===39?(t.consume(O),l=O,D):wr(O)?(t.consume(O),_):P(O)}function D(O){return O===l?(t.consume(O),l=null,A):O===null||Lt(O)?r(O):(t.consume(O),D)}function P(O){return O===null||O===34||O===39||O===47||O===60||O===61||O===62||O===96||Ei(O)?E(O):(t.consume(O),P)}function A(O){return O===47||O===62||wr(O)?S(O):r(O)}function I(O){return O===62?(t.consume(O),k):r(O)}function k(O){return O===null||Lt(O)?M(O):wr(O)?(t.consume(O),k):r(O)}function M(O){return O===45&&o===2?(t.consume(O),G):O===60&&o===1?(t.consume(O),V):O===62&&o===4?(t.consume(O),Y):O===63&&o===3?(t.consume(O),L):O===93&&o===5?(t.consume(O),Q):Lt(O)&&(o===6||o===7)?(t.exit("htmlFlowData"),t.check(yBe,j,R)(O)):O===null||Lt(O)?(t.exit("htmlFlowData"),R(O)):(t.consume(O),M)}function R(O){return t.check(vBe,B,j)(O)}function B(O){return t.enter("lineEnding"),t.consume(O),t.exit("lineEnding"),F}function F(O){return O===null||Lt(O)?R(O):(t.enter("htmlFlowData"),M(O))}function G(O){return O===45?(t.consume(O),L):M(O)}function V(O){return O===47?(t.consume(O),a="",H):M(O)}function H(O){if(O===62){let J=a.toLowerCase();return iV.includes(J)?(t.consume(O),Y):M(O)}return Fc(O)&&a.length<8?(t.consume(O),a+=String.fromCharCode(O),H):M(O)}function Q(O){return O===93?(t.consume(O),L):M(O)}function L(O){return O===62?(t.consume(O),Y):O===45&&o===2?(t.consume(O),L):M(O)}function Y(O){return O===null||Lt(O)?(t.exit("htmlFlowData"),j(O)):(t.consume(O),Y)}function j(O){return t.exit("htmlFlow"),e(O)}}function SBe(t,e,r){let n=this;return o;function o(a){return Lt(a)?(t.enter("lineEnding"),t.consume(a),t.exit("lineEnding"),i):r(a)}function i(a){return n.parser.lazy[n.now().line]?r(a):e(a)}}function CBe(t,e,r){return n;function n(o){return t.enter("lineEnding"),t.consume(o),t.exit("lineEnding"),t.attempt(pg,e,r)}}var sV={name:"htmlText",tokenize:TBe};function TBe(t,e,r){let n=this,o,i,a;return s;function s(L){return t.enter("htmlText"),t.enter("htmlTextData"),t.consume(L),l}function l(L){return L===33?(t.consume(L),c):L===47?(t.consume(L),E):L===63?(t.consume(L),S):Fc(L)?(t.consume(L),P):r(L)}function c(L){return L===45?(t.consume(L),u):L===91?(t.consume(L),i=0,h):Fc(L)?(t.consume(L),x):r(L)}function u(L){return L===45?(t.consume(L),p):r(L)}function d(L){return L===null?r(L):L===45?(t.consume(L),m):Lt(L)?(a=d,V(L)):(t.consume(L),d)}function m(L){return L===45?(t.consume(L),p):d(L)}function p(L){return L===62?G(L):L===45?m(L):d(L)}function h(L){let Y="CDATA[";return L===Y.charCodeAt(i++)?(t.consume(L),i===Y.length?f:h):r(L)}function f(L){return L===null?r(L):L===93?(t.consume(L),b):Lt(L)?(a=f,V(L)):(t.consume(L),f)}function b(L){return L===93?(t.consume(L),v):f(L)}function v(L){return L===62?G(L):L===93?(t.consume(L),v):f(L)}function x(L){return L===null||L===62?G(L):Lt(L)?(a=x,V(L)):(t.consume(L),x)}function S(L){return L===null?r(L):L===63?(t.consume(L),T):Lt(L)?(a=S,V(L)):(t.consume(L),S)}function T(L){return L===62?G(L):S(L)}function E(L){return Fc(L)?(t.consume(L),_):r(L)}function _(L){return L===45||Ka(L)?(t.consume(L),_):D(L)}function D(L){return Lt(L)?(a=D,V(L)):wr(L)?(t.consume(L),D):G(L)}function P(L){return L===45||Ka(L)?(t.consume(L),P):L===47||L===62||Ei(L)?A(L):r(L)}function A(L){return L===47?(t.consume(L),G):L===58||L===95||Fc(L)?(t.consume(L),I):Lt(L)?(a=A,V(L)):wr(L)?(t.consume(L),A):G(L)}function I(L){return L===45||L===46||L===58||L===95||Ka(L)?(t.consume(L),I):k(L)}function k(L){return L===61?(t.consume(L),M):Lt(L)?(a=k,V(L)):wr(L)?(t.consume(L),k):A(L)}function M(L){return L===null||L===60||L===61||L===62||L===96?r(L):L===34||L===39?(t.consume(L),o=L,R):Lt(L)?(a=M,V(L)):wr(L)?(t.consume(L),M):(t.consume(L),B)}function R(L){return L===o?(t.consume(L),o=void 0,F):L===null?r(L):Lt(L)?(a=R,V(L)):(t.consume(L),R)}function B(L){return L===null||L===34||L===39||L===60||L===61||L===96?r(L):L===47||L===62||Ei(L)?A(L):(t.consume(L),B)}function F(L){return L===47||L===62||Ei(L)?A(L):r(L)}function G(L){return L===62?(t.consume(L),t.exit("htmlTextData"),t.exit("htmlText"),e):r(L)}function V(L){return t.exit("htmlTextData"),t.enter("lineEnding"),t.consume(L),t.exit("lineEnding"),H}function H(L){return wr(L)?Ar(t,Q,"linePrefix",n.parser.constructs.disable.null.includes("codeIndented")?void 0:4)(L):Q(L)}function Q(L){return t.enter("htmlTextData"),a(L)}}var $y={name:"labelEnd",tokenize:DBe,resolveTo:IBe,resolveAll:EBe},wBe={tokenize:ABe},_Be={tokenize:kBe},PBe={tokenize:MBe};function EBe(t){let e=-1;for(;++e<t.length;){let r=t[e][1];(r.type==="labelImage"||r.type==="labelLink"||r.type==="labelEnd")&&(t.splice(e+1,r.type==="labelImage"?4:2),r.type="data",e++)}return t}function IBe(t,e){let r=t.length,n=0,o,i,a,s;for(;r--;)if(o=t[r][1],i){if(o.type==="link"||o.type==="labelLink"&&o._inactive)break;t[r][0]==="enter"&&o.type==="labelLink"&&(o._inactive=!0)}else if(a){if(t[r][0]==="enter"&&(o.type==="labelImage"||o.type==="labelLink")&&!o._balanced&&(i=r,o.type!=="labelLink")){n=2;break}}else o.type==="labelEnd"&&(a=r);let l={type:t[i][1].type==="labelLink"?"link":"image",start:Object.assign({},t[i][1].start),end:Object.assign({},t[t.length-1][1].end)},c={type:"label",start:Object.assign({},t[i][1].start),end:Object.assign({},t[a][1].end)},u={type:"labelText",start:Object.assign({},t[i+n+2][1].end),end:Object.assign({},t[a-2][1].start)};return s=[["enter",l,e],["enter",c,e]],s=xl(s,t.slice(i+1,i+n+3)),s=xl(s,[["enter",u,e]]),s=xl(s,Tx(e.parser.constructs.insideSpan.null,t.slice(i+n+4,a-3),e)),s=xl(s,[["exit",u,e],t[a-2],t[a-1],["exit",c,e]]),s=xl(s,t.slice(a+1)),s=xl(s,[["exit",l,e]]),qs(t,i,t.length,s),t}function DBe(t,e,r){let n=this,o=n.events.length,i,a;for(;o--;)if((n.events[o][1].type==="labelImage"||n.events[o][1].type==="labelLink")&&!n.events[o][1]._balanced){i=n.events[o][1];break}return s;function s(m){return i?i._inactive?d(m):(a=n.parser.defined.includes(Zp(n.sliceSerialize({start:i.end,end:n.now()}))),t.enter("labelEnd"),t.enter("labelMarker"),t.consume(m),t.exit("labelMarker"),t.exit("labelEnd"),l):r(m)}function l(m){return m===40?t.attempt(wBe,u,a?u:d)(m):m===91?t.attempt(_Be,u,a?c:d)(m):a?u(m):d(m)}function c(m){return t.attempt(PBe,u,d)(m)}function u(m){return e(m)}function d(m){return i._balanced=!0,r(m)}}function ABe(t,e,r){return n;function n(d){return t.enter("resource"),t.enter("resourceMarker"),t.consume(d),t.exit("resourceMarker"),o}function o(d){return Ei(d)?Ky(t,i)(d):i(d)}function i(d){return d===41?u(d):hD(t,a,s,"resourceDestination","resourceDestinationLiteral","resourceDestinationLiteralMarker","resourceDestinationRaw","resourceDestinationString",32)(d)}function a(d){return Ei(d)?Ky(t,l)(d):u(d)}function s(d){return r(d)}function l(d){return d===34||d===39||d===40?yD(t,c,r,"resourceTitle","resourceTitleMarker","resourceTitleString")(d):u(d)}function c(d){return Ei(d)?Ky(t,u)(d):u(d)}function u(d){return d===41?(t.enter("resourceMarker"),t.consume(d),t.exit("resourceMarker"),t.exit("resource"),e):r(d)}}function kBe(t,e,r){let n=this;return o;function o(s){return gD.call(n,t,i,a,"reference","referenceMarker","referenceString")(s)}function i(s){return n.parser.defined.includes(Zp(n.sliceSerialize(n.events[n.events.length-1][1]).slice(1,-1)))?e(s):r(s)}function a(s){return r(s)}}function MBe(t,e,r){return n;function n(i){return t.enter("reference"),t.enter("referenceMarker"),t.consume(i),t.exit("referenceMarker"),o}function o(i){return i===93?(t.enter("referenceMarker"),t.consume(i),t.exit("referenceMarker"),t.exit("reference"),e):r(i)}}var lV={name:"labelStartImage",tokenize:RBe,resolveAll:$y.resolveAll};function RBe(t,e,r){let n=this;return o;function o(s){return t.enter("labelImage"),t.enter("labelImageMarker"),t.consume(s),t.exit("labelImageMarker"),i}function i(s){return s===91?(t.enter("labelMarker"),t.consume(s),t.exit("labelMarker"),t.exit("labelImage"),a):r(s)}function a(s){return s===94&&"_hiddenFootnoteSupport"in n.parser.constructs?r(s):e(s)}}var cV={name:"labelStartLink",tokenize:LBe,resolveAll:$y.resolveAll};function LBe(t,e,r){let n=this;return o;function o(a){return t.enter("labelLink"),t.enter("labelMarker"),t.consume(a),t.exit("labelMarker"),t.exit("labelLink"),i}function i(a){return a===94&&"_hiddenFootnoteSupport"in n.parser.constructs?r(a):e(a)}}var rT={name:"lineEnding",tokenize:BBe};function BBe(t,e){return r;function r(n){return t.enter("lineEnding"),t.consume(n),t.exit("lineEnding"),Ar(t,e,"linePrefix")}}var Zy={name:"thematicBreak",tokenize:OBe};function OBe(t,e,r){let n=0,o;return i;function i(c){return t.enter("thematicBreak"),a(c)}function a(c){return o=c,s(c)}function s(c){return c===o?(t.enter("thematicBreakSequence"),l(c)):n>=3&&(c===null||Lt(c))?(t.exit("thematicBreak"),e(c)):r(c)}function l(c){return c===o?(t.consume(c),n++,l):(t.exit("thematicBreakSequence"),wr(c)?Ar(t,s,"whitespace")(c):s(c))}}var Ws={name:"list",tokenize:VBe,continuation:{tokenize:zBe},exit:GBe},FBe={tokenize:jBe,partial:!0},NBe={tokenize:UBe,partial:!0};function VBe(t,e,r){let n=this,o=n.events[n.events.length-1],i=o&&o[1].type==="linePrefix"?o[2].sliceSerialize(o[1],!0).length:0,a=0;return s;function s(p){let h=n.containerState.type||(p===42||p===43||p===45?"listUnordered":"listOrdered");if(h==="listUnordered"?!n.containerState.marker||p===n.containerState.marker:ZC(p)){if(n.containerState.type||(n.containerState.type=h,t.enter(h,{_container:!0})),h==="listUnordered")return t.enter("listItemPrefix"),p===42||p===45?t.check(Zy,r,c)(p):c(p);if(!n.interrupt||p===49)return t.enter("listItemPrefix"),t.enter("listItemValue"),l(p)}return r(p)}function l(p){return ZC(p)&&++a<10?(t.consume(p),l):(!n.interrupt||a<2)&&(n.containerState.marker?p===n.containerState.marker:p===41||p===46)?(t.exit("listItemValue"),c(p)):r(p)}function c(p){return t.enter("listItemMarker"),t.consume(p),t.exit("listItemMarker"),n.containerState.marker=n.containerState.marker||p,t.check(pg,n.interrupt?r:u,t.attempt(FBe,m,d))}function u(p){return n.containerState.initialBlankLine=!0,i++,m(p)}function d(p){return wr(p)?(t.enter("listItemPrefixWhitespace"),t.consume(p),t.exit("listItemPrefixWhitespace"),m):r(p)}function m(p){return n.containerState.size=i+n.sliceSerialize(t.exit("listItemPrefix"),!0).length,e(p)}}function zBe(t,e,r){let n=this;return n.containerState._closeFlow=void 0,t.check(pg,o,i);function o(s){return n.containerState.furtherBlankLines=n.containerState.furtherBlankLines||n.containerState.initialBlankLine,Ar(t,e,"listItemIndent",n.containerState.size+1)(s)}function i(s){return n.containerState.furtherBlankLines||!wr(s)?(n.containerState.furtherBlankLines=void 0,n.containerState.initialBlankLine=void 0,a(s)):(n.containerState.furtherBlankLines=void 0,n.containerState.initialBlankLine=void 0,t.attempt(NBe,e,a)(s))}function a(s){return n.containerState._closeFlow=!0,n.interrupt=void 0,Ar(t,t.attempt(Ws,e,r),"linePrefix",n.parser.constructs.disable.null.includes("codeIndented")?void 0:4)(s)}}function UBe(t,e,r){let n=this;return Ar(t,o,"listItemIndent",n.containerState.size+1);function o(i){let a=n.events[n.events.length-1];return a&&a[1].type==="listItemIndent"&&a[2].sliceSerialize(a[1],!0).length===n.containerState.size?e(i):r(i)}}function GBe(t){t.exit(this.containerState.type)}function jBe(t,e,r){let n=this;return Ar(t,o,"listItemPrefixWhitespace",n.parser.constructs.disable.null.includes("codeIndented")?void 0:5);function o(i){let a=n.events[n.events.length-1];return!wr(i)&&a&&a[1].type==="listItemPrefixWhitespace"?e(i):r(i)}}var vD={name:"setextUnderline",tokenize:qBe,resolveTo:HBe};function HBe(t,e){let r=t.length,n,o,i;for(;r--;)if(t[r][0]==="enter"){if(t[r][1].type==="content"){n=r;break}t[r][1].type==="paragraph"&&(o=r)}else t[r][1].type==="content"&&t.splice(r,1),!i&&t[r][1].type==="definition"&&(i=r);let a={type:"setextHeading",start:Object.assign({},t[o][1].start),end:Object.assign({},t[t.length-1][1].end)};return t[o][1].type="setextHeadingText",i?(t.splice(o,0,["enter",a,e]),t.splice(i+1,0,["exit",t[n][1],e]),t[n][1].end=Object.assign({},t[i][1].end)):t[n][1]=a,t.push(["exit",a,e]),t}function qBe(t,e,r){let n=this,o;return i;function i(c){let u=n.events.length,d;for(;u--;)if(n.events[u][1].type!=="lineEnding"&&n.events[u][1].type!=="linePrefix"&&n.events[u][1].type!=="content"){d=n.events[u][1].type==="paragraph";break}return!n.parser.lazy[n.now().line]&&(n.interrupt||d)?(t.enter("setextHeadingLine"),o=c,a(c)):r(c)}function a(c){return t.enter("setextHeadingLineSequence"),s(c)}function s(c){return c===o?(t.consume(c),s):(t.exit("setextHeadingLineSequence"),wr(c)?Ar(t,l,"lineSuffix")(c):l(c))}function l(c){return c===null||Lt(c)?(t.exit("setextHeadingLine"),e(c)):r(c)}}var Nse={tokenize:WBe};function WBe(t){let e=this,r=t.attempt(pg,n,t.attempt(this.parser.constructs.flowInitial,o,Ar(t,t.attempt(this.parser.constructs.flow,o,t.attempt(tV,o)),"linePrefix")));return r;function n(i){if(i===null){t.consume(i);return}return t.enter("lineEndingBlank"),t.consume(i),t.exit("lineEndingBlank"),e.currentConstruct=void 0,r}function o(i){if(i===null){t.consume(i);return}return t.enter("lineEnding"),t.consume(i),t.exit("lineEnding"),e.currentConstruct=void 0,r}}var Vse={resolveAll:jse()},zse=Gse("string"),Use=Gse("text");function Gse(t){return{tokenize:e,resolveAll:jse(t==="text"?XBe:void 0)};function e(r){let n=this,o=this.parser.constructs[t],i=r.attempt(o,a,s);return a;function a(u){return c(u)?i(u):s(u)}function s(u){if(u===null){r.consume(u);return}return r.enter("data"),r.consume(u),l}function l(u){return c(u)?(r.exit("data"),i(u)):(r.consume(u),l)}function c(u){if(u===null)return!0;let d=o[u],m=-1;if(d)for(;++m<d.length;){let p=d[m];if(!p.previous||p.previous.call(n,n.previous))return!0}return!1}}}function jse(t){return e;function e(r,n){let o=-1,i;for(;++o<=r.length;)i===void 0?r[o]&&r[o][1].type==="data"&&(i=o,o++):(!r[o]||r[o][1].type!=="data")&&(o!==i+2&&(r[i][1].end=r[o-1][1].end,r.splice(i+2,o-i-2),o=i+2),i=void 0);return t?t(r,n):r}}function XBe(t,e){let r=0;for(;++r<=t.length;)if((r===t.length||t[r][1].type==="lineEnding")&&t[r-1][1].type==="data"){let n=t[r-1][1],o=e.sliceStream(n),i=o.length,a=-1,s=0,l;for(;i--;){let c=o[i];if(typeof c=="string"){for(a=c.length;c.charCodeAt(a-1)===32;)s++,a--;if(a)break;a=-1}else if(c===-2)l=!0,s++;else if(c!==-1){i++;break}}if(s){let c={type:r===t.length||l||s<2?"lineSuffix":"hardBreakTrailing",start:{line:n.end.line,column:n.end.column-s,offset:n.end.offset-s,_index:n.start._index+i,_bufferIndex:i?a:n.start._bufferIndex+a},end:Object.assign({},n.end)};n.end=Object.assign({},c.start),n.start.offset===n.end.offset?Object.assign(n,c):(t.splice(r,0,["enter",c,e],["exit",c,e]),r+=2)}r++}return t}function Hse(t,e,r){let n=Object.assign(r?Object.assign({},r):{line:1,column:1,offset:0},{_index:0,_bufferIndex:-1}),o={},i=[],a=[],s=[],l=!0,c={consume:T,enter:E,exit:_,attempt:A(D),check:A(P),interrupt:A(P,{interrupt:!0})},u={previous:null,code:null,containerState:{},events:[],parser:t,sliceStream:f,sliceSerialize:h,now:b,defineSkip:v,write:p},d=e.tokenize.call(u,c),m;return e.resolveAll&&i.push(e),u;function p(R){return a=xl(a,R),x(),a[a.length-1]!==null?[]:(I(e,0),u.events=Tx(i,u.events,u),u.events)}function h(R,B){return QBe(f(R),B)}function f(R){return YBe(a,R)}function b(){let{line:R,column:B,offset:F,_index:G,_bufferIndex:V}=n;return{line:R,column:B,offset:F,_index:G,_bufferIndex:V}}function v(R){o[R.line]=R.column,M()}function x(){let R;for(;n._index<a.length;){let B=a[n._index];if(typeof B=="string")for(R=n._index,n._bufferIndex<0&&(n._bufferIndex=0);n._index===R&&n._bufferIndex<B.length;)S(B.charCodeAt(n._bufferIndex));else S(B)}}function S(R){l=void 0,m=R,d=d(R)}function T(R){Lt(R)?(n.line++,n.column=1,n.offset+=R===-3?2:1,M()):R!==-1&&(n.column++,n.offset++),n._bufferIndex<0?n._index++:(n._bufferIndex++,n._bufferIndex===a[n._index].length&&(n._bufferIndex=-1,n._index++)),u.previous=R,l=!0}function E(R,B){let F=B||{};return F.type=R,F.start=b(),u.events.push(["enter",F,u]),s.push(F),F}function _(R){let B=s.pop();return B.end=b(),u.events.push(["exit",B,u]),B}function D(R,B){I(R,B.from)}function P(R,B){B.restore()}function A(R,B){return F;function F(G,V,H){let Q,L,Y,j;return Array.isArray(G)?J(G):"tokenize"in G?J([G]):O(G);function O(se){return Me;function Me(be){let _e=be!==null&&se[be],je=be!==null&&se.null,gt=[...Array.isArray(_e)?_e:_e?[_e]:[],...Array.isArray(je)?je:je?[je]:[]];return J(gt)(be)}}function J(se){return Q=se,L=0,se.length===0?H:$(se[L])}function $(se){return Me;function Me(be){return j=k(),Y=se,se.partial||(u.currentConstruct=se),se.name&&u.parser.constructs.disable.null.includes(se.name)?Z(be):se.tokenize.call(B?Object.assign(Object.create(u),B):u,c,ae,Z)(be)}}function ae(se){return l=!0,R(Y,j),V}function Z(se){return l=!0,j.restore(),++L<Q.length?$(Q[L]):H}}}function I(R,B){R.resolveAll&&!i.includes(R)&&i.push(R),R.resolve&&qs(u.events,B,u.events.length-B,R.resolve(u.events.slice(B),u)),R.resolveTo&&(u.events=R.resolveTo(u.events,u))}function k(){let R=b(),B=u.previous,F=u.currentConstruct,G=u.events.length,V=Array.from(s);return{restore:H,from:G};function H(){n=R,u.previous=B,u.currentConstruct=F,u.events.length=G,s=V,M()}}function M(){n.line in o&&n.column<2&&(n.column=o[n.line],n.offset+=o[n.line]-1)}}function YBe(t,e){let r=e.start._index,n=e.start._bufferIndex,o=e.end._index,i=e.end._bufferIndex,a;if(r===o)a=[t[r].slice(n,i)];else{if(a=t.slice(r,o),n>-1){let s=a[0];typeof s=="string"?a[0]=s.slice(n):a.shift()}i>0&&a.push(t[o].slice(0,i))}return a}function QBe(t,e){let r=-1,n=[],o;for(;++r<t.length;){let i=t[r],a;if(typeof i=="string")a=i;else switch(i){case-5:{a="\r";break}case-4:{a=`
`;break}case-3:{a=`\r
`;break}case-2:{a=e?" ":"	";break}case-1:{if(!e&&o)continue;a=" ";break}default:a=String.fromCharCode(i)}o=i===-2,n.push(a)}return n.join("")}var uV={};ua(uV,{attentionMarkers:()=>nOe,contentInitial:()=>$Be,disable:()=>oOe,document:()=>KBe,flow:()=>JBe,flowInitial:()=>ZBe,insideSpan:()=>rOe,string:()=>eOe,text:()=>tOe});var KBe={42:Ws,43:Ws,45:Ws,48:Ws,49:Ws,50:Ws,51:Ws,52:Ws,53:Ws,54:Ws,55:Ws,56:Ws,57:Ws,62:cD},$Be={91:rV},ZBe={[-2]:eT,[-1]:eT,32:eT},JBe={35:oV,42:Zy,45:[vD,Zy],60:aV,61:vD,95:Zy,96:mD,126:mD},eOe={38:dD,92:uD},tOe={[-5]:rT,[-4]:rT,[-3]:rT,33:lV,38:dD,42:JC,60:[J4,sV],91:cV,92:[nV,uD],93:$y,95:JC,96:eV},rOe={null:[JC,Vse]},nOe={null:[42,95]},oOe={null:[]};function dV(t){let r=Pse([uV,...(t||{}).extensions||[]]),n={defined:[],lazy:{},constructs:r,content:o(Mse),document:o(Lse),flow:o(Nse),string:o(zse),text:o(Use)};return n;function o(i){return a;function a(s){return Hse(n,i,s)}}}function mV(t){for(;!fD(t););return t}var qse=/[\0\t\n\r]/g;function pV(){let t=1,e="",r=!0,n;return o;function o(i,a,s){let l=[],c,u,d,m,p;for(i=e+(typeof i=="string"?i.toString():new TextDecoder(a||void 0).decode(i)),d=0,e="",r&&(i.charCodeAt(0)===65279&&d++,r=void 0);d<i.length;){if(qse.lastIndex=d,c=qse.exec(i),m=c&&c.index!==void 0?c.index:i.length,p=i.charCodeAt(m),!c){e=i.slice(d);break}if(p===10&&d===m&&n)l.push(-3),n=void 0;else switch(n&&(l.push(-5),n=void 0),d<m&&(l.push(i.slice(d,m)),t+=m-d),p){case 0:{l.push(65533),t++;break}case 9:{for(u=Math.ceil(t/4)*4,l.push(-2);t++<u;)l.push(-1);break}case 10:{l.push(-4),t=1;break}default:n=!0,t=1}d=m+1}return s&&(n&&l.push(-5),e&&l.push(e),l.push(null)),l}}var iOe=/\\([!-/:-@[-`{-~])|&(#(?:\d{1,7}|x[\da-f]{1,6})|[\da-z]{1,31});/gi;function Wse(t){return t.replace(iOe,aOe)}function aOe(t,e,r){if(e)return e;if(r.charCodeAt(0)===35){let o=r.charCodeAt(1),i=o===120||o===88;return lD(r.slice(i?2:1),i?16:10)}return Cx(r)||t}var Yse={}.hasOwnProperty;function fV(t,e,r){return typeof e!="string"&&(r=e,e=void 0),sOe(r)(mV(dV(r).document().write(pV()(t,e,!0))))}function sOe(t){let e={transforms:[],canContainEols:["emphasis","fragment","heading","paragraph","strong"],enter:{autolink:i(Le),autolinkProtocol:A,autolinkEmail:A,atxHeading:i(Nr),blockQuote:i(be),characterEscape:A,characterReference:A,codeFenced:i(_e),codeFencedFenceInfo:a,codeFencedFenceMeta:a,codeIndented:i(_e,a),codeText:i(je,a),codeTextData:A,data:A,codeFlowValue:A,definition:i(gt),definitionDestinationString:a,definitionLabelString:a,definitionTitleString:a,emphasis:i(fr),hardBreakEscape:i(Zt),hardBreakTrailing:i(Zt),htmlFlow:i(oe,a),htmlFlowData:A,htmlText:i(oe,a),htmlTextData:A,image:i(De),label:a,link:i(Le),listItem:i(Ue),listItemValue:m,listOrdered:i(Qe,d),listUnordered:i(Qe),paragraph:i(Ke),reference:O,referenceString:a,resourceDestinationString:a,resourceTitleString:a,setextHeading:i(Nr),strong:i(Ve),thematicBreak:i(yt)},exit:{atxHeading:l(),atxHeadingSequence:E,autolink:l(),autolinkEmail:Me,autolinkProtocol:se,blockQuote:l(),characterEscapeValue:I,characterReferenceMarkerHexadecimal:$,characterReferenceMarkerNumeric:$,characterReferenceValue:ae,characterReference:Z,codeFenced:l(b),codeFencedFence:f,codeFencedFenceInfo:p,codeFencedFenceMeta:h,codeFlowValue:I,codeIndented:l(v),codeText:l(F),codeTextData:I,data:I,definition:l(),definitionDestinationString:T,definitionLabelString:x,definitionTitleString:S,emphasis:l(),hardBreakEscape:l(M),hardBreakTrailing:l(M),htmlFlow:l(R),htmlFlowData:I,htmlText:l(B),htmlTextData:I,image:l(V),label:Q,labelText:H,lineEnding:k,link:l(G),listItem:l(),listOrdered:l(),listUnordered:l(),paragraph:l(),referenceString:J,resourceDestinationString:L,resourceTitleString:Y,resource:j,setextHeading:l(P),setextHeadingLineSequence:D,setextHeadingText:_,strong:l(),thematicBreak:l()}};Qse(e,(t||{}).mdastExtensions||[]);let r={};return n;function n(pe){let Ae={type:"root",children:[]},$e={stack:[Ae],tokenStack:[],config:e,enter:s,exit:c,buffer:a,resume:u,data:r},ft=[],Pt=-1;for(;++Pt<pe.length;)if(pe[Pt][1].type==="listOrdered"||pe[Pt][1].type==="listUnordered")if(pe[Pt][0]==="enter")ft.push(Pt);else{let yr=ft.pop();Pt=o(pe,yr,Pt)}for(Pt=-1;++Pt<pe.length;){let yr=e[pe[Pt][0]];Yse.call(yr,pe[Pt][1].type)&&yr[pe[Pt][1].type].call(Object.assign({sliceSerialize:pe[Pt][2].sliceSerialize},$e),pe[Pt][1])}if($e.tokenStack.length>0){let yr=$e.tokenStack[$e.tokenStack.length-1];(yr[1]||Xse).call($e,void 0,yr[0])}for(Ae.position={start:fg(pe.length>0?pe[0][1].start:{line:1,column:1,offset:0}),end:fg(pe.length>0?pe[pe.length-2][1].end:{line:1,column:1,offset:0})},Pt=-1;++Pt<e.transforms.length;)Ae=e.transforms[Pt](Ae)||Ae;return Ae}function o(pe,Ae,$e){let ft=Ae-1,Pt=-1,yr=!1,Ze,_r,qr,Ao;for(;++ft<=$e;){let Bn=pe[ft];switch(Bn[1].type){case"listUnordered":case"listOrdered":case"blockQuote":{Bn[0]==="enter"?Pt++:Pt--,Ao=void 0;break}case"lineEndingBlank":{Bn[0]==="enter"&&(Ze&&!Ao&&!Pt&&!qr&&(qr=ft),Ao=void 0);break}case"linePrefix":case"listItemValue":case"listItemMarker":case"listItemPrefix":case"listItemPrefixWhitespace":break;default:Ao=void 0}if(!Pt&&Bn[0]==="enter"&&Bn[1].type==="listItemPrefix"||Pt===-1&&Bn[0]==="exit"&&(Bn[1].type==="listUnordered"||Bn[1].type==="listOrdered")){if(Ze){let co=ft;for(_r=void 0;co--;){let bn=pe[co];if(bn[1].type==="lineEnding"||bn[1].type==="lineEndingBlank"){if(bn[0]==="exit")continue;_r&&(pe[_r][1].type="lineEndingBlank",yr=!0),bn[1].type="lineEnding",_r=co}else if(!(bn[1].type==="linePrefix"||bn[1].type==="blockQuotePrefix"||bn[1].type==="blockQuotePrefixWhitespace"||bn[1].type==="blockQuoteMarker"||bn[1].type==="listItemIndent"))break}qr&&(!_r||qr<_r)&&(Ze._spread=!0),Ze.end=Object.assign({},_r?pe[_r][1].start:Bn[1].end),pe.splice(_r||ft,0,["exit",Ze,Bn[2]]),ft++,$e++}if(Bn[1].type==="listItemPrefix"){let co={type:"listItem",_spread:!1,start:Object.assign({},Bn[1].start),end:void 0};Ze=co,pe.splice(ft,0,["enter",co,Bn[2]]),ft++,$e++,qr=void 0,Ao=!0}}}return pe[Ae][1]._spread=yr,$e}function i(pe,Ae){return $e;function $e(ft){s.call(this,pe(ft),ft),Ae&&Ae.call(this,ft)}}function a(){this.stack.push({type:"fragment",children:[]})}function s(pe,Ae,$e){this.stack[this.stack.length-1].children.push(pe),this.stack.push(pe),this.tokenStack.push([Ae,$e]),pe.position={start:fg(Ae.start),end:void 0}}function l(pe){return Ae;function Ae($e){pe&&pe.call(this,$e),c.call(this,$e)}}function c(pe,Ae){let $e=this.stack.pop(),ft=this.tokenStack.pop();if(ft)ft[0].type!==pe.type&&(Ae?Ae.call(this,pe,ft[0]):(ft[1]||Xse).call(this,pe,ft[0]));else throw new Error("Cannot close `"+pe.type+"` ("+dg({start:pe.start,end:pe.end})+"): it\u2019s not open");$e.position.end=fg(pe.end)}function u(){return $4(this.stack.pop())}function d(){this.data.expectingFirstListItemValue=!0}function m(pe){if(this.data.expectingFirstListItemValue){let Ae=this.stack[this.stack.length-2];Ae.start=Number.parseInt(this.sliceSerialize(pe),10),this.data.expectingFirstListItemValue=void 0}}function p(){let pe=this.resume(),Ae=this.stack[this.stack.length-1];Ae.lang=pe}function h(){let pe=this.resume(),Ae=this.stack[this.stack.length-1];Ae.meta=pe}function f(){this.data.flowCodeInside||(this.buffer(),this.data.flowCodeInside=!0)}function b(){let pe=this.resume(),Ae=this.stack[this.stack.length-1];Ae.value=pe.replace(/^(\r?\n|\r)|(\r?\n|\r)$/g,""),this.data.flowCodeInside=void 0}function v(){let pe=this.resume(),Ae=this.stack[this.stack.length-1];Ae.value=pe.replace(/(\r?\n|\r)$/g,"")}function x(pe){let Ae=this.resume(),$e=this.stack[this.stack.length-1];$e.label=Ae,$e.identifier=Zp(this.sliceSerialize(pe)).toLowerCase()}function S(){let pe=this.resume(),Ae=this.stack[this.stack.length-1];Ae.title=pe}function T(){let pe=this.resume(),Ae=this.stack[this.stack.length-1];Ae.url=pe}function E(pe){let Ae=this.stack[this.stack.length-1];if(!Ae.depth){let $e=this.sliceSerialize(pe).length;Ae.depth=$e}}function _(){this.data.setextHeadingSlurpLineEnding=!0}function D(pe){let Ae=this.stack[this.stack.length-1];Ae.depth=this.sliceSerialize(pe).codePointAt(0)===61?1:2}function P(){this.data.setextHeadingSlurpLineEnding=void 0}function A(pe){let $e=this.stack[this.stack.length-1].children,ft=$e[$e.length-1];(!ft||ft.type!=="text")&&(ft=It(),ft.position={start:fg(pe.start),end:void 0},$e.push(ft)),this.stack.push(ft)}function I(pe){let Ae=this.stack.pop();Ae.value+=this.sliceSerialize(pe),Ae.position.end=fg(pe.end)}function k(pe){let Ae=this.stack[this.stack.length-1];if(this.data.atHardBreak){let $e=Ae.children[Ae.children.length-1];$e.position.end=fg(pe.end),this.data.atHardBreak=void 0;return}!this.data.setextHeadingSlurpLineEnding&&e.canContainEols.includes(Ae.type)&&(A.call(this,pe),I.call(this,pe))}function M(){this.data.atHardBreak=!0}function R(){let pe=this.resume(),Ae=this.stack[this.stack.length-1];Ae.value=pe}function B(){let pe=this.resume(),Ae=this.stack[this.stack.length-1];Ae.value=pe}function F(){let pe=this.resume(),Ae=this.stack[this.stack.length-1];Ae.value=pe}function G(){let pe=this.stack[this.stack.length-1];if(this.data.inReference){let Ae=this.data.referenceType||"shortcut";pe.type+="Reference",pe.referenceType=Ae,delete pe.url,delete pe.title}else delete pe.identifier,delete pe.label;this.data.referenceType=void 0}function V(){let pe=this.stack[this.stack.length-1];if(this.data.inReference){let Ae=this.data.referenceType||"shortcut";pe.type+="Reference",pe.referenceType=Ae,delete pe.url,delete pe.title}else delete pe.identifier,delete pe.label;this.data.referenceType=void 0}function H(pe){let Ae=this.sliceSerialize(pe),$e=this.stack[this.stack.length-2];$e.label=Wse(Ae),$e.identifier=Zp(Ae).toLowerCase()}function Q(){let pe=this.stack[this.stack.length-1],Ae=this.resume(),$e=this.stack[this.stack.length-1];if(this.data.inReference=!0,$e.type==="link"){let ft=pe.children;$e.children=ft}else $e.alt=Ae}function L(){let pe=this.resume(),Ae=this.stack[this.stack.length-1];Ae.url=pe}function Y(){let pe=this.resume(),Ae=this.stack[this.stack.length-1];Ae.title=pe}function j(){this.data.inReference=void 0}function O(){this.data.referenceType="collapsed"}function J(pe){let Ae=this.resume(),$e=this.stack[this.stack.length-1];$e.label=Ae,$e.identifier=Zp(this.sliceSerialize(pe)).toLowerCase(),this.data.referenceType="full"}function $(pe){this.data.characterReferenceType=pe.type}function ae(pe){let Ae=this.sliceSerialize(pe),$e=this.data.characterReferenceType,ft;$e?(ft=lD(Ae,$e==="characterReferenceMarkerNumeric"?10:16),this.data.characterReferenceType=void 0):ft=Cx(Ae);let Pt=this.stack[this.stack.length-1];Pt.value+=ft}function Z(pe){let Ae=this.stack.pop();Ae.position.end=fg(pe.end)}function se(pe){I.call(this,pe);let Ae=this.stack[this.stack.length-1];Ae.url=this.sliceSerialize(pe)}function Me(pe){I.call(this,pe);let Ae=this.stack[this.stack.length-1];Ae.url="mailto:"+this.sliceSerialize(pe)}function be(){return{type:"blockquote",children:[]}}function _e(){return{type:"code",lang:null,meta:null,value:""}}function je(){return{type:"inlineCode",value:""}}function gt(){return{type:"definition",identifier:"",label:null,title:null,url:""}}function fr(){return{type:"emphasis",children:[]}}function Nr(){return{type:"heading",depth:0,children:[]}}function Zt(){return{type:"break"}}function oe(){return{type:"html",value:""}}function De(){return{type:"image",title:null,url:"",alt:null}}function Le(){return{type:"link",title:null,url:"",children:[]}}function Qe(pe){return{type:"list",ordered:pe.type==="listOrdered",start:null,spread:pe._spread,children:[]}}function Ue(pe){return{type:"listItem",spread:pe._spread,checked:null,children:[]}}function Ke(){return{type:"paragraph",children:[]}}function Ve(){return{type:"strong",children:[]}}function It(){return{type:"text",value:""}}function yt(){return{type:"thematicBreak"}}}function fg(t){return{line:t.line,column:t.column,offset:t.offset}}function Qse(t,e){let r=-1;for(;++r<e.length;){let n=e[r];Array.isArray(n)?Qse(t,n):lOe(t,n)}}function lOe(t,e){let r;for(r in e)if(Yse.call(e,r))switch(r){case"canContainEols":{let n=e[r];n&&t[r].push(...n);break}case"transforms":{let n=e[r];n&&t[r].push(...n);break}case"enter":case"exit":{let n=e[r];n&&Object.assign(t[r],n);break}}}function Xse(t,e){throw t?new Error("Cannot close `"+t.type+"` ("+dg({start:t.start,end:t.end})+"): a different token (`"+e.type+"`, "+dg({start:e.start,end:e.end})+") is open"):new Error("Cannot close document, a token (`"+e.type+"`, "+dg({start:e.start,end:e.end})+") is still open")}function bD(t){let e=this;e.parser=r;function r(n){return fV(n,U(w(w({},e.data("settings")),t),{extensions:e.data("micromarkExtensions")||[],mdastExtensions:e.data("fromMarkdownExtensions")||[]}))}}function Kse(t,e){let r={type:"element",tagName:"blockquote",properties:{},children:t.wrap(t.all(e),!0)};return t.patch(e,r),t.applyData(e,r)}function $se(t,e){let r={type:"element",tagName:"br",properties:{},children:[]};return t.patch(e,r),[t.applyData(e,r),{type:"text",value:`
`}]}function Zse(t,e){let r=e.value?e.value+`
`:"",n={};e.lang&&(n.className=["language-"+e.lang]);let o={type:"element",tagName:"code",properties:n,children:[{type:"text",value:r}]};return e.meta&&(o.data={meta:e.meta}),t.patch(e,o),o=t.applyData(e,o),o={type:"element",tagName:"pre",properties:{},children:[o]},t.patch(e,o),o}function Jse(t,e){let r={type:"element",tagName:"del",properties:{},children:t.all(e)};return t.patch(e,r),t.applyData(e,r)}function ele(t,e){let r={type:"element",tagName:"em",properties:{},children:t.all(e)};return t.patch(e,r),t.applyData(e,r)}function tle(t,e){let r=typeof t.options.clobberPrefix=="string"?t.options.clobberPrefix:"user-content-",n=String(e.identifier).toUpperCase(),o=td(n.toLowerCase()),i=t.footnoteOrder.indexOf(n),a,s=t.footnoteCounts.get(n);s===void 0?(s=0,t.footnoteOrder.push(n),a=t.footnoteOrder.length):a=i+1,s+=1,t.footnoteCounts.set(n,s);let l={type:"element",tagName:"a",properties:{href:"#"+r+"fn-"+o,id:r+"fnref-"+o+(s>1?"-"+s:""),dataFootnoteRef:!0,ariaDescribedBy:["footnote-label"]},children:[{type:"text",value:String(a)}]};t.patch(e,l);let c={type:"element",tagName:"sup",properties:{},children:[l]};return t.patch(e,c),t.applyData(e,c)}function rle(t,e){let r={type:"element",tagName:"h"+e.depth,properties:{},children:t.all(e)};return t.patch(e,r),t.applyData(e,r)}function nle(t,e){if(t.options.allowDangerousHtml){let r={type:"raw",value:e.value};return t.patch(e,r),t.applyData(e,r)}}function xD(t,e){let r=e.referenceType,n="]";if(r==="collapsed"?n+="[]":r==="full"&&(n+="["+(e.label||e.identifier)+"]"),e.type==="imageReference")return[{type:"text",value:"!["+e.alt+n}];let o=t.all(e),i=o[0];i&&i.type==="text"?i.value="["+i.value:o.unshift({type:"text",value:"["});let a=o[o.length-1];return a&&a.type==="text"?a.value+=n:o.push({type:"text",value:n}),o}function ole(t,e){let r=String(e.identifier).toUpperCase(),n=t.definitionById.get(r);if(!n)return xD(t,e);let o={src:td(n.url||""),alt:e.alt};n.title!==null&&n.title!==void 0&&(o.title=n.title);let i={type:"element",tagName:"img",properties:o,children:[]};return t.patch(e,i),t.applyData(e,i)}function ile(t,e){let r={src:td(e.url)};e.alt!==null&&e.alt!==void 0&&(r.alt=e.alt),e.title!==null&&e.title!==void 0&&(r.title=e.title);let n={type:"element",tagName:"img",properties:r,children:[]};return t.patch(e,n),t.applyData(e,n)}function ale(t,e){let r={type:"text",value:e.value.replace(/\r?\n|\r/g," ")};t.patch(e,r);let n={type:"element",tagName:"code",properties:{},children:[r]};return t.patch(e,n),t.applyData(e,n)}function sle(t,e){let r=String(e.identifier).toUpperCase(),n=t.definitionById.get(r);if(!n)return xD(t,e);let o={href:td(n.url||"")};n.title!==null&&n.title!==void 0&&(o.title=n.title);let i={type:"element",tagName:"a",properties:o,children:t.all(e)};return t.patch(e,i),t.applyData(e,i)}function lle(t,e){let r={href:td(e.url)};e.title!==null&&e.title!==void 0&&(r.title=e.title);let n={type:"element",tagName:"a",properties:r,children:t.all(e)};return t.patch(e,n),t.applyData(e,n)}function cle(t,e,r){let n=t.all(e),o=r?cOe(r):ule(e),i={},a=[];if(typeof e.checked=="boolean"){let u=n[0],d;u&&u.type==="element"&&u.tagName==="p"?d=u:(d={type:"element",tagName:"p",properties:{},children:[]},n.unshift(d)),d.children.length>0&&d.children.unshift({type:"text",value:" "}),d.children.unshift({type:"element",tagName:"input",properties:{type:"checkbox",checked:e.checked,disabled:!0},children:[]}),i.className=["task-list-item"]}let s=-1;for(;++s<n.length;){let u=n[s];(o||s!==0||u.type!=="element"||u.tagName!=="p")&&a.push({type:"text",value:`
`}),u.type==="element"&&u.tagName==="p"&&!o?a.push(...u.children):a.push(u)}let l=n[n.length-1];l&&(o||l.type!=="element"||l.tagName!=="p")&&a.push({type:"text",value:`
`});let c={type:"element",tagName:"li",properties:i,children:a};return t.patch(e,c),t.applyData(e,c)}function cOe(t){let e=!1;if(t.type==="list"){e=t.spread||!1;let r=t.children,n=-1;for(;!e&&++n<r.length;)e=ule(r[n])}return e}function ule(t){let e=t.spread;return e??t.children.length>1}function dle(t,e){let r={},n=t.all(e),o=-1;for(typeof e.start=="number"&&e.start!==1&&(r.start=e.start);++o<n.length;){let a=n[o];if(a.type==="element"&&a.tagName==="li"&&a.properties&&Array.isArray(a.properties.className)&&a.properties.className.includes("task-list-item")){r.className=["contains-task-list"];break}}let i={type:"element",tagName:e.ordered?"ol":"ul",properties:r,children:t.wrap(n,!0)};return t.patch(e,i),t.applyData(e,i)}function mle(t,e){let r={type:"element",tagName:"p",properties:{},children:t.all(e)};return t.patch(e,r),t.applyData(e,r)}function ple(t,e){let r={type:"root",children:t.wrap(t.all(e))};return t.patch(e,r),t.applyData(e,r)}function fle(t,e){let r={type:"element",tagName:"strong",properties:{},children:t.all(e)};return t.patch(e,r),t.applyData(e,r)}function hle(t,e){let r=t.all(e),n=r.shift(),o=[];if(n){let a={type:"element",tagName:"thead",properties:{},children:t.wrap([n],!0)};t.patch(e.children[0],a),o.push(a)}if(r.length>0){let a={type:"element",tagName:"tbody",properties:{},children:t.wrap(r,!0)},s=Sx(e.children[1]),l=sD(e.children[e.children.length-1]);s&&l&&(a.position={start:s,end:l}),o.push(a)}let i={type:"element",tagName:"table",properties:{},children:t.wrap(o,!0)};return t.patch(e,i),t.applyData(e,i)}function gle(t,e,r){let n=r?r.children:void 0,i=(n?n.indexOf(e):1)===0?"th":"td",a=r&&r.type==="table"?r.align:void 0,s=a?a.length:e.children.length,l=-1,c=[];for(;++l<s;){let d=e.children[l],m={},p=a?a[l]:void 0;p&&(m.align=p);let h={type:"element",tagName:i,properties:m,children:[]};d&&(h.children=t.all(d),t.patch(d,h),h=t.applyData(d,h)),c.push(h)}let u={type:"element",tagName:"tr",properties:{},children:t.wrap(c,!0)};return t.patch(e,u),t.applyData(e,u)}function yle(t,e){let r={type:"element",tagName:"td",properties:{},children:t.all(e)};return t.patch(e,r),t.applyData(e,r)}function ble(t){let e=String(t),r=/\r?\n|\r/g,n=r.exec(e),o=0,i=[];for(;n;)i.push(vle(e.slice(o,n.index),o>0,!0),n[0]),o=n.index+n[0].length,n=r.exec(e);return i.push(vle(e.slice(o),o>0,!1)),i.join("")}function vle(t,e,r){let n=0,o=t.length;if(e){let i=t.codePointAt(n);for(;i===9||i===32;)n++,i=t.codePointAt(n)}if(r){let i=t.codePointAt(o-1);for(;i===9||i===32;)o--,i=t.codePointAt(o-1)}return o>n?t.slice(n,o):""}function xle(t,e){let r={type:"text",value:ble(String(e.value))};return t.patch(e,r),t.applyData(e,r)}function Sle(t,e){let r={type:"element",tagName:"hr",properties:{},children:[]};return t.patch(e,r),t.applyData(e,r)}var Cle={blockquote:Kse,break:$se,code:Zse,delete:Jse,emphasis:ele,footnoteReference:tle,heading:rle,html:nle,imageReference:ole,image:ile,inlineCode:ale,linkReference:sle,link:lle,listItem:cle,list:dle,paragraph:mle,root:ple,strong:fle,table:hle,tableCell:yle,tableRow:gle,text:xle,thematicBreak:Sle,toml:SD,yaml:SD,definition:SD,footnoteDefinition:SD};function SD(){}var Tle=typeof self=="object"?self:globalThis,uOe=(t,e)=>{let r=(o,i)=>(t.set(i,o),o),n=o=>{if(t.has(o))return t.get(o);let[i,a]=e[o];switch(i){case 0:case-1:return r(a,o);case 1:{let s=r([],o);for(let l of a)s.push(n(l));return s}case 2:{let s=r({},o);for(let[l,c]of a)s[n(l)]=n(c);return s}case 3:return r(new Date(a),o);case 4:{let{source:s,flags:l}=a;return r(new RegExp(s,l),o)}case 5:{let s=r(new Map,o);for(let[l,c]of a)s.set(n(l),n(c));return s}case 6:{let s=r(new Set,o);for(let l of a)s.add(n(l));return s}case 7:{let{name:s,message:l}=a;return r(new Tle[s](l),o)}case 8:return r(BigInt(a),o);case"BigInt":return r(Object(BigInt(a)),o)}return r(new Tle[i](a),o)};return n},vV=t=>uOe(new Map,t)(0);var wx="",{toString:dOe}={},{keys:mOe}=Object,aT=t=>{let e=typeof t;if(e!=="object"||!t)return[0,e];let r=dOe.call(t).slice(8,-1);switch(r){case"Array":return[1,wx];case"Object":return[2,wx];case"Date":return[3,wx];case"RegExp":return[4,wx];case"Map":return[5,wx];case"Set":return[6,wx]}return r.includes("Array")?[1,r]:r.includes("Error")?[7,r]:[2,r]},PD=([t,e])=>t===0&&(e==="function"||e==="symbol"),pOe=(t,e,r,n)=>{let o=(a,s)=>{let l=n.push(a)-1;return r.set(s,l),l},i=a=>{if(r.has(a))return r.get(a);let[s,l]=aT(a);switch(s){case 0:{let u=a;switch(l){case"bigint":s=8,u=a.toString();break;case"function":case"symbol":if(t)throw new TypeError("unable to serialize "+l);u=null;break;case"undefined":return o([-1],a)}return o([s,u],a)}case 1:{if(l)return o([l,[...a]],a);let u=[],d=o([s,u],a);for(let m of a)u.push(i(m));return d}case 2:{if(l)switch(l){case"BigInt":return o([l,a.toString()],a);case"Boolean":case"Number":case"String":return o([l,a.valueOf()],a)}if(e&&"toJSON"in a)return i(a.toJSON());let u=[],d=o([s,u],a);for(let m of mOe(a))(t||!PD(aT(a[m])))&&u.push([i(m),i(a[m])]);return d}case 3:return o([s,a.toISOString()],a);case 4:{let{source:u,flags:d}=a;return o([s,{source:u,flags:d}],a)}case 5:{let u=[],d=o([s,u],a);for(let[m,p]of a)(t||!(PD(aT(m))||PD(aT(p))))&&u.push([i(m),i(p)]);return d}case 6:{let u=[],d=o([s,u],a);for(let m of a)(t||!PD(aT(m)))&&u.push(i(m));return d}}let{message:c}=a;return o([s,{name:l,message:c}],a)};return i},bV=(t,{json:e,lossy:r}={})=>{let n=[];return pOe(!(e||r),!!e,new Map,n)(t),n};var _x=typeof structuredClone=="function"?(t,e)=>e&&("json"in e||"lossy"in e)?vV(bV(t,e)):structuredClone(t):(t,e)=>vV(bV(t,e));function fOe(t,e){let r=[{type:"text",value:"\u21A9"}];return e>1&&r.push({type:"element",tagName:"sup",properties:{},children:[{type:"text",value:String(e)}]}),r}function hOe(t,e){return"Back to reference "+(t+1)+(e>1?"-"+e:"")}function wle(t){let e=typeof t.options.clobberPrefix=="string"?t.options.clobberPrefix:"user-content-",r=t.options.footnoteBackContent||fOe,n=t.options.footnoteBackLabel||hOe,o=t.options.footnoteLabel||"Footnotes",i=t.options.footnoteLabelTagName||"h2",a=t.options.footnoteLabelProperties||{className:["sr-only"]},s=[],l=-1;for(;++l<t.footnoteOrder.length;){let c=t.footnoteById.get(t.footnoteOrder[l]);if(!c)continue;let u=t.all(c),d=String(c.identifier).toUpperCase(),m=td(d.toLowerCase()),p=0,h=[],f=t.footnoteCounts.get(d);for(;f!==void 0&&++p<=f;){h.length>0&&h.push({type:"text",value:" "});let x=typeof r=="string"?r:r(l,p);typeof x=="string"&&(x={type:"text",value:x}),h.push({type:"element",tagName:"a",properties:{href:"#"+e+"fnref-"+m+(p>1?"-"+p:""),dataFootnoteBackref:"",ariaLabel:typeof n=="string"?n:n(l,p),className:["data-footnote-backref"]},children:Array.isArray(x)?x:[x]})}let b=u[u.length-1];if(b&&b.type==="element"&&b.tagName==="p"){let x=b.children[b.children.length-1];x&&x.type==="text"?x.value+=" ":b.children.push({type:"text",value:" "}),b.children.push(...h)}else u.push(...h);let v={type:"element",tagName:"li",properties:{id:e+"fn-"+m},children:t.wrap(u,!0)};t.patch(c,v),s.push(v)}if(s.length!==0)return{type:"element",tagName:"section",properties:{dataFootnotes:!0,className:["footnotes"]},children:[{type:"element",tagName:i,properties:U(w({},_x(a)),{id:"footnote-label"}),children:[{type:"text",value:o}]},{type:"text",value:`
`},{type:"element",tagName:"ol",properties:{},children:t.wrap(s,!0)},{type:"text",value:`
`}]}}var ED=function(t){if(t==null)return bOe;if(typeof t=="function")return ID(t);if(typeof t=="object")return Array.isArray(t)?gOe(t):yOe(t);if(typeof t=="string")return vOe(t);throw new Error("Expected function, string, or object as test")};function gOe(t){let e=[],r=-1;for(;++r<t.length;)e[r]=ED(t[r]);return ID(n);function n(...o){let i=-1;for(;++i<e.length;)if(e[i].apply(this,o))return!0;return!1}}function yOe(t){let e=t;return ID(r);function r(n){let o=n,i;for(i in t)if(o[i]!==e[i])return!1;return!0}}function vOe(t){return ID(e);function e(r){return r&&r.type===t}}function ID(t){return e;function e(r,n,o){return!!(xOe(r)&&t.call(this,r,typeof n=="number"?n:void 0,o||void 0))}}function bOe(){return!0}function xOe(t){return t!==null&&typeof t=="object"&&"type"in t}var _le=[],xV=!0,DD=!1,SV="skip";function CV(t,e,r,n){let o;typeof e=="function"&&typeof r!="function"?(n=r,r=e):o=e;let i=ED(o),a=n?-1:1;s(t,void 0,[])();function s(l,c,u){let d=l&&typeof l=="object"?l:{};if(typeof d.type=="string"){let p=typeof d.tagName=="string"?d.tagName:typeof d.name=="string"?d.name:void 0;Object.defineProperty(m,"name",{value:"node ("+(l.type+(p?"<"+p+">":""))+")"})}return m;function m(){let p=_le,h,f,b;if((!e||i(l,c,u[u.length-1]||void 0))&&(p=SOe(r(l,u)),p[0]===DD))return p;if("children"in l&&l.children){let v=l;if(v.children&&p[0]!==SV)for(f=(n?v.children.length:-1)+a,b=u.concat(v);f>-1&&f<v.children.length;){let x=v.children[f];if(h=s(x,f,b)(),h[0]===DD)return h;f=typeof h[1]=="number"?h[1]:f+a}}return p}}}function SOe(t){return Array.isArray(t)?t:typeof t=="number"?[xV,t]:t==null?_le:[t]}function sT(t,e,r,n){let o,i,a;typeof e=="function"&&typeof r!="function"?(i=void 0,a=e,o=r):(i=e,a=r,o=n),CV(t,i,s,o);function s(l,c){let u=c[c.length-1],d=u?u.children.indexOf(l):void 0;return a(l,d,u)}}var TV={}.hasOwnProperty,COe={};function Ele(t,e){let r=e||COe,n=new Map,o=new Map,i=new Map,a=w(w({},Cle),r.handlers),s={all:c,applyData:wOe,definitionById:n,footnoteById:o,footnoteCounts:i,footnoteOrder:[],handlers:a,one:l,options:r,patch:TOe,wrap:POe};return sT(t,function(u){if(u.type==="definition"||u.type==="footnoteDefinition"){let d=u.type==="definition"?n:o,m=String(u.identifier).toUpperCase();d.has(m)||d.set(m,u)}}),s;function l(u,d){let m=u.type,p=s.handlers[m];if(TV.call(s.handlers,m)&&p)return p(s,u,d);if(s.options.passThrough&&s.options.passThrough.includes(m)){if("children"in u){let f=u,{children:b}=f,v=fz(f,["children"]),x=_x(v);return x.children=s.all(u),x}return _x(u)}return(s.options.unknownHandler||_Oe)(s,u,d)}function c(u){let d=[];if("children"in u){let m=u.children,p=-1;for(;++p<m.length;){let h=s.one(m[p],u);if(h){if(p&&m[p-1].type==="break"&&(!Array.isArray(h)&&h.type==="text"&&(h.value=Ple(h.value)),!Array.isArray(h)&&h.type==="element")){let f=h.children[0];f&&f.type==="text"&&(f.value=Ple(f.value))}Array.isArray(h)?d.push(...h):d.push(h)}}}return d}}function TOe(t,e){t.position&&(e.position=q4(t))}function wOe(t,e){let r=e;if(t&&t.data){let n=t.data.hName,o=t.data.hChildren,i=t.data.hProperties;if(typeof n=="string")if(r.type==="element")r.tagName=n;else{let a="children"in r?r.children:[r];r={type:"element",tagName:n,properties:{},children:a}}r.type==="element"&&i&&Object.assign(r.properties,_x(i)),"children"in r&&r.children&&o!==null&&o!==void 0&&(r.children=o)}return r}function _Oe(t,e){let r=e.data||{},n="value"in e&&!(TV.call(r,"hProperties")||TV.call(r,"hChildren"))?{type:"text",value:e.value}:{type:"element",tagName:"div",properties:{},children:t.all(e)};return t.patch(e,n),t.applyData(e,n)}function POe(t,e){let r=[],n=-1;for(e&&r.push({type:"text",value:`
`});++n<t.length;)n&&r.push({type:"text",value:`
`}),r.push(t[n]);return e&&t.length>0&&r.push({type:"text",value:`
`}),r}function Ple(t){let e=0,r=t.charCodeAt(e);for(;r===9||r===32;)e++,r=t.charCodeAt(e);return t.slice(e)}function AD(t,e){let r=Ele(t,e),n=r.one(t,void 0),o=wle(r),i=Array.isArray(n)?{type:"root",children:n}:n||{type:"root",children:[]};return o&&("children"in i,i.children.push({type:"text",value:`
`},o)),i}function kD(t,e){return t&&"run"in t?function(r,n){return N(this,null,function*(){let o=AD(r,w({file:n},e));yield t.run(o,n)})}:function(r,n){return AD(r,w({file:n},e||t))}}function wV(t){if(t)throw t}var LD=Ot(Ole(),1);function lT(t){if(typeof t!="object"||t===null)return!1;let e=Object.getPrototypeOf(t);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in t)&&!(Symbol.iterator in t)}function _V(){let t=[],e={run:r,use:n};return e;function r(...o){let i=-1,a=o.pop();if(typeof a!="function")throw new TypeError("Expected function as last argument, not "+a);s(null,...o);function s(l,...c){let u=t[++i],d=-1;if(l){a(l);return}for(;++d<o.length;)(c[d]===null||c[d]===void 0)&&(c[d]=o[d]);o=c,u?Fle(u,s)(...c):a(null,...c)}}function n(o){if(typeof o!="function")throw new TypeError("Expected `middelware` to be a function, not "+o);return t.push(o),e}}function Fle(t,e){let r;return n;function n(...a){let s=t.length>a.length,l;s&&a.push(o);try{l=t.apply(this,a)}catch(c){let u=c;if(s&&r)throw u;return o(u)}s||(l&&l.then&&typeof l.then=="function"?l.then(i,o):l instanceof Error?o(l):i(l))}function o(a,...s){r||(r=!0,e(a,...s))}function i(a){o(null,a)}}var Kd={basename:EOe,dirname:IOe,extname:DOe,join:AOe,sep:"/"};function EOe(t,e){if(e!==void 0&&typeof e!="string")throw new TypeError('"ext" argument must be a string');cT(t);let r=0,n=-1,o=t.length,i;if(e===void 0||e.length===0||e.length>t.length){for(;o--;)if(t.codePointAt(o)===47){if(i){r=o+1;break}}else n<0&&(i=!0,n=o+1);return n<0?"":t.slice(r,n)}if(e===t)return"";let a=-1,s=e.length-1;for(;o--;)if(t.codePointAt(o)===47){if(i){r=o+1;break}}else a<0&&(i=!0,a=o+1),s>-1&&(t.codePointAt(o)===e.codePointAt(s--)?s<0&&(n=o):(s=-1,n=a));return r===n?n=a:n<0&&(n=t.length),t.slice(r,n)}function IOe(t){if(cT(t),t.length===0)return".";let e=-1,r=t.length,n;for(;--r;)if(t.codePointAt(r)===47){if(n){e=r;break}}else n||(n=!0);return e<0?t.codePointAt(0)===47?"/":".":e===1&&t.codePointAt(0)===47?"//":t.slice(0,e)}function DOe(t){cT(t);let e=t.length,r=-1,n=0,o=-1,i=0,a;for(;e--;){let s=t.codePointAt(e);if(s===47){if(a){n=e+1;break}continue}r<0&&(a=!0,r=e+1),s===46?o<0?o=e:i!==1&&(i=1):o>-1&&(i=-1)}return o<0||r<0||i===0||i===1&&o===r-1&&o===n+1?"":t.slice(o,r)}function AOe(...t){let e=-1,r;for(;++e<t.length;)cT(t[e]),t[e]&&(r=r===void 0?t[e]:r+"/"+t[e]);return r===void 0?".":kOe(r)}function kOe(t){cT(t);let e=t.codePointAt(0)===47,r=MOe(t,!e);return r.length===0&&!e&&(r="."),r.length>0&&t.codePointAt(t.length-1)===47&&(r+="/"),e?"/"+r:r}function MOe(t,e){let r="",n=0,o=-1,i=0,a=-1,s,l;for(;++a<=t.length;){if(a<t.length)s=t.codePointAt(a);else{if(s===47)break;s=47}if(s===47){if(!(o===a-1||i===1))if(o!==a-1&&i===2){if(r.length<2||n!==2||r.codePointAt(r.length-1)!==46||r.codePointAt(r.length-2)!==46){if(r.length>2){if(l=r.lastIndexOf("/"),l!==r.length-1){l<0?(r="",n=0):(r=r.slice(0,l),n=r.length-1-r.lastIndexOf("/")),o=a,i=0;continue}}else if(r.length>0){r="",n=0,o=a,i=0;continue}}e&&(r=r.length>0?r+"/..":"..",n=2)}else r.length>0?r+="/"+t.slice(o+1,a):r=t.slice(o+1,a),n=a-o-1;o=a,i=0}else s===46&&i>-1?i++:i=-1}return r}function cT(t){if(typeof t!="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(t))}var Nle={cwd:ROe};function ROe(){return"/"}function Px(t){return!!(t!==null&&typeof t=="object"&&"href"in t&&t.href&&"protocol"in t&&t.protocol&&t.auth===void 0)}function Vle(t){if(typeof t=="string")t=new URL(t);else if(!Px(t)){let e=new TypeError('The "path" argument must be of type string or an instance of URL. Received `'+t+"`");throw e.code="ERR_INVALID_ARG_TYPE",e}if(t.protocol!=="file:"){let e=new TypeError("The URL must be of scheme file");throw e.code="ERR_INVALID_URL_SCHEME",e}return LOe(t)}function LOe(t){if(t.hostname!==""){let n=new TypeError('File URL host must be "localhost" or empty on darwin');throw n.code="ERR_INVALID_FILE_URL_HOST",n}let e=t.pathname,r=-1;for(;++r<e.length;)if(e.codePointAt(r)===37&&e.codePointAt(r+1)===50){let n=e.codePointAt(r+2);if(n===70||n===102){let o=new TypeError("File URL path must not include encoded / characters");throw o.code="ERR_INVALID_FILE_URL_PATH",o}}return decodeURIComponent(e)}var PV=["history","path","basename","stem","extname","dirname"],Jy=class{constructor(e){let r;e?Px(e)?r={path:e}:typeof e=="string"||BOe(e)?r={value:e}:r=e:r={},this.cwd=Nle.cwd(),this.data={},this.history=[],this.messages=[],this.value,this.map,this.result,this.stored;let n=-1;for(;++n<PV.length;){let i=PV[n];i in r&&r[i]!==void 0&&r[i]!==null&&(this[i]=i==="history"?[...r[i]]:r[i])}let o;for(o in r)PV.includes(o)||(this[o]=r[o])}get basename(){return typeof this.path=="string"?Kd.basename(this.path):void 0}set basename(e){IV(e,"basename"),EV(e,"basename"),this.path=Kd.join(this.dirname||"",e)}get dirname(){return typeof this.path=="string"?Kd.dirname(this.path):void 0}set dirname(e){zle(this.basename,"dirname"),this.path=Kd.join(e||"",this.basename)}get extname(){return typeof this.path=="string"?Kd.extname(this.path):void 0}set extname(e){if(EV(e,"extname"),zle(this.dirname,"extname"),e){if(e.codePointAt(0)!==46)throw new Error("`extname` must start with `.`");if(e.includes(".",1))throw new Error("`extname` cannot contain multiple dots")}this.path=Kd.join(this.dirname,this.stem+(e||""))}get path(){return this.history[this.history.length-1]}set path(e){Px(e)&&(e=Vle(e)),IV(e,"path"),this.path!==e&&this.history.push(e)}get stem(){return typeof this.path=="string"?Kd.basename(this.path,this.extname):void 0}set stem(e){IV(e,"stem"),EV(e,"stem"),this.path=Kd.join(this.dirname||"",e+(this.extname||""))}fail(e,r,n){let o=this.message(e,r,n);throw o.fatal=!0,o}info(e,r,n){let o=this.message(e,r,n);return o.fatal=void 0,o}message(e,r,n){let o=new Pi(e,r,n);return this.path&&(o.name=this.path+":"+o.name,o.file=this.path),o.fatal=!1,this.messages.push(o),o}toString(e){return this.value===void 0?"":typeof this.value=="string"?this.value:new TextDecoder(e||void 0).decode(this.value)}};function EV(t,e){if(t&&t.includes(Kd.sep))throw new Error("`"+e+"` cannot be a path: did not expect `"+Kd.sep+"`")}function IV(t,e){if(!t)throw new Error("`"+e+"` cannot be empty")}function zle(t,e){if(!t)throw new Error("Setting `"+e+"` requires `path` to be set too")}function BOe(t){return!!(t&&typeof t=="object"&&"byteLength"in t&&"byteOffset"in t)}var Ule=function(t){let n=this.constructor.prototype,o=n[t],i=function(){return o.apply(i,arguments)};Object.setPrototypeOf(i,n);let a=Object.getOwnPropertyNames(o);for(let s of a){let l=Object.getOwnPropertyDescriptor(o,s);l&&Object.defineProperty(i,s,l)}return i};var OOe={}.hasOwnProperty,MV=class t extends Ule{constructor(){super("copy"),this.Compiler=void 0,this.Parser=void 0,this.attachers=[],this.compiler=void 0,this.freezeIndex=-1,this.frozen=void 0,this.namespace={},this.parser=void 0,this.transformers=_V()}copy(){let e=new t,r=-1;for(;++r<this.attachers.length;){let n=this.attachers[r];e.use(...n)}return e.data((0,LD.default)(!0,{},this.namespace)),e}data(e,r){return typeof e=="string"?arguments.length===2?(kV("data",this.frozen),this.namespace[e]=r,this):OOe.call(this.namespace,e)&&this.namespace[e]||void 0:e?(kV("data",this.frozen),this.namespace=e,this):this.namespace}freeze(){if(this.frozen)return this;let e=this;for(;++this.freezeIndex<this.attachers.length;){let[r,...n]=this.attachers[this.freezeIndex];if(n[0]===!1)continue;n[0]===!0&&(n[0]=void 0);let o=r.call(e,...n);typeof o=="function"&&this.transformers.use(o)}return this.frozen=!0,this.freezeIndex=Number.POSITIVE_INFINITY,this}parse(e){this.freeze();let r=RD(e),n=this.parser||this.Parser;return DV("parse",n),n(String(r),r)}process(e,r){let n=this;return this.freeze(),DV("process",this.parser||this.Parser),AV("process",this.compiler||this.Compiler),r?o(void 0,r):new Promise(o);function o(i,a){let s=RD(e),l=n.parse(s);n.run(l,s,function(u,d,m){if(u||!d||!m)return c(u);let p=d,h=n.stringify(p,m);NOe(h)?m.value=h:m.result=h,c(u,m)});function c(u,d){u||!d?a(u):i?i(d):r(void 0,d)}}}processSync(e){let r=!1,n;return this.freeze(),DV("processSync",this.parser||this.Parser),AV("processSync",this.compiler||this.Compiler),this.process(e,o),jle("processSync","process",r),n;function o(i,a){r=!0,wV(i),n=a}}run(e,r,n){Gle(e),this.freeze();let o=this.transformers;return!n&&typeof r=="function"&&(n=r,r=void 0),n?i(void 0,n):new Promise(i);function i(a,s){let l=RD(r);o.run(e,l,c);function c(u,d,m){let p=d||e;u?s(u):a?a(p):n(void 0,p,m)}}}runSync(e,r){let n=!1,o;return this.run(e,r,i),jle("runSync","run",n),o;function i(a,s){wV(a),o=s,n=!0}}stringify(e,r){this.freeze();let n=RD(r),o=this.compiler||this.Compiler;return AV("stringify",o),Gle(e),o(e,n)}use(e,...r){let n=this.attachers,o=this.namespace;if(kV("use",this.frozen),e!=null)if(typeof e=="function")l(e,r);else if(typeof e=="object")Array.isArray(e)?s(e):a(e);else throw new TypeError("Expected usable value, not `"+e+"`");return this;function i(c){if(typeof c=="function")l(c,[]);else if(typeof c=="object")if(Array.isArray(c)){let[u,...d]=c;l(u,d)}else a(c);else throw new TypeError("Expected usable value, not `"+c+"`")}function a(c){if(!("plugins"in c)&&!("settings"in c))throw new Error("Expected usable value but received an empty preset, which is probably a mistake: presets typically come with `plugins` and sometimes with `settings`, but this has neither");s(c.plugins),c.settings&&(o.settings=(0,LD.default)(!0,o.settings,c.settings))}function s(c){let u=-1;if(c!=null)if(Array.isArray(c))for(;++u<c.length;){let d=c[u];i(d)}else throw new TypeError("Expected a list of plugins, not `"+c+"`")}function l(c,u){let d=-1,m=-1;for(;++d<n.length;)if(n[d][0]===c){m=d;break}if(m===-1)n.push([c,...u]);else if(u.length>0){let[p,...h]=u,f=n[m][1];lT(f)&&lT(p)&&(p=(0,LD.default)(!0,f,p)),n[m]=[c,p,...h]}}}},RV=new MV().freeze();function DV(t,e){if(typeof e!="function")throw new TypeError("Cannot `"+t+"` without `parser`")}function AV(t,e){if(typeof e!="function")throw new TypeError("Cannot `"+t+"` without `compiler`")}function kV(t,e){if(e)throw new Error("Cannot call `"+t+"` on a frozen processor.\nCreate a new processor first, by calling it: use `processor()` instead of `processor`.")}function Gle(t){if(!lT(t)||typeof t.type!="string")throw new TypeError("Expected node, got `"+t+"`")}function jle(t,e,r){if(!r)throw new Error("`"+t+"` finished async. Use `"+e+"` instead")}function RD(t){return FOe(t)?t:new Jy(t)}function FOe(t){return!!(t&&typeof t=="object"&&"message"in t&&"messages"in t)}function NOe(t){return typeof t=="string"||VOe(t)}function VOe(t){return!!(t&&typeof t=="object"&&"byteLength"in t&&"byteOffset"in t)}var zOe="https://github.com/remarkjs/react-markdown/blob/main/changelog.md",Hle=[],qle={allowDangerousHtml:!0},UOe=/^(https?|ircs?|mailto|xmpp)$/i,GOe=[{from:"astPlugins",id:"remove-buggy-html-in-markdown-parser"},{from:"allowDangerousHtml",id:"remove-buggy-html-in-markdown-parser"},{from:"allowNode",id:"replace-allownode-allowedtypes-and-disallowedtypes",to:"allowElement"},{from:"allowedTypes",id:"replace-allownode-allowedtypes-and-disallowedtypes",to:"allowedElements"},{from:"disallowedTypes",id:"replace-allownode-allowedtypes-and-disallowedtypes",to:"disallowedElements"},{from:"escapeHtml",id:"remove-buggy-html-in-markdown-parser"},{from:"includeElementIndex",id:"#remove-includeelementindex"},{from:"includeNodeIndex",id:"change-includenodeindex-to-includeelementindex"},{from:"linkTarget",id:"remove-linktarget"},{from:"plugins",id:"change-plugins-to-remarkplugins",to:"remarkPlugins"},{from:"rawSourcePos",id:"#remove-rawsourcepos"},{from:"renderers",id:"change-renderers-to-components",to:"components"},{from:"source",id:"change-source-to-children",to:"children"},{from:"sourcePos",id:"#remove-sourcepos"},{from:"transformImageUri",id:"#add-urltransform",to:"urlTransform"},{from:"transformLinkUri",id:"#add-urltransform",to:"urlTransform"}];function BD(t){let e=t.allowedElements,r=t.allowElement,n=t.children||"",o=t.className,i=t.components,a=t.disallowedElements,s=t.rehypePlugins||Hle,l=t.remarkPlugins||Hle,c=t.remarkRehypeOptions?w(w({},t.remarkRehypeOptions),qle):qle,u=t.skipHtml,d=t.unwrapDisallowed,m=t.urlTransform||Wle,p=RV().use(bD).use(l).use(kD,c).use(s),h=new Jy;typeof n=="string"?h.value=n:(""+n,void 0),e&&a&&void 0;for(let x of GOe)Object.hasOwn(t,x.from)&&(""+x.from+(x.to?"use `"+x.to+"` instead":"remove it")+zOe+x.id,void 0);let f=p.parse(h),b=p.runSync(f,h);return o&&(b={type:"element",tagName:"div",properties:{className:o},children:b.type==="root"?b.children:[b]}),sT(b,v),Y4(b,{Fragment:Ex.Fragment,components:i,ignoreInvalidStyle:!0,jsx:Ex.jsx,jsxs:Ex.jsxs,passKeys:!0,passNode:!0});function v(x,S,T){if(x.type==="raw"&&T&&typeof S=="number")return u?T.children.splice(S,1):T.children[S]={type:"text",value:x.value},S;if(x.type==="element"){let E;for(E in KC)if(Object.hasOwn(KC,E)&&Object.hasOwn(x.properties,E)){let _=x.properties[E],D=KC[E];(D===null||D.includes(x.tagName))&&(x.properties[E]=m(String(_||""),E,x))}}if(x.type==="element"){let E=e?!e.includes(x.tagName):a?a.includes(x.tagName):!1;if(!E&&r&&typeof S=="number"&&(E=!r(x,S,T)),E&&T&&typeof S=="number")return d&&x.children?T.children.splice(S,1,...x.children):T.children.splice(S,1),S}}}function Wle(t){let e=t.indexOf(":"),r=t.indexOf("?"),n=t.indexOf("#"),o=t.indexOf("/");return e<0||o>-1&&e>o||r>-1&&e>r||n>-1&&e>n||UOe.test(t.slice(0,e))?t:""}var Jp=Ot(Or());var OD=class extends Mt{constructor(){super(...arguments),this.updateParams=e=>{this.plugin.managers.animation.updateParams({[e.name]:e.value})},this.updateCurrentParams=e=>{this.plugin.managers.animation.updateCurrentParams({[e.name]:e.value})},this.startOrStop=()=>{let e=this.plugin.managers.animation;e.state.animationState==="playing"?e.stop():(this.props.onStart&&this.props.onStart(),e.start())}}componentDidMount(){this.subscribe(this.plugin.managers.animation.events.updated,()=>this.forceUpdate())}render(){var e,r;let n=this.plugin.managers.animation;if(n.isEmpty)return null;let o=n.state.animationState==="playing",i=(r=(e=n.current.anim).canApply)===null||r===void 0?void 0:r.call(e,this.plugin);return(0,Jp.jsxs)(Jp.Fragment,{children:[(0,Jp.jsx)(Hr,{params:n.getParams(),values:n.state.params,onChange:this.updateParams,isDisabled:o}),(0,Jp.jsx)(Hr,{params:n.current.params,values:n.current.paramValues,onChange:this.updateCurrentParams,isDisabled:o}),(0,Jp.jsx)("div",{className:"msp-flex-row",children:(0,Jp.jsx)(vt,{icon:n.state.animationState!=="playing"?void 0:lP,onClick:this.startOrStop,disabled:i!==void 0&&i.canApply===!1,children:n.state.animationState==="playing"?"Stop":i===void 0||i.canApply?"Start":i.reason||"Start"})})]})}};var cr=Ot(Or());var jOe=Ot(Or());var yi=Ot(Or());var $d=class extends Kn{constructor(){super(...arguments),this.onChange=({name:e,value:r})=>{let n=U(w({},this.props.params),{[e]:r});this.props.events.onChange(n,this.areInitial(n),this.validate(n))}}validate(e){}areInitial(e){return g.areEqual(this.props.info.params,e,this.props.info.initialValues)}render(){return(0,yi.jsx)(Hr,{params:this.props.info.params,values:this.props.params,onChange:this.onChange,onEnter:this.props.events.onEnter,isDisabled:this.props.isDisabled})}};(function(t){function e(o){let i=Object.keys(o);for(let a of i)if(!o[a].isHidden)return!1;return!0}function r(o,i,a,s){let l=i.cells.get(s).obj,c=a.definition.params?a.definition.params(l,o):{};return{initialValues:g.getDefaultValues(c),params:c,isEmpty:e(c)}}t.infoFromAction=r;function n(o,i,a){let s=i.cells.get(a.ref),l=s.params&&s.params.definition||{};return{initialValues:s.params&&s.params.values||{},params:l,isEmpty:e(l)}}t.infoFromTransform=n})($d||($d={}));var Ix=class extends Kn{constructor(){super(...arguments),this.busy=new da(!1),this.onEnter=()=>{this.state.error||this.apply()},this.autoApplyHandle=void 0,this.events={onEnter:this.onEnter,onChange:(e,r,n)=>{this.clearAutoApply(),this.setState({params:e,isInitial:r,error:n&&n[0]},()=>{!r&&!this.state.error&&this.canAutoApply(e)&&(this.clearAutoApply(),this.autoApplyHandle=setTimeout(this.apply,50))})}},this.apply=()=>N(this,null,function*(){var e,r;this.clearAutoApply(),this.setState({busy:!0});try{yield this.applyAction()}catch(n){console.error(n)}finally{(r=(e=this.props).onApply)===null||r===void 0||r.call(e),this.busy.next(!1)}}),this.refresh=()=>{this.setState({params:this.getInfo().initialValues,isInitial:!0,error:void 0})},this.setDefault=()=>{let e=this.getInfo(),r=g.getDefaultValues(e.params);this.setState({params:r,isInitial:g.areEqual(e.params,r,e.initialValues),error:void 0})},this.toggleExpanded=()=>{this.setState({isCollapsed:!this.state.isCollapsed})}}clearAutoApply(){this.autoApplyHandle!==void 0&&(clearTimeout(this.autoApplyHandle),this.autoApplyHandle=void 0)}componentDidMount(){this.subscribe(this.plugin.behaviors.state.isBusy,e=>{this.busy.value!==e&&this.busy.next(e)}),this.subscribe(this.busy.pipe(xT(1)),e=>{this.setState({busy:e})})}renderApply(){let e=this.canApply();return this.props.autoHideApply&&(!e||this.canAutoApply(this.state.params))?null:(0,yi.jsxs)("div",{className:"msp-transform-apply-wrap",children:[(0,yi.jsx)(pt,{svg:TS,className:"msp-transform-default-params",onClick:this.setDefault,disabled:this.state.busy,title:"Set default params"}),(0,yi.jsx)("div",{className:"msp-transform-apply-wider",children:(0,yi.jsx)(vt,{icon:e?Pc:void 0,className:`msp-btn-commit msp-btn-commit-${e?"on":"off"}`,onClick:this.apply,disabled:!e,children:this.props.applyLabel||this.applyText()})})]})}renderDefault(){let e=this.getInfo(),r=e.isEmpty&&this.isUpdate(),n=this.getHeader(),o=this.getTransformerId(),i=this.plugin.customParamEditors.has(o)?this.plugin.customParamEditors.get(o):$d,a=this.state.isCollapsed?"msp-transform-wrapper msp-transform-wrapper-collapsed":"msp-transform-wrapper",s=null;if(!r&&!this.state.isCollapsed){let{a:c,b:u,bCell:d}=this.getSourceAndTarget(),m=this.renderApply();s=(0,yi.jsxs)(yi.Fragment,{children:[(0,yi.jsx)(i,{info:e,a:c,b:u,bCell:d,events:this.events,params:this.state.params,isDisabled:this.state.busy}),m]})}let l=(0,yi.jsxs)("div",{className:a,style:{marginBottom:this.props.noMargin?0:void 0},children:[n!=="none"&&!this.props.wrapInExpander&&(0,yi.jsx)("div",{className:"msp-transform-header",children:(0,yi.jsxs)(vt,{onClick:this.toggleExpanded,title:n.description,children:[!r&&(0,yi.jsx)(pr,{svg:this.state.isCollapsed?Ls:Rs}),n.name]})}),s]});return r||!this.props.wrapInExpander?l:(0,yi.jsx)(Ci,{header:this.isUpdate()?`Update ${n==="none"?"":n.name}`:`Apply ${n==="none"?"":n.name}`,headerLeftMargin:this.props.expanderHeaderLeftMargin,children:l})}renderSimple(){var e,r,n;let o=this.getInfo(),i=this.canApply(),a=(0,yi.jsxs)("div",{className:"msp-flex-row",children:[(0,yi.jsx)(vt,{icon:(e=this.props.simpleApply)===null||e===void 0?void 0:e.icon,title:(r=this.props.simpleApply)===null||r===void 0?void 0:r.title,disabled:this.state.busy||!i,onClick:this.apply,className:"msp-btn-apply-simple",children:(n=this.props.simpleApply)===null||n===void 0?void 0:n.header}),!o.isEmpty&&(0,yi.jsx)(Gn,{icon:pl,label:"",title:"Options",toggle:this.toggleExpanded,isSelected:!this.state.isCollapsed,disabled:this.state.busy,style:{flex:"0 0 40px",padding:0}})]});if(this.state.isCollapsed)return a;let s=this.getTransformerId(),l=this.plugin.customParamEditors.has(s)?this.plugin.customParamEditors.get(s):$d,{a:c,b:u,bCell:d}=this.getSourceAndTarget();return(0,yi.jsxs)(yi.Fragment,{children:[a,(0,yi.jsx)(l,{info:o,a:c,b:u,bCell:d,events:this.events,params:this.state.params,isDisabled:this.state.busy})]})}render(){return this.props.simpleApply?this.renderSimple():this.renderDefault()}};var Xs=class extends Ix{constructor(){super(...arguments),this._getInfo=Js(e=>$d.infoFromTransform(this.plugin,this.props.state,e)),this.state={error:void 0,isInitial:!0,params:this.getInfo().initialValues,busy:!1,isCollapsed:this.props.initiallyCollapsed}}applyAction(){return this.props.customUpdate?this.props.customUpdate(this.state.params):this.plugin.state.updateTransform(this.props.state,this.props.transform.ref,this.state.params)}getInfo(){return this._getInfo(this.props.transform)}getTransformerId(){return this.props.transform.transformer.id}getHeader(){return this.props.customHeader||this.props.transform.transformer.definition.display}canApply(){let{state:e}=this.props,r=e.cells.get(this.props.transform.ref);if(!r)return!1;if(r.status==="error"){let n=e.cells.get(this.props.transform.parent);return n?n.status==="ok":!1}return!this.state.error&&!this.state.busy&&!this.state.isInitial}applyText(){return this.canApply()?"Update":"Nothing to Update"}isUpdate(){return!0}getSourceAndTarget(){let e=this.props.state.cells.get(this.props.transform.ref);return{a:this.props.state.cells.get(this.props.transform.parent).obj,b:e?.obj,bCell:e}}canAutoApply(e){let r=this.props.transform.transformer.definition.canAutoUpdate;if(!r)return!1;let{state:n}=this.props,o=n.cells.get(this.props.transform.ref);if(!o||!o.sourceRef||o.status!=="ok")return!1;let i=n.cells.get(o.sourceRef);return r({a:i.obj,b:o.obj,oldParams:this.getInfo().initialValues,newParams:e},this.plugin)}componentDidMount(){super.componentDidMount(),this.props.toggleCollapsed&&this.subscribe(this.props.toggleCollapsed,()=>this.setState({isCollapsed:!this.state.isCollapsed})),this.subscribe(this.plugin.state.events.object.updated,({ref:e,state:r})=>{this.props.transform.ref!==e||this.props.state!==r||this.state.params!==this.props.transform.params&&(this._getInfo=Js(n=>$d.infoFromTransform(this.plugin,this.props.state,n)),this.setState({params:this.props.transform.params,isInitial:!0}))})}componentDidUpdate(e){var r;if(this.props.transform!==e.transform){let n=this.props.state.cells.get(this.props.transform.ref);this.setState({params:((r=n.params)===null||r===void 0?void 0:r.values)||{},isInitial:!0,error:void 0,simpleOnly:this.state.simpleOnly})}}};var Ji=Ot(Or());var FD=class extends Kn{get current(){return this.plugin.managers.structure.hierarchy.behaviors.selection}componentDidMount(){this.subscribe(this.current,()=>this.forceUpdate())}get unitcell(){var e;let{selection:r}=this.plugin.managers.structure.hierarchy;if(r.structures.length===0)return null;let n=[];for(let o of r.structures){let i=o.model;i?.unitcell&&(!((e=i.unitcell)===null||e===void 0)&&e.cell.obj)&&n.push(i.unitcell)}return n.length===0?null:(0,Ji.jsx)(ND,{refs:n,labelMultiple:"Unit Cells"})}get customControls(){let e=[];return this.plugin.genericRepresentationControls.forEach((r,n)=>{let[o,i]=r(this.plugin.managers.structure.hierarchy.selection);o.length>0&&e.push((0,Ji.jsx)("div",{children:(0,Ji.jsx)(ND,{refs:o,labelMultiple:i})},n))}),e.length>0?e:null}render(){return(0,Ji.jsx)(Ji.Fragment,{children:(0,Ji.jsxs)("div",{style:{marginTop:"6px"},children:[this.unitcell,this.customControls]})})}},ND=class extends Kn{constructor(){super(...arguments),this.state={showOptions:!1},this.toggleVisibility=e=>{e.preventDefault(),this.plugin.managers.structure.hierarchy.toggleVisibility(this.props.refs),e.currentTarget.blur()},this.highlight=e=>{e.preventDefault(),this.pivot.cell.parent&&Re.Interactivity.Object.Highlight(this.plugin,{state:this.pivot.cell.parent,ref:this.props.refs.map(r=>r.cell.transform.ref)})},this.clearHighlight=e=>{e.preventDefault(),Re.Interactivity.ClearHighlights(this.plugin)},this.focus=e=>{var r;e.preventDefault();let n=!0;for(let i of this.props.refs)if(!i.cell.state.isHidden){n=!1;break}n&&this.plugin.managers.structure.hierarchy.toggleVisibility(this.props.refs,"show");let o=[];for(let i of this.props.refs){if(i.cell.state.isHidden)continue;let a=(r=i.cell.obj)===null||r===void 0?void 0:r.data.repr.getLoci();a&&o.push(a)}this.plugin.managers.camera.focusLoci(o)},this.toggleOptions=()=>this.setState({showOptions:!this.state.showOptions})}componentDidMount(){this.subscribe(this.plugin.state.events.cell.stateUpdated,e=>{var r;Ll.ObjectEvent.isCell(e,(r=this.pivot)===null||r===void 0?void 0:r.cell)&&this.forceUpdate()})}get pivot(){return this.props.refs[0]}render(){let{refs:e,labelMultiple:r}=this.props;if(e.length===0)return null;let n=e[0],o,i;if(e.length===1){let{obj:a}=n.cell;if(!a)return null;o=a?.label,i=a?.description}else o=`${e.length} ${r||"Objects"}`;return(0,Ji.jsxs)(Ji.Fragment,{children:[(0,Ji.jsxs)("div",{className:"msp-flex-row",children:[(0,Ji.jsxs)("button",{className:"msp-form-control msp-control-button-label",title:`${o}. Click to focus.`,onClick:this.focus,onMouseEnter:this.highlight,onMouseLeave:this.clearHighlight,style:{textAlign:"left"},children:[o," ",(0,Ji.jsx)("small",{children:i})]}),(0,Ji.jsx)(pt,{svg:n.cell.state.isHidden?Ec:Ic,toggleState:!1,className:"msp-form-control",onClick:this.toggleVisibility,title:`${n.cell.state.isHidden?"Show":"Hide"}`,small:!0,flex:!0}),e.length===1&&(0,Ji.jsx)(pt,{svg:Pu,className:"msp-form-control",onClick:this.toggleOptions,title:"Options",toggleState:this.state.showOptions,flex:!0})]}),e.length===1&&this.state.showOptions&&n.cell.parent&&(0,Ji.jsx)(Ji.Fragment,{children:(0,Ji.jsx)("div",{className:"msp-control-offset",children:(0,Ji.jsx)(Xs,{state:n.cell.parent,transform:n.cell.transform,customHeader:"none",autoHideApply:!0})})})]})}};var VD=class extends hl{defaultState(){return{header:"Components",isCollapsed:!1,isDisabled:!1,brand:{accent:"blue",svg:bS}}}componentDidMount(){this.subscribe(this.plugin.managers.structure.hierarchy.behaviors.selection,e=>this.setState({description:km.getSelectedStructuresDescription(this.plugin)}))}renderControls(){return(0,cr.jsxs)(cr.Fragment,{children:[(0,cr.jsx)(LV,{}),(0,cr.jsx)(OV,{}),(0,cr.jsx)(FD,{})]})}},LV=class extends Kn{constructor(){super(...arguments),this.state={isEmpty:!0,isBusy:!1,canUndo:!1},this.togglePreset=this.toggleAction("preset"),this.toggleAdd=this.toggleAction("add"),this.toggleOptions=this.toggleAction("options"),this.hideAction=()=>this.setState({action:void 0}),this.applyPreset=e=>{if(this.hideAction(),!e)return;let r=this.plugin.managers.structure,{structures:n}=r.hierarchy.selection;e.value===null?r.component.clear(n):r.component.applyPreset(n,e.value)},this.undo=()=>{let e=this.plugin.state.data.undo();e&&this.plugin.runTask(e)}}get isDisabled(){return this.state.isBusy||this.state.isEmpty}componentDidMount(){this.subscribe(this.plugin.managers.structure.hierarchy.behaviors.selection,e=>this.setState({action:this.state.action!=="options"||e.structures.length===0?void 0:"options",isEmpty:e.structures.length===0})),this.subscribe(this.plugin.behaviors.state.isBusy,e=>{this.setState({isBusy:e,action:this.state.action!=="options"?void 0:"options"})}),this.subscribe(this.plugin.state.data.events.historyUpdated,({state:e})=>{this.setState({canUndo:e.canUndo})})}toggleAction(e){return()=>this.setState({action:this.state.action===e?void 0:e})}get presetControls(){return(0,cr.jsx)(wt,{items:this.presetActions,onSelect:this.applyPreset})}get presetActions(){let e=this.plugin.managers.structure.component.pivotStructure,r=this.plugin.builders.structure.representation.getPresets(e?.cell.obj);return wt.createItems(r,{label:n=>n.display.name,category:n=>n.display.group,description:n=>n.display.description})}render(){let e=this.state.canUndo?`Undo ${this.plugin.state.data.latestUndoLabel}`:"Some mistakes of the past can be undone.";return(0,cr.jsxs)(cr.Fragment,{children:[(0,cr.jsxs)("div",{className:"msp-flex-row",children:[(0,cr.jsx)(Gn,{icon:Mp,label:"Preset",title:"Apply a representation preset for the current structure(s).",toggle:this.togglePreset,isSelected:this.state.action==="preset",disabled:this.isDisabled}),(0,cr.jsx)(Gn,{icon:Fd,label:"Add",title:"Add a new representation component for a selection.",toggle:this.toggleAdd,isSelected:this.state.action==="add",disabled:this.isDisabled}),(0,cr.jsx)(Gn,{icon:pl,label:"",title:"Options that are applied to all applicable representations.",style:{flex:"0 0 40px",padding:0},toggle:this.toggleOptions,isSelected:this.state.action==="options",disabled:this.isDisabled}),(0,cr.jsx)(pt,{svg:_S,className:"msp-flex-item",flex:"40px",onClick:this.undo,disabled:!this.state.canUndo||this.isDisabled,title:e})]}),this.state.action==="preset"&&this.presetControls,this.state.action==="add"&&(0,cr.jsx)("div",{className:"msp-control-offset",children:(0,cr.jsx)(uT,{onApply:this.hideAction})}),this.state.action==="options"&&(0,cr.jsx)("div",{className:"msp-control-offset",children:(0,cr.jsx)(BV,{isDisabled:this.isDisabled})})]})}},uT=class extends Kn{constructor(){super(...arguments),this.state=this.createState(),this.apply=()=>{let e=this.props.forSelection?this.currentStructures:this.selectedStructures;this.props.onApply(),this.plugin.managers.structure.component.add(this.state.values,e)},this.paramsChanged=e=>this.setState({values:e})}createState(){let e=ql.getAddParams(this.plugin);return{params:e,values:g.getDefaultValues(e)}}get selectedStructures(){return this.plugin.managers.structure.component.currentStructures}get currentStructures(){return this.plugin.managers.structure.hierarchy.current.structures}render(){return(0,cr.jsxs)(cr.Fragment,{children:[(0,cr.jsx)(Hr,{params:this.state.params,values:this.state.values,onChangeValues:this.paramsChanged}),(0,cr.jsx)(vt,{icon:Fd,title:"Use Selection and optional Representation to create a new Component.",className:"msp-btn-commit msp-btn-commit-on",onClick:this.apply,style:{marginTop:"1px"},children:"Create Component"})]})}},BV=class extends Kn{constructor(){super(...arguments),this.update=e=>this.plugin.managers.structure.component.setOptions(e)}componentDidMount(){this.subscribe(this.plugin.managers.structure.component.events.optionsUpdated,()=>this.forceUpdate())}render(){return(0,cr.jsx)(Hr,{params:ql.OptionsParams,values:this.plugin.managers.structure.component.state.options,onChangeValues:this.update,isDisabled:this.props.isDisabled})}},OV=class extends Kn{componentDidMount(){this.subscribe(this.plugin.managers.structure.hierarchy.behaviors.selection,()=>{this.forceUpdate()})}render(){let e=this.plugin.managers.structure.hierarchy.currentComponentGroups;return e.length===0?null:(0,cr.jsx)("div",{style:{marginTop:"6px"},children:e.map(r=>(0,cr.jsx)(FV,{group:r},r[0].cell.transform.ref))})}},FV=class extends Kn{constructor(){super(...arguments),this.state={action:void 0},this.toggleVisible=e=>{e.preventDefault(),e.currentTarget.blur(),this.plugin.managers.structure.component.toggleVisibility(this.props.group)},this.selectAction=e=>{e&&(0,e?.value)()},this.remove=()=>this.plugin.managers.structure.hierarchy.remove(this.props.group,!0),this.toggleAction=()=>this.setState({action:this.state.action==="action"?void 0:"action"}),this.toggleLabel=()=>this.setState({action:this.state.action==="label"?void 0:"label"}),this.highlight=e=>{e.preventDefault(),this.props.group[0].cell.parent&&Re.Interactivity.Object.Highlight(this.plugin,{state:this.props.group[0].cell.parent,ref:this.props.group.map(r=>r.cell.transform.ref)})},this.clearHighlight=e=>{e.preventDefault(),Re.Interactivity.ClearHighlights(this.plugin)},this.focus=()=>{let e=!0;for(let r of this.props.group)if(!r.cell.state.isHidden){e=!1;break}e&&this.plugin.managers.structure.hierarchy.toggleVisibility(this.props.group,"show"),this.plugin.managers.camera.focusSpheres(this.props.group,r=>{var n;if(!r.cell.state.isHidden)return(n=r.cell.obj)===null||n===void 0?void 0:n.data.boundary.sphere})},this.updateLabel=e=>{this.plugin.managers.structure.component.updateLabel(this.pivot,e)}}get pivot(){return this.props.group[0]}componentDidMount(){this.subscribe(this.plugin.state.events.cell.stateUpdated,e=>{Ll.ObjectEvent.isCell(e,this.pivot.cell)&&this.forceUpdate()})}get colorByActions(){var e,r;let n=this.plugin.managers.structure.component,i=(e=this.pivot.representations[0].cell.transform.params)===null||e===void 0?void 0:e.colorTheme.name,a=zZ(this.plugin,(r=this.pivot.cell.obj)===null||r===void 0?void 0:r.data);return wt.createItemsFromSelectOptions(a,{value:s=>()=>n.updateRepresentationsTheme(this.props.group,{color:s[0]}),selected:s=>s[0]===i})}get actions(){let e=this.plugin.managers.structure.component,r=[[wt.Header("Add Representation"),...ql.getRepresentationTypes(this.plugin,this.props.group[0]).map(n=>wt.Item(n[1],()=>e.addRepresentation(this.props.group,n[0])))]];return this.pivot.representations.length>0&&r.push([wt.Header("Set Coloring",{isIndependent:!0}),...this.colorByActions]),e.canBeModified(this.props.group[0])&&r.push([wt.Header("Modify by Selection"),wt.Item("Include",()=>e.modifyByCurrentSelection(this.props.group,"union"),{icon:gS}),wt.Item("Subtract",()=>e.modifyByCurrentSelection(this.props.group,"subtract"),{icon:yS}),wt.Item("Intersect",()=>e.modifyByCurrentSelection(this.props.group,"intersect"),{icon:vS})]),r.push(wt.Item("Select This",()=>e.selectThis(this.props.group),{icon:yy})),e.canBeModified(this.props.group[0])&&r.push(wt.Item("Edit Label",this.toggleLabel)),r}get reprLabel(){var e;let r=this.pivot;return r.representations.length===0?"No repr.":r.representations.length===1?(e=r.representations[0].cell.obj)===null||e===void 0?void 0:e.label:`${r.representations.length} reprs`}render(){var e;let r=this.pivot,n=r.cell,o=(e=n.obj)===null||e===void 0?void 0:e.label,i=this.reprLabel;return(0,cr.jsxs)(cr.Fragment,{children:[(0,cr.jsxs)("div",{className:"msp-flex-row",children:[(0,cr.jsxs)(vt,{noOverflow:!0,className:"msp-control-button-label",title:`${o}. Click to focus.`,onClick:this.focus,onMouseEnter:this.highlight,onMouseLeave:this.clearHighlight,style:{textAlign:"left"},children:[o,(0,cr.jsx)("small",{className:"msp-25-lower-contrast-text",style:{float:"right"},children:i})]}),(0,cr.jsx)(pt,{svg:n.state.isHidden?Ec:Ic,toggleState:!1,onClick:this.toggleVisible,title:`${n.state.isHidden?"Show":"Hide"} component`,small:!0,className:"msp-form-control",flex:!0}),(0,cr.jsx)(pt,{svg:Hi,toggleState:!1,onClick:this.remove,title:"Remove",small:!0,className:"msp-form-control",flex:!0}),(0,cr.jsx)(pt,{svg:Pu,onClick:this.toggleAction,title:"Actions",toggleState:this.state.action==="action",className:"msp-form-control",flex:!0})]}),this.state.action==="label"&&(0,cr.jsx)("div",{className:"msp-control-offset",style:{marginBottom:"6px"},children:(0,cr.jsx)(Ga,{label:"Label",control:(0,cr.jsxs)("div",{style:{display:"flex",textAlignLast:"center"},children:[(0,cr.jsx)(fl,{onChange:this.updateLabel,value:o,style:{flex:"1 1 auto",minWidth:0},className:"msp-form-control",blurOnEnter:!0,blurOnEscape:!0}),(0,cr.jsx)(pt,{svg:Pc,onClick:this.toggleLabel,className:"msp-form-control msp-control-button-label",flex:!0})]})})}),this.state.action==="action"&&(0,cr.jsxs)("div",{className:"msp-accent-offset",children:[(0,cr.jsx)("div",{style:{marginBottom:"6px"},children:(0,cr.jsx)(wt,{items:this.actions,onSelect:this.selectAction,noOffset:!0})}),(0,cr.jsx)("div",{style:{marginBottom:"6px"},children:r.representations.map(a=>(0,cr.jsx)(NV,{group:this.props.group,representation:a},a.cell.transform.ref))})]})]})}},NV=class extends Kn{constructor(){super(...arguments),this.remove=()=>this.plugin.managers.structure.component.removeRepresentations(this.props.group,this.props.representation),this.toggleVisible=e=>{e.preventDefault(),e.currentTarget.blur(),this.plugin.managers.structure.component.toggleVisibility(this.props.group,this.props.representation)},this.update=e=>this.plugin.managers.structure.component.updateRepresentations(this.props.group,this.props.representation,e)}componentDidMount(){this.subscribe(this.plugin.state.events.cell.stateUpdated,e=>{Ll.ObjectEvent.isCell(e,this.props.representation.cell)&&this.forceUpdate()})}render(){var e;let r=this.props.representation.cell;return(0,cr.jsxs)("div",{className:"msp-representation-entry",children:[r.parent&&(0,cr.jsx)(Ci,{header:`${((e=r.obj)===null||e===void 0?void 0:e.label)||""} Representation`,noOffset:!0,children:(0,cr.jsx)(Xs,{state:r.parent,transform:r.transform,customHeader:"none",customUpdate:this.update,noMargin:!0})}),(0,cr.jsx)(pt,{svg:Hi,onClick:this.remove,title:"Remove",small:!0,className:"msp-default-bg",toggleState:!1,style:{position:"absolute",top:0,right:"32px",lineHeight:"24px",height:"24px",textAlign:"right",width:"44px",paddingRight:"6px",background:"none"}}),(0,cr.jsx)(pt,{svg:this.props.representation.cell.state.isHidden?Ec:Ic,toggleState:!1,onClick:this.toggleVisible,title:"Toggle Visibility",small:!0,className:"msp-default-bg",style:{position:"absolute",top:0,right:0,lineHeight:"24px",height:"24px",textAlign:"right",width:"32px",paddingRight:"6px",background:"none"}})]})}};var gr=Ot(Or());var qt=Ot(Or()),Yle=Ot(Po());function HOe(t,e){var r;let n=[],o=e==="auth"?"auth_asym_id":"label_asym_id",i=e==="auth"?"auth_seq_id":"label_seq_id";for(let s of t)if(s.kind==="range")n.push(q.struct.generator.atomGroups({"chain-test":q.core.rel.eq([q.ammp(o),s.asym_id]),"residue-test":q.core.rel.inRange([q.ammp(i),s.seq_id_beg,s.seq_id_end])}));else{let l=((r=s.ins_code)!==null&&r!==void 0?r:"").trim();n.push(q.struct.generator.atomGroups({"chain-test":q.core.rel.eq([q.ammp(o),s.asym_id]),"residue-test":q.core.logic.and([q.core.rel.eq([q.ammp(i),s.seq_id]),q.core.rel.eq([q.ammp("pdbx_PDB_ins_code"),l])])}))}let a=q.struct.combinator.merge(n);return hd(a)}function qOe(t){let e=Qc.create();for(let[n,o]of t)for(let i=n;i<=o;i++)Qc.add(e,i,i);let r=q.struct.generator.atomGroups({"atom-test":q.core.set.has([q.set(...e.array),q.ammp("id")])});return hd(r)}function WOe(t,e,r){if(!(!t||e.length===0||Number.isNaN(+e[0])))return Number.isNaN(r)?{kind:"single",asym_id:t,seq_id:+e[0],ins_code:e[1]}:{kind:"range",asym_id:t,seq_id_beg:+e[0],seq_id_end:r}}function XOe(t){return t?t.split(":"):[]}function YOe(t){return t.split(",").map(e=>e.trim().split(/\s+|[-]/g).filter(r=>!!r)).map(e=>WOe(e[0],XOe(e[1]),+e[2])).filter(e=>!!e)}function QOe(t){return t.split(",").map(e=>e.trim().split(/\s+|[-]/g).filter(r=>!!r)).filter(e=>e.length===1||e.length===2).map(e=>e.length===1?[+e[0],+e[0]]:[+e[0],+e[1]])}function Xle(t,e){if(e==="atom-id"){let r=QOe(t);return qOe(r)}else{let r=YOe(t);return HOe(r,e)}}var Bt=Ot(Or()),UD=Ot(Po());function KOe(t){return Object.keys(t).map(e=>[e,t[e]]).filter(e=>Xe.isBinding(e[1]))}var Dx=class extends UD.PureComponent{getBindingComponents(){let e=KOe(this.props.bindings);return(0,Bt.jsx)(Bt.Fragment,{children:e.map(r=>{let[n,o]=r;return Xe.isEmpty(o)?null:(0,Bt.jsxs)("div",{style:{marginBottom:"6px"},children:[(0,Bt.jsx)("b",{children:o.action}),(0,Bt.jsx)("br",{}),(0,Bt.jsx)("span",{dangerouslySetInnerHTML:{__html:Xe.format(o,n)}})]},n)})})}render(){return(0,Bt.jsx)(Nc,{children:this.getBindingComponents()})}},Nc=class extends UD.PureComponent{render(){return(0,Bt.jsx)("div",{className:"msp-help-text",children:(0,Bt.jsx)("div",{children:this.props.children})})}},Vc=class extends UD.PureComponent{constructor(){super(...arguments),this.state={header:this.props.header,isExpanded:!!this.props.initiallyExpanded},this.toggleExpanded=()=>this.setState({isExpanded:!this.state.isExpanded})}render(){return(0,Bt.jsxs)("div",{className:"msp-control-group-wrapper",children:[(0,Bt.jsx)("div",{className:"msp-control-group-header",children:(0,Bt.jsxs)(vt,{onClick:this.toggleExpanded,children:[(0,Bt.jsx)(pr,{svg:this.state.isExpanded?Rs:Ls}),this.props.header]})}),this.state.isExpanded&&(0,Bt.jsx)("div",{className:"msp-control-offset",style:{display:this.state.isExpanded?"block":"none"},children:this.props.children})]})}};function VV(t){return(0,Bt.jsx)("div",{className:"msp-simple-help-section",children:t.header})}var e0=class extends Mt{constructor(){super(...arguments),this.getInteractionBindings=Js(e=>{let r;return e.forEach(n=>{var o;let i=(o=n.params)===null||o===void 0?void 0:o.values;i?.bindings&&Object.keys(i.bindings).length>0&&(r||(r={}),Object.assign(r,i.bindings))}),r})}componentDidMount(){this.subscribe(this.plugin.events.canvas3d.settingsUpdated,()=>this.forceUpdate())}render(){let e=this.getInteractionBindings(this.plugin.state.behaviors.cells);return(0,Bt.jsxs)(Bt.Fragment,{children:[!this.props.selectOnly&&this.plugin.canvas3d&&(0,Bt.jsx)(Vc,{header:"Moving in 3D",children:(0,Bt.jsx)(Dx,{bindings:this.plugin.canvas3d.props.trackball.bindings})},"trackball"),!!e&&(0,Bt.jsx)(Vc,{header:"Mouse & Key Controls",children:(0,Bt.jsx)(Dx,{bindings:e})},"interactions")]})}},zD=class extends Mt{componentDidMount(){this.subscribe(this.plugin.events.canvas3d.settingsUpdated,()=>this.forceUpdate())}formatTriggers(e){return e.triggers.map(r=>Xe.Trigger.format(r)).join(" or ")}getTriggerFor(e,r){let o=this.plugin.state.behaviors.select(lt.Generators.ofTransformer(e)),i=o.length===1?o[0].params:void 0,a=i?i.values.bindings:{},s=r in a?a[r]:Xe.Empty;return this.formatTriggers(s)}render(){let e=this.getTriggerFor(iL,"clickSelectToggle"),r=this.getTriggerFor(ly,"clickFocus");return(0,Bt.jsxs)("div",{children:[(0,Bt.jsx)(VV,{header:"Interface Controls"}),(0,Bt.jsxs)(Vc,{header:"Inline Help",children:[(0,Bt.jsx)(Nc,{children:"Many user interface elements show a little questionmark icon when hovered over. Clicking the icon toggles the display of an inline help text."}),(0,Bt.jsx)(Nc,{children:"Tooltips may provide additional information on a user interface element and are shown when hovering over it with the mouse."})]}),(0,Bt.jsx)(Vc,{header:"Selections",children:(0,Bt.jsxs)(Nc,{children:["The viewer allows changing colors and representations for selections of atoms, residues or chains. Selections can be created by",(0,Bt.jsxs)("ul",{style:{paddingLeft:"20px"},children:[(0,Bt.jsxs)("li",{children:["picking elements on the 3D canvas or the sequence view using the mouse, e.g. toggle selection using ",e," (for more see help section on ",(0,Bt.jsx)("i",{children:"Mouse Controls"}),")"]}),(0,Bt.jsxs)("li",{children:["using the ",(0,Bt.jsx)("i",{children:"Add"}),", ",(0,Bt.jsx)("i",{children:"Remove"})," and ",(0,Bt.jsx)("i",{children:"Only"})," dropdown buttons in the ",(0,Bt.jsx)("i",{children:"Manage Selection"})," panel which allow modifing the current selection by predefined sets"]})]})]})}),(0,Bt.jsx)(Vc,{header:"Coloring",children:(0,Bt.jsxs)(Nc,{children:["There are two ways to color structures. Every representation (e.g. cartoon or spacefill) has a color theme which can be changed using the dropdown for each representation in the ",(0,Bt.jsx)("i",{children:"Structure Settings"})," panel. Additionally any selection atoms, residues or chains can by given a custom color. For that, first select the parts of the structure to be colored (see help section on ",(0,Bt.jsx)("i",{children:"Selections"}),") and, second, choose a color from the color dropdown botton in the ",(0,Bt.jsx)("i",{children:"Selection"})," row of the ",(0,Bt.jsx)("i",{children:"Change Representation"})," panel. The theme color can be seen as a base color that is overpainted by the custom color. Custom colors can be removed for a selection with the 'Clear' option in the color dropdown."]})}),(0,Bt.jsx)(Vc,{header:"Representations",children:(0,Bt.jsxs)(Nc,{children:["Structures can be shown with many different representations (e.g. cartoon or spacefill). The ",(0,Bt.jsx)("i",{children:"Change Representation"})," panel offers a collection of predefined styles which can be applied using the ",(0,Bt.jsx)("i",{children:"Preset"})," dropdown button. Additionally any selection atoms, residues or chains can by shown with a custom representation. For that, first select the parts of the structure to be mofified (see help section on ",(0,Bt.jsx)("i",{children:"Selections"}),") and, second, choose a representation to hide or show from the ",(0,Bt.jsx)("i",{children:"Show"})," and ",(0,Bt.jsx)("i",{children:"Hide"})," dropdown bottons in the ",(0,Bt.jsx)("i",{children:"Selection"})," row of the ",(0,Bt.jsx)("i",{children:"Change Representation"})," panel. The ",(0,Bt.jsx)("i",{children:"Everything"})," row applies the action to the whole structure instead of the current selection."]})}),(0,Bt.jsx)(Vc,{header:"Surroundings",children:(0,Bt.jsxs)(Nc,{children:["To show the surroundings of a residue or ligand, click it in the 3D scene or in the sequence widget using ",r,"."]})}),(0,Bt.jsx)(VV,{header:"How-to Guides"}),(0,Bt.jsx)(Vc,{header:"Create an Image",children:(0,Bt.jsxs)(Nc,{children:[(0,Bt.jsxs)("p",{children:["Use the ",(0,Bt.jsx)(pr,{svg:PJ})," icon in the viewport to bring up the screenshot controls."]}),(0,Bt.jsxs)("p",{children:["To adjust the size of the image, use the ",(0,Bt.jsx)("i",{children:"Resolution"})," dropdown."]})]})}),(0,Bt.jsx)(VV,{header:"Mouse Controls"}),(0,Bt.jsx)(e0,{})]})}};var hg=class extends Kn{constructor(){super(...arguments),this._toggleSelMode=()=>{this.plugin.selectionMode=!this.plugin.selectionMode}}componentDidMount(){this.subscribe(this.plugin.events.canvas3d.settingsUpdated,()=>this.forceUpdate()),this.subscribe(this.plugin.layout.events.updated,()=>this.forceUpdate()),this.subscribe(this.plugin.behaviors.interaction.selectionMode,()=>this.forceUpdate())}render(){let e=this.props.inline?{background:"transparent",width:"auto",height:"auto",lineHeight:"unset"}:{background:"transparent"};return(0,qt.jsx)(pt,{svg:VJ,onClick:this._toggleSelMode,title:"Toggle Selection Mode",style:e,toggleState:this.plugin.selectionMode})}},$Oe={granularity:Ih.Params.granularity},Ax=new Map([["add","Add/Union Selection"],["remove","Remove/Subtract Selection"],["intersect","Intersect Selection"],["set","Set Selection"]]),GD=class extends Mt{constructor(){super(...arguments),this.state={action:void 0,helper:void 0,isEmpty:!0,isBusy:!1,canUndo:!1},this.set=(e,r)=>{this.plugin.managers.structure.selection.fromSelectionQuery(e,r,!1)},this.selectQuery=(e,r)=>{if(!e||!this.state.action){this.setState({action:void 0});return}let n=this.state.action;r?.shiftKey?this.set(n,e.value):this.setState({action:void 0},()=>{this.set(n,e.value)})},this.selectHelper=(e,r)=>{if(console.log(e),!e||!this.state.action){this.setState({action:void 0,helper:void 0});return}this.setState({helper:e.value.kind})},this.queriesItems=[],this.queriesVersion=-1,this.helpersItems=void 0,this.toggleAdd=this.showAction("add"),this.toggleRemove=this.showAction("remove"),this.toggleIntersect=this.showAction("intersect"),this.toggleSet=this.showAction("set"),this.toggleTheme=this.showAction("theme"),this.toggleAddComponent=this.showAction("add-component"),this.toggleHelp=this.showAction("help"),this.setGranuality=({value:e})=>{this.plugin.managers.interactivity.setProps({granularity:e})},this.turnOff=()=>this.plugin.selectionMode=!1,this.undo=()=>{let e=this.plugin.state.data.undo();e&&this.plugin.runTask(e)},this.subtract=()=>{let e=this.plugin.managers.structure.hierarchy.getStructuresWithSelection(),r=[];for(let n of e)r.push(...n.components);r.length!==0&&this.plugin.managers.structure.component.modifyByCurrentSelection(r,"subtract")}}componentDidMount(){this.subscribe(this.plugin.managers.structure.hierarchy.behaviors.selection,e=>{let r=e.hierarchy.structures.length===0;this.state.isEmpty!==r&&this.setState({isEmpty:r}),this.queriesVersion=-1,this.forceUpdate()}),this.subscribe(this.plugin.behaviors.state.isBusy,e=>{this.setState({isBusy:e,action:void 0})}),this.subscribe(this.plugin.managers.interactivity.events.propsUpdated,()=>{this.forceUpdate()}),this.subscribe(this.plugin.state.data.events.historyUpdated,({state:e})=>{this.setState({canUndo:e.canUndo})})}get isDisabled(){return this.state.isBusy||this.state.isEmpty}get structures(){var e;let r=[];for(let n of this.plugin.managers.structure.hierarchy.selection.structures){let o=(e=n.cell.obj)===null||e===void 0?void 0:e.data;o&&r.push(o)}return r}get queries(){let{registry:e}=this.plugin.query.structure;if(e.version!==this.queriesVersion){let r=this.structures,n=[...e.list,...rY(r),...tY(r),...eY(r)].sort((o,i)=>i.priority-o.priority);this.queriesItems=wt.createItems(n,{filter:o=>o!==Qn.current&&!o.isHidden,label:o=>o.label,category:o=>o.category,description:o=>o.description}),this.queriesVersion=e.version}return this.queriesItems}get helpers(){if(this.helpersItems)return this.helpersItems;let e=[{kind:"residue-list",category:"Helpers",label:"Atom/Residue Identifier List",description:"Create a selection from a list of atom/residue ranges."}];return this.helpersItems=wt.createItems(e,{label:r=>r.label,category:r=>r.category,description:r=>r.description}),this.helpersItems}showAction(e){return()=>this.setState({action:this.state.action===e?void 0:e,helper:void 0})}render(){let e=this.plugin.managers.interactivity.props.granularity,r=this.state.canUndo?`Undo ${this.plugin.state.data.latestUndoLabel}`:"Some mistakes of the past can be undone.",n;if(this.state.action&&!this.state.helper)n=(0,qt.jsxs)(qt.Fragment,{children:[this.state.action&&this.state.action!=="theme"&&this.state.action!=="add-component"&&this.state.action!=="help"&&(0,qt.jsxs)("div",{className:"msp-selection-viewport-controls-actions",children:[(0,qt.jsx)(wt,{header:Ax.get(this.state.action),title:"Click to close.",items:this.queries,onSelect:this.selectQuery,noOffset:!0}),(0,qt.jsx)(wt,{items:this.helpers,onSelect:this.selectHelper,noOffset:!0})]}),this.state.action==="theme"&&(0,qt.jsx)("div",{className:"msp-selection-viewport-controls-actions",children:(0,qt.jsx)(Ua,{header:"Theme",title:"Click to close.",initialExpanded:!0,hideExpander:!0,hideOffset:!0,onHeaderClick:this.toggleTheme,topRightIcon:ml,children:(0,qt.jsx)(zV,{onApply:this.toggleTheme})})}),this.state.action==="add-component"&&(0,qt.jsx)("div",{className:"msp-selection-viewport-controls-actions",children:(0,qt.jsx)(Ua,{header:"Add Component",title:"Click to close.",initialExpanded:!0,hideExpander:!0,hideOffset:!0,onHeaderClick:this.toggleAddComponent,topRightIcon:ml,children:(0,qt.jsx)(uT,{onApply:this.toggleAddComponent,forSelection:!0})})}),this.state.action==="help"&&(0,qt.jsx)("div",{className:"msp-selection-viewport-controls-actions",children:(0,qt.jsxs)(Ua,{header:"Help",title:"Click to close.",initialExpanded:!0,hideExpander:!0,hideOffset:!0,onHeaderClick:this.toggleHelp,topRightIcon:ml,maxHeight:"300px",children:[(0,qt.jsx)(Vc,{header:"Selection Operations",children:(0,qt.jsxs)(Nc,{children:["Use ",(0,qt.jsx)(pr,{svg:gS,inline:!0})," ",(0,qt.jsx)(pr,{svg:yS,inline:!0})," ",(0,qt.jsx)(pr,{svg:vS,inline:!0})," ",(0,qt.jsx)(pr,{svg:yy,inline:!0})," to modify the selection."]})}),(0,qt.jsx)(Vc,{header:"Representation Operations",children:(0,qt.jsxs)(Nc,{children:["Use ",(0,qt.jsx)(pr,{svg:aP,inline:!0})," ",(0,qt.jsx)(pr,{svg:bS,inline:!0})," ",(0,qt.jsx)(pr,{svg:wS,inline:!0})," ",(0,qt.jsx)(pr,{svg:_S,inline:!0})," to color, create components, remove from components, or undo actions."]})}),(0,qt.jsx)(e0,{selectOnly:!0})]})})]});else if(Ax.has(this.state.action)&&this.state.helper==="residue-list"){let o=()=>this.setState({action:void 0,helper:void 0});n=(0,qt.jsx)("div",{className:"msp-selection-viewport-controls-actions",children:(0,qt.jsx)(Ua,{header:"Atom/Residue Identifier List",title:"Click to close.",initialExpanded:!0,hideExpander:!0,hideOffset:!0,onHeaderClick:o,topRightIcon:ml,children:(0,qt.jsx)(JOe,{modifier:this.state.action,plugin:this.plugin,close:o})})})}return(0,qt.jsxs)(qt.Fragment,{children:[(0,qt.jsxs)("div",{className:"msp-flex-row",style:{background:"none"},children:[(0,qt.jsx)(Dm,{title:"Picking Level for selecting and highlighting",param:$Oe.granularity,name:"granularity",value:e,onChange:this.setGranuality,isDisabled:this.isDisabled}),(0,qt.jsx)(Gn,{icon:gS,title:`${Ax.get("add")}. Hold shift key to keep menu open.`,toggle:this.toggleAdd,isSelected:this.state.action==="add",disabled:this.isDisabled}),(0,qt.jsx)(Gn,{icon:yS,title:`${Ax.get("remove")}. Hold shift key to keep menu open.`,toggle:this.toggleRemove,isSelected:this.state.action==="remove",disabled:this.isDisabled}),(0,qt.jsx)(Gn,{icon:vS,title:`${Ax.get("intersect")}. Hold shift key to keep menu open.`,toggle:this.toggleIntersect,isSelected:this.state.action==="intersect",disabled:this.isDisabled}),(0,qt.jsx)(Gn,{icon:yy,title:`${Ax.get("set")}. Hold shift key to keep menu open.`,toggle:this.toggleSet,isSelected:this.state.action==="set",disabled:this.isDisabled}),(0,qt.jsx)(Gn,{icon:aP,title:"Apply Theme to Selection",toggle:this.toggleTheme,isSelected:this.state.action==="theme",disabled:this.isDisabled,style:{marginLeft:"10px"}}),(0,qt.jsx)(Gn,{icon:bS,title:"Create Component of Selection with Representation",toggle:this.toggleAddComponent,isSelected:this.state.action==="add-component",disabled:this.isDisabled}),(0,qt.jsx)(pt,{svg:wS,title:"Remove/subtract Selection from all Components",onClick:this.subtract,disabled:this.isDisabled}),(0,qt.jsx)(pt,{svg:_S,onClick:this.undo,disabled:!this.state.canUndo||this.isDisabled,title:r}),(0,qt.jsx)(Gn,{icon:Bs,title:"Show/hide help",toggle:this.toggleHelp,style:{marginLeft:"10px"},isSelected:this.state.action==="help"}),this.plugin.config.get(Wt.Viewport.ShowSelectionMode)&&(0,qt.jsx)(pt,{svg:xS,title:"Turn selection mode off",onClick:this.turnOff})]}),n]})}},jD=class extends Mt{constructor(){super(...arguments),this.state={isEmpty:!0,isBusy:!1},this.clear=()=>this.plugin.managers.interactivity.lociSelects.deselectAll(),this.focus=()=>{if(this.plugin.managers.structure.selection.stats.elementCount===0)return;let{sphere:e}=this.plugin.managers.structure.selection.getBoundary();this.plugin.managers.camera.focusSphere(e)},this.highlight=e=>{this.plugin.managers.interactivity.lociHighlights.clearHighlights(),this.plugin.managers.structure.selection.entries.forEach(r=>{this.plugin.managers.interactivity.lociHighlights.highlight({loci:r.selection},!1)})},this.clearHighlight=()=>{this.plugin.managers.interactivity.lociHighlights.clearHighlights()}}componentDidMount(){this.subscribe(this.plugin.managers.structure.selection.events.changed,()=>{this.forceUpdate()}),this.subscribe(this.plugin.managers.structure.hierarchy.behaviors.selection,e=>{let r=e.structures.length===0;this.state.isEmpty!==r&&this.setState({isEmpty:r})}),this.subscribe(this.plugin.behaviors.state.isBusy,e=>{this.setState({isBusy:e})})}get isDisabled(){return this.state.isBusy||this.state.isEmpty}get stats(){let e=this.plugin.managers.structure.selection.stats;return e.structureCount===0||e.elementCount===0?"Nothing Selected":`${sd(e.label)} Selected`}render(){let e=this.plugin.managers.structure.selection.stats,r=e.structureCount===0||e.elementCount===0;return r&&this.props.hideOnEmpty?null:(0,qt.jsx)(qt.Fragment,{children:(0,qt.jsxs)("div",{className:"msp-flex-row",children:[(0,qt.jsx)(vt,{noOverflow:!0,onClick:this.focus,title:"Click to Focus Selection",disabled:r,onMouseEnter:this.highlight,onMouseLeave:this.clearHighlight,style:{textAlignLast:r?void 0:"left"},children:this.stats}),!r&&(0,qt.jsx)(pt,{svg:xS,onClick:this.clear,title:"Clear",className:"msp-form-control",flex:!0})]})})}},zV=class extends Kn{constructor(){super(...arguments),this._params=Js(e=>ql.getThemeParams(this.plugin,e)),this.state={values:g.getDefaultValues(this.params)},this.apply=()=>{var e,r;this.plugin.managers.structure.component.applyTheme(this.state.values,this.plugin.managers.structure.hierarchy.current.structures),(r=(e=this.props).onApply)===null||r===void 0||r.call(e)},this.paramsChanged=e=>this.setState({values:e})}get params(){return this._params(this.plugin.managers.structure.component.pivotStructure)}render(){return(0,qt.jsxs)(qt.Fragment,{children:[(0,qt.jsx)(Hr,{params:this.params,values:this.state.values,onChangeValues:this.paramsChanged}),(0,qt.jsx)(vt,{icon:aP,className:"msp-btn-commit msp-btn-commit-on",onClick:this.apply,style:{marginTop:"1px"},children:"Apply Theme"})]})}},Qle={idType:g.Select("auth",g.arrayToOptions(["auth","label","atom-id"])),identifiers:g.Text("",{description:"A comma separated list of atom identifiers (e.g. 10, 15-25) or residue ranges in given chain (e.g. A 10-15, B 25, C 30:i)"})},ZOe=g.getDefaultValues(Qle);function JOe({modifier:t,plugin:e,close:r}){let[n,o]=Yle.useState(ZOe),i=()=>{if(n.identifiers.trim().length!==0)try{r();let a=Xle(n.identifiers,n.idType);e.managers.structure.selection.fromCompiledQuery(t,a,!1)}catch(a){console.error(a),e.log.error("Failed to create selection")}};return(0,qt.jsxs)(qt.Fragment,{children:[(0,qt.jsx)(Hr,{params:Qle,values:n,onChangeValues:o,onEnter:i}),(0,qt.jsxs)(vt,{className:"msp-btn-commit msp-btn-commit-on",disabled:n.identifiers.trim().length===0,onClick:i,style:{marginTop:"1px"},children:[m0(t)," Selection"]})]})}var HD=class extends hl{defaultState(){return{isCollapsed:!1,header:"Measurements",brand:{accent:"gray",svg:SJ}}}renderControls(){return(0,gr.jsxs)(gr.Fragment,{children:[(0,gr.jsx)(GV,{}),(0,gr.jsx)(UV,{})]})}},UV=class extends Kn{componentDidMount(){this.subscribe(this.plugin.managers.structure.measurement.behaviors.state,()=>{this.forceUpdate()})}renderGroup(e,r){let n=[];for(let o of e)o.obj&&n.push((0,gr.jsx)(HV,{cell:o},o.obj.id));return n.length?(0,gr.jsx)(Ci,{header:r,initiallyExpanded:!0,children:n}):null}render(){let e=this.plugin.managers.structure.measurement.state;return(0,gr.jsxs)("div",{style:{marginTop:"6px"},children:[this.renderGroup(e.labels,"Labels"),this.renderGroup(e.distances,"Distances"),this.renderGroup(e.angles,"Angles"),this.renderGroup(e.dihedrals,"Dihedrals"),this.renderGroup(e.orientations,"Orientations"),this.renderGroup(e.planes,"Planes")]})}},GV=class extends Kn{constructor(){super(...arguments),this.state={isBusy:!1,action:void 0},this.measureDistance=()=>{let e=this.plugin.managers.structure.selection.additionsHistory;this.plugin.managers.structure.measurement.addDistance(e[0].loci,e[1].loci)},this.measureAngle=()=>{let e=this.plugin.managers.structure.selection.additionsHistory;this.plugin.managers.structure.measurement.addAngle(e[0].loci,e[1].loci,e[2].loci)},this.measureDihedral=()=>{let e=this.plugin.managers.structure.selection.additionsHistory;this.plugin.managers.structure.measurement.addDihedral(e[0].loci,e[1].loci,e[2].loci,e[3].loci)},this.addLabel=()=>{let e=this.plugin.managers.structure.selection.additionsHistory;this.plugin.managers.structure.measurement.addLabel(e[0].loci)},this.addOrientation=()=>{let e=[];this.plugin.managers.structure.selection.entries.forEach(r=>{e.push(r.selection)}),this.plugin.managers.structure.measurement.addOrientation(e)},this.addPlane=()=>{let e=[];this.plugin.managers.structure.selection.entries.forEach(r=>{e.push(r.selection)}),this.plugin.managers.structure.measurement.addPlane(e)},this.selectAction=e=>{this.toggleAdd(),e&&(0,e?.value)()},this.toggleAdd=()=>this.setState({action:this.state.action==="add"?void 0:"add"}),this.toggleOptions=()=>this.setState({action:this.state.action==="options"?void 0:"options"})}componentDidMount(){this.subscribe(this.selection.events.additionsHistoryUpdated,()=>{this.forceUpdate(),this.updateOrderLabels()}),this.subscribe(this.plugin.behaviors.state.isBusy,e=>{this.setState({isBusy:e})})}componentWillUnmount(){this.clearOrderLabels(),super.componentWillUnmount()}componentDidUpdate(e,r){this.state.action!==r.action&&this.updateOrderLabels()}clearOrderLabels(){this.plugin.managers.structure.measurement.addOrderLabels([])}updateOrderLabels(){if(this.state.action!=="add"){this.clearOrderLabels();return}let e=[],r=this.selection.additionsHistory;for(let n=0;n<r.length&&n<4;n++)e.push(r[n].loci);this.plugin.managers.structure.measurement.addOrderLabels(e)}get selection(){return this.plugin.managers.structure.selection}get actions(){let e=this.selection.additionsHistory;return[{kind:"item",label:`Label ${e.length===0?" (1 selection item required)":" (1st selection item)"}`,value:this.addLabel,disabled:e.length===0},{kind:"item",label:`Distance ${e.length<2?" (2 selection items required)":" (top 2 selection items)"}`,value:this.measureDistance,disabled:e.length<2},{kind:"item",label:`Angle ${e.length<3?" (3 selection items required)":" (top 3 items)"}`,value:this.measureAngle,disabled:e.length<3},{kind:"item",label:`Dihedral ${e.length<4?" (4 selection items required)":" (top 4 selection items)"}`,value:this.measureDihedral,disabled:e.length<4},{kind:"item",label:`Orientation ${e.length===0?" (selection required)":" (current selection)"}`,value:this.addOrientation,disabled:e.length===0},{kind:"item",label:`Plane ${e.length===0?" (selection required)":" (current selection)"}`,value:this.addPlane,disabled:e.length===0}]}highlight(e){this.plugin.managers.interactivity.lociHighlights.highlightOnly({loci:e},!1)}moveHistory(e,r){this.plugin.managers.structure.selection.modifyHistory(e,r,4)}focusLoci(e){this.plugin.managers.camera.focusLoci(e)}historyEntry(e,r){let n=this.plugin.managers.structure.selection.additionsHistory;return(0,gr.jsxs)("div",{className:"msp-flex-row",onMouseEnter:()=>this.highlight(e.loci),onMouseLeave:()=>this.plugin.managers.interactivity.lociHighlights.clearHighlights(),children:[(0,gr.jsxs)(vt,{noOverflow:!0,title:"Click to focus. Hover to highlight.",onClick:()=>this.focusLoci(e.loci),style:{width:"auto",textAlign:"left"},children:[r,". ",(0,gr.jsx)("span",{dangerouslySetInnerHTML:{__html:e.label}})]}),n.length>1&&(0,gr.jsx)(pt,{svg:Ph,small:!0,className:"msp-form-control",onClick:()=>this.moveHistory(e,"up"),flex:"20px",title:"Move up"}),n.length>1&&(0,gr.jsx)(pt,{svg:_h,small:!0,className:"msp-form-control",onClick:()=>this.moveHistory(e,"down"),flex:"20px",title:"Move down"}),(0,gr.jsx)(pt,{svg:Hi,small:!0,className:"msp-form-control",onClick:()=>this.plugin.managers.structure.selection.modifyHistory(e,"remove"),flex:!0,title:"Remove"})]},e.id)}add(){let e=this.plugin.managers.structure.selection.additionsHistory,r=[];for(let i=0,a=Math.min(e.length,4);i<a;i++)r.push(this.historyEntry(e[i],i+1));let o=this.plugin.config.get(Wt.Viewport.ShowSelectionMode)?(0,gr.jsxs)(gr.Fragment,{children:[" ","(toggle ",(0,gr.jsx)(hg,{inline:!0})," mode)"]}):null;return(0,gr.jsxs)(gr.Fragment,{children:[(0,gr.jsx)(wt,{items:this.actions,onSelect:this.selectAction}),r.length>0&&(0,gr.jsx)("div",{className:"msp-control-offset",children:r}),r.length===0&&(0,gr.jsx)("div",{className:"msp-control-offset msp-help-text",children:(0,gr.jsxs)("div",{className:"msp-help-description",children:[(0,gr.jsx)(pr,{svg:Bs,inline:!0}),"Add one or more selections",o]})})]})}render(){return(0,gr.jsxs)(gr.Fragment,{children:[(0,gr.jsxs)("div",{className:"msp-flex-row",children:[(0,gr.jsx)(Gn,{icon:Fd,label:"Add",toggle:this.toggleAdd,isSelected:this.state.action==="add",disabled:this.state.isBusy,className:"msp-btn-apply-simple"}),(0,gr.jsx)(Gn,{icon:pl,label:"",title:"Options",toggle:this.toggleOptions,isSelected:this.state.action==="options",disabled:this.state.isBusy,style:{flex:"0 0 40px",padding:0}})]}),this.state.action==="add"&&this.add(),this.state.action==="options"&&(0,gr.jsx)(jV,{})]})}},jV=class extends Kn{constructor(){super(...arguments),this.state={isDisabled:!1},this.changed=e=>{this.plugin.managers.structure.measurement.setOptions(e)}}componentDidMount(){this.subscribe(this.plugin.managers.structure.measurement.behaviors.state,()=>{this.forceUpdate()}),this.subscribe(this.plugin.behaviors.state.isBusy,e=>{this.setState({isDisabled:e})})}render(){let e=this.plugin.managers.structure.measurement.state;return(0,gr.jsx)("div",{className:"msp-control-offset",children:(0,gr.jsx)(Hr,{params:JB,values:e.options,onChangeValues:this.changed,isDisabled:this.state.isDisabled})})}},HV=class extends Kn{constructor(){super(...arguments),this.state={showUpdate:!1},this.delete=()=>{Re.State.RemoveObject(this.plugin,{state:this.props.cell.parent,ref:this.props.cell.transform.parent,removeParentGhosts:!0})},this.toggleVisibility=e=>{e.preventDefault(),Re.State.ToggleVisibility(this.plugin,{state:this.props.cell.parent,ref:this.props.cell.transform.parent}),e.currentTarget.blur()},this.highlight=()=>{var e;if(!this.selections)return;this.plugin.managers.interactivity.lociHighlights.clearHighlights();for(let o of this.lociArray)this.plugin.managers.interactivity.lociHighlights.highlight({loci:o},!1);let n=(e=this.props.cell.obj)===null||e===void 0?void 0:e.data.repr.getAllLoci();if(n)for(let o of n)this.plugin.managers.interactivity.lociHighlights.highlight({loci:o},!1)},this.clearHighlight=()=>{this.plugin.managers.interactivity.lociHighlights.clearHighlights()},this.toggleUpdate=()=>this.setState({showUpdate:!this.state.showUpdate}),this.focus=()=>{if(!this.selections)return;let r=st.getBundleBoundingSphere({loci:this.lociArray});r&&this.plugin.managers.camera.focusSphere(r)},this.selectAction=e=>{e&&(this.setState({showUpdate:!1}),(0,e?.value)())}}componentDidMount(){this.subscribe(this.plugin.state.events.cell.stateUpdated,e=>{this.forceUpdate()})}get selections(){var e;return(e=this.props.cell.obj)===null||e===void 0?void 0:e.data.sourceData}get lociArray(){let e=this.selections;return e?e.infos?[e.infos[0].loci]:e.pairs?e.pairs[0].loci:e.triples?e.triples[0].loci:e.quads?e.quads[0].loci:e.locis?e.locis:[]:[]}get label(){let e=this.selections;return e?e.infos?fu(e.infos[0].loci,{condensed:!0}):e.pairs?bv(e.pairs[0],{condensed:!0,unitLabel:this.plugin.managers.structure.measurement.state.options.distanceUnitLabel}):e.triples?xv(e.triples[0],{condensed:!0}):e.quads?Sv(e.quads[0],{condensed:!0}):e.locis?qf(e.locis,{countsOnly:!0}):"<empty>":"<empty>"}get actions(){return this.props.cell.sourceRef,[wt.Item("Select This",()=>this.plugin.managers.structure.selection.fromSelections(this.props.cell.sourceRef),{icon:yy})]}render(){let{cell:e}=this.props,{obj:r}=e;return r?(0,gr.jsxs)(gr.Fragment,{children:[(0,gr.jsxs)("div",{className:"msp-flex-row",onMouseEnter:this.highlight,onMouseLeave:this.clearHighlight,children:[(0,gr.jsx)("button",{className:"msp-form-control msp-control-button-label msp-no-overflow",title:"Click to focus. Hover to highlight.",onClick:this.focus,style:{width:"auto",textAlign:"left"},children:(0,gr.jsx)("span",{dangerouslySetInnerHTML:{__html:this.label}})}),(0,gr.jsx)(pt,{svg:e.state.isHidden?Ec:Ic,toggleState:!1,small:!0,className:"msp-form-control",onClick:this.toggleVisibility,flex:!0,title:e.state.isHidden?"Show":"Hide"}),(0,gr.jsx)(pt,{svg:Hi,small:!0,className:"msp-form-control",onClick:this.delete,flex:!0,title:"Delete",toggleState:!1}),(0,gr.jsx)(pt,{svg:Pu,className:"msp-form-control",onClick:this.toggleUpdate,flex:!0,title:"Actions",toggleState:this.state.showUpdate})]},r.id),this.state.showUpdate&&e.parent&&(0,gr.jsx)(gr.Fragment,{children:(0,gr.jsxs)("div",{className:"msp-accent-offset",children:[(0,gr.jsx)(wt,{items:this.actions,onSelect:this.selectAction,noOffset:!0}),(0,gr.jsx)(Ci,{header:"Options",noOffset:!0,children:(0,gr.jsx)(Xs,{state:e.parent,transform:e.transform,customHeader:"none",autoHideApply:!0})})]})})]}):null}};var ps=Ot(Or());var Qm=Ot(Or());function qV(t,e,r,n){let o=tr.indexOf(e.unit.elements,e.element),i=z.Loci(e.structure,[{unit:e.unit,indices:we.ofSingleton(o)}]),a=n==="residue"?z.Loci.extendToWholeResidues(i):z.Loci.extendToWholeChains(i),s=Ne.entity.pdbx_description(e).join(", ");for(let l of r.units){let c=z.Loci(a.structure,[{unit:l,indices:a.elements[0].indices}]),u=fu(c,{reverse:!0,hidePrefix:!0,htmlStyling:!1,granularity:n});u||(u=fu(c,{hidePrefix:!1,htmlStyling:!1})),r.units.length>1&&(u+=` | ${c.elements[0].unit.conformation.operator.name}`);let d={label:u,category:s,loci:c};t.has(s)?t.get(s).push(d):t.set(s,[d])}}function eFe(t){let e=new Map,r=z.Location.create(t);for(let o of t.unitSymmetryGroups){if(!Pe.isAtomic(o.units[0]))continue;r.unit=o.units[0],r.element=o.elements[0];let i=Pe.Traits.is(r.unit.traits,Pe.Trait.MultiChain),a=Ne.entity.type(r),s=a==="non-polymer",l=a==="branched";if(!!Ne.entity.prd_id(r))qV(e,r,o,"chain");else if(s&&!i)qV(e,r,o,"residue");else if(l||s&&i){let u=r.unit,{index:d}=u.model.atomicHierarchy.residueAtomSegments,m=-1;for(let p=0,h=u.elements.length;p<h;++p){let f=u.elements[p],b=d[f];b!==m&&(r.element=f,qV(e,r,o,"residue"),m=b)}}}let n=[];return e.forEach((o,i)=>{o.length===1?n.push({label:`${i}: ${o[0].label}`,loci:o[0].loci}):o.length<2e3&&n.push(...o)}),n}var qD=class extends Mt{constructor(){super(...arguments),this.state={isBusy:!1,showAction:!1},this.getSelectionItems=Js(e=>{var r;let n=[];for(let o of e){let i=(r=o.cell.obj)===null||r===void 0?void 0:r.data;if(i){let a=eFe(i);a.length>0&&n.push([wt.Header(i.label,{description:i.label}),...wt.createItems(a,{label:s=>s.label,category:s=>s.category,description:s=>s.label})])}}return n}),this.selectAction=(e,r)=>{if(!e||!this.state.showAction){this.setState({showAction:!1});return}let n=e.value;r?.shiftKey?this.plugin.managers.structure.focus.addFromLoci(n.loci):this.plugin.managers.structure.focus.set(n),this.focusCamera()},this.toggleAction=()=>this.setState({showAction:!this.state.showAction}),this.focusCamera=()=>{let{current:e}=this.plugin.managers.structure.focus;e&&this.plugin.managers.camera.focusLoci(e.loci)},this.clear=()=>{this.plugin.managers.structure.focus.clear(),this.plugin.managers.camera.reset()},this.highlightCurrent=()=>{let{current:e}=this.plugin.managers.structure.focus;e&&this.plugin.managers.interactivity.lociHighlights.highlightOnly({loci:e.loci},!1)},this.clearHighlights=()=>{this.plugin.managers.interactivity.lociHighlights.clearHighlights()}}componentDidMount(){this.subscribe(this.plugin.managers.structure.focus.behaviors.current,e=>{this.getSelectionItems([]),this.forceUpdate()}),this.subscribe(this.plugin.managers.structure.focus.events.historyUpdated,e=>{this.forceUpdate()}),this.subscribe(this.plugin.behaviors.state.isBusy,e=>{this.setState({isBusy:e,showAction:!1})})}get isDisabled(){return this.state.isBusy||this.plugin.managers.structure.hierarchy.selection.structures.length===0}get actionItems(){let e=[],{history:r}=this.plugin.managers.structure.focus;r.length>0&&e.push([wt.Header("History",{description:"Previously focused on items."}),...wt.createItems(r,{label:i=>i.label,description:i=>i.category&&i.label!==i.category?`${i.category} | ${i.label}`:i.label})]);let n=this.getSelectionItems(this.plugin.managers.structure.hierarchy.selection.structures);if(n.length===1){let a=n[0][0];a.initiallyExpanded=!0}let o=[];return n.length>0&&o.push(...n),e.length>0&&o.push(...e),o}getToggleBindingLabel(){var e;let r=this.plugin.state.behaviors.transforms.get(ly.id);if(!r)return"";let n=(e=r.params)===null||e===void 0?void 0:e.bindings.clickFocus;return!n||Xe.isEmpty(n)?"":Xe.formatTriggers(n)}render(){let{current:e}=this.plugin.managers.structure.focus,r=e?.label||"Nothing Focused",n="Click to Center Camera";if(!e){n="Select focus using the menu";let o=this.getToggleBindingLabel();o&&(n+=`
or use '${o}' on element`)}return(0,Qm.jsxs)(Qm.Fragment,{children:[(0,Qm.jsxs)("div",{className:"msp-flex-row",children:[(0,Qm.jsx)(vt,{noOverflow:!0,onClick:this.focusCamera,title:n,onMouseEnter:this.highlightCurrent,onMouseLeave:this.clearHighlights,disabled:this.isDisabled||!e,style:{textAlignLast:e?"left":void 0},children:r}),e&&(0,Qm.jsx)(pt,{svg:xS,onClick:this.clear,title:"Clear",className:"msp-form-control",flex:!0,disabled:this.isDisabled}),(0,Qm.jsx)(Gn,{icon:EJ,title:"Select a focus target to center on an show its surroundings. Hold shift to focus on multiple targets.",toggle:this.toggleAction,isSelected:this.state.showAction,disabled:this.isDisabled,style:{flex:"0 0 40px",padding:0}})]}),this.state.showAction&&(0,Qm.jsx)(wt,{items:this.actionItems,onSelect:this.selectAction})]})}};var WD=class extends hl{constructor(){super(...arguments),this.item=e=>{var r,n,o,i,a,s,l,c,u;let d=this.plugin.managers.structure.hierarchy.seletionSet,m;switch(e.kind){case"model":{let h=(r=e.cell.obj)===null||r===void 0?void 0:r.data;h&&Et.TrajectoryInfo.get(h).size>1&&(m=`${(n=e.cell.obj)===null||n===void 0?void 0:n.data.entryId} | Model ${Et.TrajectoryInfo.get(h).index+1} of ${Et.TrajectoryInfo.get(h).size}`),m=`${(o=e.cell.obj)===null||o===void 0?void 0:o.data.entryId} | ${(i=e.cell.obj)===null||i===void 0?void 0:i.label}`;break}case"structure":{let h=(a=e.cell.obj)===null||a===void 0?void 0:a.data.models[0];if(h&&Et.TrajectoryInfo.get(h).size>1){m=`${h.entryId} | ${(s=e.cell.obj)===null||s===void 0?void 0:s.label} (Model ${Et.TrajectoryInfo.get(h).index+1} of ${Et.TrajectoryInfo.get(h).size})`;break}else if(h){m=`${h.entryId} | ${(l=e.cell.obj)===null||l===void 0?void 0:l.label}`;break}else{m=`${(c=e.cell.obj)===null||c===void 0?void 0:c.label}`;break}}default:m=(u=e.cell.obj)===null||u===void 0?void 0:u.label;break}return{kind:"item",label:m||e.kind,selected:d.has(e.cell.transform.ref),value:[e]}},this.getTrajectoryItems=e=>{var r;return e.models.length===0?this.item(e):[wt.Header((r=e.cell.obj)===null||r===void 0?void 0:r.label),...e.models.map(this.getModelItems)]},this.getModelItems=e=>{var r,n,o;if(e.structures.length===0)return this.item(e);if(e.structures.length===1){let i=this.plugin.managers.structure.hierarchy.seletionSet,a=e.structures[0];return{label:`${(r=e.cell.obj)===null||r===void 0?void 0:r.label} | ${(n=a.cell.obj)===null||n===void 0?void 0:n.label}`,selected:i.has(a.cell.transform.ref),value:[e,a]}}return[wt.Header((o=e.cell.obj)===null||o===void 0?void 0:o.label),...e.structures.map(this.item)]},this.selectHierarchy=e=>{if(!e||e.length===0)return;let r=[];for(let n of e)for(let o of n.value)r.push(o);this.plugin.managers.structure.hierarchy.updateCurrent(r,e[0].selected?"remove":"add")},this.toggleHierarchy=()=>this.setState({show:this.state.show!=="hierarchy"?"hierarchy":void 0}),this.togglePreset=()=>this.setState({show:this.state.show!=="presets"?"presets":void 0}),this.applyPreset=e=>{if(this.setState({show:void 0}),!e)return;let r=this.plugin.managers.structure,{trajectories:n}=r.hierarchy.selection;r.hierarchy.applyPreset(n,e.value)},this.updateModelQueueParams=void 0,this.isUpdatingModel=!1,this.updateStructureModel=e=>{this.updateModelQueueParams=e,this._updateStructureModel()},this.updateStructure=e=>{let{selection:r}=this.plugin.managers.structure.hierarchy,n=r.structures[0];return this.plugin.managers.structure.hierarchy.updateStructure(n,e)}}defaultState(){return{header:"Structure",isCollapsed:!1,isBusy:!1,brand:{accent:"purple",svg:bJ}}}componentDidMount(){this.subscribe(this.plugin.managers.structure.hierarchy.behaviors.selection,()=>this.forceUpdate()),this.subscribe(this.plugin.behaviors.state.isBusy,e=>{this.setState({isBusy:e})})}get hierarchyItems(){let e=this.plugin.managers.structure.hierarchy,{current:r}=e,n=[];return r.trajectories.length>1&&n.push([wt.Header("Trajectories"),...r.trajectories.map(this.item)]),(r.models.length>1||r.trajectories.length>1)&&n.push([wt.Header("Models"),...r.models.map(this.item)]),r.trajectories.length===1&&r.models.length===1?n.push(...r.structures.map(this.item)):r.structures.length>0&&n.push([wt.Header("Structures"),...r.structures.map(this.item)]),n}get isEmpty(){let{structures:e,models:r,trajectories:n}=this.plugin.managers.structure.hierarchy.current;return n.length===0&&r.length===0&&e.length===0}get label(){var e,r,n,o,i,a,s,l,c,u,d,m,p,h;let{structures:f,models:b,trajectories:v}=this.plugin.managers.structure.hierarchy.selection;if(f.length===1){let x=f[0];return!((r=(e=x.model)===null||e===void 0?void 0:e.trajectory)===null||r===void 0)&&r.models&&x.model.trajectory.models.length===1?(n=x.cell.obj)===null||n===void 0?void 0:n.data.label:x.model?`${(o=x.model.cell.obj)===null||o===void 0?void 0:o.label} | ${(i=x.cell.obj)===null||i===void 0?void 0:i.data.label}`:(a=x.cell.obj)===null||a===void 0?void 0:a.data.label}if(f.length>1){let x=f[0],S=(s=x?.model)===null||s===void 0?void 0:s.trajectory,T=!0;for(let E of f)if(((l=E?.model)===null||l===void 0?void 0:l.trajectory)!==S){T=!1;break}return T&&S?`${(c=S.cell.obj)===null||c===void 0?void 0:c.label} | ${f.length} structures`:`${f.length} structures`}if(b.length>0){let x=b[0].trajectory;if(b.length===1){let T=(u=b[0].cell.obj)===null||u===void 0?void 0:u.data;return T&&Et.TrajectoryInfo.get(T).size>1?`${(d=x?.cell.obj)===null||d===void 0?void 0:d.label} | Model ${Et.TrajectoryInfo.get(T).index+1} of ${Et.TrajectoryInfo.get(T).size}`:`${(m=x?.cell.obj)===null||m===void 0?void 0:m.label} | Model`}let S=!0;for(let T of b)if(T.trajectory!==x){S=!1;break}return S?`${(p=x?.cell.obj)===null||p===void 0?void 0:p.label} | ${b.length} models`:`${b.length} models`}return v.length>0?v.length===1?`${(h=v[0].cell.obj)===null||h===void 0?void 0:h.label} trajectory`:`${v.length} trajectories`:v.length===0&&b.length===0&&f.length===0?"Nothing Loaded":"Nothing Selected"}get presetActions(){let e=[],{trajectories:r}=this.plugin.managers.structure.hierarchy.selection;if(r.length===0)return e;let n=this.plugin.builders.structure.hierarchy.getPresets(r[0].cell.obj);if(r.length>1){let o=new Set(n);for(let i=1;i<r.length;i++){let a=this.plugin.builders.structure.hierarchy.getPresets(r[i].cell.obj),s=new Set(a);for(let l of a)s.has(l)||o.delete(l)}n=n.filter(i=>o.has(i))}for(let o of n)e.push(wt.Item(o.display.name,o,{description:o.display.description}));return e}_updateStructureModel(){return N(this,null,function*(){if(!this.updateModelQueueParams||this.isUpdatingModel)return;let e=this.updateModelQueueParams;this.updateModelQueueParams=void 0;try{this.isUpdatingModel=!0;let{selection:r}=this.plugin.managers.structure.hierarchy,n=r.structures[0].model;yield this.plugin.state.updateTransform(this.plugin.state.data,n.cell.transform.ref,e,"Model Index")}finally{this.isUpdatingModel=!1,this._updateStructureModel()}})}get modelIndex(){var e,r;let{selection:n}=this.plugin.managers.structure.hierarchy;if(n.structures.length!==1)return null;let o=n.structures[0].model;if(!o||o.cell.transform.transformer!==de.Model.ModelFromTrajectory||!o.cell.obj||Et.TrajectoryInfo.get(o.cell.obj.data).size<=1)return null;let i=(e=o.cell.params)===null||e===void 0?void 0:e.definition;return i?(0,ps.jsx)(Hr,{params:i,values:(r=o.cell.params)===null||r===void 0?void 0:r.values,onChangeValues:this.updateStructureModel,isDisabled:this.state.isBusy}):null}get structureType(){var e;let{selection:r}=this.plugin.managers.structure.hierarchy;if(r.structures.length!==1)return null;let n=r.structures[0];return!((e=n.cell.params)===null||e===void 0?void 0:e.definition)||!n.cell.parent?null:(0,ps.jsx)(Xs,{state:n.cell.parent,transform:n.cell.transform,customHeader:"none",customUpdate:this.updateStructure,noMargin:!0,autoHideApply:!0})}get transform(){let{selection:e}=this.plugin.managers.structure.hierarchy;if(e.structures.length!==1)return null;let r=e.structures[0];if(!r.cell.parent)return null;let n=lt.tryFindDecorator(this.plugin.state.data,r.cell.transform.ref,de.Model.TransformStructureConformation);if(n)return(0,ps.jsx)(Ci,{header:"Conformation Transform",children:(0,ps.jsx)(Xs,{state:n.parent,transform:n.transform,customHeader:"none",noMargin:!0,autoHideApply:!0})})}renderControls(){let e=this.state.isBusy||this.isEmpty,r=this.presetActions,n=this.label;return(0,ps.jsxs)(ps.Fragment,{children:[(0,ps.jsxs)("div",{className:"msp-flex-row",style:{marginTop:"1px"},children:[(0,ps.jsx)(vt,{noOverflow:!0,flex:!0,onClick:this.toggleHierarchy,disabled:e,title:n,children:n}),r.length>0&&(0,ps.jsx)(pt,{svg:Mp,className:"msp-form-control",flex:"40px",onClick:this.togglePreset,title:"Apply a structure presets to the current hierarchy.",toggleState:this.state.show==="presets",disabled:e})]}),this.state.show==="hierarchy"&&(0,ps.jsx)(wt,{items:this.hierarchyItems,onSelect:this.selectHierarchy,multiselect:!0}),this.state.show==="presets"&&(0,ps.jsx)(wt,{items:r,onSelect:this.applyPreset}),this.modelIndex,this.structureType,this.transform,(0,ps.jsxs)("div",{style:{marginTop:"6px"},children:[(0,ps.jsx)(qD,{}),(0,ps.jsx)(jD,{hideOnEmpty:!0})]})]})}};var En=Ot(Or());var gg=class extends Ix{constructor(){super(...arguments),this._getInfo=Js((e,r,n)=>$d.infoFromAction(this.plugin,this.props.state,this.props.action,this.props.nodeRef)),this.state={plugin:this.plugin,ref:this.props.nodeRef,version:this.props.state.transforms.get(this.props.nodeRef).version,error:void 0,isInitial:!0,params:this.getInfo().initialValues,busy:!1,isCollapsed:this.props.initiallyCollapsed}}applyAction(){return Re.State.ApplyAction(this.plugin,{state:this.props.state,action:this.props.action.create(this.state.params),ref:this.props.nodeRef})}getInfo(){var e;return this._getInfo(this.props.nodeRef,this.props.state.transforms.get(this.props.nodeRef).version,(e=this.state)===null||e===void 0?void 0:e.isCollapsed)}getTransformerId(){return this.props.state.transforms.get(this.props.nodeRef).transformer.id}getHeader(){return this.props.hideHeader?"none":this.props.action.definition.display}canApply(){return!this.state.error&&!this.state.busy}canAutoApply(){return!1}applyText(){return"Apply"}isUpdate(){return!1}getSourceAndTarget(){return{a:this.props.state.cells.get(this.props.nodeRef).obj}}static getDerivedStateFromProps(e,r){let n=e.state.transforms.get(e.nodeRef).version;if(e.nodeRef===r.ref&&n===r.version)return null;let o=e.state.cells.get(e.nodeRef).obj,i=e.action.definition.params?g.getDefaultValues(e.action.definition.params(o,r.plugin)):{};return{plugin:r.plugin,ref:e.nodeRef,version:n,params:i,isInitial:!0,error:void 0}}};var XD=class extends hl{defaultState(){return{header:"Volume Streaming",isCollapsed:!1,isBusy:!1,isHidden:!0,brand:{accent:"cyan",svg:sB}}}componentDidMount(){this.subscribe(this.plugin.managers.structure.hierarchy.behaviors.selection,()=>{this.setState({isHidden:!this.canEnable(),description:km.getSelectedStructuresDescription(this.plugin)})}),this.subscribe(this.plugin.state.events.cell.stateUpdated,e=>{kt.hasTag(e.cell.transform,di.RootTag)&&this.forceUpdate()}),this.subscribe(this.plugin.behaviors.state.isBusy,e=>{this.setState({isBusy:e})})}get pivot(){return this.plugin.managers.structure.hierarchy.selection.structures[0]}canEnable(){var e,r;let{selection:n}=this.plugin.managers.structure.hierarchy;if(n.structures.length!==1)return!1;let o=this.pivot.cell;return o.obj?!!(!((r=(e=q1.definition).isApplicable)===null||r===void 0)&&r.call(e,o.obj,o.transform,this.plugin)):!1}renderEnable(){var e,r;let n=this.pivot;if(!n.cell.parent)return null;let o=lt.findTagInSubtree(n.cell.parent.tree,this.pivot.cell.transform.ref,di.RootTag),i=o&&n.cell.parent.cells.get(o),a=i&&i.status==="error"?{header:i.errorText&&(!((e=i.errorText)===null||e===void 0)&&e.includes("404"))?"No Density Data Available":"Error Enabling",icon:cB,title:i.errorText}:i&&((r=i.obj)===null||r===void 0?void 0:r.data.entries.length)===0?{header:"Error Enabling",icon:cB,title:"No Entry for Streaming Found"}:{header:"Enable",icon:Pc,title:"Enable"};return(0,En.jsx)(gg,{state:n.cell.parent,action:q1,initiallyCollapsed:!0,nodeRef:n.cell.transform.ref,simpleApply:a})}renderParams(){var e,r,n,o,i;let a=this.pivot;if(!a.cell.parent)return null;let s=((r=(e=a.volumeStreaming)===null||e===void 0?void 0:e.cell.transform.params)===null||r===void 0?void 0:r.entry.params.view.name)==="selection-box"&&((i=(o=(n=this.plugin.state.behaviors.cells.get(ly.id))===null||n===void 0?void 0:n.params)===null||o===void 0?void 0:o.values)===null||i===void 0?void 0:i.bindings);return(0,En.jsxs)(En.Fragment,{children:[(0,En.jsx)(Xs,{state:a.cell.parent,transform:a.volumeStreaming.cell.transform,customHeader:"none",noMargin:!0}),s&&(0,En.jsx)(Ci,{header:"Controls Help",children:(0,En.jsx)(Dx,{bindings:s})})]})}renderControls(){let e=this.pivot;return e?e.volumeStreaming?this.renderParams():this.renderEnable():null}},YD=class extends hl{constructor(){super(...arguments),this.item=e=>{var r;let n=this.plugin.managers.volume.hierarchy.selection,o=((r=e.cell.obj)===null||r===void 0?void 0:r.label)||"Volume";return{kind:"item",label:(e.kind==="lazy-volume"?"Load ":"")+(o||e.kind),selected:n===e,value:e}},this.selectCurrent=e=>{if(this.toggleHierarchy(),!e)return;let r=e.value;r.kind==="volume"?this.plugin.managers.volume.hierarchy.setCurrent(r):this.lazyLoad(r.cell)},this.selectAdd=e=>{e&&(this.setState({show:void 0}),e.value())},this.toggleHierarchy=()=>this.setState({show:this.state.show!=="hierarchy"?"hierarchy":void 0}),this.toggleAddRepr=()=>this.setState({show:this.state.show!=="add-repr"?"add-repr":void 0})}defaultState(){return{header:"Volume",isCollapsed:!1,isBusy:!1,isHidden:!0,brand:{accent:"purple",svg:sB}}}componentDidMount(){this.subscribe(this.plugin.managers.volume.hierarchy.behaviors.selection,e=>{this.setState({isHidden:e.hierarchy.volumes.length===0&&e.hierarchy.lazyVolumes.length===0})}),this.subscribe(this.plugin.behaviors.state.isBusy,e=>{this.setState({isBusy:e})})}get hierarchyItems(){let e=this.plugin.managers.volume.hierarchy,{current:r}=e,n=[];for(let o of r.volumes)n.push(this.item(o));for(let o of r.lazyVolumes)n.push(this.item(o));return n}get addActions(){let e=this.plugin.managers.volume.hierarchy,r=e.selection;return[...Dh.getRepresentationTypes(this.plugin,r).map(o=>wt.Item(o[1],()=>e.addRepresentation(r,o[0])))]}get isEmpty(){let{volumes:e,lazyVolumes:r}=this.plugin.managers.volume.hierarchy.current;return e.length===0&&r.length===0}get label(){var e;if(this.state.loadingLabel)return`Loading ${this.state.loadingLabel}...`;let r=this.plugin.managers.volume.hierarchy.selection;return r?((e=r?.cell.obj)===null||e===void 0?void 0:e.label)||"Volume":"Nothing Selected"}lazyLoad(e){return N(this,null,function*(){let{url:r,isBinary:n,format:o,entryId:i,isovalues:a}=e.obj.data;this.setState({isBusy:!0,loadingLabel:e.obj.label});try{let s=this.plugin;yield s.dataTransaction(()=>N(this,null,function*(){var l,c,u,d;let m=yield s.builders.data.download({url:r,isBinary:n},{state:{isGhost:!0}}),p=yield s.dataFormats.get(o).parse(s,m,{entryId:i}),h=p.volume||p.volumes[0];if(!h?.isOk)throw new Error("Failed to parse any volume.");let f=s.build();for(let b of a)f.to((u=(l=p.volumes)===null||l===void 0?void 0:l[(c=b.volumeIndex)!==null&&c!==void 0?c:0])!==null&&u!==void 0?u:p.volume).apply(de.Representation.VolumeRepresentation3D,Bp(this.plugin,h.data,{type:"isosurface",typeParams:{alpha:(d=b.alpha)!==null&&d!==void 0?d:1,isoValue:b.type==="absolute"?{kind:"absolute",absoluteValue:b.value}:{kind:"relative",relativeValue:b.value}},color:"uniform",colorParams:{value:b.color}}));yield f.commit(),yield s.build().delete(e).commit()}))}finally{this.setState({isBusy:!1,loadingLabel:void 0})}})}renderControls(){let e=this.state.isBusy||this.isEmpty,r=this.label,n=this.plugin.managers.volume.hierarchy.selection;return(0,En.jsxs)(En.Fragment,{children:[(0,En.jsxs)("div",{className:"msp-flex-row",style:{marginTop:"1px"},children:[(0,En.jsx)(vt,{noOverflow:!0,flex:!0,onClick:this.toggleHierarchy,disabled:e,title:r,children:r}),!this.isEmpty&&n&&(0,En.jsx)(pt,{svg:Fd,onClick:this.toggleAddRepr,title:"Apply a structure presets to the current hierarchy.",toggleState:this.state.show==="add-repr",disabled:e})]}),this.state.show==="hierarchy"&&(0,En.jsx)(wt,{items:this.hierarchyItems,onSelect:this.selectCurrent}),this.state.show==="add-repr"&&(0,En.jsx)(wt,{items:this.addActions,onSelect:this.selectAdd}),n&&n.representations.length>0&&(0,En.jsx)("div",{style:{marginTop:"6px"},children:n.representations.map(o=>(0,En.jsx)(WV,{representation:o},o.cell.transform.ref))})]})}},WV=class extends Kn{constructor(){super(...arguments),this.state={action:void 0},this.remove=()=>this.plugin.managers.volume.hierarchy.remove([this.props.representation],!0),this.toggleVisible=e=>{e.preventDefault(),e.currentTarget.blur(),this.plugin.managers.volume.hierarchy.toggleVisibility([this.props.representation])},this.toggleColor=()=>{this.setState({action:this.state.action==="select-color"?void 0:"select-color"})},this.toggleUpdate=()=>this.setState({action:this.state.action==="update"?void 0:"update"}),this.highlight=e=>{e.preventDefault(),this.props.representation.cell.parent&&Re.Interactivity.Object.Highlight(this.plugin,{state:this.props.representation.cell.parent,ref:this.props.representation.cell.transform.ref})},this.clearHighlight=e=>{e.preventDefault(),Re.Interactivity.ClearHighlights(this.plugin)},this.focus=()=>{var e;let r=this.props.representation,n=(e=r.cell.obj)===null||e===void 0?void 0:e.data.repr.getAllLoci();r.cell.state.isHidden&&this.plugin.managers.volume.hierarchy.toggleVisibility([this.props.representation],"show"),n&&this.plugin.managers.camera.focusLoci(n,{extraRadius:1})},this.updateColor=({value:e})=>{let r=this.props.representation.cell.transform;return this.plugin.build().to(r.ref).update(U(w({},r.params),{colorTheme:{name:"uniform",params:{value:e}}})).commit()}}componentDidMount(){this.subscribe(this.plugin.state.events.cell.stateUpdated,e=>{Ll.ObjectEvent.isCell(e,this.props.representation.cell)&&this.forceUpdate()})}get color(){var e,r;let n=this.props.representation.cell;if(((e=n.transform.params)===null||e===void 0?void 0:e.colorTheme.name)==="uniform")return(r=n.transform.params)===null||r===void 0?void 0:r.colorTheme.params.value}render(){var e,r,n;let o=this.props.representation.cell,i=this.color;return(0,En.jsxs)(En.Fragment,{children:[(0,En.jsxs)("div",{className:"msp-flex-row",children:[i!==void 0&&(0,En.jsx)(vt,{style:{backgroundColor:ce.toStyle(i),minWidth:32,width:32},onClick:this.toggleColor}),(0,En.jsxs)(vt,{noOverflow:!0,className:"msp-control-button-label",title:`${(e=o.obj)===null||e===void 0?void 0:e.label}. Click to focus.`,onClick:this.focus,onMouseEnter:this.highlight,onMouseLeave:this.clearHighlight,style:{textAlign:"left"},children:[(r=o.obj)===null||r===void 0?void 0:r.label,(0,En.jsx)("small",{className:"msp-25-lower-contrast-text",style:{float:"right"},children:(n=o.obj)===null||n===void 0?void 0:n.description})]}),(0,En.jsx)(pt,{svg:o.state.isHidden?Ec:Ic,toggleState:!1,onClick:this.toggleVisible,title:`${o.state.isHidden?"Show":"Hide"} component`,small:!0,className:"msp-form-control",flex:!0}),(0,En.jsx)(pt,{svg:Hi,onClick:this.remove,title:"Remove",small:!0}),(0,En.jsx)(pt,{svg:Pu,onClick:this.toggleUpdate,title:"Actions",toggleState:this.state.action==="update"})]}),this.state.action==="update"&&!!o.parent&&(0,En.jsx)("div",{style:{marginBottom:"6px"},className:"msp-accent-offset",children:(0,En.jsx)(Xs,{state:o.parent,transform:o.transform,customHeader:"none",noMargin:!0})}),this.state.action==="select-color"&&i!==void 0&&(0,En.jsx)("div",{style:{marginBottom:"6px",marginTop:1},className:"msp-accent-offset",children:(0,En.jsx)(Ua,{header:"Select Color",initialExpanded:!0,hideExpander:!0,hideOffset:!0,onHeaderClick:this.toggleColor,topRightIcon:ml,noTopMargin:!0,childrenClassName:"msp-viewport-controls-panel-controls",children:(0,En.jsx)(tb,{param:tFe,value:this.color,onChange:this.updateColor,name:"color",hideNameRow:!0})})})]})}},tFe=g.Color(ce(1184274));var vr=Ot(Or());var dT;(function(t){function e(n){return{size:n,matrix:Ro.create(n,n),eigenValues:new Float64Array(n),D:new Float64Array(n),E:new Float64Array(n)}}t.createCache=e;function r(n){rFe(n.size,n.matrix.data,n.eigenValues,n.D,n.E)}t.compute=r})(dT||(dT={}));function rFe(t,e,r,n,o){for(let a=0;a<t;a++)o[a]=0;let i=t-1;for(let a=0;a<t;a++)n[a]=e[a*t+i];nFe(e,n,o,t),oFe(e,n,o,t);for(let a=0;a<t;a++)r[a]=n[a]}function nFe(t,e,r,n){for(let o=n-1;o>0;o--){let i=0,a=0;for(let s=0;s<o;s++)i=i+Math.abs(e[s]);if(i===0){r[o]=e[o-1];for(let s=0;s<o;s++)e[s]=t[s*n+o-1],t[s*n+o]=0,t[o*n+s]=0}else{for(let u=0;u<o;u++)e[u]/=i,a+=e[u]*e[u];let s=e[o-1],l=Math.sqrt(a);s>0&&(l=-l),r[o]=i*l,a=a-s*l,e[o-1]=s-l;for(let u=0;u<o;u++)r[u]=0;for(let u=0;u<o;u++){s=e[u],t[o*n+u]=s,l=r[u]+t[u*n+u]*s;for(let d=u+1;d<=o-1;d++)l+=t[u*n+d]*e[d],r[d]+=t[u*n+d]*s;r[u]=l}s=0;for(let u=0;u<o;u++)r[u]/=a,s+=r[u]*e[u];let c=s/(a+a);for(let u=0;u<o;u++)r[u]-=c*e[u];for(let u=0;u<o;u++){s=e[u],l=r[u];for(let d=u;d<=o-1;d++)t[u*n+d]-=s*r[d]+l*e[d];e[u]=t[u*n+o-1],t[u*n+o]=0}}e[o]=a}for(let o=0;o<n-1;o++){t[o*n+n-1]=t[o*n+o],t[o*n+o]=1;let i=e[o+1];if(i!==0){for(let a=0;a<=o;a++)e[a]=t[(o+1)*n+a]/i;for(let a=0;a<=o;a++){let s=0;for(let l=0;l<=o;l++)s+=t[(o+1)*n+l]*t[a*n+l];for(let l=0;l<=o;l++)t[a*n+l]-=s*e[l]}}for(let a=0;a<=o;a++)t[(o+1)*n+a]=0}for(let o=0;o<n;o++)e[o]=t[o*n+n-1],t[o*n+n-1]=0;t[n*n-1]=1,r[0]=0}function oFe(t,e,r,n){for(let l=1;l<n;l++)r[l-1]=r[l];r[n-1]=0;let i=0,a=0,s=Math.pow(2,-53);for(let l=0;l<n;l++){a=Math.max(a,Math.abs(e[l])+Math.abs(r[l]));let c=l;for(;c<n&&!(Math.abs(r[c])<=s*a);)c++;if(c>l){let u=0;do{u=u+1;let d=e[l],m=(e[l+1]-d)/(2*r[l]),p=Kle(m,1);m<0&&(p=-p),e[l]=r[l]/(m+p),e[l+1]=r[l]*(m+p);let h=e[l+1],f=d-e[l];for(let _=l+2;_<n;_++)e[_]-=f;i=i+f,m=e[c];let b=1,v=b,x=b,S=r[l+1],T=0,E=0;for(let _=c-1;_>=l;_--){x=v,v=b,E=T,d=b*r[_],f=b*m,p=Kle(m,r[_]),r[_+1]=T*p,T=r[_]/p,b=m/p,m=b*e[_]-T*d,e[_+1]=f+T*(b*d+T*e[_]);for(let D=0;D<n;D++)f=t[(_+1)*n+D],t[(_+1)*n+D]=T*t[_*n+D]+b*f,t[_*n+D]=b*t[_*n+D]-T*f}if(m=-T*E*x*S*r[l]/h,r[l]=T*m,e[l]=b*m,u>=1e3)throw new Error("SVD: Not converging.")}while(Math.abs(r[l])>s*a)}e[l]=e[l]+i,r[l]=0}for(let l=0;l<n-1;l++){let c=l,u=e[l];for(let d=l+1;d<n;d++)e[d]<u&&(c=d,u=e[d]);if(c!==l){e[c]=e[l],e[l]=u;for(let d=0;d<n;d++)u=t[l*n+d],t[l*n+d]=t[c*n+d],t[c*n+d]=u}}}function Kle(t,e){if(Math.abs(t)>Math.abs(e)){let r=e/t;return Math.abs(t)*Math.sqrt(1+r*r)}if(e!==0){let r=t/e;return Math.abs(e)*Math.sqrt(1+r*r)}return 0}var Zd;(function(t){let e;(function(n){function o(i){return{x:new Float64Array(i),y:new Float64Array(i),z:new Float64Array(i)}}n.empty=o})(e=t.Positions||(t.Positions={}));function r(n,o){return typeof o>"u"&&(o={bTransform:W.zero(),rmsd:0}),sFe(new XV(n,o)),o}t.compute=r})(Zd||(Zd={}));var XV=class{constructor(e,r){this.evdCache=dT.createCache(4),this.translateB=W.identity(),this.rotateB=W.identity(),this.tempMatrix=W.identity(),this.a=e.a,this.b=e.b,e.centerA?this.centerA=e.centerA:this.centerA=e.centerA=np.fromArrays(e.a,te()).center,e.centerB?this.centerB=e.centerB:this.centerB=e.centerB=np.fromArrays(e.b,te()).center,this.result=r}};function iFe(t){let e=t.evdCache.matrix;Ro.makeZero(e);let r=t.a.x,n=t.a.y,o=t.a.z,i=t.b.x,a=t.b.y,s=t.b.z,l=t.centerA,c=t.centerB,u=0,d=Math.min(t.a.x.length,t.b.x.length);for(let m=0;m<d;m++){let p=r[m]-l[0],h=n[m]-l[1],f=o[m]-l[2],b=i[m]-c[0],v=a[m]-c[1],x=s[m]-c[2];u+=p*p+h*h+f*f+b*b+v*v+x*x,Ro.add(e,0,0,p*b+h*v+f*x),Ro.add(e,0,1,-(f*v)+h*x),Ro.add(e,0,2,f*b-p*x),Ro.add(e,0,3,-(h*b)+p*v),Ro.add(e,1,0,-(f*v)+h*x),Ro.add(e,1,1,p*b-h*v-f*x),Ro.add(e,1,2,h*b+p*v),Ro.add(e,1,3,f*b+p*x),Ro.add(e,2,0,f*b-p*x),Ro.add(e,2,1,h*b+p*v),Ro.add(e,2,2,-(p*b)+h*v-f*x),Ro.add(e,2,3,f*v+h*x),Ro.add(e,3,0,-(h*b)+p*v),Ro.add(e,3,1,f*b+p*x),Ro.add(e,3,2,f*v+h*x),Ro.add(e,3,3,-(p*b)-h*v+f*x)}return u}function aFe(t){let e=t.evdCache.matrix,r=Ro.get(e,1,3),n=Ro.get(e,2,3),o=Ro.get(e,3,3),i=Ro.get(e,0,3),a=2*n*n,s=2*o*o,l=2*r*r,c=2*r*n,u=2*i*o,d=2*r*o,m=2*i*n,p=2*n*o,h=2*i*r,f=t.translateB;W.setValue(f,0,3,-t.centerB[0]),W.setValue(f,1,3,-t.centerB[1]),W.setValue(f,2,3,-t.centerB[2]),f=t.rotateB,W.setValue(f,0,0,1-a-s),W.setValue(f,0,1,c+u),W.setValue(f,0,2,d-m),W.setValue(f,1,0,c-u),W.setValue(f,1,1,1-l-s),W.setValue(f,1,2,p+h),W.setValue(f,2,0,d+m),W.setValue(f,2,1,p-h),W.setValue(f,2,2,1-l-a),W.setValue(f,3,3,1),W.mul(t.tempMatrix,t.rotateB,t.translateB),f=t.translateB,W.setValue(f,0,3,t.centerA[0]),W.setValue(f,1,3,t.centerA[1]),W.setValue(f,2,3,t.centerA[2]),W.mul(t.result.bTransform,t.translateB,t.tempMatrix)}function sFe(t){let e=iFe(t);dT.compute(t.evdCache);let r=e-2*t.evdCache.eigenValues[3];r=r<0?0:Math.sqrt(r/t.a.x.length),aFe(t),t.result.rmsd=r}var lFe="ACDEFGHIKLMNPQRSTVWY",cFe="ARNDCQEGHILKMFPSTWYVBZX",uFe=[[4,0,-2,-1,-2,0,-2,-1,-1,-1,-1,-2,-1,-1,-1,1,0,0,-3,-2],[0,9,-3,-4,-2,-3,-3,-1,-3,-1,-1,-3,-3,-3,-3,-1,-1,-1,-2,-2],[-2,-3,6,2,-3,-1,-1,-3,-1,-4,-3,1,-1,0,-2,0,-1,-3,-4,-3],[-1,-4,2,5,-3,-2,0,-3,1,-3,-2,0,-1,2,0,0,-1,-2,-3,-2],[-2,-2,-3,-3,6,-3,-1,0,-3,0,0,-3,-4,-3,-3,-2,-2,-1,1,3],[0,-3,-1,-2,-3,6,-2,-4,-2,-4,-3,0,-2,-2,-2,0,-2,-3,-2,-3],[-2,-3,-1,0,-1,-2,8,-3,-1,-3,-2,1,-2,0,0,-1,-2,-3,-2,2],[-1,-1,-3,-3,0,-4,-3,4,-3,2,1,-3,-3,-3,-3,-2,-1,3,-3,-1],[-1,-3,-1,1,-3,-2,-1,-3,5,-2,-1,0,-1,1,2,0,-1,-2,-3,-2],[-1,-1,-4,-3,0,-4,-3,2,-2,4,2,-3,-3,-2,-2,-2,-1,1,-2,-1],[-1,-1,-3,-2,0,-3,-2,1,-1,2,5,-2,-2,0,-1,-1,-1,1,-1,-1],[-2,-3,1,0,-3,0,1,-3,0,-3,-2,6,-2,0,0,1,0,-3,-4,-2],[-1,-3,-1,-1,-4,-2,-2,-3,-1,-3,-2,-2,7,-1,-2,-1,-1,-2,-4,-3],[-1,-3,0,2,-3,-2,0,-3,1,-2,0,0,-1,5,1,0,-1,-2,-2,-1],[-1,-3,-2,0,-3,-2,0,-3,2,-2,-1,0,-2,1,5,-1,-1,-3,-3,-2],[1,-1,0,0,-2,0,-1,-2,0,-2,-1,1,-1,0,-1,4,1,-2,-3,-2],[0,-1,-1,-1,-2,-2,-2,-1,-1,-1,-1,0,-1,-1,-1,1,5,0,-2,-2],[0,-1,-3,-2,-1,-3,-3,3,-2,1,1,-3,-2,-2,-3,-2,0,4,-3,-1],[-3,-2,-4,-3,1,-2,-2,-3,-3,-2,-1,-4,-4,-2,-3,-3,-2,-3,11,2],[-2,-2,-3,-2,3,-3,2,-1,-2,-1,-1,-2,-3,-1,-2,-2,-2,-1,2,7]],dFe=[[4,-1,-2,-2,0,-1,-1,0,-2,-1,-1,-1,-1,-2,-1,1,0,-3,-2,0,-2,-1,0],[-1,5,0,-2,-3,1,0,-2,0,-3,-2,2,-1,-3,-2,-1,-1,-3,-2,-3,-1,0,-1],[-2,0,6,1,-3,0,0,0,1,-3,-3,0,-2,-3,-2,1,0,-4,-2,-3,3,0,-1],[-2,-2,1,6,-3,0,2,-1,-1,-3,-4,-1,-3,-3,-1,0,-1,-4,-3,-3,4,1,-1],[0,-3,-3,-3,9,-3,-4,-3,-3,-1,-1,-3,-1,-2,-3,-1,-1,-2,-2,-1,-3,-3,-2],[-1,1,0,0,-3,5,2,-2,0,-3,-2,1,0,-3,-1,0,-1,-2,-1,-2,0,3,-1],[-1,0,0,2,-4,2,5,-2,0,-3,-3,1,-2,-3,-1,0,-1,-3,-2,-2,1,4,-1],[0,-2,0,-1,-3,-2,-2,6,-2,-4,-4,-2,-3,-3,-2,0,-2,-2,-3,-3,-1,-2,-1],[-2,0,1,-1,-3,0,0,-2,8,-3,-3,-1,-2,-1,-2,-1,-2,-2,2,-3,0,0,-1],[-1,-3,-3,-3,-1,-3,-3,-4,-3,4,2,-3,1,0,-3,-2,-1,-3,-1,3,-3,-3,-1],[-1,-2,-3,-4,-1,-2,-3,-4,-3,2,4,-2,2,0,-3,-2,-1,-2,-1,1,-4,-3,-1],[-1,2,0,-1,-3,1,1,-2,-1,-3,-2,5,-1,-3,-1,0,-1,-3,-2,-2,0,1,-1],[-1,-1,-2,-3,-1,0,-2,-3,-2,1,2,-1,5,0,-2,-1,-1,-1,-1,1,-3,-1,-1],[-2,-3,-3,-3,-2,-3,-3,-3,-1,0,0,-3,0,6,-4,-2,-2,1,3,-1,-3,-3,-1],[-1,-2,-2,-1,-3,-1,-1,-2,-2,-3,-3,-1,-2,-4,7,-1,-1,-4,-3,-2,-2,-1,-2],[1,-1,1,0,-1,0,0,0,-1,-2,-2,0,-1,-2,-1,4,1,-3,-2,-2,0,0,0],[0,-1,0,-1,-1,-1,-1,-2,-2,-1,-1,-1,-1,-2,-1,1,5,-2,-2,0,-1,-1,0],[-3,-3,-4,-4,-2,-2,-3,-2,-2,-3,-2,-3,-1,1,-4,-3,-2,11,2,-3,-4,-3,-2],[-2,-2,-2,-3,-2,-1,-2,-3,2,-1,-1,-2,-1,3,-3,-2,-2,2,7,-1,-3,-2,-1],[0,-3,-3,-3,-1,-2,-2,-3,-3,3,1,-2,1,-1,-2,-2,0,-3,-1,4,-3,-2,-1],[-2,-1,3,4,-3,0,1,-1,0,-3,-4,0,-3,-3,-2,0,-1,-4,-3,-3,4,1,-1],[-1,0,0,1,-3,3,4,-2,0,-3,-3,1,-1,-3,-1,0,-1,-3,-2,-2,1,4,-1],[0,-1,-1,-1,-2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-2,0,0,-2,-1,-1,-1,-1,-1]];function $le(t,e){let r,n=0,o={};return e.forEach(i=>{r=0;let a={};i.forEach(s=>a[t[r++]]=s),o[t[n++]]=a}),o}var Zle={blosum62:$le(cFe,dFe),blosum62x:$le(lFe,uFe)};var mFe={gapPenalty:-11,gapExtensionPenalty:-1,substMatrix:"default"};function Jle(t,e,r={}){let n=w(w({},mFe),r),o=new YV(t,e,n);return o.calculate(),o.trace()}var YV=class{constructor(e,r,n){this.seqA=e,this.seqB=r,this.S=[],this.V=[],this.H=[],this.gapPenalty=n.gapPenalty,this.gapExtensionPenalty=n.gapExtensionPenalty,this.substMatrix=n.substMatrix==="default"?void 0:Zle[n.substMatrix],this.n=this.seqA.length,this.m=this.seqB.length}initMatrices(){let{n:e,m:r,gapPenalty:n,S:o,V:i,H:a}=this;for(let s=0;s<=e;++s){o[s]=[],i[s]=[],a[s]=[];for(let l=0;l<=r;++l)o[s][l]=0,i[s][l]=0,a[s][l]=0}for(let s=0;s<=e;++s)o[s][0]=n,a[s][0]=-1/0;for(let s=0;s<=r;++s)o[0][s]=n,i[0][s]=-1/0;o[0][0]=0}makeScoreFn(){let{seqA:e,seqB:r,substMatrix:n}=this;return n?function(i,a){var s,l;let c=e[i],u=r[a];return(l=(s=n[c])===null||s===void 0?void 0:s[u])!==null&&l!==void 0?l:-4}:function(i,a){let s=e[i],l=r[a];return s===l?5:-3}}calculate(){this.initMatrices();let e=this.makeScoreFn(),{V:r,H:n,S:o,n:i,m:a,gapExtensionPenalty:s,gapPenalty:l}=this,c,u,d,m,p;for(let h=1;h<=i;++h){u=o[h-1],c=r[h-1],d=r[h],m=n[h],p=o[h];for(let f=1;f<=a;++f)d[f]=Math.max(u[f]+l,c[f]+s),m[f]=Math.max(p[f-1]+l,m[f-1]+s),p[f]=Math.max(u[f-1]+e(h-1,f-1),d[f],m[f])}}trace(){let e=this.makeScoreFn(),{V:r,H:n,S:o,seqA:i,seqB:a,gapExtensionPenalty:s,gapPenalty:l}=this,c=this.n,u=this.m,d,m,p="",h="";for(o[c][u]>=r[c][u]?(d="S",m=o[c][u]):r[c][u]>=n[c][u]?(d="V",m=r[c][u]):(d="H",m=n[c][u]);c>0&&u>0;)d==="S"?o[c][u]===o[c-1][u-1]+e(c-1,u-1)?(p=i[c-1]+p,h=a[u-1]+h,--c,--u,d="S"):o[c][u]===r[c][u]?d="V":o[c][u]===n[c][u]?d="H":(--c,--u):d==="V"?r[c][u]===r[c-1][u]+s?(p=i[c-1]+p,h="-"+h,--c,d="V"):r[c][u]===o[c-1][u]+l?(p=i[c-1]+p,h="-"+h,--c,d="S"):--c:d==="H"&&(n[c][u]===n[c][u-1]+s?(p="-"+p,h=a[u-1]+h,--u,d="H"):n[c][u]===o[c][u-1]+l?(p="-"+p,h=a[u-1]+h,--u,d="S"):--u);for(;c>0;)p=i[c-1]+p,h="-"+h,--c;for(;u>0;)p="-"+p,h=a[u-1]+h,--u;return{aliA:p,aliB:h,score:m}}};var QD;(function(t){function e(n){let o=new Map;if(Pe.isAtomic(n.unit)){let{label_seq_id:i}=n.unit.model.atomicHierarchy.residues,{residueIndex:a}=n.unit;for(let s=0,l=we.size(n.indices);s<l;++s){let c=we.getAt(n.indices,s),u=n.unit.elements[c],d=i.value(a[u]);o.has(d)?o.get(d).push(c):o.set(d,[c])}}else if(Pe.isCoarse(n.unit)){let{seq_id_begin:i}=Pe.isSpheres(n.unit)?n.unit.model.coarseHierarchy.spheres:n.unit.model.coarseHierarchy.gaussians;for(let a=0,s=we.size(n.indices);a<s;++a){let l=we.getAt(n.indices,a),c=n.unit.elements[l],u=i.value(c);o.set(u,[l])}}return o}t.createSeqIdIndicesMap=e;function r(n,o={}){let i=ece(n.a.unit),a=ece(n.b.unit),s=e(n.a),l=e(n.b),c=[],u=[],{aliA:d,aliB:m,score:p}=Jle(i.code.toArray(),a.code.toArray(),o),h=0,f=0;for(let x=0,S=d.length;x<S;++x){if(d[x]==="-"||m[x]==="-"){d[x]!=="-"&&(h+=1),m[x]!=="-"&&(f+=1);continue}let T=i.seqId.value(h),E=a.seqId.value(f);if(s.has(T)&&l.has(E)){let _=s.get(T),D=l.get(E);for(let P=0,A=Math.min(_.length,D.length);P<A;++P)c.push(_[P]),u.push(D[P])}h+=1,f+=1}let b=we.intersect(we.ofSortedArray(c),n.a.indices),v=we.intersect(we.ofSortedArray(u),n.b.indices);return{a:{unit:n.a.unit,indices:b},b:{unit:n.b.unit,indices:v},score:p}}t.compute=r})(QD||(QD={}));function pFe(t){switch(t.kind){case 0:return t.model.atomicHierarchy.index.getEntityFromChain(t.chainIndex[t.elements[0]]);case 1:return t.model.coarseHierarchy.spheres.entityKey[t.elements[0]];case 2:return t.model.coarseHierarchy.gaussians.entityKey[t.elements[0]]}}function ece(t){return t.model.sequence.byEntityKey[pFe(t)].sequence}function QV(t){let e=[];if(t.length<=0)return e;let r=hFe(t),n={a:mT(t[0],r),b:mT(t[1],r)};e[0]=Zd.compute(n);for(let o=2;o<t.length;o++)n.b=mT(t[o],r),n.centerB=void 0,e.push(Zd.compute(n));return e}var fFe=/(polypeptide|cyclic-pseudo-peptide)/i;function tce(t){let e=[];if(t.length<=0)return e;let r=z.Loci.getFirstLocation(t[0]),o=Ne.entity.subtype(r).match(fFe)?"blosum62":"default";for(let i=1;i<t.length;i++){let{a,b:s,score:l}=QD.compute({a:t[0].elements[0],b:t[i].elements[0]},{substMatrix:o}),c=z.Loci(t[0].structure,[a]),u=z.Loci(t[i].structure,[s]),d=we.size(a.indices);e.push(U(w({},Zd.compute({a:mT(c,d),b:mT(u,d)})),{alignmentScore:l}))}return e}function mT(t,e){let r=Zd.Positions.empty(e),n=0;for(let o of t.elements){let{unit:i,indices:a}=o,{elements:s,conformation:l}=i;for(let c=0,u=we.size(a);c<u;c++){let d=s[we.getAt(a,c)];if(r.x[n]=l.x(d),r.y[n]=l.y(d),r.z[n]=l.z(d),n++,n>=e)break}if(n>=e)break}return r}function hFe(t){if(t.length===0)return 0;let e=z.Loci.size(t[0]);for(let r=1;r<t.length;r++){let n=z.Loci.size(t[r]);n<e&&(e=n)}return e}function rce(t,e){var r,n;let o=new Map;for(let u=0;u<t.length;u++)bFe(t[u],o,u,(r=e?.traceOnly)!==null&&r!==void 0?r:!0,(n=e?.includeResidueTest)!==null&&n!==void 0?n:vFe);let i=Array.from(o.values()),a=yFe(t.length,i),s=[],l=[],c=[];for(let u of a)if(u.count===0)s.push([u.i,u.j]);else{let[d,m]=gFe(i,u.i,u.j,u.count),p=Zd.compute({a:d,b:m});Number.isNaN(p.rmsd)?l.push([u.i,u.j]):c.push({transform:p,pivot:u.i,other:u.j})}return{entries:c,zeroOverlapPairs:s,failedPairs:l}}function gFe(t,e,r,n){let o=Zd.Positions.empty(n),i=Zd.Positions.empty(n),a=0;for(let{pivots:s}of t){let l=s[e],c=s[r];if(!l||!c)continue;let u=Math.min(l[2]-l[1],c[2]-c[1]);for(let d=0;d<u;d++){let m=l[1]+d;o.x[a]=l[0].conformation.x(m),o.y[a]=l[0].conformation.y(m),o.z[a]=l[0].conformation.z(m),m=c[1]+d,i.x[a]=c[0].conformation.x(m),i.y[a]=c[0].conformation.y(m),i.z[a]=c[0].conformation.z(m),a++}}return[o,i]}function yFe(t,e){let r=[];for(let o=0;o<t;o++){r[o]=[];for(let i=0;i<t;i++)r[o][i]=0}for(let{pivots:o}of e)for(let i=0;i<t;i++){if(!o[i])continue;let a=o[i][2]-o[i][1];for(let s=i+1;s<t;s++){if(!o[s])continue;let l=o[s][2]-o[s][1];r[i][s]=r[i][s]+Math.min(a,l)}}let n=[];for(let o=1;o<t;o++)n[o-1]={i:0,j:o,count:r[0][o]};return n}function vFe(){return!0}function bFe(t,e,r,n,o){let i=z.Location.create(t);for(let a of t.units){if(a.kind!==0)continue;let{elements:s,model:l}=a;i.unit=a;let c=cc.Provider.get(l).value;if(!c)return;let{dbName:u,accession:d,num:m}=c,p=$r.transientSegments(a.model.atomicHierarchy.chainAtomSegments,s),h=$r.transientSegments(a.model.atomicHierarchy.residueAtomSegments,s),f=a.model.atomicHierarchy.derived.residue.traceElementIndex;for(;p.hasNext;){let b=p.move();for(h.setSegment(b);h.hasNext;){let v=h.move(),x=v.index;if(!u[x])continue;let S=f[x],T,E;if(n){if(T=S,T===-1)continue;E=T+1}else T=s[v.start],E=s[v.end-1]+1;if(i.element=S>=0?S:T,!o(i,x,T,E))continue;let _=`${u[x]}-${d[x]}-${m[x]}`;if(!e.has(_))e.set(_,{key:_,pivots:{[r]:[a,T,E]}});else{let D=e.get(_);D.pivots[r]||(D.pivots[r]=[a,T,E])}}}}}var KD=class extends hl{defaultState(){return{isCollapsed:!1,header:"Superposition",brand:{accent:"gray",svg:UJ},isHidden:!0}}componentDidMount(){this.subscribe(this.plugin.managers.structure.hierarchy.behaviors.selection,e=>{this.setState({isHidden:e.structures.length<2})})}renderControls(){return(0,vr.jsx)(vr.Fragment,{children:(0,vr.jsx)(KV,{})})}},nce={alignSequences:g.Boolean(!0,{isEssential:!0,description:"For Chain-based 3D superposition, perform a sequence alignment and use the aligned residue pairs to guide the 3D superposition."}),traceOnly:g.Boolean(!0,{description:"For Chain- and Uniprot-based 3D superposition, base superposition only on CA (and equivalent) atoms."})},xFe=g.getDefaultValues(nce),SFe="SuperpositionTransform",KV=class extends Kn{constructor(){super(...arguments),this.state={isBusy:!1,canUseDb:!1,action:void 0,options:xFe},this.superposeChains=()=>N(this,null,function*(){var e,r,n;let{query:o}=this.state.options.traceOnly?Qn.trace:Qn.polymer,i=this.chainEntries,a=i.map(d=>{let m=z.Loci.toStructure(d.loci),p=hn.toLociWithSourceUnits(o(new fa(m)));return z.Loci.remap(p,this.getRootStructure(d.loci.structure))}),s=this.plugin.managers.structure.hierarchy.findStructure((e=a[0])===null||e===void 0?void 0:e.structure),l=(n=(r=s?.transform)===null||r===void 0?void 0:r.cell.obj)===null||n===void 0?void 0:n.data.coordinateSystem,c=this.state.options.alignSequences?tce(a):QV(a),u=i[0];for(let d=1,m=a.length;d<m;++d){let p=i[d],{bTransform:h,rmsd:f}=c[d-1];yield this.transform(p.cell,h,l);let b=sd(u.label),v=sd(p.label);this.plugin.log.info(`Superposed [${b}] and [${v}] with RMSD ${f.toFixed(2)}.`)}yield this.cameraReset()}),this.superposeAtoms=()=>N(this,null,function*(){var e,r,n;let o=this.atomEntries,i=o.map(u=>z.Loci.remap(u.loci,this.getRootStructure(u.loci.structure))),a=QV(i),s=this.plugin.managers.structure.hierarchy.findStructure((e=i[0])===null||e===void 0?void 0:e.structure),l=(n=(r=s?.transform)===null||r===void 0?void 0:r.cell.obj)===null||n===void 0?void 0:n.data.coordinateSystem,c=o[0];for(let u=1,d=i.length;u<d;++u){let m=o[u],{bTransform:p,rmsd:h}=a[u-1];yield this.transform(m.cell,p,l);let f=sd(c.label),b=sd(m.label),v=o[u].atoms.length;this.plugin.log.info(`Superposed ${v} ${v===1?"atom":"atoms"} of [${f}] and [${b}] with RMSD ${h.toFixed(2)}.`)}yield this.cameraReset()}),this.superposeDb=()=>N(this,null,function*(){var e,r,n;let o=this.plugin.managers.structure.hierarchy.behaviors.selection.value.structures,i=this.state.options.traceOnly,a=o.map(p=>{var h;return(h=p.cell.obj)===null||h===void 0?void 0:h.data}),{entries:s,failedPairs:l,zeroOverlapPairs:c}=rce(a,{traceOnly:i}),u=(n=(r=(e=o[0])===null||e===void 0?void 0:e.transform)===null||r===void 0?void 0:r.cell.obj)===null||n===void 0?void 0:n.data.coordinateSystem,d=0;for(let p of s)yield this.transform(o[p.other].cell,p.transform.bTransform,u),d+=p.transform.rmsd;d/=Math.max(s.length-1,1);let m=p=>`[${p.map(([h,f])=>`(${a[h].models[0].entryId}, ${a[f].models[0].entryId})`).join(", ")}]`;c.length&&this.plugin.log.warn(`Superposition: No UNIPROT mapping overlap between structures ${m(c)}.`),l.length&&this.plugin.log.error(`Superposition: Failed to superpose structures ${m(l)}.`),s.length&&(this.plugin.log.info(`Superposed ${s.length+1} structures with avg. RMSD ${d.toFixed(2)} \xC5.`),yield this.cameraReset())}),this.toggleByChains=()=>this.setState({action:this.state.action==="byChains"?void 0:"byChains"}),this.toggleByAtoms=()=>this.setState({action:this.state.action==="byAtoms"?void 0:"byAtoms"}),this.toggleOptions=()=>this.setState({action:this.state.action==="options"?void 0:"options"}),this.setOptions=e=>{this.setState({options:e})}}componentDidMount(){this.subscribe(this.selection.events.changed,()=>{this.forceUpdate()}),this.subscribe(this.selection.events.additionsHistoryUpdated,()=>{this.forceUpdate()}),this.subscribe(this.plugin.behaviors.state.isBusy,e=>{this.setState({isBusy:e})}),this.subscribe(this.plugin.managers.structure.hierarchy.behaviors.selection,e=>{this.setState({canUseDb:e.structures.every(r=>{var n;return!!(!((n=r.cell.obj)===null||n===void 0)&&n.data)&&r.cell.obj.data.models.some(o=>cc.Provider.isApplicable(o))})})})}get selection(){return this.plugin.managers.structure.selection}transform(e,r,n){return N(this,null,function*(){let o=Fn.resolveAndCheck(this.plugin.state.data,e);if(!o)return;let i=this.plugin.state.data.selectQ(c=>c.byRef(o.transform.ref).subtree().withTransformer(de.Model.TransformStructureConformation))[0],s={transform:{name:"matrix",params:{data:n&&!W.isIdentity(n.matrix)?W.mul(W(),n.matrix,r):r,transpose:!1}}},l=i?this.plugin.state.data.build().to(i).update(s):this.plugin.state.data.build().to(e).insert(de.Model.TransformStructureConformation,s,{tags:SFe});yield this.plugin.runTask(this.plugin.state.data.updateTree(l))})}getRootStructure(e){var r;let n=this.plugin.helpers.substructureParent.get(e);return(r=this.plugin.state.data.selectQ(o=>o.byValue(n).rootOfType(X.Molecule.Structure))[0].obj)===null||r===void 0?void 0:r.data}cameraReset(){return N(this,null,function*(){yield new Promise(e=>requestAnimationFrame(e)),Re.Camera.Reset(this.plugin)})}highlight(e){this.plugin.managers.interactivity.lociHighlights.highlightOnly({loci:e},!1)}moveHistory(e,r){this.plugin.managers.structure.selection.modifyHistory(e,r,void 0,!0)}focusLoci(e){this.plugin.managers.camera.focusLoci(e)}lociEntry(e,r){return(0,vr.jsx)("div",{className:"msp-flex-row",children:(0,vr.jsx)(vt,{noOverflow:!0,title:"Click to focus. Hover to highlight.",onClick:()=>this.focusLoci(e.loci),style:{width:"auto",textAlign:"left"},onMouseEnter:()=>this.highlight(e.loci),onMouseLeave:()=>this.plugin.managers.interactivity.lociHighlights.clearHighlights(),children:(0,vr.jsx)("span",{dangerouslySetInnerHTML:{__html:e.label}})})},r)}historyEntry(e,r){let n=this.plugin.managers.structure.selection.additionsHistory;return(0,vr.jsxs)("div",{className:"msp-flex-row",children:[(0,vr.jsxs)(vt,{noOverflow:!0,title:"Click to focus. Hover to highlight.",onClick:()=>this.focusLoci(e.loci),style:{width:"auto",textAlign:"left"},onMouseEnter:()=>this.highlight(e.loci),onMouseLeave:()=>this.plugin.managers.interactivity.lociHighlights.clearHighlights(),children:[r,". ",(0,vr.jsx)("span",{dangerouslySetInnerHTML:{__html:e.label}})]}),n.length>1&&(0,vr.jsx)(pt,{svg:Ph,small:!0,className:"msp-form-control",onClick:()=>this.moveHistory(e,"up"),flex:"20px",title:"Move up"}),n.length>1&&(0,vr.jsx)(pt,{svg:_h,small:!0,className:"msp-form-control",onClick:()=>this.moveHistory(e,"down"),flex:"20px",title:"Move down"}),(0,vr.jsx)(pt,{svg:Hi,small:!0,className:"msp-form-control",onClick:()=>this.plugin.managers.structure.selection.modifyHistory(e,"remove"),flex:!0,title:"Remove"})]},e.id)}atomsLociEntry(e,r){return(0,vr.jsxs)("div",{children:[(0,vr.jsx)("div",{className:"msp-control-group-header",children:(0,vr.jsx)("div",{className:"msp-no-overflow",title:e.label,children:e.label})}),(0,vr.jsx)("div",{className:"msp-control-offset",children:e.atoms.map((n,o)=>this.historyEntry(n,o))})]},r)}get chainEntries(){let e=z.Location.create(),r=[];return this.plugin.managers.structure.selection.entries.forEach(({selection:n},o)=>{let i=Fn.resolveAndCheck(this.plugin.state.data,o);if(!i||z.Loci.isEmpty(n))return;let a=z.Loci.getFirstLocation(n,e);if(n.elements.length>1||Ne.entity.type(a)!=="polymer")return;let s=z.Stats.ofLoci(n),l=Qg(s,{countsOnly:!0}),c=Sc(a,{reverse:!0,granularity:"chain"}).split("|"),u=`${l} | ${c[0]} | ${c[c.length-1]}`;r.push({loci:n,label:u,cell:i})}),r}get atomEntries(){let e=new Map,r=this.plugin.managers.structure.selection.additionsHistory;for(let o=0,i=r.length;o<i;++o){let a=r[o];if(z.Loci.size(a.loci)!==1)continue;let s=a.loci.structure;e.has(s)?e.get(s).push(a):e.set(s,[a])}let n=[];return e.forEach((o,i)=>{let a=this.plugin.helpers.substructureParent.get(i),s=[];for(let u=0,d=o.length;u<d;++u)s.push(o[u].loci.elements[0]);let l=z.Loci(o[0].loci.structure,s),c=l.structure.label.split(" | ")[0];n.push({loci:l,label:c,cell:a,atoms:o})}),n}toggleHint(){return this.plugin.config.get(Wt.Viewport.ShowSelectionMode)?(0,vr.jsxs)(vr.Fragment,{children:[" ","(toggle ",(0,vr.jsx)(hg,{inline:!0})," mode)"]}):null}addByChains(){let e=this.chainEntries;return(0,vr.jsxs)(vr.Fragment,{children:[e.length>0&&(0,vr.jsx)("div",{className:"msp-control-offset",children:e.map((r,n)=>this.lociEntry(r,n))}),e.length<2&&(0,vr.jsx)("div",{className:"msp-control-offset msp-help-text",children:(0,vr.jsxs)("div",{className:"msp-help-description",children:[(0,vr.jsx)(pr,{svg:Bs,inline:!0}),"Add 2 or more selections",this.toggleHint()," from separate structures. Selections must be limited to single polymer chains or residues therein."]})}),e.length>1&&(0,vr.jsx)(vt,{title:"Superpose structures by selected chains.",className:"msp-btn-commit msp-btn-commit-on",onClick:this.superposeChains,style:{marginTop:"1px"},children:"Superpose"})]})}addByAtoms(){let e=this.atomEntries;return(0,vr.jsxs)(vr.Fragment,{children:[e.length>0&&(0,vr.jsx)("div",{className:"msp-control-offset",children:e.map((r,n)=>this.atomsLociEntry(r,n))}),e.length<2&&(0,vr.jsx)("div",{className:"msp-control-offset msp-help-text",children:(0,vr.jsxs)("div",{className:"msp-help-description",children:[(0,vr.jsx)(pr,{svg:Bs,inline:!0}),"Add 1 or more selections",this.toggleHint()," from separate structures. Selections must be limited to single atoms."]})}),e.length>1&&(0,vr.jsx)(vt,{title:"Superpose structures by selected atoms.",className:"msp-btn-commit msp-btn-commit-on",onClick:this.superposeAtoms,style:{marginTop:"1px"},children:"Superpose"})]})}superposeByDbMapping(){return(0,vr.jsx)(vr.Fragment,{children:(0,vr.jsx)(vt,{icon:pB,title:"Superpose structures using intersection of residues from SIFTS UNIPROT mapping.",className:"msp-btn msp-btn-block",onClick:this.superposeDb,style:{marginTop:"1px"},disabled:this.state.isBusy,children:"Uniprot"})})}render(){return(0,vr.jsxs)(vr.Fragment,{children:[(0,vr.jsxs)("div",{className:"msp-flex-row",children:[(0,vr.jsx)(Gn,{icon:pB,label:"Chains",toggle:this.toggleByChains,isSelected:this.state.action==="byChains",disabled:this.state.isBusy}),(0,vr.jsx)(Gn,{icon:zJ,label:"Atoms",toggle:this.toggleByAtoms,isSelected:this.state.action==="byAtoms",disabled:this.state.isBusy}),this.state.canUseDb&&this.superposeByDbMapping(),(0,vr.jsx)(Gn,{icon:pl,label:"",title:"Options",toggle:this.toggleOptions,isSelected:this.state.action==="options",disabled:this.state.isBusy,style:{flex:"0 0 40px",padding:0}})]}),this.state.action==="byChains"&&this.addByChains(),this.state.action==="byAtoms"&&this.addByAtoms(),this.state.action==="options"&&(0,vr.jsx)("div",{className:"msp-control-offset",children:(0,vr.jsx)(Hr,{params:nce,values:this.state.options,onChangeValues:this.setOptions,isDisabled:this.state.isBusy})})]})}};var Km=Ot(Or());var $D=class extends hl{defaultState(){return{isCollapsed:!1,header:"Quick Styles",brand:{accent:"gray",svg:xJ}}}renderControls(){return(0,Km.jsx)(Km.Fragment,{children:(0,Km.jsx)($V,{})})}},$V=class extends Kn{default(){return N(this,null,function*(){let{structures:e}=this.plugin.managers.structure.hierarchy.selection,r=this.plugin.config.get(Wt.Structure.DefaultRepresentationPreset)||Ms.auto.id,n=this.plugin.builders.structure.representation.resolveProvider(r);if(yield this.plugin.managers.structure.component.applyPreset(e,n),this.plugin.managers.structure.component.setOptions(g.getDefaultValues(ql.OptionsParams)),this.plugin.canvas3d){let o=g.getDefaultValues(Rv);this.plugin.canvas3d.setProps({postprocessing:{outline:o.outline,occlusion:o.occlusion}})}})}illustrative(){return N(this,null,function*(){let{structures:e}=this.plugin.managers.structure.hierarchy.selection;yield this.plugin.managers.structure.component.applyPreset(e,Ms.illustrative),this.plugin.canvas3d&&this.plugin.canvas3d.setProps({postprocessing:{outline:{name:"on",params:{scale:1,color:ce(0),threshold:.25,includeTransparent:!0}},occlusion:{name:"on",params:{multiScale:{name:"off",params:{}},radius:5,bias:.8,blurKernelSize:15,samples:32,resolutionScale:1,color:ce(0)}},shadow:{name:"off",params:{}}}})})}stylized(){return N(this,null,function*(){if(this.plugin.managers.structure.component.setOptions(U(w({},this.plugin.managers.structure.component.state.options),{ignoreLight:!0})),this.plugin.canvas3d){let e=this.plugin.canvas3d.props.postprocessing;this.plugin.canvas3d.setProps({postprocessing:{outline:{name:"on",params:e.outline.name==="on"?e.outline.params:{scale:1,color:ce(0),threshold:.33,includeTransparent:!0}},occlusion:{name:"on",params:e.occlusion.name==="on"?e.occlusion.params:{multiScale:{name:"off",params:{}},radius:5,bias:.8,blurKernelSize:15,samples:32,resolutionScale:1,color:ce(0)}},shadow:{name:"off",params:{}}}})}})}render(){return(0,Km.jsxs)("div",{className:"msp-flex-row",children:[(0,Km.jsx)(vt,{noOverflow:!0,title:"Applies default representation preset. Set outline and occlusion effects to defaults.",onClick:()=>this.default(),style:{width:"auto"},children:"Default"}),(0,Km.jsx)(vt,{noOverflow:!0,title:"Applies no representation preset. Enables outline and occlusion effects. Enables ignore-light representation parameter.",onClick:()=>this.stylized(),style:{width:"auto"},children:"Stylized"}),(0,Km.jsx)(vt,{noOverflow:!0,title:"Applies illustrative representation preset. Enables outline and occlusion effects. Enables ignore-light parameter.",onClick:()=>this.illustrative(),style:{width:"auto"},children:"Illustrative"})]})}};var ZD=class extends Mt{constructor(){super(...arguments),this.state={show:!1,label:""},this.update=()=>{let e=this.plugin.state.data,r=e.selectQ(a=>a.ofTransformer(de.Model.ModelFromTrajectory));if(r.length===0){this.setState({show:!1});return}let n="",o=0,i=new Set;for(let a of r){if(!a.sourceRef)continue;let s=e.cells.get(a.sourceRef).obj;if(s&&s.data.frameCount>1){if(i.has(a.sourceRef)){this.setState({show:!1});return}i.add(a.sourceRef),o++,n||(n=`Model ${a.transform.params.modelIndex+1} / ${s.data.frameCount}`)}}o>1&&(n=""),this.setState({show:o>0,label:n})},this.reset=()=>Re.State.ApplyAction(this.plugin,{state:this.plugin.state.data,action:pS.create({action:"reset"})}),this.prev=()=>Re.State.ApplyAction(this.plugin,{state:this.plugin.state.data,action:pS.create({action:"advance",by:-1})}),this.next=()=>Re.State.ApplyAction(this.plugin,{state:this.plugin.state.data,action:pS.create({action:"advance",by:1})})}componentDidMount(){this.subscribe(this.plugin.state.data.events.changed,this.update),this.subscribe(this.plugin.behaviors.state.isAnimating,this.update)}render(){let e=this.plugin.behaviors.state.isAnimating.value;return!this.state.show||e&&!this.state.label||!this.plugin.config.get(Wt.Viewport.ShowTrajectoryControls)?null:(0,br.jsxs)("div",{className:"msp-traj-controls",children:[!e&&(0,br.jsx)(pt,{svg:OJ,title:"First Model",onClick:this.reset,disabled:e}),!e&&(0,br.jsx)(pt,{svg:uB,title:"Previous Model",onClick:this.prev,disabled:e}),!e&&(0,br.jsx)(pt,{svg:dB,title:"Next Model",onClick:this.next,disabled:e}),!!this.state.label&&(0,br.jsx)("span",{children:this.state.label})]})}},JD=class extends Mt{constructor(){super(...arguments),this.state={isBusy:!1,show:!0},this.keyUp=e=>{if(!e.ctrlKey||this.state.isBusy||e.target!==document.body)return;let r=this.plugin.managers.snapshot;if(e.keyCode===37||e.key==="ArrowLeft")r.state.isPlaying&&r.stop(),this.prev();else if(e.keyCode===38||e.key==="ArrowUp"){if(r.state.isPlaying&&r.stop(),r.state.entries.size===0)return;let n=r.state.entries.get(0);this.update(n.snapshot.id)}else if(e.keyCode===39||e.key==="ArrowRight")r.state.isPlaying&&r.stop(),this.next();else if(e.keyCode===40||e.key==="ArrowDown"){if(r.state.isPlaying&&r.stop(),r.state.entries.size===0)return;let n=r.state.entries.get(r.state.entries.size-1);this.update(n.snapshot.id)}},this.change=e=>{e.target.value!=="none"&&this.update(e.target.value)},this.prev=()=>{let e=this.plugin.managers.snapshot,r=e.getNextId(e.state.current,-1);r&&this.update(r)},this.next=()=>{let e=this.plugin.managers.snapshot,r=e.getNextId(e.state.current,1);r&&this.update(r)},this.togglePlay=()=>{this.plugin.managers.snapshot.togglePlay()}}componentDidMount(){this.subscribe(this.plugin.managers.snapshot.events.changed,()=>this.forceUpdate()),this.subscribe(this.plugin.behaviors.state.isBusy,e=>this.setState({isBusy:e})),this.subscribe(this.plugin.behaviors.state.isAnimating,e=>this.setState({isBusy:e})),window.addEventListener("keyup",this.keyUp,!1)}componentWillUnmount(){super.componentWillUnmount(),window.removeEventListener("keyup",this.keyUp,!1)}update(e){return N(this,null,function*(){this.setState({isBusy:!0}),yield Re.State.Snapshots.Apply(this.plugin,{id:e}),this.setState({isBusy:!1})})}render(){let e=this.plugin.managers.snapshot,r=e.state.entries.size;if(r<2||!this.state.show)return null;let n=e.state.current,o=e.state.isPlaying;return(0,br.jsxs)("div",{className:"msp-state-snapshot-viewport-controls",children:[(0,br.jsxs)("select",{className:"msp-form-control",value:n||"none",onChange:this.change,disabled:this.state.isBusy||o,children:[!n&&(0,br.jsx)("option",{value:"none"},"none"),e.state.entries.valueSeq().map((i,a)=>(0,br.jsxs)("option",{value:i.snapshot.id,children:[`[${a+1}/${r}]`," ",i.name||new Date(i.timestamp).toLocaleString()]},i.snapshot.id))]}),(0,br.jsx)(pt,{svg:o?mB:lP,title:o?"Pause":"Cycle States",onClick:this.togglePlay,disabled:o?!1:this.state.isBusy}),!o&&(0,br.jsxs)(br.Fragment,{children:[(0,br.jsx)(pt,{svg:uB,title:"Previous State",onClick:this.prev,disabled:this.state.isBusy||o}),(0,br.jsx)(pt,{svg:dB,title:"Next State",onClick:this.next,disabled:this.state.isBusy||o})]})]})}};function oce(){var t;let e=t0.useContext(Hl),[r,n]=t0.useState(0);t0.useEffect(()=>{let a=e.managers.snapshot.events.changed.subscribe(()=>n(s=>s+1));return()=>a.unsubscribe()},[e]);let o=e.managers.snapshot.state.current;if(!o)return null;let i=e.managers.snapshot.getEntry(o);return!((t=i?.description)===null||t===void 0)&&t.trim()?(0,br.jsx)("div",{className:"msp-snapshot-description-wrapper",children:(0,br.jsx)(BD,{skipHtml:!0,components:{a:CFe},children:i.description})}):null}function CFe({href:t,children:e,element:r}){let n=t0.useContext(Hl);return t&&t[0]==="#"?(0,br.jsx)("a",{href:"#",onClick:o=>{o.preventDefault(),n.managers.snapshot.applyKey(t.substring(1))},children:e}):r}var eA=class extends Mt{constructor(){super(...arguments),this.state={isEmpty:!0,isExpanded:!1,isBusy:!1,isAnimating:!1,isPlaying:!1},this.toggleExpanded=()=>this.setState({isExpanded:!this.state.isExpanded}),this.stop=()=>{this.plugin.managers.animation.stop(),this.plugin.managers.snapshot.stop()}}componentDidMount(){this.subscribe(this.plugin.managers.snapshot.events.changed,()=>{this.plugin.managers.snapshot.state.isPlaying?this.setState({isPlaying:!0,isExpanded:!1}):this.setState({isPlaying:!1})}),this.subscribe(this.plugin.behaviors.state.isBusy,e=>{e?this.setState({isBusy:!0,isExpanded:!1,isEmpty:this.plugin.state.data.tree.transforms.size<2}):this.setState({isBusy:!1,isEmpty:this.plugin.state.data.tree.transforms.size<2})}),this.subscribe(this.plugin.behaviors.state.isAnimating,e=>{e?this.setState({isAnimating:!0,isExpanded:!1}):this.setState({isAnimating:!1})})}render(){let e=this.plugin.managers.snapshot.state.isPlaying;if(e||this.state.isEmpty||this.plugin.managers.animation.isEmpty||!this.plugin.config.get(Wt.Viewport.ShowAnimation))return null;let r=this.state.isAnimating;return(0,br.jsxs)("div",{className:"msp-animation-viewport-controls",children:[(0,br.jsxs)("div",{children:[(0,br.jsx)("div",{className:"msp-semi-transparent-background"}),(0,br.jsx)(pt,{svg:r||e?mB:FJ,transparent:!0,title:r?"Stop":"Select Animation",onClick:r||e?this.stop:this.toggleExpanded,toggleState:this.state.isExpanded,disabled:r||e?!1:this.state.isBusy||this.state.isPlaying||this.state.isEmpty})]}),this.state.isExpanded&&!this.state.isBusy&&(0,br.jsx)("div",{className:"msp-animation-viewport-controls-select",children:(0,br.jsx)(OD,{onStart:this.toggleExpanded})})]})}},tA=class extends Mt{componentDidMount(){this.subscribe(this.plugin.behaviors.interaction.selectionMode,()=>this.forceUpdate())}render(){return this.plugin.selectionMode?(0,br.jsx)("div",{className:"msp-selection-viewport-controls",children:(0,br.jsx)(GD,{})}):null}},rA=class extends Mt{constructor(){super(...arguments),this.state={labels:[]}}componentDidMount(){this.subscribe(this.plugin.behaviors.labels.highlight,e=>this.setState({labels:e.labels}))}render(){return this.state.labels.length===0?null:(0,br.jsx)("div",{className:"msp-highlight-info",children:this.state.labels.map((e,r)=>e.indexOf(`
`)>0?(0,br.jsx)("div",{className:"msp-highlight-markdown-row",children:(0,br.jsx)(BD,{skipHtml:!0,children:e})},""+r):(0,br.jsx)("div",{className:"msp-highlight-simple-row",dangerouslySetInnerHTML:{__html:e}},""+r))})}},ZV=class extends Mt{componentDidMount(){this.subscribe(this.plugin.state.behaviors.events.changed,()=>this.forceUpdate())}render(){let e=[];return this.plugin.customStructureControls.forEach((r,n)=>{e.push((0,br.jsx)(r,{initiallyCollapsed:this.props.initiallyCollapsed},n))}),e.length>0?(0,br.jsx)(br.Fragment,{children:e}):null}},nA=class extends Mt{render(){return(0,br.jsxs)(br.Fragment,{children:[(0,br.jsxs)("div",{className:"msp-section-header",children:[(0,br.jsx)(pr,{svg:wJ}),"Structure Tools"]}),(0,br.jsx)(WD,{}),(0,br.jsx)(HD,{}),(0,br.jsx)(KD,{}),(0,br.jsx)($D,{}),(0,br.jsx)(VD,{}),this.plugin.config.get(Wt.VolumeStreaming.Enabled)&&(0,br.jsx)(XD,{}),(0,br.jsx)(YD,{}),(0,br.jsx)(ZV,{})]})}};var ar=Ot(Or());var kx=Ot(Or());var oA=class extends Mt{get current(){return this.props.state.behaviors.currentObject.value}componentDidMount(){this.subscribe(this.plugin.state.events.object.updated,({ref:e,state:r})=>{let n=this.current;n.ref!==e||n.state!==r||this.forceUpdate()}),this.subscribe(this.plugin.state.data.actions.events.added,()=>this.forceUpdate()),this.subscribe(this.plugin.state.data.actions.events.removed,()=>this.forceUpdate())}render(){let{state:e,nodeRef:r}=this.props,n=e.cells.get(r),o=e.actions.fromCell(n,this.plugin);if(o.length===0)return null;let i=n.transform.transformer.definition,a=n.obj?n.obj.label:i.display&&i.display.name||i.name;return(0,kx.jsxs)("div",{className:"msp-state-actions",children:[!this.props.hideHeader&&(0,kx.jsxs)("div",{className:"msp-section-header",children:[(0,kx.jsx)(pr,{svg:DJ})," ",`Actions (${a})`]}),o.map((s,l)=>(0,kx.jsx)(gg,{state:e,action:s,nodeRef:r,initiallyCollapsed:l===0?!this.props.alwaysExpandFirst&&this.props.initiallyCollapsed:this.props.initiallyCollapsed},`${s.id}`))]})}};var dt=Ot(Or());var r0=Ot(Po());var iA=class extends Mt{render(){var e;return(0,dt.jsxs)("div",{children:[(0,dt.jsx)(Nd,{icon:cP,title:"Plugin State"}),(0,dt.jsx)("div",{style:{marginBottom:"10px"},children:(0,dt.jsx)(Ci,{header:"Save Options",initiallyExpanded:!1,children:(0,dt.jsx)(fT,{})})}),(0,dt.jsx)(aA,{}),(0,dt.jsx)(JV,{}),(0,dt.jsx)(Nd,{title:"Save as File",accent:"blue"}),(0,dt.jsx)(pT,{}),((e=this.plugin.spec.components)===null||e===void 0?void 0:e.remoteState)!=="none"&&(0,dt.jsx)(hT,{})]})}},pT=class extends Mt{constructor(){super(...arguments),this.downloadToFileJson=()=>{var e,r;(r=(e=this.props).onAction)===null||r===void 0||r.call(e),Re.State.Snapshots.DownloadToFile(this.plugin,{type:"json"})},this.downloadToFileZip=()=>{var e,r;(r=(e=this.props).onAction)===null||r===void 0||r.call(e),Re.State.Snapshots.DownloadToFile(this.plugin,{type:"zip"})},this.open=e=>{var r,n;if(!e.target.files||!e.target.files[0]){this.plugin.log.error("No state file selected");return}(n=(r=this.props).onAction)===null||n===void 0||n.call(r),Re.State.Snapshots.OpenFile(this.plugin,{file:e.target.files[0]})}}render(){return(0,dt.jsxs)(dt.Fragment,{children:[(0,dt.jsxs)("div",{className:"msp-flex-row",children:[(0,dt.jsx)(vt,{icon:SS,onClick:this.downloadToFileJson,title:"Save the state description. Input data are loaded using the provided sources. Does not work if local files are used as input.",children:"State"}),(0,dt.jsx)(vt,{icon:SS,onClick:this.downloadToFileZip,title:"Save the state including the input data.",children:"Session"}),(0,dt.jsxs)("div",{className:"msp-btn msp-btn-block msp-btn-action msp-loader-msp-btn-file",children:[(0,dt.jsx)(pr,{svg:BJ,inline:!0})," Open ",(0,dt.jsx)("input",{onChange:this.open,type:"file",multiple:!1,accept:".molx,.molj"})]})]}),(0,dt.jsxs)("div",{className:"msp-help-text",style:{padding:"10px"},children:[(0,dt.jsx)(pr,{svg:uP})," This is an experimental feature and stored states/sessions might not be openable in a future version."]})]})}},fT=class extends Mt{componentDidMount(){this.subscribe(this.plugin.state.snapshotParams,()=>this.forceUpdate())}render(){return(0,dt.jsx)(Hr,{params:Gh.SnapshotParams,values:this.plugin.state.snapshotParams.value,onChangeValues:this.plugin.state.setSnapshotParams})}},aA=class t extends Mt{constructor(){super(...arguments),this.state={params:g.getDefaultValues(t.Params)},this.add=()=>{Re.State.Snapshots.Add(this.plugin,{name:this.state.params.name,description:this.state.params.description})},this.updateParams=e=>this.setState({params:e}),this.clear=()=>{Re.State.Snapshots.Clear(this.plugin,{})}}shouldComponentUpdate(e,r){return!Cg(this.props,e)||!Cg(this.state,r)}render(){return(0,dt.jsx)("div",{children:(0,dt.jsx)(TFe,{parent:this})})}};aA.Params={name:g.Text(),description:g.Text()};function ice(t,e,r){return e?t.managers.snapshot.state.entries.some(n=>(!r||n.snapshot.id!==r)&&n.key===e):!1}function TFe({parent:t}){let[e,r]=r0.useState({key:"",name:"",description:""}),n=()=>{Re.State.Snapshots.Add(t.plugin,{key:e.key,name:e.name,description:e.description}),r({key:"",name:"",description:""})},o=ice(t.plugin,e.key);return(0,dt.jsxs)(dt.Fragment,{children:[(0,dt.jsx)(ace,{state:e,setState:r,apply:n}),(0,dt.jsxs)("div",{className:"msp-flex-row",children:[(0,dt.jsx)(pt,{onClick:t.clear,svg:Hi,title:"Remove All"}),(0,dt.jsx)(vt,{onClick:n,icon:o?void 0:Fd,style:{textAlign:"right"},commit:o?"off":"on",disabled:o,children:o?"Key must be unique":"Add"})]})]})}var JV=class extends Mt{constructor(){super(...arguments),this.state={editingId:void 0},this.edit=e=>{let r=e.currentTarget.getAttribute("data-id");if(!r)return;let n=this.state.editingId;this.setState({editingId:r===n?void 0:r})},this.doneEdit=()=>this.setState({editingId:void 0}),this.apply=e=>{let r=e.currentTarget.getAttribute("data-id");r&&Re.State.Snapshots.Apply(this.plugin,{id:r})},this.remove=e=>{let r=e.currentTarget.getAttribute("data-id");r&&Re.State.Snapshots.Remove(this.plugin,{id:r})},this.moveUp=e=>{let r=e.currentTarget.getAttribute("data-id");r&&Re.State.Snapshots.Move(this.plugin,{id:r,dir:-1})},this.moveDown=e=>{let r=e.currentTarget.getAttribute("data-id");r&&Re.State.Snapshots.Move(this.plugin,{id:r,dir:1})},this.replace=e=>{let r=e.currentTarget.getAttribute("data-id");r&&Re.State.Snapshots.Replace(this.plugin,{id:r})}}componentDidMount(){this.subscribe(this.plugin.managers.snapshot.events.changed,()=>this.forceUpdate())}render(){let e=this.plugin.managers.snapshot.state.current,r=[];return this.plugin.managers.snapshot.state.entries.forEach(n=>{var o;r.push((0,dt.jsxs)("li",{className:"msp-flex-row",children:[(0,dt.jsxs)(vt,{"data-id":n.snapshot.id,onClick:this.apply,className:"msp-no-overflow",children:[(0,dt.jsxs)("span",{style:{fontWeight:n.snapshot.id===e?"bold":void 0},children:[!!n.key&&`[${n.key}] `,n.name||new Date(n.timestamp).toLocaleString()]})," ",(0,dt.jsx)("small",{children:`${n.snapshot.durationInMs?p0(n.snapshot.durationInMs,!1):""}`})]}),(0,dt.jsx)(pt,{svg:pl,"data-id":n.snapshot.id,title:"Edit",onClick:this.edit,flex:"28px"}),(0,dt.jsx)(pt,{svg:Ph,"data-id":n.snapshot.id,title:"Move Up",onClick:this.moveUp,flex:"20px"}),(0,dt.jsx)(pt,{svg:_h,"data-id":n.snapshot.id,title:"Move Down",onClick:this.moveDown,flex:"20px"}),(0,dt.jsx)(pt,{svg:NJ,"data-id":n.snapshot.id,title:"Replace",onClick:this.replace,flex:"20px"}),(0,dt.jsx)(pt,{svg:Hi,"data-id":n.snapshot.id,title:"Remove",onClick:this.remove,flex:"20px"})]},n.snapshot.id)),this.state.editingId===n.snapshot.id&&r.push((0,dt.jsx)(wFe,{entry:n,plugin:this.plugin,done:this.doneEdit},`${n.snapshot.id}-edit`));let i=n.image&&((o=this.plugin.managers.asset.get(n.image))===null||o===void 0?void 0:o.file);i&&r.push((0,dt.jsx)("li",{className:"msp-state-image-row",children:(0,dt.jsx)(vt,{"data-id":n.snapshot.id,onClick:this.apply,children:(0,dt.jsx)("img",{draggable:!1,src:URL.createObjectURL(i)})})},`${n.snapshot.id}-image`))}),(0,dt.jsx)(dt.Fragment,{children:(0,dt.jsx)("ul",{style:{listStyle:"none",marginTop:"10px"},className:"msp-state-list",children:r})})}};function ace({state:t,setState:e,apply:r}){let n=r0.useRef(),o=r0.useRef(),[i,a]=r0.useState(!1);return(0,dt.jsxs)(dt.Fragment,{children:[(0,dt.jsx)(Ga,{label:"Name",control:(0,dt.jsx)("input",{type:"text",value:t.name,placeholder:"Name",onChange:s=>e(U(w({},t),{name:s.target.value})),onKeyUp:s=>{var l;s.key==="Enter"&&((l=n.current)===null||l===void 0||l.focus())}})}),(0,dt.jsx)(Ga,{label:(0,dt.jsxs)(dt.Fragment,{children:["Key",(0,dt.jsx)(jB,{show:i,toggle:()=>a(s=>!s)})]}),control:(0,dt.jsx)("input",{type:"text",ref:n,value:t.key,placeholder:"Key (optional)",onChange:s=>e(U(w({},t),{key:s.target.value})),onKeyUp:s=>{var l;s.key==="Enter"&&((l=o.current)===null||l===void 0||l.focus())}})}),i&&(0,dt.jsx)("div",{className:"msp-control-offset",children:(0,dt.jsx)(IS,{description:"Optional snapshot key used to activate snapshots from descriptions, labels, etc."})}),(0,dt.jsx)("div",{className:"msp-flex-row msp-text-area-wrapper",style:{marginBottom:1},children:(0,dt.jsx)("textarea",{ref:o,placeholder:`Markdown Description

- Use [title](#key) to link to a snapshot`,className:"msp-form-control",value:t.description,onChange:s=>e(U(w({},t),{description:s.target.value})),onKeyUp:s=>{s.key==="Enter"&&s.ctrlKey&&r(t)}})})]})}function wFe({entry:t,plugin:e,done:r}){var n,o,i;let[a,s]=r0.useState({key:(n=t.key)!==null&&n!==void 0?n:"",name:(o=t.name)!==null&&o!==void 0?o:"",description:(i=t.description)!==null&&i!==void 0?i:""}),l=()=>{e.managers.snapshot.update(t,a),r()},c=ice(e,a.key,t.snapshot.id);return(0,dt.jsxs)(dt.Fragment,{children:[(0,dt.jsx)(ace,{state:a,setState:s,apply:l}),(0,dt.jsx)("div",{className:"msp-flex-row",style:{marginBottom:1},children:(0,dt.jsx)(vt,{onClick:l,icon:c?void 0:Pc,style:{textAlign:"right"},commit:c?"off":"on",disabled:c,children:c?"Key must be unique":"Apply"})})]})}var hT=class extends Mt{constructor(){super(...arguments),this.Params={name:g.Text(),options:g.Group({description:g.Text(),playOnLoad:g.Boolean(!1),serverUrl:g.Text(this.plugin.config.get(Wt.State.CurrentServer))})},this.state={params:g.getDefaultValues(this.Params),entries:Ui(),isBusy:!1},this.ListOnlyParams={options:g.Group({serverUrl:g.Text(this.plugin.config.get(Wt.State.CurrentServer))},{isFlat:!0})},this._mounted=!1,this.refresh=()=>N(this,null,function*(){try{this.setState({isBusy:!0}),this.plugin.config.set(Wt.State.CurrentServer,this.state.params.options.serverUrl);let e=(yield this.plugin.runTask(this.plugin.fetch({url:this.serverUrl("list"),type:"json"})))||[];e.sort((n,o)=>n.isSticky===o.isSticky?n.timestamp-o.timestamp:n.isSticky?-1:1);let r=Ui().asMutable();for(let n of e)r.set(n.id,U(w({},n),{url:this.serverUrl(`get/${n.id}`),removeUrl:this.serverUrl(`remove/${n.id}`)}));this._mounted&&this.setState({entries:r.asImmutable(),isBusy:!1})}catch(e){console.error(e),this.plugin.log.error("Error fetching remote snapshots"),this._mounted&&this.setState({entries:Ui(),isBusy:!1})}}),this.upload=()=>N(this,null,function*(){this.setState({isBusy:!0}),this.plugin.config.set(Wt.State.CurrentServer,this.state.params.options.serverUrl),yield Re.State.Snapshots.Upload(this.plugin,{name:this.state.params.name,description:this.state.params.options.description,playOnLoad:this.state.params.options.playOnLoad,serverUrl:this.state.params.options.serverUrl}),this.plugin.log.message("Snapshot uploaded."),this._mounted&&(this.setState({isBusy:!1}),this.refresh())}),this.fetch=e=>N(this,null,function*(){let r=e.currentTarget.getAttribute("data-id");if(!r)return;let n=this.state.entries.get(r);if(n){this.setState({isBusy:!0});try{yield Re.State.Snapshots.Fetch(this.plugin,{url:n.url})}finally{this._mounted&&this.setState({isBusy:!1})}}}),this.remove=e=>N(this,null,function*(){let r=e.currentTarget.getAttribute("data-id");if(!r)return;let n=this.state.entries.get(r);if(n){this.setState({entries:this.state.entries.remove(r)});try{yield fetch(n.removeUrl)}catch(o){console.error(o)}}})}componentDidMount(){this.refresh(),this._mounted=!0}componentWillUnmount(){super.componentWillUnmount(),this._mounted=!1}serverUrl(e){return e?kf(this.state.params.options.serverUrl,e):this.state.params.options.serverUrl}render(){return(0,dt.jsxs)(dt.Fragment,{children:[(0,dt.jsx)(Nd,{title:"Remote States",accent:"blue"}),!this.props.listOnly&&(0,dt.jsxs)(dt.Fragment,{children:[(0,dt.jsx)(Hr,{params:this.Params,values:this.state.params,onEnter:this.upload,onChange:e=>{this.setState({params:U(w({},this.state.params),{[e.name]:e.value})})},isDisabled:this.state.isBusy}),(0,dt.jsxs)("div",{className:"msp-flex-row",children:[(0,dt.jsx)(pt,{onClick:this.refresh,disabled:this.state.isBusy,svg:TS}),(0,dt.jsx)(vt,{icon:IJ,onClick:this.upload,disabled:this.state.isBusy,commit:!0,children:"Upload"})]})]}),(0,dt.jsx)(ez,{entries:this.state.entries,isBusy:this.state.isBusy,serverUrl:this.state.params.options.serverUrl,fetch:this.fetch,remove:this.props.listOnly?void 0:this.remove}),this.props.listOnly&&(0,dt.jsxs)("div",{style:{marginTop:"10px"},children:[(0,dt.jsx)(Hr,{params:this.ListOnlyParams,values:this.state.params,onEnter:this.upload,onChange:e=>{this.setState({params:U(w({},this.state.params),{[e.name]:e.value})})},isDisabled:this.state.isBusy}),(0,dt.jsx)("div",{className:"msp-flex-row",children:(0,dt.jsx)(vt,{onClick:this.refresh,disabled:this.state.isBusy,icon:TS,children:"Refresh"})})]})]})}},ez=class extends Kn{constructor(){super(...arguments),this.open=e=>N(this,null,function*(){let r=e.currentTarget.getAttribute("data-id");if(!r)return;let n=this.props.entries.get(r);if(!n)return;e.preventDefault();let o=`${window.location}`,i=o.indexOf("?");i>0&&(o=o.substr(0,i)),window.open(`${o}?snapshot-url=${encodeURIComponent(n.url)}`,"_blank")})}render(){return(0,dt.jsx)("ul",{style:{listStyle:"none",marginTop:"10px"},className:"msp-state-list",children:this.props.entries.valueSeq().map(e=>(0,dt.jsxs)("li",{className:"msp-flex-row",children:[(0,dt.jsxs)(vt,{"data-id":e.id,onClick:this.props.fetch,disabled:this.props.isBusy,onContextMenu:this.open,title:"Click to download, right-click to open in a new tab.",children:[e.name||new Date(e.timestamp).toLocaleString()," ",(0,dt.jsx)("small",{children:e.description})]}),!e.isSticky&&this.props.remove&&(0,dt.jsx)(pt,{svg:Hi,"data-id":e.id,title:"Remove",onClick:this.props.remove,disabled:this.props.isBusy,small:!0})]},e.id))})}};var pn=Ot(Or());var gT=class extends Mt{constructor(){super(...arguments),this.state={showActions:!0}}componentDidMount(){this.subscribe(this.plugin.state.events.cell.created,e=>{e.cell.transform.parent===kt.RootRef&&this.forceUpdate()}),this.subscribe(this.plugin.state.events.cell.removed,e=>{e.parent===kt.RootRef&&this.forceUpdate()})}static getDerivedStateFromProps(e,r){let n=e.state.tree.root.ref,i=e.state.tree.children.get(n).size===0;return r.showActions===i?null:{showActions:i}}render(){let e=this.props.state.tree.root.ref;return this.state.showActions?(0,pn.jsxs)("div",{style:{margin:"10px",cursor:"default"},children:[(0,pn.jsx)("p",{children:"Nothing to see here yet."}),(0,pn.jsxs)("p",{children:["Structures and Volumes can be loaded from the ",(0,pn.jsx)(pr,{svg:CS})," tab."]})]}):(0,pn.jsx)(tz,{cell:this.props.state.cells.get(e),depth:0})}},tz=class t extends Mt{constructor(){super(...arguments),this.state={isCollapsed:!!this.props.cell.state.isCollapsed,isNull:t.isNull(this.props.cell),showLabel:t.showLabel(this.props.cell)}}is(e){return e.ref===this.ref&&e.state===this.props.cell.parent}get ref(){return this.props.cell.transform.ref}componentDidMount(){this.subscribe(this.plugin.state.events.cell.stateUpdated,e=>{this.props.cell===e.cell&&this.is(e)&&e.state.cells.has(this.ref)&&(this.state.isCollapsed!==!!e.cell.state.isCollapsed||this.state.isNull!==t.isNull(e.cell)||this.state.showLabel!==t.showLabel(e.cell))&&this.forceUpdate()}),this.subscribe(this.plugin.state.events.cell.created,e=>{this.props.cell.parent===e.state&&this.ref===e.cell.transform.parent&&this.forceUpdate()}),this.subscribe(this.plugin.state.events.cell.removed,e=>{this.props.cell.parent===e.state&&this.ref===e.parent&&this.forceUpdate()})}static getDerivedStateFromProps(e,r){let n=t.isNull(e.cell),o=t.showLabel(e.cell);return!!e.cell.state.isCollapsed===r.isCollapsed&&r.isNull===n&&r.showLabel===o?null:{isCollapsed:!!e.cell.state.isCollapsed,isNull:n,showLabel:o}}static hasDecorator(e){var r;let n=e.parent.tree.children.get(e.transform.ref);return n.size!==1?!1:!!(!((r=e.parent)===null||r===void 0)&&r.tree.transforms.get(n.first()).transformer.definition.isDecorator)}static isNull(e){return!e||!e.parent||e.obj===Rr.Null||!e.parent.tree.transforms.has(e.transform.ref)}static showLabel(e){return e.transform.ref!==kt.RootRef&&(e.status!=="ok"||!e.state.isGhost&&!t.hasDecorator(e))}render(){if(this.state.isNull)return null;let e=this.props.cell,r=e.parent.tree.children.get(this.ref);if(!this.state.showLabel)return r.size===0?null:(0,pn.jsx)(pn.Fragment,{children:r.map(o=>(0,pn.jsx)(t,{cell:e.parent.cells.get(o),depth:this.props.depth},o))});let n=this.props.depth+1;return(0,pn.jsxs)(pn.Fragment,{children:[(0,pn.jsx)(rz,{cell:e,depth:this.props.depth}),r.size===0?void 0:(0,pn.jsx)("div",{style:{display:this.state.isCollapsed?"none":"block"},children:r.map(o=>(0,pn.jsx)(t,{cell:e.parent.cells.get(o),depth:n},o))})]})}},rz=class extends Mt{constructor(){super(...arguments),this.state={isCurrent:this.props.cell.parent.current===this.ref,isCollapsed:!!this.props.cell.state.isCollapsed,action:void 0,currentAction:void 0},this.setCurrent=e=>{e?.preventDefault(),e?.currentTarget.blur(),Re.State.SetCurrentObject(this.plugin,{state:this.props.cell.parent,ref:this.ref})},this.setCurrentRoot=e=>{e?.preventDefault(),e?.currentTarget.blur(),Re.State.SetCurrentObject(this.plugin,{state:this.props.cell.parent,ref:kt.RootRef})},this.remove=e=>{e?.preventDefault(),Re.State.RemoveObject(this.plugin,{state:this.props.cell.parent,ref:this.ref,removeParentGhosts:!0})},this.toggleVisible=e=>{e.preventDefault(),Re.State.ToggleVisibility(this.plugin,{state:this.props.cell.parent,ref:this.ref}),e.currentTarget.blur()},this.toggleExpanded=e=>{e.preventDefault(),Re.State.ToggleExpanded(this.plugin,{state:this.props.cell.parent,ref:this.ref}),e.currentTarget.blur()},this.highlight=e=>{e.preventDefault(),Re.Interactivity.Object.Highlight(this.plugin,{state:this.props.cell.parent,ref:this.ref}),e.currentTarget.blur()},this.clearHighlight=e=>{e.preventDefault(),Re.Interactivity.ClearHighlights(this.plugin),e.currentTarget.blur()},this.hideApply=()=>{this.setCurrentRoot()},this.selectAction=e=>{e&&(0,e?.value)()}}is(e){return e.ref===this.ref&&e.state===this.props.cell.parent}get ref(){return this.props.cell.transform.ref}componentDidMount(){this.subscribe(this.plugin.state.events.cell.stateUpdated.pipe(d0(e=>this.is(e)),bT(33)),e=>{this.forceUpdate()}),this.subscribe(this.props.cell.parent.behaviors.currentObject,e=>{if(!this.is(e)){this.state.isCurrent&&e.state.transforms.has(this.ref)&&this._setCurrent(this.props.cell.parent.current===this.ref,this.state.isCollapsed);return}e.state.transforms.has(this.ref)&&this._setCurrent(this.props.cell.parent.current===this.ref,!!this.props.cell.state.isCollapsed)})}_setCurrent(e,r){e?this.setState({isCurrent:e,action:"options",currentAction:void 0,isCollapsed:r}):this.setState({isCurrent:e,action:void 0,currentAction:void 0,isCollapsed:r})}static getDerivedStateFromProps(e,r){let n=e.cell.parent.current===e.cell.transform.ref,o=!!e.cell.state.isCollapsed;return r.isCollapsed===o&&r.isCurrent===n?null:{isCurrent:n,isCollapsed:o,action:void 0,currentAction:void 0}}get actions(){let e=this.props.cell,r=[...e.parent.actions.fromCell(e,this.plugin)];if(r.length!==0)return r.sort((n,o)=>n.definition.display.name<o.definition.display.name?-1:n.definition.display.name===o.definition.display.name?0:1),[wt.Header("Apply Action"),...r.map(n=>wt.Item(n.definition.display.name,()=>this.setState({action:"apply",currentAction:n})))]}updates(e){let r=this.props.cell,n=Af.getDecoratorChain(r.parent,r.transform.ref),o=[];for(let i=n.length-1;i>=0;i--){let a=n[i];o.push((0,pn.jsx)(Xs,{state:r.parent,transform:a.transform,noMargin:!0,wrapInExpander:!0,expanderHeaderLeftMargin:e},`${a.transform.transformer.id}-${i}`))}return(0,pn.jsx)("div",{className:"msp-tree-updates-wrapper",children:o})}render(){let e=this.props.cell,r=e.transform;if(!e)return null;let n=this.is(e.parent.behaviors.currentObject.value),o=e.status!=="error"&&e.status!=="ok",i;if(e.status==="error"||!e.obj){let p=e.status==="error"?e.errorText:r.transformer.definition.display.name;i=(0,pn.jsxs)(vt,{className:"msp-btn-tree-label msp-no-hover-outline",noOverflow:!0,title:p,onClick:this.state.isCurrent?this.setCurrentRoot:this.setCurrent,disabled:o,children:[e.status==="error"&&(0,pn.jsxs)("b",{children:["[",e.status,"]"]})," ",(0,pn.jsx)("span",{children:p})]})}else{let p=e.obj,h=`${p.label} ${p.description?p.description:""}`;i=(0,pn.jsxs)(vt,{className:`msp-btn-tree-label msp-type-class-${p.type.typeClass}`,noOverflow:!0,disabled:o,title:h,onClick:this.state.isCurrent?this.setCurrentRoot:this.setCurrent,children:[(0,pn.jsx)("span",{children:p.label})," ",p.description?(0,pn.jsx)("small",{children:p.description}):void 0]})}let a=e.parent.tree.children.get(this.ref),s=e.state,l=(0,pn.jsx)(pt,{svg:s.isCollapsed?Ls:Rs,flex:"20px",disabled:o,onClick:this.toggleExpanded,transparent:!0,className:"msp-no-hover-outline",style:{visibility:a.size>0?"visible":"hidden"}}),c=e.state.isLocked?void 0:(0,pn.jsx)(pt,{svg:Hi,onClick:this.remove,disabled:o,small:!0,toggleState:!1}),u=(0,pn.jsx)(pt,{svg:s.isHidden?Ec:Ic,toggleState:!1,disabled:o,small:!0,onClick:this.toggleVisible}),d={marginLeft:`${this.props.depth*8}px`},m=(0,pn.jsxs)("div",{className:`msp-flex-row msp-tree-row${n?" msp-tree-row-current":""}`,onMouseEnter:this.highlight,onMouseLeave:this.clearHighlight,style:d,children:[l,i,c,u]});if(!n)return m;if(this.state.action==="apply"&&this.state.currentAction)return(0,pn.jsxs)("div",{style:{marginBottom:"1px"},children:[m,(0,pn.jsx)(Ua,{header:`Apply ${this.state.currentAction.definition.display.name}`,initialExpanded:!0,hideExpander:!0,hideOffset:!1,onHeaderClick:this.hideApply,topRightIcon:ml,headerLeftMargin:`${this.props.depth*8+21}px`,children:(0,pn.jsx)(gg,{onApply:this.hideApply,state:this.props.cell.parent,action:this.state.currentAction,nodeRef:this.props.cell.transform.ref,hideHeader:!0,noMargin:!0})})]});if(this.state.action==="options"){let p=this.actions,h=this.updates(`${this.props.depth*8+21}px`);return(0,pn.jsxs)("div",{style:{marginBottom:"1px"},children:[m,h,p&&(0,pn.jsx)("div",{style:{marginLeft:`${this.props.depth*8+21}px`,marginTop:"-1px"},children:(0,pn.jsx)(wt,{items:p,onSelect:this.selectAction})})]})}return m}};var nz=class extends Mt{componentDidMount(){this.subscribe(this.plugin.state.behaviors.events.changed,()=>this.forceUpdate())}render(){let e=[];return this.plugin.customImportControls.forEach((r,n)=>{e.push((0,ar.jsx)(r,{initiallyCollapsed:this.props.initiallyCollapsed},n))}),e.length>0?(0,ar.jsx)(ar.Fragment,{children:e}):null}},sA=class extends Mt{constructor(){var e;super(...arguments),this.state={tab:this.plugin.behaviors.layout.leftPanelTabName.value},this.set=r=>{if(this.state.tab===r){this.setState({tab:"none"},()=>this.plugin.behaviors.layout.leftPanelTabName.next("none")),Re.Layout.Update(this.plugin,{state:{regionState:U(w({},this.plugin.layout.state.regionState),{left:"collapsed"})}});return}this.setState({tab:r},()=>this.plugin.behaviors.layout.leftPanelTabName.next(r)),this.plugin.layout.state.regionState.left!=="full"&&Re.Layout.Update(this.plugin,{state:{regionState:U(w({},this.plugin.layout.state.regionState),{left:"full"})}})},this.tabs={none:(0,ar.jsx)(ar.Fragment,{}),root:(0,ar.jsxs)(ar.Fragment,{children:[(0,ar.jsx)(Nd,{icon:CS,title:"Home"}),(0,ar.jsx)(oA,{state:this.plugin.state.data,nodeRef:kt.RootRef,hideHeader:!0,initiallyCollapsed:!0,alwaysExpandFirst:!0}),(0,ar.jsx)(nz,{}),((e=this.plugin.spec.components)===null||e===void 0?void 0:e.remoteState)!=="none"&&(0,ar.jsx)(hT,{listOnly:!0})]}),data:(0,ar.jsxs)(ar.Fragment,{children:[(0,ar.jsx)(Nd,{icon:aB,title:(0,ar.jsxs)(ar.Fragment,{children:[(0,ar.jsx)(az,{})," State Tree"]})}),(0,ar.jsx)(gT,{state:this.plugin.state.data})]}),states:(0,ar.jsx)(iA,{}),settings:(0,ar.jsxs)(ar.Fragment,{children:[(0,ar.jsx)(Nd,{icon:pl,title:"Plugin Settings"}),(0,ar.jsx)(iz,{})]}),help:(0,ar.jsxs)(ar.Fragment,{children:[(0,ar.jsx)(Nd,{icon:Bs,title:"Help"}),(0,ar.jsx)(zD,{})]})}}componentDidMount(){this.subscribe(this.plugin.behaviors.layout.leftPanelTabName,e=>{this.state.tab!==e&&this.setState({tab:e}),e==="none"&&this.plugin.layout.state.regionState.left!=="collapsed"&&Re.Layout.Update(this.plugin,{state:{regionState:U(w({},this.plugin.layout.state.regionState),{left:"collapsed"})}})}),this.subscribe(this.plugin.state.data.events.changed,({state:e})=>{this.state.tab==="data"&&e.cells.size===1&&this.set("root")})}render(){let e=this.state.tab;return(0,ar.jsxs)("div",{className:"msp-left-panel-controls",children:[(0,ar.jsxs)("div",{className:"msp-left-panel-controls-buttons",children:[(0,ar.jsx)(pt,{svg:CS,toggleState:e==="root",transparent:!0,onClick:()=>this.set("root"),title:"Home"}),(0,ar.jsx)(oz,{set:this.set}),(0,ar.jsx)(pt,{svg:cP,toggleState:e==="states",transparent:!0,onClick:()=>this.set("states"),title:"Plugin State"}),(0,ar.jsx)(pt,{svg:Bs,toggleState:e==="help",transparent:!0,onClick:()=>this.set("help"),title:"Help"}),(0,ar.jsx)("div",{className:"msp-left-panel-controls-buttons-bottom",children:(0,ar.jsx)(pt,{svg:pl,toggleState:e==="settings",transparent:!0,onClick:()=>this.set("settings"),title:"Settings"})})]}),(0,ar.jsx)("div",{className:"msp-scrollable-container",children:this.tabs[e]})]})}},oz=class extends Mt{constructor(){super(...arguments),this.state={changed:!1}}get tab(){return this.plugin.behaviors.layout.leftPanelTabName.value}componentDidMount(){this.subscribe(this.plugin.behaviors.layout.leftPanelTabName,e=>{this.tab==="data"?this.setState({changed:!1}):this.forceUpdate()}),this.subscribe(this.plugin.state.data.events.changed,e=>{this.tab!=="data"&&this.setState({changed:!0})})}render(){return(0,ar.jsx)(pt,{svg:aB,toggleState:this.tab==="data",transparent:!0,onClick:()=>this.props.set("data"),title:"State Tree",style:{position:"relative"},extraContent:this.state.changed?(0,ar.jsx)("div",{className:"msp-left-panel-controls-button-data-dirty"}):void 0})}},iz=class extends Mt{constructor(){super(...arguments),this.setSettings=e=>{Re.Canvas3D.SetSettings(this.plugin,{settings:{[e.name]:e.value}})},this.setCanvas3DContextProps=e=>{var r;(r=this.plugin.canvas3dContext)===null||r===void 0||r.setProps({[e.name]:e.value}),this.plugin.events.canvas3d.settingsUpdated.next(void 0)}}componentDidMount(){this.subscribe(this.plugin.events.canvas3d.settingsUpdated,()=>this.forceUpdate()),this.subscribe(this.plugin.layout.events.updated,()=>this.forceUpdate()),this.plugin.canvas3d&&this.subscribe(this.plugin.canvas3d.camera.stateChanged.pipe(qc(500,void 0,{leading:!0,trailing:!0})),e=>{(e.radiusMax!==void 0||e.radius!==void 0)&&this.forceUpdate()})}render(){return(0,ar.jsxs)(ar.Fragment,{children:[this.plugin.canvas3d&&this.plugin.canvas3dContext&&(0,ar.jsxs)(ar.Fragment,{children:[(0,ar.jsx)(Nd,{title:"Viewport"}),(0,ar.jsx)(Hr,{params:Fa,values:this.plugin.canvas3d.props,onChange:this.setSettings}),(0,ar.jsx)(Hr,{params:Ad.Params,values:this.plugin.canvas3dContext.props,onChange:this.setCanvas3DContextProps})]}),(0,ar.jsx)(Nd,{title:"Behavior"}),(0,ar.jsx)(gT,{state:this.plugin.state.behaviors})]})}},az=class extends Mt{constructor(){super(...arguments),this.remove=e=>{e.preventDefault(),Re.State.RemoveObject(this.plugin,{state:this.plugin.state.data,ref:kt.RootRef})}}componentDidMount(){this.subscribe(this.plugin.state.events.cell.created,e=>{e.cell.transform.parent===kt.RootRef&&this.forceUpdate()}),this.subscribe(this.plugin.state.events.cell.removed,e=>{e.parent===kt.RootRef&&this.forceUpdate()})}render(){return this.plugin.state.data.tree.children.get(kt.RootRef).size===0?null:(0,ar.jsx)(pt,{svg:Hi,onClick:this.remove,title:"Remove All",style:{display:"inline-block"},small:!0,className:"msp-no-hover-outline",transparent:!0})}};var Do=Ot(Or()),mce=Ot(Po());var lA=Ot(Or()),lce=Ot(Po());var sce=5,cA=class extends Mt{constructor(){super(...arguments),this.parentDiv=lce.createRef(),this.lastMouseOverSeqIdx=-1,this.highlightQueue=new ln,this.lociHighlightProvider=(e,r)=>{this.props.sequenceWrapper.markResidue(e.loci,r)&&this.updateMarker()},this.lociSelectionProvider=(e,r)=>{this.props.sequenceWrapper.markResidue(e.loci,r)&&this.updateMarker()},this.contextMenu=e=>{e.preventDefault()},this.mouseDownLoci=void 0,this.mouseDown=e=>{e.stopPropagation();let r=this.getSeqIdx(e),n=this.getLoci(r),o=ih(e.nativeEvent),i=ny(e.nativeEvent),a=K1(e.nativeEvent);this.click(n,o,i,a),this.mouseDownLoci=n},this.mouseUp=e=>{if(e.stopPropagation(),this.mouseDownLoci===void 0)return;let r=this.getSeqIdx(e),n=this.getLoci(r);if(n&&!z.Loci.areEqual(this.mouseDownLoci,n)){let o=ih(e.nativeEvent),i=ny(e.nativeEvent),a=K1(e.nativeEvent),s=this.mouseDownLoci.elements[0],l=n.elements[0],c=Math.min(we.min(s.indices),we.min(l.indices)),u=Math.max(we.max(s.indices),we.max(l.indices)),d=z.Loci(n.structure,[{unit:s.unit,indices:we.ofRange(c,u)}]);this.click(z.Loci.subtract(d,this.mouseDownLoci),o,i,a)}this.mouseDownLoci=void 0},this.location=z.Location.create(void 0),this.mouseMove=e=>{e.stopPropagation();let r=ih(e.nativeEvent),n=ny(e.nativeEvent),o=K1(e.nativeEvent),i=e.target;if(!i||!i.getAttribute){if(this.lastMouseOverSeqIdx===-1)return;this.lastMouseOverSeqIdx=-1,this.highlightQueue.next({seqIdx:-1,buttons:r,button:n,modifiers:o});return}let a=i.hasAttribute("data-seqid")?+i.getAttribute("data-seqid"):-1;if(this.lastMouseOverSeqIdx!==a)if(this.lastMouseOverSeqIdx=a,this.mouseDownLoci!==void 0){let s=this.getLoci(a);this.hover(s,yn.Flag.None,yn.Flag.None,U(w({},o),{shift:!0}))}else this.highlightQueue.next({seqIdx:a,buttons:r,button:n,modifiers:o})},this.mouseLeave=e=>{if(e.stopPropagation(),this.mouseDownLoci=void 0,this.lastMouseOverSeqIdx===-1)return;this.lastMouseOverSeqIdx=-1;let r=ih(e.nativeEvent),n=ny(e.nativeEvent),o=K1(e.nativeEvent);this.highlightQueue.next({seqIdx:-1,buttons:r,button:n,modifiers:o})}}get sequenceNumberPeriod(){return this.props.sequenceNumberPeriod!==void 0?this.props.sequenceNumberPeriod:this.props.sequenceWrapper.length>10?10:this.getSequenceNumber(this.props.sequenceWrapper.length-1).length>1?5:1}componentDidMount(){this.plugin.managers.interactivity.lociHighlights.addProvider(this.lociHighlightProvider),this.plugin.managers.interactivity.lociSelects.addProvider(this.lociSelectionProvider),this.subscribe(this.highlightQueue.pipe(qc(3*16.666,void 0,{leading:!0,trailing:!0})),e=>{let r=this.getLoci(e.seqIdx<0?void 0:e.seqIdx);this.hover(r,e.buttons,e.button,e.modifiers)})}componentWillUnmount(){super.componentWillUnmount(),this.plugin.managers.interactivity.lociHighlights.removeProvider(this.lociHighlightProvider),this.plugin.managers.interactivity.lociSelects.removeProvider(this.lociSelectionProvider)}getLoci(e){if(e!==void 0){let r=this.props.sequenceWrapper.getLoci(e);if(!z.Loci.isEmpty(r))return r}}getSeqIdx(e){let r,n=e.target;return n&&n.getAttribute&&(r=n.hasAttribute("data-seqid")?+n.getAttribute("data-seqid"):void 0),r}hover(e,r,n,o){let i={current:rt.Loci.Empty,buttons:r,button:n,modifiers:o};e!==void 0&&!z.Loci.isEmpty(e)&&(i.current={loci:e}),this.plugin.behaviors.interaction.hover.next(i)}click(e,r,n,o){let i={current:rt.Loci.Empty,buttons:r,button:n,modifiers:o};e!==void 0&&!z.Loci.isEmpty(e)&&(i.current={loci:e}),this.plugin.behaviors.interaction.click.next(i)}getBackgroundColor(e){return typeof e>"u"&&console.error("unexpected marker value"),e===0?"":e%2===0?"rgb(51, 255, 25)":"rgb(255, 102, 153)"}getResidueClass(e,r){return r.length>1?this.props.sequenceWrapper.residueClass(e)+(e===0?" msp-sequence-residue-long-begin":" msp-sequence-residue-long"):this.props.sequenceWrapper.residueClass(e)}residue(e,r,n){return(0,lA.jsx)("span",{"data-seqid":e,style:{backgroundColor:this.getBackgroundColor(n)},className:this.getResidueClass(e,r),children:`\u200B${r}\u200B`},e)}getSequenceNumberClass(e,r,n){let o=["msp-sequence-number"];return r.startsWith("-")?n.length>1&&e>0?o.push("msp-sequence-number-long-negative"):o.push("msp-sequence-number-negative"):n.length>1&&e>0&&o.push("msp-sequence-number-long"),o.join(" ")}getSequenceNumber(e){let r="",n=this.props.sequenceWrapper.getLoci(e),o=z.Loci.getFirstLocation(n,this.location);if(o)if(Pe.isAtomic(o.unit)){let i=Ne.residue.auth_seq_id(o),a=Ne.residue.pdbx_PDB_ins_code(o);r=`${i}${a||""}`}else Pe.isCoarse(o.unit)&&(r=`${e+1}`);return r}padSeqNum(e){return e.length<sce?e+new Array(sce-e.length+1).join("\xA0"):e}getSequenceNumberSpan(e,r){let n=this.getSequenceNumber(e);return(0,lA.jsx)("span",{className:this.getSequenceNumberClass(e,n,r),children:this.padSeqNum(n)},`marker-${e}`)}updateMarker(){if(!this.parentDiv.current)return;let e=this.parentDiv.current.children,{markerArray:r}=this.props.sequenceWrapper,n=!this.props.hideSequenceNumbers,o=this.sequenceNumberPeriod,i=0;for(let a=0,s=r.length;a<s;a++){n&&a%o===0&&a<s&&i++;let l=e[i];if(!l)return;i++;let c=this.getBackgroundColor(r[a]);l.style.backgroundColor!==c&&(l.style.backgroundColor=c)}}render(){let e=this.props.sequenceWrapper,r=[],n=!this.props.hideSequenceNumbers,o=this.sequenceNumberPeriod;for(let i=0,a=e.length;i<a;++i){let s=e.residueLabel(i);n&&i%o===0&&i<a&&(r[r.length]=this.getSequenceNumberSpan(i,s)),r[r.length]=this.residue(i,s,e.markerArray[i])}return this.updateMarker(),(0,lA.jsx)("div",{className:"msp-sequence-wrapper",onContextMenu:this.contextMenu,onMouseDown:this.mouseDown,onMouseUp:this.mouseUp,onMouseMove:this.mouseMove,onMouseLeave:this.mouseLeave,ref:this.parentDiv,children:r})}};var $m=class{markResidue(e,r){return So(e)?ka(this.markerArray,Oe.ofLength(this.length),r):this.mark(e,r)}constructor(e,r,n){this.data=e,this.markerArray=r,this.length=n}};var uA=class extends $m{seqId(e){return this.sequence.seqId.value(e)}residueLabel(e){return this.sequence.label.value(e)||this.sequence.code.value(e)}residueColor(e){return this.missing.has(this.modelNum,this.asymId,this.seqId(e))?ut.grey:ut.black}residueClass(e){return this.missing.has(this.modelNum,this.asymId,this.seqId(e))?"msp-sequence-missing":"msp-sequence-present"}mark(e,r){let n=!1,{structure:o}=this.data,i=a=>this.sequence.index(a);if(z.Loci.is(e)){if(!ue.areRootsEquivalent(e.structure,o))return!1;e=z.Loci.remap(e,o);for(let a of e.elements)this.unitMap.has(a.unit.id)&&(Pe.isAtomic(a.unit)?n=PFe(a,r,this.markerArray,i)||n:n=EFe(a,r,this.markerArray,i)||n)}else if(ue.isLoci(e)){if(!ue.areRootsEquivalent(e.structure,o))return!1;ka(this.markerArray,this.observed,r)&&(n=!0)}return n}getLoci(e){let r=_Fe(this.data.units[0].chainGroupId,this.data.units[0].conformation.operator.name,this.seqId(e));return hn.toLociWithSourceUnits(yU.run(r,this.data.structure))}constructor(e){let r=z.Location.create(e.structure,e.units[0],e.units[0].elements[0]),n=e.units[0].model.sequence.byEntityKey[Ne.entity.key(r)],o=n.sequence.length,i=new Uint8Array(o);super(e,i,o),this.unitMap=new Map;for(let s of e.units)this.unitMap.set(s.id,s);this.sequence=n.sequence,this.missing=e.units[0].model.properties.missingResidues,this.modelNum=e.units[0].model.modelNum,this.asymId=Pe.isAtomic(e.units[0])?Ne.chain.label_asym_id(r):Ne.coarse.asym_id(r);let a=[];for(let s=0;s<o;++s)this.missing.has(this.modelNum,this.asymId,this.seqId(s))&&a.push(s);this.observed=we.subtract(Oe.ofBounds(0,o),tr.ofSortedArray(a))}};function _Fe(t,e,r){return cn.generators.atoms({unitTest:n=>Ne.unit.chainGroupId(n.element)===t&&Ne.unit.operator_name(n.element)===e,residueTest:n=>n.element.unit.kind===0?Ne.residue.label_seq_id(n.element)===r:Ne.coarse.seq_id_begin(n.element)<=r&&Ne.coarse.seq_id_end(n.element)>=r})}function PFe(t,e,r,n){let{model:o,elements:i}=t.unit,{index:a}=o.atomicHierarchy.residueAtomSegments,{label_seq_id:s}=o.atomicHierarchy.residues;return we.forEachSegment(t.indices,l=>a[i[l]],l=>{let c=s.value(l);uv(r,n(c),e)}),!0}function EFe(t,e,r,n){let{model:o,elements:i}=t.unit,a=Pe.isSpheres(t.unit)?o.coarseHierarchy.spheres.seq_id_begin:o.coarseHierarchy.gaussians.seq_id_begin,s=Pe.isSpheres(t.unit)?o.coarseHierarchy.spheres.seq_id_end:o.coarseHierarchy.gaussians.seq_id_end;return we.forEach(t.indices,l=>{let c=i[l];for(let u=n(a.value(c)),d=n(s.value(c));u<=d;u++)uv(r,u,e)}),!0}var dA=class extends $m{residueLabel(e){return this.sequence[e]}residueColor(e){return ut.black}residueClass(e){return"msp-sequence-present"}mark(e,r){let n=!1,{structure:o}=this.data;if(z.Loci.is(e)){if(!ue.areRootsEquivalent(e.structure,o))return!1;e=z.Loci.remap(e,o);for(let i of e.elements){let a=this.unitMap.get(i.unit.id);if(a){let{index:s}=i.unit.model.atomicHierarchy.residueAtomSegments;we.forEach(i.indices,l=>{let c=this.sequenceIndices.get(s[a.elements[l]]);c!==void 0&&ka(this.markerArray,Oe.ofSingleton(c),r)&&(n=!0)})}}}else if(ue.isLoci(e)){if(!ue.areRootsEquivalent(e.structure,o))return!1;ka(this.markerArray,Oe.ofBounds(0,this.length),r)&&(n=!0)}return n}getLoci(e){let r=[],n=this.residueIndices.get(e);if(n!==void 0){let o=this.seqToUnit.get(e),{offsets:i}=o.model.atomicHierarchy.residueAtomSegments,a=tr.findPredecessorIndex(o.elements,i[n]),s=tr.findPredecessorIndex(o.elements,i[n+1]);r.push({unit:o,indices:Oe.ofBounds(a,s)})}return z.Loci(this.data.structure,r)}constructor(e){let r=[],n=new Map,o=new Map,i=new Map;for(let l=0,c=e.units.length;l<c;++l){let u=e.units[l],{residueAtomSegments:d,atoms:m}=u.model.atomicHierarchy,p=$r.transientSegments(d,u.elements);for(;p.hasNext;){let{index:h}=p.move();n.set(h,r.length),o.set(r.length,h),i.set(r.length,u),r.push(m.label_comp_id.value(d.offsets[h]))}}let a=r.length,s=new Uint8Array(a);super(e,s,a),this.unitMap=new Map;for(let l of e.units)this.unitMap.set(l.id,l);this.sequence=r,this.sequenceIndices=n,this.residueIndices=o,this.seqToUnit=i}};var Mx=class extends $m{residueLabel(e){return this.label}residueColor(e){return ut.black}residueClass(e){return"msp-sequence-present"}mark(e,r){let n=!1,{structure:o}=this.data;if(z.Loci.is(e)){if(!ue.areRootsEquivalent(e.structure,o))return!1;e=z.Loci.remap(e,o);for(let i of e.elements){let a=this.unitIndices.get(i.unit.id);a&&we.isSubset(a,i.indices)&&ka(this.markerArray,Oe.ofSingleton(0),r)&&(n=!0)}}else if(ue.isLoci(e)){if(!ue.areRootsEquivalent(e.structure,o))return!1;ka(this.markerArray,Oe.ofSingleton(0),r)&&(n=!0)}return n}getLoci(e){return this.loci}constructor(e){let r=0,n=0,o=[],i=z.Location.create(e.structure),a=new Map,s=[];for(let u=0,d=e.units.length;u<d;++u){let m=e.units[u];z.Location.set(i,e.structure,m,m.elements[0]);let p=m.model.sequence.byEntityKey[Ne.entity.key(i)];p&&(r+=p.sequence.length),n+=m.elements.length;let h=Oe.ofBounds(0,m.elements.length);a.set(m.id,h),s.push({unit:m,indices:h})}r>0&&o.push(`${r} residues`),o.push(`${n} elements`);let l=1,c=new Uint8Array(l);super(e,c,l),this.label=`Whole Chain (${o.join(", ")})`,this.unitIndices=a,this.loci=z.Loci(this.data.structure,s)}};var mA=class extends $m{residueLabel(e){return"X"}residueColor(e){return ut.black}residueClass(e){return"msp-sequence-present"}mark(e,r){let n=!1,{structure:o,units:i}=this.data;if(z.Loci.is(e)){if(!ue.areRootsEquivalent(e.structure,o))return!1;e=z.Loci.remap(e,o);for(let a of e.elements){let s=this.unitIndices.get(a.unit.id);s&&we.isSubset(s,a.indices)&&ka(this.markerArray,a.indices,r)&&(n=!0)}}else if(ue.isLoci(e)){if(!ue.areRootsEquivalent(e.structure,o))return!1;for(let a=0,s=i.length;a<s;++a){let l=this.unitIndices.get(i[a].id);ka(this.markerArray,l,r)&&(n=!0)}}return n}getLoci(e){let{units:r}=this.data,n=[],o=0;for(let i=0,a=r.length;i<a;++i){let s=r[i];if(e<o+s.elements.length){n.push({unit:s,indices:Oe.ofSingleton(e-o)});break}o+=s.elements.length}return z.Loci(this.data.structure,n)}constructor(e){let r=0,n=new Map,o=[];for(let a=0,s=e.units.length;a<s;++a){let l=e.units[a];r+=l.elements.length;let c=Oe.ofBounds(0,l.elements.length);n.set(l.id,c),o.push({unit:l,indices:c})}let i=new Uint8Array(r);super(e,i,r),this.unitIndices=n}};var sz=5e3,lz=1e3,IFe=30;function pce(t){let e=Ne.unit.pdbx_struct_oper_list_ids(t),r=Ne.unit.struct_ncs_oper_id(t),n=Ne.unit.hkl(t),o=Ne.unit.spgrOp(t);return`${e.sort().join(",")}|${r}|${n}|${o}`}function cz(t){let[e,r]=t.split("|");return[parseInt(e),r]}function cce(t,e){let{structure:r,modelEntityId:n,chainGroupId:o,operatorKey:i}=t,a=z.Location.create(r),[s,l]=cz(n),c=[];for(let u of r.units)z.Location.set(a,r,u,u.elements[0]),r.getModelIndex(u.model)===s&&Ne.entity.id(a)===l&&u.chainGroupId===o&&pce(a)===i&&c.push(u);if(c.length>0){let u={structure:r,units:c},d=c[0],m;if(d.polymerElements.length){let p=z.Location.create(r,d,d.elements[0]),h=d.model.sequence.byEntityKey[Ne.entity.key(p)];if(h&&h.sequence.length<=sz)m=new uA(u);else{let f=c.reduce((b,v)=>b+v.polymerElements.length,0);Pe.isAtomic(d)||f>sz?m=new Mx(u):m=new mA(u)}}else Pe.isAtomic(d)?c.reduce((h,f)=>h+f.residueCount,0)>sz?m=new Mx(u):m=new dA(u):(console.warn("should not happen, expecting coarse units to be polymeric"),m=new Mx(u));return m.markResidue(e.getLoci(r),tt.Select),m}else return"No sequence available"}function pA(t,e=!1){let r=[],n=z.Location.create(t),o=new Set;for(let i of t.units){z.Location.set(n,t,i,i.elements[0]);let a=Ne.entity.id(n),s=t.getModelIndex(i.model),l=`${s}|${a}`;if(o.has(l)||e&&Ne.entity.type(n)!=="polymer")continue;let c=Ne.entity.pdbx_description(n).join(", ");t.models.length&&(t.representativeModel?c+=` (Model ${t.models[s].modelNum})`:c.startsWith("Polymer ")&&(c+=` (${t.models[s].entry})`));let u=`${a}: ${c}`;if(r.push([l,u]),o.add(l),r.length>lz)return[["","Too many entities"]]}return r.length===0&&r.push(["","No entities"]),r}function yT(t,e){let r=[],n=z.Location.create(t),o=new Set,[i,a]=cz(e);for(let s of t.units){if(z.Location.set(n,t,s,s.elements[0]),t.getModelIndex(s.model)!==i||Ne.entity.id(n)!==a)continue;let l=s.chainGroupId;if(o.has(l))continue;let c=Sc(n,{granularity:"chain",hidePrefix:!0,htmlStyling:!1});if(r.push([l,c]),o.add(l),r.length>lz)return[[-1,"Too many chains"]]}return r.length===0&&r.push([-1,"No chains"]),r}function Rx(t,e,r){let n=[],o=z.Location.create(t),i=new Set,[a,s]=cz(e);for(let l of t.units){if(z.Location.set(o,t,l,l.elements[0]),t.getModelIndex(l.model)!==a||Ne.entity.id(o)!==s||l.chainGroupId!==r)continue;let c=pce(o);if(i.has(c))continue;let u=l.conformation.operator.name;if(n.push([c,u]),i.add(c),n.length>lz)return[["","Too many operators"]]}return n.length===0&&n.push(["","No operators"]),n}function uce(t){var e;let r=[],n=[],o=t.select(lt.Generators.rootsOfType(X.Molecule.Structure));for(let i of o)!((e=i.obj)===null||e===void 0)&&e.data&&(n.push(i.obj.data),r.push([i.transform.ref,i.obj.data.label]));return r.length===0&&r.push(["","No structure"]),{options:r,all:n}}var dce=g.Select("single",[["single","Chain"],["polymers","Polymers"],["all","Everything"]]),fA=class extends Mt{constructor(){super(...arguments),this.state={structureOptions:{options:[],all:[]},structure:ue.Empty,structureRef:"",modelEntityId:"",chainGroupId:-1,operatorKey:"",mode:"single"},this.setParamProps=e=>{let r=w({},this.state);switch(e.name){case"mode":if(r.mode=e.value,this.state.mode===r.mode)return;if(r.mode==="all"||r.mode==="polymers")break;case"structure":e.name==="structure"&&(r.structureRef=e.value),r.structure=this.getStructure(r.structureRef),r.modelEntityId=pA(r.structure)[0][0],r.chainGroupId=yT(r.structure,r.modelEntityId)[0][0],r.operatorKey=Rx(r.structure,r.modelEntityId,r.chainGroupId)[0][0];break;case"entity":r.modelEntityId=e.value,r.chainGroupId=yT(r.structure,r.modelEntityId)[0][0],r.operatorKey=Rx(r.structure,r.modelEntityId,r.chainGroupId)[0][0];break;case"chain":r.chainGroupId=e.value,r.operatorKey=Rx(r.structure,r.modelEntityId,r.chainGroupId)[0][0];break;case"operator":r.operatorKey=e.value;break}this.setState(r)}}componentDidMount(){this.plugin.state.data.select(lt.Generators.rootsOfType(X.Molecule.Structure)).length>0&&this.setState(this.getInitialState()),this.subscribe(this.plugin.state.events.object.updated,({ref:e,obj:r})=>{e===this.state.structureRef&&r&&r.type===X.Molecule.Structure.type&&r.data!==this.state.structure&&this.sync()}),this.subscribe(this.plugin.state.events.object.created,({obj:e})=>{e&&e.type===X.Molecule.Structure.type&&this.sync()}),this.subscribe(this.plugin.state.events.object.removed,({obj:e})=>{e&&e.type===X.Molecule.Structure.type&&e.data===this.state.structure&&this.sync()})}sync(){let e=uce(this.plugin.state.data);v0(e.all,this.state.structureOptions.all)||this.setState(this.getInitialState())}getStructure(e){let n=this.plugin.state.data.select(e)[0];return!e||!n||!n.obj?ue.Empty:n.obj.data}getSequenceWrapper(e){return{wrapper:cce(this.state,this.plugin.managers.structure.selection),label:`${g.optionLabel(e.chain,this.state.chainGroupId)} | ${g.optionLabel(e.entity,this.state.modelEntityId)}`}}getSequenceWrappers(e){if(this.state.mode==="single")return[this.getSequenceWrapper(e)];let r=this.getStructure(this.state.structureRef),n=[];for(let[o,i]of pA(r,this.state.mode==="polymers"))for(let[a,s]of yT(r,o))for(let[l]of Rx(r,o,a))if(n.push({wrapper:cce({structure:r,modelEntityId:o,chainGroupId:a,operatorKey:l},this.plugin.managers.structure.selection),label:`${s} | ${i}`}),n.length>IFe)return[];return n}getInitialState(){var e;let r=uce(this.plugin.state.data),n=r.options[0][0],o=this.getStructure(n),i=pA(o)[0][0],a=yT(o,i)[0][0],s=Rx(o,i,a)[0][0];return this.state.structure&&this.state.structure===o&&(i=this.state.modelEntityId,a=this.state.chainGroupId,s=this.state.operatorKey),{structureOptions:r,structure:o,structureRef:n,modelEntityId:i,chainGroupId:a,operatorKey:s,mode:(e=this.props.defaultMode)!==null&&e!==void 0?e:"single"}}get params(){let{structureOptions:e,structure:r,modelEntityId:n,chainGroupId:o}=this.state,i=pA(r),a=yT(r,n),s=Rx(r,n,o);return{structure:g.Select(e.options[0][0],e.options,{shortLabel:!0}),entity:g.Select(i[0][0],i,{shortLabel:!0}),chain:g.Select(a[0][0],a,{shortLabel:!0,twoColumns:!0,label:"Chain"}),operator:g.Select(s[0][0],s,{shortLabel:!0,twoColumns:!0}),mode:dce}}get values(){return{structure:this.state.structureRef,entity:this.state.modelEntityId,chain:this.state.chainGroupId,operator:this.state.operatorKey,mode:this.state.mode}}render(){if(this.getStructure(this.state.structureRef)===ue.Empty)return(0,Do.jsx)("div",{className:"msp-sequence",children:(0,Do.jsxs)("div",{className:"msp-sequence-select",children:[(0,Do.jsx)(pr,{svg:Bs,style:{cursor:"help",position:"absolute",right:0,top:0},title:"Shows a sequence of one or more chains. Use the controls to alter selection."}),(0,Do.jsx)("span",{children:"Sequence"}),(0,Do.jsx)("span",{style:{fontWeight:"normal"},children:"No structure available"})]})});let e=this.params,r=this.values,n=this.getSequenceWrappers(e);return(0,Do.jsxs)("div",{className:"msp-sequence",children:[(0,Do.jsxs)("div",{className:"msp-sequence-select",children:[(0,Do.jsx)(pr,{svg:Bs,style:{cursor:"help",position:"absolute",right:0,top:0},title:"This shows a single sequence. Use the controls to show a different sequence."}),(0,Do.jsx)("span",{children:"Sequence of"}),(0,Do.jsx)(Dm,{title:`[Structure] ${g.optionLabel(e.structure,r.structure)}`,param:e.structure,name:"structure",value:r.structure,onChange:this.setParamProps}),(0,Do.jsx)(Dm,{title:"[Mode]",param:dce,name:"mode",value:r.mode,onChange:this.setParamProps}),r.mode==="single"&&(0,Do.jsx)(Dm,{title:`[Entity] ${g.optionLabel(e.entity,r.entity)}`,param:e.entity,name:"entity",value:r.entity,onChange:this.setParamProps}),r.mode==="single"&&(0,Do.jsx)(Dm,{title:`[Chain] ${g.optionLabel(e.chain,r.chain)}`,param:e.chain,name:"chain",value:r.chain,onChange:this.setParamProps}),e.operator.options.length>1&&(0,Do.jsx)(Do.Fragment,{children:(0,Do.jsx)(Dm,{title:`[Instance] ${g.optionLabel(e.operator,r.operator)}`,param:e.operator,name:"operator",value:r.operator,onChange:this.setParamProps})})]}),(0,Do.jsx)(DFe,{children:n.map((o,i)=>{let a=typeof o.wrapper=="string"?(0,Do.jsx)("div",{className:"msp-sequence-wrapper",children:o.wrapper},i):(0,Do.jsx)(cA,{sequenceWrapper:o.wrapper},i);return r.mode==="single"?a:(0,Do.jsxs)(mce.Fragment,{children:[(0,Do.jsx)("div",{className:"msp-sequence-chain-label",children:o.label}),a]},i)})})]})}};function DFe({children:t}){return(0,Do.jsx)("div",{className:"msp-sequence-wrapper-non-empty",children:t})}var sa=Ot(Or());var Zm=Ot(Po());var yg=Ot(Po());function AFe(t){let[,e]=yg.default.useState({}),r=yg.default.useRef();return r.current=t?.value,yg.default.useEffect(()=>{if(!t)return;let n=t.subscribe(o=>{r.current!==o&&e({})});return()=>n.unsubscribe()},[t]),t?.value}function kFe(t){return yg.default.useSyncExternalStore(yg.default.useCallback(e=>{let r=t?.pipe(xT(1)).subscribe(e);return()=>r?.unsubscribe()},[t]),yg.default.useCallback(()=>t?.value,[t]))}var MFe=yg.default.useSyncExternalStore?kFe:AFe;function zc(t){return MFe(t)}function fce(){let t=(0,Zm.useContext)(Hl),[e,r]=(0,Zm.useState)(Ui());return(0,Zm.useEffect)(()=>{let n=t.events.task.progress.subscribe(i=>{var a;let s=!!(!((a=t.spec.components)===null||a===void 0)&&a.hideTaskOverlay);i.level==="background"&&(s||!i.useOverlay)&&r(l=>l.set(i.id,i))}),o=t.events.task.finished.subscribe(({id:i})=>{r(a=>a.delete(i))});return()=>{n.unsubscribe(),o.unsubscribe()}},[t]),(0,sa.jsxs)("div",{className:"msp-background-tasks",children:[e.valueSeq().map(n=>(0,sa.jsx)(hA,{event:n},n.id)),(0,sa.jsx)(RFe,{})]})}function RFe(){var t;let e=(0,Zm.useContext)(Hl),r=zc((t=e.canvas3d)===null||t===void 0?void 0:t.commitQueueSize);return r?(0,sa.jsx)("div",{className:"msp-task-state",children:(0,sa.jsx)("div",{children:(0,sa.jsxs)("div",{children:["Commiting renderables... ",r," remaining"]})})}):null}var hA=class extends Mt{constructor(){super(...arguments),this.abort=()=>{this.plugin.managers.task.requestAbort(this.props.event.progress.root.progress.taskId,"User Request")}}render(){let e=this.props.event.progress.root,r=hce(this.props.event.progress.root)-1,n=e.progress.isIndeterminate?void 0:(0,sa.jsxs)(sa.Fragment,{children:["[",e.progress.current,"/",e.progress.max,"]"]}),o=r>0?(0,sa.jsxs)(sa.Fragment,{children:["[",r," subtask(s)]"]}):void 0;return(0,sa.jsx)("div",{className:"msp-task-state",children:(0,sa.jsxs)("div",{children:[e.progress.canAbort&&(0,sa.jsx)(pt,{svg:sP,onClick:this.abort,title:"Abort"}),(0,sa.jsxs)("div",{children:[e.progress.message," ",n," ",o]})]})})}};function hce(t){if(t.children.length===0)return 1;let e=0;for(let r of t.children)e+=hce(r);return e}function gce(){let t=(0,Zm.useContext)(Hl),[e,r]=(0,Zm.useState)(Ui());return(0,Zm.useEffect)(()=>{let n=t.events.task.progress.subscribe(i=>{i.useOverlay&&r(a=>a.set(i.id,i))}),o=t.events.task.finished.subscribe(({id:i})=>{r(a=>a.delete(i))});return()=>{n.unsubscribe(),o.unsubscribe()}},[t]),e.size===0?null:(0,sa.jsx)("div",{className:"msp-overlay-tasks",children:e.valueSeq().map(n=>(0,sa.jsx)(hA,{event:n},n.id))})}var Uc=Ot(Or());var uz=class extends Mt{constructor(){super(...arguments),this.hide=()=>{(this.props.entry.hide||function(){}).call(null)}}render(){let e=this.props.entry,r=typeof e.message=="string"?(0,Uc.jsx)("div",{dangerouslySetInnerHTML:{__html:e.message}}):(0,Uc.jsx)("div",{children:(0,Uc.jsx)(e.message,{})});return(0,Uc.jsxs)("div",{className:"msp-toast-entry",children:[(0,Uc.jsx)("div",{className:"msp-toast-title",onClick:()=>this.hide(),children:e.title}),(0,Uc.jsx)("div",{className:"msp-toast-message",children:r}),(0,Uc.jsx)("div",{className:"msp-toast-clear"}),(0,Uc.jsx)("div",{className:"msp-toast-hide",children:(0,Uc.jsx)(pt,{svg:sP,onClick:this.hide,title:"Hide",className:"msp-no-hover-outline"})})]})}},gA=class extends Mt{componentDidMount(){this.subscribe(this.plugin.managers.toast.events.changed,()=>this.forceUpdate())}render(){let e=this.plugin.managers.toast.state;if(!e.entries.count())return null;let r=[];return e.entries.forEach((n,o)=>r.push(n)),r.sort(function(n,o){return n.serialNumber-o.serialNumber}),(0,Uc.jsx)("div",{className:"msp-toast-container",children:r.map(n=>(0,Uc.jsx)(uz,{entry:n},n.serialNumber))})}};var Ln=Ot(Or());var rd=Ot(Or()),yce=Ot(Po());var yA=class extends Mt{constructor(){super(...arguments),this.container=yce.createRef(),this.state={noWebGl:!1,showLogo:!0},this.handleLogo=()=>{var e;this.setState({showLogo:!(!((e=this.plugin.canvas3d)===null||e===void 0)&&e.reprCount.value)})}}componentDidMount(){if(!this.container.current||!this.plugin.mount(this.container.current,{checkeredCanvasBackground:!0})){this.setState({noWebGl:!0});return}this.handleLogo(),this.subscribe(this.plugin.canvas3d.reprCount,this.handleLogo)}componentWillUnmount(){super.componentWillUnmount(),this.plugin.unmount()}renderMissing(){if(this.props.noWebGl){let e=this.props.noWebGl;return(0,rd.jsx)(e,{})}return(0,rd.jsx)("div",{className:"msp-no-webgl",children:(0,rd.jsxs)("div",{children:[(0,rd.jsx)("p",{children:(0,rd.jsx)("b",{children:"WebGL does not seem to be available."})}),(0,rd.jsx)("p",{children:"This can be caused by an outdated browser, graphics card driver issue, or bad weather. Sometimes, just restarting the browser helps. Also, make sure hardware acceleration is enabled in your browser."}),(0,rd.jsxs)("p",{children:["For a list of supported browsers, refer to ",(0,rd.jsx)("a",{href:"http://caniuse.com/#feat=webgl",target:"_blank",children:"http://caniuse.com/#feat=webgl"}),"."]})]})})}render(){if(this.state.noWebGl)return this.renderMissing();let e=this.props.logo;return(0,rd.jsx)("div",{className:this.props.parentClassName||"msp-viewport",style:this.props.parentStyle,ref:this.container,children:this.state.showLogo&&e&&(0,rd.jsx)(e,{})})}};var si=Ot(Or());var la=Ot(Or()),vA=Ot(Po()),nc=Ot(Po());var LFe=t=>{let{plugin:e,cropFrameColor:r}=t,n=e.helpers.viewportScreenshot,[o,i]=(0,nc.useState)(null),a=(0,nc.useRef)(null),s=(0,nc.useRef)(t);return(0,nc.useEffect)(()=>{s.current=t},Object.values(t)),(0,nc.useEffect)(()=>{o!==a.current&&i(a.current)}),(0,nc.useEffect)(()=>{var l;let c=!1,u=[];function d(b,v){b&&u.push(b.subscribe(v))}function m(){let b=s.current;!b.suspend&&a.current&&vce(n,a.current,b.customBackground,b.borderColor,b.borderWidth),a.current||(c=!0)}let p=setInterval(()=>{c&&(c=!1,m())},1e3/8);d(e.events.canvas3d.settingsUpdated,()=>c=!0),d((l=e.canvas3d)===null||l===void 0?void 0:l.didDraw,()=>c=!0),d(e.state.data.behaviors.isUpdating,b=>{b||(c=!0)}),d(n?.behaviors.values,()=>c=!0),d(n?.behaviors.cropParams,()=>c=!0);let h;typeof ResizeObserver<"u"&&(h=new ResizeObserver(()=>c=!0));let f=a.current;return h?.observe(f),m(),()=>{clearInterval(p),u.forEach(b=>b.unsubscribe()),h?.unobserve(f)}},[n]),(0,nc.useLayoutEffect)(()=>{a.current&&vce(n,a.current,t.customBackground,t.borderColor,t.borderWidth)},[...Object.values(t)]),(0,la.jsx)(la.Fragment,{children:(0,la.jsxs)("div",{style:{position:"relative",width:"100%",height:"100%"},children:[(0,la.jsx)("canvas",{ref:a,onContextMenu:l=>{l.preventDefault(),l.stopPropagation()},style:{display:"block",width:"100%",height:"100%"}}),(0,la.jsx)(BFe,{plugin:e,canvas:o,color:r})]})})},xce=vA.memo(LFe,(t,e)=>lf(t,e));function vce(t,e,r,n,o){if(!t)return;let{canvas:i,width:a,height:s}=t.getPreview(),l=e.getContext("2d");if(!l)return;let c=e.clientWidth,u=e.clientHeight;e.width=c,e.height=u,l.clearRect(0,0,c,u);let d=Sce(a,s,c,u);if(r)l.fillStyle=r,l.fillRect(d.x,d.y,d.width,d.height);else if(t.values.transparent)for(let p=0;p<d.width;p+=13)for(let h=0;h<d.height;h+=13){l.fillStyle=(p+h)%2?"#ffffff":"#bfbfbf";let f=d.x+p,b=d.y+h,v=p+13>d.width?d.width-p:13,x=h+13>d.height?d.height-h:13;l.fillRect(f,b,v,x)}if(l.drawImage(i,d.x,d.y,d.width,d.height),n&&o){let m=o;l.rect(d.x,d.y,d.width,d.height),l.rect(d.x+m,d.y+m,d.width-2*m,d.height-2*m),l.fillStyle=n,l.fill("evenodd")}}function BFe({plugin:t,canvas:e,color:r="rgba(255, 87, 45, 0.75)"}){var n;let o=t.helpers.viewportScreenshot,i=zc(o?.behaviors.values),a=zc(o?.behaviors.cropParams),s=zc(o?.behaviors.relativeCrop),l=(0,nc.useRef)({x:0,y:0,width:0,height:0});zc(i?.resolution.name==="viewport"?(n=t.canvas3d)===null||n===void 0?void 0:n.resized:void 0);let[c,u]=vA.useState(""),[d,m]=(0,nc.useState)([0,0]),[p,h]=(0,nc.useState)([0,0]);if(!o||!e||!s)return null;let{width:f,height:b}=o.getSizeAndViewport(),v=Sce(f,b,e.clientWidth,e.clientHeight),x={x:v.x+Math.floor(v.width*s.x),y:v.y+Math.floor(v.height*s.y),width:Math.ceil(v.width*s.width),height:Math.ceil(v.height*s.height)},S=bce(x),T=bce(v);if(c==="move"?(S.l+=p[0]-d[0],S.r+=p[0]-d[0],S.t+=p[1]-d[1],S.b+=p[1]-d[1]):c&&(c.indexOf("left")>=0?S.l+=p[0]-d[0]:c.indexOf("right")>=0&&(S.r+=p[0]-d[0]),c.indexOf("top")>=0?S.t+=p[1]-d[1]:c.indexOf("bottom")>=0&&(S.b+=p[1]-d[1])),S.l>S.r){let V=S.l;S.l=S.r,S.r=V}if(S.t>S.b){let V=S.t;S.t=S.b,S.b=V}let E=40;S.l=Math.min(T.r-E,Math.max(T.l,S.l)),S.r=Math.max(T.l+E,Math.min(T.r,S.r)),S.t=Math.min(T.b-E,Math.max(T.t,S.t)),S.b=Math.max(T.t+E,Math.min(T.b,S.b)),x.x=S.l,x.y=S.t,x.width=S.r-S.l+1,x.height=S.b-S.t+1,l.current=x;let _=V=>{V.preventDefault(),h([V.pageX,V.pageY])},D=V=>{V.preventDefault();let H=V.touches[0];h([H.pageX,H.pageY])},P=V=>{V.preventDefault(),u(V.currentTarget.getAttribute("data-drag"));let H=V.touches[0],Q=[H.pageX,H.pageY];m(Q),h(Q),window.addEventListener("touchend",k),window.addEventListener("touchmove",D)},A=V=>{V.preventDefault(),u(V.currentTarget.getAttribute("data-drag"));let H=[V.pageX,V.pageY];m(H),h(H),window.addEventListener("mouseup",I),window.addEventListener("mousemove",_)},I=()=>{window.removeEventListener("mouseup",I),window.removeEventListener("mousemove",_),M()},k=()=>{window.removeEventListener("touchend",k),window.removeEventListener("touchmove",D),M()};function M(){let V=l.current;a?.auto&&o?.behaviors.cropParams.next(U(w({},a),{auto:!1})),o?.behaviors.relativeCrop.next({x:(V.x-v.x)/v.width,y:(V.y-v.y)/v.height,width:V.width/v.width,height:V.height/v.height}),u("");let H=[0,0];m(H),h(H)}let R=V=>{V.preventDefault(),V.stopPropagation()},B=4,F=`3px solid ${r}`,G="transparent";return(0,la.jsxs)(la.Fragment,{children:[(0,la.jsx)("div",{"data-drag":"move",style:{position:"absolute",left:x.x,top:x.y,width:x.width,height:x.height,border:F,cursor:"move"},onMouseDown:A,onTouchStart:P,draggable:!1,onContextMenu:R}),(0,la.jsx)("div",{"data-drag":"left",style:{position:"absolute",left:x.x-B,top:x.y+B,width:4*B,height:x.height-B,background:G,cursor:"w-resize"},onMouseDown:A,onTouchStart:P,draggable:!1,onContextMenu:R}),(0,la.jsx)("div",{"data-drag":"right",style:{position:"absolute",left:S.r-2*B,top:x.y,width:4*B,height:x.height-B,background:G,cursor:"w-resize"},onMouseDown:A,onTouchStart:P,draggable:!1,onContextMenu:R}),(0,la.jsx)("div",{"data-drag":"top",style:{position:"absolute",left:x.x-B,top:x.y-B,width:x.width+2*B,height:4*B,background:G,cursor:"n-resize"},onMouseDown:A,onTouchStart:P,draggable:!1,onContextMenu:R}),(0,la.jsx)("div",{"data-drag":"bottom",style:{position:"absolute",left:x.x-B,top:S.b-2*B,width:x.width+2*B,height:4*B,background:G,cursor:"n-resize"},onMouseDown:A,onTouchStart:P,draggable:!1,onContextMenu:R}),(0,la.jsx)("div",{"data-drag":"top, left",style:{position:"absolute",left:S.l-B,top:S.t-B,width:4*B,height:4*B,background:G,cursor:"nw-resize"},onMouseDown:A,onTouchStart:P,draggable:!1,onContextMenu:R}),(0,la.jsx)("div",{"data-drag":"bottom, right",style:{position:"absolute",left:S.r-2*B,top:S.b-2*B,width:4*B,height:4*B,background:G,cursor:"nw-resize"},onMouseDown:A,onTouchStart:P,draggable:!1,onContextMenu:R}),(0,la.jsx)("div",{"data-drag":"top, right",style:{position:"absolute",left:S.r-2*B,top:S.t-B,width:4*B,height:4*B,background:G,cursor:"ne-resize"},onMouseDown:A,onTouchStart:P,draggable:!1,onContextMenu:R}),(0,la.jsx)("div",{"data-drag":"bottom, left",style:{position:"absolute",left:S.l-B,top:S.b-2*B,width:4*B,height:4*B,background:G,cursor:"ne-resize"},onMouseDown:A,onTouchStart:P,draggable:!1,onContextMenu:R})]})}function bce(t){return{l:t.x,t:t.y,r:t.x+t.width-1,b:t.y+t.height-1}}function Sce(t,e,r,n){let o=t/e,i=r/n;if(o<=i){let a=n*o;return{x:Math.round((r-a)/2),y:0,width:Math.round(a),height:n}}else{let a=r/o;return{x:0,y:Math.round((n-a)/2),width:r,height:Math.round(a)}}}var bA=class extends Mt{constructor(){super(...arguments),this.state={showPreview:!0,isDisabled:!1},this.download=()=>{var e;(e=this.plugin.helpers.viewportScreenshot)===null||e===void 0||e.download(),this.props.close()},this.copy=()=>N(this,null,function*(){var e;try{yield(e=this.plugin.helpers.viewportScreenshot)===null||e===void 0?void 0:e.copyToClipboard(),Re.Toast.Show(this.plugin,{message:"Copied to clipboard.",title:"Screenshot",timeoutMs:1500})}catch{return this.copyImg()}}),this.copyImg=()=>N(this,null,function*(){var e;let r=yield(e=this.plugin.helpers.viewportScreenshot)===null||e===void 0?void 0:e.getImageDataUri();this.setState({imageData:r})}),this.open=e=>{!e.target.files||!e.target.files[0]||Re.State.Snapshots.OpenFile(this.plugin,{file:e.target.files[0]})}}componentDidMount(){this.subscribe(this.plugin.state.data.behaviors.isUpdating,e=>{this.setState({isDisabled:e})})}componentWillUnmount(){super.componentWillUnmount(),this.setState({imageData:void 0})}render(){var e;let r=!!(!((e=navigator.clipboard)===null||e===void 0)&&e.write);return(0,si.jsxs)("div",{children:[this.state.showPreview&&(0,si.jsxs)("div",{className:"msp-image-preview",children:[(0,si.jsx)(xce,{plugin:this.plugin}),(0,si.jsx)(FFe,{plugin:this.plugin})]}),(0,si.jsxs)("div",{className:"msp-flex-row",children:[!this.state.imageData&&(0,si.jsx)(vt,{icon:AJ,onClick:r?this.copy:this.copyImg,disabled:this.state.isDisabled,children:"Copy"}),this.state.imageData&&(0,si.jsx)(vt,{onClick:()=>this.setState({imageData:void 0}),disabled:this.state.isDisabled,children:"Clear"}),(0,si.jsx)(vt,{icon:SS,onClick:this.download,disabled:this.state.isDisabled,children:"Download"})]}),this.state.imageData&&(0,si.jsxs)("div",{className:"msp-row msp-copy-image-wrapper",children:[(0,si.jsx)("div",{children:"Right click below + Copy Image"}),(0,si.jsx)("img",{src:this.state.imageData,style:{width:"100%",height:32,display:"block"}})]}),(0,si.jsx)(OFe,{plugin:this.plugin,isDisabled:this.state.isDisabled}),(0,si.jsxs)(Ci,{header:"State",children:[(0,si.jsx)(pT,{onAction:this.props.close}),(0,si.jsx)(Ci,{header:"Save Options",initiallyExpanded:!1,noOffset:!0,children:(0,si.jsx)(fT,{})})]})]})}};function OFe({plugin:t,isDisabled:e}){let r=t.helpers.viewportScreenshot,n=zc(r?.behaviors.values);return r?(0,si.jsx)(Hr,{params:r.params,values:n,onChangeValues:o=>r.behaviors.values.next(o),isDisabled:e}):null}function FFe({plugin:t}){let e=t.helpers.viewportScreenshot,r=zc(e?.behaviors.cropParams);return zc(e?.behaviors.relativeCrop),!e||!r?null:(0,si.jsxs)("div",{style:{width:"100%",height:"24px",marginTop:"8px"},children:[(0,si.jsx)(Gn,{icon:RJ,title:"Auto-crop",inline:!0,isSelected:r.auto,style:{background:"transparent",float:"left",width:"auto",height:"24px",lineHeight:"24px"},toggle:()=>e.toggleAutocrop(),label:"Auto-crop "+(r.auto?"On":"Off")}),!r.auto&&(0,si.jsx)(vt,{icon:kJ,title:"Crop",style:{background:"transparent",float:"right",height:"24px",lineHeight:"24px",width:"24px",padding:"0"},onClick:()=>e.autocrop()}),!r.auto&&!e.isFullFrame&&(0,si.jsx)(vt,{icon:MJ,title:"Reset Crop",style:{background:"transparent",float:"right",height:"24px",lineHeight:"24px",width:"24px",padding:"0"},onClick:()=>e.resetCrop()})]})}var n0=Ot(Or());function Cce(t){return({values:e,update:r,apply:n})=>({params:typeof t.params=="function"?t.params:o=>t.params,getTarget:t.target,getValues:e,update(o,i){let a=t.target(i);return ss(a,s=>r(o,s,i))},apply:n||(()=>{})})}var xA=class extends Mt{componentDidMount(){this.plugin.canvas3d&&(this.subscribe(this.plugin.events.canvas3d.settingsUpdated,()=>this.forceUpdate()),this.subscribe(this.plugin.canvas3d.camera.stateChanged.pipe(qc(500,void 0,{leading:!0,trailing:!0})),e=>{(e.radiusMax!==void 0||e.radius!==void 0)&&this.forceUpdate()}))}render(){return this.plugin.canvas3d?(0,n0.jsxs)(n0.Fragment,{children:[(0,n0.jsx)(yP,{mapping:VFe}),(0,n0.jsx)(e0,{})]}):null}},vT={sequence:"Sequence",log:"Log",left:"Left Panel",right:"Right Panel"},NFe={animate:Fa.trackball.params.animate,camera:Fa.camera,background:g.Group({color:g.Color(ce(16579577),{label:"Background",description:"Custom background color"}),transparent:g.Boolean(!1),style:Fa.postprocessing.params.background},{pivot:"color"}),lighting:g.Group({occlusion:Fa.postprocessing.params.occlusion,shadow:Fa.postprocessing.params.shadow,outline:Fa.postprocessing.params.outline,dof:Fa.postprocessing.params.dof,fog:Fa.cameraFog},{isFlat:!0}),clipping:g.Group(w({},Fa.cameraClipping.params),{pivot:"radius"}),layout:g.MultiSelect([],g.objectToOptions(vT)),advanced:g.Group({multiSample:Fa.multiSample,hiZ:Fa.hiZ,sharpening:Fa.postprocessing.params.sharpening,pixelScale:Ad.Params.pixelScale,transparency:Ad.Params.transparency})},VFe=Cce({params:t=>{var e;let r=g.clone(NFe),n=(e=t.spec.components)===null||e===void 0?void 0:e.controls;if(n){let i=[];n.top!=="none"&&i.push(["sequence",vT.sequence]),n.bottom!=="none"&&i.push(["log",vT.log]),n.left!=="none"&&i.push(["left",vT.left]),n.right!=="none"&&i.push(["right",vT.right]),r.layout.options=i}let o=t.config.get(Wt.Background.Styles)||[];return o.length>0&&Object.assign(r.background.params.style,{presets:$s(o),isFlat:!1}),r},target(t){var e,r,n;let o=(e=t.spec.components)===null||e===void 0?void 0:e.controls,i=t.layout.state.regionState,a=[];i.top!=="hidden"&&(!o||o.top!=="none")&&a.push("sequence"),i.bottom!=="hidden"&&(!o||o.bottom!=="none")&&a.push("log"),i.left!=="hidden"&&(!o||o.left!=="none")&&a.push("left"),i.right!=="hidden"&&(!o||o.right!=="none")&&a.push("right");let{pixelScale:s,transparency:l}=(r=t.canvas3dContext)===null||r===void 0?void 0:r.props;return{canvas:(n=t.canvas3d)===null||n===void 0?void 0:n.props,layout:a,pixelScale:s,transparency:l}}})({values(t,e){let{canvas:r}=t,n=r.renderer;return{layout:t.layout,animate:r.trackball.animate,camera:r.camera,background:{color:n.backgroundColor,transparent:r.transparentBackground,style:r.postprocessing.background},lighting:{occlusion:r.postprocessing.occlusion,shadow:r.postprocessing.shadow,outline:r.postprocessing.outline,dof:r.postprocessing.dof,fog:r.cameraFog},clipping:w({},r.cameraClipping),advanced:{multiSample:r.multiSample,hiZ:r.hiZ,sharpening:r.postprocessing.sharpening,pixelScale:t.pixelScale,transparency:t.transparency}}},update(t,e){let r=e.canvas;r.trackball.animate=t.animate,r.camera=t.camera,r.transparentBackground=t.background.transparent,r.renderer.backgroundColor=t.background.color,r.postprocessing.occlusion=t.lighting.occlusion,r.postprocessing.shadow=t.lighting.shadow,r.postprocessing.outline=t.lighting.outline,r.postprocessing.background=t.background.style,r.cameraFog=t.lighting.fog,r.cameraClipping={radius:t.clipping.radius,far:t.clipping.far,minNear:t.clipping.minNear},r.multiSample=t.advanced.multiSample,r.hiZ=t.advanced.hiZ,r.postprocessing.sharpening=t.advanced.sharpening,r.postprocessing.dof=t.lighting.dof,e.layout=t.layout,e.pixelScale=t.advanced.pixelScale,e.transparency=t.advanced.transparency},apply(t,e){return N(this,null,function*(){var r;yield Re.Canvas3D.SetSettings(e,{settings:t.canvas});let n=t.layout.indexOf("left")<0,o=ss(e.layout.state,i=>{i.regionState.top=t.layout.indexOf("sequence")>=0?"full":"hidden",i.regionState.bottom=t.layout.indexOf("log")>=0?"full":"hidden",i.regionState.left=n?"hidden":e.behaviors.layout.leftPanelTabName.value==="none"?"collapsed":"full",i.regionState.right=t.layout.indexOf("right")>=0?"full":"hidden"});yield Re.Layout.Update(e,{state:o}),n&&Re.State.SetCurrentObject(e,{state:e.state.data,ref:kt.RootRef}),(r=e.canvas3dContext)===null||r===void 0||r.setProps({pixelScale:t.pixelScale,transparency:t.transparency})})}});var SA=class extends Mt{constructor(){super(...arguments),this.allCollapsedState={isSettingsExpanded:!1,isScreenshotExpanded:!1},this.state=U(w({},this.allCollapsedState),{isCameraResetEnabled:!0}),this.resetCamera=()=>{Re.Camera.Reset(this.plugin,{})},this.toggleSettingsExpanded=this.toggle("isSettingsExpanded"),this.toggleScreenshotExpanded=this.toggle("isScreenshotExpanded"),this.toggleControls=()=>{Re.Layout.Update(this.plugin,{state:{showControls:!this.plugin.layout.state.showControls}})},this.toggleExpanded=()=>{Re.Layout.Update(this.plugin,{state:{isExpanded:!this.plugin.layout.state.isExpanded}})},this.setSettings=e=>{Re.Canvas3D.SetSettings(this.plugin,{settings:{[e.name]:e.value}})},this.setLayout=e=>{Re.Layout.Update(this.plugin,{state:{[e.name]:e.value}})},this.screenshot=()=>{var e;(e=this.plugin.helpers.viewportScreenshot)===null||e===void 0||e.download()},this.enableCameraReset=e=>{this.setState(r=>U(w({},r),{isCameraResetEnabled:e}))}}toggle(e){return r=>{this.setState(n=>U(w(w({},n),this.allCollapsedState),{[e]:!this.state[e]})),r?.currentTarget.blur()}}componentDidMount(){this.subscribe(this.plugin.events.canvas3d.settingsUpdated,()=>this.forceUpdate()),this.subscribe(this.plugin.layout.events.updated,()=>this.forceUpdate()),this.plugin.canvas3d&&this.subscribe(this.plugin.canvas3d.camera.stateChanged.pipe(qc(500,void 0,{leading:!0,trailing:!0})),e=>this.enableCameraReset(e.radius!==0&&e.radiusMax!==0))}icon(e,r,n,o=!0){return(0,Ln.jsx)(pt,{svg:e,toggleState:o,onClick:r,title:n,style:{background:"transparent"}})}render(){return(0,Ln.jsxs)("div",{className:"msp-viewport-controls",children:[(0,Ln.jsxs)("div",{className:"msp-viewport-controls-buttons",children:[(0,Ln.jsxs)("div",{className:"msp-hover-box-wrapper",children:[(0,Ln.jsx)("div",{className:"msp-semi-transparent-background"}),this.icon(CJ,this.resetCamera,"Reset Zoom"),(0,Ln.jsx)("div",{className:"msp-hover-box-body",children:(0,Ln.jsxs)("div",{className:"msp-flex-column",children:[(0,Ln.jsx)("div",{className:"msp-flex-row",children:(0,Ln.jsx)(vt,{onClick:()=>this.resetCamera(),disabled:!this.state.isCameraResetEnabled,title:"Set camera zoom to fit the visible scene into view",children:"Reset Zoom"})}),(0,Ln.jsx)("div",{className:"msp-flex-row",children:(0,Ln.jsx)(vt,{onClick:()=>Re.Camera.OrientAxes(this.plugin),disabled:!this.state.isCameraResetEnabled,title:"Align principal component axes of the loaded structures to the screen axes (\u201Clay flat\u201D)",children:"Orient Axes"})}),(0,Ln.jsx)("div",{className:"msp-flex-row",children:(0,Ln.jsx)(vt,{onClick:()=>Re.Camera.ResetAxes(this.plugin),disabled:!this.state.isCameraResetEnabled,title:"Align Cartesian axes to the screen axes",children:"Reset Axes"})})]})}),(0,Ln.jsx)("div",{className:"msp-hover-box-spacer"})]}),(0,Ln.jsxs)("div",{children:[(0,Ln.jsx)("div",{className:"msp-semi-transparent-background"}),this.icon(_J,this.toggleScreenshotExpanded,"Screenshot / State Snapshot",this.state.isScreenshotExpanded)]}),(0,Ln.jsxs)("div",{children:[(0,Ln.jsx)("div",{className:"msp-semi-transparent-background"}),this.plugin.config.get(Wt.Viewport.ShowControls)&&this.icon(TJ,this.toggleControls,"Toggle Controls Panel",this.plugin.layout.state.showControls),this.plugin.config.get(Wt.Viewport.ShowExpand)&&this.icon(LJ,this.toggleExpanded,"Toggle Expanded Viewport",this.plugin.layout.state.isExpanded),this.plugin.config.get(Wt.Viewport.ShowSettings)&&this.icon(pl,this.toggleSettingsExpanded,"Settings / Controls Info",this.state.isSettingsExpanded)]}),this.plugin.config.get(Wt.Viewport.ShowSelectionMode)&&(0,Ln.jsxs)("div",{children:[(0,Ln.jsx)("div",{className:"msp-semi-transparent-background"}),(0,Ln.jsx)(hg,{})]})]}),this.state.isScreenshotExpanded&&(0,Ln.jsx)("div",{className:"msp-viewport-controls-panel",children:(0,Ln.jsx)(Ua,{header:"Screenshot / State",title:"Click to close.",initialExpanded:!0,hideExpander:!0,hideOffset:!0,onHeaderClick:this.toggleScreenshotExpanded,topRightIcon:ml,noTopMargin:!0,childrenClassName:"msp-viewport-controls-panel-controls",children:(0,Ln.jsx)(bA,{close:this.toggleScreenshotExpanded})})}),this.state.isSettingsExpanded&&(0,Ln.jsx)("div",{className:"msp-viewport-controls-panel",children:(0,Ln.jsx)(Ua,{header:"Settings / Controls Info",title:"Click to close.",initialExpanded:!0,hideExpander:!0,hideOffset:!0,onHeaderClick:this.toggleSettingsExpanded,topRightIcon:ml,noTopMargin:!0,childrenClassName:"msp-viewport-controls-panel-controls",children:(0,Ln.jsx)(xA,{})})})]})}},zFe=()=>(0,Ln.jsx)("a",{className:"msp-logo",href:"https://molstar.org",target:"_blank"}),Tce=()=>(0,Ln.jsx)(yA,{logo:zFe});function wce({plugin:t}){return t.isInitialized?(0,Fr.jsx)(Hl.Provider,{value:t,children:(0,Fr.jsx)(CA,{})}):(0,Fr.jsx)(UFe,{plugin:t})}function UFe({plugin:t}){let[e,r]=o0.useState({kind:"pending"});return o0.useEffect(()=>{r({kind:"pending"});let n=!0;return t.initialized.then(()=>{n&&r({kind:"initialized"})}).catch(o=>{n&&r({kind:"error",message:`${o}`})}),()=>{n=!1}},[t]),e.kind==="pending"?null:e.kind==="error"?(0,Fr.jsx)("div",{className:"msp-plugin",children:(0,Fr.jsxs)("div",{className:"msp-plugin-init-error",children:["Initialization error: ",e.message]})}):(0,Fr.jsx)(Hl.Provider,{value:t,children:(0,Fr.jsx)(CA,{})})}var CA=class extends Mt{constructor(){super(...arguments),this.onDrop=e=>{e.preventDefault();let r=[];if(e.dataTransfer.items)for(let o=0;o<e.dataTransfer.items.length;o++){if(e.dataTransfer.items[o].kind!=="file")continue;let i=e.dataTransfer.items[o].getAsFile();i&&r.push(i)}else for(let o=0;o<e.dataTransfer.files.length;o++){let i=e.dataTransfer.files[o];i&&r.push(i)}let n=r.filter(o=>{let i=o.name.toLowerCase();return i.endsWith(".molx")||i.endsWith(".molj")});n.length>0?Re.State.Snapshots.OpenFile(this.plugin,{file:n[0]}):this.plugin.runTask(this.plugin.state.data.applyAction(fS,{files:r.map(o=>Wr.File(o)),format:{name:"auto",params:{}},visuals:!0}))},this.onDragOver=e=>{e.preventDefault()},this.showDragOverlay=new da(!1),this.onDragEnter=e=>{let r=!1;if(e.dataTransfer.items&&e.dataTransfer.items.length>0){for(let n=0;n<e.dataTransfer.items.length;n++)if(e.dataTransfer.items[n].kind==="file"){r=!0;break}}else for(let n=0;n<e.dataTransfer.types.length;n++)if(e.dataTransfer.types[n]==="Files"){r=!0;break}r&&this.showDragOverlay.next(!0)}}componentDidMount(){this.subscribe(this.plugin.layout.events.updated,()=>this.forceUpdate())}region(e,r){return(0,Fr.jsx)("div",{className:`msp-layout-region msp-layout-${e}`,children:(0,Fr.jsx)("div",{className:"msp-layout-static",children:r?(0,Fr.jsx)(r,{}):null})})}get layoutVisibilityClassName(){var e,r;let n=this.plugin.layout.state,o=(r=(e=this.plugin.spec.components)===null||e===void 0?void 0:e.controls)!==null&&r!==void 0?r:{},i=[];return(o.top==="none"||!n.showControls||n.regionState.top==="hidden")&&i.push("msp-layout-hide-top"),o.left==="none"||!n.showControls||n.regionState.left==="hidden"?i.push("msp-layout-hide-left"):n.regionState.left==="collapsed"&&i.push("msp-layout-collapse-left"),(o.right==="none"||!n.showControls||n.regionState.right==="hidden")&&i.push("msp-layout-hide-right"),(o.bottom==="none"||!n.showControls||n.regionState.bottom==="hidden")&&i.push("msp-layout-hide-bottom"),i.join(" ")}get layoutClassName(){let e=this.plugin.layout.state,r=["msp-plugin-content"];return e.isExpanded?r.push("msp-layout-expanded"):r.push("msp-layout-standard",`msp-layout-standard-${e.controlsDisplay}`),r.join(" ")}render(){var e,r,n,o,i,a,s;let l=this.plugin.layout.state,c=((e=this.plugin.spec.components)===null||e===void 0?void 0:e.controls)||{},u=((n=(r=this.plugin.spec.components)===null||r===void 0?void 0:r.viewport)===null||n===void 0?void 0:n.view)||mz,d=((i=(o=this.plugin.spec.components)===null||o===void 0?void 0:o.sequenceViewer)===null||i===void 0?void 0:i.view)||fA;return(0,Fr.jsx)("div",{className:"msp-plugin",children:(0,Fr.jsxs)("div",{className:this.layoutClassName,onDragEnter:this.onDragEnter,children:[(0,Fr.jsxs)("div",{className:this.layoutVisibilityClassName,children:[this.region("main",u),l.showControls&&c.top!=="none"&&this.region("top",c.top||d),l.showControls&&c.left!=="none"&&this.region("left",c.left||sA),l.showControls&&c.right!=="none"&&this.region("right",c.right||dz),l.showControls&&c.bottom!=="none"&&this.region("bottom",c.bottom||pz)]}),!(!((a=this.plugin.spec.components)===null||a===void 0)&&a.hideTaskOverlay)&&(0,Fr.jsx)(gce,{}),!(!((s=this.plugin.spec.components)===null||s===void 0)&&s.disableDragOverlay)&&(0,Fr.jsx)(jFe,{plugin:this.plugin,showDragOverlay:this.showDragOverlay})]})})}};function GFe(t,e,r){t.preventDefault(),t.stopPropagation(),r.next(!1);let n=[];if(t.dataTransfer.items)for(let o=0;o<t.dataTransfer.items.length;o++){if(t.dataTransfer.items[o].kind!=="file")continue;let i=t.dataTransfer.items[o].getAsFile();i&&n.push(i)}else for(let o=0;o<t.dataTransfer.files.length;o++){let i=t.dataTransfer.files[o];i&&n.push(i)}e.managers.dragAndDrop.handle(n)}function jFe({plugin:t,showDragOverlay:e}){let r=zc(e),n=o=>{o.dataTransfer.dropEffect="copy",o.preventDefault(),o.stopPropagation()};return(0,Fr.jsx)("div",{className:"msp-drag-drop-overlay",style:{display:r?"flex":"none"},onDragEnter:n,onDragOver:n,onDragLeave:()=>e.next(!1),onDrop:o=>GFe(o,t,e),children:"Load File(s)"})}var dz=class extends Mt{render(){var e;let r=((e=this.plugin.spec.components)===null||e===void 0?void 0:e.structureTools)||nA;return(0,Fr.jsx)("div",{className:"msp-scrollable-container",children:(0,Fr.jsx)(r,{})})}},mz=class extends Mt{render(){var e,r;let n=((r=(e=this.plugin.spec.components)===null||e===void 0?void 0:e.viewport)===null||r===void 0?void 0:r.controls)||SA;return(0,Fr.jsxs)(Fr.Fragment,{children:[(0,Fr.jsx)(Tce,{}),(0,Fr.jsxs)("div",{className:"msp-viewport-top-left-controls",children:[(0,Fr.jsx)(eA,{}),(0,Fr.jsx)(ZD,{}),(0,Fr.jsx)(JD,{}),(0,Fr.jsx)(oce,{})]}),(0,Fr.jsx)(tA,{}),(0,Fr.jsx)(n,{}),(0,Fr.jsx)(fce,{}),(0,Fr.jsxs)("div",{className:"msp-highlight-toast-wrapper",children:[(0,Fr.jsx)(rA,{}),(0,Fr.jsx)(gA,{})]})]})}},pz=class extends Mt{constructor(){super(...arguments),this.wrapper=o0.createRef(),this.state={entries:this.plugin.log.entries}}componentDidMount(){this.subscribe(this.plugin.events.log,()=>this.setState({entries:this.plugin.log.entries}))}componentDidUpdate(){this.scrollToBottom()}scrollToBottom(){let e=this.wrapper.current;e&&(e.scrollTop=e.scrollHeight-e.clientHeight-1)}render(){let r=this.state.entries,n=r.size,o=[];for(let i=Math.max(0,n-10),a=0;i<n;i++){let s=r.get(i);o.push((0,Fr.jsxs)("li",{children:[(0,Fr.jsx)("div",{className:"msp-log-entry-badge msp-log-entry-"+s.type}),(0,Fr.jsx)("div",{className:"msp-log-timestamp",children:Pz(s.timestamp)}),(0,Fr.jsx)("div",{className:"msp-log-entry",children:s.message})]},a++))}return(0,Fr.jsx)("div",{ref:this.wrapper,className:"msp-log",style:{position:"absolute",top:"0",right:"0",bottom:"0",left:"0",overflowY:"auto"},children:(0,Fr.jsx)("ul",{className:"msp-list-unstyled",children:o})})}};function HFe(t){return N(this,null,function*(){let{spec:e,target:r,onBeforeUIRender:n,render:o}=t,i=new eC(e||qB());yield i.init(),n&&(yield n(i)),o((0,_ce.createElement)(wce,{plugin:i}),r);try{yield i.canvas3dInitialized}catch{}return i})}function qFe(t,e){let r=Jr.getStructureSelection(t,e);return hn.toLociWithSourceUnits(r)}function xpr(t,e){let r=q.struct.generator.atomGroups({"residue-test":q.core.set.has([q.set(...t),q.core.str.concat([q.ammp("auth_asym_id"),",",q.ammp("auth_seq_id"),q.ammp("pdbx_PDB_ins_code")])])});return qFe(r,e)}function Spr(t,e){let r=io.ofBundle(t,e.root),n=io.merge(r);return io.filter(n,e)}export{Wr as Asset,qB as DefaultPluginUISpec,eC as PluginUIContext,HFe as createPluginUI,Spr as getFilteredBundle,qFe as getLocusFromQuery,xpr as getLocusFromSet,qRe as renderReact18};
